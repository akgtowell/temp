<!--
 '  Created By   : Pratik Raval
 '  Created Date : 10/02/2012
 '  Description  : This page is used for load selection screen.
-->
<!DOCTYPE html>
<html>
<head>
    <title>Load Selection</title>
   	<meta name="viewport" content="width=device-width, initial-scale=1.0;maximum-scale=1.0;user-scalable=0; target-densitydpi=device-dpi">
   
    <meta name="format-detection" content="telephone=no">
    <link rel="stylesheet" href="../css/jquery.mobile-1.0.min.css" />
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="../css/en.css" lang="en" />
    <<!-- link rel="stylesheet" media="only screen and (min-width: 320px) and (max-width: 600px)"
        href="../css/style_600.css">
    <link rel="stylesheet" media="only screen and (min-width: 600px) and (max-width: 700px)"
        href="../css/style_700.css"> -->
         <link rel="stylesheet"
	media="only screen and (min-height: 0px) and (max-height: 576px)"
	href="../css/style_480.css"> 
 <link rel="stylesheet"
	media="only screen and (min-width: 360px) and (max-width: 479px)"
	href="../css/style_600.css">
    <link rel="stylesheet" media="only screen and (min-width: 700px) and (max-width: 800px)"
        href="../css/style_800.css">
    <link rel="stylesheet" media="only screen and (min-width: 1000px) and (max-width: 1200px)"
        href="../css/style_1200.css">
    <link rel="stylesheet" media="only screen and (min-width: 1200px) and (max-width: 1500px)"
        href="../css/style_1400.css">

	<link rel="stylesheet" href="../css/boostrap/css/bStyle.css"/>
        <link rel="stylesheet" href="../css/boostrap/css/bootstrap.min.css"/>
        <link rel="stylesheet" href="../css/boostrap/css/bootstrap-grid.css"/>
        <link rel="stylesheet" href="../css/boostrap/css/bootstrap-grid.min.css"/>
        <link rel="stylesheet" href="../css/boostrap/css/bootstrap.css"/>

    <script type="text/javascript" src="../js/jquery.js"></script>

    <script type="text/javascript" src="../js/jquery.mobile-1.0.js"></script>

    <script type="text/javascript" src="../js/common.js"></script>
    <script type="text/javascript">
    if (navigator.userAgent.toLowerCase().match(/android/)) {
        document.write('<script charset="utf-8" src="../cordova-2.0.0.js"><\/script>');
        document.write('<script charset="utf-8" src="../directoryListing.js"><\/script>');
    } else if (navigator.userAgent.toLowerCase().match(/iphone/) || navigator.userAgent.toLowerCase().match(/ipad/)) {
        document.write('<script charset="utf-8" src="../cordova-1.5.0.js"><\/script>');
    }
    </script>
    <script type="text/javascript" src="../js/jquery.json-2.3.min.js"></script> 

   

    <script src="../LangJS/jquery-lang.js" charset="utf-8" type="text/javascript"></script>

    <script src="../LangJS/langpack/AR.js" charset="utf-8" type="text/javascript" lang="en" ></script>

    <link rel="stylesheet" type="text/css" href="../css/jquery.mobile.simpledialog.css" />

    <script type="text/javascript" src="../js/jquery.mobile.simpledialog.js"></script>

    <!-- SCRIPT FOR PUSHBAR -->
        <link rel="stylesheet" type="text/css" href="../pushbar/milligram.css">
    		<link rel="stylesheet" type="text/css" href="../pushbar/normalize.css">
    	<link rel="stylesheet" type="text/css" href="../pushbar/pushbar.css">
    		<link rel="stylesheet" type="text/css" href="../pushbar/demo.css">
    	<script type="text/javascript" src="../pushbar/pushbar.js"></script>
</head>
<body>
    <div data-role="page" data-theme="d">
        <div>
            <img title="" alt="" src="../images/bg.png" id="background">
        </div>
        <div data-role="header" data-position="inline" id="bgclheader">
                             	<div class="wrapper">
			<div class="card_content">
				<div>
<!-- 				<button data-pushbar-target="left"  src="../images/icons8-menu-50.png" >Left pushbar</button> -->
				 <img title="" alt="" data-pushbar-target="left"  src="../images/icons8-menu-50.png" id="setting">
				 </div>
			</div>
	</div> 
            <a href="inventory.html" id="Back_inner" rel="external" lang="en">Back</a>
            <h1 lang="en">
                Load Selection</h1>
            <a href="#" id="lang_inner">EN</a>
        </div>
        <div data-role="content" class="centerboxInvReq">
        
            <div style="height: 820px !important">
                    
                    	<div class="row">
                    		<div class="col-6">
                    			<div class="alert border-info" role="alert">
                    				LOAD DATE
                    			</div>
                    		</div>
                    		<div class="col-6">
                    			<div class="alert border-info" role="alert" id="divLoadFor">  N/A                  				
                    			</div>
                    		</div>
                    	</div>
                    	<div class="row">
                    		<div class="col-6">
                    			<div class="alert border-info" role="alert" >
                    				AVAILABLE LOAD
                    			</div>
                    		</div>
                    		<div class="col-6">
                    			<div class="alert border-info" role="alert" id="divAvilableLoad">N/A                    				
                    			</div>
                    		</div>
                    	</div>
                    	<div class="row">
                    		<div class="col-6">
                    			<div class="alert border-info" role="alert">
                    				USED LOAD
                    			</div>
                    		</div>
                    		<div class="col-6">
                    			<div class="alert border-info" role="alert" id="divUsedLoad"> N/A                   				
                    			</div>
                    		</div>
                    	</div>
                    	<div class="row">
                    		<div class="col-6">
                    			<div class="alert border-info" role="alert">
                    				NEXT LOAD
                    			</div>
                    		</div>
                    		<div class="col-6">
                    			<div class="alert border-info" role="alert" id="divNextLoad"> N/A                   				
                    			</div>
                    		</div>
                    	</div>
                    	<div class="row">
                    		<div class="col-6">
                    			<div class="alert border-info" role="alert">
                    				SELECT LOAD
                    			</div>
                    		</div>
                    		<div class="col-6">
                    			<select name="select-choice-1" id="ddlLoad" class="form-control !important" >
                                </select>
                    		</div>
                    	</div>
               </div>     
              <div class="leftbotSync card border-info !important"  >
                <div class="row">                    
                    <div class="col-3" style="margin:10px !important">
                        <div class="card bg-success text-center" style="width:100% ">
                            <a href="#" id="lnkAdjust" rel="external">
                                <img class="bottomicon" id="imgAdjust" src="../images/adjust-load.png" alt="Adjust" />
                                <h4 class="text-white">ADJUST</h4>
                            </a>
                        </div>                        
                    </div>                    
                    <div class="col-3" style="margin:10px !important">
                    	<div class="card bg-danger text-center" style="width:100% ">
                            <a href="inventory.html" rel="external" >
                            <img class="bottomicon" src="../images/no.png" alt="Yes" />
                            <h4 class="text-white">NO</h4>
                            </a>
                        </div>
                    </div>
                    <div class="col-3" style="margin:10px !important">
                        <div class="card bg-success text-center" style="width:100% ">
                            <a href="#" rel="external" onclick="setLoadPeriod();">
                            <img class="bottomicon" src="../images/yes.png" alt="Yes" />
                            <h4 class="text-white">YES</h4>
                            </a>
                        </div>
                        
                    </div>
                </div>
				<!-- <div class="menuPadding">&nbsp;</div>
				
				
				<div class="menuPadding">&nbsp;</div>
				
				<div class="menuPadding">&nbsp;</div> -->
			</div>      
                    
                        
             
        </div>
        <div id="f1" data-role="footer" class="ui-bar">
            <div class="footer">
                <div class="leftfooter">
                    09 November 2011</div>
                <div class="rightfooter">
                    Mirnah Technology Systems</div>
            </div>
        </div>
        <div  id="f2" data-role="footer" style="bottom: 0; position: absolute;">
         <aside data-pushbar-id="left" class="pushbar from_left">
		<div class="title"><span data-pushbar-close class="close push_right"></span>
			<span id="txtroute"></span>
		</div>

		<ul class="menu">
		<li style="margin-bottom: 0 !important;" > 
		<img title="" alt="" src="../images/startday-icon.png" id="day"  class="leftmenu" >
		 <a href="#"
						class="ui-btn-active" rel="external" id="day" data-icon="custom"  
						lang="en" onclick="footerredict('../startofday/startofday.html')">Start day</a></li>
					<li style="margin-bottom: 0 !important;">
					 <img title="" alt="" src="../images/Inventoryicon.png" id="inve"  class="leftmenu">
					 <a href="#" id="inve"
						rel="external" data-icon="custom" lang="en"
						onclick="footerredict('../inventory/inventory.html')">Inventory</a></li>
					<li style="margin-bottom: 0 !important;">
					 <img title="" alt="" src="../images/customer-icon.png" id="cust" class="leftmenu">
					 <a href="#"
						rel="external" id="cust" data-icon="custom" lang="en"
						onclick="footerredict('../customer/customer_operation.html')">Customer</a></li>
					<li style="margin-bottom: 0 !important;">
					<img title="" alt="" src="../images/Money-icon.png" id="sett" class="leftmenu">
					<a href="#"
						rel="external" id="sett" data-icon="custom" lang="en"
						onclick="footerredict('../settlement/managesettlement.html')">Settlement</a></li>
					<li style="margin-bottom: 0 !important;">
					<img title="" alt="" src="../images/expense-icon.png" id="expe" class="leftmenu">
					<a href="#"
						rel="external" id="expe" data-icon="custom" lang="en"
						onclick="footerredict('../settlement/expenseentry.html')">Expenses</a></li>
					<li style="margin-bottom: 0 !important;">
					<img title="" alt="" src="../images/information-icon.png" id="info" class="leftmenu" >
					<a href="#"
						rel="external" id="info" data-icon="custom" lang="en"  
						onclick="footerredict('../information/information.html')">Information</a></li>
					<li style="margin-bottom: 0 !important; ">
					 <img title="" alt="" src="../images/user-settings-icon.png" id="setup" class="leftmenu">
					 <a href="#" rel="external" id="setup" data-icon="custom" lang="en"
						onclick="footerredict('../utilities/utilities.html')">Utilities</a></li>
		</ul>

	</aside>
             <div data-role="navbar" data-iconpos="top" data-grid="f">
                <ul>
                    <li style="margin-bottom:0 !important;"><a href="#" rel="external" id="day" data-icon="custom" lang="en" onclick="footerredict('../startofday/startofday.html')">Start day</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" id="inve" class="ui-btn-active" rel="external" data-icon="custom" lang="en">Inventory</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" rel="external" id="cust" data-icon="custom" lang="en" onclick="footerredict('../customer/customer_operation.html')">Customer</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" rel="external" id="sett" data-icon="custom" lang="en" onclick="footerredict('../settlement/managesettlement.html')">Settlement</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" rel="external" id="expe" data-icon="custom" lang="en" onclick="footerredict('../settlement/expenseentry.html')">Expenses</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" rel="external" id="info" data-icon="custom" lang="en" onclick="footerredict('../information/information.html')">Information</a></li>
			        <li style="margin-bottom:0 !important; width:14.0%"><a href="#" rel="external" id="setup" data-icon="custom" lang="en" onclick="footerredict('../utilities/utilities.html')">Utilities</a></li>
                </ul>
            </div>
        </div>
    </div>

    <script type="text/javascript" language="javascript">
        window.lang = new jquery_lang_js();
        var routeCode;
        var platform = '';    
        
        
        
        //Default function of phonegap that required to call offline function
        function onDeviceReady()
        {
       		resizeWindow();
            platform = sessionStorage.getItem("platform");           
            routeCode = sessionStorage.getItem("RouteCode");    
            
            $('#divLoadFor').text(getTodayMMMDate());
            $("#divLoadFor").attr("dir", "ltr");
            try{
            getAvialableLoad();     
            
            }
            catch(ex)
            {
                alert(ex);
            }
        }       

        
        $(document).ready(function() {
            $(".leftfooter").html(getCurrentDate()); 
             resizeOrientationWindow();
         	document.addEventListener("deviceready", onDeviceReady, false);                       
            // sujee added side bar ----------------- START ------------------------ 
	          var pushbar = new Pushbar({
	      		blur:true,
	      		overlay:true,
	      	});
	          $("#txtroute").text("ROUTE #: " + sessionStorage.getItem("RouteCode")); 
	          window.setInterval(function(){
	       		var randomColor = '#'+ ('000000' + Math.floor(Math.random()*16777215).toString(16)).slice(-6);
	       		$('#txtroute').css({
	         			'color' : randomColor,
	       		});
	     			}, 2000);
	          
	          //----------------------------- END -------------------------  
                          
            $(".ui-slider").remove();
           
            $('.ui-select .ui-btn-text').css({ 'text-align': 'left','color':'#999'});
           
            var lan = sessionStorage.getItem("Language");
	    window.lang.run(lan);
           if (sessionStorage.getItem("Language")  != "en") {
               
                window.lang.change('LoadSelection'+lan,lan);
                window.lang.change('Footer'+lan,lan);
		if(lan=="AR")
                {
                     $(".centerboxInvReq").attr("dir", "rtl");
                    $('#Back_inner').removeClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
		    $('#Back_inner').addClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
		    $('#lang_inner').removeClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
		    $('#lang_inner').addClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
		}
		
            }
	    else
	    {
		window.lang.change('en','en');
		$(".centerboxInvReq").attr("dir", "ltr");
		$('#Back_inner').removeClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
		$('#Back_inner').addClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
		$('#lang_inner').removeClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
		$('#lang_inner').addClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
	    }

            // Date with external button
            $('#date1').scroller();
            var t = 'android';
            var m = 'scroller';

            $('#date1').scroller('destroy').scroller({ theme: t, mode: m });

        });

       /* function PopulateSelect() {
            var el = document.getElementById("ddlLoad");
            for (i = 0; i < 100; i++) {
                el.options[el.options.length] = new Option(i, i);
            }
        }
        PopulateSelect(); */
        
        //Function for bind avialable load
        function getAvialableLoad()
        {
        
            var avilableLoad = "";
            var Qry = "select Distinct loadperiodnumber From startingloaddetail where routecode=" + routeCode + "  order by loadperiodnumber";
            if (platform == "iPad") {
                var abc = Cordova.exec(function(result) {                    
                    for (i = 0; i < result.length; i++) {
                        avilableLoad += result[i][0];
                        if (i != result.length - 1)
                            avilableLoad += ",";
                    }
                    divAvilableLoad.innerHTML = avilableLoad;
                },
                 function(error) {
                     navigator.notification.navigator.notification.alert("Error in binding Avialable Load : " + error);
                 },
                 "PluginClass",
                 "GetdataMethod",
                 [Qry]);
            }
            else if (platform == "Android") 
            {
                window.plugins.DataBaseHelper.select(Qry, function(result) {
                    
                    var array = $.map(result.array, function(item, index) {
                        return [[item.loadperiodnumber]];
                    });

                    var result = array;
                    console.log(JSON.stringify(result));
                    for (i = 0; i < result.length; i++) {
                        avilableLoad += result[i][0];
                        if (i != result.length - 1)
                            avilableLoad += ",";
                    }
                    divAvilableLoad.innerHTML = avilableLoad;
                    
                    getUsedLoad();       
            		
                    
                },
			    function() {
			        console.warn("Error calling plugin");
			    });
            }
        }
        
        //Function for bind used load
        function getUsedLoad()
        {
            var Qry = "select Distinct loadperiodnumber From startingloaddetail where routecode=" + routeCode + "  and status = 1 order by loadperiodnumber";
            var usedLoad = "";
            if (platform == "iPad") {
                var abc = Cordova.exec(function(result) {
                    if (result.length == 0) {
                        divUsedLoad.innerHTML = "";
                    }
                    else {
                        for (i = 0; i < result.length; i++) {
                            usedLoad += result[i][0];
                            if (i != result.length - 1)
                                usedLoad += ",";
                        }
                        divUsedLoad.innerHTML = usedLoad;
                    }
                },
                function(error) {
                    navigator.notification.alert("Error in binding Used Load : " + error);
                },
                "PluginClass",
                "GetdataMethod",
                [Qry]);
            }
            else if (platform == "Android") 
            {
                window.plugins.DataBaseHelper.select(Qry, function(result) {
                    if(result.array != undefined)
                    {
                    	var array = $.map(result.array, function(item, index) {
	                        return [[item.loadperiodnumber]];
                    	});
                    	var result = array;
                    	if (result.length == 0) {
	                        divUsedLoad.innerHTML = "";
                    	}                    
                    	else {
	                        for (i = 0; i < result.length; i++) {
                            	usedLoad += result[i][0];
                            	if (i != result.length - 1)
                                	usedLoad += ",";
                        	}
                        	divUsedLoad.innerHTML = usedLoad;
                    	}
                    
                    }
                    getNextLoad();
                },
		        function() {
		            console.warn("Error calling plugin");
		        });
            }
        }
        
         //Function for bind next load
        function getNextLoad()
        {
            var Qry = "select Distinct loadperiodnumber From startingloaddetail where routecode=" + routeCode + " and status = 0 order by loadperiodnumber Limit 1";
            if (platform == "iPad") {
                var abc = Cordova.exec(function(result) {
                    if (result.length > 0) {
                        divNextLoad.innerHTML = result[0][0];
                    }
                },
                function(error) {
                    navigator.notification.alert("Error in binding Next Load : " + error);
                },
                "PluginClass",
                "GetdataMethod",
                [Qry]);
            }
            else if (platform == "Android") 
            {
                window.plugins.DataBaseHelper.select(Qry, function(result) {
                    if(result.array != undefined)
                    {
                    	var array = $.map(result.array, function(item, index) {
	                        return [[item.loadperiodnumber]];
                    	});
                    	var result = array;
                    	if (result.length > 0) {
	                        divNextLoad.innerHTML = result[0][0];
                    	}
                    }
                    getDesiredLoad();
           			
                },
		        function() {
		            console.warn("Error calling plugin");
		        });
            }
        }
        
        
        //Function for bind desired load
        function getDesiredLoad()
        {
            var Qry = "select Distinct loadperiodnumber From startingloaddetail where routecode=" + routeCode + " and status = 0  order by loadperiodnumber";
            console.log(Qry);
            if (platform == "iPad") 
            {
                var abc = Cordova.exec(function(result) {
                    if(sessionStorage.getItem("CaseEditEnabled") == 0 || result.length > 0)
                    {
                        $("#lnkAdjust").attr("href","#");
                        $("#imgAdjust").attr("src","../images/adjust-load-gray.png");
                        $("#divAdjust").addClass('MenuGray');
                    }
                    else                     
                    {
                        $("#lnkAdjust").attr("href","adjustload.html");
                        $("#imgAdjust").attr("src","../images/adjust-load.png");
                        $("#divAdjust").removeClass('MenuGray');
                    }
                    if (result.length > 0) {
                        for (i = 0; i < result.length; i++) {
                            $("<option />", { value: result[i][0], text: result[i][0] }).appendTo($("#ddlLoad"));
                        }
                        $("#ddlLoad").selectmenu("refresh");
                    }
                },
                function(error) {
                    navigator.notification.alert("Error in binding Desired Load : " + error);
                },
                "PluginClass",
                "GetdataMethod",
                [Qry]);
            }
            else if (platform == "Android") 
            {            	
                window.plugins.DataBaseHelper.select(Qry, function(result) {
                    if(sessionStorage.getItem("CaseEditEnabled") == 0 || result.array !=  undefined)
                    {
                    	if(result.array != undefined)
                    	{                    	
                    		var array = $.map(result.array, function(item, index) {
	                        	return [[item.loadperiodnumber]];
                    		});
                    		var result = array;	
                    		if (result.length > 0) {
	                        	for (i = 0; i < result.length; i++) {
	                            	$("<option />", { value: result[i][0], text: result[i][0] }).appendTo($("#ddlLoad"));
    	                    	}
                        		$("#ddlLoad").selectmenu("refresh");
                        		 
                    		}
                    	}

                    	if (sessionStorage.getItem("CaseEditEnabled") == 1 )
                    		{
                    	$("#lnkAdjust").attr("onclick","AdjustLoad();");
                        $("#imgAdjust").attr("src","../images/adjust-load.png");
                        $("#divAdjust").removeClass('MenuGray');
                    		} else {
                    			$("#lnkAdjust").attr("href","#");
                            	$("#imgAdjust").attr("src","../images/adjust-load-gray.png");
                            	$("#divAdjust").addClass('MenuGray');
                    		}
                    }
                    else
                	{                		
                    	$("#lnkAdjust").attr("href","#");
                    	$("#imgAdjust").attr("src","../images/adjust-load-gray.png");
                    	$("#divAdjust").addClass('MenuGray');
                	}
                	CheckForOpeningQuantity();
                },
		        function() {
		            console.warn("Error calling plugin");
		        });
            }
        }
		function selectbatchdata()
        {
            $.mobile.showPageLoadingMsg();
            var selectqry = "select CASE WHEN count(batchdetailkey)>0 THEN batchdetailkey ELSE (select max(batchdetailkey)+1 from batchexpirydetail) END as batchdetailkey from batchexpirydetail where transactiontypecode=1 and istemp='true'";
            if(platform=='iPad')
		    {
                return abc = Cordova.exec(function(result) {
                                           if(result=='')
                                           key=1;
                                           else
                                           key = result[0][0];
                                           
                                           addbatchdata(key);
                                           },
                                           function(error) {
                                           alert(error);},
                                           "PluginClass", 
                                           "GetdataMethod", 
                                           [selectqry]);
        	}
        	else if(platform=='Android')
            {
                window.plugins.DataBaseHelper.select(selectqry,function(result)
                                                     {
                                                     
                                                     result = $.map(result.array, function (item, index) {
                                                                    
                                                                    return [[item.batchdetailkey]];
                                                                    });
                                                     if(result=='' || result==0)
                                                     key=1;
                                                     else
                                                     key = result[0][0];
                                                     
                                                     addbatchdata(key);
                                                     },
                                                     function()
                                                     {
                                                     console.warn("Error calling plugin");
                                                     });
            } 
        }
        function addbatchdata(key)
        {
            var routecode=sessionStorage.getItem("RouteCode");
            
            if(platform=='iPad')
		    {
                return abc = Cordova.exec(function(result) {
                                           //checkbatch(result,0,key);
                                           insertbatchexpiry(result,0,key);
                                           },
                                           function(error) {
                                           alert(error);},
                                           "PluginClass", 
                                           "GetdataMethod", 
                                           ["select batchnumber,expirydate,itemcode,cases,units,upc from startingloaddetail where routecode = " + sessionStorage.getItem('RouteCode') + " and loadperiodnumber = " + localStorage.LoadPeriod + ""]);
        	}
        	else if(platform=='Android')
            {
                window.plugins.DataBaseHelper.select("select batchnumber,expirydate,itemcode,cases,units,upc from startingloaddetail where routecode = " + sessionStorage.getItem('RouteCode') + " and loadperiodnumber = " + localStorage.LoadPeriod + "",function(result)
                                                     {
                                                     
                                                     result = $.map(result.array, function (item, index) {
                                                                    
                                                                    return [[item.batchnumber, item.expirydate,item.itemcode, item.cases,item.units, item.upc]];
                                                                    });
                                                    // checkbatch(result,0,key);	
                                                     insertbatchexpiry(result,0,key);
                                                     },
                                                     function()
                                                     {
                                                     console.warn("Error calling plugin");
                                                     });
            } 
        }
        function insertbatchexpiry(batchdata,i,key)
        {
            var cases = batchdata[i][3];
            var units = batchdata[i][4];
            var upc = batchdata[i][5];
            var qty = (eval(cases)*eval(upc))+eval(units);
            
            if(platform=='iPad')
            {
                Cordova.exec(function(result) {
                    
                              if(result=='')
                              {
                              var updateqry="INSERT INTO `batchexpirydetail` ('batchdetailkey','batchnumber','itemcode','expirydate','quantity','transactiontypecode','routekey','visitkey','issync','istemp') VALUES ("+key+",'"+batchdata[i][0] +"','"+batchdata[i][2] +"','"+batchdata[i][1] +"','"+qty +"',1," + sessionStorage.getItem('RouteKey') + ",0,0,'true')";
                              }
                              else
                              {
                              var updateqry="update `batchexpirydetail` set batchnumber='"+batchdata[i][0] +"',itemcode='"+batchdata[i][2] +"',expirydate='"+batchdata[i][1] +"',quantity='"+qty +"' where routekey = " + sessionStorage.getItem('RouteKey') + " and transactiontypecode=1 and itemcode="+batchdata[i][2]+" and batchnumber='"+batchdata[i][0]+"'";
                              }
                              console.log(updateqry);
                              Cordova.exec(function(result) {
                                            //alert(result);
                                            
                                            if(i+1 < batchdata.length)
                                            {
                                            insertbatchexpiry(batchdata,i+1,key);
                                            }
                                            else
                                            checkbatch(batchdata,0,key);
                                            },
                                            function(error) {
                                            alert(error);},
                                            "PluginClass", 
                                            "InsertUpdateMethod", 
                                            [updateqry]);
                              },
                              function(error) {
                              alert(error);},
                              "PluginClass", 
                              "GetdataMethod", 
                              ["select batchnumber from batchexpirydetail where itemcode="+batchdata[i][2]+" and batchnumber='"+batchdata[i][0]+"' and transactiontypecode=1 and istemp='true'"]); 
                
            }
            else if(platform=='Android')
            {
                window.plugins.DataBaseHelper.select("select batchnumber from batchexpirydetail where itemcode="+batchdata[i][2]+" and batchnumber='"+batchdata[i][0]+"' and transactiontypecode=1 and istemp='true'",function(result)
                                                     {
                                                    
                                                     if($.isEmptyObject(result))
                                                     {
                                                     var updateqry="INSERT INTO `batchexpirydetail` ('batchdetailkey','batchnumber','itemcode','expirydate','quantity','transactiontypecode','routekey','visitkey','issync','istemp') VALUES ("+key+",'"+batchdata[i][0] +"','"+batchdata[i][2] +"','"+batchdata[i][1] +"','"+qty +"',1," + sessionStorage.getItem('RouteKey') + ",0,0,'true')";
                                                     }
                                                     else
                                                     {
                                                     var updateqry="update `batchexpirydetail` set batchnumber='"+batchdata[i][0] +"',itemcode='"+batchdata[i][2] +"',expirydate='"+batchdata[i][1] +"',quantity='"+qty +"' where routekey = " + sessionStorage.getItem('RouteKey') + " and transactiontypecode=1 and itemcode="+batchdata[i][2]+" and batchnumber='"+batchdata[i][0]+"'";
                                                     }
                                                     console.log(updateqry);
                                                     window.plugins.DataBaseHelper.insert(updateqry,function(result)
                                                                                          {
                                                                                          if(i+1 < batchdata.length)
                                                                                          {
                                                                                          insertbatchexpiry(batchdata,i+1,key);
                                                                                          }
                                                                                          else
                                                                                            checkbatch(batchdata,0,key);
                                                                                          },
                                                                                          function()
                                                                                          {
                                                                                          console.warn("Error calling plugin");
                                                                                          });
                                                     },
                                                     function()
                                                     {
                                                     console.warn("Error calling plugin");
                                                     });
                
            } 
        }
        function checkbatch(data,i,key)
        {
            console.log("select batchmaster_temp from batchmaster where itemcode="+data[i][2]+" and batchnumber='"+data[i][0]+"'");
            if(platform=='iPad')
		    {
                Cordova.exec(function(result) {
                              if(result=='')
                              {
                              insert_batchdetaildata(data,'insert',i,key);
                              }
                              else
                              {
                              insert_batchdetaildata(data,'update',i,key);
                              }
                              if(i+1 < data.length)
                              {
                              checkbatch(data,i+1,key);
                              }
                              else
                              {
                              var base = window.location.toString().substring(0, window.location.toString().lastIndexOf("/")) + "/";
                              $.mobile.hidePageLoadingMsg();  
                              window.location = base + "load.html";
                              }
                              },
                              function(error) {
                              alert(error);},
                              "PluginClass", 
                              "GetdataMethod", 
                              ["select batchnumber from batchmaster_temp where itemcode="+data[i][2]+" and batchnumber='"+data[i][0]+"'"]);
        	}
        	else if(platform=='Android')
            {
                window.plugins.DataBaseHelper.select("select batchnumber from batchmaster_temp where itemcode="+data[i][2]+" and batchnumber='"+data[i][0]+"'",function(result)
                                                     {
                                                     
                                                     if($.isEmptyObject(result))
                                                     {
                                                     insert_batchdetaildata(data,'insert',i,key);
                                                     }
                                                     else
                                                     {
                                                     insert_batchdetaildata(data,'update',i,key);
                                                     }	
                                                     if(i+1 < data.length)
                                                     {
                                                     checkbatch(data,i+1,key);
                                                     }
                                                     else
                                                     {
                                                      var base = window.location.toString().substring(0, window.location.toString().lastIndexOf("/")) + "/"; 
                                                     $.mobile.hidePageLoadingMsg();  
                                                     window.location = base + "load.html";
                                                     }
                                                     },
                                                     function()
                                                     {
                                                     console.warn("Error calling plugin");
                                                     });
            } 
        }
        function insert_batchdetaildata(batchdata,flag,i,key)
        {
            
            
            var cases = batchdata[i][3];
            var units = batchdata[i][4];
            var upc = batchdata[i][5];
            var qty = (eval(cases)*eval(upc))+eval(units);
            
            if(flag=="insert")
            {
                console.log("insert");
                if(platform=='iPad')
		    	{
                    return abc = Cordova.exec(function(result) {
                                               //alert(result);
                                               return true;
                                               },
                                               function(error) {
                                               alert(error);},
                                               "PluginClass", 
                                               "InsertUpdateMethod", 
                                               ["INSERT INTO `batchmaster_temp` ('batchdetailkey','batchnumber','itemcode','expirydate','loadquantity')VALUES ("+key+",'"+batchdata[i][0] +"','"+batchdata[i][2] +"','"+batchdata[i][1] +"','"+qty +"')"]);
            	}
            	else if(platform=='Android')
           	  	{
	           		window.plugins.DataBaseHelper.insert("INSERT INTO `batchmaster_temp` ('batchdetailkey','batchnumber','itemcode','expirydate','loadquantity')VALUES ("+key+",'"+batchdata[i][0] +"','"+batchdata[i][2] +"','"+batchdata[i][1] +"','"+qty +"')",function(result)
                                                         {
                                                         return true;
                                                         },
                                                         function()
                                                         {
                                                         console.warn("Error calling plugin");
                                                         });
           	 	} 
            }else
            {
                console.log("update");
                if(platform=='iPad')
		    	{
                    return abc = Cordova.exec(function(result) {
                                               //alert(result);
                                               return true;
                                               },
                                               function(error) {
                                               alert(error);},
                                               "PluginClass", 
                                               "InsertUpdateMethod", 
                                               ["update batchmaster_temp set expirydate='"+batchdata[i][1]+"',loadquantity='"+qty+"' where itemcode='"+batchdata[i][2]+"' and batchnumber='"+batchdata[i][0]+"'"]);
            	}
            	else if(platform=='Android')
           	  	{
	           		window.plugins.DataBaseHelper.insert("update batchmaster_temp set expirydate='"+batchdata[i][1]+"',loadquantity='"+qty+"' where itemcode='"+batchdata[i][2]+"' and batchnumber='"+batchdata[i][0]+"'",function(result)
                                                         {
                                                         return true;
                                                         },
                                                         function()
                                                         {
                                                         console.warn("Error calling plugin");
                                                         });
           	 	} 
            }
            
        }
        //Function for set load period that access in another screen
        function setLoadPeriod() {
            var base = window.location.toString().substring(0, window.location.toString().lastIndexOf("/")) + "/";            
            if ($("#ddlLoad").val() == null && sessionStorage.onlyopeningstock != 1) {
                localStorage.LoadPeriod = 0;
                getLangText("No load Available for proceed.");
                return false;
            }
            else {
            	
                localStorage.LoadPeriod = $("#ddlLoad").val();
                //window.location = base + "load.html";
                InsertInventoryData();
				updateloadused();				 
                selectbatchdata();
            }
        }
        
        function AdjustLoad(){
        	var base = window.location.toString().substring(0, window.location.toString().lastIndexOf("/")) + "/";            
        	 localStorage.LoadPeriod = $("#ddlLoad").val();
             window.location = base + "adjustload.html";
        	
        	
        }
		function updateloadused(){
			var routecode= sessionStorage.getItem("RouteCode");
            var userid= sessionStorage.getItem("SalesmanCode");
            var deviceid= sessionStorage.getItem("DeviceID");
            var platform= sessionStorage.getItem("platform");
            
            //alert(userid+"inside"+wsurl);
           // $.mobile.showPageLoadingMsg();
            // get all masterdata
            $.ajax({
                   type: "post",
                   url: wsurl+"ws/checknewload/routeid/"+routecode+"/ddate/"+getTodayMMMDate()+"/lpno/"+$("#ddlLoad").val(),
                   data: "{}",
                   cache: false,
                    timeout: 20000,
                   dataType: "json",
                   crossDomain: true,
                   success: function(data) {
                   //alert(data);
                  // $.mobile.hidePageLoadingMsg();     
                  
                   },
                   error: function(qXHR, textStatus, errorThrown) {
                   alert("failure: " + qXHR.status + ":" + textStatus + errorThrown);
                   }
                   });
        }						  
        function CheckForOpeningQuantity()
        {
            var Qry = "SELECT (SELECT IFNULL(SUM(beginstockqty),0) FROM inventorysummarydetail WHERE routekey=" + sessionStorage.getItem("RouteKey") + ") as beginqty, (SELECT COUNT(*) from startingloaddetail WHERE strftime('%Y-%m-%d',ddate) = date()) currloadcount, (SELECT COUNT(*) FROM inventorytransactiondetail WHERE transactiontypecode = 12) transcnt";
            var QrySelect = "SELECT itemcode,quantity FROM inventorytransactiondetail WHERE transactiontypecode = 12";
            console.log(Qry);
            if(platform == "iPad")
            {
                Cordova.exec(function(result) 
                {
                    if(result.length > 0)
                    {
                        if(result[0][0] == 0 && result[0][1] == 0 && result[0][2] > 0)
                            sessionStorage.onlyopeningstock = 1;
                        else
                            sessionStorage.onlyopeningstock = 0;
                            
                        /*if(result[0][0] == 0) //Code moved to startofday
                        {                            
                            Cordova.exec(function(result){
                                if(result.length > 0)
                                    UpdateInventoySummary(0,result);
                            },
                            function(error){
                                alert(error);
                            },
                            "PluginClass",
                            "GetdataMethod",
                            [QrySelect]);
                        }*/
                    }
                },
                function(error) {
                    alert(error);
                },
                "PluginClass",
                "GetdataMethod",
                [Qry]);
            }
            else if(platform == "Android")
            {
                window.plugins.DataBaseHelper.select(Qry, function(result) {
                    if(result.array !=  undefined)
                    {
                        var result = $.map(result.array, function(item, index) {
                            return [[item.beginqty,item.currloadcount,item.transcnt]];
                        });                        
                        if(result[0][0] == 0 && result[0][1] == 0 && result[0][2] > 0)
                            sessionStorage.onlyopeningstock = 1;
                        else
                            sessionStorage.onlyopeningstock = 0;
                    }
                },
		        function() {
		            console.warn("Error calling plugin");
		        });
            }
        }
        
        function UpdateInventoySummary(i,data)
        {
            var itemcode = data[i][0];
            var quantity = data[i][1];
            var Qry = "SELECT COUNT(*) as cnt FROM inventorysummarydetail WHERE itemcode = " + itemcode + " AND routekey= " + sessionStorage.getItem("RouteKey");
            var QryInsert = "INSERT INTO inventorysummarydetail(inventorykey,routekey,itemcode,beginstockqty,istemp,issync,stdsalesprice,stdsalescaseprice,stdreturnprice,stdreturncaseprice) SELECT " + sessionStorage.getItem("RouteKey") + "," + sessionStorage.getItem("RouteKey") + "," + itemcode + "," + quantity + ",'false',0,defaultsalesprice,caseprice,defaultreturnprice,returncaseprice FROM itemmaster WHERE actualitemcode=" + itemcode;
            var QryUpdate = "UPDATE inventorysummarydetail set beginstockqty = (ifnull(beginstockqty,0) + " + eval(quantity) + "),issync=0 where routekey=" + sessionStorage.getItem("RouteKey") + " and itemcode=" + itemcode;
            var QryNew = "";
            if(platform == "iPad")
            {
                Cordova.exec(function(result) {
                    if(result.length > 0)
                    {
                        if(eval(result) > 0 )                        
                            QryNew = QryUpdate;
                        else
                            QryNew = QryInsert;                        
                        console.log(QryNew);    
                        Cordova.exec(function(result){
                            if(i+1 < data.length)
                                UpdateInventoySummary(i+1,data);
                        },
                        function(error){
                            alert(error);
                        },
                        "PluginClass",
                        "InsertUpdateMethod",
                        [QryNew]);                        
                    }                    
                },
                function(error) {
                    alert(error);
                },
                "PluginClass",
                "GetdataMethod",
                [Qry]);
            }
            else if(platform == "Android")
            {
                window.plugins.DataBaseHelper.select(Qry, function(result) {
                    if(result.array != undefined)
                    {
                        if(result.array[0].cnt > 0)
                            QryNew = QryUpdate;
                        else
                            QryNew = QryInsert;
                        console.log(QryNew);
                        window.plugins.DataBaseHelper.insert(QryNew, function(result) {
                            if(i+1 < data.length)
                                UpdateInventoySummary(i+1,data);
                        },
                        function() {
                            console.warn("Error calling plugin");
                        });
                    }
                },
		        function() {
		            console.warn("Error calling plugin");
		        });
            }
        }

        function InsertInventoryData() {
            var RouteCode = sessionStorage.getItem("RouteCode");
            var RouteKey = sessionStorage.getItem("RouteKey");
            var SalesmanCode = sessionStorage.getItem("SalesmanCode");
            var LoadPeriod = localStorage.getItem("LoadPeriod");
            var DetailKey;
            var Qty;
            var CaseEnabled = sessionStorage.getItem("CaseEnabled");
            if (CaseEnabled == "1")
                CaseEnabled = true;
            else
                CaseEnabled = false;


            //navigator.notification.navigator.notification.alert(SalesmanCode);
            //navigator.notification.navigator.notification.alert("Routecode:" + RouteCode + " Routekey:" + RouteKey + " LoadPeriod:" + LoadPeriod);            



            //Inserting inventorytransactionheader table
            /*var Qry = "INSERT INTO inventorytransactionheader(inventorykey,routekey,transactiontype,routecode,salesmancode,transactiondate,documentnumber,loadnumber,istemp) select 0," + RouteKey + ",1," + RouteCode + "," + SalesmanCode + ",date(),0," + LoadPeriod + ",'true' from startingloaddetail where loadperiodnumber = " + LoadPeriod + " and strftime('%Y-%m-%d',ddate)=date()";
            //navigator.notification.navigator.notification.alert(Qry);
            if (platform == "iPad") {
                Cordova.exec(function(result) {
                    //navigator.notification.navigator.notification.alert(result);                                                        
                },
                  function(error) {
                      navigator.notification.navigator.notification.alert(error);
                  },
                  "PluginClass",
                  "InsertUpdateMethod",
                  [Qry]);
            }
            else if (platform == "Android") 
            {
                window.plugins.DataBaseHelper.insert(Qry, function(result) {
                    //navigator.notification.navigator.notification.alert(result);                
                },
		        function() {
		            console.warn("Error calling plugin");
		        });
            }
            
           
            Qry = "INSERT INTO inventorytransactiondetail(routekey,transactiontypecode,itemcode,quantity,itemprice,itemcaseprice,istemp)  select " + RouteKey + "," + "1,itemcode,((SELECT sum((cases * unitspercase) + units) from startingloaddetail where itemcode = sld.itemcode and loadperiodnumber = " + LoadPeriod + " and strftime('%Y-%m-%d',ddate)=date()) + (ifnull((select endstockqty from openingqty where itemcode = sld.itemcode),0))) as invQty,sld.salesprice,sld.caseprice,'true' from startingloaddetail sld join itemmaster on actualitemcode = itemcode where loadperiodnumber = " + LoadPeriod + " and strftime('%Y-%m-%d',ddate)=date()";
            console.log(Qry);
            //navigator.notification.navigator.notification.alert(Qry);
            if(platform == "iPad")
            {
              Cordova.exec(function(result) {
                //navigator.notification.alert(result);
              },
              function(error) {
                  navigator.notification.alert(error);
              },
              "PluginClass",
              "InsertUpdateMethod",
              [Qry]);
            }
            else if(platform == "Android")
            {
                window.plugins.DataBaseHelper.insert(Qry, function(result) {
                    navigator.notification.alert(result);                
                },
		        function() {
		            console.warn("Error calling plugin");
		        });
            }

            //Inserting inventorysummarydetail table          
            Qry = "INSERT INTO inventorysummarydetail(routekey,itemcode,loadqty,istemp)  select " + RouteKey + "," + "itemcode,((SELECT sum((cases * unitspercase) + units) from startingloaddetail where itemcode = sld.itemcode and loadperiodnumber = " + LoadPeriod + " and strftime('%Y-%m-%d',ddate)=date()) + (ifnull((select endstockqty from openingqty where itemcode = sld.itemcode),0))) as invQty,'true' from startingloaddetail sld join itemmaster on actualitemcode = itemcode where loadperiodnumber = " + LoadPeriod + " and strftime('%Y-%m-%d',ddate)=date()";
            //console.log(Qry);
            //navigator.notification.navigator.notification.alert(Qry);
            if (platform == "iPad") {
                Cordova.exec(function(result) {
                    //navigator.notification.alert(result);
                },
                  function(error) {
                      navigator.notification.alert(error);
                  },
                  "PluginClass",
                  "InsertUpdateMethod",
                  [Qry]);
            }
            else if (platform == "Android") 
            {
                window.plugins.DataBaseHelper.insert(Qry, function(result) {
                    //navigator.notification.alert(result);                
                },
		        function() {
		            console.warn("Error calling plugin");
		        });
            }*/
        }
    </script>

</body>
</html>
