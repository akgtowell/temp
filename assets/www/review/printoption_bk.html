<!--
 '  Created By   : Ankur Shah
 '  Created Date : 05/02/2012
 '  Description  : This page is used for select print options.
-->
<!DOCTYPE html>
<html>
<head>
    <title>Print Options</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0;maximum-scale=1.0;user-scalable=0; target-densitydpi=device-dpi">
    <meta name="format-detection" content="telephone=no">
    <link rel="stylesheet" href="../css/jquery.mobile-1.0.min.css" />
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="../css/en.css" lang="en" />
    <link rel="stylesheet" media="only screen and (min-width: 320px) and (max-width: 600px)"
        href="../css/style_600.css">
    <link rel="stylesheet" media="only screen and (min-width: 601px) and (max-width: 700px)"
        href="../css/style_700.css">
    <link rel="stylesheet" media="only screen and (min-width: 700px) and (max-width: 800px)"
        href="../css/style_800.css">
    <link rel="stylesheet" media="only screen and (min-width: 1000px) and (max-width: 1200px)"
        href="../css/style_1200.css">
    <link rel="stylesheet" media="only screen and (min-width: 1200px) and (max-width: 1500px)"
        href="../css/style_1400.css">

    <script type="text/javascript" src="../js/jquery.js"></script>

    <script type="text/javascript" src="../js/jquery.mobile-1.0.js"></script>

    <script type="text/javascript" src="../js/common.js"></script>

   

    <script type="text/javascript" src="../js/jquery.json-2.3.min.js"></script>

    <script src="../LangJS/jquery-lang.js" charset="utf-8" type="text/javascript"></script>

    <script src="../LangJS/langpack/AR.js" charset="utf-8" type="text/javascript" lang="en"></script>
    
    <script type="text/javascript" src="../js/printreport.js"></script>

    <script>
        if (navigator.userAgent.toLowerCase().match(/android/)) {
            document.write('<script charset="utf-8" src="../cordova-2.0.0.js"><\/script>');
            document.write('<script charset="utf-8" src="../directoryListing.js"><\/script>');
        } else if (navigator.userAgent.toLowerCase().match(/iphone/) || navigator.userAgent.toLowerCase().match(/ipad/)) {
            document.write('<script charset="utf-8" src="../cordova-1.5.0.js"><\/script>');
        }
    </script>
</head>
<body>
    <div data-role="page" data-theme="d">
        <div>
            <img title="" alt="" src="../images/bg.png" id="background">
        </div>
        <div data-role="header" data-position="inline" id="bgclheader">
            <a href="#" id="Back_inner" rel="external" lang="en">Back</a>
            <h1 lang="en">
                Print Options</h1>
            <a href="#" id="lang_inner">EN</a>
        </div>
        <div data-role="content" class="centerbox">
            <div class="boxContent">
                <div class="tblBox tblReport">
                    <center>
                        <table border="0" cellpadding="4" cellspacing="4" width="60%" id="tblContent">
                            <tr>
                                <td colspan="2">
                                    &nbsp;
                                </td>
                            </tr>
                            <tr>
                                <td colspan="2">
                                    &nbsp;
                                </td>
                            </tr>
                            <tr>
                                <td colspan="2">
                                    &nbsp;
                                </td>
                            </tr>
                            <tr>
                                <td >
                                    <img src="../images/r-btn-1.png" id="bt1" alt=""  class="printAlign" />
                                </td>
                                <td >
                                    <h3 class="captionLabel" lang="en">Print Final Copy</h3>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="2">
                                    &nbsp;
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <img src="../images/r-btn-2.png" id="bt2" alt="" class="printAlign"/>
                                </td>
                                <td>
                                <h3 class="captionLabel" lang="en">Print Draft Copy</h3>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="2">
                                    &nbsp;
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <img src="../images/r-btn-2.png" id="bt3" alt=""  class="printAlign" />
                                </td>
                                <td>
                                	<h3 class="captionLabel" lang="en">Delay Printing</h3>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="2">
                                    &nbsp;
                                </td>
                            </tr>
                            <tr>
                                <td colspan="2">
                                    &nbsp;
                                </td>
                            </tr>
                        </table>
                    </center>
                </div>
            </div>
            <div class="leftbottomMenu">
                <div class="menuPadding">
                    &nbsp;</div>
                <a href="#" rel="external" style="text-decoration: none; font-weight: normal;" id="lnkNext" onclick="GetDocumentNumber();">
                    <div class="MenuPosition printLoadHeight">
                        <div class="MenuTextPos">
                            <img  class="bottomicon" src="../images/ok.png" alt="Continue" /></div>
                        <div class="MenuTextPos MenuText" id="cntlbl" lang="en">
                            Continue</div>
                    </div>
                </a>
                <div class="menuPadding ">
                    &nbsp;</div>
                <a href="#" id="lnkExit" rel="external" style="text-decoration: none; font-weight: normal;">
                    <div class="MenuPosition printLoadHeight MenuExit">
                        <div class="MenuTextPos">
                            <img  class="bottomicon" src="../images/icn-exit.png" alt="Exit" /></div>
                        <div class="MenuTextPos MenuText" lang="en"  id="extlbl">
                        Cancel</div>
                    </div>
                </a>
                <div class="menuPadding">
                    &nbsp;</div>
            </div>
        </div>
        <div id="f1" data-role="footer" class="ui-bar">
            <div class="footer">
                <div class="leftfooter">
                </div>
                <div class="rightfooter">
                    Mirnah Technology Systems</div>
            </div>
        </div>
        <div id="f2" data-role="footer" style="bottom: 0; position: absolute;">
            <div data-role="navbar" data-iconpos="top" data-grid="f">
                <ul>
                    <li style="margin-bottom:0 !important;"><a href="#" rel="external" id="day" data-icon="custom" lang="en" onclick="footerredict('../startofday/startofday.html')">Start day</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" id="inve" rel="external" data-icon="custom" lang="en" onclick="footerredict('../inventory/inventory.html')">Inventory</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" rel="external" id="cust" data-icon="custom" lang="en" onclick="footerredict('../customer/customer_operation.html')">Customer</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" rel="external" id="sett" data-icon="custom" lang="en" onclick="footerredict('../settlement/managesettlement.html')">Settlement</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" rel="external" id="expe" data-icon="custom" lang="en" onclick="footerredict('../settlement/expenseentry.html')">Expenses</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" class="ui-btn-active" rel="external" id="info" data-icon="custom" lang="en" onclick="footerredict('../information/information.html')">Information</a></li>
			        <li style="margin-bottom:0 !important; width:14.0%"><a href="#" rel="external" id="setup" data-icon="custom" lang="en" onclick="footerredict('../utilities/utilities.html')">Utilities</a></li>
                </ul>
            </div>
        </div>
    </div>

    <script type="text/javascript" language="javascript">
        var page = "#";
        window.lang = new jquery_lang_js();
        var platform = "";
        var DocumentNumber,InvoiceNumber,InvoiceNumberField;
        var advpaycollection = 0;
        var balanceupdate;
        var FinalBalance;  
        var printstatus = 0;
        var amountpaid1=0;
        var invoicebalance1=0;
        var tmpdata;
        var DocNos=[];
        var printanother=false;
         resizeOrientationWindow();
	  $(document).ready(function() {
	 	resizeWindow();            
		// Set current date in footer
            $(".leftfooter").html(getCurrentDate());

            // Fetch current language and set that language.
            var lan = sessionStorage.getItem("Language");
            window.lang.run(lan);

            document.addEventListener("deviceready", onDR, false);
            function onDR() {
            	  platform = sessionStorage.getItem("platform");
            	  var printval = sessionStorage.getItem("printerval");
                  if(printval=='' || printval==0)
                  {  
                	 getSetup();
                  }
                  if(localStorage.po == 'inventory')
                  {
                	  
            	  		checkenableprintoption();
	              }
	              else
	              {
	            	  	checkenableprintoption_cust();
	              }
            }
			if (localStorage.po == 'customer_opt') {
                $("#info").removeClass('ui-btn-active');
                $("#cust").addClass('ui-btn-active');
                page = '../customer_opt/cust_opt.html';
            }
            else if(localStorage.po == 'collection')
            {
                          $("#info").removeClass('ui-btn-active');
                          $("#cust").addClass('ui-btn-active');
                          page = '../customer_opt/autosettler.html';
            }
            else if(localStorage.po == 'advance')
            {
                          $("#info").removeClass('ui-btn-active');
                          $("#cust").addClass('ui-btn-active');
                          page = '../customer/advance_payment.html';
            }
            else if(localStorage.po == 'sales')
            {
                page = '../customer_opt/salesinvoice_option.html';
            }
            else if(localStorage.po == 'orderrequest')
            {
                page = '../customer_opt/orderRequest.html';
            }
            else if (localStorage.po == 'inventory') {
                
            	$("#info").removeClass('ui-btn-active');
                $("#inve").addClass('ui-btn-active');

                page = '../inventory/inventory.html';
            }
            else if (localStorage.po == 'settlement') {
                $("#info").removeClass('ui-btn-active');
                $("#sett").addClass('ui-btn-active');

                page = '../settlement/managesettlement.html';
            }
            else {
                page = '../information/information.html';
            }
                          
            $("#lnkExit").attr("href", page);
            $("#Back_inner").attr("href", page);

            // Check for current language and set css for that
            if (sessionStorage.getItem("Language") != "en") {
                window.lang.change('PrintOption' + lan, lan);
                window.lang.change('Footer' + lan, lan);

                if (lan == "AR") {
                    // Set html right alignment for arbic language
                    $(".centerboxInvReq").attr("dir", "rtl");

                    // Set header align
                    $('#Back_inner').removeClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                    $('#Back_inner').addClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                    $('#lang_inner').removeClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                    $('#lang_inner').addClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                }
            }
            else {
                // Change current language to english
                window.lang.change('en', 'en');

                // Set html left alignment for english language
                $(".centerboxInvReq").attr("dir", "ltr");

                // Set header align
                $('#Back_inner').removeClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                $('#Back_inner').addClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                $('#lang_inner').removeClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                $('#lang_inner').addClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
            }


            $("#bt1").click(function() {
            	if($("#bt1").attr('src') != '../images/r-btn-2-gray.png')
            	{
                	$("#bt1").attr('src', '../images/r-btn-1.png');
					if($("#bt2").attr('src') != '../images/r-btn-2-gray.png')                	
	                	$("#bt2").attr('src', '../images/r-btn-2.png');
					if($("#bt3").attr('src') != '../images/r-btn-2-gray.png')                	
	                	$("#bt3").attr('src', '../images/r-btn-2.png');
	                printstatus = 0;
                }
            });

            $("#bt2").click(function() {
            	if($("#bt2").attr('src') != '../images/r-btn-2-gray.png')
            	{
                	$("#bt2").attr('src', '../images/r-btn-1.png');
                	if($("#bt1").attr('src') != '../images/r-btn-2-gray.png')
                		$("#bt1").attr('src', '../images/r-btn-2.png');
					if($("#bt3").attr('src') != '../images/r-btn-2-gray.png')                		
                		$("#bt3").attr('src', '../images/r-btn-2.png');
                	printstatus = 1;
                }
            });

            $("#bt3").click(function() {
            	if($("#bt3").attr('src') != '../images/r-btn-2-gray.png')
            	{
            		printstatus = 2;
	                $("#bt3").attr('src', '../images/r-btn-1.png');
	                if($("#bt1").attr('src') != '../images/r-btn-2-gray.png')
	                	$("#bt1").attr('src', '../images/r-btn-2.png');
					if($("#bt2").attr('src') != '../images/r-btn-2-gray.png')	                	
	                	$("#bt2").attr('src', '../images/r-btn-2.png');
	                	
                }
            });
            function checkenableprintoption_cust()
            {
                          var Qry = "select enabledraftcopy,enabledelayprint FROM customermaster WHERE customercode="+ sessionStorage.getItem('customerid');
                          console.log(Qry);
                          if(platform == "iPad")
                          {
                          Cordova.exec(function(result) {
                                        if(result[0][0]==0)
                                        {
                                        $("#bt2").unbind('click');
                                        $("#bt2").attr('src', '../images/r-btn-2-gray.png');
                                        }
                                        if(result[0][1]==0)
                                        {
                                        $("#bt3").unbind('click');
                                        $("#bt3").attr('src', '../images/r-btn-2-gray.png');
                                        }
                                        },
                                        function(error) {
                                        alert(error);
                                        },
                                        "PluginClass",
                                        "GetdataMethod",
                                        [Qry]);
                          }
                          else if(platform == "Android")
                          {	                          	
                          		window.plugins.DataBaseHelper.select(Qry, function(result)
                          		{
                          			if(!$.isEmptyObject(result))
                          			{
                          				result = $.map(result.array, function(item, index) {
		                                	return [[item.enabledraftcopy,item.enabledelayprint]];
    	                      			});
                          				if (result[0][0] == 0) {
	                          				$("#bt2").unbind('click');
                          					$("#bt2").attr('src', '../images/r-btn-2-gray.png');
                          				}
                          				if (result[0][1] == 0) {
	                          				$("#bt3").unbind('click');
                          					$("#bt3").attr('src', '../images/r-btn-2-gray.png');
                          				}
                          			}
                          		},
                          		function()
                          		{
                          			console.warn("Error calling plugin");
                          		});                          	
                          }      
    
            }
            function getSetup() {
                var qry ="SELECT currencymaster.decimalplaces,routemaster.routeprinter FROM routemaster INNER JOIN currencymaster ON routemaster.amountdecimaldigits = currencymaster.currencycode WHERE routemaster.routecode = " + sessionStorage.getItem("RouteCode");
               
                if (platform == 'iPad') {
                    Cordova.exec(function(result) {
                        if (result.length > 0) {
                            sessionStorage.setItem("decimalplace", result[0][0]);
                            sessionStorage.setItem("printerval", result[0][1]);// ADded
																				// for
																				// printer
																				// value
																				// by
																				// mirnah
                        }
                        else {
                            sessionStorage.setItem("decimalplace", 0);
                            sessionStorage.setItem("printerval", 0);// ADded for
																	// printer
																	// value by
																	// mirnah
                        }
                    },
                            function(error) {
                                alert("Error in getting setup : " + error);
                            },
                            "PluginClass",
                            "GetdataMethod",
                            [qry]);
                }
                else if (platform == 'Android') {
                    window.plugins.DataBaseHelper.select(qry, function(result) {
                    
                        if (result.array != undefined) {
                            
                            sessionStorage.setItem("decimalplace", result.array[0].decimalplaces);
                            sessionStorage.setItem("printerval", result.array[0].routeprinter);// ADded
																								// for
																								// printer
																								// value
																								// by
																								// mirnah
                            printval=result.array[0].routeprinter;
                            
                        }
                        else {
                            sessionStorage.setItem("decimalplace", 0);
                            sessionStorage.setItem("printerval", 0);// ADded for
																	// printer
																	// value by
																	// mirnah
                            printval=0;
                        }
                    },
                    function() {
                        console.warn("Error calling plugin");
                    });
                }
            }
            function checkenableprintoption()
            {
            var Qry = "select enabledraftcopy,enabledelayprint FROM routemaster WHERE routecode=" + sessionStorage.getItem("RouteCode");
                          console.log(Qry);
                          if(platform == "iPad")
                          {
                          Cordova.exec(function(result) {
                                            if(result[0][0]==0)
                                            {
                                                $("#bt2").unbind('click');
                                                $("#bt2").attr('src', '../images/r-btn-2-gray.png');
                                            }
                                            if(result[0][1]==0)
                                            {
                                                $("#bt3").unbind('click');
                                                $("#bt3").attr('src', '../images/r-btn-2-gray.png');
                                            }
                                        },
                                        function(error) {
                                        alert(error);
                                        },
                                        "PluginClass",
                                        "GetdataMethod",
                                        [Qry]);
                          }
                          else if(platform == "Android")
                          {     
                          		window.plugins.DataBaseHelper.select(Qry, function(result) 
                                {
                                	if(!$.isEmptyObject(result))
                                	{
                                		result = $.map(result.array, function(item, index) {
	                                	  	return [[item.enabledraftcopy, item.enabledelayprint]];
                          				});                                	
                                		if (result[0][0] == 0) {
	                                		$("#bt2").unbind('click');
                                			$("#bt2").attr('src', '../images/r-btn-2-gray.png');
                                		}
                                		if (result[0][1] == 0) {
	                                		$("#bt3").unbind('click');
                                			$("#bt3").attr('src', '../images/r-btn-2-gray.png');
                                		}
                                	}
                                },
                                function()
                                {
                                	console.warn("Error calling plugin");
                                });
                          }      
            }
            function toogleClass(element) {
                if ($(element).attr("src") == '../images/r-btn-1.png') {
                    $(element).attr("src", "../images/r-btn-2.png");
                }
                else {
                    $(element).attr("src", "../images/r-btn-1.png");
                }
            }

        });
        
        function GetDocumentNumber()
        {
            var Qry = "SELECT CASE WHEN MAX(bodocseq) IS NULL OR MAX(bodocseq) <=0 OR MAX(bodocseq) = '' OR MAX(bodocseq) = 'null' THEN 0 ELSE bodocseq END AS documentnumber FROM routemaster WHERE routecode=" + sessionStorage.getItem("RouteCode");
            console.log(Qry);
            if(platform == "iPad")
            {
                Cordova.exec(function(result) {
                              if(result.length > 0)
                              {
                              var DocPrefix  = sessionStorage.getItem("RouteCode").toString();
                              DocumentNumber = DocPrefix.toString() + (eval(result[0][0]) + 1).toString().lpad("0",7);                               
                              SaveFinalData();
                              }
                              },
                              function(error) {
                              alert(error);
                              },
                              "PluginClass",
                              "GetdataMethod",
                              [Qry]);
            }
            else if(platform == "Android")
            {
                window.plugins.DataBaseHelper.select(Qry, function(result) 
                                                     {                                                     
                                                     var DocPrefix  = sessionStorage.getItem("RouteCode").toString();
                                                     DocumentNumber = DocPrefix.toString() + (eval(result.array[0].documentnumber) + 1).toString().lpad("0",6);                                                                                                
                                                   	 SaveFinalData();
                                                     },
                                                     function() 
                                                     {
                                                     console.warn("Error calling plugin");
                                                     });
            }
        }
		function UpdateRouteMasterDocumentNumber()
        {
          
            var Qry = "UPDATE routemaster SET bodocseq = (ifnull(bodocseq,0) + 1)," + InvoiceNumberField + " = (ifnull(" + InvoiceNumberField + ",0) + 1) WHERE routecode=" + sessionStorage.getItem("RouteCode");
            console.log(Qry);
            if(platform == "iPad")
            {
                console.log("LocalStorage PO : " + localStorage.po);
                Cordova.exec(function(result) {   
                    SelectPrint();
                },
                function(error) {
                    alert(error);
                },
                "PluginClass",
                "InsertUpdateMethod",
                [Qry]);
            }
            else if(platform == "Android")
            {
            	window.plugins.DataBaseHelper.insert(Qry,function(result){                	
                    SelectPrint();
            	     
                    // Pairedprinter();
                },
                function()
                {
                    console.warn("Error calling plugin");
                });    
        	}
        }
		function checkDocumentNo(){
			var Qry = "select max(documentnumber) as docno from invoiceheader where routekey="+sessionStorage.getItem("RouteKey");
            console.log(Qry);
            if(platform == "iPad")
            {
                Cordova.exec(function(result) 
                {
                        if(result.length > 0)
                        {
		                        var DocPrefix  = sessionStorage.getItem("RouteCode").toString();
		                        DocumentNumber = DocPrefix.toString() + (eval(result[0][0]) + 1).toString().lpad("0",6);                               
		                        
                        }
                        },
                        function(error) {
                        alert(error);
                },
                "PluginClass",
                "GetdataMethod",
                [Qry]);
            }
            else if(platform == "Android")
            {
                window.plugins.DataBaseHelper.select(Qry, function(result) 
                {                                                     
			                // alert(DocumentNumber);
			               // alert(result.array[0].documentnumber);
			                if(eval(DocumentNumber)==eval(result.array[0].documentnumber)){
			                	DocumentNumber=(eval(DocumentNumber)+1).toString()
			                }	
			                // alert(DocumentNumber);
			                SaveFinalData();
                },
                function() 
                {
                			console.warn("Error calling plugin");
                });
            }
			
		
		}

        function SaveFinalData() {
          
            
            $("#lnkNext").attr("onclick","");                   
            $("#cntlbl").addClass('MenuGray');
            $("#Back_inner").attr("href",'#');
            
            $("#lnkExit").attr("onclick","");                   
            $("#extlbl").addClass('MenuGray');
            $("#Back_inner").attr("href",'#');
            
            var rlink;  
            if(localStorage.po == "inventory")
            {
            	 rlink = "../inventory/inventory.html";
            }
            else if(localStorage.po == 'sales'){
            	
            	 rlink = "../customer_opt/cust_opt.html";
            }	
            else
            {
            	 rlink = "../customer_opt/cust_opt.html";
            }
                                  
           	$("#lnkExit").attr("href", "#");
            $.mobile.showPageLoadingMsg();       
            if (localStorage.po == 'sales' || localStorage.po == 'customer_opt') {
            	var manualfree=window.localStorage.getItem("manualfree");
                if((sessionStorage.getItem("SignEnabled") == 1  && sessionStorage.getItem("invoicepaymentterms") == 2) || (eval(manualfree)>0 && sessionStorage.getItem("invoicepaymentterms") == 2))
                {
                	localStorage.setItem("roundredirect",'print_option');
                	getRoundingline();
                   
                }else{
                	
                	DeleteSalesTempData();
                }
                var rlink = "../customer_opt/cust_opt.html";
             
              	
            }
            if (localStorage.po == 'inventory') {
                // alert(localStorage.po + " : " + $("#bt1").attr("src"));
                 if(sessionStorage.onlyopeningstock == 1)
                 {
                    var rlink = "../inventory/inventory.html";
                    if(sessionStorage.getItem('syncmode') == 1)
                    {
                        // senddata('print',rlink);
						senddata('inv',rlink);
                    }
                    else
                    {
                    	getLangText("Transaction Saved Successfully.");  
                        if(localStorage.po == "inventory")
                            window.location = rlink;
                        else
                            window.location = rlink;
                    }
                 }
                 else
                    SaveStartingLoadDetail();
                 // navigator.notification.alert("Data save successfully");
                 
            }
            if(localStorage.po == "orderrequest")
            {
                 SavePromotionDetailorderData();
                 saveCCForOdrCollection();
                 SaveOrderDetail();
               
            }
            if(localStorage.po == "collection")
            {
            	saveCCForOdrCollection();
                // SetCustomerInvoice();
                GetCollectionPaymentType();
            }
            
            if(localStorage.po == "advance")
            {
            	DocNos=JSON.parse(localStorage.getItem("DocNos"));
            	
            	insertAdvaancePaymentDocs();
            	
            }
        }
        function insertAdvaancePaymentDocs(){
        	
        	
        	if(DocNos !=undefined && DocNos.length>0){
        		
        		var documents=DocNos.shift();
        		
        		insertarAdvance(documents);
        		
        	}else{
        		saveCCForOdrCollection();
                UpdateCustomerMasterBalance(0);
        		
        		
        	}
        	
        	
        	
        	
        }
        
        
        function insertarAdvance(document){
        	
        	var Qry="INSERT into ardetail(routekey,visitkey,transactionkey,invoicenumber,invoicedate,totalinvoiceamount,amountpaid,invoicebalance,issync,istemp,pdcbalance,salesmancode,alternateinvoicenumber) VALUES(" + sessionStorage.getItem("RouteKey") + "," + sessionStorage.getItem("VisitKey") + ",0," + document + ",(SELECT transactiondate FROM customerinvoice WHERE invoicenumber = " + document + "),(SELECT totalinvoiceamount FROM customerinvoice WHERE invoicenumber = " + document + "),0,0,0,'false',0,(SELECT CASE status WHEN 1 THEN (SELECT salesmancode FROM customerinvoice WHERE invoicenumber = " + document + ") ELSE " + sessionStorage.getItem("SalesmanCode") + " END FROM controlpanel WHERE flagid = 71),(SELECT erpreferencenumber FROM customerinvoice WHERE invoicenumber = " +  document + "))";
        	if(platform == "iPad")
            {
               
            }
            else if(platform == "Android")
            {
               
                    window.plugins.DataBaseHelper.insert(Qry,function(result)
                    {
                    	insertAdvaancePaymentDocs();
                    },
                    function()
                    {
                        console.warn("Error calling plugin");
                    });
               
            }
        	
        	
        	
        }
        
        // -----------Start---------------17th March By Mirnah
        function Updateinvoiceheadersyncstatus() {
            // var Qry = "UPDATE inventorysummarydetail SET saleqty = (SELECT
			// IFNULL(SUM(id.salesqty),0) FROM invoicedetail id Where
			// inventorysummarydetail.routekey =id.routekey AND
			// inventorysummarydetail.itemcode = id.itemcode AND id.istemp =
			// 'false'),returnqty = (SELECT IFNULL(SUM(id.returnqty),0) FROM
			// invoicedetail id Where inventorysummarydetail.routekey =
			// id.routekey AND inventorysummarydetail.itemcode = id.itemcode AND
			// id.istemp = 'false'),returnfreeqty = (SELECT
			// IFNULL(SUM(id.returnfreeqty),0) FROM invoicedetail id Where
			// inventorysummarydetail.routekey = id.routekey AND
			// inventorysummarydetail.itemcode = id.itemcode AND id.istemp =
			// 'false'),damageqty = (SELECT IFNULL(SUM(id.damagedqty),0) FROM
			// invoicedetail id Where inventorysummarydetail.routekey =
			// id.routekey AND inventorysummarydetail.itemcode = id.itemcode AND
			// id.istemp = 'false'),expiryqty = (SELECT
			// IFNULL(SUM(id.expiryqty),0) FROM invoicedetail id Where
			// inventorysummarydetail.routekey = id.routekey AND
			// inventorysummarydetail.itemcode = id.itemcode AND id.istemp =
			// 'false'),freesampleqty = (SELECT
			// IFNULL(SUM(id.manualfreeqty+id.freesampleqty),0) FROM
			// invoicedetail id Where inventorysummarydetail.routekey =
			// id.routekey AND inventorysummarydetail.itemcode = id.itemcode AND
			// id.istemp = 'false'),rentqty = (SELECT
			// IFNULL(SUM(id.rebaterentqty+id.fixedrentqty),0) FROM
			// invoicedetail id Where inventorysummarydetail.routekey =
			// id.routekey AND inventorysummarydetail.itemcode = id.itemcode AND
			// id.istemp = 'false')";
             var Qry = "UPDATE invoiceheader SET issync = 0 where transactionkey in (select Distinct transactionkey from invoicedetail where issync=0)";
             console.log(Qry);
             if(platform == "iPad")
             {
                 Cordova.exec(function(result) {
                     // navigator.notification.alert("Save invoice rxd detail
						// record successfully");
                 },
                 function(error) {
                     navigator.notification.alert("Error save invoice rxd detail record");
                 },
                 "PluginClass",
                 "InsertUpdateMethod",
                 [Qry]);
             }
             else if(platform == "Android")
             {
                 window.plugins.DataBaseHelper.insert(Qry, function(result) {
                     
                 },
                 function() {
                     console.warn("Error calling plugin");
                 });
             }
         }
        function Updateinventoryvalue() {
           // var Qry = "UPDATE inventorysummarydetail SET saleqty = (SELECT
			// IFNULL(SUM(id.salesqty),0) FROM invoicedetail id Where
			// inventorysummarydetail.routekey =id.routekey AND
			// inventorysummarydetail.itemcode = id.itemcode AND id.istemp =
			// 'false'),returnqty = (SELECT IFNULL(SUM(id.returnqty),0) FROM
			// invoicedetail id Where inventorysummarydetail.routekey =
			// id.routekey AND inventorysummarydetail.itemcode = id.itemcode AND
			// id.istemp = 'false'),returnfreeqty = (SELECT
			// IFNULL(SUM(id.returnfreeqty),0) FROM invoicedetail id Where
			// inventorysummarydetail.routekey = id.routekey AND
			// inventorysummarydetail.itemcode = id.itemcode AND id.istemp =
			// 'false'),damageqty = (SELECT IFNULL(SUM(id.damagedqty),0) FROM
			// invoicedetail id Where inventorysummarydetail.routekey =
			// id.routekey AND inventorysummarydetail.itemcode = id.itemcode AND
			// id.istemp = 'false'),expiryqty = (SELECT
			// IFNULL(SUM(id.expiryqty),0) FROM invoicedetail id Where
			// inventorysummarydetail.routekey = id.routekey AND
			// inventorysummarydetail.itemcode = id.itemcode AND id.istemp =
			// 'false'),freesampleqty = (SELECT
			// IFNULL(SUM(id.manualfreeqty+id.freesampleqty),0) FROM
			// invoicedetail id Where inventorysummarydetail.routekey =
			// id.routekey AND inventorysummarydetail.itemcode = id.itemcode AND
			// id.istemp = 'false'),rentqty = (SELECT
			// IFNULL(SUM(id.rebaterentqty+id.fixedrentqty),0) FROM
			// invoicedetail id Where inventorysummarydetail.routekey =
			// id.routekey AND inventorysummarydetail.itemcode = id.itemcode AND
			// id.istemp = 'false')";
            // var Qry = "UPDATE inventorysummarydetail SET saleqty = (SELECT
			// IFNULL(SUM(IFNULL(id.salesqty,0)),0) FROM invoicedetail id Where
			// inventorysummarydetail.routekey = id.routekey AND
			// inventorysummarydetail.itemcode = id.itemcode AND id.istemp =
			// 'false'),returnqty = (SELECT
			// IFNULL(SUM(IFNULL(id.returnqty,0)),0) FROM invoicedetail id Where
			// inventorysummarydetail.routekey = id.routekey AND
			// inventorysummarydetail.itemcode = id.itemcode AND id.istemp =
			// 'false'),returnfreeqty = (SELECT
			// IFNULL(SUM(IFNULL(id.returnfreeqty,0)),0) FROM invoicedetail id
			// Where inventorysummarydetail.routekey = id.routekey AND
			// inventorysummarydetail.itemcode = id.itemcode AND id.istemp =
			// 'false'),damageqty = (SELECT
			// IFNULL(SUM(IFNULL(id.damagedqty,0)),0) FROM invoicedetail id
			// Where inventorysummarydetail.routekey = id.routekey AND
			// inventorysummarydetail.itemcode = id.itemcode AND id.istemp =
			// 'false'),expiryqty = (SELECT
			// IFNULL(SUM(IFNULL(id.expiryqty,0)),0) FROM invoicedetail id Where
			// inventorysummarydetail.routekey = id.routekey AND
			// inventorysummarydetail.itemcode = id.itemcode AND id.istemp =
			// 'false'),freesampleqty = (SELECT
			// IFNULL(SUM(IFNULL(id.manualfreeqty,0)+IFNULL(id.freesampleqty,0)),0)
			// FROM invoicedetail id Where inventorysummarydetail.routekey =
			// id.routekey AND inventorysummarydetail.itemcode = id.itemcode AND
			// id.istemp = 'false'),rentqty = (SELECT
			// IFNULL(SUM(IFNULL(id.rebaterentqty,0)+IFNULL(id.fixedrentqty,0)),0)
			// FROM invoicedetail id Where inventorysummarydetail.routekey =
			// id.routekey AND inventorysummarydetail.itemcode = id.itemcode AND
			// id.istemp = 'false')";
            var Qry ="UPDATE inventorysummarydetail SET saleqty = (SELECT IFNULL(SUM(IFNULL(id.salesqty,0)),0) FROM invoicedetail id JOIN invoiceheader ih ON ih.transactionkey=id.transactionkey Where inventorysummarydetail.routekey = id.routekey AND inventorysummarydetail.itemcode = id.itemcode AND id.istemp = 'false' AND ih.voidflag IS NOT 1), returnqty = (SELECT IFNULL(SUM(IFNULL(id.returnqty,0)),0) FROM invoicedetail id JOIN invoiceheader ih ON ih.transactionkey=id.transactionkey Where inventorysummarydetail.routekey = id.routekey AND inventorysummarydetail.itemcode = id.itemcode AND id.istemp = 'false' AND ih.voidflag IS NOT 1), returnfreeqty = (SELECT IFNULL(SUM(IFNULL(id.returnfreeqty,0)),0) FROM invoicedetail id  JOIN invoiceheader ih ON ih.transactionkey=id.transactionkey Where inventorysummarydetail.routekey = id.routekey AND inventorysummarydetail.itemcode = id.itemcode AND id.istemp = 'false' AND ih.voidflag IS NOT 1), damageqty = (SELECT IFNULL(SUM(IFNULL(id.damagedqty,0)),0) FROM invoicedetail id JOIN invoiceheader ih ON ih.transactionkey=id.transactionkey Where inventorysummarydetail.routekey = id.routekey AND inventorysummarydetail.itemcode = id.itemcode AND id.istemp = 'false' AND ih.voidflag IS NOT 1), expiryqty = (SELECT IFNULL(SUM(IFNULL(id.expiryqty,0)),0) FROM invoicedetail id JOIN invoiceheader ih ON ih.transactionkey=id.transactionkey Where inventorysummarydetail.routekey = id.routekey AND inventorysummarydetail.itemcode = id.itemcode AND id.istemp = 'false' AND ih.voidflag IS NOT 1),freesampleqty = (SELECT IFNULL(SUM(IFNULL(id.manualfreeqty,0)+IFNULL(id.freesampleqty,0)),0) FROM invoicedetail id JOIN invoiceheader ih ON ih.transactionkey=id.transactionkey Where inventorysummarydetail.routekey = id.routekey AND inventorysummarydetail.itemcode = id.itemcode AND id.istemp = 'false' AND ih.voidflag IS NOT 1),rentqty = (SELECT IFNULL(SUM(IFNULL(id.rebaterentqty,0)+IFNULL(id.fixedrentqty,0)),0) FROM invoicedetail id JOIN invoiceheader ih ON ih.transactionkey=id.transactionkey Where inventorysummarydetail.routekey = id.routekey AND inventorysummarydetail.itemcode = id.itemcode AND id.istemp = 'false' AND ih.voidflag IS NOT 1)";
            console.log(Qry);
            if(platform == "iPad")
            {
                Cordova.exec(function(result) {
                    // navigator.notification.alert("Save invoice rxd detail
					// record successfully");
                },
                function(error) {
                    navigator.notification.alert("Error save invoice rxd detail record");
                },
                "PluginClass",
                "InsertUpdateMethod",
                [Qry]);
            }
            else if(platform == "Android")
            {
                window.plugins.DataBaseHelper.insert(Qry, function(result) {
                    Updateinvoiceheadersyncstatus();
                },
                function() {
                    console.warn("Error calling plugin");
                });
            }
        }
        // -----------End
        function DeleteSalesTempData() {
            var routekey = sessionStorage.getItem("RouteKey");
            var visitkey = sessionStorage.getItem("VisitKey");
            var Qry = "";            
            Qry += "DELETE FROM invoicerxddetail WHERE routekey=" + routekey + " AND visitkey=" + visitkey + " AND IFNULL(quantity,0) = 0 AND istemp = 'true';";
            Qry += "DELETE FROM customerinventorydetail WHERE routekey = " + routekey + " AND visitkey= " + visitkey + " AND IFNULL(qtyloc1each,0) = 0 AND IFNULL(qtyloc2each,0) = 0 AND IFNULL(qtyloc3each) = 0";
            console.log(Qry);
            if(platform == "iPad")
            {
                Cordova.exec(function(result) {                    
                },
                function(error) {
                    navigator.notification.alert("Error save promtion detail record");
                },
                "PluginClass",
                "InsertUpdateMethod",
                [Qry]);
            }
            else if(platform == "Android")
            {
            	// alert("Delete Sales Temp Data");
            	// alert(Qry);
                window.plugins.DataBaseHelper.insert(Qry, function(result) {
                	SavePromotionDetailData();
                },
				function() {
                	SavePromotionDetailData();
				    console.warn("Error calling plugin");
				});
            }
           
        }
		function SavePromotionDetailData() {
            var Qry = "Update promotiondetail set istemp = 'false',issync=0,transactionkey=(SELECT transactionkey FROM invoiceheader WHERE routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey = " + sessionStorage.getItem("VisitKey") + ") where routekey = " + sessionStorage.getItem('RouteKey') + " and visitkey = " + sessionStorage.getItem('VisitKey') + "";
            if(platform == "iPad")
            {
                     Cordova.exec(function(result) {
                    // navigator.notification.alert("Save promtion detail record
					// successfully");
            },
            function(error) {
                navigator.notification.alert("Error save promtion detail record");
            },
            "PluginClass",
            "InsertUpdateMethod",
            [Qry]);
            }
            else if(platform == "Android")
            {
            	// alert("Update PromotionDetail");
                window.plugins.DataBaseHelper.select(Qry, function(result) {
                	savecustomercontrol();
                },
				function() {
                	savecustomercontrol();
				    console.warn("Error calling plugin");
				});
            }
           
        }
        function SavePromotionDetailorderData() {
            var Qry = "Update promotiondetail set istemp = 'false',issync=0,transactionkey=(SELECT transactionkey FROM salesorderheader WHERE routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey = " + sessionStorage.getItem("VisitKey") + ") where routekey = " + sessionStorage.getItem('RouteKey') + " and visitkey = " + sessionStorage.getItem('VisitKey') + "";
            if(platform == "iPad")
            {
                 Cordova.exec(function(result) 
                 {
                              // navigator.notification.alert("Save promtion
								// detail record successfully");
	             },
	             function(error) {
	            			navigator.notification.alert("Error save promtion detail record");
	             },
	             "PluginClass",
	             "InsertUpdateMethod",
	             [Qry]);
            }
            else if(platform == "Android")
            {
                 window.plugins.DataBaseHelper.select(Qry, function(result) 
                 {
                                                     
                 },
                 function() {
                	 console.warn("Error calling plugin");
                 });
            }
            
        }
        function savecustomercontrol()
        {
        	
        	if(printstatus==1){
        		
        		GetOrderToSales();
        		
        	}else{
        		var mydate = new Date();
                
                var thehour = mydate.getHours();
                var theminut = mydate.getMinutes();
                var time = thehour+":"+theminut;
                    
                var Qry = "Update customeroperationscontrol set totaltransactions = totaltransactions+1,visitendtime='"+time+"',issync=0 where routekey = " + sessionStorage.getItem('RouteKey') + " and visitkey = " + sessionStorage.getItem('VisitKey') + " and customercode="+ sessionStorage.getItem('customerid')+" and routecode="+ sessionStorage.getItem('RouteCode');
                console.log(Qry);
                if(platform == "iPad")
                {
                    Cordova.exec(function(result) {
                                  // navigator.notification.alert("Save promtion
    								// detail record successfully");
                                  },
                                  function(error) {
                                  navigator.notification.alert("Error save promtion detail record");
                                  },
                                  "PluginClass",
                                  "InsertUpdateMethod",
                                  [Qry]);
                }
                else if(platform == "Android")
                {
                	// alert("Save Customer Controll");
                    window.plugins.DataBaseHelper.insert(Qry, function(result) {
                    												GetOrderToSales();
                                                         },
                                                         function() {
                                                        	 	GetOrderToSales();
                                                         console.warn("Error calling plugin");
                                                         });
                }
        		
        	}
            
        }
        function saveCCForOdrCollection()
        {
            var mydate = new Date();
            
            var thehour = mydate.getHours();
            var theminut = mydate.getMinutes();
            var time = thehour+":"+theminut;
                
            var Qry = "Update customeroperationscontrol set totaltransactions = totaltransactions+1,visitendtime='"+time+"',issync=0 where routekey = " + sessionStorage.getItem('RouteKey') + " and visitkey = " + sessionStorage.getItem('VisitKey') + " and customercode="+ sessionStorage.getItem('customerid')+" and routecode="+ sessionStorage.getItem('RouteCode');
            console.log(Qry);
            if(platform == "iPad")
            {
                Cordova.exec(function(result) {
                              // navigator.notification.alert("Save promtion
								// detail record successfully");
                              },
                              function(error) {
                              navigator.notification.alert("Error save promtion detail record");
                              },
                              "PluginClass",
                              "InsertUpdateMethod",
                              [Qry]);
            }
            else if(platform == "Android")
            {
            	// alert("Save Customer Controll");
                window.plugins.DataBaseHelper.insert(Qry, function(result) {
                											
                                                     },
                                                     function() {
                                                    	 	
                                                     console.warn("Error calling plugin");
                                                     });
            }
        }
        
        
        function savebatchexpirydetail()
        {
           var batchqty = "CASE WHEN batchexpirydetail.transactiontypecode = 15 THEN ifnull(batchmaster_temp.quantity,0)-ifnull(batchmaster_temp.freeqty,0)+ifnull(batchmaster_temp.returnqty,0)+ifnull(batchmaster_temp.buybackqty,0)-ifnull(batchmaster_temp.rentalqty,0)-ifnull(batchmaster_temp.promoqty,0)+ifnull(batchmaster_temp.loadaddqty,0)-ifnull(batchmaster_temp.loadcutqty,0) WHEN batchexpirydetail.transactiontypecode = 16 THEN ifnull(batchmaster_temp.quantity,0)-ifnull(batchmaster_temp.salesqty,0)+ifnull(batchmaster_temp.returnqty,0)+ifnull(batchmaster_temp.buybackqty,0)-ifnull(batchmaster_temp.rentalqty,0)-ifnull(batchmaster_temp.promoqty,0)+ifnull(batchmaster_temp.loadaddqty,0)-ifnull(batchmaster_temp.loadcutqty,0) WHEN batchexpirydetail.transactiontypecode = 17 THEN ifnull(batchmaster_temp.quantity,0)-ifnull(batchmaster_temp.salesqty,0)-ifnull(batchmaster_temp.freeqty,0)+ifnull(batchmaster_temp.returnqty,0)+ifnull(batchmaster_temp.buybackqty,0)-ifnull(batchmaster_temp.rentalqty,0)+ifnull(batchmaster_temp.loadaddqty,0)-ifnull(batchmaster_temp.loadcutqty,0) ELSE ifnull(batchmaster_temp.quantity,0)-ifnull(batchmaster_temp.salesqty,0)-ifnull(batchmaster_temp.freeqty,0)+ifnull(batchmaster_temp.returnqty,0)+ifnull(batchmaster_temp.buybackqty,0)-ifnull(batchmaster_temp.promoqty,0)+ifnull(batchmaster_temp.loadaddqty,0)-ifnull(batchmaster_temp.loadcutqty,0) END";
            var selectqry ="select batchexpirydetail.batchnumber,batchexpirydetail.batchdetailkey,batchexpirydetail.itemcode,batchexpirydetail.quantity,batchexpirydetail.transactiontypecode from batchexpirydetail join batchmaster_temp on batchmaster_temp.batchnumber=batchexpirydetail.batchnumber and batchmaster_temp.itemcode=batchexpirydetail.itemcode where batchexpirydetail.quantity > "+batchqty+" and routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + sessionStorage.getItem("VisitKey")+" and istemp='true' and batchexpirydetail.transactiontypecode not in(18,19,20,21)";
            console.log(selectqry);
            if(platform == "iPad")
            {
                Cordova.exec(function(result) {
                              if(result.length > 0)
                              {
                              selectbatchexpirydetail(result,0);
                              }
                              else
                              {
                              updatebatchexpirytemp();
                              }
                              },
                              function(error) {
                              navigator.notification.alert("Error save promtion detail record");
                              },
                              "PluginClass",
                              "GetdataMethod",
                              [selectqry]);
            }
            else if(platform == "Android")
            {
                window.plugins.DataBaseHelper.select(selectqry, function(result) {
                	if(!$.isEmptyObject(result))
                    {
	                	if(result.array.length > 0)
                		{
	                		selectbatchexpirydetail(result,0);
                		}
                	}
                	else
                	{
                		updatebatchexpirytemp();
                	}
                },
                function() {
                	console.warn("Error calling plugin");
                });
            }
        }
        function selectbatchexpirydetail(result1,j)
        {
            deletebatchexpirydetail(result1,j);
            updatebatchmastertemp(result1,j);
            var batchqty2 = "ifnull(quantity,0)-ifnull(salesqty,0)-ifnull(freeqty,0)+ifnull(returnqty,0)-ifnull(rentalqty,0)-ifnull(promoqty,0)+ifnull(loadaddqty,0)-ifnull(loadcutqty,0)";
            var selectqry = "select batchnumber,"+batchqty2+" as qty,expirydate,"+result1[j][1]+" as batchdetailkey,itemcode,"+result1[j][4]+" as transactiontype from batchmaster_temp where itemcode="+result1[j][2]+" and quantity > 0 order by expirydate";
            console.log(selectqry);
            if(platform == "iPad")
            {
                Cordova.exec(function(result) {
                              var i = 0;
                              var batchquantity = eval(result1[j][3]);
                              while(batchquantity > 0)
                              {
                              if(eval(result[i][1]) > batchquantity)
                              {
                              var assignqty = eval(batchquantity);
                              batchquantity = 0;
                              }
                              else
                              {
                              var assignqty = eval(result[i][1]);
                              batchquantity= batchquantity - eval(assignqty);
                              i=i+1;
                              }
                              var insertqry = "INSERT INTO `batchexpirydetail` ('batchnumber','itemcode','expirydate','quantity','transactiontypecode','routekey','visitkey','issync','istemp') VALUES ('"+result[i][0] +"','"+result[i][4] +"','"+result[i][2] +"','"+assignqty +"',"+result[i][5]+"," + sessionStorage.getItem('RouteKey') + "," + sessionStorage.getItem('VisitKey') + ",0,'true')";
                              console.log(insertqry);
                              updatebatchmaster(result[i][4],result[i][0],assignqty);
                              Cordova.exec(function(result) {
                                            
                                            },
                                            function(error) {
                                            navigator.notification.alert(error);
                                            },
                                            "PluginClass",
                                            "InsertUpdateMethod",
                                            [insertqry]);
                              
                              }
                              },
                              function(error) {
                              navigator.notification.alert("Error save promtion detail record");
                              },
                              "PluginClass",
                              "GetdataMethod",
                              [selectqry]);
            }
            else if(platform == "Android")
            {
                window.plugins.DataBaseHelper.select(selectqry, function(result) {
                                                     var result = $.map(result.array, function(item, index) {
                                                                        return [[item.batchnumber,item.quantity,item.expirydate]];
                                                                        });
                                                     var i = 0;
                                                     var batchquantity = CurrQty;
                                                     while(batchquantity > 0)
                                                     {
                                                     if(eval(result[i][1]) > batchquantity)
                                                     {
                                                     var assignqty = eval(batchquantity);
                                                     batchquantity = 0;
                                                     }
                                                     else
                                                     {
                                                     var assignqty = eval(result[i][1]);
                                                     batchquantity= batchquantity - eval(assignqty);
                                                     i=i+1;
                                                     }
                                                     var insertqry = "INSERT INTO `batchexpirydetail` ('batchnumber','itemcode','expirydate','quantity','transactiontypecode','routekey','visitkey','issync','istemp') VALUES ('"+result[i][0] +"','"+result[i][4] +"','"+result[i][2] +"','"+assignqty +"',"+result[i][5]+"," + sessionStorage.getItem('RouteKey') + "," + sessionStorage.getItem('VisitKey') + ",0,'true')";
                                                     updatebatchmaster(result[i][4],result[i][0],assignqty,result[i][5]);
                                                     window.plugins.DataBaseHelper.insert(insertqry, function(result) {
                                                                                          
                                                                                          },
                                                                                          function() {
                                                                                          console.warn("Error calling plugin");
                                                                                          });
                                                     }
                                                     },
                                                     function() {
                                                     console.warn("Error calling plugin");
                                                     });
            }
        }
        function deletebatchexpirydetail(data,i)
        {
            var updateqry = "delete from batchexpirydetail where itemcode="+data[i][2]+" and batchnumber='"+data[i][0]+"' and routekey="+sessionStorage.getItem('RouteKey')+" and visitkey="+sessionStorage.getItem('VisitKey');
            if(platform == "iPad"){
                Cordova.exec(function(result) {
                              
                              },
                              function(error) {
                              navigator.notification.alert(error);
                              },
                              "PluginClass",
                              "InsertUpdateMethod",
                              [updateqry]);
            }
            else if (platform == "Android") {
                window.plugins.DataBaseHelper.insert(updateqry, function(result) {
                                                     
                                                     },
                                                     function() {
                                                     console.warn("Error calling plugin");
                                                     });
            }
        }
        function updatebatchmastertemp(data,i)
        {
            console.log(data[i]);
            var transactiontype = eval(data[i][4]);
            console.log("transactiontype="+transactiontype);
            if(transactiontype ==15)
            {
                batchqty='salesqty';
            }
            else if(transactiontype ==16)
            {
                batchqty='freeqty';
            }
            else if(transactiontype ==18)
            {
                batchqty='returnqty';                
            }
            else if(transactiontype ==19)
            {
                batchqty='buybackqty';                
            }
            else if(transactiontype ==20)
            {
                batchqty='damagedqty';                
            }
            else if(transactiontype ==21)
            {
                batchqty='expiryqty';                
            }
            else if(transactiontype ==22)
            {
                batchqty='rentalqty';                
            }
            else if(transactiontype ==17)
            {
                batchqty='promoqty';                
            }
            var updateqry = "update batchmaster_temp set "+batchqty+"="+batchqty+"-"+data[i][3]+" where itemcode="+data[i][2]+" and batchnumber='"+data[i][0]+"'";
            if(platform == "iPad"){
                Cordova.exec(function(result) {
                              
                              },
                              function(error) {
                              navigator.notification.alert(error);
                              },
                              "PluginClass",
                              "InsertUpdateMethod",
                              [updateqry]);
            }
            else if (platform == "Android") {
                window.plugins.DataBaseHelper.insert(updateqry, function(result) {
                                                     
                                                     },
                                                     function() {
                                                     console.warn("Error calling plugin");
                                                     });
            }
        }
        function updatebatchmaster(itemcode,batchnumber,quantity,transactiontype)
        {
            if(transactiontype ==15)
            {
                batchqty='salesqty';
            }
            else if(transactiontype ==16)
            {
                batchqty='freeqty';
            }
            else if(transactiontype ==18)
            {
                batchqty='returnqty';                
            }
            else if(transactiontype ==19)
            {
                batchqty='buybackqty';                
            }
            else if(transactiontype ==20)
            {
                batchqty='damagedqty';                
            }
            else if(transactiontype ==21)
            {
                batchqty='expiryqty';                
            }
            else if(transactiontype ==22)
            {
                batchqty='rentalqty';                
            }
            else if(transactiontype ==17)
            {
                batchqty='promoqty';                
            }
            var updateqry = "update batchmaster_temp set "+batchqty+"="+quantity+" where itemcode="+itemcode+" and batchnumber='"+batchnumber+"'";
            if (platform == "iPad") {
                Cordova.exec(function(result) {
                              updatebatchexpirytemp();
                              },
                              function(error) {
                              navigator.notification.alert(error);
                              },
                              "PluginClass",
                              "InsertUpdateMethod",
                              [updateqry]);
            }
            else if (platform == "Android") {
                window.plugins.DataBaseHelper.insert(updateqry, function(result) {
                                                     updatebatchexpirytemp();
                                                     },
                                                     function() {
                                                     console.warn("Error calling plugin");
                                                     });
            }
            
        }
        function updatebatchexpirytemp()
        {
            var updateqry = "update batchexpirydetail set istemp='false' where routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + sessionStorage.getItem("VisitKey");
            if (platform == "iPad") {
                Cordova.exec(function(result) {
                              updatebatchmaster_temp();
                              },
                              function(error) {
                              navigator.notification.alert(error);
                              },
                              "PluginClass",
                              "InsertUpdateMethod",
                              [updateqry]);
            }
            else if (platform == "Android") {
                window.plugins.DataBaseHelper.insert(updateqry, function(result) {
                                                     updatebatchmaster_temp();
                                                     },
                                                     function() {
                                                     console.warn("Error calling plugin");
                                                     });
            }

        }
        function updatebatchmaster_temp()
        {
            var batchqty = "ifnull(batchmaster_temp.quantity,0)-ifnull(batchmaster_temp.salesqty,0)-ifnull(batchmaster_temp.freeqty,0)+ifnull(batchmaster_temp.returnqty,0)+ifnull(batchmaster_temp.buybackqty,0)-ifnull(batchmaster_temp.rentalqty,0)-ifnull(batchmaster_temp.promoqty,0)+ifnull(batchmaster_temp.loadaddqty,0)-ifnull(batchmaster_temp.loadcutqty,0)";
            var updateqry = "update batchmaster set quantity = (select "+batchqty+" from batchmaster_temp where batchmaster_temp.batchnumber=batchmaster.batchnumber and batchmaster_temp.itemcode=batchmaster.itemcode) where exists (select "+batchqty+" from batchmaster_temp where batchmaster_temp.batchnumber=batchmaster.batchnumber and batchmaster_temp.itemcode=batchmaster.itemcode)";
            var badupdateqry = "update batchmaster set damagequantity = (select ifnull(badquantity,0)+ifnull(batchmaster_temp.damageqty,0)+ifnull(batchmaster_temp.expiryqty,0) from batchmaster_temp where batchmaster_temp.batchnumber=batchmaster.batchnumber and batchmaster_temp.itemcode=batchmaster.itemcode) where exists (select ifnull(badquantity,0)+ifnull(batchmaster_temp.damageqty,0)+ifnull(batchmaster_temp.expiryqty,0) from batchmaster_temp where batchmaster_temp.batchnumber=batchmaster.batchnumber and batchmaster_temp.itemcode=batchmaster.itemcode)";
            console.log(updateqry);
            console.log(badupdateqry);
            addnewbatch();
            if (platform == "iPad") {
                Cordova.exec(function(result) {
                              
                              },
                              function(error) {
                              navigator.notification.alert(error);
                              },
                              "PluginClass",
                              "InsertUpdateMethod",
                              [updateqry]);
            }
            else if (platform == "Android") {
                window.plugins.DataBaseHelper.insert(updateqry, function(result) {
                                                     
                                                     },
                                                     function() {
                                                     console.warn("Error calling plugin");
                                                     });
            }
            if (platform == "iPad") {
                Cordova.exec(function(result) {
                              
                              },
                              function(error) {
                              navigator.notification.alert(error);
                              },
                              "PluginClass",
                              "InsertUpdateMethod",
                              [badupdateqry]);
            }
            else if (platform == "Android") {
                window.plugins.DataBaseHelper.insert(badupdateqry, function(result) {
                                                     
                                                     },
                                                     function() {
                                                     console.warn("Error calling plugin");
                                                     });
            }
            
        }
        function addnewbatch()
        {
            var batchqty = "ifnull(batchmaster_temp.quantity,0)-ifnull(batchmaster_temp.salesqty,0)-ifnull(batchmaster_temp.freeqty,0)+ifnull(batchmaster_temp.returnqty,0)+ifnull(batchmaster_temp.buybackqty,0)-ifnull(batchmaster_temp.rentalqty,0)-ifnull(batchmaster_temp.promoqty,0)+ifnull(batchmaster_temp.loadaddqty,0)-ifnull(batchmaster_temp.loadcutqty,0)";
            var insertqry ="insert into batchmaster(quantity,batchdetailkey,batchnumber,expirydate,itemcode,damagequantity) select "+batchqty+",batchdetailkey,batchnumber,expirydate,itemcode,ifnull(badquantity,0)+ifnull(damageqty,0)+ifnull(expiryqty,0) from batchmaster_temp where batchmaster_temp.batchnumber || batchmaster_temp.itemcode not in(select batchmaster.batchnumber || batchmaster.itemcode from batchmaster)";
            console.log(insertqry);
            if (platform == "iPad") {
                Cordova.exec(function(result) {
                              
                              },
                              function(error) {
                              navigator.notification.alert(error);
                              },
                              "PluginClass",
                              "InsertUpdateMethod",
                              [insertqry]);
            }
            else if (platform == "Android") {
                window.plugins.DataBaseHelper.insert(insertqry, function(result) {
                                                     
                                                     },
                                                     function() {
                                                     console.warn("Error calling plugin");
                                                     });
            }
        }
        function addnewloadbatch()
        {
            var batchqty = "ifnull(batchmaster_temp.quantity,0)+ifnull(batchmaster_temp.loadquantity,0)";
            var insertqry ="insert into batchmaster(quantity,batchdetailkey,batchnumber,expirydate,itemcode,damagequantity) select "+batchqty+",batchdetailkey,batchnumber,expirydate,itemcode,ifnull(badquantity,0)+ifnull(damageqty,0)+ifnull(expiryqty,0) from batchmaster_temp where batchmaster_temp.batchnumber || batchmaster_temp.itemcode not in(select batchmaster.batchnumber || batchmaster.itemcode from batchmaster)";
            var updateqry = "update batchmaster set quantity = (select "+batchqty+" from batchmaster_temp where batchmaster_temp.batchnumber=batchmaster.batchnumber and batchmaster_temp.itemcode=batchmaster.itemcode) where exists (select "+batchqty+" from batchmaster_temp where batchmaster_temp.batchnumber=batchmaster.batchnumber and batchmaster_temp.itemcode=batchmaster.itemcode)";
            console.log(insertqry);
            console.log(updateqry);
            if (platform == "iPad") {
                Cordova.exec(function(result) {
                              
                              },
                              function(error) {
                              navigator.notification.alert(error);
                              },
                              "PluginClass",
                              "InsertUpdateMethod",
                              [insertqry]);
                Cordova.exec(function(result) {
                              
                              },
                              function(error) {
                              navigator.notification.alert(error);
                              },
                              "PluginClass",
                              "InsertUpdateMethod",
                              [updateqry]);
            }
            else if (platform == "Android") {
                window.plugins.DataBaseHelper.insert(insertqry, function(result) {
                                                     
                                                     },
                                                     function() {
                                                     console.warn("Error calling plugin");
                                                     });
                window.plugins.DataBaseHelper.insert(updateqry, function(result) {
                                                     
                                                     },
                                                     function() {
                                                     console.warn("Error calling plugin");
                                                     });
            }
        }
        function SaveSalesData() {
        	// alert("Save Sales Data");
            Qry = "UPDATE invoicedetail SET istemp='false',issync=0,transactionkey=(SELECT transactionkey FROM invoiceheader WHERE routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey = " + sessionStorage.getItem("VisitKey") + ") where routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + sessionStorage.getItem("VisitKey");
            console.log(Qry);
            // navigator.notification.alert(Qry);
            if(platform == "iPad")
            {
                Cordova.exec(function(result) {
                // alert(result);
                    var QrySelect = "SELECT itemcode,ifnull(salesqty,0) as SalesQty,ifnull(returnqty,0) as RetQty,ifnull(manualfreeqty,0) as FreeQty,ifnull(freesampleqty,0) as freesampleqty,ifnull(returnfreeqty,0) as returnfreeqty,ifnull(damagedqty,0) as damagedqty,ifnull(fixedrentqty,0) rentqty FROM invoicedetail where routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey = " + sessionStorage.getItem("VisitKey") + " and istemp='false'";
                    console.log(QrySelect)
                    Cordova.exec(function(result1) {
                        if(result1.length > 0)
                        {
                             
                            // getfocitem();
                            /*
							 * var Quantity = {}; for(i=0;i<result1.length;i++) {
							 * Quantity.ItemCode = result1[i][0];
							 * Quantity.SalesQty = result1[i][1];
							 * Quantity.RetQty = result1[i][2]; Quantity.FreeQty =
							 * result1[i][3]; Quantity.freesampleqty =
							 * result1[i][4]; Quantity.returnfreeqty =
							 * result1[i][5]; Quantity.damagedqty =
							 * result1[i][6]; UpdateInventorySalesQty(Quantity); }
							 */
                            UpdateInventorySalesQty(result1,0,result1.length);                           
                        }
                    },
                    function(error) {
                        alert(error);
                    },
                    "PluginClass",
                    "GetdataMethod",
                    [QrySelect]);
                },
                function(error) {
                    navigator.notification.alert(error);
                },
                "PluginClass",
                "InsertUpdateMethod",
                [Qry]);
            }
            else if(platform == "Android")
            {            	
                window.plugins.DataBaseHelper.insert(Qry, function(result) 
                {                	
	                var QrySelect = "SELECT itemcode,ifnull(salesqty,0) as SalesQty,ifnull(returnqty,0) as RetQty,ifnull(manualfreeqty,0) as FreeQty,ifnull(freesampleqty,0) as freesampleqty,ifnull(returnfreeqty,0) as returnfreeqty,ifnull(damagedqty,0) as damagedqty,ifnull(fixedrentqty,0) rentqty FROM invoicedetail where routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey = " + sessionStorage.getItem("VisitKey") + " and istemp='false'";                	
                	console.log(QrySelect);
                    window.plugins.DataBaseHelper.select(QrySelect, function(result1) 
                    {                        
                        if(result1.array != undefined)
                        {
                            var array = $.map(result1.array, function(item, index) {
                                return [[item.itemcode, item.SalesQty, item.RetQty, item.FreeQty,item.freesampleqty,item.returnfreeqty,item.damagedqty,item.rentqty]];
                            });
                             
                          // getfocitem();
                            UpdateInventorySalesQty(array,0,array.length);
                        }else
                        {
                        	SaveInvoiceRXDDetail();
                        }
                    },
                    function() {
                        console.warn("Error calling plugin");
                    });
                },
				function() {
				    console.warn("Error calling plugin");
				});
            }
            
        }
        function getfocitem()
        {
            var QrySelect = "SELECT itemcode,(ifnull(manualfreeqty,0)) as manualfreeqty FROM invoicedetail where routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey = " + sessionStorage.getItem("VisitKey") + " and istemp='false' and (ifnull(manualfreeqty,0)) > 0";  
            console.log(QrySelect);          
            if(platform == "iPad")
            {
                Cordova.exec(function(result) {                
                              if(result.length > 0)
                              {
                              for(i=0;i<result.length;i++)
                              {
                              updatefoc(result,i);
                              }
                              }
                              },
                              function(error) {
                              navigator.notification.alert("Error");
                              },
                              "PluginClass",
                              "GetdataMethod",
                              [QrySelect]);
            }
            else if(platform == "Android")
            {
                window.plugins.DataBaseHelper.select(QrySelect, function(result) {
                	if(!$.isEmptyObject(result))
                    {
                    	result = $.map(result.array, function(item, index) {
                    		return [[item.itemcode,item.manualfreeqty]];
                    	});
                    	if (result.length > 0) {
                    		for (i = 0; i < result.length; i++) {
                    			updatefoc(result,i);
                    		}
                    	}
                    }
                 },
                 function() {
                 	console.warn("Error calling plugin");
                 });
            }
        }
        function updatefoc(data,i)
            {
                var qry ="update customer_foc_balance set balanceqty = balanceqty-"+data[i][1]+" where itemcode ="+data[i][0]+" and customercode="+sessionStorage.getItem('customerid');
                if (platform == iPadPlatform) {
                        Cordova.exec(function(result) {
                            
                        },
                        function(error) {
                            navigator.notification.alert(error);
                        },
                        "PluginClass",
                        "InsertUpdateMethod",
                        [qry]);
                    }
                    else if (platform == AndroidPlatform) {
                        window.plugins.DataBaseHelper.insert(qry, function(result) {
                            
                          
                        },
                        function() {
                            console.warn("Error calling plugin");
                        });
                    }
                    
            }
        function UpdateInventorySalesQty(data,i,total)
        {        	
           	var obj = {};
           	obj.ItemCode = data[i][0];
           	obj.SalesQty = data[i][1];
           	obj.RetQty = data[i][2];
           	obj.FreeQty = data[i][3];
           	obj.freesampleqty = data[i][4];
           	obj.returnfreeqty = data[i][5];
           	obj.damagedqty = data[i][6];
            obj.rentqty = data[i][7];
           	console.log("total"+total);
            var QrySelect = "SELECT COUNT(*) as cnt FROM inventorysummarydetail where itemcode = " + eval(obj.ItemCode) + " and routekey = " + sessionStorage.getItem("RouteKey");
            console.log(QrySelect);
            var QryInsert = "INSERT INTO inventorysummarydetail(inventorykey,routekey,itemcode,saleqty,returnqty,freesampleqty,returnfreeqty,damageqty,istemp,issync,stdsalesprice,stdsalescaseprice,stdreturnprice,stdreturncaseprice,rentqty) SELECT " + sessionStorage.getItem("RouteKey") + "," + sessionStorage.getItem("RouteKey") + "," + obj.ItemCode + "," + obj.SalesQty + "," + obj.RetQty + "," + obj.FreeQty + "+" + obj.freesampleqty + "," + obj.returnfreeqty + "," + obj.damagedqty + ",'false',0,defaultsalesprice,caseprice,defaultreturnprice,returncaseprice," + obj.rentqty + " FROM itemmaster WHERE actualitemcode=" + obj.ItemCode;
            var QryUpdate = "UPDATE inventorysummarydetail set saleqty = (ifnull(saleqty,0) + " + obj.SalesQty + "),returnqty=(ifnull(returnqty,0) + " + obj.RetQty+"),freesampleqty=(ifnull(freesampleqty,0) + " + obj.FreeQty + "+" + obj.freesampleqty + "),returnfreeqty=(ifnull(returnfreeqty,0) + " + obj.returnfreeqty + "),damageqty = (ifnull(damageqty,0) + " + obj.damagedqty + "),issync=0,rentqty=" + obj.rentqty + " where routekey = " + sessionStorage.getItem("RouteKey") + " and itemcode = " + obj.ItemCode;
            var QryNew = "";
           
            if(platform == "iPad")
            {
                Cordova.exec(function(result) 
                {
                    if(eval(result[0][0]) > 0)
                    {
                        QryNew = QryUpdate;
                        console.log(QryNew);
                    }
                    else
                    {
                        QryNew = QryInsert;
                        console.log(QryNew);
                    }
                    Cordova.exec(function(result) {
                    	   
                    	   if(i+1 < total)
                    	   		UpdateInventorySalesQty(data,i+1,total);                                         
                    },
                    function(error) {
                        navigator.notification.alert("Error");
                    },
                    "PluginClass",
                    "InsertUpdateMethod",
                    [QryNew]);
                },
                function(error) {
                    navigator.notification.alert("Error");
                },
                "PluginClass",
                "GetdataMethod",
                [QrySelect]);
            }
            else if(platform == "Android")
            {
                window.plugins.DataBaseHelper.select(QrySelect, function(result) 
                {
                    if(eval(result.array[0].cnt) > 0 )
                    {
                        QryNew = QryUpdate;
                        console.log(QryNew);
                    }
                    else
                    {
                        QryNew = QryInsert;
                        console.log(QryNew);
                    }
                   // alert("Inventory Sales Qty");
                    window.plugins.DataBaseHelper.insert(QryNew, function(result) {
                    	
                    	if((i+1) < total)
                    	   	UpdateInventorySalesQty(data,i+1,total);
                    	if(i == (total - 1))
                    		SaveInvoiceRXDDetail();
                    },
                    function() {
                    	SaveInvoiceRXDDetail();
                        console.warn("Error calling plugin");
                    });
                },
                function() {
                    console.warn("Error calling plugin");
                });
            }
        }  
        
        function UpdateDamageQtyForUnload()
        {
        	// alert("Update Damage Qty Unload");
            var QrySelect = "SELECT itemcode,(ifnull(damagedqty,0) + ifnull(expiryqty,0)) as damagedqty FROM invoicedetail where routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey = " + sessionStorage.getItem("VisitKey") + " and istemp='false' and (ifnull(damagedqty,0) + ifnull(expiryqty,0)) > 0";  
            console.log(QrySelect);          
            if(platform == "iPad")
            {
                Cordova.exec(function(result) {                
                              if(result.length > 0)
                              {
                              for(i=0;i<result.length;i++)
                              {
                              var obj = {};
                              obj.ItemCode = result[i][0];
                              obj.damagedqty = result[i][1];
                              UpdateData(obj);
                              }
                              }
                              },
                              function(error) {
                              navigator.notification.alert("Error");
                              },
                              "PluginClass",
                              "GetdataMethod",
                              [QrySelect]);
            }
            else if(platform == "Android")
            {
                window.plugins.DataBaseHelper.select(QrySelect, function(result) {
                	if(!$.isEmptyObject(result))
                    {
                    	result = $.map(result.array, function(item, index) {
                    		return [[item.itemcode,item.damagedqty]];
                    	});
                    	if (result.length > 0) {
                    		// alert("Update DamageQty For Upload
							// length"+result.length);
                    		for (i = 0; i < result.length; i++) {
                    			var obj = {};
                    			obj.ItemCode = result[i][0];
                    			obj.damagedqty = result[i][1];
                    			UpdateData(obj);
                    			// alert("Update DamageQty For Upload"+i);
                    			if(i==(result.length-1)){
                    				// alert("Update DamageQty For Upload end");
                    				SaveFOC();
                    			}
                    		}
                    		
                    	}else
                    	{
                    		SaveFOC();
                    		
                    	}
                    }else
                    {
                    	SaveFOC();
                    }
                 },
                 function() {
                	 		SaveFOC();
                 	console.warn("Error calling plugin");
                 });
            }
        }
        
        function UpdateData(obj)
        {            
            var Qry = "SELECT COUNT(*) as cnt FROM inventorytransactiondetail WHERE transactiontypecode = 07 AND routekey=" + sessionStorage.getItem("RouteKey") + " AND istemp = 'true' AND itemcode = " + obj.ItemCode;
            var QryInsert = "INSERT INTO inventorytransactiondetail(routekey,detailkey,transactiontypecode,itemcode,quantity,istemp,issync,itemprice,itemcaseprice) VALUES(" + sessionStorage.getItem("RouteKey") + ",0,07," + obj.ItemCode + "," + obj.damagedqty + "," + "'true',0,(SELECT defaultreturnprice from itemmaster where actualitemcode = " + obj.ItemCode + "),(SELECT returncaseprice FROM itemmaster where actualitemcode = " + obj.ItemCode + "))";
            var QryUpdate = "Update inventorytransactiondetail SET quantity=ifnull(quantity,0) + " + (eval(obj.damagedqty)) + ",issync=0,istemp='true',itemprice = (SELECT defaultreturnprice from itemmaster where actualitemcode = " + obj.ItemCode + "),itemcaseprice = (SELECT returncaseprice FROM itemmaster where actualitemcode = " + obj.ItemCode + ") where itemcode=" + obj.ItemCode + " and routekey=" + sessionStorage.getItem("RouteKey") + " and transactiontypecode=07";
            var QryNew = "";
            console.log(Qry);
            console.log(Qry);
            if(platform == "iPad")
            {
                Cordova.exec(function(result) {                
                              if(result[0][0] > 0)                    
                              QryNew = QryUpdate;
                              else
                              QryNew = QryInsert;                        
                              console.log(QryNew);
                              Cordova.exec(function(result1) {
                                            },
                                            function(error) {
                                            navigator.notification.alert("Error");
                                            },
                                            "PluginClass",
                                            "InsertUpdateMethod",
                                            [QryNew]);                    
                              },
                              function(error) {
                              navigator.notification.alert("Error");
                              },
                              "PluginClass",
                              "GetdataMethod",
                              [Qry]);
            }
            else if(platform == "Android")
            {
                window.plugins.DataBaseHelper.select(Qry, function(result) {                									 
                                                     if(result.array[0].cnt > 0)
													{		
                                                    // QryNew = QryUpdate;
													 window.plugins.DataBaseHelper.insert(QryUpdate, function(result1) {
                                                                                          },
                                                                                          function() {
                                                                                          console.warn("Error calling plugin");
                                                                                          });  
													} 
                                                     else
													 {
                                                    // QryNew = QryInsert;
													 window.plugins.DataBaseHelper.insert(QryInsert, function(result1) {
                                                                                          },
                                                                                          function() {
                                                                                          console.warn("Error calling plugin");
                                                                                          });  
                                                      } 
                                                     },
                                                     function() {
                                                     console.warn("Error calling plugin");
                                                     });
            }
        }

        function SaveInvoiceRXDDetail() {
        	// alert("InVoice Rxd Detail");
            var Qry = "Update invoicerxddetail set istemp = 'false',issync=0,transactionkey=(SELECT transactionkey FROM invoiceheader WHERE routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey = " + sessionStorage.getItem("VisitKey") + ") where routekey = " + sessionStorage.getItem('RouteKey') + " and visitkey = " + sessionStorage.getItem('VisitKey') + "";
            console.log(Qry);
            if(platform == "iPad")
            {
                Cordova.exec(function(result) {
                    // navigator.notification.alert("Save invoice rxd detail
					// record successfully");
                },
                function(error) {
                    navigator.notification.alert("Error save invoice rxd detail record");
                },
                "PluginClass",
                "InsertUpdateMethod",
                [Qry]);
            }
            else if(platform == "Android")
            {
                window.plugins.DataBaseHelper.insert(Qry, function(result) {
                	 UPdateCustomerInventory();	
                },
				function() {
				    console.warn("Error calling plugin");
				});
            }
        }
        function updatebatchdata()
        {
            var updateqry = "update batchexpirydetail set istemp='false' where transactiontypecode=1 and routekey="+sessionStorage.getItem("RouteKey")+"";
            if (platform == "iPad") {
                Cordova.exec(function(result) {
                              addnewloadbatch();
                              },
                              function(error) {
                              navigator.notification.alert(error);
                              },
                              "PluginClass",
                              "InsertUpdateMethod",
                              [updateqry]);
            }
            else if (platform == "Android") {
                window.plugins.DataBaseHelper.insert(updateqry, function(result) {
                                                     addnewloadbatch();
                                                     },
                                                     function() {
                                                     console.warn("Error calling plugin");
                                                     });
            }
        }

        function SaveStartingLoadDetail() {
           // updatebatchdata();
            var Qry = "Update startingloaddetail set status = 1 where routecode = " + sessionStorage.getItem('RouteCode') + " and strftime('%Y-%m-%d',ddate) = '" + getTabletDate() + "' and loadperiodnumber = " + localStorage.LoadPeriod + "";
            if(platform == "iPad")
            {
                Cordova.exec(function(result) {
                    console.log("startload");
                    SaveInventorySummarys();
                    // navigator.notification.alert("Save starting load detail
					// successfully");
                },
                function(error) {
                    navigator.notification.alert("Error save starting load detail record");
                },
                "PluginClass",
                "InsertUpdateMethod",
                [Qry]);
            }
            else if(platform == "Android")
            {
                window.plugins.DataBaseHelper.insert(Qry, function(result) {
                     console.log("startload");
                    SaveInventorySummarys();
                },
				function() {
				    console.warn("Error calling plugin");
				});
            }
        }
        function UPdateCustomerInventory()
        {
            var Qry = "UPDATE customerinventorydetail SET istemp = 'false' WHERE routekey=" + sessionStorage.getItem("RouteKey") + " AND visitkey=" + sessionStorage.getItem("VisitKey");
            console.log(Qry);
            if(platform == "iPad")
            {
                Cordova.exec(function(result) {
                    SetNextPage();
                },
                function(error) {
                    alert(error);
                },
                "PluginClass",
                "InsertUpdateMethod",
                [Qry]);
            }
            else if(platform == "Android")
            {
                window.plugins.DataBaseHelper.insert(Qry, function(result) 
                {
                	SaveCashChequeDetail();
                },
                function()
                {
                    console.warn("Error calling plugin");
                });
            }
        }
        function SaveCashChequeDetail() {
        	// alert("Save CashCheck Detail");
            var Qry;
            Qry = "Update cashcheckdetail set istemp = 'false',issync=0,hhctransactionkey= " + sessionStorage.getItem("VisitKey") + " where routekey = " + sessionStorage.getItem('RouteKey') + " and visitkey = " + sessionStorage.getItem('VisitKey') + "";
            console.log(Qry);
            if(platform == "iPad")
            {
                Cordova.exec(function(result) {
                    // navigator.notification.alert("Save cash cheque detail
					// successfully");
                },
                function(error) {
                    navigator.notification.alert("Error save cash cheque detail record");
                },
                "PluginClass",
                "InsertUpdateMethod",
                [Qry]);
            }
            else if(platform == "Android")
            {
                window.plugins.DataBaseHelper.insert(Qry, function(result) {
                	UpdateDamageQtyForUnload();
                },
				function() {
				    console.warn("Error calling plugin");
				});
            }
        }

        function SaveInvoiceHeader() 
        {
        	
        	var dexflg=0;
            InvoiceNumber = sessionStorage.getItem("InvoiceNumber");
            //alert(InvoiceNumber.toString().substr("-6","1"));
            if(InvoiceNumber.toString().substr("-6","1") == "8") {
            	InvoiceNumberField = "hhcinvretseq";
            	dexflg=1;
            }
            else{
            	InvoiceNumberField = "hhcinvseq";
            	dexflg=0;
            }
            
            var Qry = "Update invoiceheader set istemp = 'false',issync=0,invoicenumber=" + sessionStorage.getItem("InvoiceNumber") + ",documentnumber=" + DocumentNumber + ",printstatus = " + printstatus + ",dexflag="+dexflg+" where routekey = " + sessionStorage.getItem('RouteKey') + " and visitkey = " + sessionStorage.getItem('VisitKey') + "";
            //alert(Qry);
            if(platform == "iPad")
            {
                Cordova.exec(function(result) {
                    // navigator.notification.alert("Save invoice header detail
					// successfully");
                              updatebatchsales();
                              FetchPaidAmount();
                },
                function(error) {
                    navigator.notification.alert("Error save invoice header detail record");
                },
                "PluginClass",
                "InsertUpdateMethod",
                [Qry]);
            }
            else if(platform == "Android")
            {
                window.plugins.DataBaseHelper.insert(Qry, function(result) {
                                                     updatebatchsales();
                                                    // FetchPaidAmount();
                },
				function() {
				    console.warn("Error calling plugin");
				});
            }
        }
        
        function FetchPaidAmount()
        {            
            var Qry  = "SELECT amount,typecode from cashcheckdetail where routekey = " + sessionStorage.getItem("RouteKey") + " and visitkey = " + sessionStorage.getItem("VisitKey");
            var Amount,PaymentType;
            var Invoice = {};
            if(platform == "iPad")
            {
                Cordova.exec(function(result) {
                    var Invoice = {};
                    if(result.length>0)
                    {
                        Invoice.Amount = result[0][0];
                        Invoice.gcpaymenttype = 0;
                        if(eval(result[0][1]) == 0)
                        {
                              Invoice.PaymentType = 0; // cash
                              Invoice.PaymentStatus = 0; // cash
                              if(sessionStorage.invoicepaymentterms == 2)
                                Invoice.gcpaymenttype = 1;
                              else
                                Invoice.gcpaymenttype = 0;
                        }
                        else if(eval(result[0][1]) == 1)
                        {
                              Invoice.PaymentType = 4; // cheque
                              Invoice.PaymentStatus = 4; // cheque
                        }
                    }
                    else
                    {
                        Invoice.Amount = 0;
                        Invoice.PaymentType = 1; // charge/credit
                        Invoice.PaymentStatus = 1; // charge/credit
                        Invoice.gcpaymenttype = 2;
                    }
                    getInvoicepaymentTerms(Invoice);        
                },
                function(error) {
                    navigator.notification.alert("Error");
                },
                "PluginClass",
                "GetdataMethod",
                [Qry]);
            }  
            else if(platform == "Android")
            {
                window.plugins.DataBaseHelper.select(Qry, function(result) {                   
                  
                    if(!$.isEmptyObject(result))
                    {
                    console.log("result3"+result);
                    result = $.map(result.array, function(item, index) {
                        return [[item.amount,item.typecode]];
                    });
                    console.log("result"+result);
                    console.log("len"+result.length);
                    	if (result.length > 0) {
	                        Invoice.Amount = result[0][0];
                        	Invoice.gcpaymenttype = 0;
                        	if (eval(result[0][1]) == 0) {
	                            Invoice.PaymentType = 0; // cash
                            	Invoice.PaymentStatus = 0; // cash
                            	Invoice.gcpaymenttype = 1;
                        	}
                        	else if (eval(result[0][1]) == 1) {
	                            Invoice.PaymentType = 4; // cheque
                            	Invoice.PaymentStatus = 4; // cheque
                        	}
                        	getInvoicepaymentTerms(Invoice);
                    	}
                    }
                    else
                    {
                    	Invoice.Amount = 0;
                        Invoice.PaymentType = 1; // charge/credit
                        Invoice.PaymentStatus = 1; // charge/credit
                        Invoice.gcpaymenttype = 2;
                        getInvoicepaymentTerms(Invoice);
                    }
                    
                                        
                   
                },
				function() {
				    console.warn("Error calling plugin");
				});
            }          
        }
       function getInvoicepaymentTerms(Invoice){
    	   
    	   var custid=sessionStorage.getItem("customerid");
           var platform= sessionStorage.getItem("platform");
           var routecode=sessionStorage.getItem("RouteCode");
           var CompanyCode=sessionStorage.getItem("CompanyCode");
           
           
           if(platform=='iPad')
           {
                Cordova.exec(function(result) {
                             
                            
                 },
                 function(error) {
                 alert(error);
                 },   
                 "PluginClass",
                 "GetdataMethod",
                 ["select invoicepaymentterms from customermaster where customercode="+custid]);
           }
           else if(platform=='Android')
           {
               window.plugins.DataBaseHelper.select("select invoicepaymentterms from customermaster where customercode="+custid,function(result)
               {
               	
               	   if(result.array != undefined)
                   {
						
	               		var paymentterms = $.map(result.array, function (item, index) {
	                        return [[item.invoicepaymentterms]];
	               		});	
               	
	               		UpdateCustomerInvoice(Invoice,paymentterms[0][0]);
                       	
                   }else{
                   	
                	   UpdateCustomerInvoice(Invoice,window.localStorage.getItem("invoicepaymenttersmslocal"));
                   } 
                       
                },
                function()
                {
                	console.warn("Error calling plugin");
                });
           }
    	   
    	   
       }
        
        function UpdateCustomerInvoice(Invoice,paymentterms) {
            var balanceupdate;
			
            var ipt = paymentterms;
            if(eval(ipt) == 2 || eval(ipt) == 3 || eval(ipt) == 4)
            {
                if(Invoice.PaymentType == 4)
                {
                    
                    if(sessionStorage.getItem("disablebalanceupdate") == 1)                
                        balanceupdate = true;
                    else if(sessionStorage.getItem("disablebalanceupdate") == 0)
                        balanceupdate = false;
                }
            }
            
            
            
            
            if(balanceupdate == true)
            {
				
                // Invoiceheader : invoicebalance and amountpaid will be updated
                var QryUpdate = "Update invoiceheader set invoicebalance=(ifnull(totalinvoiceamount,0)) - " + eval(Invoice.Amount) + ",amountpaid=" + eval(Invoice.Amount) + ",paymenttype=" + eval(Invoice.PaymentType) + ",issync=0,immediatepaid=" + eval(Invoice.Amount) + ",paymentstatus=" + eval(Invoice.PaymentStatus) + ",gcpaymenttype=" + Invoice.gcpaymenttype + ",actualtransactiondate = date()  WHERE routekey=" + sessionStorage.getItem("RouteKey") + "  and visitkey=" + sessionStorage.getItem("VisitKey");
                
                // CustomerInvoice : invoicebalance and amountpaid will be
				// updated; pdcbalance,pdcindicator and pdcdate will not be
				// updated
                var QryInsertToCustomer = "INSERT INTO customerinvoice(transactionkey,documentnumber,invoicenumber,erpreferencenumber,transactiondate,transactiontime,customercode,routecode,salesmancode,totalinvoiceamount,totalsalesamount,totalreturnamount,totaldamagedamount,totalfreesampleamount,amountpaid,invoicebalance,paymenttype,transactiontype,voidflag,issync,pdcbalance,immediatepaid,paymenttype,paymentstatus,gcpaymenttype,pdcindicator,totalbuybackfreeamount,pdcdate) SELECT transactionkey,documentnumber,invoicenumber,invoicenumber as erpreferencenumber,date('now', 'localtime'),time('now', 'localtime'),customercode,routecode,salesmancode,totalinvoiceamount,totalsalesamount,totalreturnamount,totaldamagedamount,totalfreesampleamount,ifnull(amountpaid,0) as amountpaid,invoicebalance,ifnull(paymenttype,1) as paymenttype,2,0,0,NULL,immediatepaid,paymenttype,paymentstatus,gcpaymenttype,NULL,totalbuybackfreeamount,NULL FROM invoiceheader WHERE routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + sessionStorage.getItem("VisitKey");
				
            }
            else if(balanceupdate == false)
            {
			
                // Invoiceheader : invoicebalance and amountpaid will not be
				// updated
                var QryUpdate = "Update invoiceheader set invoicebalance=0,amountpaid=0,paymenttype=" + eval(Invoice.PaymentType) + ",issync=0,immediatepaid=" + eval(Invoice.Amount) + ",paymentstatus=" + eval(Invoice.PaymentStatus) + ",gcpaymenttype=" + Invoice.gcpaymenttype + ",actualtransactiondate = date()  WHERE routekey=" + sessionStorage.getItem("RouteKey") + "  and visitkey=" + sessionStorage.getItem("VisitKey");
                
                // CustomerInvoice : invoicebalance and amountpaid will not be
				// updated; pdcbalance,pdcindicator and pdcdate will be updated
                var QryInsertToCustomer = "INSERT INTO customerinvoice(transactionkey,documentnumber,invoicenumber,erpreferencenumber,transactiondate,transactiontime,customercode,routecode,salesmancode,totalinvoiceamount,totalsalesamount,totalreturnamount,totaldamagedamount,totalfreesampleamount,amountpaid,invoicebalance,paymenttype,transactiontype,voidflag,issync,pdcbalance,immediatepaid,paymenttype,paymentstatus,gcpaymenttype,pdcindicator,totalbuybackfreeamount,pdcdate) SELECT transactionkey,documentnumber,invoicenumber,invoicenumber as erpreferencenumber,date('now', 'localtime'),time('now', 'localtime'),customercode,routecode,salesmancode,totalinvoiceamount,totalsalesamount,totalreturnamount,totaldamagedamount,totalfreesampleamount,ifnull(amountpaid,0) as amountpaid,invoicebalance,ifnull(paymenttype,1) as paymenttype,2,0,0,(SELECT CASE typecode WHEN 1 THEN ifnull(amount,0) ELSE 0 END FROM cashcheckdetail WHERE routekey=" + sessionStorage.getItem("RouteKey") + " AND visitkey=" + sessionStorage.getItem("VisitKey") + "),immediatepaid,paymenttype,paymentstatus,gcpaymenttype,(CASE paymenttype WHEN 4 THEN 1 ELSE 0 END),totalbuybackfreeamount,(SELECT CASE typecode WHEN 1 THEN checkdate ELSE NULL END FROM cashcheckdetail WHERE routekey=" + sessionStorage.getItem("RouteKey") + " AND visitkey=" + sessionStorage.getItem("VisitKey") + ") FROM invoiceheader WHERE routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + sessionStorage.getItem("VisitKey");
				
				
            } 
            else
            {
            	var QryInsertToCustomer = "INSERT INTO customerinvoice(transactionkey,documentnumber,invoicenumber,erpreferencenumber,transactiondate,transactiontime,customercode,routecode,salesmancode,totalinvoiceamount,totalsalesamount,totalreturnamount,totaldamagedamount,totalfreesampleamount,amountpaid,invoicebalance,paymenttype,transactiontype,voidflag,issync,pdcbalance,immediatepaid,paymenttype,paymentstatus,gcpaymenttype,pdcindicator,totalbuybackfreeamount,pdcdate) SELECT transactionkey,documentnumber,invoicenumber,invoicenumber as erpreferencenumber,date('now', 'localtime'),time('now', 'localtime'),customercode,routecode,salesmancode,totalinvoiceamount,totalsalesamount,totalreturnamount,totaldamagedamount,totalfreesampleamount,ifnull(amountpaid,0) as amountpaid,invoicebalance,ifnull(paymenttype,1) as paymenttype,2,0,0,(SELECT CASE typecode WHEN 1 THEN ifnull(amount,0) ELSE 0 END FROM cashcheckdetail WHERE routekey=" + sessionStorage.getItem("RouteKey") + " AND visitkey=" + sessionStorage.getItem("VisitKey") + "),immediatepaid,paymenttype,paymentstatus,gcpaymenttype,(CASE paymenttype WHEN 4 THEN 1 ELSE 0 END),totalbuybackfreeamount,(SELECT CASE typecode WHEN 1 THEN checkdate ELSE NULL END FROM cashcheckdetail WHERE routekey=" + sessionStorage.getItem("RouteKey") + " AND visitkey=" + sessionStorage.getItem("VisitKey") + ") FROM invoiceheader WHERE routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + sessionStorage.getItem("VisitKey");
 				
        		if(eval(ipt) > 1)
    			{
                    var QryUpdate = "Update invoiceheader set invoicebalance=(ifnull(totalinvoiceamount,0)) - " + eval(Invoice.Amount) + ",amountpaid=" + eval(Invoice.Amount) + ",paymenttype=" + eval(Invoice.PaymentType) + ",issync=0,immediatepaid=" + eval(Invoice.Amount) + ",paymentstatus=" + eval(Invoice.PaymentStatus) + ",gcpaymenttype=" + Invoice.gcpaymenttype + ",actualtransactiondate = date()  WHERE routekey=" + sessionStorage.getItem("RouteKey") + "  and visitkey=" + sessionStorage.getItem("VisitKey");
    			  
    			}
        		else
    			{
    				var QryUpdate = "Update invoiceheader set totalinvoiceamount=" + eval(Invoice.Amount) + ",invoicebalance=0,amountpaid=" + eval(Invoice.Amount) + ",paymenttype=" + eval(Invoice.PaymentType) + ",issync=0,immediatepaid=" + eval(Invoice.Amount) + ",paymentstatus=" + eval(Invoice.PaymentStatus) + ",gcpaymenttype=" + Invoice.gcpaymenttype + ",actualtransactiondate = date()  WHERE routekey=" + sessionStorage.getItem("RouteKey") + "  and visitkey=" + sessionStorage.getItem("VisitKey");
                }     
               
				
            }                  
                        
            if (platform == "iPad") {
                Cordova.exec(function(result) 
                {
                    console.log(QryUpdate);
                    if (result !='') 
                    {
                        Cordova.exec(function(result1) 
                        {
                            console.log(QryInsertToCustomer);
                          
                            UpdateCustomerBalanceSales();
                        },
                        function(error) {
                            navigator.notification.alert("Error");
                        },
                        "PluginClass",
                        "InsertUpdateMethod",
                        [QryInsertToCustomer]);
                    }
                },
                function(error) {
                    navigator.notification.alert("Error");
                },
                "PluginClass",
                "InsertUpdateMethod",
                [QryUpdate]);
            }
            else if (platform == "Android") 
            {
			// alert(QryInsertToCustomer);
                window.plugins.DataBaseHelper.insert(QryUpdate, function(result) 
                {   
					if(eval(ipt)>1)
					{
						
                        window.plugins.DataBaseHelper.insert(QryInsertToCustomer, function(result1) {
                        		UpdateCustomerBalanceSales();
                        },
                        function() {
                            console.warn("Error calling plugin");
                        });
					}
					else
					{
					
						GetSummarizeQtyByPackage();
					}
                },
                function() {
                    console.warn("Error calling plugin");
                });
            }
        }
        
        function UpdateCustomerBalanceSales()
        {            
            var Qry = "Update customermaster set balance = balance +(select sum(invoicebalance) from invoiceheader where customercode=" + sessionStorage.getItem("customerid") + " and routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + sessionStorage.getItem("VisitKey")+"),issync = 0 WHERE customercode=" + sessionStorage.getItem("customerid");
            
            console.log(Qry);
            if(platform == "iPad")
            {
                Cordova.exec(function(result) {    
                                // UpdateDocumentNumber();
                                GetSummarizeQtyByPackage();
                              },
                              function(error) {
                              
                              },
                              "PluginClass",
                              "InsertUpdateMethod",
                              [Qry]);
            }
            else if(platform == "Android")
            {
                window.plugins.DataBaseHelper.insert(Qry, function(result) 
                                                     {                        
                                                        // UpdateDocumentNumber();
                                                       GetSummarizeQtyByPackage();
                                                     },
                                                     function() 
                                                     {
                                                     console.warn("Error calling plugin");
                                                     });
            }
        }
        
        // Calculate Qty by package and itemcode to update in route goal
        function GetSummarizeQtyByPackage()
        {
            var Qry = "SELECT packagecode,SUM(ifnull(salesqty,0) - ifnull(returnqty,0)) qty FROM invoicedetail inv JOIN itemmaster im ON inv.itemcode = im.actualitemcode AND im.itemtype = 1 WHERE routekey = " + sessionStorage.getItem("RouteKey") + " AND visitkey = " + sessionStorage.getItem("VisitKey") + " AND inv.istemp = 'false' GROUP BY packagecode";
            console.log(Qry);
            if(platform == "iPad")
            {
                Cordova.exec(function(result){
                    if(result.length > 0)
                    {
                        var packagecode,qty;
                        for(i=0;i<result.length;i++)
                        {
                            packagecode = result[i][0];
                            qty = result[i][1];
                            UpdateRouteGoal(packagecode,qty,i,result.length);
                        }
                    }
                    else
                        UpdateSignature('sales');
                },
                function(error){
                },
                "PluginClass",
                "GetdataMethod",                
                [Qry]);
            }
            else if(platform == "Android")
            {
                window.plugins.DataBaseHelper.select(Qry, function(result) {
                	if(!$.isEmptyObject(result))
                    {
                    	result = $.map(result.array, function(item, index) {
	                        return [[item.packagecode,item.qty]];
                    	});
                    	if (result.length > 0) {
	                        var packagecode, qty;
                        	for (i = 0; i < result.length; i++) {
	                            packagecode = result[i][0];
                            	qty = result[i][1];
                            	UpdateRouteGoal(packagecode, qty, i, result.length);
                        	}
                    	}
                    }
                    else
                        UpdateSignature('sales');
                },
				function() {
				    console.warn("Error calling plugin");
				});
            }
        }
        
        function UpdateRouteGoal(packagecode,qty,i,len)
        {
           
            var Qry = "UPDATE routegoal SET achievequantity=(ifnull(achievequantity,0) + " + qty + ") WHERE packagenumber = " + packagecode + " AND routecode = " + sessionStorage.getItem("RouteCode") + " AND salesmancode = " + sessionStorage.getItem("SalesmanCode") + " AND date() between fromdate and todate";
            console.log(Qry);
            if(platform == "iPad")
            {
                Cordova.exec(function(result) {                    
                    if(i == (len - 1))
                        UpdateSignature('sales');
                },
                function(error) {
                    navigator.notification.alert("Error save invoice header detail record");
                },
                "PluginClass",
                "InsertUpdateMethod",
                [Qry]);
            }
            else if(platform == "Android")
            {
                window.plugins.DataBaseHelper.insert(Qry, function(result) {
                    if(i == (len - 1))
                        UpdateSignature('sales');
                },
				function() {
				    console.warn("Error calling plugin");
				});
            }
        }
        
        function SaveFOC()
        {
        	// alert("Save FOC");
            var Qry = "SELECT itemcode,IFNULL(manualfreeqty,0) manualfreeqty FROM invoicedetail WHERE routekey=" + sessionStorage.getItem("RouteKey") + " AND visitkey=" + sessionStorage.getItem("VisitKey") + " AND itemcode IN(SELECT CASE WHEN status = 1 THEN itemcode END FROM customer_foc_detail LEFT JOIN controlpanel ON flagid = 2 WHERE customercode=" + sessionStorage.getItem("customerid") + ")";
            console.log(Qry);
            if(platform == "iPad")
            {                
                Cordova.exec(function(result) {
                    for (i = 0; i < result.length; i++) {
                        UpdateFocBalance(result,i);
                    }
                    },
                    function(error) {
                        alert(error);
                    },
                    "PluginClass",
                    "GetdataMethod",
                    [Qry]);
            }
            else if(platform == "Android")
            {                
                window.plugins.DataBaseHelper.select(Qry, function(result) {
                	if(!$.isEmptyObject(result))
                    {
                    	var array = $.map(result.array, function(item, index) {
	                        return [[item.itemcode, item.manualfreeqty]];
                    	});
                        for (i = 0; i < array.length; i++) {
                        	UpdateFocBalance(array,i);
                        	
                        }
                        SaveInvoiceHeader();
                    }else
                    {
                    	SaveInvoiceHeader();
                    }
                },
				function() {
                		SaveInvoiceHeader();
                		console.warn("Error calling plugin");
				});
            }
        }
        
        function UpdateFocBalance(result,i)
        {
            var itemcode = result[i][0];
            var balance = result[i][1];
            var QryUpdate = "UPDATE customer_foc_balance SET balanceqty = IFNULL(balanceqty,0) - " + balance + ",issync=0 WHERE itemcode = " + itemcode + " AND customercode = " + sessionStorage.getItem("customerid");
            console.log(QryUpdate);
            if(platform == "iPad")
            {                
                Cordova.exec(function(result) {
                        if(i+1 < result.length)
                            UpdateFocBalance(result,i+1);
                    },
                    function(error) {
                        alert(error);
                    },
                    "PluginClass",
                    "InsertUpdateMethod",
                    [QryUpdate]);
            }
            else if(platform == "Android")
            {                
                window.plugins.DataBaseHelper.insert(QryUpdate, function(result) {
                	if(!$.isEmptyObject(result))
                    {
                        if(i+1 < result.length)
                            UpdateFocBalance(result,i+1);
                    }
                },
				function() {
				    console.warn("Error calling plugin");
				});
            }
        }
        
        function GetOrderToSales()
        {
        	// alert("Order To Sales");
            var ordertranskey = sessionStorage.getItem("OrderToSalesTransKey");
            var Qry = "SELECT (SELECT COUNT(*) FROM salesorderdetail sod JOIN salesorderheader soh ON sod.transactionkey = soh.transactionkey AND soh.orderdeliverydate = date() AND soh.customercode = " + sessionStorage.getItem("customerid") + " WHERE sod.routekey = " + sessionStorage.getItem("RouteKey") + " AND sod.istemp = 'false') ordercount, (SELECT COUNT(*) FROM invoicedetail inv JOIN invoiceheader invh ON inv.transactionkey = invh.transactionkey AND invh.customercode = " + sessionStorage.getItem("customerid") + " WHERE inv.routekey = " + sessionStorage.getItem("RouteKey") + " AND inv.istemp = 'false') salescount";
                console.log(Qry);
                if(platform == "iPad")
                {
                Cordova.exec(function(result) {
                    if(result.length > 0)
                    {
                        if(result[0][0] > 0 && result[0][1] == 0)
                        {                            
                            var QrySelect = "SELECT itemcode,ifnull(salesqty,0) salesqty,ifnull(manualfreeqty,0) manualfreeqty,ifnull(returnqty,0) returnqty,ifnull(damagedqty,0) damagedqty FROM invoicedetail WHERE routekey = " + sessionStorage.getItem("RouteKey") + " AND visitkey=" + sessionStorage.getItem("VisitKey");
                            console.log(QrySelect);
                            Cordova.exec(function(result) {
                                if(result.length > 0)
                                {
                                    UpdateOrderToSalesDetail(result,0);
                                }
                            },
                            function(error) {
                                navigator.notification.alert(error);
                            },
                            "PluginClass",
                            "GetdataMethod",
                            [QrySelect]);
                        }
                    }                    
                },
                function(error) {
                    navigator.notification.alert(error);
                },
                "PluginClass",
                "GetdataMethod",
                [Qry]);
                }
                else if(platform == "Android")
                {                	
                	window.plugins.DataBaseHelper.select(Qry, function(result) {
                		if(result.array != undefined)
                		{
	                		if(result.array[0].ordercount > 0 && result.array[0].salescount == 0)
                            {
	                			// alert("Order Count >0");
                                var QrySelect = "SELECT itemcode,ifnull(salesqty,0) salesqty,ifnull(manualfreeqty,0) manualfreeqty,ifnull(returnqty,0) returnqty,ifnull(damagedqty,0) damagedqty FROM invoicedetail WHERE routekey = " + sessionStorage.getItem("RouteKey") + " AND visitkey=" + sessionStorage.getItem("VisitKey");
                                console.log(QrySelect);
                                window.plugins.DataBaseHelper.select(QrySelect, function(result) {
                                    if(result.array != undefined)
                                    {
                                    	
                                        result = $.map(result.array, function(item, index) {
                                            return [[item.itemcode, item.salesqty, item.manualfreeqty,item.returnqty,item.damagedqty]];
                                        });
                                        UpdateOrderToSalesDetail(result,0);
                                    }else
                                    {
                                    	SaveSalesData();
                                    }
                                },
                                function() {
                                	SaveSalesData();
                                    console.warn("Error calling plugin");
                                }); 
                            }
	                		else
	                		{
	                			SaveSalesData();
	                			
	                		}	
                		}else
                		{
                			
                			SaveSalesData();
                		}
                	},
					function() {
                		SaveSalesData();
					    console.warn("Error calling plugin");
					});					
                }
        }
        
        function UpdateOrderToSalesDetail(data,i)
        {
            var ordertranskey = sessionStorage.getItem("OrderToSalesTransKey");
            var itemcode = data[i][0];
            var allocatedpcs = data[i][1];
            var freegoodpcs = data[i][2];
            var returnpcs = data[i][3];
            var Qry = "UPDATE salesorderdetail SET allocatedpcs=" + allocatedpcs + ",freegoodpcs=" + freegoodpcs + ",returnpcs=" + returnpcs + " WHERE itemcode = " + itemcode + " AND transactionkey = " + ordertranskey;
            console.log(Qry);
            if(platform == "iPad")
            {
                Cordova.exec(function(result) {                    
                    if(i+1 < data.length)
                        UpdateOrderToSalesDetail(data,i+1);
                        
                    if(i == (data.length - 1))
                        UpdateOrderToSalesHeader(ordertranskey);
                },
                function(error) {
                    navigator.notification.alert(error);
                },
                "PluginClass",
                "InsertUpdateMethod",
                [Qry]);
            }
            else if(platform == "Android")
            {
                window.plugins.DataBaseHelper.insert(Qry, function(result) {
                    if(i+1 < data.length)
                        UpdateOrderToSalesDetail(data,i+1);
                    
                    if(i == (data.length - 1))
                        UpdateOrderToSalesHeader(ordertranskey);
                },
                function() {
                    console.warn("Error calling plugin");
                }); 
            }
        }
        
        function UpdateOrderToSalesHeader(ordertranskey)
        {
        	// alert("Order Header Update");
            var Qry = "UPDATE salesorderheader SET deliverystatus=1 WHERE transactionkey = " + ordertranskey;
            console.log(Qry);
            if(platform == "iPad")
            {
                Cordova.exec(function(result) {                    
                    
                },
                function(error) {
                    navigator.notification.alert(error);
                },
                "PluginClass",
                "InsertUpdateMethod",
                [Qry]);
            }
            else if(platform == "Android")
            {
                window.plugins.DataBaseHelper.insert(Qry, function(result) {
                	SaveSalesData();
                },
                function() {
                    console.warn("Error calling plugin");
                }); 
            }
        }
        
        function SaveInventorySummarys()
        {
            var RouteCode = sessionStorage.getItem("RouteCode");
            var RouteKey = sessionStorage.getItem("RouteKey");
            var SalesmanCode = sessionStorage.getItem("SalesmanCode");
            // Inserting inventorysummarydetail table
            
            var QrySelect = "";
            // QrySelect = "SELECT itemcode,((cases * unitspercase) + units) as
			// LoadQty from startingloaddetail join itemmaster on actualitemcode
			// = itemcode where routecode =" +
			// sessionStorage.getItem("RouteCode") + " and loadperiodnumber = "
			// + localStorage.getItem("LoadPeriod") + " and
			// strftime('%Y-%m-%d',ddate)=date()";
			 QrySelect = "SELECT itemcode,((cases * unitspercase) + units) as LoadQty from startingloaddetail join itemmaster on actualitemcode = itemcode where routecode =" + sessionStorage.getItem("RouteCode") + " and loadperiodnumber = " + localStorage.getItem("LoadPeriod") + " ";
            console.log(QrySelect);
            if(platform == "iPad")
            {
            console.log("ipad");
                Cordova.exec(function(result) {                           
                        InsertUpdateSummary(result,0);                     
                    },
                    function(error) {
                        alert(error);
                    },
                    "PluginClass",
                    "GetdataMethod",
                    [QrySelect]);
            }
            else if(platform == "Android")
            {
                console.log("inn");
                window.plugins.DataBaseHelper.select(QrySelect, function(result) {
                	if(!$.isEmptyObject(result))
                    {
                    	var array = $.map(result.array, function(item, index) {
	                        return [[item.itemcode, item.LoadQty]];
                    	});
                    	InsertUpdateSummary(array,0);
                    }
                },
				function() {
				    console.warn("Error calling plugin");
				});
            }
        }
        function SaveInventoryTransaction()
        {
            var RouteCode = sessionStorage.getItem("RouteCode");
            var RouteKey = sessionStorage.getItem("RouteKey");
           
            Qry = "INSERT INTO inventorytransactiondetail(routekey,transactiontypecode,itemcode,quantity,itemprice,itemcaseprice,istemp,issync)  select " + RouteKey + "," + "1,itemcode,((SELECT sum((cases * upc) + units) from startingloaddetail where itemcode = sld.itemcode and loadperiodnumber = " + localStorage.LoadPeriod + ") + (ifnull((select endstockqty from openingqty where itemcode = sld.itemcode),0))) as invQty,sld.salesprice,sld.caseprice,'true',0 from startingloaddetail sld join itemmaster on actualitemcode = itemcode where routecode = " + RouteCode + " and loadperiodnumber = " + localStorage.LoadPeriod + "  group by itemcode,routecode,loadperiodnumber";
            console.log(Qry);
            // navigator.notification.navigator.notification.alert(Qry);
            if(platform == "iPad")
            {
                Cordova.exec(function(result) {
                    /*
					 * navigator.notification.alert("Transaction Saved
					 * Successfully."); window.location =
					 * "../inventory/inventory.html";
					 */
                    // navigator.notification.navigator.notification.alert(result);
                    updatebactkey();
                    // GetHHCDocumentNumber();
                },
                function(error) {
                    navigator.notification.navigator.notification.alert(error);
                },
                "PluginClass",
                "InsertUpdateMethod",
                [Qry]);
            }
            else if(platform == "Android")
            {
                window.plugins.DataBaseHelper.insert(Qry, function(result) {
                    /*
					 * navigator.notification.alert("Transaction Saved
					 * Successfully."); window.location =
					 * "../inventory/inventory.html";
					 */
                    updatebactkey();
                    // GetHHCDocumentNumber();
                },
				function() {
				    console.warn("Error calling plugin");
				});
            }
        }
        
        
        
        function InsertUpdateSummary(data,i)
        {
            ItemCode = data[i][0];
            LoadQty = data[i][1];
            console.log("insertupdate");
            var QrySelect = "SELECT COUNT(*) as cnt FROM inventorysummarydetail where itemcode = " + eval(ItemCode) + " and routekey = " + sessionStorage.getItem("RouteKey");
           var QryInsert = "INSERT INTO inventorysummarydetail(inventorykey,routekey,itemcode,loadqty,istemp,issync,stdsalesprice,stdsalescaseprice,stdreturnprice,stdreturncaseprice) SELECT " + sessionStorage.getItem("RouteKey") + "," + sessionStorage.getItem("RouteKey") + "," + ItemCode + "," + LoadQty + ",'false',0,defaultsalesprice,caseprice,defaultreturnprice,returncaseprice FROM itemmaster WHERE actualitemcode=" + ItemCode;
           var QryUpdate = "UPDATE inventorysummarydetail set loadqty = (ifnull(loadqty,0) + " + eval(LoadQty) + "),issync=0 where routekey=" + sessionStorage.getItem("RouteKey") + " and itemcode=" + ItemCode;            
           var QryNew;
            console.log(QrySelect);
            if(platform == "iPad")
            {
                Cordova.exec(function(result) {
                        if(eval(result) > 0 )
                            QryNew = QryUpdate;
                        else
                            QryNew = QryInsert;
                            
                        console.log(QryNew);
                        Cordova.exec(function(result1) {
                            if(i+1 < data.length)
                            InsertUpdateSummary(data,i+1)
                            
                            if(i == (data.length - 1))
                                SaveInventoryTransaction();
                            
                        },
                        function(error) {
                            navigator.notification.alert(error);
                        },
                        "PluginClass",
                        "InsertUpdateMethod",
                        [QryNew]);
                    },
                    function(error) {
                        alert(error);
                    },
                    "PluginClass",
                    "GetdataMethod",
                    [QrySelect]);
            }
            else if(platform == "Android")
            {
                window.plugins.DataBaseHelper.select(QrySelect, function(result) {
                    if(result.array != undefined)
                    {
                         var array = $.map(result.array, function(item, index) {
                            return [[item.cnt]];
                         });
                        if(eval(array) > 0 )                        
                            QryNew = QryUpdate;
                        else
                            QryNew = QryInsert;
                            
                        console.log(QryNew);
                        window.plugins.DataBaseHelper.insert(QryNew, function(result) {
                            if(i+1 < data.length)
                            InsertUpdateSummary(data,i+1)
                            
                            if(i == (data.length - 1))
                                SaveInventoryTransaction();
                            },
                            function() {
                                console.warn("Error calling plugin");
                            }); 
                         
                    }
                },
				function() {
				    console.warn("Error calling plugin");
				});
            }
        }
        
        function GetHHCDocumentNumber()
        {
            var Qry = "SELECT CASE WHEN MAX(hhcivtseq) IS NULL OR MAX(hhcivtseq) <=0 OR MAX(hhcivtseq) = '' OR MAX(hhcivtseq) = 'null' THEN 0 ELSE hhcivtseq END AS documentnumber FROM routemaster WHERE routecode=" + sessionStorage.getItem("RouteCode");
            if (platform == "iPad") {                
                console.log(Qry);
                Cordova.exec(function(result) {
                    if (result.length > 0) {
                        var InvoicePrefix = sessionStorage.getItem("RouteCode").toString() + '4'; // 4 is
																									// the
																									// prefix
																									// for
																									// inventory
                        InvoiceNumber = InvoicePrefix.toString() + (eval(result[0][0]) + 1).toString().lpad("0", 6);
                        InvoiceNumberField = "hhcivtseq";
                        SaveInventoryTransactionHeader();
                    }
                },
                function(error) {
                    alert(error);
                },
                "PluginClass",
                "GetdataMethod",
                [Qry]);
            }
            else if (platform == "Android") {
                window.plugins.DataBaseHelper.select(Qry, function(result) {
                	if(!$.isEmptyObject(result))
                    {
                    	result = $.map(result.array, function(item, index) {
	                        return [[item.documentnumber]];
                    	});
                    	if (result.length > 0) {
	                        var InvoicePrefix = sessionStorage.getItem("RouteCode").toString() + '4'; // 4 is
																										// the
																										// prefix
																										// for
																										// inventory
                        	InvoiceNumber = InvoicePrefix.toString() + (eval(result[0][0]) + 1).toString().lpad("0", 5);
                        	InvoiceNumberField = "hhcivtseq";
                        	SaveInventoryTransactionHeader();
                    	}
                    }
                },
                function() {
                    console.warn("Error calling plugin");
                });
            }
        } 
        
        function SaveInventoryTransactionHeader()
        {
            var transactiontype = 1; // Type 1 is load
            var Qry = "INSERT INTO inventorytransactionheader(inventorykey,routekey,transactiontype,routecode,salesmancode,transactiondate,transactiontime,documentnumber,odometerreading,transferlocationcode,referencenumber,securitycode,transmitindicator,voidflag,hhcdocumentnumber,loadnumber,refdocumentnumber,currencycode,actualtransactiondate,inventorynumber,data,issync,istemp,printstatus) VALUES(" + sessionStorage.getItem("RouteKey") + "," + sessionStorage.getItem("RouteKey") + "," + transactiontype + "," + sessionStorage.getItem("RouteCode") + "," + sessionStorage.getItem("SalesmanCode") + ",date('now', 'localtime'),time('now', 'localtime')," + DocumentNumber + ",0,0,0,0,0,0," + InvoiceNumber + "," + localStorage.LoadPeriod + ",0,0,date(),0,0,0,'false'," + printstatus + ")";
            console.log(Qry);
            if (platform == "iPad") 
                {
                    Cordova.exec(function(result) {
                          UpdateTransactionDetail();           
                    },
                    function(error) {
                        navigator.notification.alert(error);
                    },
                    "PluginClass",
                    "InsertUpdateMethod",
                    [Qry]);
                }
                else if (platform == "Android") 
                {
                    window.plugins.DataBaseHelper.insert(Qry, function(result) {
                         UpdateTransactionDetail();                  	
                    },
                    function() {
                        console.warn("Error calling plugin");
                    });
                }
        }
        
        function UpdateTransactionDetail()
        {
            var Qry = "UPDATE inventorytransactiondetail SET istemp='false',detailkey=(SELECT MAX(detailkey) FROM inventorytransactionheader) WHERE istemp='true' AND transactiontypecode = 1 AND routekey=" + sessionStorage.getItem("RouteKey");
            console.log(Qry);
            if (platform == "iPad") 
                {
                    Cordova.exec(function(result) {
                          UpdateDocumentNumber();           
                    },
                    function(error) {
                        navigator.notification.alert(error);
                    },
                    "PluginClass",
                    "InsertUpdateMethod",
                    [Qry]);
                }
                else if (platform == "Android") 
                {
                    window.plugins.DataBaseHelper.insert(Qry, function(result) {
                         UpdateDocumentNumber();                  	
                    },
                    function() {
                        console.warn("Error calling plugin");
                    });
                }
        }
        
        function SaveOrderDetail()
        {
            var Qry = "UPDATE salesorderdetail SET istemp='false',issync=0,transactionkey=(SELECT transactionkey FROM salesorderheader WHERE routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey = " + sessionStorage.getItem("VisitKey") + ") WHERE routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + sessionStorage.getItem("VisitKey");
            console.log(Qry);
            if(platform == "iPad")
            {
                Cordova.exec(function(result) {
                              SaveOrderHeader();
                              },
                              function(error) {
                              navigator.notification.alert(error);
                              },
                              "PluginClass",
                              "InsertUpdateMethod",
                              [Qry]);
            }
            else if(platform == "Android")
            {
                window.plugins.DataBaseHelper.insert(Qry, function(result) {
                                                     SaveOrderHeader();
                                                     },
                                                     function() {
                                                     console.warn("Error calling plugin");
                                                     });
            }
        }
        
        function SaveOrderHeader() {
            InvoiceNumber = sessionStorage.getItem("OrderNumber");
            InvoiceNumberField = "hhcordseq"
            var Qry = "Update salesorderheader set totalinvoiceamount=(ifnull(totalsalesamount,0)-ifnull(totalreturnamount,0)-ifnull(totalpromoamount,0)-ifnull(totaldamagedamount,0)),istemp = 'false',issync=0,invoicenumber=" + sessionStorage.getItem("OrderNumber") + ",documentnumber=" + DocumentNumber + ",hhctransactionkey=" + sessionStorage.getItem("VisitKey") + ",printstatus=" + printstatus + " where routekey = " + sessionStorage.getItem('RouteKey') + " and visitkey = " + sessionStorage.getItem('VisitKey') + "";
            console.log(Qry);
            if(platform == "iPad")
            {
                Cordova.exec(function(result) {
                              UpdateSignature('order');
                              // UpdateDocumentNumber();
                              /*
								 * navigator.notification.alert("Transaction
								 * Saved Successfully."); window.location =
								 * "../customer_opt/cust_opt.html";
								 */
                              },
                              function(error) {
                              navigator.notification.alert("Error save invoice header detail record");
                              },
                              "PluginClass",
                              "InsertUpdateMethod",
                              [Qry]);
            }
            else if(platform == "Android")
            {
                window.plugins.DataBaseHelper.insert(Qry, function(result) {
                                                     UpdateSignature('order');
                                                     // UpdateDocumentNumber();
                                                     /*
														 * navigator.notification.alert("Transaction
														 * Saved
														 * Successfully.");
														 * window.location =
														 * "../customer_opt/cust_opt.html";
														 */
                                                     },
                                                     function() {
                                                     console.warn("Error calling plugin");
                                                     });
            }
        }
        
        // Saving Collection
        var objSettle;;
        objSettle = localStorage.getItem("ARDATA");   
        if(objSettle)
            objSettle = JSON.parse(objSettle);
        
        function GetCollectionPaymentType()
        {   
        		//,CASE WHEN checkdate = DATE('now') THEN 1 ELSE 0 END AS postdated
                var Qry = "SELECT typecode FROM cashcheckdetail WHERE routekey=" + sessionStorage.getItem("RouteKey") + " AND visitkey = " + sessionStorage.getItem("VisitKey");
                console.log(Qry);
                if (platform == 'iPad') 
                {
                    Cordova.exec(function(result) {
                        if(result.length > 0)
                        {
                            var CollectionPayType = result[0][0];
                            if(CollectionPayType == 1) // Cheque Payment
                            {
                                /*
								 * if(sessionStorage.getItem("disablebalanceupdate") ==
								 * 0) balanceupdate = true; else
								 * if(sessionStorage.getItem("disablebalanceupdate") ==
								 * 1) balanceupdate = false;
								 */
                                if(sessionStorage.getItem("disablebalanceupdate") == 1)                
                                    balanceupdate = true;
                                else if(sessionStorage.getItem("disablebalanceupdate") == 0)
                                    balanceupdate = false;
                            }
                        }
                        SetCustomerInvoice();
                    },
                    function(error) {
                        navigator.notification.alert(error);
                    },
                    "PluginClass",
                    "GetdataMethod",
                    [Qry]);
                }
                else if (platform == 'Android') 
                {
                    window.plugins.DataBaseHelper.select(Qry, function(result) {
                    	if(result.array != undefined)
                    	{
                        	result = $.map(result.array, function(item, index) {
                             	return [[item.typecode,item.postdated]];
                        	});
                        	if (result.length > 0) {
	                            var CollectionPayType = result[0][0];
                            	if (CollectionPayType == 1) // Cheque Payment
                            	{
	                              
                                    if(sessionStorage.getItem("disablebalanceupdate") == 1)                
                                        balanceupdate = true;
                                    else if(sessionStorage.getItem("disablebalanceupdate") == 0)
                                        balanceupdate = false;
                                    
//                                    if(eval(result[0][1])==1){
//                                    	 balanceupdate = true;
//                                    	
//                                    }
                                    
                            	}
                        	}
                        }
                        SetCustomerInvoice();
                    },
					function() {
					    console.warn("Error calling plugin");
					});
                }
        }
        
        function SetCustomerInvoice()
        {         	
            amountpaid1 = 0;
            invoicebalance1 = 0;
            if(objSettle.autoAR == false)
            {
                tmpdata = localStorage.getItem("tmpargrid");
                if(platform == "iPad")
                	tmpdata = JSON.parse(tmpdata.split(","));
                else                
                	tmpdata = JSON.parse(tmpdata);
                //Used When updating collection one by one
                updateCollections();
            }
            else
            {
                FetchFIFOInvoice();
            }                
        }
        
       function updateCollections(){
    	   
    	   //Grid Available in Autosettler Screen
    	   var duecollection=tmpdata.shift();
    	   if (localStorage.ARAmount == 0 && eval(duecollection[4]) != 0){
    		   duecollection[4] = duecollection[3];
    	   }
    	   amountpaid1 = eval(amountpaid1) + eval(duecollection[4]);
           invoicebalance1 = eval(invoicebalance1) + (eval(duecollection[3]) - eval(duecollection[4]));
           objSettle.balancedue = parseFloat(invoicebalance1);
           objSettle.ARAmount = parseFloat(amountpaid1);
           
           if(duecollection[4] != 0)
           {
               UpdateARdetail(duecollection);
              
           }else
           {
        	   if(tmpdata.length>0){
        		   updateCollections();
        	   }
        	   else{
        		   
        		   if(printstatus!=1){
        			   UpdateCustomerMasterBalance(amountpaid1); 
        		   }
        		   else
        			   GetARInvoiceNumber();
        	   }
        		  
        	   
           }
          
       }
        
        function UpdateARdetail(duecollection)
        {
            var actualamountpaid = 0 ;
            var invoicebalance = 0;
            if(eval(duecollection[3]) > eval(duecollection[4]))
            {
                actualamountpaid = eval(duecollection[4]);
                invoicebalance = (eval(duecollection[3]) - eval(duecollection[4]));
            }
            else // Paying whole invoicebalance, if amountpaid is greater
					// than invoicebalance
            {
                actualamountpaid = eval(duecollection[3]);
                invoicebalance = 0;
            }
            var Qry = "SELECT count(*) as cnt FROM ardetail WHERE routekey=" + sessionStorage.getItem("RouteKey") + " AND visitkey=" + sessionStorage.getItem("VisitKey") + " AND invoicenumber = " + duecollection[1];            
            
            if(balanceupdate == true) // Not Updating PDC Details
            {
                var QryInsert = "INSERT into ardetail(routekey,visitkey,transactionkey,invoicenumber,invoicedate,totalinvoiceamount,amountpaid,invoicebalance,issync,istemp,salesmancode,alternateinvoicenumber,sapchequestatusindicator) VALUES(" + sessionStorage.getItem("RouteKey") + "," + sessionStorage.getItem("VisitKey") + ",0," + duecollection[1] + ",(SELECT transactiondate FROM customerinvoice WHERE invoicenumber = " + duecollection[1] + ")," + duecollection[7] + "," + actualamountpaid + "," + invoicebalance + ",0,'true',(SELECT CASE status WHEN 1 THEN (SELECT salesmancode FROM customerinvoice WHERE invoicenumber = " + duecollection[1] + ") ELSE " + sessionStorage.getItem("SalesmanCode") + " END FROM controlpanel WHERE flagid = 71),(SELECT erpreferencenumber FROM customerinvoice WHERE invoicenumber = " + duecollection[1] + "),'"+duecollection[2]+"')";
                var QryUpdate = "UPDATE ardetail set amountpaid=" + actualamountpaid + ",invoicebalance=" + invoicebalance + ",sapchequestatusindicator='"+duecollection[2]+"',salesmancode = (SELECT CASE status WHEN 1 THEN (SELECT salesmancode FROM customerinvoice WHERE invoicenumber = " + duecollection[1] + ") ELSE " + sessionStorage.getItem("SalesmanCode") + " END FROM controlpanel WHERE flagid = 71) WHERE AND invoicenumber=" + tmpdata[0];
            }
            else
            {
                var QryInsert = "INSERT into ardetail(routekey,visitkey,transactionkey,invoicenumber,invoicedate,totalinvoiceamount,amountpaid,invoicebalance,issync,istemp,pdcbalance,salesmancode,alternateinvoicenumber,sapchequestatusindicator) VALUES(" + sessionStorage.getItem("RouteKey") + "," + sessionStorage.getItem("VisitKey") + ",0," + duecollection[1] + ",(SELECT transactiondate FROM customerinvoice WHERE invoicenumber = " + duecollection[1] + ")," + duecollection[7] + "," + actualamountpaid + "," + invoicebalance + ",0,'true',(SELECT CASE typecode WHEN 1 THEN " + actualamountpaid + " ELSE 0 END FROM cashcheckdetail WHERE routekey=" + sessionStorage.getItem("RouteKey") + " AND visitkey=" + sessionStorage.getItem("VisitKey") + "),(SELECT CASE status WHEN 1 THEN (SELECT salesmancode FROM customerinvoice WHERE invoicenumber = " + duecollection[1] + ") ELSE " + sessionStorage.getItem("SalesmanCode") + " END FROM controlpanel WHERE flagid = 71),(SELECT erpreferencenumber FROM customerinvoice WHERE invoicenumber = " + duecollection[1] + "),'"+duecollection[2]+"')";
                var QryUpdate = "UPDATE ardetail set amountpaid=" + actualamountpaid + ",invoicebalance=" + invoicebalance + ",sapchequestatusindicator='"+duecollection[2]+"',pdcbalance= (SELECT CASE typecode WHEN 1 THEN (ifnull(pdcbalance,0) + " + actualamountpaid + ") ELSE pdcbalance END FROM cashcheckdetail WHERE routekey=" + sessionStorage.getItem("RouteKey") + " AND visitkey=" + sessionStorage.getItem("VisitKey") + "),salesmancode = (SELECT CASE status WHEN 1 THEN (SELECT salesmancode FROM customerinvoice WHERE invoicenumber = " + duecollection[1] + ") ELSE " + sessionStorage.getItem("SalesmanCode") + " END FROM controlpanel WHERE flagid = 71) WHERE invoicenumber=" + duecollection[1];
            }
            if(platform == "iPad")
            {
                var QryNew;
                Cordova.exec(function(result) {
                    if(result[0][0] > 0)
                        QryNew = QryUpdate;
                    else
                        QryNew = QryInsert;
                    
                    console.log(QryNew);
                    
                    Cordova.exec(function(result) {
                    	  UpdateEachCollectionInvoiceBalance(duecollection);
                    },
                    function(error) { alert(error);},
                    "PluginClass",
                    "InsertUpdateMethod",
                    [QryNew]);
                },
                function(error) { alert(error);},
                "PluginClass",
                "GetdataMethod",
                [Qry]);
            }
            else if(platform == "Android")
            {
                var QryNew;
                window.plugins.DataBaseHelper.select(Qry,function(result)
                {
                    if(result.array[0].cnt > 0)
                        QryNew = QryUpdate;
                    else
                        QryNew = QryInsert;
                    console.log(QryNew);
                    window.plugins.DataBaseHelper.insert(QryNew,function(result)
                    {
                    	
                    	if(printstatus!=1){
                    			UpdateEachCollectionInvoiceBalance(duecollection);
                    	}else{
                    		
                    		if(tmpdata.length>0)
                            {
                            	updateCollections(tmpdata);
                                 
                            }else
                            {
                            	 GetARInvoiceNumber();
                            	
                            }
                    		
                    	}
                       
                    },
                    function()
                    {
                        console.warn("Error calling plugin");
                    });
                },
                function()
                {
                    console.warn("Error calling plugin");
                });
            }
        }
        
        function UpdateEachCollectionInvoiceBalance(duecollection)
        {
            var actualamountpaid = 0 ;            
            if(eval(duecollection[3]) > eval(duecollection[4]))            
                actualamountpaid = eval(duecollection[4]);                            
            else // Paying whole invoicebalance, if amountpaid is greater
					// than invoicebalance
                actualamountpaid = eval(duecollection[3]);
            
            var Qry;
            if(balanceupdate == true)
                Qry = "UPDATE customerinvoice set amountpaid=(amountpaid + " + actualamountpaid + "),invoicebalance = (invoicebalance - " + actualamountpaid + "),issync=0 WHERE invoicenumber=" + duecollection[1];
            else if(balanceupdate == false)            
                Qry = "UPDATE customerinvoice set issync=0,pdcindicator=(SELECT CASE typecode WHEN 1 THEN 1 ELSE 0 END FROM cashcheckdetail WHERE routekey=" + sessionStorage.getItem("RouteKey") + " AND visitkey=" + sessionStorage.getItem("VisitKey") + "),pdcbalance= (SELECT CASE typecode WHEN 1 THEN (ifnull(pdcbalance,0) + " + actualamountpaid + ") ELSE pdcbalance END FROM cashcheckdetail WHERE routekey=" + sessionStorage.getItem("RouteKey") + " AND visitkey=" + sessionStorage.getItem("VisitKey") + "),pdcdate=(SELECT CASE typecode WHEN 1 THEN checkdate ELSE pdcdate END FROM cashcheckdetail WHERE routekey=" + sessionStorage.getItem("RouteKey") + " AND visitkey=" + sessionStorage.getItem("VisitKey") + ") WHERE invoicenumber=" + duecollection[1];
            else
                Qry = "UPDATE customerinvoice set amountpaid=(amountpaid + " + actualamountpaid + "),invoicebalance = (invoicebalance - " + actualamountpaid + "),issync=0,pdcindicator=(SELECT CASE typecode WHEN 1 THEN 1 ELSE 0 END FROM cashcheckdetail WHERE routekey=" + sessionStorage.getItem("RouteKey") + " AND visitkey=" + sessionStorage.getItem("VisitKey") + "),pdcbalance= (SELECT CASE typecode WHEN 1 THEN (ifnull(pdcbalance,0) + " + actualamountpaid + ") ELSE pdcbalance END FROM cashcheckdetail WHERE routekey=" + sessionStorage.getItem("RouteKey") + " AND visitkey=" + sessionStorage.getItem("VisitKey") + "),pdcdate=(SELECT CASE typecode WHEN 1 THEN checkdate ELSE pdcdate END FROM cashcheckdetail WHERE routekey=" + sessionStorage.getItem("RouteKey") + " AND visitkey=" + sessionStorage.getItem("VisitKey") + ") WHERE customercode = " + sessionStorage.getItem("customerid") + "  and invoicenumber=" + duecollection[1];
            console.log(Qry);
           // alert(Qry);
            
            if(platform == "iPad")
            {
                Cordova.exec(function(result) {
                              if(i == eval(tmpdata.length - 1))
                              {
                                    UpdateCustomerMasterBalance(amountpaid);                                
                              }
                              },
                              function(error) { alert(error);},
                              "PluginClass",
                              "InsertUpdateMethod",
                              [Qry]);
            }
            else if(platform == "Android")
            {
                window.plugins.DataBaseHelper.insert(Qry,function(result)
                {
                    // amountpaid = eval(amountpaid) + tmpdata[i][4];
                    if(tmpdata.length>0)
                    {
                    	updateCollections(tmpdata);
                         
                    }else
                    {	
                    	 UpdateCustomerMasterBalance(amountpaid1);           
                    }
                },
                function()
                {
                    console.warn("Error calling plugin");
                });
            }
        }
        
        function FetchFIFOInvoice()
        {
            var Qry = "SELECT invoicebalance,invoicenumber,totalinvoiceamount FROM customerinvoice WHERE invoicebalance <> 0 and customercode = " + sessionStorage.getItem("customerid") + " AND invoicenumber NOT IN(SELECT ard.invoicenumber FROM ardetail ard JOIN arheader arh ON ard.transactionkey = arh.transactionkey AND arh.voidflag = 1) ORDER BY invoicenumber";
            console.log(Qry);
            if(platform == "iPad")
            {
                Cordova.exec(function(result) {
                              UpdateCustomerInvoiceAuto(result);
                              },
                              function(error) { alert(error);},
                              "PluginClass",
                              "GetdataMethod",
                              [Qry]);
            }
            else if(platform == "Android")
            {
                window.plugins.DataBaseHelper.select(Qry,function(result)
                {                	
                	if(!$.isEmptyObject(result))
                    {
                		var array = $.map(result.array, function(item, index) {
	                		return [[item.invoicebalance, item.invoicenumber,item.totalinvoiceamount]];
                		});                		
                		result = array;
                		UpdateCustomerInvoiceAuto(result);
                	}
                },
                function()
                {
                	console.warn("Error calling plugin");
                });
            }
        }
        
        function UpdateCustomerInvoiceAuto(result)
        {
            var Amount;
            var AmountPaid;
            var Balance;
            var TotalBalance = 0;
            var TotalAmountPaid = 0;
            var EqualCollection = false;
            
            Amount = localStorage.ARAmount;
            Balance = Amount;
            FinalBalance = Amount;
            
            if(Amount == 0)
                EqualCollection = true;
            
            if(result.length > 0)
            {
                for(i=0;i<result.length;i++)
                {
                    var cnt = i;
                    if(eval(Balance) == 0 && EqualCollection != true)
                        break;
                    else
                    {
                            if(EqualCollection == true)
                                Balance = result[i][0];
                        
                            if(eval(Balance) >= eval(result[i][0]))
                            {
                                Balance = eval(Balance) - eval(result[i][0]);
                                AmountPaid = eval(result[i][0]);
                                
                                TotalAmountPaid = eval(TotalAmountPaid) + eval(AmountPaid);
                                TotalBalance = TotalBalance + (eval(result[i][0]) - eval(AmountPaid));
                                console.log("TotalAmountPaid"+TotalAmountPaid);
                                console.log("TotalBalance"+TotalBalance);
                                UpdateARdetailAuto(i,result,AmountPaid,TotalAmountPaid,TotalBalance)
                                // UpdateCustomerInvoiceAutoEach(i,result,AmountPaid,TotalAmountPaid,TotalBalance);
                            }
                            else
                            {
                                AmountPaid = Balance;
                            
                                TotalAmountPaid = eval(TotalAmountPaid) + eval(AmountPaid);
                                console.log("TotalAmountPaid"+TotalAmountPaid);
                                TotalBalance = TotalBalance + (eval(result[i][0]) - eval(AmountPaid));
                                Balance = 0;
                                UpdateARdetailAuto(i,result,AmountPaid,TotalAmountPaid,TotalBalance) 
                                // UpdateCustomerInvoiceAutoEach(i,result,AmountPaid,TotalAmountPaid,TotalBalance);
                            }
                    }
                }
                if(sessionStorage.getItem("enableadvancepayment") == 1)
                {
                    /*
					 * if(eval(Balance) > eval(TotalAmountPaid))
					 * advpaycollection = Balance;
					 */
                    if(eval(Balance) != 0)
                        advpaycollection = Balance;
                }
                /*
				 * if(Balance == 0) { objSettle.balancedue = TotalBalance;
				 * objSettle.ARAmount = TotalAmountPaid;
				 * UpdateCustomerMasterBalance(eval(AmountPaid)); }
				 */
            }
        }
        
        function UpdateARdetailAuto(i,resultdata,AmountPaid,TotalAmountPaid,TotalBalance)
        {	
            var tmpdata = localStorage.getItem("tmpargrid");
            if(platform == "iPad")   
            	tmpdata = JSON.parse(tmpdata.split(","));
            else if(platform == "Android")
            	tmpdata = JSON.parse(tmpdata);
            	
            var Qry = "SELECT count(*) as cnt FROM ardetail WHERE routekey=" + sessionStorage.getItem("RouteKey") + " AND visitkey=" + sessionStorage.getItem("VisitKey") + " AND invoicenumber = " + tmpdata[i][0];
            console.log(Qry);
            if(balanceupdate == true) // Not Updating PDC Details
            {
                var QryInsert = "INSERT into ardetail(routekey,visitkey,transactionkey,invoicenumber,invoicedate,totalinvoiceamount,amountpaid,invoicebalance,issync,istemp,salesmancode,alternateinvoicenumber,sapchequestatusindicator) VALUES(" + sessionStorage.getItem("RouteKey") + "," + sessionStorage.getItem("VisitKey") + ",0," + tmpdata[i][0] + ",(SELECT transactiondate FROM customerinvoice WHERE invoicenumber = " + tmpdata[i][0] + ")," + tmpdata[i][2] + "," + AmountPaid + "," + (eval(tmpdata[i][3]) - eval(AmountPaid)) + ",0,'true',(SELECT CASE status WHEN 1 THEN (SELECT salesmancode FROM customerinvoice WHERE invoicenumber = " + tmpdata[i][0] + ") ELSE " + sessionStorage.getItem("SalesmanCode") + " END FROM controlpanel WHERE flagid = 71),(SELECT erpreferencenumber FROM customerinvoice WHERE invoicenumber = " +  tmpdata[i][0] + "),'"+duecollection[2]+"')";            
                var QryUpdate = "UPDATE ardetail set amountpaid=" + AmountPaid + ",invoicebalance=" + objSettle.balancedue + ",sapchequestatusindicator='"+duecollection[2]+"',salesmancode = (SELECT CASE status WHEN 1 THEN (SELECT salesmancode FROM customerinvoice WHERE invoicenumber = " + tmpdata[i][0] + ") ELSE " + sessionStorage.getItem("SalesmanCode") + " END FROM controlpanel WHERE flagid = 71) WHERE invoicenumber=" + tmpdata[i][0];
            }
            else
            {
                var QryInsert = "INSERT into ardetail(routekey,visitkey,transactionkey,invoicenumber,invoicedate,totalinvoiceamount,amountpaid,invoicebalance,issync,istemp,pdcbalance,salesmancode,alternateinvoicenumber,sapchequestatusindicator) VALUES(" + sessionStorage.getItem("RouteKey") + "," + sessionStorage.getItem("VisitKey") + ",0," + tmpdata[i][0] + ",(SELECT transactiondate FROM customerinvoice WHERE invoicenumber = " + tmpdata[i][0] + ")," + tmpdata[i][2] + "," + AmountPaid + "," + (eval(tmpdata[i][3]) - eval(AmountPaid)) + ",0,'true',(SELECT CASE typecode WHEN 1 THEN " + AmountPaid + " ELSE 0 END FROM cashcheckdetail WHERE routekey=" + sessionStorage.getItem("RouteKey") + " AND visitkey=" + sessionStorage.getItem("VisitKey") + "),(SELECT CASE status WHEN 1 THEN (SELECT salesmancode FROM customerinvoice WHERE invoicenumber = " + tmpdata[i][0] + ") ELSE " + sessionStorage.getItem("SalesmanCode") + " END FROM controlpanel WHERE flagid = 71),(SELECT erpreferencenumber FROM customerinvoice WHERE invoicenumber = " +  tmpdata[i][0] + "),'"+duecollection[2]+"')";            
                var QryUpdate = "UPDATE ardetail set amountpaid=" + AmountPaid + ",invoicebalance=" + objSettle.balancedue + ",sapchequestatusindicator='"+duecollection[2]+"',pdcbalance=(SELECT CASE typecode WHEN 1 THEN (ifnull(pdcbalance,0) + " + AmountPaid + ") ELSE pdcbalance END FROM cashcheckdetail WHERE routekey=" + sessionStorage.getItem("RouteKey") + " AND visitkey=" + sessionStorage.getItem("VisitKey") + "),salesmancode = (SELECT CASE status WHEN 1 THEN (SELECT salesmancode FROM customerinvoice WHERE invoicenumber = " + tmpdata[i][0] + ") ELSE " + sessionStorage.getItem("SalesmanCode") + " END FROM controlpanel WHERE flagid = 71) WHERE invoicenumber=" + tmpdata[i][0];
            }
            if(platform == "iPad")
            {
                var QryNew;
                Cordova.exec(function(result) {
                    if(result[0][0] > 0)
                        QryNew = QryUpdate;
                    else
                        QryNew = QryInsert
                    
                    console.log(QryNew);
                    
                    Cordova.exec(function(result) {
                        UpdateCustomerInvoiceAutoEach(i,resultdata,AmountPaid,TotalAmountPaid,TotalBalance);
                    },
                    function(error) { alert(error);},
                    "PluginClass",
                    "InsertUpdateMethod",
                    [QryNew]);
                },
                function(error) { alert(error);},
                "PluginClass",
                "GetdataMethod",
                [Qry]);
            }
            else if(platform == "Android")
            {
                var QryNew;
                window.plugins.DataBaseHelper.select(Qry,function(result)
                {                	
                    if(result.array[0].cnt > 0)
                        QryNew = QryUpdate;
                    else
                        QryNew = QryInsert;
                    console.log(QryNew);
                    window.plugins.DataBaseHelper.insert(QryNew,function(result)
                    {
                        UpdateCustomerInvoiceAutoEach(i,resultdata,AmountPaid,TotalAmountPaid,TotalBalance);
                    },
                    function()
                    {
                        console.warn("Error calling plugin");
                    });
                },
                function()
                {
                    console.warn("Error calling plugin");
                });
            }
        }
        
        function UpdateCustomerInvoiceAutoEach(i,result,AmountPaid,TotalAmountPaid,TotalBalance)
        {           	
            if(balanceupdate == true)
            {
                var Qry = "UPDATE customerinvoice set invoicebalance=(invoicebalance - " + eval(AmountPaid) + "), amountpaid=(amountpaid + " + eval(AmountPaid) + "),issync=0 WHERE invoicenumber=" + result[i][1];
            }
            else if(balanceupdate == false)
            {
                var Qry = "UPDATE customerinvoice set pdcbalance= (SELECT CASE typecode WHEN 1 THEN(ifnull(pdcbalance,0) + " + eval(AmountPaid) + ") ELSE pdcbalance END FROM cashcheckdetail WHERE routekey = " + sessionStorage.getItem("RouteKey") + " AND visitkey=" + sessionStorage.getItem("VisitKey") + "),pdcindicator=(SELECT CASE typecode WHEN 1 THEN 1 ELSE 0 END FROM cashcheckdetail WHERE routekey=" + sessionStorage.getItem("RouteKey") + " AND visitkey=" + sessionStorage.getItem("VisitKey") + "),pdcdate=(SELECT CASE typecode WHEN 1 THEN (CASE WHEN pdcdate IS NULL THEN checkdate WHEN (checkdate < pdcdate) THEN checkdate ELSE pdcdate END) ELSE pdcdate END FROM cashcheckdetail WHERE routekey=" + sessionStorage.getItem("RouteKey") + " AND visitkey=" + sessionStorage.getItem("VisitKey") + "),issync=0 WHERE invoicenumber=" + result[i][1];
            }
            else
            {
                var Qry = "UPDATE customerinvoice set invoicebalance=(invoicebalance - " + eval(AmountPaid) + "), amountpaid=(amountpaid + " + eval(AmountPaid) + "),pdcbalance= (SELECT CASE typecode WHEN 1 THEN(ifnull(pdcbalance,0) + " + eval(AmountPaid) + ") ELSE pdcbalance END FROM cashcheckdetail WHERE routekey = " + sessionStorage.getItem("RouteKey") + " AND visitkey=" + sessionStorage.getItem("VisitKey") + "),pdcindicator=(SELECT CASE typecode WHEN 1 THEN 1 ELSE 0 END FROM cashcheckdetail WHERE routekey=" + sessionStorage.getItem("RouteKey") + " AND visitkey=" + sessionStorage.getItem("VisitKey") + "),pdcdate=(SELECT CASE typecode WHEN 1 THEN (CASE WHEN pdcdate IS NULL THEN checkdate WHEN (checkdate < pdcdate) THEN checkdate ELSE pdcdate END) ELSE pdcdate END FROM cashcheckdetail WHERE routekey=" + sessionStorage.getItem("RouteKey") + " AND visitkey=" + sessionStorage.getItem("VisitKey") + "), issync=0 WHERE invoicenumber=" + result[i][1];
            }
            console.log(Qry);
            if(platform == "iPad")
            {
                        Cordova.exec(function(result1) {   
                                        FinalBalance = FinalBalance - AmountPaid;
                                        console.log("finalbalance : " + FinalBalance);
                                        if(i == (result.length - 1) || FinalBalance == 0)
                                        {   
                                            objSettle.balancedue = TotalBalance;
                                            objSettle.ARAmount = TotalAmountPaid;
                                            UpdateCustomerMasterBalance(eval(TotalAmountPaid));
                                        }
                                      },
                                      function(error) { alert(error);},
                                      "PluginClass",
                                      "InsertUpdateMethod",
                                      [Qry]);
            }
            else if(platform == "Android")
            {
                        window.plugins.DataBaseHelper.insert(Qry,function(result1) 
                                                             {
                                                             FinalBalance = FinalBalance - AmountPaid;
                                                             if (i == (result.length - 1) || FinalBalance == 0) {
                                                                 objSettle.balancedue = TotalBalance;
                                                                 objSettle.ARAmount = TotalAmountPaid;
                                                                 UpdateCustomerMasterBalance(eval(TotalAmountPaid));
                                                             }                                                           
                                                             },
                                                             function()
                                                             {
                                                             console.warn("Error calling plugin");
                                                             });
            }
        }
        
        function UpdateCustomerMasterBalance(amount)
        {
        	
        	if(printstatus!=1){
        		var Qry = "";
                if(localStorage.po == "advance")
                    Qry = "Update customermaster set balance = (balance - " + objSettle.ARAmount + ") WHERE customercode=" + sessionStorage.getItem("customerid");
                else
                {
                    if(balanceupdate == false)
                        GetARInvoiceNumber();
                    else
                        Qry = "Update customermaster set balance =balance - "+amount+"  WHERE customercode=" + sessionStorage.getItem("customerid");
                }
                console.log("customermaster = "+Qry);
                if(Qry != "")
                {
	                if(platform == "iPad")
	                {
	                    Cordova.exec(function(result) {
	                        /*
	    					 * if(balanceupdate == true) UpdateCheckToCashCollection();
	    					 * else GetARInvoiceNumber();
	    					 */
	                        GetARInvoiceNumber();
	                    },
	                    function(error) {
	                        alert(error);
	                    },
	                    "PluginClass",
	                    "InsertUpdateMethod",
	                    [Qry]);
	                }
	                else if(platform == "Android")
	                {
	                    window.plugins.DataBaseHelper.insert(Qry, function(result) 
	                    {
	                        /*
	    					 * if(balanceupdate == true) UpdateCheckToCashCollection();
	    					 * else GetARInvoiceNumber();
	    					 */
	                        GetARInvoiceNumber();
	                    },
	                    function() 
	                    {
	                        console.warn("Error calling plugin");
	                    });
	                }
                }
        		
        		
        	}else{
        		
        		GetARInvoiceNumber();
        		
        	}
            
        }
        
        /*
		 * function UpdateCheckToCashCollection() { var Qry = "Update
		 * cashcheckdetail SET typecode = 0,bankcode = NULL, checkdate =
		 * NULL,issync = 0 WHERE routekey=" + sessionStorage.getItem("RouteKey") + "
		 * AND visitkey = " + sessionStorage.getItem("VisitKey");
		 * console.log(Qry); if(platform == "iPad") {
		 * Cordova.exec(function(result) { GetARInvoiceNumber(); },
		 * function(error) { alert(error); }, "PluginClass",
		 * "InsertUpdateMethod", [Qry]); } else if(platform == "Android") {
		 * window.plugins.DataBaseHelper.insert(Qry, function(result) {
		 * GetARInvoiceNumber(); }, function() { console.warn("Error calling
		 * plugin"); }); } }
		 */
        
        function GetARInvoiceNumber()
        {            
            /*
			 * var Qry = "SELECT CASE WHEN MAX(invoicenumber) IS NULL OR
			 * MAX(invoicenumber) = 0 THEN '000000' ELSE
			 * SUBSTR(MAX(invoicenumber),-6) END as invoicenumber from
			 * arheader";
			 */
            var Qry = "SELECT CASE WHEN MAX(hhcarseq) IS NULL OR MAX(hhcarseq) = 0 OR MAX(hhcarseq) = 'null' THEN 0 ELSE hhcarseq END as invoicenumber from routemaster" + " WHERE routecode=" + sessionStorage.getItem("RouteCode");
            console.log(Qry);
            if(platform == "iPad")
            {
                Cordova.exec(function(result) {
                              if(result.length > 0)
                              {
                              var InvoicePrefix  = sessionStorage.getItem("RouteCode").toString() + '3'; // 3 is
																											// the
																											// prefix
																											// for
																											// arheader
                              InvoiceNumber = InvoicePrefix.toString() + (eval(result[0][0]) + 1).toString().lpad("0",6); 
                              InvoiceNumberField = "hhcarseq";
                              UpdateArHeader();                 
                              }
                              },
                              function(error) {
                              alert(error);
                              },
                              "PluginClass",
                              "GetdataMethod",
                              [Qry]);
            }
            else if(platform == "Android")
            {
                window.plugins.DataBaseHelper.select(Qry, function(result)
                {
                	if(!$.isEmptyObject(result))
                    {
                		var InvoicePrefix  = sessionStorage.getItem("RouteCode").toString() + '3'; // 3 is
																									// the
																									// prefix
																									// for
																									// arheader
                		InvoiceNumber = InvoicePrefix.toString() + (eval(result.array[0].invoicenumber) + 1).toString().lpad("0", 5);
                		InvoiceNumberField = "hhcarseq";
                		UpdateArHeader();
                	}
                },
                function()
                {
                	console.warn("Error calling plugin");
                });
            }
        }
        
        
        
        function UpdateArHeader()
        {
            var advancepaymentflag;
            
            var amountdue = objSettle.balancedue;
            var totalinvoiceamount = objSettle.ARAmount;
            var amountpaid = objSettle.ARAmount;  
            var invoicebalance = totalinvoiceamount - amountpaid
            // amountdue = eval(amountdue) - eval(amountpaid);
            if (localStorage.po == "advance")
            {
            	  advancepaymentflag = 1; // localStorage.getItem("advancetype");
            }
            else
            {
            	 if(eval(localStorage.ARAmount)>eval(amountpaid))
            	 {
            		 advpaycollection= eval(localStorage.ARAmount)-eval(amountpaid);
            		 advancepaymentflag = 2;
            	 }else
                 {
            		 advancepaymentflag = 0;
                 }
            	 
            }
               
            var Qry = "SELECT COUNT(*) as cnt FROM arheader WHERE routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + sessionStorage.getItem("VisitKey");
                            
            var QryInsert = "INSERT INTO arheader(routekey,visitkey,documentnumber,transactiondate,transactiontime,customercode,routecode,salesmancode,voidflag,invoicenumber,invoicebalance,amountpaid,issync,advancepaymentflag,istemp,hhctransactionkey,totalinvoiceamount,chequecollection,excesspayment,printstatus) VALUES(" + sessionStorage.getItem("RouteKey") + "," + sessionStorage.getItem("VisitKey") + "," + DocumentNumber + ",date('now', 'localtime'),time('now', 'localtime')," + sessionStorage.getItem("customerid") + "," + sessionStorage.getItem("RouteCode") + "," + sessionStorage.getItem("SalesmanCode") + ",0," + InvoiceNumber + "," + amountdue + "," + amountpaid + ",0," + advancepaymentflag + ",'false'," + sessionStorage.getItem("VisitKey") + "," + totalinvoiceamount + ",(SELECT typecode FROM cashcheckdetail WHERE routekey=" + sessionStorage.getItem("RouteKey") + " AND visitkey=" + sessionStorage.getItem("VisitKey") + ")," + advpaycollection + "," + printstatus + ")";           
            var QryUpdate = "Update arheader set documentnumber=" + DocumentNumber + ",invoicenumber=" + InvoiceNumber + ",invoicebalance=" + amountdue + ",amountpaid=" + amountpaid +  ",issync=0,istemp='false',advancepaymentflag = " + advancepaymentflag + ",totalinvoiceamount = " + totalinvoiceamount + ",hhctransactionkey = " + sessionStorage.getItem("VisitKey") + ",chequecollection = (SELECT typecode FROM cashcheckdetail WHERE routekey=" + sessionStorage.getItem("RouteKey") + " AND visitkey=" + sessionStorage.getItem("VisitKey") + "),excesspayment = " + advpaycollection + ",printstatus = " + printstatus + " WHERE routekey=" + sessionStorage.getItem("RouteKey") + " AND visitkey=" + sessionStorage.getItem("VisitKey");
            if(platform == "iPad")
            {
                Cordova.exec(function(result) {
                                console.log(Qry);
                                var QryNew;                                
                                if(result[0][0] > 0)                                
                                    QryNew = QryUpdate;                                
                                else
                                    QryNew = QryInsert;
                                console.log(QryNew);
                                Cordova.exec(function(result) {
                                        if(localStorage.po == "collection")
                                            UpdateARDetailTransactionKey();
                                        else                                        
                                            UpdateCashCheckTransactionKey();
                                    },
                                    function(error) { alert(error);},
                                    "PluginClass",
                                    "InsertUpdateMethod",
                                    [QryNew]);
                              },
                              function(error) { alert(error);},
                              "PluginClass",
                              "GetdataMethod",
                              [Qry]);
            }
            else if(platform == "Android")
            {
                    window.plugins.DataBaseHelper.select(Qry,function(result)                                                                 
                                {
                                    var QryNew;
                                    if(result.array != undefined)
                                    {
                                        if(result.array[0].cnt > 0)
                                            QryNew = QryUpdate;
                                        else
                                        	QryNew = QryInsert;
                                    }
                                    window.plugins.DataBaseHelper.insert(QryNew,function(result){
                                        if(localStorage.po == "collection")
                                            UpdateARDetailTransactionKey();
                                        else                                        
                                            UpdateCashCheckTransactionKey();
                                    },
                                    function()
                                    {
                                        console.warn("Error calling plugin");
                                    });                                    
                                },
                                function()
                                {
                                    console.warn("Error calling plugin");
                                });
            }
        }
        
        function UpdateARDetailTransactionKey()
        {
            var Qry = "UPDATE ardetail set istemp='false',transactionkey = (SELECT transactionkey FROM arheader WHERE routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + sessionStorage.getItem("VisitKey") + ") WHERE routekey=" + sessionStorage.getItem("RouteKey") + " AND visitkey=" + sessionStorage.getItem("VisitKey");
            console.log(Qry);
            if(platform == "iPad")
            {
                Cordova.exec(function(result) {
                    UpdateCashCheckTransactionKey();
                },
                function(error) { alert(error);},
                "PluginClass",
                "InsertUpdateMethod",
                [Qry]);
            }
            else if(platform == "Android")
            {
                window.plugins.DataBaseHelper.insert(Qry,function(result){
                    UpdateCashCheckTransactionKey();
                },
                function()
                {
                    console.warn("Error calling plugin");
                });
            }
        }
        
        // Update transasction key in cashcheckdetail for collection/advance
		// transaction.
        function UpdateCashCheckTransactionKey()
        {
            var Qry = "Update cashcheckdetail set istemp = 'false',issync=0,hhctransactionkey= " + sessionStorage.getItem("VisitKey") + " where routekey = " + sessionStorage.getItem('RouteKey') + " and visitkey = " + sessionStorage.getItem('VisitKey') + "";
            console.log(Qry);
            if(platform == "iPad")
            {
                Cordova.exec(function(result) {
                    UpdateDocumentNumber();
                },
                function(error) {
                    navigator.notification.alert("Error save cash cheque detail record");
                },
                "PluginClass",
                "InsertUpdateMethod",
                [Qry]);
            }
            else if(platform == "Android")
            {
                window.plugins.DataBaseHelper.insert(Qry, function(result) {
                    UpdateDocumentNumber()
                },
				function() {
				    console.warn("Error calling plugin");
				});
            }
        }
        
        function UpdateSignature(Transaction)
        {
            var HeaderTable;
            var routekey = sessionStorage.getItem("RouteKey");
            var visitkey = sessionStorage.getItem("VisitKey");
            switch(Transaction)
            {
                case "sales":
                    HeaderTable = "invoiceheader";
                    break;
                case "order":
                    HeaderTable = "salesorderheader";
                    break;                
            }
            var Qry = "SELECT COUNT(*) as cnt FROM sigcapturedata WHERE routekey=" + sessionStorage.getItem("RouteKey") + " AND visitkey=" + sessionStorage.getItem("VisitKey");
            var QryUpdate = "UPDATE sigcapturedata set istemp='false',issync=0,transactionkey=(SELECT transactionkey from " + HeaderTable + " WHERE routekey=" + routekey + " AND visitkey=" + visitkey + "),documentnumber=(SELECT documentnumber FROM " + HeaderTable + " WHERE routekey=" + routekey + " AND visitkey=" + visitkey + ") WHERE routekey=" + routekey + " AND visitkey=" + visitkey;
            console.log(Qry);
            if(platform == "iPad")
            {
                Cordova.exec(function(result) {
                    if(result[0][0] > 0)
                    {
                        console.log(QryUpdate);
                        Cordova.exec(function(result) {
                            UpdateDocumentNumber();
                        },
                        function(error) { alert(error);},
                        "PluginClass",
                        "InsertUpdateMethod",
                        [QryUpdate]);
                    }
                    else
                        UpdateDocumentNumber();
                },
                function(error) { alert(error);},
                "PluginClass",
                "GetdataMethod",
                [Qry]);
            }
            else if(platform == "Android")
            {
                window.plugins.DataBaseHelper.select(Qry,function(result){                	
                    if(result.array[0].cnt > 0)
                    {
                        console.log(QryUpdate);
                        window.plugins.DataBaseHelper.insert(QryUpdate,function(result){
                            UpdateDocumentNumber();
                        },
                        function()
                        {
                            console.warn("Error calling plugin");
                        });
                    }
                    else
                        UpdateDocumentNumber();
                },
                function()
                {
                	console.warn("Error calling plugin");
                });
            }
        }
        
        function UpdateDocumentNumber()
        {
          
        	if(printstatus==1){
        		
        		 $.mobile.hidePageLoadingMsg();         	
                 SelectPrint();
        		
        	}else{
        	
	            var Qry = "UPDATE routemaster SET bodocseq = (ifnull(bodocseq,0) + 1)," + InvoiceNumberField + " = (ifnull(" + InvoiceNumberField + ",0) + 1) WHERE routecode=" + sessionStorage.getItem("RouteCode");
	            console.log(Qry);
	            //alert(Qry);
	            if(platform == "iPad")
	            {
	                console.log("LocalStorage PO : " + localStorage.po);
	                Cordova.exec(function(result) {   
	                    SelectPrint();
	                },
	                function(error) {
	                    alert(error);
	                },
	                "PluginClass",
	                "InsertUpdateMethod",
	                [Qry]);
	            }
	            else if(platform == "Android")
	            {
	            	window.plugins.DataBaseHelper.insert(Qry,function(result){   
	            		
	            	     $.mobile.hidePageLoadingMsg();         	
	                     SelectPrint();
	            	     
	                    // Pairedprinter();
	                },
	                function()
	                {
	                    console.warn("Error calling plugin");
	                });    
	        	}
        	}
        }
        // -----------------------------
        function Pairedprinter()
        {
          // alert("tss");
        window.plugins.BluetoothHelper.fetch('1',function(data)
            {
                
                if(data.address == undefined)
                {
                    var msg = "Printer Is Not Paired,Do You Want To Continue?";
                    navigator.notification.confirm(msg,function(action){
                    if(action == true)
                        {
                       // SelectPrint();
                        PrintDone();
                        }
                    else
                        {
                        $("#lnkNext").attr("onclick","Pairedprinter()"); 
                        $("#cntlbl").removeClass('MenuGray');
                        $("#lnkExit").addClass('MenuGray');
                        $("#lnkExit").attr("href","");
                        return false;
                        }
                    });
                }else
                {
                    uproutemaster(data.address);
                    
                }
            },
            function()
            {
             
            });
        }
        // ------Start Update Route master
        function uproutemaster(macid)
        {
        // alert(macid);
        var qry="Select memo1 FROM routemaster WHERE memo1='"+macid+"' and routecode=" + sessionStorage.getItem("RouteCode");
      
                window.plugins.DataBaseHelper.select(qry, function(result) {
                                
                             if (result.array != undefined) {
                               // alert("tes");
                                alldeviceinsert(macid);
                                }
                            else {
                            
                                var Qry = "UPDATE routemaster SET memo1 = '"+macid+"' WHERE routecode=" + sessionStorage.getItem("RouteCode");
                                
                                                window.plugins.DataBaseHelper.insert(Qry, function(result) 
                                                {   
                                               // alert("testsss");
                                                    alldeviceinsert(macid);
                                                },
                                                function()
                                                {
                                                    console.warn("Error calling plugin");
                                                });
                    
                            }
                        },
                        function() {
                            console.warn("Error calling plugin");
                        });

        }
        function alldeviceinsert(macid)
        {

            $.mobile.showPageLoadingMsg();
        window.plugins.BluetoothHelper.fetch(macid,function(data) {
            $.mobile.hidePageLoadingMsg();
                                
                             if (data.status == true) {
                               // alert("tesfffff");
                                SelectPrint();
                                }
                            else {
                                
                                var msg = "Printer Is Out Of Range OR Not Paired,Do You Want To Continue?";
                                navigator.notification.confirm(msg,function(action){
                                if(action == true)
                                    {
                                   // SelectPrint();
                                    PrintDone();
                                    }
                                else
                                    {
                                    $("#lnkNext").attr("onclick","Pairedprinter()"); 
                                    $("#cntlbl").removeClass('MenuGray');
                                    $("#lnkExit").addClass('MenuGray');
                                    $("#lnkExit").attr("href","");
                                    return false;
                                    }
                                });
                                
                            }
                        },
                        function() {
                            console.warn("Error calling plugin");
                        });
        }

        function delet()
        {
                                    var Qry = "Delete From printer";
                                            // alert(Qry);
                                                window.plugins.DataBaseHelper.insert(Qry, function(result) 
                                                {   
                                                    deviceall();
                                                },
                                                function()
                                                {
                                                    console.warn("Error calling plugin");
                                                });

        }
        function deviceall()
        {
        var flag=1;
        window.plugins.BluetoothHelper.fetch('2',function(data)
                    {
                    
                        // alert(data.address);
                            // coords.push(data.address);
                           var Qry = "Insert into printer (macid) values ('"+data.address+"')";
                               // alert(Qry);
                                                window.plugins.DataBaseHelper.insert(Qry, function(result) 
                                                {   
                                                    // alldeviceinsert(macid);
                                                },
                                                function()
                                                {
                                                    console.warn("Error calling plugin");
                                                });
                            
                    },
                    function()
                    {
                     
                    });
        }
        // -----------------------------
        function SelectPrint()
        {
        	
        
            if(printstatus == 0 || printstatus == 1)
            {
                if(localStorage.po == "inventory")
                {
                    getLoadInfo();                            
                }
                else if(localStorage.po == 'sales')
                {
                	if(platform=='iPad')
                    {
                        PrintSales(printanother); 
                    }
                	else{
                    	if(printval==2 || printval==3){
                    		if(printstatus==0){
                    			PrintSales(printanother);
                    			
                    		}else{
                    			
                    			PrintSales(printanother);
                    			
                    		}
                    		
                    		
                    	}else{
                    		 navigator.notification.confirm(getLangTextdata("Do you want print duplicate copy?"),function(action){
                                  if(action == true){
                                	  
                                	  sessionStorage.setItem("invoicetwise",1);
                                	  PrintSales(printanother);   
                                  }
                                  else{
                                	  sessionStorage.setItem("invoicetwise",0);
                                	  PrintSales(printanother);   
                                  }
                                 
                              });
                    	}
                    	
                    }
                    
                }
                else if(localStorage.po == 'collection')
                {
                    getCollectionInfo();
                }else if(localStorage.po == 'advance')
                {
                	getAdvancePaymentInfo();
                }
                else
                    PrintDone(1);
            }
            else
                PrintDone(1);
            
            
        }
        
        function printAnotherCopy()
    	{
        	
        	if(printstatus==0)
        	{	
        		printanother=true;
        		navigator.notification.confirm(getLangTextdata("Do you want to print another copy?"),onSuccess);
            }else{
            	printanother=false;
            	if(printstatus!=1){
    	    		SaveTransactionData();
    	    		
    	    	}else{
    	    		
    	    		 if(localStorage.po == 'sales' || localStorage.po == 'collection'){
    	    			 
    	    			 updateDraftTransactions();
    	    		 }else{
    	    			 SaveTransactionData();
    	    		 
    	    		 }
    	    	
    	    	}
            }
    	      
    	}
    	        
    	function onSuccess(button){
    		if(button == 1)
    	    {
    			SelectPrint();
    			
    	    }else{
    	    	printanother=false;
    	    	
    	    	if(printstatus!=1){
    	    		SaveTransactionData();
    	    		
    	    	}else{
    	    		
    	    		 if(localStorage.po == 'sales' || localStorage.po == 'collection'){
    	    			 updateDraftTransactions();
    	    		 }else{
    	    			 SaveTransactionData();
    	    			 
    	    		 }
    	    		 
    	    	}
    	    	
    	    	
    	    }
    	        	
    	 }
        
       function SaveTransactionData(){
    	   	   
    	   
    	       if(localStorage.po == 'sales')
               {
    				// alert("test");
                   Updateinventoryvalue();
               }
               console.log("calledtime : " + Date());
               localStorage.setItem("ARDATA",'');
               localStorage.setItem("collectionMOP","");
               localStorage.setItem("ARAmount",0);
               sessionStorage.setItem("InvoiceNumber","");
               sessionStorage.setItem("OrderNumber","");
               localStorage.setItem("tmparamount",0);
               localStorage.removeItem("tmpargrid");
               localStorage.removeItem("DocNos");
               localStorage.removeItem("AdvanceInvoice");
               sessionStorage.removeItem("OrderToSalesTransKey");
               localStorage.removeItem("manualfree");
               localStorage.removeItem("isreturn");
              
               var rlink;
               if(localStorage.po == "inventory")
               {
               	  rlink = "../inventory/inventory.html";
               }	
               else{
               	  rlink ="../customer_opt/cust_opt.html";
               }
                
              // alert(sessionStorage.getItem('syncmode'));
               if(sessionStorage.getItem('syncmode') == 1)
               {
    				if(localStorage.po == "inventory")
    				{
    					
    					senddata('inv',rlink);
    				}else
    				{
    					senddata('sale',rlink);	
    				}
               }
               else
               {
            	   getLangText("Transaction Saved Successfully.");  
                   if(localStorage.po == "inventory")
                       window.location = rlink;
                   else
                       window.location = rlink;
               }
    		   
    		   
    	   
    	  
    	   
        }
    	function updateDraftTransactions(){
    		
    		 if(localStorage.po == 'sales')
             {
	    		 var Qry_Invoiceheader = "UPDATE invoiceheader set istemp='true' where routekey="+sessionStorage.getItem("RouteKey")+" and visitkey="+sessionStorage.getItem("VisitKey")+"";
	             
	             window.plugins.DataBaseHelper.insert(Qry_Invoiceheader, function(result) 
	             {   
	            	 
	             },
	             function()
	             {
	                 console.warn("Error calling plugin");
	             });	
	             
	             var Qry_Invoicedetail = "UPDATE invoicedetail set istemp='true' where routekey="+sessionStorage.getItem("RouteKey")+" and visitkey="+sessionStorage.getItem("VisitKey")+"";
	             
	             window.plugins.DataBaseHelper.insert(Qry_Invoicedetail, function(result) 
	             {   
	            	 
	             },
	             function()
	             {
	                 console.warn("Error calling plugin");
	             });
	             
	             var Qry_InvoiceRxddetail = "UPDATE invoicerxddetail set istemp='true' where routekey="+sessionStorage.getItem("RouteKey")+" and visitkey="+sessionStorage.getItem("VisitKey")+"";
	             
	             window.plugins.DataBaseHelper.insert(Qry_InvoiceRxddetail, function(result) 
	             {   
	            	 
	             },
	             function()
	             {
	                 console.warn("Error calling plugin");
	             });
	             
	             var Qry_promotiondetail = "UPDATE promotiondetail set istemp='true' where routekey="+sessionStorage.getItem("RouteKey")+" and visitkey="+sessionStorage.getItem("VisitKey")+"";
	             
	             window.plugins.DataBaseHelper.insert(Qry_promotiondetail, function(result) 
	             {   
	            	 
	             },
	             function()
	             {
	                 console.warn("Error calling plugin");
	             });
	             
	             var Qry_cashcheckdetail = "UPDATE cashcheckdetail set istemp='true' where routekey="+sessionStorage.getItem("RouteKey")+" and visitkey="+sessionStorage.getItem("VisitKey")+"";
	             
	             window.plugins.DataBaseHelper.insert(Qry_cashcheckdetail, function(result) 
	             {   
	            	 
	             },
	             function()
	             {
	                 console.warn("Error calling plugin");
	             });
	             
            
	             $("#lnkNext").attr("onclick","GetDocumentNumber();");                   
	             $("#cntlbl").removeClass('MenuGray');
	            
	            
	                 page = '../customer_opt/salesinvoice_option.html';
	            
	                           
	             $("#lnkExit").attr("href", page);
	             $("#Back_inner").attr("href", page);
             }else if(localStorage.po == 'collection'){
            	 var Qry_deleteArheadr = "Delete from ardetail where routekey="+sessionStorage.getItem("RouteKey")+" and visitkey="+sessionStorage.getItem("VisitKey")+"";
	             
	             window.plugins.DataBaseHelper.insert(Qry_deleteArheadr, function(result) 
	             {   
	            	 
	             },
	             function()
	             {
	                 console.warn("Error calling plugin");
	             });	
             
	             var Qry_deleteArDetail = "Delete from arheader where routekey="+sessionStorage.getItem("RouteKey")+" and visitkey="+sessionStorage.getItem("VisitKey")+"";
	             
	             window.plugins.DataBaseHelper.insert(Qry_deleteArDetail, function(result) 
	             {   
	            	 
	             },
	             function()
	             {
	                 console.warn("Error calling plugin");
	             });
	             
	             $("#lnkNext").attr("onclick","GetDocumentNumber();");                   
	             $("#cntlbl").removeClass('MenuGray');
	             page = '../customer_opt/salesinvoice_option.html';
	                          
	             $("#lnkExit").attr("href", page);
	             $("#Back_inner").attr("href", page);
             
             }

    	}
        function PrintDone(flag)
        {
            
        	if(printstatus!=1){
        		if(flag=='2')
    			{
    				// alert("Error In Printing Check Printer");
    				 $("#lnkNext").attr("onclick","SelectPrint()"); 
                                        $("#cntlbl").removeClass('MenuGray');
                                        $("#lnkExit").addClass('MenuGray');
                                        $("#lnkExit").attr("href","");
                                        
                                        
    				return false;
    			}
    			printAnotherCopy();
        	
        	}else{
        		 if(localStorage.po == 'sales' || localStorage.po == 'collection')
                 {
        			 updateDraftTransactions();
                 }else{
                	 if(flag=='2')
         			 {
         				// alert("Error In Printing Check Printer");
         				 $("#lnkNext").attr("onclick","SelectPrint()"); 
                                             $("#cntlbl").removeClass('MenuGray');
                                             $("#lnkExit").addClass('MenuGray');
                                             $("#lnkExit").attr("href","");
                                             
                                             
         				return false;
         			}
         			printAnotherCopy();
                 
                 }
        		 
        	}
			
			
            
        }
        
        function GetNewVisitKey()
        {            
            latitude =sessionStorage.getItem("latitude");
            longitude =sessionStorage.getItem("longitude");
            var newvisitkey = parseInt(sessionStorage.getItem("VisitKey")) + 1;
            sessionStorage.VisitKey = newvisitkey
            var qry = "insert into customeroperationscontrol ('visitkey','routekey','customercode','routecode','salesmancode','visitstartdate','visitstarttime','visitenddate','latitude','longitude','issync') values ('"+newvisitkey+"','"+sessionStorage.getItem("RouteKey")+"','"+sessionStorage.getItem("customerid")+"','"+sessionStorage.getItem("RouteCode")+"','"+sessionStorage.getItem("SalesmanCode")+"',date(),'"+sessionStorage.getItem("starttime")+"',date(),'"+latitude+"','"+longitude+"',0) ";
            console.log(qry);
            if(platform=='iPad')
            {
                Cordova.exec(function(result) {
                    GetDocumentNumber();
                },
             function(error) {
                    alert(error);
             },
                "PluginClass",
                "InsertUpdateMethod",
                [qry]);
            }
            else if(platform=='Android')
            {
                window.plugins.DataBaseHelper.insert(qry,function(result)
                {
                    GetDocumentNumber();
                },
                function()
                {
                    console.warn("Error calling plugin");
                });
            }
        }
        
        function updatebactkey()
        {
            var updateqry ="update inventorytransactiondetail set batchdetailkey=(select batchdetailkey from batchexpirydetail where routekey="+sessionStorage.getItem("RouteKey")+" and istemp='true' and transactiontypecode=inventorytransactiondetail.transactiontypecode and itemcode=inventorytransactiondetail.itemcode) where routekey="+sessionStorage.getItem("RouteKey")+" and istemp='true'";
            console.log(updateqry);
            if (platform == "iPad") {
                Cordova.exec(function(result) {
                              GetHHCDocumentNumber();
                              updatebatchdata();
                              },
                              function(error) {
                              navigator.notification.alert(error);
                              },
                              "PluginClass",
                              "InsertUpdateMethod",
                              [updateqry]);
            }
            else if (platform == "Android") {
                window.plugins.DataBaseHelper.insert(updateqry, function(result) {
                                                     GetHHCDocumentNumber();
                                                     updatebatchdata();
                                                     },
                                                     function() {
                                                     console.warn("Error calling plugin");
                                                     });
            }
        }
        function updatebatchsales()
        {
            var updateqry ="update invoicedetail set batchdetailkey=(select batchdetailkey from batchexpirydetail where routekey="+sessionStorage.getItem("RouteKey")+" and visitkey="+sessionStorage.getItem("VisitKey")+" and istemp='false' and itemcode=invoicedetail.itemcode) where routekey="+sessionStorage.getItem("RouteKey")+" and visitkey="+sessionStorage.getItem("VisitKey")+" and istemp='false'";
            console.log(updateqry);
            if (platform == "iPad") {
                Cordova.exec(function(result) {
                              
                              },
                              function(error) {
                              navigator.notification.alert(error);
                              },
                              "PluginClass",
                              "InsertUpdateMethod",
                              [updateqry]);
            }
            else if (platform == "Android") {
                window.plugins.DataBaseHelper.insert(updateqry, function(result) {
                                                    FetchPaidAmount();
                                                     },
                                                     function() {
                                                     console.warn("Error calling plugin");
                                                     });
            }
        }
        // End Saving Collection
    </script>

</body>
</html>
