<!--
 '  Created By   : Ankur Shah
 '  Created Date : 06/07/2012
 '  Description  : This page is used for upload data to server.    
 -->
<!DOCTYPE html>
<html>
    <head>
        <title>Upload Data</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
         <meta name="format-detection" content="telephone=no">   
            <link rel="stylesheet" href="../css/jquery.mobile-1.0.min.css" />
            <link rel="stylesheet" href="../css/style.css" />
            <link rel="stylesheet" href="../css/en.css" lang="en" />
            <link rel="stylesheet" media="only screen and (min-width: 320px) and (max-width: 600px)"
                href="../css/style_600.css">
                <link rel="stylesheet" media="only screen and (min-width: 601px) and (max-width: 700px)"
                    href="../css/style_700.css">
                    <link rel="stylesheet" media="only screen and (min-width: 700px) and (max-width: 800px)"
                        href="../css/style_800.css">
                        <link rel="stylesheet" media="only screen and (min-width: 1000px) and (max-width: 1200px)"
                            href="../css/style_1200.css">
                            <link rel="stylesheet" media="only screen and (min-width: 1200px) and (max-width: 1400px)"
                                href="../css/style_1400.css">
                                
                                <link href="../css/photoswipe.css" type="text/css" rel="stylesheet" />
                                
                                <script type="text/javascript" src="../js/klass.min.js"></script>
                                
                                <script type="text/javascript" src="../js/jquery.js"></script>
                                
                                <script type="text/javascript" src="../js/jquery.mobile-1.0.js"></script>
                                
                                <script type="text/javascript" src="../js/common.js"></script>
								<script type="text/javascript" src="../js/upload.js"></script>
                                
                                <script>
                                    if (navigator.userAgent.toLowerCase().match(/android/)) {
                                        document.write('<script charset="utf-8" src="../cordova-2.0.0.js"><\/script>');
                                        document.write('<script charset="utf-8" src="../directoryListing.js"><\/script>');
                                    } else if (navigator.userAgent.toLowerCase().match(/iphone/) || navigator.userAgent.toLowerCase().match(/ipad/)) {
                                        document.write('<script charset="utf-8" src="../cordova-1.5.0.js"><\/script>');
                                    }
                                    </script>
                                
                                <script src="../LangJS/jquery-lang.js" charset="utf-8" type="text/javascript"></script>
                                
                                <script src="../LangJS/langpack/AR.js" charset="utf-8" type="text/javascript" lang="en"></script>
                                
                                
								<script type="text/javascript" src="../js/code.photoswipe.jquery-3.0.5.min.js"></script>
                                
            <style>
                .chk{};
                .unchk{};
            </style>
    </head>
    <body>
        <div data-role="page" data-theme="d" id="divpage">
            <div>
                <img title="" alt="" src="../images/bg.png" id="background">
                    </div>
            <div data-role="header" data-position="inline" id="bgclheader">
                <a href="utilities.html" id="Back_inner" rel="external" lang="en">Back</a>
                <h1 lang="en">
                    Upload Data</h1>
                <a href="#" id="lang_inner">EN</a>
            </div>
            <div data-role="content" class="centerboxInvReq">
                <div class="boxContent Spacing">
                    <table border="0" cellpadding="4" cellspacing="4" width="100%">
                        <tr>
                            <td class="captionLabel" lang="en" style="width: 30%;">
                                Select Transaction
                            </td>    
                            <td style="width: 70%;">
                                <div style="width:60%;float:left">
                                    <select name="ddltransaction" id="ddltransaction" style="display: inline;" onchange="getTransactionList()">
                                        <option lang="0">Select</option>
                                        <option value="7">Inventory</option>
                                        <option value="1">Sales</option>
                                        <option value="2">Order</option>
                                        <option value="4">Advance Payment</option>
                                        <option value="3">Collection</option>                                       
                                        <option value="5">Merchandizing</option>
                                        <option value="6">Others</option>
                                        <option value="8">Images</option>
                                    </select>
                                </div>
                                <div style='float:right;display:none;' id='selectall'>
                            		<div style='float:left;padding:15px'>All</div>
                            		<div style='float:left'><img src="../images/check.png" id="chkall" onclick='SelectAll(this)'/></div>
                            	</div>
                            </td>                            
                        </tr>                        
                    </table>
                    <div class="tblBox tbltd" id="divgrid">
                        <table id="tblHeaderContent" cellpadding="0" cellspacing="0" border="0" width="100%"
                            class="tblHeader">
                            <tr>
                                <th style="width: 10%;"></th>
                                <th style="width: 20%;" class="leftAlign" lang="en">
                                    Customer Code
                                </th>
                                <th style="width: 20%;" class="leftAlign" lang="en">
                                    Invoice Number
                                </th>
                                <th style="width: 20%;" lang="en" class="leftAlign">
                                    Transaction Date 
                                </th>
                                <th style="width: 20%;" lang="en" class="leftAlign last">
                                    Amount
                                </th>
                            </tr>
                        </table>
                        <div id="contentWrapper" class="tblFixedHeight">
                            <table id="tblContent" cellpadding="0" cellspacing="0" border="0" width="100%">
                                <tr>
                                    <td style="width: 10%;">
                                    </td>
                                    <td style="width: 20%;">
                                    </td>
                                    <td style="width: 20%;">
                                    </td>
                                    <td style="width: 20%;">
                                    </td>
                                    <td style="width: 20%;">
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div> 
                    <!--<div class="textBar">
                        <table cellpadding="2" cellspacing="2" border="0" width="100%">
                            
                            <tr>
                                <td colspan=2 id="txtname" class="readonly_text" style="color:#A7A7A7;background-color:#EBF5FA;">
                                    
                                </td>
                            </tr>
                            </table>
                        </div>-->
                    <div class="tblBox" id="divimagebox" style="display:none;float:left;padding:10px;width:96%">                        
                        <div id="Gallery" style="float:left;overflow:auto;width:100%" class="tblFixedHeight">
                        	
                        </div>
                    </div>
                </div>
                <div class="leftbottomMenu">
                    <div class="menuPadding">
                        &nbsp;</div>
                    <a href="#" rel="external" style="text-decoration: none; font-weight: normal;" onclick="SendData()">
                    <div class="MenuPosition deleteCheckHeight">
                        <div class="MenuTextPos">
                            <img src="../images/upload-data.png" alt="Delete" /></div>
                        <div class="MenuTextPos MenuText" lang="en">
                            Upload</div>
                    </div>
                    </a>    
                    <div class="menuPadding">
                        &nbsp;</div>
                    <a href="utilities.html" rel="external" style="text-decoration: none; font-weight: normal;">
                        <div class="MenuPosition deleteCheckHeight MenuExit">
                            <div class="MenuTextPos">
                                <img src="../images/icn-exit.png" alt="Exit" /></div>
                            <div class="MenuTextPos MenuText" lang="en">
                                Exit</div>
                        </div>
                    </a>
                    <div class="menuPadding">
                        &nbsp;</div>
                </div>
            </div>
            <div data-role="footer" class="ui-bar">
                <div class="footer">
                    <div class="leftfooter">
                        09 November 2011</div>
                    <div class="rightfooter">
                        Mirnah Technology Systems</div>
                </div>
            </div>
            <div data-role="footer" style="bottom: 0; position: absolute;">
                <div data-role="navbar" data-iconpos="top" data-grid="f">
                    <ul>
                        <li style="margin-bottom:0 !important;"><a href="#" rel="external" id="day" data-icon="custom" lang="en" onclick="footerredict('../startofday/startofday.html')">Start of day</a></li>
                        <li style="margin-bottom:0 !important;"><a href="#" id="inve" rel="external" data-icon="custom" lang="en" onclick="footerredict('../inventory/inventory.html')">Inventory</a></li>
                        <li style="margin-bottom:0 !important;"><a href="#" rel="external" id="cust" data-icon="custom" lang="en" onclick="footerredict('../customer/customer_operation.html')">Customer opt</a></li>
                        <li style="margin-bottom:0 !important;"><a href="#" rel="external" id="sett" data-icon="custom" lang="en"  onclick="footerredict('../settlement/managesettlement.html')">Settlement</a></li>
                        <li style="margin-bottom:0 !important;"><a href="#" rel="external" id="expe" data-icon="custom" lang="en" onclick="footerredict('../settlement/expenseentry.html')">Expense Entry</a></li>
                        <li style="margin-bottom:0 !important;"><a href="#" rel="external" id="info" data-icon="custom" lang="en" onclick="footerredict('../information/information.html')">Information</a></li>
                        <li style="margin-bottom:0 !important; width:14.0%"><a href="#" rel="external" id="setup" data-icon="custom" lang="en" onclick="footerredict('../utilities/utilities.html')" class="ui-btn-active">Utilities</a></li>
                    </ul>
                </div>
            </div>
        </div>
        
        <script type="text/javascript" language="javascript">
            var data = null,index = 0;        
            var dataRoutekey = new Array();
            var dataTranskey = new Array();
            var dataVisitkey = new Array();
            var countRecord = 0;
            var imgarr = {};
            var imgdata = null;
            window.lang = new jquery_lang_js();
            var cntupload;
            var currfilename;
            var elm;
            var fileName;
            var idx;  
            var curridx = 0;          
            $("#tblContent").click(function() { });
              
            $(document).ready(function() {
                                
                              //Set current date in footer
                              $(".leftfooter").html(getCurrentDate());
                              
                              $('.ui-select .ui-btn-text').css({ 'text-align': 'left', 'color': '#999' });
                              
                              //Fetch current language and set that language.
                              var lan = sessionStorage.getItem("Language");
                              window.lang.run(lan);
                              
                                                    
                              //Table click event
                              $("#tblContent tr").live('click', function() {
                                                       $(this).toggleClass('clicked');
                                                       index = $(this).index();   
                                                       var custname = data[index - 1][7];
                                                       console.log(custname);
                                                       $('#txtname').val(custname);
                                                       if ($("#check_" + (index)).css('display') == 'block')
                                                       {
                                                            $("#check_" + (index)).css({ "display": "none" });
                                                      
                                                            var removeRouteKey = eval(data[index - 1][4]);
                                                            var removeTransKey = eval(data[index - 1][5]);
                                                       var removeVisitkey=eval(data[index - 1][6]);
                                                            
                                                             dataRoutekey.splice($.inArray(removeRouteKey,dataRoutekey),1);   
                                                             dataTranskey.splice($.inArray(removeTransKey,dataTranskey),1);                                                             
                                                         dataVisitkey.splice($.inArray(removeVisitkey,dataVisitkey),1);
                                                             countRecord -= 1;
                                                       }
                                                       else 
                                                       {
                                                            $("#check_" + (index)).css({ "display": "block" });                            
                                                       
                                                            dataRoutekey.push(eval(data[index - 1][4]));
                                                            dataTranskey.push(eval(data[index - 1][5]));
                                                       dataVisitkey.push(eval(data[index - 1][6]));
                                                            countRecord += 1;
                                                       
                                                       }    
                                                       
                                                       });
                              
                             
                              
                              //Check for current language and set css for that
                              if (sessionStorage.getItem("Language") != "en") {
                              window.lang.change('UploadData' + lan, lan);
                              window.lang.change('Footer' + lan, lan);
                              
                              if (lan == "AR") {
                              //Set html right alignment for arbic language
                              $(".centerboxInvReq").attr("dir", "rtl");
                              
                              //Set header align               
                              $('#Back_inner').removeClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                              $('#Back_inner').addClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                              $('#lang_inner').removeClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                              $('#lang_inner').addClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                              }
                              }
                              else {
                              //Change current language to english
                              window.lang.change('en', 'en');
                              
                              //Set html left alignment for english language
                              $(".centerboxInvReq").attr("dir", "ltr");
                              
                              //Set header align               
                              $('#Back_inner').removeClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                              $('#Back_inner').addClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                              $('#lang_inner').removeClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                              $('#lang_inner').addClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                              }
                                                         
                            
                              });
                              
            function getImages()
            {                
                var Qry = "SELECT imagename,imagepath FROM customerimages WHERE routecode=" + sessionStorage.getItem("RouteCode");
                console.log(Qry);
                if(platform == "iPad")
                {
                    Cordova.exec(function(result) {
                        BindImages(result);
                    },
                    function(error) {
                        navigator.notification.alert("Error in binding Images : " + error);
                    },
                    "PluginClass",
                    "GetdataMethod",
                    [Qry]);
                }
                else if(platform == "Android")
                {
                    window.plugins.DataBaseHelper.select(Qry,function(result)
                    {
                    	if(result.array != undefined)
                    	{
                        	var array = $.map(result.array, function(item, index) {
                            	return [[item.imagename,item.imagepath]];
                        	});
                        	BindImages(array);
                        }
                        else
                        	$("#Gallery").html("");
                    },
                    function()
                    {
                        console.warn("Error calling plugin");
                    });
                }
            }
            
            function BindImages(result)
            {                
                try
                {      
	                imgdata = result;
	                var r,cnt = 0;
	                var c1;  
	                $("#Gallery").html("");
	                var c = "";
	                for (i = 0; i < result.length; i++) 
	                {                  
	                    console.log("result.length : " + result.length);
						c = "<div style='padding:5px;margin-left:15px;float:left;'>";
						c += "<a href='#' rel='external'><img src='" + result[i][1] + "' id='img" + (i + 1) + "' width='100' height='100' /></a>";
						c += "<div style='text-align:center;padding:5px'><img src='../images/check.png' class='unchk' id = 'chk_" + (i + 1)  +"'  onclick='SelectImage(this)' idx='" + i + "'/></div>";
						c += "</div>";
						$("#Gallery").append(c);					               
	                }                        
                	$(document).ready(function(){
                		var elm = $("#Gallery a");
                		console.log("A length : " + elm.length);
                		console.log($("#Gallery").html()); 												
						//var myPhotoSwipe = $("#Gallery a").photoSwipe({ enableMouseWheel: false , enableKeyboard: false });
					});
					
					$("#divimagebox").show();
                    $("#selectall").show();
                }              
                catch(ex)
                {
                    alert(ex);
                }
            }
            
            function ClearTable(TBL) {
                $("#" + TBL + " tr:gt(0)").remove();
            }
            
            function SelectImage(selimg)
            {      
                if($(selimg).hasClass('unchk'))
                {
                    $(selimg).removeClass('unchk').addClass('chk');
                    $(selimg).attr("src","../images/check-box.png");
                }
                else
                {
                    $(selimg).removeClass('chk').addClass('unchk');
                    $(selimg).attr("src","../images/check.png");
                }
            }
            
            function SelectAll(obj)
            {            	
            	if($(obj).attr("src") == '../images/check.png')
            	{
            		$(obj).attr("src","../images/check-box.png");
            		$(".unchk").attr("src","../images/check-box.png");
            		$(".unchk").removeClass('unchk').addClass('chk');
            	}
            	else
            	{
            		$(obj).attr("src","../images/check.png");
            		$(".chk").attr("src","../images/check.png");
            		$(".chk").removeClass('chk').addClass('unchk');
            	}
            }
            
            function getTransactionList()
            {   
                
                platform= sessionStorage.getItem("platform");
                
                var selectquery = '';
                $("#divgrid").show();
                $("#divimagebox").hide();
                $("#selectall").hide();
                $("#chkall").attr("src","../images/check.png");
                if($("#ddltransaction").val() == 1) //get invoice header transaction
                {
                    selectquery = "select invoiceheader.customercode,invoicenumber,strftime('%d-%m-%Y',transactiondate) as transactiondate,totalinvoiceamount,routekey,transactionkey,visitkey,customername from invoiceheader join customermaster on customermaster.customercode=invoiceheader.customercode where invoiceheader.issync=0 and invoiceheader.istemp='false'";                   
               
                }
                else if($("#ddltransaction").val() == 2) //get sales order header transaction
                {    
                   selectquery = "select salesorderheader.customercode,invoicenumber,strftime('%d-%m-%Y',transactiondate) as transactiondate,totalinvoiceamount,routekey,transactionkey,visitkey,customername from salesorderheader join customermaster on customermaster.customercode=salesorderheader.customercode where salesorderheader.issync=0 and salesorderheader.istemp='false'";
                }
                else if($("#ddltransaction").val() == 3) //get collection transaction 
                {
                    selectquery = "select arheader.customercode,invoicenumber,strftime('%d-%m-%Y',transactiondate) as transactiondate,totalinvoiceamount,routekey,transactionkey,visitkey,customername from arheader join customermaster on customermaster.customercode=arheader.customercode where arheader.issync=0 and advancepaymentflag = 0";
                }
                else if($("#ddltransaction").val() == 4) //get payment transaction 
                {
                    selectquery = "select arheader.customercode,invoicenumber,strftime('%d-%m-%Y',transactiondate) as transactiondate,totalinvoiceamount,routekey,transactionkey,visitkey,customername from arheader join customermaster on customermaster.customercode=arheader.customercode where arheader.issync=0 and advancepaymentflag = 1";
                }
                else if($("#ddltransaction").val() == 5) //get survey,pos
                {
                    selectquery = "select distinct customeroperationscontrol.customercode as customercode,0 as invoicenumber,customeroperationscontrol.visitstartdate as transactiondate,0 as totalinvoiceamount,customeroperationscontrol.routekey as routekey,0 as transactionkey,customeroperationscontrol.visitkey as visitkey,customername from customeroperationscontrol join surveyauditdetail on surveyauditdetail.routekey = customeroperationscontrol.routekey and surveyauditdetail.visitkey = customeroperationscontrol.visitkey join customermaster on customermaster.customercode=customeroperationscontrol.customercode where customeroperationscontrol.issync=0                    union select distinct customeroperationscontrol.customercode,0 as invoicenumber,customeroperationscontrol.visitstartdate as transactiondate,0 as totalinvoiceamount,customeroperationscontrol.routekey,0 as transactionkey,customeroperationscontrol.visitkey,customername from customeroperationscontrol join posequipmentchangedetail on posequipmentchangedetail.routekey = customeroperationscontrol.routekey and posequipmentchangedetail.visitkey = customeroperationscontrol.visitkey join customermaster on customermaster.customercode=customeroperationscontrol.customercode where customeroperationscontrol.issync=0";
                }
                else if($("#ddltransaction").val() == 6) //get others
                {
                    selectquery = "select customeroperationscontrol.customercode,0 as invoicenumber,visitstartdate as transactiondate,0 as totalinvoiceamount,routekey,customeroperationscontrol.customercode as transactionkey,visitkey,customername from customeroperationscontrol join customermaster on customermaster.customercode=customeroperationscontrol.customercode where customeroperationscontrol.issync=0";
                }
                else if($("#ddltransaction").val() == 7) //get inventory
                {
                    selectquery = "select 0 as customercode,documentnumber as invoicenumber,strftime('%d-%m-%Y',transactiondate) as transactiondate,0 as totalinvoiceamount,routekey,inventorykey as transactionkey,detailkey as visitkey,0 as customername  from inventorytransactionheader where issync=0";
                }
                else if($("#ddltransaction").val() == 8)
                {
                    $("#divgrid").hide();                    
                    getImages();
                }
            	console.log(selectquery);
            	if(platform=='iPad')
           		{
                  
                    Cordova.exec(function(result) {                              
                                    ClearTable();
                                    BindData(result);
                                  },
                                  function(error) {
                                    navigator.notification.alert("Error in binding transaction list : " + error);
                                  },
                                  "PluginClass", 
                                  "GetdataMethod", 
                                  [selectquery]);         
                }
            	else if(platform=='Android')
            	{          
            		window.plugins.DataBaseHelper.select(selectquery,function(result)
                                                         {
                                                            ClearTable();
                                                         var array = $.map(result.array, function(item, index) {
                                                                           
                                                                           return [[item.customercode, item.invoicenumber,item.transactiondate,item.totalinvoiceamount,item.routekey,item.transactionkey,item.visitkey,item.customername]];
                                                                           });
                                                         
                                                         data = array;
                                                            BindData(data);
                                                         },
                                                         function()
                                                         {
                                                            console.warn("Error calling plugin");
                                                         });
            	}
            }
            
            //Bind data dynamically
            function BindData(result) {
               
                var CellCount = $("#tblHeaderContent tr:eq(0) th").length;
                
                data =  result;
                
                for (i = 0; i < data.length; i++) 
                {
                    var r = "<tr class='contentFont'>";
                    
                    for (j = 1; j <= CellCount; j++) {  
                        var c = '';
                        var temp = (j == 2) ? 'class = leftAlign' : "class = 'leftAlign last'";
                        if(j == 1)
                        {
                            c = "<td>" + "<img src='../images/check_1.png' height='25' style='display:none;' id = check_"+ (i + 1)  +" />" + "</td>";                           
                        }
                        else
                        {   
                            if(j==2 || j==3)
                                data[i][j - 2] =parseInt(data[i][j - 2]);
                            c = "<td " + temp + ">" + data[i][j - 2] + "</td>"; 
                        }
                        r += c;
                    }
                    r += "</tr>";
                    
                    $('#tblContent tbody').append(r);                    
                    
                }
                
                //Select first row of table when screen load
                //$("#tblContent tr:eq(1)").trigger('click');
                
                //Set background for odd and even row.
                $("#tblContent tr:odd").addClass('oddRow');
                $("#tblContent tr:even").addClass('evenRow');
                
            }
            
            function ClearTable() {
                $("#tblContent tr:gt(0)").remove();
            }
            
            function SendData()
            {             
                if(countRecord > 0)
                {
                   
                    if(platform=='iPad')
                    {
                        
                        var selectquery="select previousdayuploadflag from setup where setupid=1";
                        var qry="select routestartdate from starendday where routekey="+sessionStorage.getItem("RouteKey");
                        Cordova.exec(function(result) {                              
                                      if(result[0][0] == 0)
                                      {
                                      Cordova.exec(function(result) {                              
                                                    if(eval(result[0][0]) < getTabletDate())
                                                    {
                                                    navigator.notification.alert("You are not allow to previous day data upload");
                                                    return false;
                                                    }
                                                    else
                                                    {
                                                    uploaddatas();
                                                    }
                                                    },
                                                    function(error) {
                                                    navigator.notification.alert("Error in binding transaction list : " + error);
                                                    },
                                                    "PluginClass", 
                                                    "GetdataMethod", 
                                                    [qry]); 
                                      }
                                      else
                                      {
                                      uploaddatas();
                                      }
                                      },
                                      function(error) {
                                      navigator.notification.alert("Error in binding transaction list : " + error);
                                      },
                                      "PluginClass", 
                                      "GetdataMethod", 
                                      [selectquery]);         
                    }
                    else if(platform=='Android')
                    {          
                    	var selectquery="select previousdayuploadflag from setup where setupid=1";
                        var qry="select routestartdate from starendday where routekey="+sessionStorage.getItem("RouteKey");
                        window.plugins.DataBaseHelper.select(selectquery,function(result)
                                                             {
                                                             if(result.array[0].previousdayuploadflag == 0)
                                                             {
                                                             window.plugins.DataBaseHelper.select(qry,function(result)
                                                                                                  {
                                                                                                  if(eval(result.array[0].routestartdate) < getTabletDate())
                                                                                                  {
                                                                                                  navigator.notification.alert("You are not allow to previous day data upload");
                                                                                                  return false;
                                                                                                  }
                                                                                                  else
                                                                                                  {
                                                                                                  uploaddatas();
                                                                                                  }
                                                                                                  },
                                                                                                  function()
                                                                                                  {
                                                                                                  console.warn("Error calling plugin");
                                                                                                  });
                                                             }
                                                             else
                                                             {
                                                             uploaddatas();
                                                             }
                                                             },
                                                             function()
                                                             {
                                                             console.warn("Error calling plugin");
                                                             });
                    }  
                    
                    
                }
                else 
                {
                    if($("#ddltransaction").val() == 8)
                    {
                        getImagesToUpload();
                    }
                    else
                        navigator.notification.alert("Please Select A Transaction.");
                }
                
                    
                                
            }
            function uploaddatas()
            {
                dataRoutekey = $.unique(dataRoutekey);
                
                var dataRouteString = dataRoutekey.toString();
                
                var dataTransString = dataTranskey.toString();
                var datavisitString = dataVisitkey.toString();
                console.log(datavisitString);
                if($("#ddltransaction").val() == 1) //get invoice header transaction
                {
				
				    alert(dataTransString);
					alert("visit :-"+datavisitString);
					
						var transkey = dataTransString.split(",");
						var visitkey= datavisitString.split(",");
					for (var i=0; i<dataTransString.length; i++)
					{
						sendmanualdata(dataRouteString,transkey[i],visitkey[i],'sale');
					}
                    //Invocie header data
                   // getSendData(dataRouteString,dataTransString,"","invoiceheader",false);
                    
                    //Invocie detail data
                   // getSendData(dataRouteString,dataTransString,"","invoicedetail",false);
                    
                    //Invoice rxd detail data
                    //getSendData(dataRouteString,dataTransString,"","invoicerxddetail",false);
                    //inventorytransactiondetail
                    //getSendData(dataRouteString,dataTransString,"","inventorysummarydetail",false);
                    //Invoice cash check data
                    //getSendData(dataRouteString,datavisitString,"","cashcheckdetail",false);
                    //customer invoice data
                    //getSendData(dataRouteString,dataTransString,"","customerinvoice",false);
                    //promotiondetail data
                   // getSendData(dataRouteString,datavisitString,"","promotiondetail",false);
                    
                    //batchexpirydetail
                   // getSendData(dataRouteString,datavisitString,"","batchexpirydetail",false);
                    //signature data
                   // getSendData(dataRouteString,datavisitString,"","sigcapturedata",false);
                    
                    //customerinventorydetail
                   // getSendData(dataRouteString,datavisitString,"","customerinventorydetail",false);
                    
                    //customerinventorydetail
                  //  getSendData(dataRouteString,datavisitString,"","customeroperationscontrol",false);
                    
                    //routesequencecustomerstatus
                   // getSendData(dataRouteString,"","","routesequencecustomerstatus",false);
                    
                    //routemaster
                   // getSendData("","","","routemaster",false);
                    
                    //routegoal
                    //getSendData("","","","routegoal",false);
                    
                    //customermaster data
                   // getSendData("","","","customermaster",true);
                    
                }
                else if($("#ddltransaction").val() == 2)
                {            
					
                    //Sales order detail data
                    getSendData(dataRouteString,dataTransString,"","salesorderdetail",false);
                    
                    //Sales order header data
                    getSendData(dataRouteString,dataTransString,"","salesorderheader",false);
                    
                    //promotiondetail data
                    getSendData(dataRouteString,datavisitString,"","promotiondetail",false);
                    
                    //signature data
                    getSendData(dataRouteString,datavisitString,"","sigcapturedata",false);
                    
                     //customerinventorydetail
                    getSendData(dataRouteString,datavisitString,"","customeroperationscontrol",false);
                    
                    //routesequencecustomerstatus
                    getSendData(dataRouteString,"","","routesequencecustomerstatus",false);
                    
                    //customermaster data
                    getSendData("","","","customermaster",true);
                    
                }
                else if($("#ddltransaction").val() == 3)
                {
					sendmanualdata(dataRouteString,dataTransString,datavisitString,1);
                    //AR header data
                    //getSendData("",dataTransString,"","arheader",false);
                    
                    //AR detail data
                    //getSendData(dataRouteString,dataTransString,"","ardetail",false);
                    //Invoice cash check data
                    //getSendData(dataRouteString,datavisitString,"","cashcheckdetail",false);
                    //customerinventorydetail
                   // getSendData(dataRouteString,datavisitString,"","customeroperationscontrol",false);
                    
                    //routesequencecustomerstatus
                   // getSendData(dataRouteString,"","","routesequencecustomerstatus",true);
                }
                else if($("#ddltransaction").val() == 4)
                {
					sendmanualdata(dataRouteString,dataTransString,datavisitString,1);
                    //AR header data
                   // getSendData("",dataTransString,"","arheader",false);
                    
                    //AR detail data
                   // getSendData(dataRouteString,dataTransString,"","ardetail",false);
                    
                    //customer invoice data
                    //getSendData(dataRouteString,dataTransString,"","customerinvoice",false);
                    
                    //Invoice cash check data
                   // getSendData(dataRouteString,datavisitString,"","cashcheckdetail",false);
                    
                    //customerinventorydetail
                   // getSendData(dataRouteString,datavisitString,"","customeroperationscontrol",false);
                    
                    //routesequencecustomerstatus
                    //getSendData(dataRouteString,"","","routesequencecustomerstatus",true);
                }   
                else if($("#ddltransaction").val() == 5)
                {
                    //survetauditdetail
                    getSendData(dataRouteString,datavisitString,"","surveyauditdetail",false);
                    
                    //customerinventorydetail
                    getSendData(dataRouteString,datavisitString,"","customeroperationscontrol",false);
                    //pos data
                    getSendData(dataRouteString,datavisitString,"","posequipmentchangedetail",false);
                    
                    //pos data
                    getSendData(dataRouteString,dataTransString,"","posmaster",false);
                    
                    //routesequencecustomerstatus
                    getSendData(dataRouteString,"","","routesequencecustomerstatus",true);
                }
                else if($("#ddltransaction").val() == 6)
                {
                    //customerinventorydetail
                    getSendData(dataRouteString,dataTransString,"","nosalesheader",false);
                    //customerinventorydetail
                    getSendData(dataRouteString,dataTransString,"","nonservicedcustomer",false);
                    //customerinventorydetail
                    getSendData(dataRouteString,datavisitString,"","customeroperationscontrol",false);
                    
                    //routesequencecustomerstatus
                    getSendData(dataRouteString,"","","routesequencecustomerstatus",true);
                    
                } 
                else if($("#ddltransaction").val() == 7)
                {
                    //inventorytransaction header
                    getSendData(dataRouteString,datavisitString,"","inventorytransactionheader",false);
                    
                    //inventorytransactiondetail
                    getSendData(dataRouteString,datavisitString,"","inventorytransactiondetail",false);
                    
                    //inventorytransactiondetail
                    getSendData(dataRouteString,dataTransString,"","inventorysummarydetail",false);
		    
		      //routemaster
                    getSendData("","","","routemaster",false);
		    
                     //batchexpirydetail
                    getSendData(dataRouteString,0,"","batchexpirydetail",true);
                   
                }
            }            
            
            function getImagesToUpload()
            {            	
                try
                {
                	if(imgdata != null && imgdata.length > 0)
                	{
		                elm = $(".chk");
		                curridx = 0;
		                cntupload = 0;                            
		                cntupload = elm.length-1;
		                if(elm.length > 0)
		                {   
		                    CallImageUpload();
		                }
		                else
		                    navigator.notification.alert("Please Select Image.");
	                }
	                else
	                	navigator.notification.alert("No Images To Upload.");
                }
                catch(ex)
                {
                    alert(ex);
                }
            }
            
            function CallImageUpload()
            {
            	idx = $(elm[curridx]).attr("idx");
                fileName = imgdata[idx][0];
                filePath = imgdata[idx][1];
                filePath2=filePath;
                UploadImages(fileName,filePath);
            }
			
			function refreshTable()
            {
             data = null;
             index = 0;        
            dataRoutekey = new Array();
             dataTranskey = new Array();
             dataVisitkey = new Array();
             countRecord = 0;
             getTransactionList();
            }
            
            function gotFS1(fileSystem) {
    
   
    fileSystem.root.getFile(filePath2, null, gotFileEntry, fail);
    
}
function fail(evt) {
    console.log(evt.target.error.code);
}
function gotFileEntry(fileEntry) {
    fileEntry.file(gotFile, fail);
}

function gotFile(file){
    readDataUrl(file);
    
}

function readDataUrl(file) {
    var reader = new FileReader();
    reader.onloadend = function(evt) {
        console.log("Read as data URL");
        var imagedata = evt.target.result;
        console.log(imagedata);
        $.ajax({
                                                  type: "post",
                                                  url: "http://23.21.226.54/php/sfaweb/sfa_client/api/image/upload",
                                                  data: {myfile:imagedata},       
                                                  crossDomain: true,
						  cache: false,
                    timeout: 10000,
                                                  success: function(data) {  
                                                     console.log("data"+data);
                                                  }
                                                  });
    };
    reader.readAsDataURL(file);
}
            function UploadImages(fileName,filePath)
            {
                
                //filePath = "file://localhost"+filePath;
                console.log("filepath : " + filePath);
                currfilename = fileName;
                 var options = new FileUploadOptions();
            options.fileKey="file";
            options.fileName=fileName;
            options.mimeType="image/jpeg";

            var params = new Object();
            params.value1 = "test";
            params.value2 = "param";

         //   options.params = params;
options.chunkedMode=false;
            var ft = new FileTransfer();
           // ft.upload(filePath, "http://23.21.226.54/php/sfaweb/sfa_client/api/image/upload", win, fail, options);
         //ft.upload(filePath, "http://82.178.28.172:8085/sfa/smb/api/image/upload", win, fail, options);
          //ft.upload(filePath, "http://82.178.28.172:8085/sfa/sfa_test/api/image/upload", win, fail, options);
          ft.upload(filePath, "http://82.178.28.172:8086/sfa/sfa_uae/api/image/upload", win, fail, options);
          //ft.upload(filePath, "http://82.178.28.172:8086/sfa/sfa_ksa/api/image/upload", win, fail, options);
        //ft.upload(filePath, "http://82.178.28.172:8086/sfa/sfa_test/api/image/upload", win, fail, options);
          // ft.upload(filePath, "http://82.178.28.172:8086/sfa/uae_pilot/api/image/upload", win, fail, options);

               
            }
            function onFail(message) {
  alert('Failed because: ' + message);
}
            function win(r) {
            	console.log("Code = " + r.responseCode);
                console.log("Response = " + r.response);
                console.log("Sent = " + r.bytesSent);
            	var Qry = "UPDATE customerimages SET issync= 1 WHERE imagename = '" + currfilename + "'";
            	if(platform == "iPad")
            	{
            		Cordova.exec(function(result) {
            			UpdateImageSuccess();
                    },
                    function(error) {
                        navigator.notification.alert(error);
                    },
                    "PluginClass",
                    "InsertUpdateMethod",
                    [Qry]);
            	}
            	else if(platform == "Android")
            	{
            		window.plugins.DataBaseHelper.insert(Qry, function(result) {
                    	UpdateImageSuccess();
                    },
                    function() {
                        console.warn("Error calling plugin");
                    });
            	}
                
            }
            
            var tblcustomerimage = {};
            function UpdateImageSuccess()
            {
            	
                if(cntupload == 0)
                {
                    /*navigator.notification.alert("Images Uploaded Successfully.");
                    DeleteImages();*/
                    var qry = "SELECT imagename,customercode,imageno,imagepath,routecode,routekey,transactiondate,transactiontime,visitkey,issync FROM customerimages WHERE issync = 1";
                    if(platform == "iPad")
                    {                    	
                    	Cordova.exec(function(result) {
                    		if(result != '')
                    			tblcustomerimage = result;
                    		UploadImageData();
	                    },
	                    function(error) {
	                        navigator.notification.alert(error);
	                    },
	                    "PluginClass",
	                    "GetfielddataMethod",
	                    [qry]);
                    }
                    else if(platform == "Android")
                    {
                    	window.plugins.DataBaseHelper.select(qry, function(result) {
							if (!$.isEmptyObject(result)) {
				                for (i = 0; i < result.array.length; i++) {
				                    tblcustomerimage[i] = result.array[i];
				                }
				            }
				            tblcustomerimage = JSON.stringify(tblcustomerimage);    
				            console.log("customerimage : " + tblcustomerimage);
				            UploadImageData();                		
	                    },
	                    function() {
	                        console.warn("Error calling plugin");
	                    });
                    }
                }
                else
                {
                    if(curridx < elm.length - 1)
                    {
                    	cntupload = cntupload - 1;
                    	curridx = curridx + 1;
                    	CallImageUpload();
                    }
                }
            }
            
            function UploadImageData()
            {
			//url: wsurl + "sync/senddata",
            	try{
            	$.ajax({
			        type: "post",
			        url: wsurl + "sync/senddata",
			        data : {customerimages : tblcustomerimage},
				cache: false,
                    timeout: 10000,
			        success : function(data){			        	
				        navigator.notification.alert("Images Uploaded Successfully.");
	                    DeleteImages();
			        },
			        error: function(qXHR, textStatus, errorThrown) {
         			   alert("failure: " + qXHR.status + ":" + textStatus + errorThrown);
        			}
        		});
        		}
        		catch(ex)
        		{
        			alert(ex);
        		}
            }

            function fail(error) {
                alert("An error has occurred: Code = " = error.code);
                console.log("upload error source " + error.source);
                console.log("upload error target " + error.target);
            }   
            
            function DeleteImages()
            {
                try
                {
                var elm = $(".chk");                
                var filePath = "";
                var idx;                
                if(elm.length > 0)
                {
                    /*for(i=0;i<elm.length;i++)
                    {
                        idx = $(elm[i]).attr("idx");
                        fileName = imgdata[idx][0];                        
                        DeleteImageByName(fileName);
                    }*/
                    DeleteImageByName(elm,0)
                }
                else
                    alert("Please Select Image.");
                }
                catch(ex)
                {
                    alert(ex);
                }
            }
            
            function DeleteImageByName(elm,i)
            {
                var idx = $(elm[i]).attr("idx");
                var fileName = imgdata[idx][0]; 
                try
                {
                var Qry = "DELETE FROM customerimages WHERE imagename='" + fileName + "'";                
                console.log(Qry);
                if (platform == "iPad") 
                {
                    Cordova.exec(function(result) {
                        if(i+1 < elm.length)
                            DeleteImageByName(elm,i+1);
                            
                        console.log(i + " : " + (elm.length - 1));
                        if(i == (elm.length - 1))
                        {                            
                            getImages();
                        }
                    },
                    function(error) {
                        navigator.notification.alert(error);
                    },
                    "PluginClass",
                    "InsertUpdateMethod",
                    [Qry]);
                }
                else if (platform == "Android") 
                {
                    window.plugins.DataBaseHelper.insert(Qry, function(result) {
                    	if(i+1 < elm.length)
                            DeleteImageByName(elm,i+1);
                            
                        console.log(i + " : " + (elm.length - 1));
                        if(i == (elm.length - 1))
                        {                            
                            getImages();
                        }
                    },
                    function() {
                        console.warn("Error calling plugin");
                    });
                }
                }
                catch(ex)
                {
                    alert(ex);
                }
            }
            </script>
        
    </body>
</html>
