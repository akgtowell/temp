<!--
 '  Created By   : Ankur Shah
 '  Created Date : 31/1/2012
 '  Description  : This page is used for add check task.    
-->
<!DOCTYPE html>
<html>
<head>
    <title>Add Cheques</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0;maximum-scale=1.0;user-scalable=0; target-densitydpi=device-dpi">

    <meta name="format-detection" content="telephone=no">
    <link rel="stylesheet" href="../css/jquery.mobile-1.0.min.css" />
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="../css/en.css" lang="en" />
     <link type="text/css" href="../css/jquery.mobile.datebox.min.css" rel="stylesheet" />
    <link rel="stylesheet" media="only screen and (min-width: 320px) and (max-width: 600px)"
        href="../css/style_600.css">
    <link rel="stylesheet" media="only screen and (min-width: 601px) and (max-width: 700px)"
        href="../css/style_700.css">
    <link rel="stylesheet" media="only screen and (min-width: 700px) and (max-width: 800px)"
        href="../css/style_800.css">
    <link rel="stylesheet" media="only screen and (min-width: 1000px) and (max-width: 1200px)"
        href="../css/style_1200.css">
    <link rel="stylesheet" media="only screen and (min-width: 1200px) and (max-width: 1500px)"
        href="../css/style_1400.css">

    <script type="text/javascript" src="../js/jquery.js"></script>

    <script type="text/javascript" src="../js/jquery.mobile-1.0.js"></script>

    <script type="text/javascript" src="../js/common.js"></script>

    <script type="text/javascript" src="../js/jquery.validate.js"></script>

    <script src="../LangJS/jquery-lang.js" charset="utf-8" type="text/javascript"></script>

    <script src="../LangJS/langpack/AR.js" charset="utf-8" type="text/javascript" lang="en"></script>

    <link type="text/css" rel="stylesheet" href="../css/jquery.alerts.css">

    <script type="text/javascript" src="../js/jquery.alerts.js"></script>
    <script type="text/javascript" src="../js/jquery.mobile.datebox.min.js"></script>
<script>
        if (navigator.userAgent.toLowerCase().match(/android/)) {
            document.write('<script charset="utf-8" src="../cordova-2.0.0.js"><\/script>');
            document.write('<script charset="utf-8" src="../directoryListing.js"><\/script>');
        } else if (navigator.userAgent.toLowerCase().match(/iphone/) || navigator.userAgent.toLowerCase().match(/ipad/)) {
            document.write('<script charset="utf-8" src="../cordova-1.5.0.js"><\/script>');
        }
    </script>
</head>
<body>
    <div data-role="page" data-theme="d">
        <div>
            <img title="" alt="" src="../images/bg.png" id="background">
        </div>
        <div data-role="header" data-position="inline" id="bgclheader">
            <a href="managechecks.html" id="Back_inner" rel="external" lang="en">Back</a> <div class="wrapper"><div class="card_content"><div><img title="" alt="" data-pushbar-target="left"  src="../images/icons8-menu-50.png" id="setting"></div></div></div> 
            <h1 lang="en">
                Add Cheques</h1>
            <a href="#" id="lang_inner">EN</a>
        </div>
        <div data-role="content" class="centerboxInvReq">
            <div class="boxContent Spacing">
                 <div style="width: 95%;padding:0px;margin:0px">
                    <table cellpadding="0" cellspacing="0" border="0">
                        <tr>
                            <td lang="en">
                                Customer
                            </td>
                            <td style="width:100%;padding:0px;margin:0px">
                                <select id="ddlCustomer" style="display: inline;padding:0px;margin:0px">                                    
                                </select>
                            </td>
                        </tr>
                    </table>
                </div>
                <!--<div class="tblBox tbltd" style="padding-top:0px:margin-top:0px">          
                    <table id="tblHeaderContent" cellpadding="0" cellspacing="0" width="100%" class="tblHeader">
                        <tr>
                            <th style="width: 33%;" class="leftAlign" lang="en">
                                Invoice#
                            </th>
                            <th style="width: 33%;" class="leftAlign" lang="en">
                                Total Amount
                            </th>
                            <th style="width: 33%;" lang="en" class="last">
                                Balance
                            </th>                            
                        </tr>
                    </table>           
                    <div class="route_table_height pricelist">
                        <table id="tblContent" cellpadding="0" cellspacing="0" border="0" width="100%">                       
                            <tr>
                                <td style="width: 33%;">                                
                                </td>
                                <td style="width: 33%;">                                
                                </td>
                                <td style="width: 33%;" class="last">
                                </td>                                
                            </tr>
                        </table>
                    </div>
                </div>-->
                <table border="0" cellpadding="4" cellspacing="4" width="100%" data-role="none">
                    <tr>
                        <td class="captionLabel" lang="en" style="width: 50%">
                            Cheque Number
                        </td>
                        <td class="captionLabel" lang="en" style="width: 50%">
                            Amount
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <!--<input type="text" pattern="[0-9]*" id="txtCheque" name="txtCheque" class="textWidth textFont required"
                                value="" />-->
                                <input type="number" id="txtCheque" name="txtCheque" class="textWidth textFont required"
                                value="" />
                        </td>
                        <td>
                            <input id="txtAmount" name="txtAmount" type="tel" class="textWidth textFont required"
                                value="" />
                        </td>
                    </tr>
                     <tr>
                        <td class="captionLabel" lang="en" style="width: 50%">
                            Bank Name
                        </td>
                        <td class="captionLabel" lang="en" style="width: 50%">
                            Cheque Date
                        </td>
                    </tr>
                    <tr>
                        <td>
                             <div style="width: 97%;padding:0px;margin:0px">
                                <select name="select-choice-1" id="ddlBank" style="display: inline;padding:0px;margin:0px">                                    
                                </select>
                            </div>
                        </td>
                        <td>
                            <input id="txtDate" name="dpDate" type="date" data-role="datebox" value=""
                                data-options='{"mode": "flipbox","dateFormat": "dd-MM-YYYY"}' readonly="readonly" />
                        </td>
                    </tr>                    
                </table>
                </form>
            </div>
            <div class="leftbottomMenu">
                <div class="menuPadding">
                    &nbsp;</div>
                <a id="" href="#" class="enableText" rel="external" onclick="InsertCheque()">
                    <div class="MenuPosition" style="height:90px">
                        <div class="MenuTextPos">
                            <img  class="bottomicon"  src="../images/save.png" id="imgsave" alt="Ok" /></div>
                        <div class="MenuTextPos MenuText" id="lblsave" lang="en">
                            Save</div>
                    </div>
                </a>
                <div class="menuPadding">
                    &nbsp;</div>
                <a href="managechecks.html" rel="external" style="text-decoration: none; font-weight: normal;">
                    <div class="MenuPosition">
                        <div class="MenuTextPos">
                            <img  class="bottomicon"  src="../images/icn-exit.png" alt="Settlement Complete" /></div>
                        <div class="MenuTextPos MenuText" lang="en">
                            Cancel</div>
                    </div>
                </a>
                <div class="menuPadding">
                    &nbsp;</div>
            </div>
        </div>
       <div id="f1"  data-role="footer" class="ui-bar">
            <div class="footer">
                <div class="leftfooter">
                    09 November 2011</div>
                <div class="rightfooter">
                    Mirnah Technology Systems</div>
            </div>
        </div>
        <div id="f2"  data-role="footer" style="bottom: 0; position: absolute;">
        	 <aside data-pushbar-id="left" class="pushbar from_left">
		<div class="title"><span data-pushbar-close class="close push_right"></span>
			<span id="txtroute"></span>
		</div>

		<ul class="menu">
		<li style="margin-bottom: 0 !important;" > 
		<img title="" alt="" src="../images/startday-icon.png" id="day"  class="leftmenu" >
		 <a href="#"
						class="ui-btn-active" rel="external" id="day" data-icon="custom"  
						lang="en" onclick="footerredict('../startofday/startofday.html')">Start day</a></li>
					<li style="margin-bottom: 0 !important;">
					 <img title="" alt="" src="../images/Inventoryicon.png" id="inve"  class="leftmenu">
					 <a href="#" id="inve"
						rel="external" data-icon="custom" lang="en"
						onclick="footerredict('../inventory/inventory.html')">Inventory</a></li>
					<li style="margin-bottom: 0 !important;">
					 <img title="" alt="" src="../images/customer-icon.png" id="cust" class="leftmenu">
					 <a href="#"
						rel="external" id="cust" data-icon="custom" lang="en"
						onclick="footerredict('../customer/customer_operation.html')">Customer</a></li>
					<li style="margin-bottom: 0 !important;">
					<img title="" alt="" src="../images/Money-icon.png" id="sett" class="leftmenu">
					<a href="#"
						rel="external" id="sett" data-icon="custom" lang="en"
						onclick="footerredict('../settlement/managesettlement.html')">Settlement</a></li>
					<li style="margin-bottom: 0 !important;">
					<img title="" alt="" src="../images/expense-icon.png" id="expe" class="leftmenu">
					<a href="#"
						rel="external" id="expe" data-icon="custom" lang="en"
						onclick="footerredict('../settlement/expenseentry.html')">Expenses</a></li>
					<li style="margin-bottom: 0 !important;">
					<img title="" alt="" src="../images/information-icon.png" id="info" class="leftmenu" >
					<a href="#"
						rel="external" id="info" data-icon="custom" lang="en"  
						onclick="footerredict('../information/information.html')">Information</a></li>
					<li style="margin-bottom: 0 !important; ">
					 <img title="" alt="" src="../images/user-settings-icon.png" id="setup" class="leftmenu">
					 <a href="#" rel="external" id="setup" data-icon="custom" lang="en"
						onclick="footerredict('../utilities/utilities.html')">Utilities</a></li>
		</ul>

	</aside>
        
            <div data-role="navbar" data-iconpos="top" data-grid="f">
                <ul>
                    <li style="margin-bottom:0 !important;"><a href="#" rel="external" id="day" data-icon="custom" lang="en" onclick="footerredict('../startofday/startofday.html')">Start day</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" id="inve" rel="external" data-icon="custom" lang="en" onclick="footerredict('../inventory/inventory.html')">Inventory</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" rel="external" id="cust" data-icon="custom" lang="en" onclick="footerredict('../customer/customer_operation.html')">Customer</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" rel="external" id="sett" data-icon="custom" lang="en" class="ui-btn-active" onclick="footerredict('../settlement/managesettlement.html')">Settlement</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" rel="external" id="expe" data-icon="custom" lang="en" onclick="footerredict('../settlement/expenseentry.html')">Expenses</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" rel="external" id="info" data-icon="custom" lang="en" onclick="footerredict('../information/information.html')">Information</a></li>
			        <li style="margin-bottom:0 !important; width:14.0%"><a href="#" rel="external" id="setup" data-icon="custom" lang="en" onclick="footerredict('../utilities/utilities.html')">Utilities</a></li>
                </ul>
            </div>
        </div>
    </div>
    <div id="SubmitMessage" style="display: none;" lang="en">
        Data Submit Successfully</div>
    <div id="Information" style="display: none;" lang="en">
        Information</div>
    <div id="AlertOK" style="display: none;" lang="en">
        OK</div>

    <script type="text/javascript" language="javascript">
        window.lang = new jquery_lang_js();
        var platform,custid,data,selRow,decimalplace;        
        resizeOrientationWindow();
	  	$(document).ready(function() {
	 	resizeWindow();            
		//Set current date in footer
            $(".leftfooter").html(getCurrentDate());
                          
            //Fetch current language and set that language.
            var lan = sessionStorage.getItem("Language");
            window.lang.run(lan);
            
            //Setting Date Selection Limit According To PdcThreshold
            var pdcthreshold = sessionStorage.getItem("pdcthreshold");            
            if(pdcthreshold > 0 && pdcthreshold != "" && pdcthreshold != undefined)                
            {
                $("#txtDate").data('datebox').options.maxDays = eval(pdcthreshold);
            }
            $("#txtDate").data('datebox').options.minDays = 0;
            
            document.addEventListener("deviceready", getCustomer, false);
         // sujee added side bar ----------------- START ------------------------ 

	          var pushbar = new Pushbar({
	blur:true,
	overlay:true,
});
$("#txtroute").text("ROUTE #: " + sessionStorage.getItem("RouteCode")); 
window.setInterval(function(){
		var randomColor = '#'+ ('000000' + Math.floor(Math.random()*16777215).toString(16)).slice(-6);
		$('#txtroute').css({
			'color' : randomColor,
		});
		}, 2000);
//----------------------------- END -------------------------  
            $("#ddlCustomer").change(function()
            {
                if($("#ddlCustomer").get(0).selectedIndex != 0)
                    custid = $(this).val();
            })
            
            function getCustomer()
            {
                platform = sessionStorage.getItem("platform");
                decimalplace = sessionStorage.getItem("decimalplace");
                var Qry;
                Qry = "SELECT customercode,customername FROM customermaster WHERE invoicepaymentterms IN(2,3) AND templateindicator IS NOT 1  ORDER BY customername";
                console.log(Qry);
                if(platform == "iPad")
                {
                    Cordova.exec(function(result) { 
                        if(result.length > 0)
                            $("<option />" ,{value:"0",text:" -- SELECT --"}).appendTo($("#ddlCustomer"));
                        for(i=0;i<result.length;i++){
                            $("<option />" ,{value:result[i][0],text:result[i][1]}).appendTo($("#ddlCustomer"));                                           
                        }
                        $("#ddlCustomer").selectmenu("refresh");  
                        BindBankList();
                    },
                    function(error) {
                        navigator.notification.alert("Error in binding Reason : " + error);
                    },
                    "PluginClass", 
                    "GetdataMethod", 
                    [Qry]);
                }
                else if(platform == "Android")
                {
                    window.plugins.DataBaseHelper.select(Qry,function(result)
					{
						if(result.array != undefined)
						{
                        	result = $.map(result.array, function (item, index) { 
            					return [[item.customercode, item.customername]];
                        	});
                        	if(result.length > 0)
	                            $("<option />" ,{value:"0",text:" -- SELECT --"}).appendTo($("#ddlCustomer"));
                        	for(i=0;i<result.length;i++){                    
	                            $("<option />" ,{value:result[i][0],text:result[i][1]}).appendTo($("#ddlCustomer"));                                           
                        	}
                        	$("#ddlCustomer").selectmenu("refresh");
                        	BindBankList();
                        }   
					},
					function()
					{
				   	 console.warn("Error calling plugin");
					});
                }
            }
            
            function BindBankList()
            {  
                if(platform=='iPad')
                {
                    Cordova.exec(function(result) {
                        if(result.length > 0)
                        {           
                            for(i=0;i<result.length;i++){   
                                $("<option />" ,{value:result[i][0],text:result[i][1]}).appendTo($("#ddlBank"));                                           
                            }
                            $("#ddlBank").selectmenu("refresh");
                        }
                        //getRecord();
                    },
                    function(error) {
                        alert("Error in binding Bank Name : " + error);
                    },
                    "PluginClass",
                    "GetdataMethod",
                    ["select bankcode,bankname From bankmaster"]);
                }
                else if(platform=='Android')
                {
	           		window.plugins.DataBaseHelper.select("select bankcode,bankname From bankmaster",function(result)
					{
						if(result.array != undefined)
						{
					 		result = $.map(result.array, function (item, index) {
	                            return [[item.bankcode,item.bankname]];
                        	});
                        	if(result.length > 0)
                        	{
	                            for(i=0;i<result.length;i++){
                                	$("<option />" ,{value:result[i][0],text:result[i][1]}).appendTo($("#ddlBank"));                                           
                            	}
                            	$("#ddlBank").selectmenu("refresh");
                        	}
                        }
                        //getRecord();
					},
					function()
					{
				   	 console.warn("Error calling plugin");
					});
           		}  
            }
            
            /*function getRecord()
            {
                var Qry,customercode;
                if($("#ddlCustomer").get(0).selectedIndex == 0)
                    customercode = "";
                else
                    customercode = $("#ddlCustomer").val();
                    
                if(customercode != "")
                    Qry = "SELECT invoicenumber,totalinvoiceamount,invoicebalance FROM customerinvoice WHERE invoicebalance <> 0  AND voidflag IS NOT 1 AND customercode = " + customercode;
                else
                    Qry = ""
                console.log(Qry);
                if(platform == "iPad")
                {
                        Cordova.exec(function(result) {    
                                try{
                                BindData(result);
                                }
                                catch(ex)
                                {
                                    alert(ex);
                                }
                        },
                        function(error) {
                            navigator.notification.alert(error);
                        },
                        "PluginClass",
                        "GetdataMethod",
                        [Qry]);
                }
                else if(platform == "Android")
                {
                        window.plugins.DataBaseHelper.select(Qry, function(result) {
                            BindData(result);
                        },
                        function() {
                            console.warn("Error calling plugin");
                        });
                }
            }
            
            function BindData(result) 
            {   
                ClearTable('tblContent');
                data = result;
                var CellCount = $("#tblHeaderContent tr:eq(0) th").length;
                for (i = 0; i < data.length; i++) 
                {
                    var r = "<tr class='contentFont'>";
                    for (j = 0; j < CellCount; j++) {                        
                        var temp = (j == 0) ? "class = leftAlign" : "class = rightAlign";
                        if(j >= 1)
                            data[i][j] = eval(data[i][j]).toFixed(decimalplace);
                        else if(j == 0)
                            data[i][j] = parseInt(data[i][j]);                            
                         
                        var c = "<td " + temp + ">" + data[i][j] + "</td>";
                        r += c;
                    }
                    r += "</tr>";
                    $('#tblContent tbody').append(r);
                }
                
                $("#tblContent tr").live('click', function() {                    
                    $(this).toggleClass('clicked');
                    $(this).siblings().removeClass('clicked');
                    var i = $(this).index();                    
                    if($(this).hasClass("clicked"))
                        selRow = true;
                    else
                        selRow = undefined;
                });
                
                $("#tblContent tr:odd").addClass('oddRow');
                $("#tblContent tr:even").addClass('evenRow');                 
                $("#tblContent tr:eq(1)").trigger('click');
            }
            
            function ClearTable(tbl) 
            {
                $("#" + tbl + " tr:gt(0)").remove();
                $("#" + tbl + " tr").die('click');
                selRow = undefined;
            }*/
            
            
            function ClearFields()
            {
                $("#txtCheque").val('');
                $("#txtAmount").val('');
                $("#txtDate").val('');
                $("#ddlBank").get(0).selectedIndex = 0;
            }

            $('.ui-body-d').css({ 'background': '#fff' });
            $('.ui-input-datebox').css({ 'width': '93%', 'line-height': '4.0' });
            $('.ui-btn-icon-notext').css({ 'margin-top': '19px !important' });
            $('.ui-input-datebox input').css({ 'width': '75% !important', 'color': '#999' });
            $('.ui-select .ui-btn-text').css({ 'text-align': 'left', 'color': '#999' });

            //Check for current language and set css for that
            if (sessionStorage.getItem("Language") != "en") {
                var val = 'AddCheck' + lan;
                window.lang.change('AddCheck' + lan, lan);
                window.lang.change('Footer' + lan, lan);
                window.lang.change('CommonMessage' + lan, lan);

                if (lan == "AR") {
                    //Set html right alignment for arbic language
                    $(".boxContent").attr("dir", "rtl");

                    //Set header align              
                    $('#Back_inner').removeClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                    $('#Back_inner').addClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                    $('#lang_inner').removeClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                    $('#lang_inner').addClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                }
            }
            else {
                //Change current language to english
                window.lang.change('en', 'en');

                //Set html left alignment for english language
                $(".boxContent").attr("dir", "ltr");

                //Set header align              
                $('#Back_inner').removeClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                $('#Back_inner').addClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                $('#lang_inner').removeClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                $('#lang_inner').addClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');

            }

        });
        
        function InsertCheque()
            {
                if(ValidateAmount() == false)
                    return false;
                SetVisitKey(0);
            }
            
            function SetVisitKey(Action) 
            {               
                var Qry = "select (ifnull(max(visitkey),0) + 1) as VisitKey from customeroperationscontrol where routekey = " + sessionStorage.getItem("RouteKey");				
                if(platform=='iPad')
                {
	                Cordova.exec(function(result) {
	                    if (result != '')
                        {
	                        sessionStorage.setItem("VisitKey", result);
                            var visitkey=result;
                        }
	                    else
                        {
	                        sessionStorage.setItem("VisitKey", 1);
                            var visitkey=1;
                        }          
	                    insertvisitkey(visitkey);    
                            
	                },
	                function(error) {
	                        alert(error);
	                },
	                "PluginClass",
	                "GetdataMethod",
	                [Qry]);
                }
                else if(platform=='Android')
                {
                    window.plugins.DataBaseHelper.select(Qry,function(result)
                    {
                    	if(result.array != undefined)
                    	{
                        	if (result.array[0].VisitKey != undefined)
                        	{		 		
	                            sessionStorage.setItem("VisitKey", result.array[0].VisitKey);
                            	var visitkey=result.array[0].VisitKey;
                        	}
                        }
                        else
                        {
                            sessionStorage.setItem("VisitKey", 1);
                            var visitkey=1;
                        }
                        insertvisitkey(visitkey);               
                    },
                    function()
                    {
                    console.warn("Error calling plugin");
                    });
                }
             }
             
             function insertvisitkey(visitkey)
             {
                latitude =sessionStorage.getItem("latitude");
                longitude =sessionStorage.getItem("longitude");
                var qry = "insert into customeroperationscontrol ('visitkey','routekey','customercode','routecode','salesmancode','visitstartdate','visitstarttime','visitenddate','latitude','longitude') values ('"+visitkey+"','"+sessionStorage.getItem("RouteKey")+"','"+ $("#ddlCustomer").val() +"','"+sessionStorage.getItem("RouteCode")+"','"+sessionStorage.getItem("SalesmanCode")+"',date(),'"+sessionStorage.getItem("starttime")+"',date(),'"+latitude+"','"+longitude+"') ";
                console.log(qry);
                if(platform=='iPad')
                {
	                Cordova.exec(function(result) { 
	                    UpdateCheckDetail();
	                },
	                function(error) {
	                        alert(error);
	                },
	                "PluginClass",
	                "InsertUpdateMethod",
	                [qry]);
                }
                else if(platform=='Android')
                {
		      		window.plugins.DataBaseHelper.insert(qry,function(result)
                    {
                        UpdateCheckDetail();
                    },
                    function()
                    {
                        console.warn("Error calling plugin");
                    });
                }
             }
            
            
            function ValidateAmount()
            {
                if($("#ddlCustomer").get(0).selectedIndex == 0)
                {
                    getLangText("Select Customer.");
                    return false;
                }                
                if($.trim($("#txtCheque").val()) == "")
                {
                    getLangText("Required Details Missing.");
                    return false;
                }
                if($.trim($("#txtAmount").val()) == "")
                {
                    getLangText("Required Details Missing.");
                    return false;
                }                
                if($.trim($("#txtDate").val()) == "")
                {
                   getLangText("Required Details Missing.");
                    return false;
                }
                /*else if($("#txtAmount").val() < 0)
                {
                    navigator.notification.alert("Positive Inputs Only");
                    return false;
                } */               
                else
                    return true;                
            }
            
            function UpdateCheckDetail()
            {  
               var routekey= sessionStorage.getItem("RouteKey");
               var visitkey= sessionStorage.getItem("VisitKey");
               var checknumber = $('#txtCheque').val();
               var amount = $('#txtAmount').val();
               var checkdate = $('#txtDate').val();
               var bankcode = $('#ddlBank').val();   
                        
                var Qry = "insert into cashcheckdetail ('routekey','visitkey','typecode','checknumber','amount','checkdate','bankcode','istemp',issync,checktype) values ('"+routekey+"','"+visitkey+"','1','"+checknumber+"','"+amount+"','"+checkdate+"','"+bankcode+"','false',0,1)";
                console.log(Qry);
                          
                if(platform=='iPad')
                { 
                    Cordova.exec(function(result) {
                            GetARInvoiceNumber();                          
                          },
                          function(error) {
                          alert(error);},
                          "PluginClass", 
                          "InsertUpdateMethod",                
                          [Qry]);  
                    }
                else if(platform=='Android')
           		{
	           		window.plugins.DataBaseHelper.insert(Qry,function(result)
					{   
                        GetARInvoiceNumber();                  
					},
					function()
					{
				   	 console.warn("Error calling plugin");
					});
           		}
            }
            
            function GetARInvoiceNumber()
            {            
                /*var Qry = "SELECT CASE WHEN MAX(invoicenumber) IS NULL OR MAX(invoicenumber) = 0 THEN '000000' ELSE SUBSTR(MAX(invoicenumber),-6) END as invoicenumber from arheader";*/
                 var Qry = "SELECT (CASE WHEN MAX(hhcarseq) IS NULL OR MAX(hhcarseq) = 0 OR MAX(hhcarseq) = 'null' THEN 1 ELSE hhcarseq END) as invoicenumber,(CASE WHEN MAX(bodocseq) IS NULL OR MAX(bodocseq) <=0 OR MAX(bodocseq) = '' OR MAX(bodocseq) = 'null' THEN 0 ELSE bodocseq END) AS documentnumber from routemaster" + " WHERE routecode=" + sessionStorage.getItem("RouteCode");
                console.log(Qry);
                if(platform == "iPad")
                {
                    Cordova.exec(function(result) {
                              if(result.length > 0)
                              {
                                var InvoicePrefix  = sessionStorage.getItem("RouteCode").toString() + '3'; // 3 is the prefix for   arheader
                                var InvNumber = InvoicePrefix.toString() + (eval(result[0][0]) + 1).toString().lpad("0",6); 
                              
                                var DocPrefix  = sessionStorage.getItem("RouteCode").toString();
                                var DocNumber = DocPrefix.toString() + (eval(result[0][1]) + 1).toString().lpad("0",7);
                                UpdateARHeader(InvNumber,DocNumber);                 
                              }
                              },
                              function(error) {
                              alert(error);
                              },
                              "PluginClass",
                              "GetdataMethod",
                              [Qry]);
                }
                else if(platform == "Android")
                {
                    window.plugins.DataBaseHelper.select(Qry, function(result) 
                                                     {
                                                     if(result.array != undefined)
                                                     {
                                                        var InvoicePrefix  = sessionStorage.getItem("RouteCode").toString() + '3'; // 3 is the prefix for   arheader
                                                        InvNumber = InvoicePrefix.toString() + (eval(result.array[0].invoicenumber) + 1).toString().lpad("0",5); 
                                                        
                                                        var DocPrefix  = sessionStorage.getItem("RouteCode").toString();
                                                        var DocNumber = DocPrefix.toString() + (eval(result.array[0].documentnumber) + 1).toString().lpad("0",6);
                                                        UpdateARHeader(InvNumber,DocNumber); 
                                                     }  
                                                     },
                                                     function() 
                                                     {
                                                     console.warn("Error calling plugin");
                                                     });
                }
            }
            
            function UpdateARHeader(InvNumber,DocNumber)
            {  
               var routekey= sessionStorage.getItem("RouteKey");
               var visitkey= sessionStorage.getItem("VisitKey");               
               var amount = $('#txtAmount').val();
                
                var Qry = "insert into arheader (invoicenumber,routekey,visitkey,transactiondate,transactiontime,customercode,routecode,salesmancode,voidflag,totalinvoiceamount,amountpaid,invoicebalance,issync,istemp,advancepaymentflag,hhctransactionkey,documentnumber) values (" + InvNumber + "," + routekey + "," + visitkey + ",date('now', 'localtime'),time('now', 'localtime')," + $("#ddlCustomer").val() + "," + sessionStorage.getItem("RouteCode") + "," + sessionStorage.getItem("SalesmanCode") + ",0," + amount + "," + amount + ",0,0,'false',1," + sessionStorage.getItem("VisitKey") + "," + DocNumber + ")";
                console.log(Qry);
                          
                if(platform=='iPad')
                { 
                    Cordova.exec(function(result) {
                            SaveEndDayDetail(amount);
                          },
                          function(error) {
                          alert(error);},
                          "PluginClass", 
                          "InsertUpdateMethod",                
                          [Qry]);  
                    }
                else if(platform=='Android')
           		{
	           		window.plugins.DataBaseHelper.insert(Qry,function(result)
					{   
                        SaveEndDayDetail(amount);
					},
					function()
					{
				   	 console.warn("Error calling plugin");
					});
           		}
            }
            
            function SaveEndDayDetail(amount)
            {            
                var QrySelect = "SELECT COUNT(*) cnt FROM enddaydetail WHERE routekey=" + sessionStorage.getItem("RouteKey") + " AND listtypecode = 1 AND detailtypecode = 4";                
                var QryInsert = "INSERT INTO enddaydetail(routekey,detailtypecode,listtypecode,amount,issync) VALUES(" + sessionStorage.getItem("RouteKey") + ",4,1," + amount + ",0)";
                var QryUpdate = "UPDATE enddaydetail SET amount = ifnull(amount,0) + " + amount + ",issync = 0 WHERE routekey = " + sessionStorage.getItem("RouteKey") + " AND listtypecode = 1 AND detailtypecode = 4";
                var QryNew = "";
                console.log(QrySelect);
                if(platform=='iPad')
                { 
                    Cordova.exec(function(result) {                                                     
                        if(eval(result[0][0]) <= 0)                        
                            QryNew = QryInsert;
                        else
                            QryNew = QryUpdate;
                        console.log(QryNew);    
                        Cordova.exec(function(result1) { 
                            SaveStartEndDay(amount)
                        },
                        function(error) {
                            alert(error);
                        },
                        "PluginClass", 
                        "InsertUpdateMethod", 
                        [QryNew]);  
                    },
                    function(error) {
                        alert(error);
                    },
                    "PluginClass", 
                    "GetdataMethod",                
                    [QrySelect]);  
                }
                else if(platform=='Android')
           		{
	           		window.plugins.DataBaseHelper.select(QrySelect,function(result)
					{
                        if(eval(result.array[0].cnt) <= 0)                        
                            QryNew = QryInsert;
                        else
                            QryNew = QryUpdate;
                        window.plugins.DataBaseHelper.insert(QryNew,function(result)
                        {
                            SaveStartEndDay(amount)
                        },
                        function()
                        {
                            console.warn("Error calling plugin");
                        });
					},
					function()
					{
				   	 console.warn("Error calling plugin");
					});
           		}
            }
            
            function SaveStartEndDay(amount)
            {
                var Qry = "UPDATE startendday SET totalchecks = ifnull(totalchecks,0) + " + amount + " WHERE routekey = " + sessionStorage.getItem("RouteKey");
                console.log(Qry);
                if(platform=='iPad')
                { 
                    Cordova.exec(function(result) {
                        UpdateDocumentNumber();
                    },
                    function(error) {
                        alert(error);
                    },
                    "PluginClass",
                    "InsertUpdateMethod",
                    [Qry]);  
                }
                else if(platform=='Android')
           		{
	           		window.plugins.DataBaseHelper.insert(Qry,function(result)
					{   
                        UpdateDocumentNumber();
					},
					function()
					{
				   	 console.warn("Error calling plugin");
					});
           		}
            }
            
            function UpdateDocumentNumber()
            {
                var Qry = "UPDATE routemaster SET bodocseq = (ifnull(bodocseq,0) + 1),hhcarseq= (ifnull(hhcarseq,0) + 1) WHERE routecode=" + sessionStorage.getItem("RouteCode");
                console.log(Qry);
                if(platform == "iPad")
                {                    
                    Cordova.exec(function(result) {   
                        ClearFields();
                    },
                    function(error) {
                        alert(error);
                    },
                    "PluginClass",
                    "InsertUpdateMethod",
                    [Qry]);
                }
                else if(platform == "Android")
                {
                    window.plugins.DataBaseHelper.insert(Qry,function(result){                	
                    	ClearFields();
                    },
                    function()
                    {
                        console.warn("Error calling plugin");
                    });
                }
            }
            
            function ClearFields()
            {
                $("#txtCheque").val('');
                $("#txtAmount").val('');
                $("#txtDate").val('');
                $("#ddlBank").get(0).selectedIndex = 0;
            }
    </script>

</body>
</html>
