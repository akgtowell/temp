<!--
 '  Created By   : Nidhi Dedania
 '  Created Date : 26/1/2011
 '  Description  : This page is used for detail of commission
-->
<!DOCTYPE html>
<html>
<head>
    <title>Order Promotion Review</title>
    <meta name="viewport"
	content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />

    <meta name="format-detection" content="telephone=no"/>
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="../css/en.css" lang="en" />
    <link rel="stylesheet" href="../css/jquery.mobile-1.0.min.css" />
    <link rel="stylesheet" media="only screen and (min-width: 320px) and (max-width: 600px)"
        href="../css/style_600.css"/>
    <!--Black P-->
    <link rel="stylesheet" media="only screen and (min-width: 600px) and (max-width: 700px)"
        href="../css/style_700.css"/>
    <!--Iphone 4 P-->
    <link rel="stylesheet" media="only screen and (min-width: 700px) and (max-width: 800px)"
        href="../css/style_800.css"/>
    <!--Ipad P-->
    
    <!--Black L-->
    <link rel="stylesheet" media="only screen and (min-width: 1000px) and (max-width: 1200px)"
        href="../css/style_1200.css"/>
    <!--Ipad L-->
    <link rel="stylesheet" media="only screen and (min-width: 1200px) and (max-width: 1500px)" href="../css/style_1400.css"/>
	
    <link rel="stylesheet" href="../css/font-awesome.css" />

    <script type="text/javascript" src="../js/jquery.js"></script>

    <script type="text/javascript" src="../js/jquery.mobile-1.0.js"></script>

    <script type="text/javascript" src="../js/common.js"></script>

    <script>
if (navigator.userAgent.toLowerCase().match(/android/)) {
document.write('<script charset="utf-8" src="../cordova-2.0.0.js"><\/script>');
document.write('<script charset="utf-8" src="../directoryListing.js"><\/script>');
} else if (navigator.userAgent.toLowerCase().match(/iphone/) || navigator.userAgent.toLowerCase().match(/ipad/)) {
document.write('<script charset="utf-8" src="../cordova-1.5.0.js"><\/script>');
}
    </script>

    <script type="text/javascript" src="../js/jquery.json-2.3.min.js"></script>

    <script src="../LangJS/jquery-lang.js" charset="utf-8" type="text/javascript"></script>

    <script src="../LangJS/langpack/AR.js" charset="utf-8" type="text/javascript" lang="en"></script>
        <link rel="stylesheet" type="text/css" href="../css/jquery.mobile.simpledialog.css" />
        
        <script type="text/javascript" src="../js/jquery.mobile.simpledialog.js"></script>
</head>
<body>
    <div data-role="page" data-theme="d" data-title="HOME" id="myPage">
        <div>
            <img title="" alt="" src="../images/bg.png" id="background">
        </div>
        <div data-role="header" data-position="inline" id="bgclheader">
            <!--<a href="index.html"   id="Back_inner">test</a>-->
            <a href="order_promotion_list.html" id="Back_inner" class="enableText" rel="external">
                </a>
            <h1 lang="en">
                Promotions Review</h1>
            <a href="#" id="lang_inner">EN</a>
        </div>
        <div data-role="content" class="centerbox">
            <div class="tblBox com_div comm" style="display: none" id="divTotalInvoice">
                <table border="0" width="100%" cellpadding="6" cellspacing="0" id="tbl1" data-role="none">
                    <thead>
                        <tr>
                            <td colspan="3" class="tblHeader" style="padding: 10px;" lang="en">
                                Promotions Review
                            </td>
                        </tr>
                    </thead>
                    <tbody class="tbl_body">
                        <tr class="tr_commission td_com1" style="font-size:18px;">
                            <td width="36%" lang="en">
                                Promo Key
                            </td>
                            <td style="text-align: right;" colspan=2>
                                <div id="divPromoKey" class="readonly_text" style="width:85%">
                                </div>
                            </td>
                        </tr>
                        <tr class="tr_commission td_com1" style="font-size:18px;">
                            <td lang="en" width="36%">
                                Promo Description
                            </td>                           
                            <td colspan=2>
                                <div id="divPromoDesc" class="readonly_text" style="width:85%">
                                </div>
                            </td>
                        </tr>
                        <tr class="tr_commission td_com1" style="font-size:18px;">
                            <td width="36%" lang="en">
                                Current Invoice Amount
                            </td>
                            <td style="text-align: right;" colspan=2>
                                <div id="divCIAmount" class="readonly_text" style="width:85%">
                                </div>
                            </td>
                        </tr>
                        <tr class="tr_commission td_com1" style="font-size:18px;" id="app1">
                            <td width="36%" lang="en" >
                                Qualified Amount
                            </td>
                            <td colspan=2 style="text-align: right;">
                                <div id="divqualifiedAmount" class="readonly_text" style="width:85%">
                                </div>
                            </td>
                        </tr>
                        
                        <tr class="tr_commission td_com1" style="font-size:18px;" id="app2">
                            <td lang="en" width="36%">
                                Applied Promotion
                            </td>
                            
                            <td width="32%" style="text-align: right;">
                                <div id="divPromo" class="readonly_text" style="width:80%">
                                </div>
                            </td>
                            <td style="padding-left:0px;padding-right:30px;text-align: right;"> <div id="divPromotionAmount" class="readonly_text" style="width:80%;text-align: right;">
                            </div></td>
                        </tr>
                        <tr class="tr_commission td_com1" style="font-size:18px;" id="app3">
                            <td width="36%" lang="en">
                                Promotion Amount
                            </td>
                            <td style="text-align: right;" colspan=2>
                                <div id="divPromotionAmount" class="readonly_text" style="width:85%;text-align: right;">
                                </div>
                            </td>
                        </tr>
                        <tr class="tr_commission td_com1" style="font-size:18px;">
                            <td lang="en" width="36%">
                                New Invoice Amount
                            </td>                            
                            <td style="text-align: right;" colspan=2>
                                <div id="divNIAmount" class="readonly_text" style="width:85%;text-align: right;">
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="2">                                
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="boxContent" id="divLineItem">
                <div class="textBar">
                    <table id="tblInput" cellpadding="2" cellspacing="2" border="0" width="100%">
                        <tr>
                            <td class="captionLabel" lang="en" style="width: 50%">
                                Promo Key
                            </td>
                            <td class="captionLabel" lang="en" style="width: 50%">
                                Description
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <input id="txtPromoKey" type="text" class="textWidth textFont" readonly="readonly" />
                            </td>
                            <td>
                                <input id="txtDescription" type="text" class="textWidth textFont" readonly="readonly" />
                            </td>
                        </tr>
                    </table>
                </div>
                <div class="tblBox tbltd">
                    <table id="tblLineHeader" cellpadding="0" cellspacing="0" width="100%" class="tblHeader">
                        <tr>
                            <th style="width: 50%;" lang="en" class="leftAlign">
                                Item Code
                            </th>
                            <th style="width: 25%;" lang="en" class="leftAlign">
                                Discount
                            </th>
                            <th style="width: 20%;" lang="en">
                                Old
                            </th>
                            <th style="width: 25%;" lang="en" class="last">
                                Total
                            </th>
                        </tr>
                    </table>
                    <div id="contentWrapper" class="tblHeightWithTab">
                        <table id="tblLineContent" cellpadding="0" cellspacing="0" border="0" width="100%">
                            <tr>
                                <td style="width: 50%;" class="leftAlign">
                                </td>
                                <td style="width: 25%;" class="leftAlign">
                                </td>
                                <td style="width: 20%;">
                                </td>
                                <td style="width: 25%;" class="last">
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="textBar">
                    <table id="tblInput" cellpadding="2" cellspacing="2" border="0" width="100%">
                       <tr>
							<td class="captionLabel" lang="en" style="width: 50%">Total</td>
							<td class="captionLabel" lang="en" style="width: 50%">Discount Amt.</td>
							<td class="captionLabel" lang="en" style="width: 50%">Net Total</td>
							
						</tr>
						<tr>
							<td><input id="txtcurrentinvoice" type="text"
								class="textWidth textFont" style="text-align: right;"
								readonly="readonly" /></td>
							<td><input id="txtDiscount" type="text"
								class="textWidth textFont" style="text-align: right;"
								readonly="readonly" /></td>
							<td><input id="txtnewinvoice" type="text"
								class="textWidth textFont" style="text-align: right;"
								readonly="readonly" /></td>
						</tr>
                    </table>
                </div>
            </div>
            <div class="boxContent" style="display: none;" id="divFreeSample">
                <div class="textBar">
                    <table id="tblInput" cellpadding="2" cellspacing="2" border="0" width="100%">
                        <tr>
                            <td class="captionLabel" lang="en" style="width: 50%">
                                Promo Key
                            </td>
                            <td class="captionLabel" lang="en" style="width: 50%">
                                Description
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <input id="txtPromoKey1" type="text" class="textWidth textFont" readonly="readonly" />
                            </td>
                            <td>
                                <input id="txtDescription1" type="text" class="textWidth textFont" readonly="readonly" />
                            </td>
                        </tr>
                    </table>
                </div>
                <div class="tblBox tbltd">
                    <table id="tblHeaderContent" cellpadding="0" cellspacing="0" width="100%" class="tblHeader">
                        <tr>
                            <th style="width: 20%;" lang="en" class="leftAlign">
                                Item Code
                            </th>
                            <th style="width: 35%;" lang="en" class="leftAlign">
                                Item Description
                            </th>
                            <th style="width: 15%;" lang="en">
                               Order Qty
                            </th>
                            <th style="width: 15%;" lang="en">
                                UPC
                            </th>
                            <th style="width: 15%;" lang="en" class="last">
                                Given Free
                            </th>
                        </tr>
                    </table>
                    <div id="contentWrapper" class="tblHeightWithTab">
                        <table id="tblContent" cellpadding="0" cellspacing="0" border="0" width="100%">
                            <tr>
                                <td style="width: 20%;" class="leftAlign">
                                </td>
                                <td style="width: 35%;" class="leftAlign">
                                </td>
                                <td style="width: 15%;">
                                </td>
                                <td style="width: 15%;">
                                </td>
                                <td style="width: 15%;" class="last">
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="textBar">
                    <table id="tblInput" cellpadding="2" cellspacing="2" border="0" width="100%">
                        <tr>
                            <td style="width: 50%;" lang="en" id="allowedFreeDiv">
                                Allowed Free
                            </td>
                            <td style="width: 50%;" lang="en" id="promotionBalanceDiv">
                            </td>
                        </tr>
                        <tr>
                            <td>
                                    <input id="txFreeQty" type="number" size="11" class="textWidth textFont" value="0"
                                    readonly="readonly" />
                                    </td>
                                    <td>
                                    <input id="txtPromotionBalance" type="number" size="11" class="textWidth textFont" value="0"
                                    readonly="readonly"  style="display:none;"/>
                            
                            </td>
                        </tr>
                        
                          <tr>
                         <td style="width: 50%;" lang="en" id="toleranceDiv" style="display:none;">Tolerance
                            </td>
                         <td style="width: 50%;" lang="en">
                            </td>
                        </tr>
                        <tr>
                        
                           <td>
                           <input id="txtTolerance" type="number" size="11" class="textWidth textFont" value="0"
                           readonly="readonly"  style="display:none;"/>
                           </td>
                        </tr>
                      
                    </table>
                </div>
                <div class="textBar" id="addfreegrid" style="display:none;">
                    <table id="tblInput1" cellpadding="2" cellspacing="2" border="0" width="100%">
                        <tr>                             
                            <td style="width:50%;" lang="en">
                                Item   
                            </td>    
                            <td style="width:50%;">
                                Qty
                            </td> 
                            <td></td>
                        </tr>
                        <tr>                    
                            <td>
                                <select id="txtitemadd" style="width:100%" name="select-choice-1"></select>
                                
                            </td>   
                            <td>
                               
                                <input id="txFreeQtyadd" type="number" size="11" class="textWidth textFont"  value="0"/>
                            </td> 
                            <td>
                                <input type="button" value="Add" name="add" onclick="savepromotion()"/>
                            </td>
                        </tr>               
                    </table>
                </div> 
            </div>
            
            <table id="tblPassword" border="0" cellpadding="2" cellspacing="0" width="100%;"
                style="display: none;">
                <tr>
                    <th class="tblHeader captionLabel leftAlign popupTitle" colspan="2" lang="en">
                        Password Entry
                    </th>
                </tr>
                <tr class="popupRow">
                    <td colspan="2">
                        &nbsp;
                    </td>
                </tr>
                <tr class="popupRow">
                    <td  colspan="2" colspan="2" class="popupSubTitle" lang="en">                                       
                        Promotion Review
                    </td>                
                </tr>
                <tr class="popupRow">
                    <td colspan="2" lang="en" class="popupInfo">
                        Please Enter The Security Password
                    </td>
                </tr>
                <tr class="popupRow">
                    <td colspan="2">
                        <input id="txtPassword" type="number" pattern="[0-9]*" value="" maxlength="10" class="textWidth textFont passwordCenter"  />
                        <label id="lblMessage" lang="en" style="display:none">Enter Correct Password</label> 
                    </td>
                </tr>
                <tr class="popupRow">
                    <td style="width: 50%;">
                        <input id="btnSubmit" type="button" value="Submit" onclick="VerifyPassword('btnSubmit','promotion_review.html',tblPassword.innerHTML);" data-role="none"
                        lang="en" />
                    </td>
                    <td style="width: 50%;">
                        <input id="btnCancel" type="button" rel="close" value="Cancel" onclick="ClearPassword();"
                        data-role="none" lang="en" />
                    </td>
                </tr>
            </table>
        </div>
          <div id="f1"  data-role="footer" class="ui-bar">
            <div class="footer">
                <div class="leftfooter">
                    09 November 2011</div>
                <div class="rightfooter">
                    Mirnah Technology Systems</div>
            </div>
        </div>
        <div id="f2"  data-role="footer" style="bottom: 0; position: absolute;">
            <div data-role="navbar" data-iconpos="top" data-grid="f">
				<ul class="footer-topmenu clearfix">
					<li class="four">
						<a href="#" onclick="SetPage()" rel="external" id="continue">
							<i class="fa fa-check" data-icon="custom" lang="en">Continue</i>
						</a>
					</li>		
				<li class="four">
						<a href="#" rel="external" id="imgPrev">
							<i class="fa fa-angle-double-left" data-icon="custom" lang="en">Previous</i>
						</a>
					</li>
				<li class="four">
						<a href="#" rel="external" id="imgNext" >
							<i class="fa fa-angle-double-right" data-icon="custom" lang="en">Next</i>
						</a>
					</li>		
			
					<li class="four">
						<a href="orderRequest.html" onclick="" rel="external" id="A3">
							<i class="fa fa-times" data-icon="custom" lang="en">Cancel</i>
						</a>
					</li>				
				</ul>		
				<ul class="footer-bottommenu clearfix">
                    <li style="margin-bottom:0 !important;"><a href="#" rel="external" id="day" data-icon="custom" lang="en" onclick="footerredict('../startofday/startofday.html')">Start day</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" id="inve" rel="external" data-icon="custom" lang="en" onclick="footerredict('../inventory/inventory.html')">Inventory</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" class="ui-btn-active" rel="external" id="cust" data-icon="custom" lang="en">Customer</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" rel="external" id="sett" data-icon="custom" lang="en" onclick="footerredict('../settlement/managesettlement.html')">Settlement</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" rel="external" id="expe" data-icon="custom" lang="en" onclick="footerredict('../settlement/expenseentry.html')">Expenses</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" rel="external" id="info" data-icon="custom" lang="en" onclick="footerredict('../information/information.html')">Information</a></li>
			        <li style="margin-bottom:0 !important; width:14.0%"><a href="#" rel="external" id="setup" data-icon="custom" lang="en" onclick="footerredict('../utilities/utilities.html')">Utilities</a></li>
                </ul>
            </div>
        </div>

        <script type="text/javascript" language="javascript">
            var data = null,dataAmount = null,dataItem = null,dataLineItem = null,dataFreeSample = null;  
            var NoNext = false;
            var planNumber = 0, promotionTypeCode = -1, rangeBasis = 0, assignmentgroup = 0,promovalue = 0,repeatingrange=0,rangelow=0;
            var eachqty =[]; //Array to hold the free qty of each item - the text value of last column in each row
            var datapro1 = new Array(2);
            var datapro2 = new Array(2);
            var platform='';  
            var index = 0;
            var lineItem0 = 0;
            var lineItem1 = 0;
            var lineItem2 = 0;
            var lineItem5 = 0;   
            var Qty = 0; 
            var freepromoflag=0;
            var originalItemQty=0;
            var promotionBalanceQty=0;
            var memo1=0;
            var alternateItemGroup=0;
            var assignmentItemGroup=0;
            var amountBasis=0;
            var tolerance=0;
            var ItemPromoPrices=new Object();
            var totalPromotionRetailPrice=0;
            var freeItemsPreFilled=false; //for prefilling quantity 
            var isOrderEditing=false;  
        window.lang = new jquery_lang_js();
        $("#tblLineContent").click(function() { });
        $("#tblContent").click(function() { });
            
  	resizeOrientationWindow();
	  $(document).ready(function() {
	 	resizeWindow();
		  if(sessionStorage.getItem("referrer")=="../inventory/onholdorders.html"){
			  isOrderEditing=true;
		  }

                          $("#txFreeQty").ForceNumericOnly();
                          
        $(".leftfooter").html(getCurrentDate());
                          sessionStorage.setItem("invoiceamount",0);
        document.addEventListener("deviceready", getPromotionList, false); 
           
        var lan = sessionStorage.getItem("Language");
		window.lang.run(lan);
                          
                          $("#tblLineContent tr").live('click', function() {
                                                   $(this).toggleClass('clicked');
                                                   $(this).siblings().removeClass('clicked');
                                                       
                                                   });
                          
                          $("#tblContent tr").live('click', function() {
                                                   $(this).toggleClass('clicked');
                                                   $(this).siblings().removeClass('clicked');
                                                   index = $(this).index();
                                                   });
                          
                                                  
                          var NoPrev = true,ActiveIndex = 0;
                          $("#imgNext").click(function() {
                                              if (!NoNext) {
                                                ActiveIndex += 1;   
                                              $("#divPromoKey").html(data[ActiveIndex][0]);
                                              $("#divPromoDesc").html(data[ActiveIndex][1]);

                                               planNumber = data[ActiveIndex][0];
                                               assignmentgroup = data[ActiveIndex][5]; 
                                              
                                               getPomotionTypeCode(0);
                                              }
                                             
                                              if (ActiveIndex >= (data.length - 1)) {
                                                $(this).addClass("btn-disabled");
                                                NoNext = true;
                                                
                                                if(data.length == 2)
                                                {
                                                    NoPrev = false;
                                                    $("#imgPrev").removeClass("btn-disabled");
                                                }
                                                 
                                              }
                                              else {
                                                NoNext = false;
                                                NoPrev = false;
                                                $("#imgPrev").removeClass("btn-disabled");
                                              }
                                              });
                          
                          $("#imgPrev").click(function() {
                                              if (!NoPrev) {
                                              if(data[ActiveIndex][4] == 7)
                                              {
                                              var flagtype = 2;
                                              }
                                              else{
                                              var flagtype = 1;
                                              }
                                                ActiveIndex -= 1;   
                                              $("#divPromoKey").html(data[ActiveIndex][0]);
                                              $("#divPromoDesc").html(data[ActiveIndex][1]);

                                               planNumber = data[ActiveIndex][0];
                                               assignmentgroup = data[ActiveIndex][5];  
                                              
                                               getPomotionTypeCode(flagtype);
                                              }
                                              if (ActiveIndex <= 0) {
                                                $(this).addClass("btn-disabled");
                                                NoPrev = true;
                                              
                                                if(data.length == 2)
                                                {
                                                    NoNext = false;
                                                    $("#imgNext").removeClass("btn-disabled");
                                                }
                                              }
                                              else {
                                                NoPrev = false;
                                                NoNext = false;
                                                $("#imgNext").removeClass("btn-disabled");
                                              }
                                              });       
                          
		
                if (sessionStorage.getItem("Language")  != "en") {
               
                window.lang.change('Promoreview'+lan,lan);
                window.lang.change('Footer'+lan,lan);
		if(lan=="AR")
                {
                    $('#Back_inner').removeClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
		    $('#Back_inner').addClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
		    $('#lang_inner').removeClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
		    $('#lang_inner').addClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
		}
		
		}
		else
		{
		    window.lang.change('en','en');
		    
		    $('#Back_inner').removeClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
		    $('#Back_inner').addClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
		    $('#lang_inner').removeClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
		    $('#lang_inner').addClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
		}
        });
            
            //Function for bind item list
            function getPromotionList()
            {                        
                platform= sessionStorage.getItem("platform");               
                                               
                if(platform=='iPad')
           		{
                Cordova.exec(function(result) {
                                if(result.length > 0 )
                                {
                                    data = result;                              
                                                                                                                       
                                    $("#divPromoKey").html(data[0][0]);
                                    $("#divPromoDesc").html(data[0][1]);                              
                                   
                                    $("#imgPrev").addClass("btn-disabled");
                                    
                                    if(data.length == 1)
                                    {
                                        $("#imgNext").addClass("btn-disabled");
                                         NoNext = true;
                                    }

                                    planNumber = data[0][0];
                                    assignmentgroup = data[0][5]; 
                                    getPomotionTypeCode(0);
                                    
                                }
                                else
                                {
                                   
                              
                                    NoNext = true;
                                    $("#imgPrev").addClass("btn-disabled");
                                    $("#imgNext").addClass("btn-disabled");
                                }
                              },
                              function(error) {
                                navigator.notification.alert("Error in binding promotion detail : " + error);
                              },
                              "PluginClass", 
                              "GetdataMethod",
                             ["SELECT distinct promokeydetail.plannumber,Case When '" + sessionStorage.getItem('Language') + "' = 'en' Then promoplanheader.plandescription Else promoplanheader.arbplandescription End As plandesc,0,promokeydetail.plannumber,promokeydetail.promotiontypecode,promokeydetail.assignmentgroup FROM promokeydetail inner join customermaster on promokeydetail.promotionkey = customermaster.promotionkey inner join promoplanheader on promokeydetail.plannumber = promoplanheader.plannumber inner join promotiondetail on promokeydetail.plannumber = promotiondetail.promotionplannumber and promotiondetail.routekey = " + sessionStorage.getItem('RouteKey') + " and promotiondetail.visitkey = " + sessionStorage.getItem('VisitKey') + " where customermaster.customercode = " + sessionStorage.getItem('customerid') + " order by promokeydetail.promotiontypecode,promokeydetail.plannumber"]);         
               
             }
            else if(platform=='Android')
            {
                window.plugins.DataBaseHelper.select("SELECT distinct promokeydetail.plannumber,Case When '" + sessionStorage.getItem('Language') + "' = 'en' Then promoplanheader.plandescription Else promoplanheader.arbplandescription End As plandesc,0,promokeydetail.plannumber,promokeydetail.promotiontypecode,promokeydetail.assignmentgroup FROM promokeydetail inner join customermaster on promokeydetail.promotionkey = customermaster.promotionkey inner join promoplanheader on promokeydetail.plannumber = promoplanheader.plannumber inner join promotiondetail on promokeydetail.plannumber = promotiondetail.promotionplannumber and promotiondetail.routekey = " + sessionStorage.getItem('RouteKey') + " and promotiondetail.visitkey = " + sessionStorage.getItem('VisitKey') + " where customermaster.customercode = " + sessionStorage.getItem('customerid') + " order by promokeydetail.promotiontypecode,promokeydetail.plannumber", function(result)
				{
						if(result.array!=undefined)
                        {                        
                        	
                        	
                        	var result = $.map(result.array, function (item, index) {               
                			return [[item.plannumber, item.plandesc,item.routekey,item.plannumber,item.promotiontypecode,item.assignmentgroup]];
            				});    
                                                     
                            data = result;
                                  
                            $("#divPromoKey").html(data[0][0]);
                            $("#divPromoDesc").html(data[0][1]);                              
                                   
                            $("#imgPrev").addClass("btn-disabled");
                                    
                            if(data.length == 1)
                            {
                            	$("#imgNext").addClass("btn-disabled");
                                NoNext = true;
                             }

                                planNumber = data[0][0];
                                assignmentgroup = data[0][5]; 
                                getPomotionTypeCode(0);			 		
				 		} 
				 		else
                        {
                            
                              
                               NoNext = true;
                               $("#imgPrev").addClass("btn-disabled");
                               $("#imgNext").addClass("btn-disabled");
                        }            
                                        
				},
				function()
				{
			   	 console.warn("Error calling plugin");
				});
            } 
            }
            
            function getPomotionTypeCode(flag) {
                sessionStorage.setItem("orderplannumber", planNumber);
                //Check whether the free limit is set for the selected promotion
                getPromoKeyDetails();
                totalPromotionRetailPrice=0;
            	 promovalue=0;
                if(platform=='iPad')
           		{
                Cordova.exec(function(result) {
                              if(result.length > 0 )
                              {
                                    if(result[0][0] == 0)
                                       promotionTypeCode = 1;
                                    else 
                                        promotionTypeCode = eval(result[0][0]);

                                    rangeBasis = eval(result[0][1]);
                              rangelow = eval(result[0][4]);
                              repeatingrange = eval(result[0][5]);
                                    if (promotionTypeCode == 7) 
                                    {
                                       // $('#imgAdd').css({ "display": "block" });
                              freepromoflag=1;
                              if(result[0][1]==3 || result[0][1]==4)
                              {
                                for(j=0;j<result.length;j++)
                                {
                                    promovalue =+ result[0][2];
                                }
                              }
                              else
                              {
                              promovalue=result[0][2];
                              }
                                        sessionStorage.setItem("orderpromovalue",promovalue);
                              $('#txtPromoKey1').val($("#divPromoKey").html());
                              $('#txtDescription1').val($("#divPromoDesc").html());  
                                        $('#divLineItem').css({ "display": "none" });
                                        $('#divTotalInvoice').css({ "display": "none" });                              
                                        $('#divFreeSample').css({ "display": "block" });
                              if(eval(result[0][6])==-1)
                              {
                              $('#addfreegrid').css({ "display": "block" });
                              getItemList();
                              }
                                        getFreeSampleList(0,0);                                        
                                    }                                   
                                    else if(promotionTypeCode == 1 || promotionTypeCode == 2 || promotionTypeCode == 0)
                                    {                                        
                                         sessionStorage.setItem("orderpromovalue", result[0][3]);
                              
                                         $('#txtPromoKey').val($("#divPromoKey").html());
                                         $('#txtDescription').val($("#divPromoDesc").html());                              
                              
                                         $('#divTotalInvoice').css({ "display": "none" });                              
                                         $('#divFreeSample').css({ "display": "none" });   
                                         $('#divLineItem').css({ "display": "block" });
                              
                                         getLineItemDetail(flag);
                                    }
                                    else if(promotionTypeCode == 5 || promotionTypeCode == 6)
                                    {
                                         sessionStorage.setItem("orderpromovalue", result[0][3]);
                              
                                         $('#divFreeSample').css({ "display": "none" });   
                                         $('#divLineItem').css({ "display": "none" });
                                         $('#divTotalInvoice').css({ "display": "block" });
                              
                                         getAmount(flag);     
                                    }                  
                                                                
                              }
                              else 
                              {
                                    promotionTypeCode = -1; 
                                    rangeBasis = 0;
                              }
                              
                              },
                              function(error) {
                                navigator.notification.alert("Error in binding promotion type code : " + error);
                              },
                              "PluginClass", 
                              "GetdataMethod",
                              ["select promotiondetail.promotiontypecode,promokeydetail.rangebasis,promotiondetail.promotionquantity,promotiondetail.promotionamount,promotiondetail.rangelow,promotiondetail.repeatingrange,promotiondetail.itemcode From promotiondetail inner join promokeydetail on promotiondetail.promotionplannumber = promokeydetail.plannumber and promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") where promotionplannumber = " + planNumber + " and routekey = " + sessionStorage.getItem('RouteKey') + " and visitkey = " + sessionStorage.getItem('VisitKey') + ""]); 
            	}
            	else if(platform=='Android')
            	{
            	    window.plugins.DataBaseHelper.select("select promotiondetail.promotiontypecode,promokeydetail.rangebasis,promotiondetail.promotionquantity,promotiondetail.promotionamount,promotiondetail.rangelow,promotiondetail.repeatingrange,promotiondetail.itemcode From promotiondetail inner join promokeydetail on promotiondetail.promotionplannumber = promokeydetail.plannumber and promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") where promotionplannumber = " + planNumber + " and routekey = " + sessionStorage.getItem('RouteKey') + " and visitkey = " + sessionStorage.getItem('VisitKey') + "", function(result)
					{
						var array = $.map(result.array, function (item, index) {               
                		return [[item.promotiontypecode, item.rangebasis,item.promotionquantity,item.promotionamount]];
            			});
            			
            			result = array;
	            		if(result.length > 0 )
                        {
                                                         if(result[0][0] == 0)
                                                         promotionTypeCode = 0;
                                                         else 
                                                         promotionTypeCode = eval(result[0][0]);
                                                         
                                                         rangeBasis = eval(result[0][1]);
                                                         
                                                         if (promotionTypeCode == 7) 
                                                         {
                                                         // $('#imgAdd').css({ "display": "block" });
                                                         
                                                         sessionStorage.setItem("orderpromovalue", result[0][2]);
                                                         $('#txtPromoKey1').val($("#divPromoKey").html());
                                                         $('#txtDescription1').val($("#divPromoDesc").html());  
                                                         $('#divLineItem').css({ "display": "none" });
                                                         $('#divTotalInvoice').css({ "display": "none" });                              
                                                         $('#divFreeSample').css({ "display": "block" });
                                                         
                                                         getFreeSampleList(0,0);                                        
                                                         }                                   
                                                         else if(promotionTypeCode == 1 || promotionTypeCode == 2 || promotionTypeCode == 0)
                                                         {                                        
                                                         sessionStorage.setItem("orderpromovalue", result[0][3]);
                                                         
                                                         $('#txtPromoKey').val($("#divPromoKey").html());
                                                         $('#txtDescription').val($("#divPromoDesc").html());                              
                                                         
                                                         $('#divTotalInvoice').css({ "display": "none" });                              
                                                         $('#divFreeSample').css({ "display": "none" });   
                                                         $('#divLineItem').css({ "display": "block" });
                                                         
                                                         getLineItemDetail(flag);
                                                         }
                                                         else if(promotionTypeCode == 5 || promotionTypeCode == 6)
                                                         {
                                                         sessionStorage.setItem("orderpromovalue", result[0][3]);
                                                         
                                                         $('#divFreeSample').css({ "display": "none" });   
                                                         $('#divLineItem').css({ "display": "none" });
                                                         $('#divTotalInvoice').css({ "display": "block" });
                                                         
                                                         getAmount(flag);     
                                                         }                                            
                        }
                        else 
                        {
                                    promotionTypeCode = -1; 
                                    rangeBasis = 0;
                        }
                    },
                    function()
					{
			   	 		console.warn("Error calling plugin");
					});
            	}
            }
            
            //Function for getting promotion amount for passed plan number
            function getAmount(flag)
            {
                var Qry = '';               
                
                
                if(promotionTypeCode != 7)
                {
                    if(promotionTypeCode == 0)
                    {
                        Qry = "select sum((CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * itemmaster.caseprice) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * salesorderdetail.salesprice)) As CurrentInvoiceAmount,sum(((CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * itemmaster.caseprice) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * salesorderdetail.salesprice) - promotiondetail.promotionamount))  As NewInvoiceAmount From promotiondetail inner join salesorderdetail on promotiondetail.itemcode = salesorderdetail.itemcode and salesorderdetail.routekey = "+ sessionStorage.getItem('RouteKey') +" and salesorderdetail.visitkey = "+ sessionStorage.getItem('VisitKey') +" inner join itemmaster on itemmaster.actualitemcode = promotiondetail.itemcode left join pricingdetail on pricingdetail.itemcode = promotiondetail.itemcode where promotiondetail.promotionplannumber = "+ planNumber +" and promotiondetail.routekey = "+ sessionStorage.getItem('RouteKey') +" and promotiondetail.visitkey = "+ sessionStorage.getItem('VisitKey') +"";
                    }
                    else if(promotionTypeCode == 1)
                    {
                        Qry = "select sum((CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * itemmaster.caseprice) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * salesorderdetail.salesprice)) As CurrentInvoiceAmount,sum(((CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * itemmaster.caseprice) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * salesorderdetail.salesprice) - promotiondetail.promotionamount))  As NewInvoiceAmount From promotiondetail inner join salesorderdetail on promotiondetail.itemcode = salesorderdetail.itemcode and salesorderdetail.routekey = "+ sessionStorage.getItem('RouteKey') +" and salesorderdetail.visitkey = "+ sessionStorage.getItem('VisitKey') +" inner join itemmaster on itemmaster.actualitemcode = promotiondetail.itemcode left join pricingdetail on pricingdetail.itemcode = promotiondetail.itemcode where promotiondetail.promotionplannumber = "+ planNumber +" and promotiondetail.routekey = "+ sessionStorage.getItem('RouteKey') +" and promotiondetail.visitkey = "+ sessionStorage.getItem('VisitKey') +"";
                    }
                    else if(promotionTypeCode == 2)
                    {
                        Qry = "select sum((CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * itemmaster.caseprice) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * salesorderdetail.salesprice)) As CurrentInvoiceAmount,(sum((CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * itemmaster.caseprice) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * salesorderdetail.salesprice)) - sum((CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * itemmaster.caseprice) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * salesorderdetail.salesprice)) *  (promotiondetail.promotionamount /100))   As NewInvoiceAmount From promotiondetail inner join salesorderdetail on promotiondetail.itemcode = salesorderdetail.itemcode and salesorderdetail.routekey = "+ sessionStorage.getItem('RouteKey') +" and salesorderdetail.visitkey = "+ sessionStorage.getItem('VisitKey') +" inner join itemmaster on itemmaster.actualitemcode = promotiondetail.itemcode left join pricingdetail on pricingdetail.itemcode = promotiondetail.itemcode where  promotiondetail.promotionplannumber = "+ planNumber +" and promotiondetail.routekey = "+ sessionStorage.getItem('RouteKey') +" and promotiondetail.visitkey = "+ sessionStorage.getItem('VisitKey') +"";
                    }
                    else if(promotionTypeCode == 3)
                    {
                        Qry = "select sum((CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * itemmaster.caseprice) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * salesorderdetail.salesprice)) As CurrentInvoiceAmount,sum((CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * itemmaster.caseprice) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * salesorderdetail.salesprice))  As NewInvoiceAmount From promotiondetail inner join salesorderdetail on promotiondetail.itemcode = salesorderdetail.itemcode and salesorderdetail.routekey = "+ sessionStorage.getItem('RouteKey') +" and salesorderdetail.visitkey = "+ sessionStorage.getItem('VisitKey') +" inner join itemmaster on itemmaster.actualitemcode = promotiondetail.itemcode left join pricingdetail on pricingdetail.itemcode = promotiondetail.itemcode where promotiondetail.promotionplannumber = "+ planNumber +" and promotiondetail.routekey = "+ sessionStorage.getItem('RouteKey') +" and promotiondetail.visitkey = "+ sessionStorage.getItem('VisitKey') +"";
                    }              
                    else if(promotionTypeCode == 5)
                    {
                       // Qry = "select sum((CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * itemmaster.caseprice) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * salesorderdetail.salesprice)) As CurrentInvoiceAmount,(sum((CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * itemmaster.caseprice) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * salesorderdetail.salesprice)) - promotiondetail.promotionamount) As NewInvoiceAmount From promotiondetail inner join salesorderdetail on promotiondetail.itemcode = salesorderdetail.itemcode and salesorderdetail.routekey = "+ sessionStorage.getItem('RouteKey') +" and salesorderdetail.visitkey = "+ sessionStorage.getItem('VisitKey') +" inner join itemmaster on itemmaster.actualitemcode = promotiondetail.itemcode left join pricingdetail on pricingdetail.itemcode = promotiondetail.itemcode where promotiondetail.promotionplannumber = "+ planNumber +" and promotiondetail.routekey = "+ sessionStorage.getItem('RouteKey') +" and promotiondetail.visitkey = "+ sessionStorage.getItem('VisitKey') +"";
                         Qry = "select (salesorderheader.totalsalesamount) as CurrentInvoiceAmount  , (salesorderheader.totalsalesamount - promotiondetail.promotionamount) as NewInvoiceAmount,promotiondetail.promotionamount,promotiondetail.salesamount from promotiondetail join salesorderheader on salesorderheader.visitkey = promotiondetail.visitkey and salesorderheader.routekey=promotiondetail.routekey  where promotiondetail.promotionplannumber = "+ planNumber +" and promotiondetail.routekey = "+ sessionStorage.getItem('RouteKey') +" and promotiondetail.visitkey = "+ sessionStorage.getItem('VisitKey') +"";
                    }
                    else if(promotionTypeCode == 6)
                    {
                        //Qry = "select sum((CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * itemmaster.caseprice) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * salesorderdetail.salesprice)) As CurrentInvoiceAmount,(sum((CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * itemmaster.caseprice) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * salesorderdetail.salesprice)) - sum((CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * itemmaster.caseprice) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * salesorderdetail.salesprice)) *  (promotiondetail.promotionamount /100))   As NewInvoiceAmount From promotiondetail inner join salesorderdetail on promotiondetail.itemcode = salesorderdetail.itemcode and salesorderdetail.routekey = "+ sessionStorage.getItem('RouteKey') +" and salesorderdetail.visitkey = "+ sessionStorage.getItem('VisitKey') +" inner join itemmaster on itemmaster.actualitemcode = promotiondetail.itemcode left join pricingdetail on pricingdetail.itemcode = promotiondetail.itemcode where  promotiondetail.promotionplannumber = "+ planNumber +" and promotiondetail.routekey = "+ sessionStorage.getItem('RouteKey') +" and promotiondetail.visitkey = "+ sessionStorage.getItem('VisitKey') +"";
                        if(repeatingrange ==1)
                        {
                            getAmountrepeate(flag);
                        }
                        else 
                        {
                        Qry = "select (salesorderheader.totalsalesamount) as CurrentInvoiceAmount  , ((salesorderheader.totalsalesamount) - (salesorderheader.totalsalesamount) * (promotiondetail.promotionamount/100.0)) as NewInvoiceAmount,((promotiondetail.promotionamount)/100.0) as promotionamount,promotiondetail.oldpromotionamount as salesamount from promotiondetail join salesorderheader on salesorderheader.visitkey = promotiondetail.visitkey and salesorderheader.routekey=promotiondetail.routekey  where promotiondetail.promotionplannumber = "+ planNumber +" and promotiondetail.routekey = "+ sessionStorage.getItem('RouteKey') +" and promotiondetail.visitkey = "+ sessionStorage.getItem('VisitKey') +"";
                        }
                    }
                   /* else if(promotionTypeCode == 7)
                    {
                        Qry = "select sum((CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * itemmaster.caseprice) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * salesorderdetail.salesprice)) As CurrentInvoiceAmount,(sum((CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * itemmaster.caseprice) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * salesorderdetail.salesprice))) As NewInvoiceAmount From promotiondetail inner join salesorderdetail on promotiondetail.itemcode = salesorderdetail.itemcode and salesorderdetail.routekey = "+ sessionStorage.getItem('RouteKey') +" and salesorderdetail.visitkey = "+ sessionStorage.getItem('VisitKey') +" inner join itemmaster on itemmaster.actualitemcode = promotiondetail.itemcode left join pricingdetail on pricingdetail.itemcode = promotiondetail.itemcode where promotiondetail.promotionplannumber = "+ planNumber +" and promotiondetail.routekey = "+ sessionStorage.getItem('RouteKey') +" and promotiondetail.visitkey = "+ sessionStorage.getItem('VisitKey') +"";
                    }*/
                    console.log(Qry);
                }
                
                if(platform=='iPad')
           		{
                Cordova.exec(function(result) {
                              if(result.length > 0 )
                              {
                                  dataAmount = result;                         
                              bindinvoice(dataAmount,flag);
                              }
                              },
                              function(error) {
                                    navigator.notification.alert("Error in binding promotion amount : " + error);
                              },
                              "PluginClass", 
                              "GetdataMethod", 
                              [Qry]);        
            	}
            	else if(platform=='Android')
            	{
            		window.plugins.DataBaseHelper.select(Qry,function(result)
					{
            			if(result.array!=undefined)
                    	{
                    		dataAmount = result;
                    		var array = $.map(dataAmount.array, function (item, index) {               
                			return [[item.CurrentInvoiceAmount, item.NewInvoiceAmount,item.promotionamount,item.salesamount]];
            				});

            				dataAmount = array;
bindinvoice(dataAmount,flag);
                                                       
                                                         }                
                },
                    function()
					{
			   	 		console.warn("Error calling plugin");
					});
            	}
            } 
            function bindinvoice(dataAmount,flag)
            {
                if (promotionTypeCode == 5) 
                {
                    
                    
                    if(flag==0)
                    {
                        if(sessionStorage.getItem("invoiceamount")==0)
                        {
                            dataAmount[0][0] = eval(dataAmount[0][0]);
                        }
                        else
                        {
                            dataAmount[0][0] = sessionStorage.getItem("invoiceamount");
                        }
                        dataAmount[0][1] = eval(dataAmount[0][0]) - eval(dataAmount[0][2]);
                    }
                    else if(flag==1)
                    {
                        dataAmount[0][0] =eval(sessionStorage.getItem("currentinvoice")) + eval(dataAmount[0][2]);
                        dataAmount[0][1] = eval(sessionStorage.getItem("currentinvoice"));
                    }
                    else if(flag==2)
                    {
                        dataAmount[0][0] =eval(sessionStorage.getItem("currentinvoice"));
                        dataAmount[0][1] = eval(sessionStorage.getItem("invoiceamount"));
                    }
                    var promoactual = eval(dataAmount[0][2]);
                    sessionStorage.setItem("invoiceamount", dataAmount[0][1]);
                    sessionStorage.setItem("currentinvoice", dataAmount[0][0]);
                }
                
                if (promotionTypeCode == 6) {                    
                    
                    
                    
                    if(flag==0)
                    {
                        if(sessionStorage.getItem("invoiceamount")==0)
                        {
                            dataAmount[0][0] = eval(dataAmount[0][0]);
                        }
                        else
                        {
                            dataAmount[0][0] = sessionStorage.getItem("invoiceamount");
                        }
                        //dataAmount[0][1] = eval(dataAmount[0][0]) - eval(dataAmount[0][2]); 
                        
                        dataAmount[0][1] = eval(dataAmount[0][0]) - (eval(dataAmount[0][3]) * eval(dataAmount[0][2]));
                        
                    }
                    else if(flag==1)
                    {
                        dataAmount[0][0] =eval(sessionStorage.getItem("currentinvoice")) +(eval(dataAmount[0][3]) * eval(dataAmount[0][2]));
                        dataAmount[0][1] = eval(sessionStorage.getItem("currentinvoice"));
                    }
                    else if(flag==2)
                    {
                        dataAmount[0][0] =eval(sessionStorage.getItem("currentinvoice"));
                        dataAmount[0][1] = eval(sessionStorage.getItem("invoiceamount"));
                    }
                    console.log("--"+dataAmount[0][2]);
                   
                    var promoactual = eval(dataAmount[0][2]) *100;
                     console.log("promoactual"+promoactual);
                    sessionStorage.setItem("invoiceamount", dataAmount[0][1]);
                    sessionStorage.setItem("currentinvoice", dataAmount[0][0]);
                }
                
                
                if(promotionTypeCode == 6)
                {
                    $("#app1").show();
                    $("#app2").show();
                    $("#app3").hide();
                    
                    $("#divPromo").html(eval(promoactual).toFixed(sessionStorage.getItem('decimalplace'))+"%");
                    $("#divqualifiedAmount").html(eval(dataAmount[0][3]).toFixed(sessionStorage.getItem('decimalplace')));
                }
                else
                {
                    $("#app1").hide();
                    $("#app2").hide();
                    $("#app3").show();
                    
                }
                $("#divCIAmount").html(eval(dataAmount[0][0]).toFixed(sessionStorage.getItem('decimalplace')));
                $("#divNIAmount").html(eval(dataAmount[0][1]).toFixed(sessionStorage.getItem('decimalplace')));
               
                $("#divPromotionAmount").html(eval(dataAmount[0][0] - dataAmount[0][1]).toFixed(sessionStorage.getItem('decimalplace')));
                
            }
            function getAmountrepeate(flag)
            {
                
                var selectQry ="select promotiondetail.oldpromotionamount,promotiondetail.promotionamount from promotiondetail where promotiondetail.promotionplannumber = "+ planNumber +" and promotiondetail.routekey = "+ sessionStorage.getItem('RouteKey') +" and promotiondetail.visitkey = "+ sessionStorage.getItem('VisitKey') +"";
                
                if(platform=='iPad')
           		{
                    Cordova.exec(function(result) {
                                  if(result.length > 0 )
                                  {
                                  
                                  
                                  var oldamount = result[0][0];
                                  var promoamount = result[0][1];
                                  
                                  var finalamount = 0;
                                  var totalamount = eval(oldamount);
                                  while( totalamount >= eval(rangelow))
                                  {
                                  finalamount = finalamount + eval(rangelow) * (promoamount/100);
                                  totalamount = totalamount - eval(rangelow);
                                  }
                                  Qry = "select (salesorderheader.totalsalesamount) as CurrentInvoiceAmount  , ((salesorderheader.totalsalesamount) - ("+finalamount+") as NewInvoiceAmount,("+finalamount+") as amount,promotiondetail.oldpromotionamount from promotiondetail join salesorderheader on salesorderheader.visitkey = promotiondetail.visitkey and salesorderheader.routekey=promotiondetail.routekey  where promotiondetail.promotionplannumber = "+ planNumber +" and promotiondetail.routekey = "+ sessionStorage.getItem('RouteKey') +" and promotiondetail.visitkey = "+ sessionStorage.getItem('VisitKey') +"";
                                 
                                  Cordova.exec(function(result) {
                                                if(result.length > 0 )
                                                {
                                                dataAmount = result;                         
                                                bindinvoice(dataAmount,flag);
                                                }
                                                },
                                                function(error) {
                                                navigator.notification.alert("Error in binding promotion amount : " + error);
                                                },
                                                "PluginClass", 
                                                "GetdataMethod", 
                                                [Qry]);
                                  }
                                  },
                                  function(error) {
                                  navigator.notification.alert("Error in binding promotion amount : " + error);
                                  },
                                  "PluginClass", 
                                  "GetdataMethod", 
                                  [selectQry]); 
                    
            	}
            	else if(platform=='Android')
            	{
            		window.plugins.DataBaseHelper.select(selectQry,function(result)
                                                         {
                                                         if(result.array!=undefined)
                                                         {
                                                         var oldamount = result.array[0].oldpromotionamount;
                                                         var promoamount = result.array[0].promotionamount;
                                                         
                                                         var finalamount = 0;
                                                         var totalamount = eval(oldamount);
                                                         while( totalamount >= eval(rangelow))
                                                         {
                                                         finalamount = finalamount + eval(rangelow) * (promoamount/100);
                                                         totalamount = totalamount - eval(rangelow);
                                                         }
                                                        Qry = "select (salesorderheader.totalsalesamount) as CurrentInvoiceAmount  , ((salesorderheader.totalsalesamount) - ("+finalamount+") as NewInvoiceAmount,("+finalamount+") as promotionamount,promotiondetail.oldpromotionamount from promotiondetail join salesorderheader on salesorderheader.visitkey = promotiondetail.visitkey and salesorderheader.routekey=promotiondetail.routekey  where promotiondetail.promotionplannumber = "+ planNumber +" and promotiondetail.routekey = "+ sessionStorage.getItem('RouteKey') +" and promotiondetail.visitkey = "+ sessionStorage.getItem('VisitKey') +"";
                                                         window.plugins.DataBaseHelper.select(Qry,function(result)
                                                                                              {
                                                                                              if(result.array!=undefined)
                                                                                              {
                                                                                              dataAmount = result;
                                                                                              var array = $.map(dataAmount.array, function (item, index) {               
                                                                                                                return [[item.CurrentInvoiceAmount, item.NewInvoiceAmount,item.promotionamount,item.oldpromotionamount]];
                                                                                                                });
                                                                                              
                                                                                              dataAmount = array;
                                                                                              bindinvoice(dataAmount,flag);
                                                                                              }
                                                                                              },
                                                                                              function()
                                                                                              {
                                                                                              console.warn("Error calling plugin");
                                                                                              });
                                                         }
                                                         },
                                                         function()
                                                         {
                                                         console.warn("Error calling plugin");
                                                         });
                    
            	}
            }
          function getLineItemDetail(flag)
            {
                var lintItemQry = '';
                
                              
                if(promotionTypeCode == 1 || promotionTypeCode == 0)
                {
                    
                    
                    lintItemQry = "select CASE WHEN '"+ sessionStorage.getItem('CheckCode') +"' = 'alternatecode' THEN itemmaster.alternatecode ELSE itemmaster.actualitemcode END AS Code,CASE WHEN '"+ sessionStorage.getItem('Language') +"' = 'en' THEN itemmaster.itemdescription ELSE itemmaster.arbitemdescription END As Description,round(promotiondetail.oldpromotionamount,2) as oldamount,round((promotiondetail.oldpromotionamount - ifnull(promotiondetail.promotionamount,0)),2) as newamount,totalsalesamount From promotiondetail inner join promokeydetail on promotiondetail.promotionplannumber = promokeydetail.plannumber and promotionkey = (select promotionkey from customermaster  where customercode = " + sessionStorage.getItem('customerid') + ") inner join salesorderdetail on promotiondetail.itemcode = salesorderdetail.itemcode and salesorderdetail.routekey = " + sessionStorage.getItem('RouteKey') + " and salesorderdetail.visitkey = " + sessionStorage.getItem('VisitKey') + " inner join salesorderheader on salesorderheader.routekey=salesorderdetail.routekey and salesorderheader.visitkey=salesorderdetail.visitkey inner join itemmaster on promotiondetail.itemcode = itemmaster.actualitemcode where promotiondetail.promotionplannumber = " + planNumber + " and promotiondetail.routekey = " + sessionStorage.getItem('RouteKey') + " and promotiondetail.visitkey = " + sessionStorage.getItem('VisitKey') + "";                
                }
                else 
                {
                   
                    
                   /* lintItemQry = "select CASE WHEN '"+ sessionStorage.getItem('CheckCode') +"' = 'alternatecode' THEN itemmaster.alternatecode ELSE itemmaster.actualitemcode END AS Code,CASE WHEN '"+ sessionStorage.getItem('Language') +"' = 'en' THEN itemmaster.itemdescription ELSE itemmaster.arbitemdescription END As Description,round(promotiondetail.oldpromotionamount,2) as oldamount,round((promotiondetail.oldpromotionamount - ifnull(salesorderdetail.promoamount,0)),2) as newamount From promotiondetail inner join promokeydetail on promotiondetail.promotionplannumber = promokeydetail.plannumber and promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") inner join salesorderdetail on promotiondetail.itemcode = salesorderdetail.itemcode and salesorderdetail.routekey = " + sessionStorage.getItem('RouteKey') + " and salesorderdetail.visitkey = " + sessionStorage.getItem('VisitKey') + " inner join itemmaster on promotiondetail.itemcode = itemmaster.actualitemcode where promotiondetail.promotionplannumber = " + planNumber + " and promotiondetail.routekey = " + sessionStorage.getItem('RouteKey') + " and promotiondetail.visitkey = " + sessionStorage.getItem('VisitKey') + "";*/  
                    if(repeatingrange == 1)
                    {
                        selectlineitemrepeat(flag);
                    }
                    else
                    {
                    	lintItemQry = "select CASE WHEN '"+ sessionStorage.getItem('CheckCode') +"' = 'alternatecode' THEN itemmaster.alternatecode ELSE itemmaster.actualitemcode END AS Code,CASE WHEN '"+ sessionStorage.getItem('Language') +"' = 'en' THEN itemmaster.itemdescription ELSE itemmaster.arbitemdescription END As Description,round(promotiondetail.oldpromotionamount,2) as oldamount,((promotiondetail.oldpromotionamount - (promotiondetail.promotionamount))) as newamount,totalsalesamount From promotiondetail inner join promokeydetail on promotiondetail.promotionplannumber = promokeydetail.plannumber and promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") inner join salesorderdetail on promotiondetail.itemcode = salesorderdetail.itemcode and salesorderdetail.routekey = " + sessionStorage.getItem('RouteKey') + " and salesorderdetail.visitkey = " + sessionStorage.getItem('VisitKey') + " inner join salesorderheader on salesorderheader.routekey=salesorderdetail.routekey and salesorderheader.visitkey=salesorderdetail.visitkey inner join itemmaster on promotiondetail.itemcode = itemmaster.actualitemcode where promotiondetail.promotionplannumber = " + planNumber + " and promotiondetail.routekey = " + sessionStorage.getItem('RouteKey') + " and promotiondetail.visitkey = " + sessionStorage.getItem('VisitKey') + "";
                    }
                   
                }
                console.log(lintItemQry);
                if(platform=='iPad')
           		{
                    Cordova.exec(function(result) {
                                  if(result.length > 0 )
                                  {
                                        ClearTable();
                                        BindLineItem(result,flag);     
                                        
                                  }
                                  },
                                  function(error) {
                                    navigator.notification.alert("Error in binding line item detail : " + error);
                                  },
                                  "PluginClass", 
                                  "GetdataMethod",
                                  [lintItemQry]); 
            	}
                else if(platform=='Android')
                {
                        window.plugins.DataBaseHelper.select(lintItemQry,function(result)
                                                            {
                                                                if(result.array != undefined)
                                                                {
                                                                    ClearTable();
                                                                    BindLineItem(result,flag);     
                                                                }
                                                            },
                                                            function()
                                                            {
                                                             console.warn("Error calling plugin");
                                                            });
                }
            }
            function selectlineitemrepeat(flag)
            {
                
                var selectqry = "select oldpromotionamount,promotionamount,itemcode from promotiondetail where promotiondetail.promotionplannumber = " + planNumber + " and promotiondetail.routekey = " + sessionStorage.getItem('RouteKey') + " and promotiondetail.visitkey = " + sessionStorage.getItem('VisitKey') + "";
                
                console.log(selectqry);
                
                
                if(platform=='iPad')
           		{
                    
                    Cordova.exec(function(result) {
                                  if(result.length > 0 )
                                  {
                                  var where ='CASE ';
                                  for(i=0;i<result.length;i++)
                                  {
                                  
                                  var oldamount = result[i][0];
                                  var promoamount = result[i][1];
                                  var itemcodes = result[i][2];
                                  
                                  var finalamount = 0;
                                  var totalamount = eval(oldamount);
                                  while( totalamount >= eval(rangelow))
                                  {
                                  finalamount = finalamount + eval(rangelow) * (promoamount/100);
                                  totalamount = totalamount - eval(rangelow);
                                  }
                                  where =where + "when promotiondetail.itemcode="+itemcodes+" THEN "+finalamount+" ";
                                  
                                  }
                                  where = where +"END";
                                  console.log(where);
                                  lintItemQry = "select CASE WHEN '"+ sessionStorage.getItem('CheckCode') +"' = 'alternatecode' THEN itemmaster.alternatecode ELSE itemmaster.actualitemcode END AS Code,CASE WHEN '"+ sessionStorage.getItem('Language') +"' = 'en' THEN itemmaster.itemdescription ELSE itemmaster.arbitemdescription END As Description,round(promotiondetail.oldpromotionamount,2) as oldamount,round((promotiondetail.oldpromotionamount - "+where+"),2) as newamount,totalsalesamount From promotiondetail inner join promokeydetail on promotiondetail.promotionplannumber = promokeydetail.plannumber and promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") inner join salesorderdetail on promotiondetail.itemcode = salesorderdetail.itemcode and salesorderdetail.routekey = " + sessionStorage.getItem('RouteKey') + " and salesorderdetail.visitkey = " + sessionStorage.getItem('VisitKey') + " inner join salesorderheader on salesorderheader.routekey=salesorderdetail.routekey and salesorderheader.visitkey=salesorderdetail.visitkey inner join itemmaster on promotiondetail.itemcode = itemmaster.actualitemcode where promotiondetail.promotionplannumber = " + planNumber + " and promotiondetail.routekey = " + sessionStorage.getItem('RouteKey') + " and promotiondetail.visitkey = " + sessionStorage.getItem('VisitKey') + "";
                                 
                                  console.log(lintItemQry);
                                  Cordova.exec(function(result1) {
                                                if(result1.length > 0 )
                                                {
                                                
                                                ClearTable();
                                                BindLineItem(result1,flag);     
                                                
                                                }
                                                },
                                                function(error) {
                                                navigator.notification.alert("Error in binding line item detail : " + error);
                                                },
                                                "PluginClass", 
                                                "GetdataMethod",
                                                [lintItemQry]); 
                                  
                                  
                                  }
                                  },
                                  function(error) {
                                  navigator.notification.alert("Error in binding line item detail : " + error);
                                  },
                                  "PluginClass", 
                                  "GetdataMethod",
                                  [selectqry]); 
                    
            	}
                else if(platform=='Android')
                {
                    window.plugins.DataBaseHelper.select(selectqry,function(result)
                                                         {
                                                         if(result.array != undefined)
                                                         {
                                                         var where ='CASE ';
                                                         for(i=0;i<result.array.length;i++)
                                                         {
                                                         
                                                         var oldamount = result.array[i][0];
                                                         var promoamount = result.array[i][1];
                                                         var itemcodes = result.array[i][2];
                                                         
                                                         var finalamount = 0;
                                                         var totalamount = eval(oldamount);
                                                         while( totalamount >= eval(rangelow))
                                                         {
                                                         finalamount = finalamount + promoamount;
                                                         totalamount = totalamount - eval(rangelow);
                                                         }
                                                         where =where + "when promotiondetail.itemcode="+itemcodes+" THEN "+finalamount+" ";
                                                         
                                                         } 
                                                         where = where +"END";
                                                         console.log(where);
                                                          lintItemQry = "select CASE WHEN '"+ sessionStorage.getItem('CheckCode') +"' = 'alternatecode' THEN itemmaster.alternatecode ELSE itemmaster.actualitemcode END AS Code,CASE WHEN '"+ sessionStorage.getItem('Language') +"' = 'en' THEN itemmaster.itemdescription ELSE itemmaster.arbitemdescription END As Description,round(promotiondetail.oldpromotionamount,2) as oldamount,round((promotiondetail.oldpromotionamount - "+where+"),2) as newamount,totalsalesamount From promotiondetail inner join promokeydetail on promotiondetail.promotionplannumber = promokeydetail.plannumber and promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") inner join salesorderdetail on promotiondetail.itemcode = salesorderdetail.itemcode and salesorderdetail.routekey = " + sessionStorage.getItem('RouteKey') + " and salesorderdetail.visitkey = " + sessionStorage.getItem('VisitKey') + " inner join salesorderheader on salesorderheader.routekey=salesorderdetail.routekey and salesorderheader.visitkey=salesorderdetail.visitkey inner join itemmaster on promotiondetail.itemcode = itemmaster.actualitemcode where promotiondetail.promotionplannumber = " + planNumber + " and promotiondetail.routekey = " + sessionStorage.getItem('RouteKey') + " and promotiondetail.visitkey = " + sessionStorage.getItem('VisitKey') + "";
                                                         console.log(lintItemQry);
                                                         
                                                         window.plugins.DataBaseHelper.select(lintItemQry,function(result)
                                                                                              {
                                                                                              if(result.array != undefined)
                                                                                              {
                                                                                              ClearTable();
                                                                                              BindLineItem(result,flag);     
                                                                                              }
                                                                                              },
                                                                                              function()
                                                                                              {
                                                                                              console.warn("Error calling plugin");
                                                                                              });    
                                                         }
                                                         
                                                         },
                                                         function()
                                                         {
                                                         console.warn("Error calling plugin");
                                                         });
                    
                }
            }
            
            //Bind data dynamically
            function BindLineItem(result,flag)
            {

            	$("#tblLineHeader tr th:eq(2)").hide();
            	$("#tblLineContent tr td:eq(2)").hide();
                
                var CellCount = $("#tblLineHeader tr:eq(0) th").length;
               
                dataLineItem = result;
                
                if(platform=='Android')
                {
                    var result = $.map(result.array, function (item, index) {               
                                      return [[item.Code+"-"+item.Description, eval((item.oldamount)-(item.newamount)),item.oldamount,item.newamount,item.totalsalesamount]];
                                });   
                    
                    dataLineItem = result;
                }
                
               // lineItem1 = 0;
               // lineItem2 = 0;
                if(promotionTypeCode == 0)
                {
                    lineItem0 = 0;
                    lineold0 = 0;
                    for(k=0;k<dataLineItem.length;k++)
                    {
                        //lineItem1 += eval(dataLineItem[i][3]);
                        lineItem0 += eval(dataLineItem[k][3]);
                        lineold0 += eval(dataLineItem[k][2]);//changes i from k by pratik
                    }
                    if(flag==0)
                    {
                        if(sessionStorage.getItem("invoiceamount") == 0)
                        {
                            var currentinvoice = eval(dataLineItem[0][4]);
                        }
                        else
                        {
                            var currentinvoice = sessionStorage.getItem("invoiceamount");
                        }
                        var newinvoice=currentinvoice - eval(lineold0 - lineItem0);
                    }
                    else if(flag==1)
                    {
                        
                        var currentinvoice = eval(sessionStorage.getItem("currentinvoice"))+ eval(lineold0 - lineItem0);
                        var newinvoice=eval(sessionStorage.getItem("currentinvoice"));
                    }
                    else if(flag==2)
                    {
                        var currentinvoice = eval(sessionStorage.getItem("currentinvoice"));
                        var newinvoice=eval(sessionStorage.getItem("invoiceamount"));
                    }
                    
                    
                    
                    $('#txtcurrentinvoice').val(eval(currentinvoice).toFixed(sessionStorage.getItem('decimalplace')));
                    $('#txtnewinvoice').val(eval(newinvoice).toFixed(sessionStorage.getItem('decimalplace')));
                    $('#txtDiscount').val(eval(currentinvoice-newinvoice).toFixed(sessionStorage.getItem('decimalplace')));
                    
                    sessionStorage.setItem("invoiceamount", newinvoice);
                    sessionStorage.setItem("currentinvoice", currentinvoice);
                }
                else if(promotionTypeCode == 1)
                {
                    lineItem1 = 0;
                    lineold = 0;
                    for(k=0;k<dataLineItem.length;k++)
                    {
                        //lineItem1 += eval(dataLineItem[i][3]);
                        lineItem1 += eval(dataLineItem[k][3]);
                        lineold += eval(dataLineItem[k][2]);//changes i from k by pratik
                    }
                    if(flag==0)
                    {
                        if(sessionStorage.getItem("invoiceamount") == 0)
                        {
                            var currentinvoice = eval(dataLineItem[0][4]);
                        }
                        else
                        {
                            var currentinvoice = sessionStorage.getItem("invoiceamount");
                        }
                        var newinvoice=currentinvoice - eval(lineold - lineItem1);
                    }
                    else if(flag==1)
                    {
                        
                        var currentinvoice = eval(sessionStorage.getItem("currentinvoice"))+ eval(lineold - lineItem1);
                        var newinvoice=eval(sessionStorage.getItem("currentinvoice"));
                    }
                    else if(flag==2)
                    {
                        var currentinvoice = eval(sessionStorage.getItem("currentinvoice"));
                        var newinvoice=eval(sessionStorage.getItem("invoiceamount"));
                    }
                    
                    $('#txtDiscount').val(eval(currentinvoice-newinvoice).toFixed(sessionStorage.getItem('decimalplace')));
                    
                    $('#txtcurrentinvoice').val(eval(currentinvoice).toFixed(sessionStorage.getItem('decimalplace')));
                    $('#txtnewinvoice').val(eval(newinvoice).toFixed(sessionStorage.getItem('decimalplace')));
                    sessionStorage.setItem("invoiceamount", newinvoice);
                    sessionStorage.setItem("currentinvoice", currentinvoice);
                }
                else 
                {
                    lineItem2 = 0;
                    lineold2 = 0;
                    for(k=0;k<dataLineItem.length;k++)
                    {
                        //lineItem2 += eval(dataLineItem[i][3]);
                        lineItem2 += eval(dataLineItem[k][3]);
                        lineold2 += eval(dataLineItem[k][2]);// changes i from k by pratik
                    }
                    if(flag==0)
                    {
                        if(sessionStorage.getItem("invoiceamount") == 0)
                        {
                            var currentinvoice = eval(dataLineItem[0][4]);
                        }
                        else
                        {
                            var currentinvoice = sessionStorage.getItem("invoiceamount");
                        }
                        var newinvoice=currentinvoice - eval(lineold2 - lineItem2);
                    }
                    else if(flag==1)
                    {
                        
                        var currentinvoice = eval(sessionStorage.getItem("currentinvoice"))+ eval(lineold2 - lineItem2);
                        var newinvoice=eval(sessionStorage.getItem("currentinvoice"));
                    }
                    else if(flag==2)
                    {
                        var currentinvoice = eval(sessionStorage.getItem("currentinvoice"));
                        var newinvoice=eval(sessionStorage.getItem("invoiceamount"));
                    }
                    $('#txtDiscount').val(eval(currentinvoice-newinvoice).toFixed(sessionStorage.getItem('decimalplace')));
                    
                    $('#txtcurrentinvoice').val(eval(currentinvoice).toFixed(sessionStorage.getItem('decimalplace')));
                    $('#txtnewinvoice').val(eval(newinvoice).toFixed(sessionStorage.getItem('decimalplace')));
                    sessionStorage.setItem("invoiceamount", newinvoice);
                    sessionStorage.setItem("currentinvoice", currentinvoice);
                }
                
                for (i = 0; i < dataLineItem.length; i++) 
                {
                    var r = "<tr class='contentFont'>";
                    for (j = 0; j < CellCount; j++) 
                    {
                        var temp = (j == 0) ? 'class = leftAlign' : '';
                        
                        if (j == CellCount - 1)
                            temp += "class = 'last'";
                        if(j>0)
                        dataLineItem[i][j] =eval(dataLineItem[i][j]).toFixed(sessionStorage.getItem('decimalplace'));
                        
						if(j==2){
                        	temp += " style='display:none;'";
                        }
                        
                        var c = "<td " + temp + ">" + dataLineItem[i][j] + "</td>";   
                        r += c;
                    }
                    r += "</tr>";
                      
                    $('#tblLineContent tbody').append(r);
                }
                
                $("#tblLineContent tr:odd").addClass('oddRow');
                $("#tblLineContent tr:even").addClass('evenRow');        
                
                $("#tblLineContent tr:eq(1)").trigger('click');
            }   
            
            function ClearTable() {
                $("#tblLineContent  tr:gt(0)").remove();
            }
            
            
            //Function for bind free sample list
            function getFreeSampleList(flag,clickedRow)
            {   
                promovalue = sessionStorage.getItem("orderpromovalue");
                console.log("select CASE WHEN '"+ sessionStorage.getItem('CheckCode') +"' = 'alternatecode' THEN itemmaster.alternatecode ELSE itemmaster.actualitemcode END AS Code,CASE WHEN '"+ sessionStorage.getItem('Language') +"' = 'en' THEN itemmaster.itemdescription ELSE itemmaster.arbitemdescription END As Description,ifnull(salesorderdetail.salesqty,0) as salesqty,itemmaster.unitspercase,ifnull(freesampleqty,0) as freesampleqty,ifnull(salesorderdetail.salesprice,0) as salesprice,itemmaster.actualitemcode,promokeydetail.rangebasis,promotiondetail.promotionquantity from promokeydetail inner join promotiondetail on promotiondetail.promotionplannumber=promokeydetail.plannumber and promotiondetail.promotionplannumber = "+ sessionStorage.getItem('orderplannumber') +" and promotiondetail.visitkey="+ sessionStorage.getItem('VisitKey') +" and promotiondetail.routekey = "+ sessionStorage.getItem('RouteKey') +" left join salesorderdetail on promotiondetail.itemcode = salesorderdetail.itemcode and salesorderdetail.routekey = "+ sessionStorage.getItem('RouteKey') +" and salesorderdetail.visitkey  = "+ sessionStorage.getItem('VisitKey') +" inner join itemmaster on promotiondetail.itemcode = itemmaster.actualitemcode where promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = "+ sessionStorage.getItem('customerid') +") and promokeydetail.plannumber = "+ sessionStorage.getItem('orderplannumber') +"");
                $('#txFreeQty').val(parseInt(promovalue));
                
                if(platform=='iPad')
                {
                Cordova.exec(function(result) {                      
                              
                              ClearTableContent();
                              BindData(result);
                             
                              if(flag=='true')
                              UpdateInvoiceDetail(result.length);
                              
                              },
                              function(error) {
                                alert("Error in binding free sample detail : " + error);
                              },
                              "PluginClass", 
                              "GetdataMethod",                           
                              ["select CASE WHEN '"+ sessionStorage.getItem('CheckCode') +"' = 'alternatecode' THEN itemmaster.alternatecode ELSE itemmaster.actualitemcode END AS Code,CASE WHEN '"+ sessionStorage.getItem('Language') +"' = 'en' THEN itemmaster.itemdescription ELSE itemmaster.arbitemdescription END As Description,ifnull(salesorderdetail.salesqty,0) as salesqty,itemmaster.unitspercase,ifnull(freesampleqty,0) as freesampleqty,ifnull(salesorderdetail.salesprice,0) as salesprice,ifnull(salesorderdetail.salescaseprice,0) as salescaseprice,itemmaster.actualitemcode,promokeydetail.rangebasis,promotiondetail.promotionquantity from promokeydetail inner join promotiondetail on promotiondetail.promotionplannumber=promokeydetail.plannumber and promotiondetail.promotionplannumber = "+ sessionStorage.getItem('orderplannumber') +" and promotiondetail.visitkey="+ sessionStorage.getItem('VisitKey') +" and promotiondetail.routekey = "+ sessionStorage.getItem('RouteKey') +" left join salesorderdetail on promotiondetail.itemcode = salesorderdetail.itemcode and salesorderdetail.routekey = "+ sessionStorage.getItem('RouteKey') +" and salesorderdetail.visitkey  = "+ sessionStorage.getItem('VisitKey') +" inner join itemmaster on promotiondetail.itemcode = itemmaster.actualitemcode where promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = "+ sessionStorage.getItem('customerid') +") and promokeydetail.plannumber = "+ sessionStorage.getItem('orderplannumber') +""]);
                }
                else if(platform=='Android')
                {
    	var Qry="select DISTINCT CASE WHEN '"+ sessionStorage.getItem('CheckCode')+"' = 'alternatecode' THEN "
		+"itemmaster.alternatecode ELSE itemmaster.actualitemcode END AS Code,CASE WHEN '"+ sessionStorage.getItem('Language') 
		+"' = 'en' THEN itemmaster.itemdescription ELSE itemmaster.arbitemdescription END As Description,ifnull"
		+"(salesorderdetail.salesqty,0) as salesqty,itemmaster.unitspercase as unitspercase,ifnull((SELECT promotionfreetemp.promofreeqty"
		+" FROM promotionfreetemp WHERE promotionfreetemp.promotionplannumber = promotiondetail.promotionplannumber and "
		+"promotionfreetemp.itemcode = promotiondetail.itemcode),0) as freesampleqty,"
		+"ifnull(salesorderdetail.salesprice,0) as salesprice,ifnull(salesorderdetail.salescaseprice,0) as salescaseprice,"
		+"itemmaster.actualitemcode as actualitemcode,promokeydetail.rangebasis as rangebasis,promotiondetail.promotionquantity as promotionquantity,productgroupdetail.itemqty as orginal_unit,"
		+"0 as alternate_unit,promotiondetail.isalternateitem as isalternateitem from promokeydetail inner"
		+" join promotiondetail on promotiondetail.promotionplannumber=promokeydetail.plannumber and "
		+"promotiondetail.promotionplannumber = "+ sessionStorage.getItem('orderplannumber') +" and promotiondetail.visitkey="
		+ sessionStorage.getItem('VisitKey') +" and promotiondetail.routekey = "+ sessionStorage.getItem('RouteKey') 
		+" left join salesorderdetail on promotiondetail.itemcode = salesorderdetail.itemcode and salesorderdetail.routekey = "
		+ sessionStorage.getItem('RouteKey') +" and salesorderdetail.visitkey  = "+ sessionStorage.getItem('VisitKey') 
		+" inner join itemmaster on promotiondetail.itemcode = itemmaster.actualitemcode  inner join productgroupdetail on "
		+"productgroupdetail.itemcode=itemmaster.actualitemcode where promokeydetail.promotionkey"
		+" = (select promotionkey from customermaster where customercode = "+ sessionStorage.getItem('customerid') +") "
		+"and promokeydetail.plannumber = "+ sessionStorage.getItem('orderplannumber') +" AND productgroupdetail.groupnumber="
		+"promokeydetail.assignmentgroup UNION ALL "
		+"select DISTINCT CASE WHEN '"+ sessionStorage.getItem('CheckCode')+"' = 'alternatecode' THEN itemmaster.alternatecode"
		+" ELSE itemmaster.actualitemcode END AS Code,CASE WHEN '"+ sessionStorage.getItem('Language')+"' = 'en' THEN"
		+" itemmaster.itemdescription ELSE itemmaster.arbitemdescription END As Description,ifnull (salesorderdetail.salesqty,0)"
		+" as salesqty,itemmaster.unitspercase as unitspercase,ifnull((SELECT promotionfreetemp.promofreeqty FROM promotionfreetemp WHERE"
		+" promotionfreetemp.promotionplannumber = promotiondetail.promotionplannumber and "
		+"promotionfreetemp.itemcode = promotiondetail.itemcode),0) as freesampleqty, ifnull(salesorderdetail.salesprice,0) "
		+"as salesprice,ifnull(salesorderdetail.salescaseprice,0) as salescaseprice, itemmaster.actualitemcode,"
		+"promokeydetail.rangebasis as rangebasis,promotiondetail.promotionquantity as promotionquantity,tbl_productgroupdetailaltitem.orginal_unit as orginal_unit,"
		+"tbl_productgroupdetailaltitem.alternate_unit as alternate_unit,promotiondetail.isalternateitem as isalternateitem  from promokeydetail inner join promotiondetail on "
		+"promotiondetail.promotionplannumber=promokeydetail.plannumber and promotiondetail.promotionplannumber = "
		+ sessionStorage.getItem('orderplannumber') +" and promotiondetail.visitkey=" + sessionStorage.getItem('VisitKey') 
		+" and promotiondetail.routekey = "+ sessionStorage.getItem('RouteKey')+" left join salesorderdetail on "
		+"promotiondetail.itemcode = salesorderdetail.itemcode and salesorderdetail.routekey = " 
		+ sessionStorage.getItem('RouteKey') +" and salesorderdetail.visitkey  = "+ sessionStorage.getItem('VisitKey')
		+" inner join itemmaster on promotiondetail.itemcode = itemmaster.actualitemcode  inner join "
		+"tbl_productgroupdetailaltitem on tbl_productgroupdetailaltitem.alternate_prcode=itemmaster.actualitemcode"
		+"  where promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = "
		+ sessionStorage.getItem('customerid') +") and promokeydetail.plannumber = "
		+ sessionStorage.getItem('orderplannumber')+"  and promokeydetail.amountbasis<>2 ";
		
            		console.log(Qry);
            		
                	window.plugins.DataBaseHelper.select(Qry,function(result)
                                   {
                                      if(result.array != undefined)
                                      {
                                          ClearTableContent();
                                          BindData(result,clickedRow); 
                                   if(flag=='true')
                                   UpdateInvoiceDetail(result.array.length);
                                      }
                                   },
                                   function()
                                   {
                                      console.warn("Error calling plugin");
                                   });
                }
            }
                
            
            
            function BindData(result,clickedRow)
            {
                var CellCount = $("#tblHeaderContent tr:eq(0) th").length;
                
                dataFreeSample = result;
                
                if(platform=='Android')
                {
                    var result = $.map(result.array, function (item, index) { 
				return [[item.Code, item.Description,item.salesqty,item.unitspercase,item.freesampleqty,item.salesprice,item.salescaseprice,item.actualitemcode,item.rangebasis,item.promotionquantity,item.itemqty,item.orginal_unit,item.alternate_unit,item.isalternateitem]];
                                       });   
                    dataFreeSample = result;
                }
                
                for (i = 0; i < dataFreeSample.length; i++) 
                {
                	 var r;  
                	if(dataFreeSample[i][13]==1){
                		 r = "<tr class='contentFont alternateFreeItems'>";
            		}else{
                    r = "<tr class='contentFont'>";
            		}
                    for (j = 0; j < CellCount; j++) 
                    {
                        var temp = ((j == 0 || j == 1)) ? 'class = leftAlign': '';
                       
                       if(j == CellCount - 1)
                        	temp += "class = 'last'";
                        if(j > 1)
                            dataFreeSample[i][j] = parseInt(dataFreeSample[i][j]);
                        
                        if(dataFreeSample[i][8]==3 || dataFreeSample[i][8]==4)
                        {
                            if(j==4)
                            {
                                var c = "<td " + temp + ">" + parseInt(dataFreeSample[i][9]) + "</td>";
                            }
                            else
                            {
                                var c = "<td " + temp + ">" + dataFreeSample[i][j] + "</td>";
                            }
                        }
                        else{
                            var c = "<td " + temp + ">" + dataFreeSample[i][j] + "</td>";
                        }
                        
                        r += c;
                    }
                    r += "</tr>";
                    $('#tblContent tbody').append(r);                    
                }
                if(dataFreeSample[0][8]==3 || dataFreeSample[0][8]==4)
                { 
                    UpdateInvoiceDetail(0);
                } 
                
                $("#tblContent tr:odd").addClass('oddRow');
                $("#tblContent tr:even").addClass('evenRow');        
                
                $("#tblContent tr:eq("+clickedRow+")").trigger('click');
                
                 var Qty=0;
                if(dataFreeSample[0][8]<3)
                {
                $('#tblContent td.last').click(function()
                                            {
                                               var rowindex=$(this).parent().index();                                               
                                               var aval= $(this).text();
                                               var input = $('<input/>').attr('value',$(this).text());
                                               var w = $(this).innerWidth();
                                               w=w-20;
                                               
                                               input.attr('type','number');
                                               
                                               input.css('width',w).css('border','0').css('height',30).css('font-size',16);
                                               
                                               $(this).empty();
                                               $(this).append(input);
                                               input.focusout(function()
                                                              { 
                                            	   	/****Quantity checking for alternate items****/
                                                          if(dataFreeSample[rowindex-1][13]==1){
                                          	   					/*originalunit/alternateunit*/
                                          	   					if(!eval($(this).val())) {
																	$(this).parent().text(0);
																}
                                          	   				var alternateQty=eval(dataFreeSample[rowindex-1][11])/eval(dataFreeSample[rowindex-1][12]);
                                     	                         Qty=eval($(this).val())*alternateQty;
                                          	   				}
                                                            /*----Quantity checking for alternate items Ends-----*/
                                                            else if(amountBasis==2){
                                                            	if(!eval($(this).val())) {
																	$(this).parent().text(0);
																}
                                                        		     Qty=eval(checkPromoPrice(rowindex,dataFreeSample[index-1][7],eval($(this).val())));
                                                        	
                                                            }
                                           	   				else{
//                                                               if(Qty == 0)
//                                                               {
//                                                               Qty = eval(Qty) - eval(aval) + eval($(this).val());
//                                                               }
//                                                               else
//                                                               {
																	if(!eval($(this).val())) {
																		$(this).parent().text(0);
																	}																
																		
				                                                              Qty = eval($(this).val())?eval($(this).val()):0;
                                                              //}
                                            	   			}
                                                          if(amountBasis==2 && (Qty)  > (eval(promovalue)+eval(tolerance))){
                                                        	  navigator.notification.alert("Given Qty Can't Exceed Allowed Qty");
                                                        	  $(this).parent().text(0);
                                                          }
                                                          else if((Qty)  > promovalue && amountBasis!=2 )
                                                              {
                                                              	Qty = eval(Qty) - eval(parseInt($(this).val(),10));  
                                                              	navigator.notification.alert("Given Qty Can't Exceed Allowed Qty");
                                                              
                                                                $(this).parent().text(0); 
                                                              }
                                                              else{
                                                                 $(this).parent().text(parseInt($(this).val(),10)); 
                                                                 UpdateInvoiceDetail(rowindex);
                                                              }
                                                              
                                                              });
                                                    input.focus();
                                               }); 
                }
                
			 	if(!freeItemsPreFilled){
			 		$.mobile.showPageLoadingMsg();
			 		populateFreeItemsInGrid();
			 	}else{

					getGivenFreeAmount();
			 	}
            }   
            
            
            function UpdateInvoiceDetail(index1)
            { 
                var Qty = 0; 
                $('#tblContent tr').each(function(){
                						eachqty[0]=0;
                                         if($(this).index() > 0)
                                         {
                                        	 var index= $(this).index();
                                        	 eachqty[index] = eval($(this).find('td:last').text())? eval($(this).find('td:last').text()):0;
                                            	   if(amountBasis==2){
                                            		     Qty+=eval(checkPromoPrice(index1,dataFreeSample[index-1][7],eval($(this).find('td:last').text())));
                                            	   }
                                        	   
                                        	   /****Quantity checking for alternate items****/
                                        	   
                                        	   else if(dataFreeSample[index-1][11]==1){
                             	   				var alternateQty=eval(dataFreeSample[index-1][11])/eval(dataFreeSample[index-1][12]);
                             	   				Qty+=eval($(this).find('td:last').text())*alternateQty;
                             	   				
                             	   				}
                                        	   /****Quantity checking for alternate items Ends****/
                                         else{
                                         Qty += eval($(this).find('td:last').text());
                                         }
                                         }
                                         });
             
                	if(amountBasis==2 && (Qty)  > (eval(promovalue)+eval(tolerance))){
                              	 navigator.notification.alert("Given amount cannot exceed the allowed amount");
                           	
                               $('#tblContent tr').each(function(){
                                                        if($(this).index() == index1)
                                                        {
                                                        Qty = eval(Qty)-eval($(this).find('td:last').text());
                                                        $(this).find('td:last').text(0);
                                                        }
                                                        });
                               return false;
                		}
                		
                    
                	else if(amountBasis!=2 &&(Qty)  > (eval(promovalue)))
                    {
                    		 navigator.notification.alert("Given Qty Can't Exceed Allowed Qty");
                        $('#tblContent tr').each(function(){
                                                 if($(this).index() == index1)
                                                 {
                                                 Qty = eval(Qty)-eval($(this).find('td:last').text());
                                                 $(this).find('td:last').text(0);
                                                 }
                                                 });
                        return false;
                    }
                    else
                    {
                    	//if memo enabled
                    	//then check total qty with free limit
                    	if(sessionStorage.getItem("freeLimitEnabled") && sessionStorage.getItem("freeLimitEnabled").toString()=="true"){
                    		if(Qty>promotionBalanceQty){
                    			navigator.notification.alert("Given Qty Can't Exceed Free Limit");
                                 $('#tblContent tr').each(function(){
                                                          if($(this).index() == index1)
                                                          {
                                                          Qty = eval(Qty)-eval($(this).find('td:last').text());
                                                          $(this).find('td:last').text(0);
                                                          }
                                                          });
                                 return false;
                    		}else{
                    			   //Update Invoice Detail   
                    			  // var i=0;
                    			// while (i<dataFreeSample.length)
                                //for(i=0;i<dataFreeSample.length;i++)
                               // {
                                	//setTimeout(function(){
                                		updatepromotionfreetemp(dataFreeSample[0][7],eachqty[1],dataFreeSample[0][8],0,0,0,index1,0,dataFreeSample.length);
                                		//}, 5000); //Delay given to complete the DB operations
                                  //i++;
                               // }
                    			   
                    			   //updateFreeLimitQty(Qty);
                    		}
                    	}else{
                    		   //Update Invoice Detail   
//                             for(i=0;i<dataFreeSample.length;i++)
//                             {
//                             	setTimeout(function(){
                            		updatepromotionfreetemp(dataFreeSample[0][7],eachqty[1],dataFreeSample[0][8],0,0,0,index1,0,dataFreeSample.length);
                            		//}, 5000); //Delay given to complete the DB operations
                            //}
                            if(amountBasis==2){
                            	getGivenFreeAmount();
                            }
                            	
                    	}
                    	
                    	
                    }
                
                	if(Qty == 0)
                {
                    navigator.notification.alert("Please enter quantity");
                    return false;
                }   
                
                
                
            }
            
            function ClearTableContent() {
                $("#tblContent  tr:gt(0)").remove();
            }
            
            function SetPage()
            {
                localStorage.sign='promo';
                if(sessionStorage.getItem("SignEnabled") != 1 && !isOrderEditing)
                url = '../customer/signature.html' ;
                else
                {                   
                    url = 'orderdetail.html'; 
                }
                if(freepromoflag==1)
                {
                    var selectqry="select sum(freesampleqty) as qty,promotionquantity as qty2 from promotiondetail join salesorderdetail on salesorderdetail.itemcode=promotiondetail.itemcode and salesorderdetail.routekey="+sessionStorage.getItem('RouteKey')+" and salesorderdetail.visitkey="+ sessionStorage.getItem('VisitKey') +" where promotiondetail.routekey="+sessionStorage.getItem('RouteKey')+" and promotiondetail.visitkey="+ sessionStorage.getItem('VisitKey') +" and promotiontypecode=7 group by salesorderdetail.routekey,salesorderdetail.visitkey having qty<>qty2";
                    console.log(selectqry);
                    if(platform=='iPad')
                    {
                        Cordova.exec(function(result) {                      
                                      if(result!='')
                                      {
                                      PopupPasswordEntry("continue",url,tblPassword.innerHTML,'order_promotion_review.html');
                                      }
                                      else
                                      {
                                      window.location =url;
                                      }
                                      
                                      },
                                      function(error) {
                                      alert("Error in binding free sample detail : " + error);
                                      },
                                      "PluginClass", 
                                      "GetdataMethod",                           
                                      [selectqry]);
                    }
                    else if(platform=='Android')
                    {
                        window.plugins.DataBaseHelper.select(selectqry,function(result)
                                                             {
                                                             if(result.array != undefined)
                                                             {
                                                             PopupPasswordEntry("continue",'promotion_review.html',tblPassword.innerHTML,'promotion_review.html');
                                                             }
                                                             else
                                                             {
                                                            	 updateExciseTaxAndVatForOrderDetail(url);
                                                             }                                                             
                                                             },
                                                             function()
                                                             {
                                                             console.warn("Error calling plugin");
                                                             });
                    }
                }
                else{
                	updateExciseTaxAndVatForOrderDetail(url);
                }
            }
            function getItemList()
            {
                var selectqry ="SELECT itemmaster.actualitemcode,CASE WHEN '" + sessionStorage.getItem('Language') + "' = 'en' THEN itemmaster.itemdescription ELSE itemmaster.arbitemdescription END As Description,itemmaster.actualitemcode from itemmaster join inventorysummarydetail on inventorysummarydetail.itemcode=itemmaster.actualitemcode where inventorysummarydetail.routekey="+sessionStorage.getItem('RouteKey');
                if (platform == 'iPad') {
                    Cordova.exec(function(result) {
                                  
                                  for(i=0;i<result.length;i++){    
                                  
                                  $("<option />" ,{value:result[i][0],text:result[i][0]+" "+result[i][1]}).appendTo($("#txtitemadd"));   
                                  
                                  }
                                  $('#txtitemadd').selectmenu("refresh");
                                  },
                                  function(error) {
                                  alert("Error in binding Item : " + error);
                                  },
                                  "PluginClass",
                                  "GetdataMethod",
                                  [selectqry]);
                    
                }
                else if (platform == 'Android') {
                    window.plugins.DataBaseHelper.select(selectqry, function(result) {
                                                         var array = $.map(result.array, function (item, index) {               
                                                                           return [[item.actualitemcode, item.Description]];            					
                                                                           });
                                                         
                                                         result = array;
                                                         for(i=0;i<result.length;i++){    
                                                         
                                                         $("<option />" ,{value:result[i][0],text:result[i][0]+" "+result[i][1]}).appendTo($("#txtitemadd"));   
                                                         
                                                         }
                                                         $('#txtitemadd').selectmenu("refresh");
                                                         },
                                                         function() {
                                                         console.warn("Error calling plugin");
                                                         });
                }
            }
            function savepromotion()
            {
                var itemcode =$("#txtitemadd").val();
                var qty =$("#txFreeQtyadd").val();
                
                if((qty)  > parseInt(promovalue))
                {
                    
                    navigator.notification.alert("Given Qty Can't Exceeded Allowed Qty");
                    return false;
                    
                }
                var selectqry ="select promotionquantity,rangelow,repeatingrange,itemtransactiontype from promotiondetail where promotionplannumber="+ sessionStorage.getItem('orderplannumber')+" and routekey="+sessionStorage.getItem('RouteKey')+" and visitkey="+sessionStorage.getItem('VisitKey');
                console.log(selectqry);
                if (platform == 'iPad') {
                    Cordova.exec(function(result) {
                                  promotionquantity = result[0][0];
                                  rangelow = result[0][1];
                                  repeatingrange = result[0][2];
                                  itemtransactiontype = result[0][3];
                                  insertQry = "Insert Into promotiondetail(routekey,visitkey,transactionkey,itemcode,promotiontypecode,promotionquantity,promotionplannumber,assignmentkey,weighted,istemp,salesamount,issync,rangelow,repeatingrange,itemtransactiontype) values("+ sessionStorage.getItem('RouteKey') +","+ sessionStorage.getItem('VisitKey') +",0,"+ itemcode +",7,"+ promotionquantity  +","+ sessionStorage.getItem('orderplannumber') +","+ sessionStorage.getItem('orderplannumber') +",0,'true',0,0,"+ rangelow +","+ repeatingrange +","+itemtransactiontype+")";
                                  console.log(insertQry);
                                  
                                  
                                  Cordova.exec(function(result) 
                                                {    
                                                
                                                updateinvoicefree(itemcode,qty);
                                                },
                                                function(error) {
                                                navigator.notification.alert("Error inserting record in promotion detail");
                                                },
                                                "PluginClass", 
                                                "InsertUpdateMethod", 
                                                [insertQry]);
                                  },
                                  function(error) {
                                  alert("Error in binding Item : " + error);
                                  },
                                  "PluginClass",
                                  "GetdataMethod",
                                  [selectqry]);
                    
                }
                else if (platform == 'Android') {
                    window.plugins.DataBaseHelper.select(selectqry, function(result) {
                                                         var array = $.map(result.array, function (item, index) {               
                                                                           return [[item.promotionquantity, item.rangelow,item.repeatingrange,item.itemtransactiontype]];            					
                                                                           });
                                                         
                                                         result = array;
                                                         promotionquantity = result[0][0];
                                                         rangelow = result[0][1];
                                                         repeatingrange = result[0][2];
                                                         itemtransactiontype = result[0][3];
                                                         
                                                         insertQry = "Insert Into promotiondetail(routekey,visitkey,transactionkey,itemcode,promotiontypecode,promotionquantity,promotionplannumber,assignmentkey,weighted,istemp,salesamount,issync,rangelow,repeatingrange,itemtransactiontype) values("+ sessionStorage.getItem('RouteKey') +","+ sessionStorage.getItem('VisitKey') +",0,"+ itemcode +",7,"+ promotionquantity  +","+ sessionStorage.getItem('orderplannumber') +","+ sessionStorage.getItem('orderplannumber') +",0,'true',0,0,"+ rangelow +","+ repeatingrange +","+itemtransactiontype+")";
                                                         
                                                         window.plugins.DataBaseHelper.insert(insertQry,function(result)
                                                                                              {
                                                                                              
                                                                                              updateinvoicefree(itemcode,qty);
                                                                                              
                                                                                              },
                                                                                              function()
                                                                                              {
                                                                                              console.warn("Error calling plugin");
                                                                                              });
                                                         
                                                         
                                                         },
                                                         function() {
                                                         console.warn("Error calling plugin");
                                                         });
                }
                
                
            }
            function updateinvoicefree(itemcode,qty)
            {
                var selectqry ="select count(*) as cnt from salesorderdetail where itemcode="+itemcode+" and routekey="+sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +"";
                
                
                if (platform == 'iPad') {
                    Cordova.exec(function(result) {
                                  if(result[0][0] > 0)
                                  {
                                  var inserqry="Update salesorderdetail set freesampleqty = " + qty +",promoqty=" + qty + ",mdat = datetime(),issync=0 where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemcode +"";
                                  }
                                  else
                                  {
                                  var inserqry = "INSERT INTO salesorderdetail(itemcode,routekey,transactionkey,visitkey,freesampleqty,istemp,salesprice,issync,salescaseprice,stdsalesprice,stdsalescaseprice,stdreturnprice,stdreturncaseprice,returnprice,returncaseprice,goodreturnprice,goodreturncaseprice,promoqty) select " + itemcode + "," + sessionStorage.getItem('RouteKey') + ",0," + sessionStorage.getItem("VisitKey") + "," + qty + ",'true',defaultsalesprice,0,caseprice,defaultsalesprice,caseprice,defaultreturnprice,returncaseprice,defaultreturnprice,returncaseprice,defaultgoodreturnprice,defaultgoodreturncaseprice," + qty + "  from itemmaster where actualitemcode="+itemcode;
                                  }
                                  console.log(inserqry);
                                  Cordova.exec(function(result) 
                                                {    
                                                
                                                getFreeSampleList('true');
                                                
                                                },
                                                function(error) {
                                                navigator.notification.alert("Error inserting record in promotion detail");
                                                },
                                                "PluginClass", 
                                                "InsertUpdateMethod", 
                                                [inserqry]);
                                  },
                                  function(error) {
                                  alert("Error in binding Item : " + error);
                                  },
                                  "PluginClass",
                                  "GetdataMethod",
                                  [selectqry]);
                    
                }
                else if (platform == 'Android') {
                    window.plugins.DataBaseHelper.select(selectqry, function(result) {
                                                         var result = $.map(result.array, function (item, index) {               
                                                                            return [[item.cnt]];            					
                                                                            });
                                                         
                                                         if(result[0][0] > 0)
                                                         {
                                                         var inserqry="Update salesorderdetail set freesampleqty = "+ qty +",promoqty=" + qty + ",mdat = datetime(),issync=0 where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemcode +"";
                                                         }
                                                         else
                                                         {
                                                         var inserqry = "INSERT INTO salesorderdetail(itemcode,routekey,transactionkey,visitkey,freesampleqty,istemp,salesprice,issync,salescaseprice,stdsalesprice,stdsalescaseprice,stdreturnprice,stdreturncaseprice,returnprice,returncaseprice,goodreturnprice,goodreturncaseprice,promoqty) select " + itemcode + "," + sessionStorage.getItem('RouteKey') + ",0," + sessionStorage.getItem("VisitKey") + "," + qty + ",'true',defaultsalesprice,0,caseprice,defaultsalesprice,caseprice,defaultreturnprice,returncaseprice,defaultreturnprice,returncaseprice,defaultgoodreturnprice,defaultgoodreturncaseprice," + qty + "  from itemmaster where actualitemcode="+itemcode;
                                                         }
                                                         
                                                         
                                                         
                                                         window.plugins.DataBaseHelper.insert(inserqry,function(result)
                                                                                              {
                                                                                              
                                                                                              getFreeSampleList('true');
                                                                                              
                                                                                              },
                                                                                              function()
                                                                                              {
                                                                                              console.warn("Error calling plugin");
                                                                                              });
                                                         
                                                         
                                                         },
                                                         function() {
                                                         console.warn("Error calling plugin");
                                                         });
                }
                
            }
            function updatesalesorderdetail(itemcode,qty,flag,index,curIndex,length)
            {
                var selectqry ="select count(*) as cnt from salesorderdetail where itemcode="+itemcode+" and routekey="+sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +"";
                console.log(selectqry);
                
                if (platform == 'iPad') {
                    Cordova.exec(function(result) {
                                  if(result[0][0] > 0)
                                  {
                                  var inserqry="Update salesorderdetail set freesampleqty = (SELECT SUM(promotionfreetemp.promofreeqty) "
                                		  +"from promotionfreetemp where promotionfreetemp.itemcode= "+ itemcode +"),promoqty=" 
                                		  + qty + ",mdat = datetime(),issync=0 where routekey = "+ sessionStorage.getItem('RouteKey')
                                		  +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemcode +"";
                                  }
                                  else
                                  {
                                  var inserqry = "INSERT INTO salesorderdetail(itemcode,routekey,transactionkey,visitkey,freesampleqty,istemp,salesprice,issync,salescaseprice,stdsalesprice,stdsalescaseprice,stdreturnprice,stdreturncaseprice,returnprice,returncaseprice,goodreturnprice,goodreturncaseprice,promoqty) select " + itemcode + "," + sessionStorage.getItem('RouteKey') + ",0," + sessionStorage.getItem("VisitKey") + "," + qty + ",'true',defaultsalesprice,0,caseprice,defaultsalesprice,caseprice,defaultreturnprice,returncaseprice,defaultreturnprice,returncaseprice,defaultgoodreturnprice,defaultgoodreturncaseprice," + qty + "  from itemmaster where actualitemcode="+itemcode;
                                  }
                                  console.log(inserqry);
                                  Cordova.exec(function(result) 
                                                {    
                                                
                                                if(flag <3)
                                                getFreeSampleList(0);
                                                
                                                },
                                                function(error) {
                                                navigator.notification.alert("Error inserting record in promotion detail");
                                                },
                                                "PluginClass", 
                                                "InsertUpdateMethod", 
                                                [inserqry]);
                                  },
                                  function(error) {
                                  alert("Error in binding Item : " + error);
                                  },
                                  "PluginClass",
                                  "GetdataMethod",
                                  [selectqry]);
                    
                }
                else if (platform == 'Android') {
                    window.plugins.DataBaseHelper.select(selectqry, function(result) {
                                                         var result = $.map(result.array, function (item, index) {               
                                                                            return [[item.cnt]];            					
                                                                            });
                                                      
                                                         if(result[0][0] > 0)
                                                         {
                                                         var inserqry="Update salesorderdetail set freesampleqty = "
                                                         + "(SELECT SUM( promotionfreetemp.promofreeqty) from promotionfreetemp where "
                                                         +"promotionfreetemp.itemcode= "+ itemcode +"),promoqty=" + qty + ",mdat = datetime(),issync=0"
                                                         +" where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "
                                                         + sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemcode +"";
                                                         }
                                                         else
                                                         {
                                                         var inserqry = "INSERT INTO salesorderdetail(itemcode,routekey,transactionkey,visitkey,freesampleqty,istemp,salesprice,issync,salescaseprice,stdsalesprice,stdsalescaseprice,stdreturnprice,stdreturncaseprice,returnprice,returncaseprice,goodreturnprice,goodreturncaseprice,promoqty) select " + itemcode + "," + sessionStorage.getItem('RouteKey') + ",0," + sessionStorage.getItem("VisitKey") + "," + qty + ",'true',defaultsalesprice,0,caseprice,defaultsalesprice,caseprice,defaultreturnprice,returncaseprice,defaultreturnprice,returncaseprice,defaultgoodreturnprice,defaultgoodreturncaseprice," + qty + "  from itemmaster where actualitemcode="+itemcode;
                                                         }
                                                         
                                                         
                                                         
                                                         window.plugins.DataBaseHelper.insert(inserqry,function(result)
                                                                                              {
                                                        	 if(curIndex+1<length-1){
                                                        		// alert(dataFreeSample[curIndex+1][7]+" ** "+eachqty[curIndex+1]+" ** "+eachqty)
                                                        		 updatepromotionfreetemp(dataFreeSample[curIndex+1][7],eachqty[curIndex+2],dataFreeSample[0][8],0,0,0,index,curIndex+1,length);
                                                        	 }else{
                                                        		 if(flag <3)  
	                                    								getFreeSampleList(0,index);
                                                        	 }
                                                        	  },
                                                                                              function()
                                                                                              {
                                                                                              console.warn("Error calling plugin");
                                                                                              });
                                                         
                                                         
                                                         },
                                                         function() {
                                                         console.warn("Error calling plugin");
                                                         });
                }
            }
            
            /*
            *@method getPromoKeyDetails
            *Function to check whether the free limit promotion is enabled
            *Checks for the alternate item code for the selected plan
            */
            function getPromoKeyDetails(){
            	var Qry="SELECT memo1,freelimit,alternatecode,assignmentgroup,amountbasis,tolerance,qlftotqty from promokeydetail where plannumber="
            	+sessionStorage.getItem('orderplannumber');
            	if (platform == 'Android'){
            		 window.plugins.DataBaseHelper.select(Qry,function(result){
            	           
            			 if(result.array[0].memo1!="" && result.array[0].memo1!= memo1.toString()){
            	            	promotionBalanceQty=result.array[0].freelimit;
            	            	$("#promotionBalanceDiv").text("Promotion Balance Quantity");
            	            	$("#txtPromotionBalance").val(eval(promotionBalanceQty));
            	            	$("#txtPromotionBalance").css({ "display": "block" });
           	            	 	sessionStorage.setItem("freeLimitEnabled", true);
            	            }
            			 if(result.array[0].amountbasis==2){ 
            				 		$("#allowedFreeDiv").text("Allowed Free Value");
            				 		updatePromoQty(); /***Get the item promo price for each items***/
           				 	}
            			 if(result.array[0].amountbasis!=2 && result.array[0].memo1=="" ||result.array[0].memo1==null||result.array[0].memo1==undefined){
               	            	$("#txtPromotionBalance").css({ "display": "none" });
               	            	$("#toleranceDiv").css({ "display": "none" }); 
               	            	$("#txtTolerance").css({ "display": "none" });
            	            	$("#allowedFreeDiv").text("Allowed Free");
           				 	}
           				  if (result.array[0].memo1=="" ||result.array[0].memo1==null||result.array[0].memo1==undefined){
            	            	promotionBalanceQty=0;
            	            	$("#promotionBalanceDiv").text("");
            	            	$("#txtPromotionBalance").val(0)
            	            	$("#txtPromotionBalance").css({ "display": "none" });
            	            	sessionStorage.setItem("freeLimitEnabled", false);
            	            }
            			 		assignmentItemGroup=result.array[0].assignmentgroup;
            				 	alternateItemGroup=result.array[0].alternatecode;
            				 	amountBasis=result.array[0].amountbasis;
            				 	tolerance=result.array[0].tolerance;
            				 
            				 	
            				 
            		 },function(){
            			  console.warn("Error calling plugin");
            		 });
            	}
            }
 
  /*
  *@method getGivenFreeAmount
  *function to calulate the total amount given as free
  */
 function getGivenFreeAmount(){
	var Qty=0;
	 $('#tblContent tr').each(function(){
		 if($(this).index() > 0)
         {
		 var index= $(this).index();
		 Qty+=eval(checkPromoPrice(0,dataFreeSample[index-1][7],eval($(this).find('td:last').text())));
         }
		 });  
	 
	if(amountBasis==2){
	 
	$("#promotionBalanceDiv").text("Given Free Value");
	$("#txtPromotionBalance").val(eval(Qty));
	$("#txtPromotionBalance").css({ "display": "block" });  
	
	$("#toleranceDiv").css({ "display": "block" });  
	$("#txtTolerance").val(eval(tolerance)); 
	$("#txtTolerance").css({ "display": "block" });
	}
	
	
	
 }
           
 /*
 *@method populateFreeItemsInGrid
 *Function to populate the free items quantity in the grid
 */           
function populateFreeItemsInGrid(){
	var Qry="select count(itemcode) as count from promotiondetail where visitkey="+sessionStorage.getItem("VisitKey")
	+ " and routekey="+sessionStorage.getItem('RouteKey')+" and promotionplannumber="+sessionStorage.getItem('orderplannumber')+" and isalternateitem=0";
	$.mobile.hidePageLoadingMsg();
	 if (platform == 'Android') {
		 window.plugins.DataBaseHelper.select(Qry, function(result) {
			var count=result.array[0].count;
			var totalFreeQty=sessionStorage.getItem("orderpromovalue"); // for alternate and minimumqualify quantity
			
			if(amountBasis==2){
				 var itemcode=eval(dataFreeSample[0][7]);
				 var salesprice=ItemPromoPrices[itemcode];
				 totalFreeQty=parseInt(totalFreeQty/salesprice);
			}
			
			if(sessionStorage.getItem("freeLimitEnabled").toString()=="true"){
				if(eval(totalFreeQty)>eval(promotionBalanceQty)){
					totalFreeQty=promotionBalanceQty;
				}
				
			}

			
			if(count>0){
			var Qty = 0; 
				if(dataFreeSample[0][11]!=1){
				updatepromotionfreetemp(dataFreeSample[0][7],totalFreeQty,dataFreeSample[0][8],0,0,0,1,0,1);
				}
			   
					$.mobile.hidePageLoadingMsg();
					freeItemsPreFilled=true;
			}
			
		 },function(){
			  console.warn("Error calling plugin");
		 });
	 }
}
 function updatepromotionfreetemp(itemcode,qty,flag,amount,availFlag,itemprice,index,curIndex,length)
 {
     var selectqry ="select count(*) as cnt,Availability from promotionfreetemp where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemcode +" and promotionplannumber = "+ sessionStorage.getItem('orderplannumber') +"";
     
     
     if (platform == 'iPad') {
     }
     else if (platform == 'Android') {
         window.plugins.DataBaseHelper.select(selectqry, function(result) {
                                              var result = $.map(result.array, function (item, index) {               
                                                                 return [[item.cnt,item.Availability]];                                
                                                                 });
                                              
                                              if(result[0][0] > 0)
                                              {
                                             	 
                                                 if(result[0][1]==1)
                                                 {
                                                 	availFlag=result[0][1];
                                                 	
                                                 }
                                              var inserqry="Update promotionfreetemp set promofreeqty = "+ qty +",itempcsprice="+amount+",Availability="+availFlag+" where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemcode +" and promotionplannumber = "+ sessionStorage.getItem('orderplannumber') +"";
                                              
                                            
                                               window.plugins.DataBaseHelper.insert(inserqry,function(result)
                                                                                   {
                                            	   						updatesalesorderdetail(itemcode,qty,flag,index,curIndex,length);
                                                                                   },
                                                                                   function()
                                                                                   {
                                                                                   console.warn("Error calling plugin");
                                                                                   });
                                             
                                              }
                                              else
                                              {
                                              var inserqry = "INSERT INTO promotionfreetemp(routekey,visitkey,transactionkey,promotionplannumber,itemcode,promofreeqty,itempcsprice,Availability,salesprice) VALUES(" + sessionStorage.getItem('RouteKey') + "," + sessionStorage.getItem('VisitKey') + ",0," + sessionStorage.getItem('orderplannumber') + "," + itemcode + "," + qty + ","+amount+","+availFlag+","+itemprice+")";
                                           
                                              if(qty > 0 || availFlag=='1'){
                                               window.plugins.DataBaseHelper.insert(inserqry,function(result)
                                                                                   {
                                            	   										updatesalesorderdetail(itemcode,qty,flag,index,curIndex,length);
                                            	   								
                                                                                   },
                                                                                   function()
                                                                                   {
                                                                                   console.warn("Error calling plugin");
                                                                                   });
                                              }
                                             
                                               
                                              }
                                            
                                              },
                                              function() {
                                              console.warn("Error calling plugin");
                                              });
     }
     
 }
 
 /*
 *@method checkPromoPrice
 *function to check the promo price, if amount basis=2
 *@param{index} index of the selected row
 *@param{itemCode} selected item code
 *@param{quantity}
 */
 function checkPromoPrice(index,itemCode,quantity){

        	 //var promoPrice=ItemPromoPrices[itemCode];
        	 var salesprice=ItemPromoPrices[itemCode];
        	 var promotionAmount=eval(salesprice)*eval(quantity);
        	return (eval(promotionAmount));
      
	 
 }
 
 /*
 *@method getItemPromoPrices
 *function to get the promotion price for each item in promotion details
 */
 function getItemPromoPrices(){
	 var Qry="SELECT itemmaster.actualitemcode as itemcode,itemmaster.defaultretailprice as promoprice,itemmaster.defaultsalesprice as salesprice from itemmaster where itemmaster.actualitemcode"
	 +" in (SELECT Distinct itemcode from promotiondetail where routekey="
	 +sessionStorage.getItem('RouteKey')+" and visitkey="+sessionStorage.getItem('VisitKey')
	 +" and promotionplannumber="+sessionStorage.getItem('orderplannumber')+")";
	 console.log(Qry);
	 if (platform == 'Android') {
		 window.plugins.DataBaseHelper.select(Qry, function(result) {
				$.map(result.array, function(item, index) {
					ItemPromoPrices[item.itemcode]=item.promoprice;
				});
				populateFreeItemsInGrid();
				
			//updatePromoQty();	
		 },function(){
			  console.warn("Error calling plugin");
		 });
	 }
 }
 /*
 *@method updatePromoQty
 *Function to update the promotion Quantity with defaultretail price,if amount basis is 2
 */
function updatePromoQty(){
	 var PromoQtyQry="select salesqty from salesorderdetail where itemcode "
		 +" in (SELECT Distinct itemcode from promotionqualifieditems where routekey="
		 +sessionStorage.getItem('RouteKey')+" and visitkey="+sessionStorage.getItem('VisitKey')
		 +" and promotionplannumber="+sessionStorage.getItem('orderplannumber')+")and routekey="+sessionStorage.getItem('RouteKey')
		 +" and visitkey="+sessionStorage.getItem('VisitKey');
	 
	 console.log(PromoQtyQry);
	 if (platform == 'Android') {
		 window.plugins.DataBaseHelper.select(PromoQtyQry, function(result) {
				$.map(result.array, function(item, index) {
					totalPromotionRetailPrice+=eval(item.salesqty); //changed as per sipco
					
				});
				totalPromotionRetailPrice=eval(promovalue)*eval(totalPromotionRetailPrice);
				 var Qry="UPDATE promotiondetail set promotionamount="+totalPromotionRetailPrice+
				 " WHERE routekey="+sessionStorage.getItem('RouteKey')+" and visitkey="
				 +sessionStorage.getItem('VisitKey')+" and promotionplannumber="+sessionStorage.getItem('orderplannumber');
				 console.log(Qry);
					 window.plugins.DataBaseHelper.insert(Qry, function(result) {
						 sessionStorage.setItem("orderpromovalue", eval(totalPromotionRetailPrice));
						 promovalue = sessionStorage.getItem("orderpromovalue");
			             $('#txFreeQty').val(eval(promovalue));
			             getItemPromoPrices();
					 },function(){
						  console.warn("Error calling plugin");
					 });		
		 },function(){
			  console.warn("Error calling plugin");
		 });
	 }
 }
     </script>

    </div>
</body>
</html>
