<!DOCTYPE html>
<html>
<head>
<title>HOME</title>

<meta name="viewport"
	content="width=device-width, initial-scale=1.0;maximum-scale=1.0;user-scalable=0; target-densitydpi=device-dpi">
<meta name="format-detection" content="telephone=no">
<link rel="stylesheet" href="../css/style.css" />
<link rel="stylesheet" href="../css/en.css" lang="en" />
<link rel="stylesheet" href="../css/jquery.mobile-1.0.min.css" />
<link rel="stylesheet"
	media="only screen and (min-width: 1200px) and (max-width: 1500px)"
	href="../css/style_1400.css" />
<link rel="stylesheet"
	media="only screen and (min-width: 1000px) and (max-width: 1200px)"
	href="../css/style_1200.css" />
<link rel="stylesheet"
	media="only screen and (min-width: 700px) and (max-width: 800px)"
	href="../css/style_800.css" />
<!-- <link rel="stylesheet"
	media="only screen and (min-width: 600px) and (max-width: 700px)"
	href="../css/style_700.css" />
<link rel="stylesheet"
	media="only screen and (min-width: 320px) and (max-width: 600px)"
	href="../css/style_600.css" /> -->
	 <link rel="stylesheet"
	media="only screen and (min-height: 0px) and (max-height: 576px)"
	href="../css/style_480.css"> 
 <link rel="stylesheet"
	media="only screen and (min-width: 360px) and (max-width: 479px)"
	href="../css/style_600.css">

<script type="text/javascript" src="../js/jquery.js"></script>

<script type="text/javascript" src="../js/jquery.mobile-1.0.js"></script>

<script type="text/javascript" src="../js/common.js"></script>

<script src="../LangJS/jquery-lang.js" charset="utf-8"
	type="text/javascript"></script>

<script src="../LangJS/langpack/AR.js" charset="utf-8"
	type="text/javascript" lang="en"></script>

<script type="text/javascript" src="../js/jquery.json-2.3.min.js"></script>

<script>
   
if (navigator.userAgent.toLowerCase().match(/android/)) {
document.write('<script charset="utf-8" src="../cordova-2.0.0.js"><\/script>');
document.write('<script charset="utf-8" src="../directoryListing.js"><\/script>');
} else if (navigator.userAgent.toLowerCase().match(/iphone/) || navigator.userAgent.toLowerCase().match(/ipad/)) {
document.write('<script charset="utf-8" src="../cordova-1.5.0.js"><\/script>');
}
</script>

</head>
<body>
	<div data-role="page" data-theme="d" data-title="HOME" id="myPage">
		<div>
			<img title="" alt="" src="../images/bg.png" id="background">
		</div>
		<div data-role="header" data-position="inline" id="bgclheader">
			<!--<a href="index.html"   id="Back_inner">test</a>-->
			<a id="Back_inner" onclick="checksurvey('exit');" rel="external"
				lang="en">Back</a>
				<div class="wrapper"><div class="card_content"><div><img title="" alt="" data-pushbar-target="left"  src="../images/icons8-menu-50.png" id="setting"></div></div></div>
			<h1 lang="en">Customer Options</h1>
			<a href="#" id="lang_inner">EN</a>
		</div>
		<div data-role="content" class="centerbox custpage">

			<div class="topbox tohide ">
				<div class="content-primary1 ">
					<label class="cus_lable heading" lang="en"> No.</label> <span
						class="nobox headbox" id="custid"></span>
				</div>
				<div class="second-primary1">
					<label class="cus_lable heading" lang="en" id="custname">
						Customer Name</label>
				</div>
			</div>
			<div id="MenuListReview">
				<div class="content-primary custsel">
					<ul data-role="listview" id="MenuList">
				<!-- 		<li><a onclick="getRouteBalances('../customer/customer_info.html')" -->
							<li><a href="../customer/customer_info.html"
							class="enableText" rel="external"  onclick=localStorage.info='cust'>
								<img src="../images/icn-info.png" class="HomeIconPosEN" />
								<h3 lang="en">Customer Info</h3>
						</a></li>
					</ul>
				</div>
				<div class="second-primary custsel">
					<ul data-role="listview" id="MenuList">
						<li><a href="#" id="arlink" rel="external"
							onclick="localStorage.po = 'collection';checkInvoiceImageCaptured('autosettler.html')">
								<img src="../images/collection.png" id="imgarcol"
								class="HomeIconPosEN" />
								<h3 lang="en" id="arcol">Collections</h3>
						</a></li>
					</ul>
				</div>
				<div class="content-primary ">
					<ul data-role="listview" id="MenuList">
						<li><a href="#" rel="external" id="saleslink"
							onclick="sessionStorage.setItem('custreturnvisit','false');sessionStorage.setItem('custinventvisit','false');localStorage.po = 'sales';checkInvoiceImageCaptured('salesinvoice_option.html')">
								<img src="../images/info-6.png" id="imgsales"
								class="HomeIconPosEN" />
								<h3 lang="en" id="sales">Sales</h3>
						</a></li>
					</ul>
				</div>
				<div class="second-primary ">
					<ul data-role="listview" id="MenuList">
						<li><a href="#"
							onclick="checkInvoiceImageCaptured('merchandising.html')"
							class="enableText" id="surveylink" rel="external"> <img
								src="../images/icn-9.png" id="imgsurvey" class="HomeIconPosEN" />
								<h3 lang="en" id="survey">Merchandizing</h3>
						</a></li>
					</ul>
				</div>
				<div class="content-primary ">
					<ul data-role="listview" id="MenuList">
						<li><a href="#" id="orderlink" rel="external"
							onclick="localStorage.po ='orderrequest';checkInvoiceImageCaptured('orderRequest.html')">
								<img src="../images/info-5.png" id="imgord"
								class="HomeIconPosEN" />
								<h3 lang="en" id="order">Order Request</h3>
						</a></li>
					</ul>
				</div>
				<!--<div class="content-primary">
                <ul data-role="listview" id="MenuList">
                    <li><a href="#" rel="external">
                        <img src="../images/sale-gray.png" class="HomeIconPosEN" />
                        <h3 lang="en" class="MenuGray">
                            CPD Options</h3>
                    </a></li>
                </ul>
            </div>-->
				<div class="second-primary ">
					<ul data-role="listview" id="MenuList">
						<li><a href="#" id="adlink" rel="external"
							onclick="rediretAdvance()"> <img src="../images/info-7.png"
								id="imgadpay" class="HomeIconPosEN" />
								<h3 lang="en" id="adpay">Advance Payment</h3>
						</a></li>
					</ul>
				</div>
				<div class="content-primary ">
					<ul data-role="listview" id="MenuList">
						<li><a href="Printsalesdocs.html" id="printdiv"
							rel="external"> <img src="../images/icn-printdoc.png"
								id="imgord" class="HomeIconPosEN" />
								<h3 lang="en" id="order">Print Transactions</h3>
						</a></li>
					</ul>
				</div>
				<div class="second-primary ">
					<ul data-role="listview" id="MenuList">
						<li style="color: #999;"><a href="#"
							onclick="checkInvoiceImageCaptured('exit')" rel="external"> <img
								src="../images/info-8.png" class="HomeIconPosEN" />
								<h3 style="" lang="en">Checkout</h3>
						</a></li>
					</ul>
				</div>

			</div>
			<div id="f1" data-role="footer" class="ui-bar">
				<div class="footer">
					<div class="leftfooter">09 November 2011</div>
					<div class="rightfooter">Mirnah Technology Systems</div>
				</div>
			</div>
		</div>
		<div id="f2" data-role="footer" style="bottom: 0; position: absolute;">
		
		 <aside data-pushbar-id="left" class="pushbar from_left">
		<div class="title"><span data-pushbar-close class="close push_right"></span>
			<span id="txtroute"></span>
		</div>

		<ul class="menu">
		<li style="margin-bottom: 0 !important;" > 
		<img title="" alt="" src="../images/startday-icon.png" id="day"  class="leftmenu" >
		 <a href="#"
						class="ui-btn-active" rel="external" id="day" data-icon="custom"  
						lang="en" onclick="footerredict('../startofday/startofday.html')">Start day</a></li>
					<li style="margin-bottom: 0 !important;">
					 <img title="" alt="" src="../images/Inventoryicon.png" id="inve"  class="leftmenu">
					 <a href="#" id="inve"
						rel="external" data-icon="custom" lang="en"
						onclick="footerredict('../inventory/inventory.html')">Inventory</a></li>
					<li style="margin-bottom: 0 !important;">
					 <img title="" alt="" src="../images/customer-icon.png" id="cust" class="leftmenu">
					 <a href="#"
						rel="external" id="cust" data-icon="custom" lang="en"
						onclick="footerredict('../customer/customer_operation.html')">Customer</a></li>
					<li style="margin-bottom: 0 !important;">
					<img title="" alt="" src="../images/Money-icon.png" id="sett" class="leftmenu">
					<a href="#"
						rel="external" id="sett" data-icon="custom" lang="en"
						onclick="footerredict('../settlement/managesettlement.html')">Settlement</a></li>
					<li style="margin-bottom: 0 !important;">
					<img title="" alt="" src="../images/expense-icon.png" id="expe" class="leftmenu">
					<a href="#"
						rel="external" id="expe" data-icon="custom" lang="en"
						onclick="footerredict('../settlement/expenseentry.html')">Expenses</a></li>
					<li style="margin-bottom: 0 !important;">
					<img title="" alt="" src="../images/information-icon.png" id="info" class="leftmenu" >
					<a href="#"
						rel="external" id="info" data-icon="custom" lang="en"  
						onclick="footerredict('../information/information.html')">Information</a></li>
					<li style="margin-bottom: 0 !important; ">
					 <img title="" alt="" src="../images/user-settings-icon.png" id="setup" class="leftmenu">
					 <a href="#" rel="external" id="setup" data-icon="custom" lang="en"
						onclick="footerredict('../utilities/utilities.html')">Utilities</a></li>
		</ul>

	</aside>
			<div data-role="navbar" data-iconpos="top" data-grid="f">
				<ul>
					<li style="margin-bottom: 0 !important;"><a href="#"
						rel="external" id="day" data-icon="custom" lang="en"
						onclick="footerredict('../startofday/startofday.html')">Start
							day</a></li>
					<li style="margin-bottom: 0 !important;"><a href="#" id="inve"
						rel="external" data-icon="custom" lang="en"
						onclick="footerredict('../inventory/inventory.html')">Inventory</a></li>
					<li style="margin-bottom: 0 !important;"><a href="#"
						class="ui-btn-active" rel="external" id="cust" data-icon="custom"
						lang="en">Customer</a></li>
					<li style="margin-bottom: 0 !important;"><a href="#"
						rel="external" id="sett" data-icon="custom" lang="en"
						onclick="footerredict('../settlement/managesettlement.html')">Settlement</a></li>
					<li style="margin-bottom: 0 !important;"><a href="#"
						rel="external" id="expe" data-icon="custom" lang="en"
						onclick="footerredict('../settlement/expenseentry.html')">Expenses</a></li>
					<li style="margin-bottom: 0 !important;"><a href="#"
						rel="external" id="info" data-icon="custom" lang="en"
						onclick="footerredict('../information/information.html')">Information</a></li>
					<li style="margin-bottom: 0 !important; width: 14.0%"><a
						href="#" rel="external" id="setup" data-icon="custom" lang="en"
						onclick="footerredict('../utilities/utilities.html')">Utilities</a></li>
				</ul>
			</div>
			<table id="tblPassword" border="0" cellpadding="2" cellspacing="0"
				width="100%;" style="display: none;">
				<tr>
					<th class="tblHeader captionLabel leftAlign popupTitle" colspan="2"
						lang="en">Password Entry</th>
				</tr>
				<tr class="popupRow">
					<td colspan="2">&nbsp;</td>
				</tr>
				<tr class="popupRow">
					<td colspan="2" class="popupSubTitle" lang="en">Customer
						Options</td>
				</tr>
				<tr class="popupRow">
					<td class="popupSubTitle" lang="en">Password Key</td>
					<td class="popupSubTitle" id="passkey" lang="en"></td>
				</tr>
				<tr class="popupRow">
					<td colspan="2" lang="en" class="popupInfo">Please Enter The
						Security Password</td>
				</tr>
				<tr class="popupRow">
					<td colspan="2"><input id="txtPassword" type="number"
						pattern="[0-9]*" value="" maxlength="10"
						class="textWidth textFont passwordCenter"
						style="margin: 10px 22px;" /> <label id="lblMessage" lang="en"
						style="display: none">Enter Correct Password</label></td>
				</tr>
				<tr class="popupRow">
					<td style="width: 50%;"><input id="btnSubmit" type="button"
						value="Submit"
						onclick="VerifyPassword1('btnSubmit','salesinvoice_option.html',tblPassword.innerHTML);"
						data-role="none" lang="en" /></td>
					<td style="width: 50%;"><input id="btnCancel" type="button"
						rel="close" value="Cancel" onclick="ClearPassword();"
						data-role="none" lang="en" /></td>
				</tr>
			</table>
			<div class='ui-loader-background'></div>
		</div>

		<script type="text/javascript">
            window.lang = new jquery_lang_js();
			var latitude='';
			var longitude='';
            var billtobill = 0;
          	resizeOrientationWindow();
          
	  		$(document).ready(function() {
	 		//alert("ready");
	  			resizeWindow();                              
			localStorage.promooveride='';
            document.addEventListener("deviceready", onDR, false);
            function onDR() {
				sessionStorage.setItem("deliveryId",0);
            }

                $(".leftfooter").html(getCurrentDate());
                document.addEventListener("deviceready", ondeviceready, false);
                // sujee added side bar ----------------- START ------------------------ 

    	          var pushbar = new Pushbar({
		blur:true,
		overlay:true,
	});
    $("#txtroute").text("ROUTE #: " + sessionStorage.getItem("RouteCode")); 
    window.setInterval(function(){
 		var randomColor = '#'+ ('000000' + Math.floor(Math.random()*16777215).toString(16)).slice(-6);
 		$('#txtroute').css({
   			'color' : randomColor,
 		});
			}, 2000);
    //----------------------------- END -------------------------  
                var customeraid = sessionStorage.getItem("customercode");
                var customername = sessionStorage.getItem("customername");

                $('#custid').text(customeraid);
                $('#custname').text(customername);
                /*if (customername.length > 25) {
                    $('#custname').text(customername.substring(0, 25) + "...");
                }
                else {
                    $('#custname').text(customername);
                }*/

                var lan = sessionStorage.getItem("Language");
                window.lang.run(lan);

                if (sessionStorage.getItem("Language") != "en") {

                    window.lang.change('CustOpt' + lan, lan);
                    window.lang.change('Footer' + lan, lan);
                    if (lan == "AR") {
                        $('#MenuList .ui-icon').removeClass('ui-icon-arrow-r');
                        $('#MenuList .ui-icon').addClass('ui-icon-arrow-r1');
                        $('#MenuList li.ui-btn').removeClass('ui-btn-icon-right');
                        $('#MenuList li.ui-btn').addClass('ui-btn-icon-left');
                        $('#Back_inner').removeClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                        $('#Back_inner').addClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                        $('#lang_inner').removeClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                        $('#lang_inner').addClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                    }

                }
                else {
                    window.lang.change('en', 'en');

                    $('#MenuList .ui-icon').removeClass('ui-icon-arrow-r1');
                    $('#MenuList .ui-icon').addClass('ui-icon-arrow-r');
                    $('#MenuList li.ui-btn').removeClass('ui-btn-icon-left');
                    $('#MenuList li.ui-btn').addClass('ui-btn-icon-right');
                    $('#Back_inner').removeClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                    $('#Back_inner').addClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                    $('#lang_inner').removeClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                    $('#lang_inner').addClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                }
            });
            function ondeviceready()
            {
            	//alert("ondeviceready");
              //  var res=CheckConnection();
                offlinegetrecord();
            }
            function TableDataOffLine1(RecSet)
            {
              
            	//alert("TableDataOffLine1");
                    var data = RecSet;
                    var routetype,transactionseqno,enablefreereason;
                    
                    
                        var routetype=data[0][0];
                        transactionseqno = data[0][1];
                       enablefreereason = data[0][2];
                   
                    
                    localStorage.setItem("transactionseqno",transactionseqno);
                    localStorage.setItem("enablefreereason",enablefreereason);
                   
                    
                    $.mobile.hidePageLoadingMsg();
                    if(routetype==3)
                    {
                        $('#order').addClass('MenuGray');
                        $('#imgord').attr('src','../images/info-5_g.png');
                        $('#orderlink').attr('onclick','');
                    }
                    /*else
                    {                    
                        $('#order').removeClass('MenuGray');
                        $('#imgord').attr('src','../images/info-5.png');
                        $('#orderlink').attr('onclick',"localStorage.po ='orderrequest';SetVisitKey('orderRequest.html')");
                    }*/
                    if(routetype!=2 && sales==1)
                     {
                     $('#sales').removeClass('MenuGray');
                     $('#imgsales').attr('src','../images/info-6.png');
                     $('#saleslink').attr('href','salesinvoice_option.html');
                     
                     }
                     
                     
                     if(routetype==2){
                     
                     $('#sales').addClass('MenuGray');
                     $('#imgsales').attr('src','../images/info-6_g.png');
                     $('#saleslink').attr('href','');
                     $('#saleslink').attr('onclick','');
                     }
                    /* else
                     {
                     $('#sales').addClass('MenuGray');
                     $('#imgsales').attr('src','../images/info-6_g.png');
                     $('#saleslink').attr('href','');
                     
                     }*/
                     $.mobile.hidePageLoadingMsg();   
                     //CheckSalesBlock();
                     checkInvoiceSequence();
                     
                    

            }
            function loadRouteData(){
            //	alert("loadRouteData");
           	  	var routecode=sessionStorage.getItem("RouteCode");
                var platform= sessionStorage.getItem("platform");
                var selectqry = "select routemaster.routetype,transactionnoseq,enablefreereason,allowbalcheck from routemaster where routecode="+routecode;
                console.log(selectqry);
            	
            	window.plugins.DataBaseHelper.select(selectqry,function(result1)
                {
                		var array = $.map(result1.array, function (item, index) {               
                                  return [[item.routetype,item.transactionnoseq,item.enablefreereason,item.allowbalcheck]];
                        });
                		if(array[0][3]==1 && localStorage.getItem("customerBalanceSync").toString()=="false"){
                			sessionStorage.setItem("balanceUpdateEnabled",true);
                			getCustomerBalances(array);
                		}else{
                			sessionStorage.setItem("balanceUpdateEnabled",false);
                			TableDataOffLine1(array);
                		}
                		
              			
                },
                function()
                {
                console.warn("Error calling plugin");
                });
            	 	
            }
            
            /*
            *@method getCustomerBalances
            *function to get the customer balances before customer visit
            *Balance is checked only if routemaster allowbalcheck is 1
            *@param{array}
            */
            function getCustomerBalances(array){
            	//alert("getCustomerBalances");
            	$.mobile.showPageLoadingMsg();
           	 
           	 var customerbalance = {};
           	customerbalance["routecode"] =  sessionStorage.getItem("RouteCode");
           	customerbalance["customercode"] =  sessionStorage.getItem("customerid");
           	customerbalance = JSON.stringify(customerbalance);
           		 $.mobile.showPageLoadingMsg();
           		$.ajax({
           			type : "get",
           			url : wsurl + "ws/getcustomerbalance?customerbalance=[" + customerbalance + "]",
           			data : "{}",
           			cache : false,
           			timeout : 10000,
           			crossDomain : true,
           			success : function(data) {
           				if (data.length > 0) {
           					data = JSON.parse(data);
           					deleteCustomerBalances(data,array);
           				}else{
           					if(array)
           					TableDataOffLine1(array);
           					else
           						window.location.href="autosettler.html";
						 		
           					$.mobile.hidePageLoadingMsg();
           				}

           			},
           			error : function(qXHR, textStatus, errorThrown) {
           				if(array)
           					TableDataOffLine1(array);
           					else
           						window.location.href="autosettler.html";
           				alert("Connection error : " + qXHR.status + ":"
           						+ textStatus + " " + errorThrown);
           				$.mobile.hidePageLoadingMsg();
           			}
           		});

            	
            	
            }
            
            /*
            *@method deleteCustomerBalances
            *function to delete existinng data from customerinvoice which are not in invoiceheader and ardetail 
            *@param{data,array}
            */
        function deleteCustomerBalances(data,array){
            	//alert("deleteCustomerBalances");
            	var Qry="DELETE FROM customerinvoice where invoicenumber NOT IN(SELECT invoicenumber from invoiceheader " 
           		 +"union  select invoicenumber from ardetail) and customercode="+sessionStorage.getItem("customerid");
           	 if(platform=='Android')
             {
                                    
                     console.log(Qry);
                     window.plugins.DataBaseHelper.insert(Qry,function(result){
                    	 for ( var key in data) {
                 			switch (key) {
                 			case "customerbalance":
                 				var customerbalance = data[key];
                 				if (customerbalance.length > 0) {
                 					updateCustomerBalances(customerbalance,0,customerbalance.length,0,array)
                 						
                 				}else{
                 					if(array)
                       					TableDataOffLine1(array);
                       					else
                       						window.location.href="autosettler.html";
                 					$.mobile.hidePageLoadingMsg();
                 				}
                 				break;
                 			}
                 		}
                    	 
                          },
                          function()
                          {
                          console.warn("Error calling plugin");
                          });
                
             }
           	 
        }    
            
            /*
             *@method updateCustomerBalances
             *function to update the customer balances before customer visit
             *@param{data,array}
             */
            function updateCustomerBalances(itemdata,i,total,alltotal,array){
            	// alert("updateCustomerBalances");
            	 if(platform=='Android')
                 {
                        	 window.plugins.DataBaseHelper.select("select routecode from customerinvoice where routecode="+itemdata[i].routecode+" and invoicenumber="+itemdata[i].invoicenumber,function(result)
                     				{
                     				 if(!$.isEmptyObject(result))
                                                      {
                                                       var QrySelect="select count(*) as cnt from ardetail where invoicenumber="+itemdata[i].invoicenumber;
                                                              window.plugins.DataBaseHelper.select(QrySelect,function(result)
                                                             {
                                                                 if(result.array[0].cnt > 0)
                                                                     return true;
                                                                 else
                                                                     insert_customerinvoicedata(itemdata,i,"update");
                                                             },
                                                             function()
                                                             {
                                                                 console.warn("Error calling plugin");
                                                             });
                                                              
                                                             }
                                                             else
                                                             {
                                                                insert_customerinvoicedata(itemdata,i,"insert");
                                                             }
                                                             if(i+1 < total)
                                                             {
                                                            	 updateCustomerBalances(itemdata,i+1,total,alltotal,array);
                                                             }
                                                              else
                                                            {
                                                            	  localStorage.setItem("customerBalanceSync",true);
                                                            	  $.mobile.hidePageLoadingMsg();
                                                            	  if(array)
                                                     					TableDataOffLine1(array);
                                                     					else
                                                     						window.location.href="autosettler.html";
                                                            }
                     				},
                     				function()
                     				{
                     			   	 console.warn("Error calling plugin");
                     				});  
                
                    
                 }
            	
            }
             
             function insert_customerinvoicedata(customerinvoicedata,i,flag)
             {
            	// alert("insert_customerinvoicedata");
            	 var platform= sessionStorage.getItem("platform");
            	 if(platform=='Android')
  		    	{
                     if(flag=="insert")
                     {
                        
         								           	window.plugins.DataBaseHelper.insert("INSERT INTO `customerinvoice` ('transactionkey','transactiontype','documentnumber','invoicenumber','transactiondate','transactiontime','customercode','routecode','salesmancode','totalinvoiceamount','totalsalesamount','totalreturnamount','totaldamagedamount','totalfreesampleamount','immediatepaid','amountpaid','dnamountpaid','cnamountpaid','invoicebalance','paymenttype','voidflag','paymentstatus','hhcinvoicenumber','remarks1','remarks2','routestartdate','erpreferencenumber','mdat','totalpromoamount','gcpaymenttype','totaltaxesamount','itemlinetaxamount','totaldiscountamount','pdcindicator','chequecollection','totalexpiryamount','currencycode','pdcbalance','totalmanualfree','totallimitedfree','totalrebaterent','totalfixedrent','data','totaldiscdistributionamount','totalreplacementamount','pdcdate','totalbuybackfreeamount','duedate') VALUES ('"+customerinvoicedata[i].transactionkey+"','"+customerinvoicedata[i].transactiontype+"','"+customerinvoicedata[i].documentnumber+"','"+customerinvoicedata[i].invoicenumber+"','"+customerinvoicedata[i].transactiondate+"','"+customerinvoicedata[i].transactiontime+"','"+customerinvoicedata[i].customercode+"','"+customerinvoicedata[i].routecode+"','"+customerinvoicedata[i].salesmancode+"','"+customerinvoicedata[i].totalinvoiceamount+"','"+customerinvoicedata[i].totalsalesamount+"','"+customerinvoicedata[i].totalreturnamount+"','"+customerinvoicedata[i].totaldamagedamount+"','"+customerinvoicedata[i].totalfreesampleamount+"','"+customerinvoicedata[i].immediatepaid+"','"+customerinvoicedata[i].amountpaid+"','"+customerinvoicedata[i].dnamountpaid+"','"+customerinvoicedata[i].cnamountpaid+"','"+customerinvoicedata[i].invoicebalance+"','"+customerinvoicedata[i].paymenttype+"','"+customerinvoicedata[i].voidflag+"','"+customerinvoicedata[i].paymentstatus+"','"+customerinvoicedata[i].hhcinvoicenumber+"','"+customerinvoicedata[i].remarks1+"','"+customerinvoicedata[i].remarks2+"','"+customerinvoicedata[i].routestartdate+"','"+customerinvoicedata[i].erpreferencenumber+"','"+customerinvoicedata[i].mdat+"','"+customerinvoicedata[i].totalpromoamount+"','"+customerinvoicedata[i].gcpaymenttype+"','"+customerinvoicedata[i].totaltaxesamount+"','"+customerinvoicedata[i].itemlinetaxamount+"','"+customerinvoicedata[i].totaldiscountamount+"','"+customerinvoicedata[i].pdcindicator+"','"+customerinvoicedata[i].chequecollection+"','"+customerinvoicedata[i].totalexpiryamount+"','"+customerinvoicedata[i].currencycode+"','"+customerinvoicedata[i].pdcbalance+"','"+customerinvoicedata[i].totalmanualfree+"','"+customerinvoicedata[i].totallimitedfree+"','"+customerinvoicedata[i].totalrebaterent+"','"+customerinvoicedata[i].totalfixedrent+"','"+customerinvoicedata[i].data+"','"+customerinvoicedata[i].totaldiscdistributionamount+"','"+customerinvoicedata[i].totalreplacementamount+"','"+customerinvoicedata[i].pdcdate+"','"+customerinvoicedata[i].totalbuybackfreeamount+"','"+customerinvoicedata[i].duedate+"')",function(result)
         												{
         												 return true;
         												},
         												function()
         												{
         											   	 console.warn("Error calling plugin");
         												});
                     }else
                     {
                   
	                  window.plugins.DataBaseHelper.insert("update customerinvoice set transactionkey='"+customerinvoicedata[i].transactionkey+"',transactiontype='"+customerinvoicedata[i].transactiontype+"',documentnumber='"+customerinvoicedata[i].documentnumber+"',invoicenumber='"+customerinvoicedata[i].invoicenumber+"',transactiondate='"+customerinvoicedata[i].transactiondate+"',transactiontime='"+customerinvoicedata[i].transactiontime+"',customercode='"+customerinvoicedata[i].customercode+"',routecode='"+customerinvoicedata[i].routecode+"',salesmancode='"+customerinvoicedata[i].salesmancode+"',totalinvoiceamount='"+customerinvoicedata[i].totalinvoiceamount+"',totalsalesamount='"+customerinvoicedata[i].totalsalesamount+"',totalreturnamount='"+customerinvoicedata[i].totalreturnamount+"',totaldamagedamount='"+customerinvoicedata[i].totaldamagedamount+"',totalfreesampleamount='"+customerinvoicedata[i].totalfreesampleamount+"',immediatepaid='"+customerinvoicedata[i].immediatepaid+"',amountpaid='"+customerinvoicedata[i].amountpaid+"',dnamountpaid='"+customerinvoicedata[i].dnamountpaid+"',cnamountpaid='"+customerinvoicedata[i].cnamountpaid+"',invoicebalance='"+customerinvoicedata[i].invoicebalance+"',paymenttype='"+customerinvoicedata[i].paymenttype+"',voidflag='"+customerinvoicedata[i].voidflag+"',paymentstatus='"+customerinvoicedata[i].paymentstatus+"',hhcinvoicenumber='"+customerinvoicedata[i].hhcinvoicenumber+"',remarks1='"+customerinvoicedata[i].remarks1+"',remarks2='"+customerinvoicedata[i].remarks2+"',routestartdate='"+customerinvoicedata[i].routestartdate+"',erpreferencenumber='"+customerinvoicedata[i].erpreferencenumber+"',mdat='"+customerinvoicedata[i].mdat+"',totalpromoamount='"+customerinvoicedata[i].totalpromoamount+"',gcpaymenttype='"+customerinvoicedata[i].gcpaymenttype+"',totaltaxesamount='"+customerinvoicedata[i].totaltaxesamount+"',itemlinetaxamount='"+customerinvoicedata[i].itemlinetaxamount+"',totaldiscountamount='"+customerinvoicedata[i].totaldiscountamount+"',pdcindicator='"+customerinvoicedata[i].pdcindicator+"',chequecollection='"+customerinvoicedata[i].chequecollection+"',totalexpiryamount='"+customerinvoicedata[i].totalexpiryamount+"',currencycode='"+customerinvoicedata[i].currencycode+"',pdcbalance='"+customerinvoicedata[i].pdcbalance+"',totalmanualfree='"+customerinvoicedata[i].totalmanualfree+"',totallimitedfree='"+customerinvoicedata[i].totallimitedfree+"',totalrebaterent='"+customerinvoicedata[i].totalrebaterent+"',totalfixedrent='"+customerinvoicedata[i].totalfixedrent+"',data='"+customerinvoicedata[i].data+"',totaldiscdistributionamount='"+customerinvoicedata[i].totaldiscdistributionamount+"',totalreplacementamount='"+customerinvoicedata[i].totalreplacementamount+"',pdcdate='"+customerinvoicedata[i].pdcdate+"',totalbuybackfreeamount='"+customerinvoicedata[i].totalbuybackfreeamount+"',duedate='"+customerinvoicedata[i].duedate+"' where routecode='"+customerinvoicedata[i].routecode+"' and invoicenumber='"+customerinvoicedata[i].invoicenumber+"'",function(result)
	                                  {
	                                   return true;
	                                  },
	                                  function()
	                                  {
	                                   console.warn("Error calling plugin");

                						});
                   }
  		    	}
             }
            
            //function to check invoice 
            function checkInvoiceSequence(){
            	//alert("checkInvoiceSequence");  
            	var routecode=sessionStorage.getItem("RouteCode");
            	  //var selectQry="select (select ifnull(max(invoicenumber),0) from invoiceheader where istemp='false' and ifnull(dexflag,0)=0) as ihMax,(select ifnull(max(invoicenumber),0) from arheader where istemp='false') arMax,(select ifnull(max(invoicenumber),0) from salesorderheader where istemp='false') srMax,(select ifnull(max(invoicenumber),0) from invoiceheader where istemp='false' and ifnull(dexflag,0)=1) as ihretMax,(select hhcarseq from routemaster where routecode="+routecode+") as arseq,(select hhcinvseq from routemaster where routecode="+routecode+") as invseq,(select hhcordseq from routemaster where routecode="+routecode+") as ordseq,(select hhcinvretseq from routemaster where routecode="+routecode+") as invretseq";
            	  var selectQry="select (select ifnull(max(invoicenumber),0) from invoiceheader where istemp='false' and ifnull(dexflag,0)=0) as ihMax,(select ifnull(max(invoicenumber),0) from arheader where istemp='false') arMax,(select ifnull(max(invoicenumber),0) from salesorderheader where istemp='false') srMax,(select ifnull(max(invoicenumber),0) from invoiceheader where istemp='false' and ifnull(dexflag,0)=1) as ihretMax,(select ifnull(max(invoicenumber),0) from invoiceheader where istemp='false' and ifnull(dexflag,0)=2) as ihinvswapMax,(select hhcarseq from routemaster where routecode="+routecode+") as arseq,(select hhcinvseq from routemaster where routecode="+routecode+") as invseq,(select hhcordseq from routemaster where routecode="+routecode+") as ordseq,(select hhcinvretseq from routemaster where routecode="+routecode+") as invretseq,(select hhcinvswapseq from routemaster where routecode="+routecode+") as invswapseq";
            	  if (platform == "iPad") {
            		  
            	  
            	  }
            	  else
            	  {
            		  
            		  window.plugins.DataBaseHelper.select(selectQry,function(result)
            		  {		
                              var array = $.map(result.array, function (item, index) {               
                                return [[item.ihMax,item.arMax,item.srMax,item.ihretMax,item.ihinvswapMax,item.invseq,item.arseq,item.ordseq,item.invretseq,item.invswapseq]];
                              });
                             
                              if(array!=undefined && array!=null){
                            	
                            	  var routecodelength=eval(routecode.length)+1;
                            	  var invMAX=array[0][0];
                            	  var arMAX=array[0][1];
                            	  var ordMAX=array[0][2];
                            	  var invretMAX=array[0][3];
                            	  var invswapMAX=array[0][4];
                            	  
                            	  var invSeq=eval(array[0][5]);
                            	  var arSeq=eval(array[0][6]);
                            	  var ordSeq=eval(array[0][7]);
                            	  var invretSeq=array[0][8];
                            	  var invswapSeq=array[0][9];
                            	  
                            	  var diffINV=0;
                            	  var diffAR=0;
                            	  var diffORD=0;
                            	  var diffRINV=0;
                            	  var diffRSINV=0;
                            	  if(invMAX!=undefined && invMAX!=0){
                            		 
                            		  var acINVMax=parseInt(invMAX.substr(routecodelength,invMAX.length),10);
                            		 
                            		  diffINV=eval(acINVMax)-eval(invSeq);
                            		
                            		  if(diffINV==null || diffINV< 0 || diffINV==undefined){
                            			  diffINV=0;
                            			  
                            		  }
                            		  
                            	  }
                            		  
                            	  
                            	  if(arMAX!=undefined && arMAX!=0){
                            		  var acARMax=parseInt(arMAX.substr(routecodelength,arMAX.length),10);
                            		  diffAR=eval(acARMax)-eval(arSeq);
                            		 
                            		  if(diffAR=='' || diffAR<0 || diffAR==undefined){
                            			  diffAR=0;
                            			  
                            		  }
                            	  }
                            		 
                            	  
                            	  if(ordMAX!=undefined && ordMAX!=0){
                            		  var acORDMax=parseInt(ordMAX.substr(routecodelength,ordMAX.length),10);
                            		  diffORD=eval(acORDMax)-eval(ordSeq);
                            		  if(diffORD=='' || diffORD<0 || diffORD==undefined){
                            			  diffORD=0;
                            			  
                            		  }
                            	  }
                                	
                            	  if(invretMAX!=undefined && invretMAX!=0){
                            		  var acINVRETMax=parseInt(invretMAX.substr(routecodelength,invretMAX.length),10);
                            		  diffRINV=eval(acINVRETMax)-eval(invretSeq);
                            		  if(diffRINV=='' || diffRINV<0 || diffRINV==undefined){
                            			  diffRINV=0;
                            			  
                            		  }
                            	  }
                            	  
                            	  if(invswapMAX!=undefined && invswapMAX!=0){
                            		  var acINVSWAPMax=parseInt(invswapMAX.substr(routecodelength,invswapMAX.length),10);
                            		  diffRSINV=eval(acINVSWAPMax)-eval(invswapSeq);
                            		  if(diffRSINV=='' || diffRSINV<0 || diffRSINV==undefined){
                            			  diffRSINV=0;
                            			  
                            		  }
                            	  }
                            	  
                            	  
                            	  var updateQry = "UPDATE routemaster SET hhcinvseq = (ifnull(hhcinvseq,0) + "+diffINV+"),hhcarseq = (ifnull(hhcarseq,0) + "+diffAR+"),hhcordseq = (ifnull(hhcordseq,0) + "+diffORD+"),hhcinvretseq = (ifnull(hhcinvretseq,0) + "+diffRINV+"),hhcinvswapseq = (ifnull(hhcinvswapseq,0) + "+diffRSINV+") WHERE routecode=" + sessionStorage.getItem("RouteCode");
                            	  window.plugins.DataBaseHelper.insert(updateQry,function(result){   
                            		  UpdateDocumentSequence();
                             	     
                            	  },
                            	  function()
                            	  {
                                     console.warn("Error calling plugin");
                            	  });   
                            	 
                              }
                          	                                                
  					  },
					  function()
					  {
					   	 console.warn("Error calling plugin");
					  });
            		  
            		  
            	  }
            	
            }
            function UpdateDocumentSequence(){
            	//alert("UpdateDocumentSequence");  
            	var routecode=sessionStorage.getItem("RouteCode");
            	var selectQry="select  ifnull((select bodocseq from routemaster where routecode="+routecode+"),0) as bodseq,ifnull(max(documentnumber),0) as maxdoc from (select documentnumber from invoiceheader union all select documentnumber from inventorytransactionheader union all select documentnumber from arheader union all select documentnumber from salesorderheader)";
            	
            	if (platform == "iPad") {
           		  
               	  
           	  	}
           	    else
           	    {
           	     window.plugins.DataBaseHelper.select(selectQry,function(result)
               		  {		
                                 var array = $.map(result.array, function (item, index) {               
                                   return [[item.maxdoc,item.bodseq]];
                                 });
                                 if(array!=undefined && array!=null){
                               	  var routecodelength=eval(routecode.length);
                               	  var docMAX=array[0][0];
                               	  var docSeq=array[0][1];
                               	  
                               	  var diffDoc=0;
                               	  if(docMAX!=undefined && docMAX!=0){
                               		  var acDocMax=parseInt(docMAX.substr(routecodelength,docMAX.length),10);
                               		  diffDoc=eval(acDocMax)-eval(docSeq);
                               		  if(diffDoc==null || diffDoc < 0 || diffDoc==undefined){
                               			 diffDoc=0;
                               			  
                               		  }
                               		  
                               	  }
                               	  var updateQry = "UPDATE routemaster SET bodocseq = (ifnull(bodocseq,0) + "+diffDoc+") WHERE routecode=" + sessionStorage.getItem("RouteCode");
                               	  window.plugins.DataBaseHelper.insert(updateQry,function(result){   
                                 		console.log("Updated document Successfully");
                                 		
                               	  },
                               	  function()
                               	  {
                                        console.warn("Error calling plugin");
                               	  });   
                               	 
                                 }
                             	                                                
     					  },
   					  function()
   					  {
   					   	 console.warn("Error calling plugin");
   					  });
           	     
           	    }
            	
            	
            	
            }
            
            function TableDataOffLine(RecSet)
            {
            	//alert("TableDataOffLine");  
                
                var data = RecSet;
                var invcomment,enablesalespromotion,enableorderpromotion,transactionseqno,invoiceformatoption,invoicepaymentterms,enablesigcapture,enablefreereason,enablepriceeditinvs,arcustomertype,numoutstandinginv,enableSurvey;
         
                var sales=data[0][0];
                var arcoll=data[0][1];
                var adpay=data[0][2];
                invcomment=data[0][3];
                
                enablesalespromotion=data[0][4];
                enableorderpromotion=data[0][5];
               
                var invoiceformatoption = data[0][6];
                var invoicepaymentterms = data[0][7];
                var enablesigcapture = data[0][8];
                var enablepriceeditinvs = data[0][9];
                var arcustomertype = data[0][10];
                var numoutstandinginv = data[0][11];
               	var enableSurvey=data[0][12];
               	var enableExchnage=data[0][13];
                localStorage.setItem("enableinvoicecomment",invcomment);
                localStorage.setItem("enablesalespromotion",enablesalespromotion);
                localStorage.setItem("enableorderpromotion",enableorderpromotion);
                localStorage.setItem("enableexchange",enableExchnage);
                localStorage.setItem("invoiceformatoption",invoiceformatoption);
                sessionStorage.setItem("invoicepaymentterms",invoicepaymentterms);
                sessionStorage.setItem("SignEnabled",enablesigcapture);
                sessionStorage.setItem("enableadvancepayment",adpay);
                sessionStorage.setItem("enablepriceedit",enablepriceeditinvs);
                sessionStorage.setItem("enablesurvey",enableSurvey);
                localStorage.setItem("numoutstandinginv",numoutstandinginv);//bill to bill
             
                if(arcoll==0)
                {
                    $('#arcol').addClass('MenuGray');
                    $('#imgarcol').attr('src','../images/collection_g.png');
                    $('#arlink').attr('onclick','');
                }
                
                
                if(arcustomertype != 0 && numoutstandinginv != 0)
                {
                    billtobill = numoutstandinginv;
                }
               
                
                if(adpay==0)
                {
                    $('#adpay').addClass('MenuGray');
                    $('#imgadpay').attr('src','../images/info-7_g.png');
                    $('#adlink').attr('onclick','');
                                      
                }
                
                loadRouteData();
                
                    
                
            }
            function offlinegetrecord()
            {
            	//alert("offlinegetrecord");  
                $.mobile.showPageLoadingMsg();
                var custid=sessionStorage.getItem("customerid");
                var routecode=sessionStorage.getItem("RouteCode");
                var platform= sessionStorage.getItem("platform");
                var selectqry = "select routemaster.routetype,transactionnoseq,enablefreereason from routemaster where routecode="+routecode;
                console.log(selectqry);
                var selectqry1 = "select customermaster.enablesalestrxn,customermaster.enablearcollection,customermaster.enableadvancepayment,enableinvoicecomment,enablepromoeditinvs,enablepromoeditords,invoiceformatoption,invoicepaymentterms,enablesigcapture,enablepriceeditinvs,arcustomertype,numoutstandinginv,enablesurveyaudit,enableexchangetrxn,roundingoffvalue from customermaster where customercode="+custid;                
                console.log(selectqry1);
                if(platform=='iPad')
                    {
                 var abc = Cordova.exec(function(result) {
                 TableDataOffLine(result);
                 
                 
                  var abc = Cordova.exec(function(result1) {
                                            TableDataOffLine1(result1);
                                            },
                                            function(error) {
                                            alert(error);},
                                            "PluginClass", 
                                            "GetdataMethod", 
                                            [selectqry]);
                  
                  
                 },
                 function(error) {
                 alert(error);},
                 "PluginClass", 
                 "GetdataMethod", 
                 [selectqry1]);
                 
                }
                else if(platform=='Android')
           			{  		
			           		window.plugins.DataBaseHelper.select(selectqry1,function(result)
							{		
			           			var array = $.map(result.array, function (item, index) {       
			           		
			           				sessionStorage.setItem("roundingoffvalue",item.roundingoffvalue);
			           				
			           				return [[item.enablesalestrxn,item.enablearcollection,item.enableadvancepayment,item.enableinvoicecomment,item.enablepromoeditinvs,item.enablepromoeditords,item.invoiceformatoption,item.invoicepaymentterms,item.enablesigcapture,item.enablepriceeditinvs,item.arcustomertype,item.numoutstandinginv,item.enablesurveyaudit,item.enableexchangetrxn,item.roundingoffvalue]];
			           			});
							 		TableDataOffLine(array);
                                                                          
							},
							function()
							{
						   	 console.warn("Error calling plugin");
							});
           			}
                
            }
            

             function CheckOutStandingInvoices(url)
             {         
            	
            	// alert("CheckOutStandingInvoices");  
//                 if(sessionStorage.getItem("invoicepaymentterms") == 2)
//                 {
//                     if(eval(billtobill) > 0)
//                     {
//                         //var Qry = "SELECT COUNT(*) as cnt FROM customerinvoice ci  JOIN invoiceheader ih ON ih.invoicenumber = ci.invoicenumber  WHERE ih.routekey=" + sessionStorage.getItem("RouteKey") + " AND ci.invoicebalance>0 AND ci.customercode = " + sessionStorage.getItem("customerid");
//                     	var Qry="SELECT COUNT(*) as cnt FROM customerinvoice ci  WHERE ci.invoicebalance>0 AND ci.customercode = "+sessionStorage.getItem("customerid");
//                         console.log(Qry);
//                         if(platform == "iPad")
//                         {
//                             Cordova.exec(function(result) {
//                                 if(eval(result[0][0]) >= eval(billtobill))
//                                 {
//                                     navigator.notification.alert("Can't Do Credit Invoice.");
//                                     return false;
//                                 }
//                                 else
//                                     SetVisitKey(url);
//                             },
//                             function(error) {
//                                 alert(error);
//                             },
//                             "PluginClass", 
//                             "GetdataMethod", 
//                             [Qry]);                            
//                         }
//                         else if(platform == "Android")
//                         {
                        	
//                             window.plugins.DataBaseHelper.select(Qry, function(result) 
//                             {
                            	
//                                 if(eval(result.array[0].cnt) >= eval(billtobill))
//                                 {
//                                 	var count=eval(result.array[0].cnt)-eval(billtobill);
// 								    $.mobile.hidePageLoadingMsg(); 
//                                     navigator.notification.alert("Only "+eval(billtobill)+" open invoice(s) is allowed. Please clear the old invoices.");
//                                     return false;
//                                 }
//                                 else
//                                     SetVisitKey(url);
//                             },
// 							function() {
// 							    console.warn("Error calling plugin");
// 							});
//                         }
//                     }
//                     else
//                         SetVisitKey(url);
//                 }
//                 else
                    SetVisitKey(url);
             }
             
              function SetVisitKey(url) {
                 //localStorage.po = 'sales';                 
                //alert("SetVisitKey");  
				var selectqry="select ifnull(max(visitkey),0) as VisitKey,totaltransactions,reasoncode from customeroperationscontrol where routekey = " + sessionStorage.getItem("RouteKey");
                 console.log(selectqry);
                 var platform= sessionStorage.getItem("platform");
                 if(platform=='iPad')
                 {
                     Cordova.exec(function(result) {
	                               
                                      if(eval(result[0][1]) > 0 || eval(result[0][2]) > 0)
                                        InserVisitKeys(url);
                                      else
                                        deletetransaction(url,result[0][0]);   
                                   
                                   },
                                   function(error) {
                                   alert(error);
                                   },
                                   "PluginClass",
                                   "GetdataMethod",
                                   [selectqry]);
                 }
                 else if(platform=='Android')
                 {
                     window.plugins.DataBaseHelper.select(selectqry,function(result)
                                                          {
                                                          if(eval(result.array[0].totaltransactions) > 0 || eval(result.array[0].reasoncode) > 0)
                                                          InserVisitKeys(url);
                                                          else
                                                          deletetransaction(url,result.array[0].VisitKey);        
                                                          },
                                                          function()
                                                          {
                                                          console.warn("Error calling plugin");
                                                          });
                 }
                
             }
             function deletetransaction(url,VisitKey)
            {
            	// alert("deletetransaction");  
            	 var platform= sessionStorage.getItem("platform");
                var deleteqry="delete from customeroperationscontrol where routekey = " + sessionStorage.getItem("RouteKey")+" and visitkey="+VisitKey;
                console.log(deleteqry);
                if(platform=='iPad')
                {
	                Cordova.exec(function(result) {
                                  var Tbls = ["invoicedetail","promotiondetail","invoicerxddetail","cashcheckdetail","invoiceheader","inventorytransactionheader","inventorytransactiondetail","inventorysummarydetail","batchexpirydetail","salesorderdetail","salesorderdetail","posequipmentchangedetail","surveyauditdetail","arheader","ardetail","customerinventorydetail","promotionfreetemp","orderrxddetail"];
                                  for(i=0;i<Tbls.length;i++)
                                  {
                                  if(i == 5 || i == 6 || i == 7)
                                  {
                                  var Qry = "DELETE FROM " + Tbls[i] + " WHERE istemp='true' and transactiontypecode!=07 and routekey=" + sessionStorage.getItem("RouteKey");
                                  }
                                  else if(i == 11 || i == 12)
                                  {
                                  var Qry = "DELETE FROM " + Tbls[i] + " WHERE routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + VisitKey;
                                  }
                                  else
                                  {            
                                  var Qry = "DELETE FROM " + Tbls[i] + " WHERE istemp='true' and routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + VisitKey;
                                  }
                                  console.log(Qry);
                                  Cordova.exec(function(result) {
                                               
                                               
                                                
                                                },
                                                function(error) {
                                                alert(error);},
                                                "PluginClass", 
                                                "InsertUpdateMethod", 
                                                [Qry]);
                                  }
                                  InserVisitKeys(url);
                                  
                                  
                                  },
                                  function(error) {
                                  alert(error);
                                  },
                                  "PluginClass",
                                  "InsertUpdateMethod",
                                  [deleteqry]);
                }
                else if(platform=='Android')
                {
		      		window.plugins.DataBaseHelper.insert(deleteqry,function(result)
                                                         {
                                                         var Tbls = ["invoicedetail","promotiondetail","invoicerxddetail","cashcheckdetail","invoiceheader","inventorytransactionheader","inventorytransactiondetail","inventorysummarydetail","batchexpirydetail","salesorderheader","salesorderdetail","posequipmentchangedetail","surveyauditdetail","arheader","ardetail","customerinventorydetail","orderrxddetail"];
                                                         for(i=0;i<Tbls.length;i++)
                                                         {
                                                         if(i == 5 || i == 6 || i == 7)
                                                         {
                                                         var Qry = "DELETE FROM " + Tbls[i] + " WHERE istemp='true' and transactiontypecode!=07 and routekey=" + sessionStorage.getItem("RouteKey");
                                                         }
                                                         else if(i == 11 || i == 12 || i==15)
                                                         {
                                                         var Qry = "DELETE FROM " + Tbls[i] + " WHERE routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + VisitKey;
                                                         }else if(i==9){
                                                        	 var Qry = "DELETE FROM " + Tbls[i] + " WHERE istemp='true' and routekey=" + sessionStorage.getItem("RouteKey")+ " and visitkey=" + sessionStorage.getItem("VisitKey")+" and coalesce(dexflag,0)<>1";
                                                         }
                                                         else
                                                         {            
                                                         var Qry = "DELETE FROM " + Tbls[i] + " WHERE istemp='true' and routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + VisitKey;
                                                         }
                                                         console.log(Qry);
                                                         window.plugins.DataBaseHelper.insert(Qry,function(result)
                                                                                              {
                                                                                              
                                                                                              },
                                                                                              function()
                                                                                              {
                                                                                              console.warn("Error calling plugin");
                                                                                              });
                                                         }
                                                         // org line sujee commented 
                                                     // InserVisitKeys(url);
                                                       checkSessionstorage(url);  // added to check session storage and update 27/07/2020
                                                         },
                                                         function()
                                                         {
                                                         console.warn("Error calling plugin");
                                                         });
                }
            }
            function  checkSessionstorage(url)
             {
            	// alert("checkSessionstorage");
            	 var Qry="SELECT count(*) as cnt  from customeroperationscontrol WHERE  routekey= 'null'  ";
            	 console.log(Qry);
            	// alert(Qry);
            	 if(platform=='Android')
                	{
     		      		window.plugins.DataBaseHelper.select(Qry,function(result)
     				{
                              		//alert(result.array[0].cnt );
                              		if(result.array[0].cnt > 0)
                              			{
                              			updateSessionstorage(url);
                              			} else {
                              			 InserVisitKeys(url);
                              			}
                              	 
     		        
     				},
                             	function()
     				{
     			   	 console.warn("Error calling plugin");
     				});
                	}
            	 
             }
            
            function updateSessionstorage(url)
            {
            	//alert("updateSessionstorage");
            	var Qry ="Update customeroperationscontrol set routekey= (select max(routekey)  from startendday where routecode = " + sessionStorage.getItem('RouteCode') + " and salesmancode = " + sessionStorage.getItem('SalesmanCode') + " and routeclosed=0) ";
            	console.log(Qry);
            	//alert(Qry);
            	 if(platform=='Android')
 	           	{
 		      		window.plugins.DataBaseHelper.insert(Qry,function(result)
 				    {
                          		
                                   // alert("updated");
                                    InserVisitKeys(url);
                                                         
 					},
 	                        	function()
 					{
 				   	 console.warn("Error calling plugin");
 					});
            	}
            }
            function InserVisitKeys(url)
            {
                 //localStorage.po = 'sales'; 
               //  alert("InserVisitKeys");  
               localStorage.removeItem("tmpargrid");
               localStorage.removeItem("manualfree");
               localStorage.removeItem("isreturn")
               var Qry = "select (ifnull(max(visitkey),0) + 1) as VisitKey from customeroperationscontrol where routekey = " + sessionStorage.getItem("RouteKey");
				var platform= sessionStorage.getItem("platform");
                if(platform=='iPad')
                {
	                Cordova.exec(function(result) {
	                               
	                     if (result != '')
                             {
	                         sessionStorage.setItem("VisitKey", result);
                                 var visitkey=result;
                             }
	                     else
                             {
	                         sessionStorage.setItem("VisitKey", 1);
                                 var visitkey=1;
                             }          
	                    insertvisitkey(url,visitkey);    
                            
	                },
	                function(error) {
	                        alert(error);
	                },
	                "PluginClass",
	                "GetdataMethod",
	                [Qry]);
                }
	        else if(platform=='Android')
           	{
		      		window.plugins.DataBaseHelper.select(Qry,function(result)
				{
                         		if (result.array[0].VisitKey != undefined)
			 		{
	                         		sessionStorage.setItem("VisitKey", result.array[0].VisitKey);
                                                 var visitkey=result.array[0].VisitKey;
		                        }
                                        else{
                                                 sessionStorage.setItem("VisitKey", 1);
                                                  var visitkey=1;
	                               }
                                        insertvisitkey(url,visitkey);               
				},
                        	function()
				{
			   	 console.warn("Error calling plugin");
				});
           	}
             }
             function onsuccess(position)
             {
            	// alert("onsuccess");  
            	 latitude = position.coords.latitude;
              longitude =position.coords.longitude;
             }
             function onError()
             {
             }
             function insertvisitkey(url,visitkey)
             { //alert("insertvisitkey")
   				//navigator.geolocation.getCurrentPosition(onsuccess, onError);
            // alert(sessionStorage.getItem("RouteKey"));
                latitude =localStorage.getItem("latitude");
                 longitude =localStorage.getItem("longitude");
                 
                var platform= sessionStorage.getItem("platform");
                var Odometer= sessionStorage.getItem("Odometer");
                 var qry = "insert into customeroperationscontrol ('visitkey','routekey','customercode','routecode','salesmancode','visitstartdate','visitstarttime','visitenddate','latitude','longitude','issync','odometerreading') values ('"+visitkey+"','"+sessionStorage.getItem("RouteKey")+"','"+sessionStorage.getItem("customerid")+"','"+sessionStorage.getItem("RouteCode")+"','"+sessionStorage.getItem("SalesmanCode")+"',date(),'"+sessionStorage.getItem("starttime")+"',date(),'"+latitude+"','"+longitude+"',0,"+Odometer+") ";
                console.log(qry);
                if(platform=='iPad')
                {
	                Cordova.exec(function(result) {
                                  if(url == 'salesinvoice_option.html')
                                  deletebatchmaster(); 
                                  else
                                  window.location.href=url;
	                },
	                function(error) {
	                        alert(error);
	                },
	                "PluginClass",
	                "InsertUpdateMethod",
	                [qry]);
                }
		        else if(platform=='Android')
	           	{
		      		window.plugins.DataBaseHelper.insert(qry,function(result)
				    {
                         		
                                                         if(url == 'salesinvoice_option.html')
                                                        	 	deletebatchmaster(); 
                                                         else{
                                                        	 
														 		 $.mobile.hidePageLoadingMsg(); 
														 		 
														 		 if(url=="orderRequest.html"){
														 			 checkOnShelfQty(url);
														 		 }else if(url=="autosettler.html"){
														 			 if(sessionStorage.getItem("balanceUpdateEnabled").toString()=="true"){
														 			getCustomerBalances();
														 			 }else{
														 				window.location.href=url;
														 			 }
														 		 }
														 		 else{
														 			 window.location.href=url;
														 		 }
														 		
														 }
                                                        
					},
	                        	function()
					{
				   	 console.warn("Error calling plugin");
					});
           	}
             }
             
function checkOnShelfQty(url){
	//alert("checkOnShelfQty");  
	var Qry="SELECT enablesuggestsales FROM customermaster WHERE customercode ="+sessionStorage.getItem("customerid");
	if(platform=='Android')
    {
        window.plugins.DataBaseHelper.select(Qry,function(result)
                                             {
                                             
        										if(result.array[0].enablesuggestsales<2){
        											navigator.notification.alert("Please Take Outlet Inventory.",function(){
        												
        												sessionStorage.setItem("backScreen",url);
        												window.location="../customer/../customer/customer_inventory.html";
        											});
        										}else{
        											window.location=url;
        										}
                                             },
                                             function()
                                             {
                                             console.warn("Error calling plugin");
                                             });
    }
	
}             
            function checkenable(url)
            {
            	//alert("checkenable");  
                
                var routekey=sessionStorage.getItem("RouteKey");
                var platform= sessionStorage.getItem("platform");
                console.log("select sum(invoicebalance) as balance from customerinvoice where routecode="+sessionStorage.getItem("RouteCode")+" and customercode="+sessionStorage.getItem("customerid"));
                if(platform=='iPad')
                {
                    Cordova.exec(function(result) {
                                  
                                  checkcustomer(result[0][0],url);
                                  },
                                  function(error) {
                                  alert(error);
                                  },
                                  "PluginClass",
                                  "GetdataMethod",
                                  ["select sum(invoicebalance) as balance from customerinvoice where routecode="+sessionStorage.getItem("RouteCode")+" and customercode="+sessionStorage.getItem("customerid")]);
                }
                else if(platform=='Android')
                {
                    window.plugins.DataBaseHelper.select("select sum(invoicebalance) as balance from customerinvoice where voidflag = 0 and customercode="+sessionStorage.getItem("customerid"),function(result)
                                                         {
                                                         checkcustomer(result.array[0].balance,url);
                                                         },
                                                         function()
                                                         {
                                                         console.warn("Error calling plugin");
                                                         });
                }
            }
            function checkcustomer(balance,url)
            {
            	//alert("checkenable");
            	var custid=sessionStorage.getItem("customerid");
                var platform= sessionStorage.getItem("platform");
                var routecode=sessionStorage.getItem("RouteCode");
                var CompanyCode=sessionStorage.getItem("CompanyCode");
                if(balance=='')
                balance=0;
                
                //var Qry=""select creditlimit,invoicepaymentterms from customermaster where customercode="+custid"
                var Qry="select ifnull(rm.routecreditcheck,0) as routecreditcheck, ifnull(routecreditlimit,0) routecreditlimit, (CASE WHEN jp.creditlimit IS NOT NULL THEN jp.creditlimit ELSE cm.creditlimit END) AS creditlimit,invoicepaymentterms,ifnull(cm.gracelimit,0) as gracelimit,ifnull(rm.routebalance,0) routebalance from customermaster cm left join journeyplancreditlimit jp ON jp.customercode = cm.customercode and jp.routecode = " + sessionStorage.getItem("RouteCode") + "  join routemaster rm where cm.customercode="+custid+" and rm.routecode="+sessionStorage.getItem("RouteCode");
                
                if(platform=='iPad')
                {
                    Cordova.exec(function(result) {
                                  
                                  if(eval(result[0][1]) > 1)
                                  {
                                  if(eval(balance) > eval(result[0][0]))
                                  {
                                  navigator.notification.alert("Credit Limit Exceeded",onConfirm);
                                 
                                  //window.location.href=url;
                                  }
                                  else
                                  {
                                  window.location.href=url;
                                  }
                                  }
                                  else
                                  {
                                  window.location.href=url;
                                  }
                                  },
                                  function(error) {
                                  alert(error);
                                  },   
                                  "PluginClass",
                                  "GetdataMethod",
                                  [Qry]);
                }
                else if(platform=='Android')
                {
                    window.plugins.DataBaseHelper.select(Qry,function(result)
                                                         {
														 //if(eval(result[0][1]) > 1)
                                  
														// var balance =eval(result.array[0].balance) - eval(balance);
														 var routeCreditCheck=eval(result.array[0].routecreditcheck);
										 				 var routecreditlimit=eval(result.array[0].routecreditlimit);
										 				 var customercreditlimit=eval(result.array[0].creditlimit);
										 				 var routebalance=result.array[0].routebalance;
														 if(routebalance=='' || routebalance==null || routebalance==undefined){
															 routebalance=0;
														 }
											 				 if(routeCreditCheck==1){
		                                                         if(eval(routebalance) > routecreditlimit)
		                                                         {
																     $.mobile.hidePageLoadingMsg(); 
		                                                        	 alert("Credit Limit Exceeded");
		                                                         	 SetVisitKey(url);
		                                                             //window.location.href=url;
		                                                         }
		                                                         else
		                                                         {
		                                                        	 //window.location.href=url;
		                                                        	 
		                                                        	 if(eval(balance) > customercreditlimit)
			                                                         {
																	     $.mobile.hidePageLoadingMsg(); 
			                                                        	 alert("Credit Limit Exceeded");
			                                                         	 SetVisitKey(url);
			                                                             //window.location.href=url;
			                                                         }
			                                                         else
			                                                         {
			                                                        	 //window.location.href=url;
			                                                        	 
			                                                        	 SetVisitKey(url);
			                                                         } 
		                                                         }
	                                                         
											 				 }else{
											 					 
											 					 if(eval(balance) > customercreditlimit)
		                                                         {
																     $.mobile.hidePageLoadingMsg(); 
		                                                        	 alert("Credit Limit Exceeded");
		                                                         	 SetVisitKey(url);
		                                                             //window.location.href=url;
		                                                         }
		                                                         else
		                                                         {
		                                                        	 //window.location.href=url;
		                                                        	 
		                                                        	 SetVisitKey(url);
		                                                         } 
											 					 
											 					 
											 				 }
                                                         },
                                                         function()
                                                         {
                                                         console.warn("Error calling plugin");
                                                         });
                }
            }
            function onConfirm(button)
            {               
            	//alert("onConfirm");
            	if(button == 1)
                {
                	
//                    var d = new Date();
//                    var n = d.getMinutes();                                        
//                    //var s = d.getSeconds();
//                    if(n<10)
//                    n='0'+n;
//                    var key = routecode+CompanyCode+n;
//                    var str = key;
                	var customercode=sessionStorage.getItem("RouteCode").toString().slice(-2);
    	            var d = new Date();
    	            var unixtime = parseInt(d.getTime() / 1000);
    	            var randomnumber= Math.floor(Math.random() * 9999999) + 100000;
    	            console.log(CompanyCode);
    	            var timestamp=unixtime.toString().slice(-7)+customercode;
    	            var key =  Math.abs(eval(timestamp)-eval(randomnumber));
    	            var str = key.toString();
    				
                	
                    var a=str.split(''), b = a.length;
                    for (var i=0; i<b; i++) {
                        a.unshift(a.splice(1+i,1).shift())
                    }
                    a.shift();
                    var pass = a.join('');
                    $('#passkey').text(pass);
                    console.log(key);
                                 
                    
                    
                    popuppasswordgenerator('saleslink','cust_opt.html',tblPassword.innerHTML,'cust_opt.html');
                  
                    
                }
            }
            
            function showExitAlert(){
            	
            	//alert("showExitAlert");
            	navigator.notification.confirm(getLangTextdata("Are You Sure To Close This Call."),CheckRedirection);
            	
            	
            	
            }
            function CheckRedirection(button)
            {               
            	//alert("CheckRedirection");
            	if(button == 1)
                {
                	insertendtime(1);
                }
            }
            function insertendtime(flag)
            {
            	//alert("insertendtime");
            	var platform= sessionStorage.getItem("platform");
                var starttime = sessionStorage.getItem("starttime");
                var mydate = new Date();
                
                var thehour = mydate.getHours();
                var theminut = mydate.getMinutes();
                var time = thehour+":"+theminut;
                            
                            
                if(flag == 1)
                    nonservice();
                else
                    window.location.href="../customer/customer_operation.html";
              /*  var insertqry = "update customeroperationscontrol set visitendtime='"+time+"',issync=0 where routekey='"+sessionStorage.getItem("RouteKey")+"' and customercode='"+sessionStorage.getItem("customerid")+"' and routecode='"+sessionStorage.getItem("RouteCode")+"' and visitstarttime='"+starttime+"'";
                console.log(insertqry);
                if(platform=='iPad')
                {
                Cordova.exec(function(result) {                    
                              if(flag == 1)
                              nonservice();
                              else
                              window.location.href="../customer/customer_operation.html";
                              },
                              function(error) {
                              navigator.notification.alert(error);
                              },
                              "PluginClass",
                              "InsertUpdateMethod",
                              [insertqry]);
                }
                else if(platform=='Android')
                {
                    window.plugins.DataBaseHelper.insert(insertqry,function(result)
                                                         {
                                                         if(flag == 1)
                                                         nonservice();
                                                         else
                                                         window.location.href="../customer/customer_operation.html";
                                                         },
                                                         function()
                                                         {
                                                         console.warn("Error calling plugin");
                                                         });
                }*/
                
                
            }
            function nonservice()
            {
            	//alert("nonservice");
            	var platform= sessionStorage.getItem("platform");
                var starttime = sessionStorage.getItem("starttime");
                var qry = "select sum(totaltransactions) as totaltrans from customeroperationscontrol where routekey='"+sessionStorage.getItem("RouteKey")+"' and customercode='"+sessionStorage.getItem("customerid")+"' and routecode='"+sessionStorage.getItem("RouteCode")+"' and visitstarttime='"+starttime+"' group by customercode,routecode,visitstarttime";
                console.log(qry);
                               
                
                
                if(platform=='iPad')
                {
                    Cordova.exec(function(result) {
                                  if(result != '')
                                  {
                                  if(result[0][0] > 0)
                                  {
                                    window.location.href="../customer/customer_operation.html";
                                  }
                                  else
                                  {
                                    window.location.href="../customer/non_serviced_customer.html";
                                  }
                                  }
                                  else
                                  {
                                  window.location.href="../customer/non_serviced_customer.html";
                                  }
                                  
                                  },
                                  function(error) {
                                  alert(error);
                                  },
                                  "PluginClass",
                                  "GetdataMethod",
                                  [qry]);
                }
                else if(platform=='Android')
                {
                    window.plugins.DataBaseHelper.select(qry,function(result)
                                                         {
                                                         if(result.array != undefined)
                                                         {
                                                       	 if(result.array[0].totaltrans > 0)
                                                         {
                                                        	 updateEndTime();
                                                         }
                                                         else
                                                         {
                                                         window.location.href="../customer/non_serviced_customer.html";
                                                         }
                                                         }
                                                         else
                                                         {
                                                         window.location.href="../customer/non_serviced_customer.html";
                                                         }
                                                         },
                                                         function()
                                                         {
                                                         console.warn("Error calling plugin");
                                                         });
                }
            }
           function deletebatchmaster()
            {
        	  // alert("deletebatchmaster");
        	   var platform= sessionStorage.getItem("platform");
                var qry ="delete from batchmaster_temp";
                console.log(qry);
                if(platform=='iPad')
                {
                    return abc = Cordova.exec(function(result) {
                                               insertbatchmaster();
                                               },
                                               function(error) {
                                               alert(error);},
                                               "PluginClass", 
                                               "InsertUpdateMethod", 
                                               [qry]);
                }
                else if(platform=='Android')
                {
                    window.plugins.DataBaseHelper.insert(qry,function(result)
                                                         {
                                                         insertbatchmaster();
                                                         },
                                                         function()
                                                         {
                                                         console.warn("Error calling plugin");
                                                         });
                } 
            }
            function insertbatchmaster()
            {
            	//alert("insertbatchmaster");
            	var platform= sessionStorage.getItem("platform");
                var qry ="insert into batchmaster_temp('quantity','badquantity','itemcode','batchdetailkey','batchnumber','expirydate') select ifnull(quantity,0),ifnull(damagequantity,0),itemcode,batchdetailkey,batchnumber,expirydate from batchmaster where batchnumber IS NOT NULL";
                console.log(qry);
                if(platform=='iPad')
                {
                    return abc = Cordova.exec(function(result) {
                                               window.location ='salesinvoice_option.html';
                                               },
                                               function(error) {
                                               alert(error);},
                                               "PluginClass", 
                                               "InsertUpdateMethod", 
                                               [qry]);
                }
                else if(platform=='Android')
                {
                    window.plugins.DataBaseHelper.insert(qry,function(result)
                                                         {
														 $.mobile.hidePageLoadingMsg(); 
                                                         window.location ='salesinvoice_option.html';
                                                         },
                                                         function()
                                                         {
                                                         console.warn("Error calling plugin");
                                                         });
                } 
            }
            function checksurvey(url)
            {
            	//alert("checksurvey");
			    $.mobile.showPageLoadingMsg(); 
			    
			    if(url=='exit'){
			    	var Qry="select CASE WHEN COALESCE(SUM(COALESCE(co.visitkey,0)),1) > 0 THEN 0 ELSE 1 END cnt FROM customermaster cm INNER JOIN customersurveykeyplan cskp on cskp.surveykey = cm.surveykey INNER JOIN customersurveyplan csp on csp.surveyplankey = cskp.surveyplankey AND csp.surveymandatory = 1 LEFT OUTER JOIN (SELECT coc.customercode, coc.visitkey, sad.surveyplankey FROM customeroperationscontrol coc INNER JOIN surveyauditdetail sad on sad.visitkey = coc.visitkey) co ON co.customercode = cm.customercode AND co.surveyplankey = csp.surveyplankey WHERE cm.customercode="+sessionStorage.getItem("customerid");
	                console.log(Qry);
					if(platform == "iPad")
	                {
	                    Cordova.exec(function(result) 
	                                  {
			                                  if(result[0][0] == 0)
			                                  {
				                                  if(url =='salesinvoice_option.html'){
				                                    sessionStorage.setItem("suggestedvisit",0);
				                                    CheckOutStandingInvoices(url);
				                                  }                                  
				                                  else if(url=='orderRequest.html')
				                                  {
					                                  checkenable('orderRequest.html');
					                                  SetVisitKey(url);
				                                  }
				                                  else
				                                  SetVisitKey(url);
			                                  }
			                                  else
			                                  {
			                                	  navigator.notification.alert("Please Fill Survey First.");
			                                  }
	                                  }, 
	                                  function(error) {
	                                  alert(error);
	                                  },
	                                  "PluginClass",
	                                  "GetdataMethod",
	                                  [Qry]);
	                }
	                else if(platform == "Android")
	                {
	                    window.plugins.DataBaseHelper.select(Qry,function(result)
	                                                         {
	                                                         if(result.array != undefined)
	                                                         {
	                                                        	 $.mobile.hidePageLoadingMsg(); 
		                                                         if(result.array[0].cnt== 0)
		                                                         {
		                                                        	 showExitAlert();
		                                                         }
		                                                         else
		                                                         {
																	
		                                                        	 getLangText("Please Fill Survey First.");
		                                                         }
	                                                         }
	                                                         },
	                                                         function()
	                                                         {
	                                                         console.warn("Error calling plugin");
	                                                         });
	                }
			    	
			    	
			    	
			    }else{
			    	
			    	if(url =='salesinvoice_option.html'){
                        sessionStorage.setItem("suggestedvisit",0);
                         CheckOutStandingInvoices(url);
                     }                                                        
                     else if(url=='orderRequest.html')
                     {
	                     sessionStorage.removeItem("OrderDate");		 
	                     checkenable('orderRequest.html');
                     
                     }
                     else 
                    	 SetVisitKey(url);
			    		
			    }
			    
			    
            	
            }
            function rediretAdvance(){
             
            	//alert("rediretAdvance");
             	var Qry = "DELETE FROM arheader WHERE istemp='true'";
       			if (platform == 'iPad') {
            
            
            	}else{
            
            		window.plugins.DataBaseHelper.select(Qry, function(result) {
                   
                   			localStorage.removeItem("AdvanceInvoice");
              
                			localStorage.removeItem("DocNos");
            				localStorage.po = 'advance';
            				checksurvey('../customer/advance_payment.html');
                	},
		       		function() {
		        	
		           
		       		});
            
            	}
             
             }
            
            
   /*
   *@method checkInvoiceImageCaptured
   *Function to check whether the image for the completed invoice is captured
   *@param{url}
   */         
   function checkInvoiceImageCaptured(url){
	   //alert("checkInvoiceImageCaptured");
	   checksurvey(url);
   }    
   function updateEndTime(){
	  // alert("updateEndTime");
	   var platform= sessionStorage.getItem("platform");
       var starttime = sessionStorage.getItem("starttime");
       var mydate = new Date();
       
       var thehour = mydate.getHours();
       var theminut = mydate.getMinutes();
       var time = thehour+":"+theminut;
           
       var insertqry = "update customeroperationscontrol set visitendtime='"+time+"',issync=0 where routekey='"+sessionStorage.getItem("RouteKey")+"' and customercode='"+sessionStorage.getItem("customerid")+"' and routecode='"+sessionStorage.getItem("RouteCode")+"' and visitstarttime='"+starttime+"'";
       console.log(insertqry);
       if(platform=='iPad')
       {
       Cordova.exec(function(result) {                    
                     if(flag == 1)
                     nonservice();
                     else
                     window.location.href="../customer/customer_operation.html";
                     },
                     function(error) {
                     navigator.notification.alert(error);
                     },
                     "PluginClass",
                     "InsertUpdateMethod",
                     [insertqry]);
       }
       else if(platform=='Android')
       {
           window.plugins.DataBaseHelper.insert(insertqry,function(result)
                                                {
                                               
        	   										window.location.href="../customer/customer_operation.html";
                                                
                                                },
                                                function()
                                                {
                                                console.warn("Error calling plugin");
                                                });
       }
    	
    	
    	
    	
    }
   /*
    *@method getRouteBalances
    *function to get the Route balances before customer visit
    *Balance is checked only if routemaster allowbalcheck is 1
    *@param{array}
    */
    function getRouteBalances(url){
    	//alert("getRouteBalances");
    	$.mobile.showPageLoadingMsg();
    localStorage.info='cust';
   	 var routebalance = {};
   	 routebalance["routecode"] =  sessionStorage.getItem("RouteCode");
   	
   	 routebalance = JSON.stringify(routebalance);
   	 $.ajax({
   			type : "get",
   			url : wsurl + "ws/getroutebalance?routebalance=[" + routebalance + "]",
   			data : "{}",
   			cache : false,
   			timeout : 10000,
   			crossDomain : true,
   			success : function(data) {
   				$.mobile.hidePageLoadingMsg();
   				if (data.length > 0) {
   					data = JSON.parse(data);
					var routebalance=data["routebalance"][0].routebalance;
					if(routebalance!=undefined){
						updateRouteBalance(routebalance,url)
					}else{
						window.location=url;
					}
					
   				}else{
   					window.location=url;
   				}

   			},
   			error : function(qXHR, textStatus, errorThrown) {
   				$.mobile.hidePageLoadingMsg();
   				alert("Connction Error: Balance Not found" + qXHR.status + ":"
   						+ textStatus + " " + errorThrown);
   				window.location=url;
   				
   				
   			}
   		});

    	
    	
    }

    function updateRouteBalance(balance,url){
    //	alert("updateRouteBalance");
   	   var Qry = "UPDATE routemaster SET routebalance = '"+balance+"' WHERE routecode=" + sessionStorage.getItem("RouteCode");
   	    console.log(Qry);
   	    if (platform == "iPad") {
   	        Cordova.exec(function (result) {
   	            
   	        },
   	
   	        function (error) {
   	            alert(error);
   	        },
   	            "PluginClass",
   	            "InsertUpdateMethod", [Qry]);
   	    } else if (platform == "Android") {
   	        window.plugins.DataBaseHelper.insert(Qry, function (result) {
   	        	window.location=url;
   	        },
   	
   	        function () {
   	            console.warn("Error calling plugin");
   	        });
   	    }
   	 
   	 
    }
    
   </script>

	</div>
</body>
</html>
