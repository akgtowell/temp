<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>Buy Back Free</title>
       <meta name="viewport" content="width=device-width, initial-scale=1.0;maximum-scale=1.0;user-scalable=0; target-densitydpi=device-dpi">
	
        <meta name="format-detection" content="telephone=no">
            <link rel="stylesheet" href="../css/style.css" />
            <link rel="stylesheet" href="../css/en.css" lang="en" />
            <link rel="stylesheet" href="../css/jquery.mobile-1.0.min.css" />
            <link rel="stylesheet" media="only screen and (min-width: 320px) and (max-width: 600px)"
                href="../css/style_600.css">
                <!--Black P-->
                <link rel="stylesheet" media="only screen and (min-width: 600px) and (max-width: 700px)"
                    href="../css/style_700.css">
                    <!--Iphone 4 P-->
                    <link rel="stylesheet" media="only screen and (min-width: 700px) and (max-width: 800px)"
                        href="../css/style_800.css">
                        <!--Ipad P-->    
                        <!--Black L-->
                        <link rel="stylesheet" media="only screen and (min-width: 1000px) and (max-width: 1200px)"
                            href="../css/style_1200.css">
                            <!--Ipad L-->
                            <link rel="stylesheet" media="only screen and (min-width: 1200px) and (max-width: 1500px)" href="../css/style_1400.css">
                                
                                <script type="text/javascript" src="../js/jquery.js"></script>
                                
                                <script type="text/javascript" src="../js/jquery.mobile-1.0.js"></script>
                                
                                <script type="text/javascript" src="../js/common.js"></script>
                                <script type="text/javascript" src="../js/batch.js"></script>
                                <script>
if (navigator.userAgent.toLowerCase().match(/android/)) {
document.write('<script charset="utf-8" src="../cordova-2.0.0.js"><\/script>');
document.write('<script charset="utf-8" src="../directoryListing.js"><\/script>');
} else if (navigator.userAgent.toLowerCase().match(/iphone/) || navigator.userAgent.toLowerCase().match(/ipad/)) {
document.write('<script charset="utf-8" src="../cordova-1.5.0.js"><\/script>');
}
</script>                                
<script type="text/javascript" src="../js/jquery.json-2.3.min.js"></script>
                                
                                <script src="../LangJS/jquery-lang.js" charset="utf-8" type="text/javascript"></script>
                                <script src="../LangJS/langpack/AR.js" charset="utf-8" type="text/javascript" lang="en"></script>
                                <script type="text/javascript" src="../barcodescanner.js"></script>
    </head>
    <body>
        <div data-role="page" data-theme="d" data-title="Order Request">
            <div>
                <img title="" alt="" src="../images/bg.png" id="background">
                    </div>
            <div data-role="header" data-position="inline" id="bgclheader">
                <a href="salesgoodreturn.html" id="Back_inner" rel="external" lang="en" onclick="ClearVariables()">Back</a> <div class="wrapper"><div class="card_content"><div><img title="" alt="" data-pushbar-target="left"  src="../images/icons8-menu-50.png" id="setting"></div></div></div> 
                <h1 lang="en">Buy Back Free</h1>
                <a href="#" id="lang_inner">EN</a>
            </div>
            <div data-role="content" class="centerboxInvReq">
                <div class="boxContent Spacing">
                <table class="topbox" cellpadding="0">
                    <tr>
                        <td style="width:25%">
                            <table cellpadding="0">
                                <tr>
                                    <td style="width:10%" lang="en">No.</td>
                                    <td style="width:80%;">
                                        <input type="text" name="itemno" id="itemno" class="textWidth textFont" value=""> 
                                        
                                    </td>
                                </tr>
                            </table>                 
                        </td>
                        <td style="width:60%;padding-left:40px">
                            <label class="cus_lable heading" lang="en" id="lblDesc">
                            </label>
                        </td>
                    </tr>
                </table>
               <div class="tblBox tbltd">	       
               <table id="tblHeaderContent" cellpadding="0" cellspacing="0" width="100%" class="tblHeader">
                        <tr>
                            <th style="width: 40%;" class="leftAlign" lang="en">
                               Reason
                            </th>
                            <th style="width: 30%;" lang="en">
                                Cases
                            </th>
                            <th style="width: 30%;" lang="en" class="last">
                                Units
                            </th>
                            <th style="width: 30%;display: none;">Code</th>
                        </tr>
                    </table>
                    <div class="tblSalesHeight">
                        <table id="tblContent" cellpadding="0" cellspacing="0" border="0" width="100%">
                            <tr>
                                <td style="width: 40%;">
                                </td>
                                <td style="width: 30%;">
                                </td>                               
                                <td style="width: 30%;" class="last">                                
                                </td>
				<td style="width: 30%;display: none;">                                
                                </td>
                            </tr>
                        </table>
                    </div>
 </div>
            </div>
                <div class="leftbottomMenu">
                    <a href="../customer/item_selection.html" rel="external" id="A1" style="text-decoration: none"
                    data-role="none">
                    <div class="MenuPositionFourIcons">
                        <div class="MenuTextPos">
                            <img class="bottomicon" src="../images/search.png" alt="Add" /></div>
                        <div class="MenuTextPos MenuText" lang="en">
                            Find</div>
                    </div>
                    </a>
                    <a href="#" class="enableText" rel="external" data-role="none" id="lnkScan" 
                        onclick="clickScan()">
                        <div class="MenuPositionFourIcons">
                            <div class="MenuTextPos">
                                <img class="bottomicon" src="../images/barcode-scan.png" alt="Scan" /></div>
                            <div class="MenuTextPos MenuText" lang="en">
                                Scan</div>
                        </div>
                    </a>
                    <a href="#" rel="external" id="simplestring" style="text-decoration:none" data-role="none" rel="external" onclick="return Validateitem();">
                        <div class="MenuPositionFourIcons">
                            
                            <div class="MenuTextPos"><img class="bottomicon" src="../images/save.png" alt="Option" /></div>
                            <div class="MenuTextPos MenuText" lang="en">Save</div>
                            
                        </div>
                    </a>                     
                    <a href="salesgoodreturn.html" rel="external" id="lnkExit" onclick="ClearVariables();" style="text-decoration:none" data-role="none" rel="external">
                        <div class="MenuPositionFourIcons">
                            <div class="MenuTextPos">
                                <img class="bottomicon" src="../images/icn-exit.png" alt="Exit" /></div>
                            <div class="MenuTextPos MenuText" lang="en">
                                Cancel</div>
                        </div>
                    </a>                    
                </div>
            </div>
            <div id="f1"  data-role="footer" class="ui-bar">
                <div class="footer">
                    <div class="leftfooter">
                        09 November 2011</div>
                    <div class="rightfooter">
                        Mirnah Technology Systems</div>
                </div>
            </div>
            <div id="f2"  data-role="footer" style="bottom: 0; position: absolute;"> <aside data-pushbar-id="left" class="pushbar from_left">
		<div class="title"><span data-pushbar-close class="close push_right"></span>
			<span id="txtroute"></span>
		</div>

		<ul class="menu">
		<li style="margin-bottom: 0 !important;" > 
		<img title="" alt="" src="../images/startday-icon.png" id="day"  class="leftmenu" >
		 <a href="#"
						class="ui-btn-active" rel="external" id="day" data-icon="custom"  
						lang="en" onclick="footerredict('../startofday/startofday.html')">Start day</a></li>
					<li style="margin-bottom: 0 !important;">
					 <img title="" alt="" src="../images/Inventoryicon.png" id="inve"  class="leftmenu">
					 <a href="#" id="inve"
						rel="external" data-icon="custom" lang="en"
						onclick="footerredict('../inventory/inventory.html')">Inventory</a></li>
					<li style="margin-bottom: 0 !important;">
					 <img title="" alt="" src="../images/customer-icon.png" id="cust" class="leftmenu">
					 <a href="#"
						rel="external" id="cust" data-icon="custom" lang="en"
						onclick="footerredict('../customer/customer_operation.html')">Customer</a></li>
					<li style="margin-bottom: 0 !important;">
					<img title="" alt="" src="../images/Money-icon.png" id="sett" class="leftmenu">
					<a href="#"
						rel="external" id="sett" data-icon="custom" lang="en"
						onclick="footerredict('../settlement/managesettlement.html')">Settlement</a></li>
					<li style="margin-bottom: 0 !important;">
					<img title="" alt="" src="../images/expense-icon.png" id="expe" class="leftmenu">
					<a href="#"
						rel="external" id="expe" data-icon="custom" lang="en"
						onclick="footerredict('../settlement/expenseentry.html')">Expenses</a></li>
					<li style="margin-bottom: 0 !important;">
					<img title="" alt="" src="../images/information-icon.png" id="info" class="leftmenu" >
					<a href="#"
						rel="external" id="info" data-icon="custom" lang="en"  
						onclick="footerredict('../information/information.html')">Information</a></li>
					<li style="margin-bottom: 0 !important; ">
					 <img title="" alt="" src="../images/user-settings-icon.png" id="setup" class="leftmenu">
					 <a href="#" rel="external" id="setup" data-icon="custom" lang="en"
						onclick="footerredict('../utilities/utilities.html')">Utilities</a></li>
		</ul>

	</aside>
                <div data-role="navbar" data-iconpos="top" data-grid="f">
                <ul>
                    <li style="margin-bottom:0 !important;"><a href="#" rel="external" id="day" data-icon="custom" lang="en" onclick="footerredict('../startofday/startofday.html')">Start day</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" id="inve" rel="external" data-icon="custom" lang="en" onclick="footerredict('../inventory/inventory.html')">Inventory</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" class="ui-btn-active" rel="external" id="cust" data-icon="custom" lang="en">Customer</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" rel="external" id="sett" data-icon="custom" lang="en" onclick="footerredict('../settlement/managesettlement.html')">Settlement</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" rel="external" id="expe" data-icon="custom" lang="en" onclick="footerredict('../settlement/expenseentry.html')">Expenses</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" rel="external" id="info" data-icon="custom" lang="en" onclick="footerredict('../information/information.html')">Information</a></li>
			        <li style="margin-bottom:0 !important; width:14.0%"><a href="#" rel="external" id="setup" data-icon="custom" lang="en" onclick="footerredict('../utilities/utilities.html')">Utilities</a></li>
                </ul>
            </div>
            </div>
        </div>
        
        <script type="text/javascript">
            var data = null; 
            var ArrPrice;
            var dataInventory = null;
            var index = 0;
            var returnprice = 0;
            var stdreturnprice = 0;
            var platform=''; 
            var caseprice = 0;
            var key;
            var batchqty='buybackqty';
            var transactiontypecode=19;
            var itemno = sessionStorage.getItem("itemno");
         $('#lblDesc').text(sessionStorage.getItem('ItemDesc')); 
         $("#itemno").text(sessionStorage.getItem('ItemCode'));
            
            window.lang = new jquery_lang_js();
            $("#tblContent").click(function() { });
           resizeOrientationWindow();
	 		 $(document).ready(function() {
	 		resizeWindow();
                 if(sessionStorage.getItem('CheckCode') =='alternatecode')
            $('#itemno').clone().attr('type','text').insertAfter('#itemno').prev().remove();
            else
            $('#itemno').clone().attr('type','tel').insertAfter('#itemno').prev().remove();
            
             platform= sessionStorage.getItem("platform");  
                              $(".leftfooter").html(getCurrentDate());
                              
                              $("#itemno").keyup(function(event){
                             
                                if($("#itemno").val != "")          
                                    getFillterItemList();
                                
                    });
                              
                              document.addEventListener("deviceready", FillReasongrid, false);

                              // sujee added side bar ----------------- START ------------------------ 

                           	          	          var pushbar = new Pushbar({
                           	      		blur:true,
                           	      		overlay:true,
                           	      	});
                           	          $("#txtroute").text("ROUTE #: " + sessionStorage.getItem("RouteCode")); 
                           	          window.setInterval(function(){
                           	       		var randomColor = '#'+ ('000000' + Math.floor(Math.random()*16777215).toString(16)).slice(-6);
                           	       		$('#txtroute').css({
                           	         			'color' : randomColor,
                           	       		});
                           	     			}, 2000);
                           	          //----------------------------- END -------------------------  
                              var lan = sessionStorage.getItem("Language");
                              window.lang.run(lan);
                              
                              //Dropdown text color and disabled opacity setting
                              $('.ui-select .ui-btn-text').css({ 'text-align': 'left', 'color': '#999' });
                              
                              if (sessionStorage.getItem("Language")  != "en") {
                              
                              window.lang.change('AddGoodReturns'+lan,lan);
                              window.lang.change('Footer'+lan,lan);
                              if(lan=="AR")
                              {
                              $("#centerboxInvReq").attr("dir", "rtl");
                              ChangeTableRadius();
                              $('#Back_inner').removeClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                              $('#Back_inner').addClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                              $('#lang_inner').removeClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                              $('#lang_inner').addClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                              }
                              
                              }
                              else
                              {
                              window.lang.change('en','en');
                              $(".centerboxInvReq").attr("dir", "ltr");
                              ChangeTableRadius();
                              $('#Back_inner').removeClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                              $('#Back_inner').addClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                              $('#lang_inner').removeClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                              $('#lang_inner').addClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                              }
                              
                              function GetElements(xmlDoc) {
                              var PageName = 'orderRequest';
                              }
                              
                              function ChangeTableRadius() {
                              if (sessionStorage.getItem("Language") == "en") {
                              $("#tblContent tr:first th:first").addClass('tableBorderTopLeft');
                              $("#tblContent tr:first th:last").addClass('tableBorderTopRight');
                              $("#tblContent tr:last td:first").addClass('tableBorderBottomLeft');
                              $("#tblContent tr:last td:last").addClass('tableBorderBottomRight');
                              
                              $("#tblContent tr:first th:first").removeClass('tableBorderTopRight');
                              $("#tblContent tr:first th:last").removeClass('tableBorderTopLeft');
                              $("#tblContent tr:last td:first").removeClass('tableBorderBottomRight');
                              $("#tblContent tr:last td:last").removeClass('tableBorderBottomLeft');
                              }
                              else {
                              $("#tblContent tr:first th:first").addClass('tableBorderTopRight');
                              $("#tblContent tr:first th:last").addClass('tableBorderTopLeft');
                              $("#tblContent tr:last td:first").addClass('tableBorderBottomRight');
                              $("#tblContent tr:last td:last").addClass('tableBorderBottomLeft');
                              
                              $("#tblContent tr:first th:first").removeClass('tableBorderTopLeft');
                              $("#tblContent tr:first th:last").removeClass('tableBorderTopRight');
                              $("#tblContent tr:last td:first").removeClass('tableBorderBottomLeft');
                              $("#tblContent tr:last td:last").removeClass('tableBorderBottomRight');
                              
                              }
                              }
                              
                              });
            
            $("#txtCase").blur(function () { $(this).val(parseFloat(CheckIsNaN($(this).val()))) });
            $("#txtUnits").blur(function () { $(this).val(parseFloat(CheckIsNaN($(this).val()))) }); 
            
            //-----------------Start---------------------------
            function clickScan() {
                //alert("test");
                //result="";
                window.plugins.barcodeScanner.scan(scannerSuccess, scannerFailure);
            }
            
            function scannerSuccess(result) {
                
                
                if (result.cancelled)
                {
                    alert("the user cancelled the scan");
                }
                else
                {
                    //alert("we got a barcode: " + result.text)
                    var itemcode = result.text; 
                    // alert(itemcode);
                    itemscan(result.text);
                }
                
                
            }
            
            function itemscan(itemcode)
        	{   
	            var Qry = "SELECT actualitemcode,itemdescription FROM itemmaster   WHERE (barcode1 ='"+itemcode+"'OR barcode2 ='"+itemcode+"'OR barcode3 ='"+itemcode+"'OR barcode4 ='"+itemcode+"'OR barcode5 ='"+itemcode+"' OR barcode6 ='" + itemcode + "'OR barcode7 = '"+itemcode+"' OR barcode8 ='"+itemcode+"' OR barcode9 ='"+itemcode+"' OR barcode10 ='"+itemcode+"')";
	            console.log(Qry);  
	            if(platform == "iPad")
	            {          
	            	Cordova.exec(function(result1) 
	            	{            	
	                	if(result1!='')
	                 	{                 		
	                 		if(result1.length > 0)
	                 		{
	                 			sessionStorage.setItem("itemno","");
	                 			sessionStorage.setItem("itemno",result1[0][0]);
	                 			$('#itemno').val(result1[0][0]); 
	                 			$('#lblDesc').text(result1[0][1]);
	                 			FillReason();
	                 		}
	             		}
	                 	else
	                 	{
	                 		getLangText("Item No found");
	             		}
	             	},
	                function(error) {
	                 	navigator.notification.alert(error);
	             	},
	                "PluginClass",
	                "GetdataMethod",
	                [Qry]);
	            }
	            else if(platform == "Android")
	            {
	            	window.plugins.DataBaseHelper.select(Qry, function(result1){
	        			if(result1.array != undefined)
	        			{				                     	
	                  		sessionStorage.setItem("itemno","");
	             			sessionStorage.setItem("itemno",result1.array[0].actualitemcode);
	             			$('#itemno').val(result1.array[0].actualitemcode); 
	             			$('#lblDesc').text(result1.array[0].itemdescription);
	             			FillReason();				                     	
	        			}
	        			else
	        				getLangText("Item No found");  
	                },
	                function()
	                {
	                 	console.warn("Error calling plugin");
	                });
	            }
        	}
            
            function scannerFailure(message) {
                console.log("scannerFailure: message: " + message)
                //resultSpan.innerText = "failure: " + JSON.stringify(message)
            }
            //-----------------End-------------------------------- 
            function UpdateData(obj) {
                
		var RowIndex = $(obj).parent().parent().index();
                var ObjIndex = $(obj).parent().index();
               
                    if(ObjIndex == 1 || ObjIndex == 2)
                        $(obj).parent().text(parseInt(CheckIsNaN($(obj).val())));
                
                                   
            
                var Cases, Units, UnitsPerCase, ItemCode, RouteKey, CurrQty, Price,CasePrice;
                              
                    Cases = eval($("#tblContent tr:eq(" + RowIndex + ") td:eq(1)").text());
                    Units = eval($("#tblContent tr:eq(" + RowIndex + ") td:eq(2)").text());
                    Code = eval($("#tblContent tr:eq(" + RowIndex + ") td:eq(3)").text());
		    console.log(griddata);
		    console.log(RowIndex);
                   UnitsPerCase = griddata[RowIndex - 1][4];
		   console.log(UnitsPerCase);
		   CurrQty = (parseInt(Cases) * UnitsPerCase) + parseInt(Units);
		    CheckInvoiceRXDetailItemCount(CurrQty,Code);
		    //CheckItemPrice(CurrQty,Code);
		   //Validate(CurrQty,Code);
                
            }
            //Function for bind invoice list
            function getInvoiceList()
            {    
                if(sessionStorage.getItem("CaseEnabled") != 1)
                {
                    $("#tdCaseLabel").hide();
                    $("#txtCase").hide();
                }
                
                if(sessionStorage.getItem("CaseEnabled") == 1)
                {
                    var Qry = "SELECT distinct im.defaultreturnprice,(SELECT CASE WHEN returnfreeqty > 0 THEN (returnfreeqty / im.unitspercase) ELSE '' END from invoicedetail invd where istemp='true' and invd.itemcode = im.actualitemcode and routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + sessionStorage.getItem("VisitKey") + ") as cases,(SELECT CASE WHEN returnfreeqty > 0 THEN (returnfreeqty % im.unitspercase) ELSE '' END from invoicedetail invd where istemp='true' and invd.itemcode = im.actualitemcode and routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + sessionStorage.getItem("VisitKey") + ") as units,(select reasoncode from invoicerxddetail where itemcode = im.actualitemcode and itemtransactiontype=4 and routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + sessionStorage.getItem("VisitKey") + ") as reason,im.unitspercase,defaultgoodreturncaseprice FROM itemmaster AS im where im.itemtype = 1 and actualitemcode = " + itemno;
                }
                else
                {
                    var Qry = "SELECT distinct im.defaultreturnprice,(SELECT CASE WHEN returnfreeqty > 0 THEN (returnfreeqty % im.unitspercase) ELSE '' END from invoicedetail invd where istemp='true' and invd.itemcode = im.actualitemcode and routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + sessionStorage.getItem("VisitKey") + ") as units,(select reasoncode from invoicerxddetail where itemcode = im.actualitemcode and itemtransactiontype=4 and routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + sessionStorage.getItem("VisitKey") + ") as reason,im.unitspercase,defaultgoodreturncaseprice FROM itemmaster AS im where im.itemtype = 1 and itemcode" + itemno;
                }
                
                if(platform=='iPad')
                {
                Cordova.exec(function(result) {                             
                                if(result.length > 0)
                                {
                                    data = result;
                                    if (eval(sessionStorage.getItem("CaseEnabled")) == 1)
                                    {
                                        $("#txtCase").val(CheckIsNaN(parseInt(data[0][1])));
                                        $("#txtUnits").val(CheckIsNaN(parseInt(data[0][2])));
                                        $("#ddlReason").val(parseInt(data[0][3]));
                                        $("#ddlReason").selectmenu("refresh");
                                    }
                                    else
                                    {
                                        $("#txtUnits").val(CheckIsNaN(parseInt(data[0][1])));
                                        $("#ddlReason").val(parseInt(data[0][2]));
                                        $("#ddlReason").selectmenu("refresh");
                                    }
                                }
                                getPrices();                                                              
                              },
                              function(error) {
                              navigator.notification.alert("Error in binding Invoice Detail : " + error);
                              },
                              "PluginClass", 
                              "GetdataMethod",
                                 [Qry]);                
                }
                 else if(platform=='Android')
           		{
	           		window.plugins.DataBaseHelper.select(Qry,function(result)
					{
						if(result.array != undefined)
						{					 	
                        result = $.map(result.array, function (item, index) {
                            if(sessionStorage.getItem("CaseEnabled") == 1)
                                return [[item.defaultreturnprice, item.cases, item.units, item.reason, item.unitspercase, item.defaultgoodreturncaseprice]];
                            else
                                return [[item.defaultreturnprice, item.units, item.reason, item.unitspercase, item.defaultgoodreturncaseprice]];
                        });
		                if(result.length > 0)
                        {
                                data = result;
                                if (eval(sessionStorage.getItem("CaseEnabled")) == 1) {
                                    $("#txtCase").val(CheckIsNaN(parseInt(data[0][1])));
                                    $("#txtUnits").val(CheckIsNaN(parseInt(data[0][2])));
                                    $("#ddlReason").val(parseInt(data[0][3]));
                                    $("#ddlReason").selectmenu("refresh");
                                }
                                else {
                                    $("#txtUnits").val(CheckIsNaN(parseInt(data[0][1])));
                                    $("#ddlReason").val(parseInt(data[0][2]));
                                    $("#ddlReason").selectmenu("refresh");
                                }
                        }
                        }  
                        getPrices();
					},
					function()
					{
				   	 console.warn("Error calling plugin");
					});
           		} 
            }
            
           function FillReasongrid()
       {
        if(sessionStorage.getItem('batchsetting') ==1)
            selectbatchdata();
           if(itemno=='')
           itemno =0;
        var selectqry = "select CASE WHEN '"+ sessionStorage.getItem('Language') +"' = 'en' THEN description Else arbdescription END AS description,(CASE WHEN unitspercase=1 THEN 0 ELSE (ifnull(quantity,0)/unitspercase) END) as cases,(CASE WHEN unitspercase=1 THEN ifnull(quantity,0) ELSE (ifnull(quantity,0)%unitspercase) END) as units,code,unitspercase,ifnull(expirydate,'') as expirydate from retitmreasons left join itemmaster ON actualitemcode = " + itemno +" left join invoicerxddetail ON reasoncode = code and itemcode =" + itemno +" and routekey = "+sessionStorage.getItem('RouteKey')+" and visitkey="+sessionStorage.getItem('VisitKey')+" and itemtransactiontype=4 order by description";
	    if(platform=='iPad')
		    {
            Cordova.exec(function(result) {
                ClearTable('tblContent');
                          FillGrid(result);                        
			   getPrices();
                          
                          },
                          function(error) {
                          navigator.notification.alert("Error in binding Reason : " + error);
                          },
                          "PluginClass", 
                          "GetdataMethod", 
                          [selectqry]);         
            }
             else if(platform=='Android')
           	{
	           		window.plugins.DataBaseHelper.select(selectqry,function(result)
					{
						if(result.array != undefined)
						{
		                    result = $.map(result.array, function (item, index) {
                				return [[item.description,item.cases,item.units,item.code,item.unitspercase]];
            				});
                                    ClearTable('tblContent');
                        	FillGrid(result);
				
                          	getPrices();
                         }
					},
					function()
					{
				   	 console.warn("Error calling plugin");
					});
           	} 
       }
       function FillGrid(result)
       {
	griddata = result;
	var CellCount = $("#tblHeaderContent tr:eq(0) th").length;
	 for (i = 0; i < griddata.length; i++) {
                    var r = "<tr class='contentFont'>";
                    for (j = 0; j < CellCount; j++) {
			if (j == 1 || j == 2) {
                                temp = "class = 'editable'";                                
                                if (griddata[i][j] != '' && griddata[i][j] != undefined)
                                    griddata[i][j] = parseInt(griddata[i][j]);
                                else {
                                    griddata[i][j] = '';
                                }
                            }
                            else
                                temp = '';
			if (j == 3)
			temp += " style='display:none;text-align:right;padding:0px 10px 0px 10px;'";
			    
			temp += (j == 0) ? 'class = leftAlign' : '';
			var c = "<td " + temp + " id='c" + i + "_" +  j + "'>" + griddata[i][j] + "</td>";    
                        r += c;
		    }
		    r += "</tr>";
                    $('#tblContent tbody').append(r);
	 }
	 $('#tblContent td.editable').click(function() {
                    var index = $(this).index();
                    selColIndex = index
                    var colcaseunits,colprices;
                   if(itemno == "" || itemno == null)
			{
			  getLangText("Please Select Item.");
			 return false;
			} 
                    if(eval($(this).text()) <= 0)
                    	$(this).text("");
                    var input = $("<input type='number'/>").attr('value', $(this).text());
                    var w = $(this).innerWidth();
                    w = w - 50;
                    if(window.innerWidth>1000){
                    	input.css('width', w).css('border', '0').css('height', 60).css('font-size',35);
                    }else{
                    	input.css('width', w).css('border', '0').css('height', 30).css('font-size', 16);
                    }
                    $(this).empty();
                    $(this).append(input);  
                   
                        input.bind("keyup",function() { return SetNumberMaxLength(this,4) });
                        input.focusout(function() {
                        	var v = parseInt($(input).val(),10);
                        	$(input).val(v); 
                        	if(ValidateGridCaseUnit(this)) 
                        	{ 
                        		UpdateData(this); 
                        	} 
                        });
                    
                    
                    input.focus();
                    $(this).find('input').live("keypress", function(event) {
                        if (event.keyCode == 13) {
                            input.focusout();
                        }
                    });
                });
       }
            //Function for bind category list
            function FillReason()
            {               
                if(sessionStorage.getItem('batchsetting') ==1)
                selectbatchdata();
                if(platform=='iPad')
		    	{
                Cordova.exec(function(result) { 
                              if(result.length > 0)
                                $("<option />" ,{value:"0",text:" -- SELECT --"}).appendTo($("#ddlReason"));
                              for(i=0;i<result.length;i++){                    
                              $("<option />" ,{value:result[i][0],text:result[i][1]}).appendTo($("#ddlReason"));                                           
                              }
                              $("#ddlReason").selectmenu("refresh");
                              getInvoiceList();
                              },
                              function(error) {
                              navigator.notification.alert("Error in binding Reason : " + error);
                              },
                              "PluginClass", 
                              "GetdataMethod", 
                              ["select code,CASE WHEN '"+ sessionStorage.getItem('Language') +"' = 'en' THEN description Else arbdescription END AS description from retitmreasons order by code"]);         
                }
                else if(platform=='Android')
                {
	           		window.plugins.DataBaseHelper.select("select code,CASE WHEN '"+ sessionStorage.getItem('Language') +"' = 'en' THEN description Else arbdescription END AS description from retitmreasons order by code",function(result)
					{	
						if(result.array != undefined)
						{
		                    result = $.map(result.array, function (item, index) {
                				return [[item.code, item.description]];
            				});
		                  for(i=0;i<result.length;i++){                    
                          $("<option />" ,{value:result[i][0],text:result[i][1]}).appendTo($("#ddlReason"));                                           
                          }
                          $("#ddlReason").selectmenu("refresh");
                          getInvoiceList();
                        }
					},
					function()
					{
				   	 console.warn("Error calling plugin");
					});
                } 
            }
            
            function getPrices()
            {
                var Qry = "SELECT actualitemcode,im.defaultsalesprice AS stdsalesprice,im.caseprice AS stdsalescaseprice,im.defaultreturnprice AS stdreturnprice,im.returncaseprice AS stdreturncaseprice,im.defaultgoodreturnprice AS stdgoodreturnprice,im.defaultgoodreturncaseprice AS stdgoodreturncaseprice,CASE WHEN invoicedetail.returnprice NOT NULL AND invoicedetail.returnprice > 0 THEN invoicedetail.returnprice ELSE (CASE WHEN pd.returnprice NOT NULL AND pd.returnprice > 0  THEN pd.returnprice ELSE im.defaultreturnprice END) END AS returnprice,CASE WHEN invoicedetail.returncaseprice NOT NULL AND invoicedetail.returncaseprice > 0 THEN invoicedetail.returncaseprice ELSE (CASE WHEN pd.returncaseprice NOT NULL AND pd.returncaseprice > 0  THEN pd.returncaseprice ELSE im.returncaseprice END) END AS returncaseprice, CASE WHEN invoicedetail.salesprice NOT NULL AND invoicedetail.salesprice > 0 THEN invoicedetail.salesprice ELSE (CASE WHEN pd.salesprice NOT NULL AND pd.salesprice > 0  THEN pd.salesprice ELSE im.defaultsalesprice END) END AS salesprice, CASE WHEN invoicedetail.salescaseprice NOT NULL AND invoicedetail.salescaseprice > 0 THEN invoicedetail.salescaseprice ELSE (CASE WHEN pd.salescaseprice NOT NULL AND pd.salescaseprice > 0 THEN pd.salescaseprice ELSE im.caseprice END) END AS caseprice,im.costcaseprice,im.defaultcostprice FROM itemmaster AS im LEFT JOIN startingloaddetail sld on sld.itemcode = actualitemcode AND strftime('%Y-%m-%d',sld.ddate)=date() and sld.status = 1 and sld.routecode = " + sessionStorage.getItem("RouteCode") + " and salesmancode = " + sessionStorage.getItem("SalesmanCode") + " left join invoicedetail on invoicedetail.itemcode = im.actualitemcode and invoicedetail.routekey=" + sessionStorage.getItem("RouteKey") + " and invoicedetail.visitkey=" + sessionStorage.getItem("VisitKey") + " left join pricingdetail1 pd on pd.itemcode = actualitemcode and pd.customerpricingkey =(select ifnull(customerpricing1.customerpricingkey,0) from customerpricing1 join customermaster on customerpricing1.pricingplankey = customermaster.pricingkey and customercode = " + sessionStorage.getItem("customerid") + ") where im.itemtype=1 AND im.actualitemcode = " + sessionStorage.getItem("itemno");
                console.log(Qry);
                if (platform == "iPad") {
                    Cordova.exec(function(result) {
                        ArrPrice = result;
                    },
                    function(error) {
                        navigator.notification.alert(error);
                    },
                    "PluginClass",
                    "GetdataMethod",
                    [Qry]);
                }
                else if (platform == "Android") {
                    window.plugins.DataBaseHelper.select(Qry, function(result) {
                        var array = $.map(result.array, function(item, index) {
                            return [[item.actualitemcode,item.stdsalesprice, item.stdsalescaseprice, item.stdreturnprice, item.stdreturncaseprice, item.stdgoodreturnprice, item.stdgoodreturncaseprice, item.returnprice, item.returncaseprice, item.salesprice, item.caseprice,item.costcaseprice,item.defaultcostprice]];                        
                        });
                        ArrPrice = array;
                    },
					function() {
					    console.warn("Error calling plugin");
					});
                }
            }
            
            function Validate()
            {
                if(itemno == "" || itemno == null)
                {
                    getLangText("Please Select Item.");
                    return false;
                }
                if($("#ddlReason").get(0).selectedIndex == 0)
                {
                    getLangText("Please Select A Reason.");
                    return false;
                }
                else
                    CheckInvoiceDetailItemCount();
            }
            
            function CheckInvoiceDetailItemCount()
            {
                //CheckItemPrice();
                //getInventoryDetail();
               if(platform=='iPad')
		    {
                Cordova.exec(function(result) {          
                              
                              if(result.length > 0)
                              {
                              if(result[0][0] == 0)
                              {
                               
                                fetchqty(0);
                              }
                              else
                              {
                                
                                fetchqty(1);
                              }
                              }
                              
                              },
                              function(error) {
                              navigator.notification.alert("Error in check invoice detail item count : " + error);
                              },
                              "PluginClass", 
                              "GetdataMethod", 
                              ["Select Count(routekey) From invoicedetail where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemno +""]);    
            	}
            	else if(platform=='Android')
           	{
	           		window.plugins.DataBaseHelper.select("Select Count(routekey) as routekey From invoicedetail where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemno +"",function(result)
					{		
						if(result.array != undefined)
						{			 	
		                    result = $.map(result.array, function (item, index) {                
                				return [[item.routekey]];
            				});
		                 	if(result.length > 0)
                              {
                              if(result[0][0] == 0)
                              {
                                
                                fetchqty(0);
                              }
                              else
                              {
                               
                                fetchqty(1);
                              }
                              }
						}		                
					},
					function()
					{
				   	 console.warn("Error calling plugin");
					});
           	} 
            }
            function fetchqty(flag)
            {
            	var qry = "Select sum(ifnull(quantity,0)) as quantity  From invoicerxddetail where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemno +" and itemtransactiontype = 4";
            	if(platform=='iPad')
            	{
            		Cordova.exec(function(result) {          
                          
                          if(result.length > 0)
                          {
                            if(flag == 0)
							    InsertInvoiceDetail(result[0][0]);
							    else
							    UpdateInvoiceDetail(result[0][0]);
                          }
                          
                          },
                          function(error) {
                            navigator.notification.alert("Error in check invoice rx detail item count : " + error);
                          },
                          "PluginClass", 
                          "GetdataMethod", 
                          [qry]);    
        	}
        	else if(platform=='Android')
           	  	{
	           		window.plugins.DataBaseHelper.select(qry,function(result)
					{
					 	 
					 	 if(result.array != undefined)
					 	 {
					 	 	result = $.map(result.array, function (item, index) {                
                				return [[item.quantity]];
            				});            			
						 	if(result.length > 0)
							{
								if(flag == 0)
								InsertInvoiceDetail(result[0][0]);
								else
								UpdateInvoiceDetail(result[0][0]);
							}
                         }
					},
					function()
					{
				   	 console.warn("Error calling plugin");
					});
           	 	}
	}
            function InsertInvoiceDetail(Qty)
            {   
                var selectqty = null;
                          
                
                
               
                var ADDstdsalesprice = ArrPrice[0][1];
                var ADDstdsalescaseprice = ArrPrice[0][2];
                var ADDstdreturnprice = ArrPrice[0][3];
                var ADDstdreturncaseprice = ArrPrice[0][4];
                var ADDstdgoodreturnprice = ArrPrice[0][5];
                var ADDstdgoodreturncaseprice = ArrPrice[0][6];
                var ADDreturnprice = ArrPrice[0][7];
                var ADDreturncaseprice = ArrPrice[0][8];
                var ADDsalesprice = ArrPrice[0][9];
                var ADDsalescaseprice = ArrPrice[0][10];
               
               console.log("qty"+Qty);
                if(Qty != 0)
                {                       
                 console.log("qty"+Qty);
                 if(sessionStorage.getItem('batchsetting') ==1){
                    var selectqry = "select allowbatchentry from itemmaster where actualitemcode="+itemno;
                    if(platform=='iPad')
                    {
                        Cordova.exec(function(result) {
                                                   
                                                   if(eval(result[0][0]) == 0)
                                                   {
                                                   deletebatchexpiry(itemno,sessionStorage.getItem('RouteKey'),sessionStorage.getItem('VisitKey'), parseInt(Qty),19,'buybackqty');                                                     }
                                                   
                                                   },
                                                   function(error) {
                                                   alert(error);},
                                                   "PluginClass", 
                                                   "GetdataMethod", 
                                                   [selectqry]);
                    }
                    else if(platform=='Android')
                    {
                        window.plugins.DataBaseHelper.select(selectqry,function(result)
                                                             {
                                                             
                                                             result = $.map(result.array, function (item, index) {
                                                                            
                                                                            return [[item.allowbatchentry]];
                                                                            });
                                                             if(eval(result[0][0]) == 0)
                                                             {
                                                             deletebatchexpiry(itemno,sessionStorage.getItem('RouteKey'),sessionStorage.getItem('VisitKey'), parseInt(Qty),19,'buybackqty');
                                                             }
                                                             
                                                             
                                                             },
                                                             function()
                                                             {
                                                             console.warn("Error calling plugin");
                                                             });
                    }
                    }
                //Insert Invoice Detail      
                if(platform=='iPad')
		    	{               
                Cordova.exec(function(result) 
                              {
                                ClearVariables();  
                              //  InsertInvoiceRXDetail();
                                //navigator.notification.alert("Insert Invoice Detail Successfully"); 
                              /*var base = window.location.toString().substring(0, window.location.toString().lastIndexOf("/")) + "/";
                              window.location = base + "salesgoodreturn.html" ;*/
                              },
                              function(error) {
                              navigator.notification.alert("Error inserting record in a invoice detail");
                              },
                              "PluginClass", 
                              "InsertUpdateMethod",
                              ["Insert Into invoicedetail(routekey,transactionkey,visitkey,itemcode,returnfreeqty,goodreturnprice,mdat,istemp,issync,goodreturncaseprice,displayitem,stdsalesprice,stdsalescaseprice,stdreturnprice,stdreturncaseprice,stdgoodreturnprice,stdgoodreturncaseprice,returnprice,returncaseprice,salesprice,salescaseprice) values(" + sessionStorage.getItem('RouteKey') + ",0," + sessionStorage.getItem('VisitKey') + "," + itemno + "," + Qty + "," + ADDstdgoodreturnprice + ",datetime(),'true',0," + ADDstdgoodreturncaseprice + ",1," + ADDstdsalesprice + "," + ADDstdsalescaseprice + "," + ADDstdreturnprice + "," + ADDstdreturncaseprice + "," + ADDstdgoodreturnprice + "," + ADDstdgoodreturncaseprice + "," + ADDreturnprice + "," + ADDreturncaseprice + "," + ADDsalesprice + "," + ADDsalescaseprice + ")"
                               ]);
             	}
             	 else if(platform=='Android')
           	  	{
           	  	    window.plugins.DataBaseHelper.insert("Insert Into invoicedetail(routekey,transactionkey,visitkey,itemcode,returnfreeqty,goodreturnprice,mdat,istemp,issync,goodreturncaseprice,displayitem,stdsalesprice,stdsalescaseprice,stdreturnprice,stdreturncaseprice,stdgoodreturnprice,stdgoodreturncaseprice,returnprice,returncaseprice,salesprice,salescaseprice) values(" + sessionStorage.getItem('RouteKey') + ",0," + sessionStorage.getItem('VisitKey') + "," + itemno + "," + Qty + "," + ADDstdgoodreturnprice + ",datetime(),'true',0," + ADDstdgoodreturncaseprice + ",1," + ADDstdsalesprice + "," + ADDstdsalescaseprice + "," + ADDstdreturnprice + "," + ADDstdreturncaseprice + "," + ADDstdgoodreturnprice + "," + ADDstdgoodreturncaseprice + "," + ADDreturnprice + "," + ADDreturncaseprice + "," + ADDsalesprice + "," + ADDsalescaseprice + ")", function(result)
					{
                        ClearVariables();  
                        //InsertInvoiceRXDetail();
					 	//navigator.notification.alert("Insert Invoice Detail Successfully"); 
                              /*var base = window.location.toString().substring(0, window.location.toString().lastIndexOf("/")) + "/";
                              window.location = base + "salesgoodreturn.html" ;*/
					},
					function()
					{
				   	 console.warn("Error calling plugin");
					});
           	 	} 
                }
                else
                {
                    getLangText("Please Enter Quantity.");
                }
            }
            
            function InsertInvoiceRXDetail(CurrQty,Code)
            {   
                var selectqty = null;
                
                var Qty = CurrQty;
                
                
        
                console.log(Qty);
                console.log("Insert Into invoicerxddetail(routekey,visitkey,transactionkey, itemtransactiontype,itemcode,itemtranstypeseq,reasoncode,quantity,istemp) values("+ sessionStorage.getItem('RouteKey') +","+ sessionStorage.getItem('VisitKey') +",0,4,"+ itemno +",0,"+ Code +","+ parseInt(Qty) +",'true')");
                //Insert Invoice Detail  
                if(platform=='iPad')
                {                   
                    Cordova.exec(function(result) 
                          {
                           // ClearVariables();
                          },
                          function(error) {
                            navigator.notification.alert("Error inserting record in a invoice rx detail");
                          },
                          "PluginClass", 
                          "InsertUpdateMethod", 
                          ["Insert Into invoicerxddetail(routekey,visitkey,transactionkey, itemtransactiontype,itemcode,itemtranstypeseq,reasoncode,quantity,istemp,issync) values("+ sessionStorage.getItem('RouteKey') +","+ sessionStorage.getItem('VisitKey') +",0,4,"+ itemno +",0,"+ Code +","+ parseInt(Qty) +",'true',0)"]);
                }
                else if(platform=='Android')
           	  	{
           	  	    window.plugins.DataBaseHelper.insert("Insert Into invoicerxddetail(routekey,visitkey,transactionkey, itemtransactiontype,itemcode,itemtranstypeseq,reasoncode,quantity,istemp,issync) values(" + sessionStorage.getItem('RouteKey') + "," + sessionStorage.getItem('VisitKey') + ",0,4," + itemno + ",0," + Code + "," + parseInt(Qty) + ",'true',0)", function(result)
					{
                            //ClearVariables();
					},
					function()
					{
				   	 console.warn("Error calling plugin");
					});
           	 	}
            }
            
            function UpdateInvoiceDetail(Qty)
            {
                
                
                var ADDstdsalesprice = ArrPrice[0][1];
                var ADDstdsalescaseprice = ArrPrice[0][2];
                var ADDstdreturnprice = ArrPrice[0][3];
                var ADDstdreturncaseprice = ArrPrice[0][4];
                var ADDstdgoodreturnprice = ArrPrice[0][5];
                var ADDstdgoodreturncaseprice = ArrPrice[0][6];
                var ADDreturnprice = ArrPrice[0][7];
                var ADDreturncaseprice = ArrPrice[0][8];
                var ADDsalesprice = ArrPrice[0][9];
                var ADDsalescaseprice = ArrPrice[0][10];
                
                //if(Qty != 0)
               // {   
                    if(sessionStorage.getItem('batchsetting') ==1){
                    var selectqry = "select allowbatchentry from itemmaster where actualitemcode="+itemno;
                    if(platform=='iPad')
                    {
                        Cordova.exec(function(result) {
                                                   
                                                   if(eval(result[0][0]) == 0)
                                                   {
                                                   deletebatchexpiry(itemno,sessionStorage.getItem('RouteKey'),sessionStorage.getItem('VisitKey'), parseInt(Qty),19,'buybackqty');                                                     }
                                                   
                                                   },
                                                   function(error) {
                                                   alert(error);},
                                                   "PluginClass", 
                                                   "GetdataMethod", 
                                                   [selectqry]);
                    }
                    else if(platform=='Android')
                    {
                        window.plugins.DataBaseHelper.select(selectqry,function(result)
                                                             {
                                                             
                                                             result = $.map(result.array, function (item, index) {
                                                                            
                                                                            return [[item.allowbatchentry]];
                                                                            });
                                                             if(eval(result[0][0]) == 0)
                                                             {
                                                             deletebatchexpiry(itemno,sessionStorage.getItem('RouteKey'),sessionStorage.getItem('VisitKey'), parseInt(Qty),19,'buybackqty');
                                                             }
                                                             
                                                             
                                                             },
                                                             function()
                                                             {
                                                             console.warn("Error calling plugin");
                                                             });
                    }
                    }
                    //Update Invoice Detail
                    if(platform=='iPad')
		    		{                      
                    	Cordova.exec(function(result) 
                                  {
                                    ClearVariables();  
                                    //CheckInvoiceRXDetailItemCount();
                                  },
                                  function(error) {
                                    navigator.notification.alert("Error updating record in a invoice detail");
                                  },
                                  "PluginClass", 
                                  "InsertUpdateMethod",
                                  ["Update invoicedetail set returnfreeqty = " + Qty + ",returnprice = " + ADDstdgoodreturnprice + ",mdat = datetime(),issync=0,returncaseprice=" + ADDstdgoodreturncaseprice + ",stdsalesprice = " + ADDstdsalesprice + ",stdsalescaseprice = " + ADDstdsalescaseprice + ",stdreturnprice = " + ADDstdreturnprice + ",stdreturncaseprice=" + ADDstdreturncaseprice + ",stdgoodreturnprice=" + ADDstdgoodreturnprice + ",stdgoodreturncaseprice=" + ADDstdgoodreturncaseprice + ",returnprice=" + ADDreturnprice + ",returncaseprice=" + ADDreturncaseprice + ",salesprice=" + ADDsalesprice + ",salescaseprice=" + ADDsalescaseprice + " where routekey = " + sessionStorage.getItem('RouteKey') + " and visitkey = " + sessionStorage.getItem('VisitKey') + " and itemcode = " + itemno + ""]);                              
                	}
                	else if(platform=='Android')
           	  		{
           	  		    window.plugins.DataBaseHelper.insert("Update invoicedetail set returnfreeqty = " + Qty + ",returnprice = " + ADDstdgoodreturnprice + ",mdat = datetime(),issync=0,returncaseprice=" + ADDstdgoodreturncaseprice + ",stdsalesprice = " + ADDstdsalesprice + ",stdsalescaseprice = " + ADDstdsalescaseprice + ",stdreturnprice = " + ADDstdreturnprice + ",stdreturncaseprice=" + ADDstdreturncaseprice + ",stdgoodreturnprice=" + ADDstdgoodreturnprice + ",stdgoodreturncaseprice=" + ADDstdgoodreturncaseprice + ",returnprice=" + ADDreturnprice + ",returncaseprice=" + ADDreturncaseprice + ",salesprice=" + ADDsalesprice + ",salescaseprice=" + ADDsalescaseprice + " where routekey = " + sessionStorage.getItem('RouteKey') + " and visitkey = " + sessionStorage.getItem('VisitKey') + " and itemcode = " + itemno + "", function(result)
						{
                            ClearVariables();  
                            //CheckInvoiceRXDetailItemCount();
						},
						function()
						{
					   	 console.warn("Error calling plugin");
						});
           	 		} 
                //}
                //else
                //{
                  //  navigator.notification.alert("Please Enter Quantity.");
                //}
            }
            
            function CheckInvoiceRXDetailItemCount(CurrQty,Code)
            {
                if(platform=='iPad')
                {
                    Cordova.exec(function(result) {          
                                  
                                  if(result.length > 0)
                                  {
                                  if(result[0][0] == 0)
                                  {
                                  InsertInvoiceRXDetail(CurrQty,Code);
                                  }
                                  else
                                  {
                                  UpdateInvoiceRXDetail(CurrQty,Code);
                                  }
                                  }
                                  
                                  },
                                  function(error) {
                                  navigator.notification.alert("Error in check invoice rx detail item count : " + error);
                                  },
                                  "PluginClass", 
                                  "GetdataMethod", 
                                  ["Select Count(routekey) From invoicerxddetail where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemno +" and reasoncode ="+ Code +" and itemtransactiontype = 4"]);    
                }
                else if(platform=='Android')
           	  	{
	           		window.plugins.DataBaseHelper.select("Select Count(routekey) as cnt From invoicerxddetail where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemno +" and reasoncode ="+ Code +" and itemtransactiontype = 4",function(result)
                                                         {                                                         
                                                         if(result.array != undefined)
                                                         {
                                                         	result = $.map(result.array, function (item, index) {                                                                        
                                                                        return [[item.cnt]];
                                                         	});
                                                         
                                                         	if(result.length > 0)
                                                         	{
                                                         		if(result[0][0] == 0)
                                                         		{
                                                         			InsertInvoiceRXDetail(CurrQty,Code);
                                                         		}
                                                         		else
                                                         		{
                                                         			UpdateInvoiceRXDetail(CurrQty,Code);
                                                         		}
                                                         	}
                                                         }
                                                         },
                                                         function()
                                                         {
                                                         console.warn("Error calling plugin");
                                                         });
           	 	}
            }
            
            function UpdateInvoiceRXDetail(CurrQty,Code)
            {
                var selectqty = null;                
                var Qty = CurrQty;               
                              
                
                                         
                //Update Invoice RX Detail                     
                if(platform=='iPad')
                {
                    Cordova.exec(function(result) 
                    {
                       // ClearVariables();
                    },
                    function(error) {
                        navigator.notification.alert("Error inserting record in a invoice rx detail");
                    },
                    "PluginClass", 
                    "InsertUpdateMethod", 
                    ["Update invoicerxddetail set quantity = "+ parseInt(Qty) +",issync=0 where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemno +" and reasoncode=" + Code + " and itemtransactiontype = 4"]);            
                }
                else if(platform=='Android')
                {
                    window.plugins.DataBaseHelper.insert("Update invoicerxddetail set quantity = " + parseInt(Qty) + ",issync=0 where routekey = " + sessionStorage.getItem('RouteKey') + " and visitkey = " + sessionStorage.getItem('VisitKey') + " and reasoncode=" + Code + " and itemcode = " + itemno + " and itemtransactiontype = 4", function(result)
					{
                        //ClearVariables();
					},
					function()
					{
				   	 console.warn("Error calling plugin");
					});
                } 
            }
                 function Validateitem()
        {
            if(itemno == "" || itemno == null)
            {
                getLangText("Please Select Item.");
                return false;
            }            
            else
                CheckItem();
        }
        function CheckItem()
	{
	    if(platform=='iPad')
		    {
            Cordova.exec(function(result) {          
                          
                          if(result.length > 0)
                          {
                            if(result[0][0] == 0)
                            {
                                getLangText("Please Enter Quantity.");
                            }
                            else
                            {
                                CheckInvoiceDetailItemCount();
                            }
                          }
                          
                          },
                          function(error) {
                            navigator.notification.alert("Error in check invoice rx detail item count : " + error);
                          },
                          "PluginClass", 
                          "GetdataMethod", 
                          ["Select Count(routekey) as cnt From invoicerxddetail where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemno +" and itemtransactiontype = 4"]);    
        	}
        	else if(platform=='Android')
           	  	{
	           		window.plugins.DataBaseHelper.select("Select Count(routekey) as cnt From invoicerxddetail where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemno +" and itemtransactiontype = 4",function(result)
					{
					 	 
					 	 if(result.array != undefined)
					 	 {
					 	 	result = $.map(result.array, function (item, index) {                
                				return [[item.cnt]];
            				});            			
					 	 	if(result.length > 0)
                          	{
	                            if(result[0][0] == 0)
                            	{
	                                getLangText("Please Enter Quantity.");
                            	}
                            	else
                            	{
	                                CheckInvoiceDetailItemCount();
                            	}
                          	}
                         }
					},
					function()
					{
				   	 console.warn("Error calling plugin");
					});
           	 	}
	}
            function CheckItemPrice()
            {
                 var Qry = "Select CASE WHEN inv.goodreturnprice NOT NULL AND inv.goodreturnprice > 0 THEN inv.goodreturnprice ELSE pd.returnprice END AS returnprice,CASE WHEN inv.goodreturncaseprice NOT NULL AND inv.goodreturncaseprice > 0 THEN inv.goodreturncaseprice ELSE pd.returncaseprice END AS returncaseprice From invoicedetail inv LEFT JOIN pricingdetail1 pd ON pd.itemcode = inv.itemcode AND customerpricingkey =(select ifnull(customerpricing1.customerpricingkey,0) from customerpricing1 join customermaster on customerpricing1.pricingplankey = customermaster.pricingkey and customercode = " + sessionStorage.getItem("customerid") + ") where inv.routekey = " + sessionStorage.getItem("RouteKey") + " AND visitkey=" + sessionStorage.getItem("VisitKey") + " and inv.itemcode = " + sessionStorage.getItem('itemno');
                 
                 if(platform=='iPad')
		    	{ 
                Cordova.exec(function(result) {          
                               
                              if(result.length > 0)
                              {
                              
                                if(result[0][0] > 0)
                                {
                                    returnprice = result[0][0];                              
                                    stdreturnprice = data[0][0];    
                                }
                                else 
                                {
                                    returnprice = data[0][0];
                                    stdreturnprice = data[0][0];
                                }

                                if (sessionStorage.getItem("CaseEnabled") == 1) {
                                    if (result[0][1] > 0)
                                        caseprice = result[0][1];
                                    else
                                        caseprice = data[0][5];
                                }
                              }
                              else
                              {
                                    returnprice = data[0][0];
                                    stdreturnprice = data[0][0];

                                    if (sessionStorage.getItem("CaseEnabled") == 1)
                                        caseprice = data[0][5];
                              }
                              
                              },
                              function(error) {
                              navigator.notification.alert("Error in check item price : " + error);
                              },
                              "PluginClass", 
                              "GetdataMethod",
                              [Qry]);  
            	}
            	else if(platform=='Android')
           	  	{
           	  	    window.plugins.DataBaseHelper.select(Qry, function(result)
					{
					 	
					 	 if(result.array != undefined)
					 	 {
					 	 	result = $.map(result.array, function (item, index) {
					 	    	return [[item.returnprice, item.returncaseprice]];
            				});            			
					 	 	if(result.length > 0)
                              {                              
                                if(result[0][0] > 0)
                                {
                                    returnprice = result[0][0];                              
                                    stdreturnprice = data[0][0];    
                                }
                                else 
                                {
                                    returnprice = data[0][0];
                                    stdreturnprice = data[0][0];
                                }

                                if (sessionStorage.getItem("CaseEnabled") == 1) {
                                    if (result[0][1] > 0)
                                        caseprice = result[0][1];
                                    else
                                        caseprice = data[0][5];
                                }
                              }                              
                         }
                         else
                         {
                            returnprice = data[0][0];
                            stdreturnprice = data[0][0];

                            if (sessionStorage.getItem("CaseEnabled") == 1)
                                caseprice = data[0][5];
                         }
					},
					function()
					{
				   	 console.warn("Error calling plugin");
					});
           	 	}
            }
            
            function getInventoryDetail()
            {
               if(platform=='iPad')
		    	{
                	Cordova.exec(function(result) {                        
                              if(result.length > 0)
                              {
                              	dataInventory = result;                              
                              }
                              },
                              function(error) {
                              navigator.notification.alert("Error in binding inventory detail : " + error);
                              },
                              "PluginClass", 
                              "GetdataMethod", 
                             /* ["Select (inventorysummarydetail.loadqty / itemmaster.unitspercase) As LoadQty, (inventorysummarydetail.loadqty % itemmaster.unitspercase) As LoadUnit from inventorysummarydetail inner join itemmaster on inventorysummarydetail.itemcode = itemmaster.actualitemcode where itemmaster.actualitemcode = "+ data[index - 1][2] +" and routekey = "+ sessionStorage.getItem('RouteKey') +""]);  */                            
                            /*["Select ((inventorysummarydetail.loadqty) -  ifnull(invoicedetail.salesqty + invoicedetail.returnqty - invoicedetail.damagedqty ,0)) As LoadQty from inventorysummarydetail inner join itemmaster on inventorysummarydetail.itemcode = itemmaster.actualitemcode  and inventorysummarydetail.routekey = "+ sessionStorage.getItem('RouteKey') +" left join invoicedetail on invoicedetail.itemcode = itemmaster.actualitemcode and invoicedetail.routekey = "+ sessionStorage.getItem('RouteKey') +" and invoicedetail.visitkey = "+ sessionStorage.getItem('VisitKey') +" where itemmaster.actualitemcode = "+ data[index - 1][2] +""]);*/
                            ["Select (ifnull(loadqty,0)+ifnull(beginstockqty,0) +ifnull(loadadjustqty,0)+ ifnull(loadaddqty,0) - ifnull(loadcutqty,0) -  ifnull(saleqty,0) + ifnull(returnqty,0) - ifnull(freesampleqty,0)) As AvialableQty from inventorysummarydetail where routekey = "+ sessionStorage.getItem('RouteKey') +" and itemcode = "+ data[index - 1][2] +""]);
            	}
            	else if(platform=='Android')
           	  {
           	      window.plugins.DataBaseHelper.select("Select (ifnull(loadqty,0)+ifnull(loadadjustqty,0)+ifnull(beginstockqty,0) + ifnull(loadaddqty,0) - ifnull(loadcutqty,0) -  ifnull(saleqty,0) + ifnull(returnqty,0) - ifnull(freesampleqty,0)) As AvialableQty from inventorysummarydetail where routekey = " + sessionStorage.getItem('RouteKey') + " and itemcode = " + data[index - 1][2] + "", function(result)
					{
					 	 if(result.array!=undefined)
					 	 {
                           	result = $.map(result.array, function (item, index) {                
                				return [[item.AvialableQty]];
            				});            			
					 		if(result.length > 0)
                            {
                              dataInventory = result;                              
                            }
                         } 
					},
					function()
					{
				   	 console.warn("Error calling plugin");
					});
           	 } 
            }
            
            function ClearVariables()
            {
                $("#itemno").val("");
               
                $("#lblDesc").text("");
               
                sessionStorage.setItem("ItemCode","");
                sessionStorage.setItem("ItemDesc","");
                sessionStorage.setItem("itemno","");
                localStorage.setItem("addgood",1);
                itemno = 0;
                ClearTable('tblContent');
	    FillReasongrid();
            }   
             function getFillterItemList()
        {
            var qry = "SELECT CASE WHEN '" + sessionStorage.getItem('CheckCode') + "' = 'alternatecode' THEN itemmaster.alternatecode ELSE itemmaster.actualitemcode END AS Code,CASE WHEN '" + sessionStorage.getItem('Language') + "' = 'en' THEN itemmaster.itemdescription ELSE itemmaster.arbitemdescription END As Description,itemmaster.actualitemcode from itemmaster  where Code like '%" + $("#itemno").val() + "%' order by Code";
            if (platform == 'iPad') {
                    Cordova.exec(function(result) {
                if(result1!='')
                 	{ 
                        var code = result[0][0];
                                   var Description = result[0][1];
                                    var actualitemcode = result[0][2];
                                    sessionStorage.setItem("ItemCode",code);
				    
                                    sessionStorage.setItem("ItemDesc",Description);
                                    sessionStorage.setItem("itemno",actualitemcode);
				    $('#lblDesc').text(sessionStorage.getItem('ItemDesc'));
				    itemno = sessionStorage.getItem("itemno");
                                    FillReasongrid();
				    //getInvoiceList();
                        }
                        else
                        getLangText("Item Not Available");

                    },
                                  function(error) {
                                      alert("Error in binding fillter Item : " + error);
                                  },
                                  "PluginClass",
                                  "GetdataMethod",
                                  [qry]);
                }
                else if (platform == 'Android') {
                    window.plugins.DataBaseHelper.select(qry, function(result) {
                        if(result.array != undefined)
        			{
                                  var code = result.array[0].Code;
                                   var Description = result.array[0].Description;
                                    var actualitemcode = result.array[0].actualitemcode;
                                    sessionStorage.setItem("ItemCode",code);
				   
                                    sessionStorage.setItem("ItemDesc",Description);
                                    sessionStorage.setItem("itemno",actualitemcode);
				    $('#lblDesc').text(sessionStorage.getItem('ItemDesc'));
				     itemno = sessionStorage.getItem("itemno");
                                    FillReasongrid();
				    //getInvoiceList();
                                }
                                else
                                {
                                    getLangText("Item Not Available");
                                }
                    },
                                                         function() {
                                                             console.warn("Error calling plugin");
                                                         });
                }
        }
            function CheckIsNaN(val)
            {
            if(isNaN(val) || $.trim(val) == "")
                return 0;
            else
                return val;
            }
            
            function SetFormat(obj)
            {
                var Num = new Number($(obj).val());            
                $(obj).val(parseInt(Num));
            }
            function ClearTable(TBL) {
                $("#" + TBL + " tr:gt(0)").remove();
            }
            </script>
        
    </body>
</html>
