<!DOCTYPE html>
<html>
<head>
    <title>Order Request</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no">
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="../css/en.css" lang="en" />
    <link rel="stylesheet" href="../css/jquery.mobile-1.0.min.css" />
    <link type="text/css" href="../css/jquery.mobile.datebox.min.css" rel="stylesheet" />
    <link rel="stylesheet" media="only screen and (min-width: 600px) and (max-width: 700px)"
        href="../css/style_600.css">
    <link rel="stylesheet" media="only screen and (min-width: 701px) and (max-width: 800px)"
        href="../css/style_800.css">
    <link rel="stylesheet" media="only screen and (min-width: 1000px) and (max-width: 1200px)"
        href="../css/style_1200.css">
    <!--Ipad L-->
    <link rel="stylesheet" media="only screen and (min-width: 1200px) and (max-width: 1400px)"
        href="../css/style_1400.css">
    <link rel="stylesheet" media="only screen and (min-width: 320px) and (max-width: 599px)"
        href="../css/style_600.css" />

    <script type="text/javascript" src="../js/jquery.js"></script>

    <script type="text/javascript" src="../js/jquery.mobile-1.0.js"></script>

    <script type="text/javascript" src="../js/common.js"></script>

    <script type="text/javascript" src="../js/jquery.mobile.datebox.min.js"></script>

    <script src="../LangJS/jquery-lang.js" charset="utf-8" type="text/javascript"></script>

    <script src="../LangJS/langpack/AR.js" charset="utf-8" type="text/javascript" lang="en"></script>
    <script type="text/javascript">
        if (navigator.userAgent.toLowerCase().match(/android/)) {
            document.write('<script charset="utf-8" src="../cordova-2.0.0.js"><\/script>');
            document.write('<script charset="utf-8" src="../directoryListing.js"><\/script>');
        } else if (navigator.userAgent.toLowerCase().match(/iphone/) || navigator.userAgent.toLowerCase().match(/ipad/)) {
            document.write('<script charset="utf-8" src="../cordova-1.5.0.js"><\/script>');
        }
    </script>
</head>
<body>
    <div data-role="page" data-theme="d" data-title="Order Request">
        <div>
            <img title="" alt="" src="images/bg.png" id="background">
        </div>
        <div data-role="header" data-position="inline" id="bgclheader">
            <a href="#" onclick="PromotionCount()" id="Back_inner" rel="external" lang="en">Back</a>
            <h1 lang="en">
                Order Request</h1>
            <a href="#" id="lang_inner">EN</a>
        </div>
        <div data-role="content" class="centerboxInvReq">
            <div class="boxContent">
                <div class="textBar">
                    <table cellpadding="2" cellspacing="2" border="0" width="65%">
                        <tr>
                            <td lang="en" id="date">
                                Delivery Date
                            </td>
                            <td>
                                <input name="date" type="date" data-role="datebox" readonly="readonly" id="txtdate"
                                    value="" data-options='{"mode": "flipbox","dateFormat": "dd-MM-YYYY"}' />
                            </td>
                        </tr>                        
                    </table>
                </div>
                <div class="tblBox tbltd" id="contentWrapper">
                    <div class="tblHeader" id="tblHeaderContent">
                        <table width="100%" cellpadding="10" cellspacing="0">
                            <tr>
                                <th style="width: 30%;" class="leftAlign" lang="en">
                                    Item Description
                                </th>
                                <th style="width: 10%;" lang="en">
                                    Cases
                                </th>
                                <th style="width: 10%;" lang="en">
                                    Units
                                </th>
                                <th style="width: 15%;" lang="en">
                                    Case Price
                                </th>
                                <th style="width: 14%;" lang="en">
                                    Unit Price
                                </th>
                                <th style="width: 12%;display:none" lang="en" class="last">
                                    Total
                                </th>
                            </tr>
                        </table>
                    </div>
                    <div class="route_table_height orderrequest" id="contentWrapper">
                        <table id="tblContent" border="0" width="100%" cellpadding="0" cellspacing="0" data-role="none">
                            <tr>
                                <td style="width: 30%;">                                
                                </td>
                                <td style="width: 10%;">
                                </td>
                                <td style="width: 10%;">                                
                                </td>
                                <td style="width: 15%;">
                                </td>
                                <td style="width: 14%;">                               
                                </td>
                                <td style="width: 12%;display:none" class="last">                                
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="tabedBar">
                    <div class="paging" id="paging" style="display:none">
                        <img id="imgPrev" src="../images/right.png" />
                        <img id="imgNext" src="../images/left.png" />                        
                    </div>
                    <div id="TabPanel" class="TabPanelEN">
                        <div id="Tab0" class="Tab TabFirst TabActive" style="display: block" db="O" act="1" lang="en">
                            Orders</div>                     
                       
                        <!--<div id="Tab1" class="Tab ordertab Tabmiddle" db="GR" lang="en" act="1" style="display: block;">
                            Good Return</div>
                        <div id="Tab2" class="Tab TabLast" db="BR" lang="en" act="1" style="display: block">
                            Bad Return</div>
                         <div id="Tab3" class="Tab TabFirst TabLast" db="F" lang="en" act="1" style="display: block">
                            Free</div>-->
                    </div>
                </div>
                <div class="textBar">
                    <table cellpadding="2" cellspacing="2" border="0" width="100%">
                        <tr>
                            <td width="25%" class="captionLabel" lang="en">
                                Item No.
                            </td>
                            <td class="captionLabel" lang="en">
                                Warehouse Stock
                            </td>
                            <td class="captionLabel" lang="en">
                                Total Qty
                            </td>
                            <td class="captionLabel" lang="en">
                                Total Amount
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <input id="txtItemNo" type="text" size="20" class="textWidth textFont" readonly="readonly" />
                            </td>
                            <td>
                                <input id="txtWareHouseStock" type="text" size="11" class="textWidth textFont" readonly="readonly" />
                            </td>
                            <td>
                                <input id="txtTotal1" type="text" size="11" class="textWidth textFont" readonly="readonly"/>
                            </td>
                            <td>
                                <input id="txtTotal2" type="text" size="11" class="textWidth textFont" style="text-align:right"  readonly="readonly"/>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            <div class="leftbottomMenu">
                <a href="#" class="enableText" rel="external" data-role="none" onclick="SetPage();">
                    <div class="MenuPosition">
                        <div class="MenuTextPos">
                            <img src="../images/icn-add.png" alt="Add" /></div>
                        <div class="MenuTextPos MenuText" lang="en">
                            Add</div>
                    </div>
                </a>
                <a href="#" class="enableText" rel="external" onclick="localStorage.signature ='orderrequest';GetOrderInvoiceNumber();">
                    <div class="MenuPosition">
                        <div class="MenuTextPos">
                            <img src="../images/icn-select.png" alt="Exit" /></div>
                        <div class="MenuTextPos MenuText" lang="en">
                            Finalize</div>
                    </div>
                </a>
                <a href="#" onclick="PromotionCount()" class="enableText" rel="external">
                    <div class="MenuPosition">
                        <div class="MenuTextPos">
                            <img src="../images/icn-exit.png" alt="Exit" /></div>
                        <div class="MenuTextPos MenuText" lang="en">
                            Cancel</div>
                    </div>
                </a>
            </div>
        </div>
        <div data-role="footer" class="ui-bar">
            <div class="footer">
                <div class="leftfooter">
                    09 November 2011</div>
                <div class="rightfooter">
                    Mirnah Technology Systems</div>
            </div>
        </div>
        <div data-role="footer" style="bottom: 0; position: absolute;">
             <div data-role="navbar" data-iconpos="top" data-grid="f">
                <ul>
                    <li style="margin-bottom:0 !important;"><a href="#" rel="external" id="day" data-icon="custom" lang="en" onclick="footerredict('../startofday/startofday.html')">Start of day</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" id="inve" rel="external" data-icon="custom" lang="en" onclick="footerredict('../inventory/inventory.html')">Inventory</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" class="ui-btn-active" rel="external" id="cust" data-icon="custom" lang="en">Customer opt</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" rel="external" id="sett" data-icon="custom" lang="en" onclick="footerredict('../settlement/managesettlement.html')">Settlement</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" rel="external" id="expe" data-icon="custom" lang="en" onclick="footerredict('../settlement/expenseentry.html')">Expense Entry</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" rel="external" id="info" data-icon="custom" lang="en" onclick="footerredict('../information/information.html')">Information</a></li>
			        <li style="margin-bottom:0 !important; width:14.0%"><a href="#" rel="external" id="setup" data-icon="custom" lang="en" onclick="footerredict('../utilities/utilities.html')">Utilities</a></li>
                </ul>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        window.lang = new jquery_lang_js();       
        $("#tblContent").click(function() { });
        var Qty,data,IsTabActive;
        var platform = '';
        var AndroidPlatform = "Android";
        var iPadPlatform = "iPad";
        var decimalplace = sessionStorage.getItem("decimalplace"); 
        var InvoiceNumber,DocumentNumber;
        var IsFinalize;
        var FinalizeSales,FinalizeReturn,FinalizeDamage,FinalizeFree;
        var anytimetabclick = true;
        $(document).ready(function() {            
            $(".leftfooter").html(getCurrentDate());
            var ActiveIndex = 0;
            var CaseEnabled,AvailQty;
            var AvailQty;            
                          var itemno = sessionStorage.getItem("ItemCode");
                          if (itemno == null)
                          sessionStorage.setItem("ItemCode", 0);
            console.log(decimalplace);
            //SetTabs();
            /*if(window.location.toString().indexOf("salesqty") > 0)                
                    ActiveIndex = 0;
                else if(window.location.toString().indexOf("returnqty") > 0)                
                    ActiveIndex = 1;
                else if(window.location.toString().indexOf("damagedqty") > 0)                
                    ActiveIndex = 2;
                else if(window.location.toString().indexOf("manualfreeqty") > 0)                
                    ActiveIndex = 3;*/
            if(sessionStorage.addorderqty == "salesqty")
                ActiveIndex = 0;
            else if(sessionStorage.addorderqty == "returnqty")
                ActiveIndex = 1;
            else if(sessionStorage.addorderqty == "damagedqty")
                ActiveIndex = 2;
            else if(sessionStorage.addorderqty == "manualfreeqty")
                ActiveIndex = 3;
                
            function SetTabs() {               
            
                $("#TabPanel div").removeClass("TabActive");
                $("#Tab" + ActiveIndex).addClass("TabActive");

                Qty = $("#TabPanel div:eq(" + ActiveIndex + ")").attr("db");
                switch (Qty) {
                    case 'O':
                        Qty = 'salesqty'; break;
                    case 'GR':
                        Qty = 'returnqty'; break;
                    case 'BR':
                        Qty = 'damagedqty'; break;
                    case 'F':
                        Qty = 'manualfreeqty'; break; 
                    default:
                        Qty = 'salesqty';
                }
                IsTabActive = $("#TabPanel div:eq(" + ActiveIndex + ")").attr("act");                
                if (ActiveIndex > 2) {
                    $("#TabPanel div").slice(0, 3).css("display", "none");
                    $("#TabPanel div").slice(3, $("#TabPanel div").length).css("display", "block");
                    
                    if(IsTabActive == 1)
                    {
                        $("#TabPanel div:eq(" + ActiveIndex + ")").css("display","block");
                        ////getRecord();
                    }
                    else if(IsTabActive == 0)
                    {
                        $("#TabPanel div:eq(" + ActiveIndex + ")").css("display","none");
                    }
                }
                else 
                {
                    $("#TabPanel div").slice(0, 3).css("display", "block");
                    $("#TabPanel div").slice(3, $("#TabPanel div").length).css("display", "none");
                    if(IsTabActive == 1)
                    {
                        $("#TabPanel div:eq(" + ActiveIndex + ")").css("display","block");
                        ////getRecord();
                    }
                    else if(IsTabActive == 0)
                    {
                        $("#TabPanel div:eq(" + ActiveIndex + ")").css("display","none");
                    }
                }
                
                /*$("#TabPanel div").each(function(index){
                    if($(this).attr("act") == "0")
                        $(this).css("display","none");
                    else
                        $(this).css("display","block");
                });*/
                
                $('#tblContent').css("display", "table");
		    getRecord();	
            }

            var NoNext, NoPrev;
            $("#imgNext").click(function() {
                if (!NoNext) {
                    ActiveIndex += 1;
                    SetTabs();
                    getRecord();
                }
                if (ActiveIndex >= ($("#TabPanel div").length - 1)) {
                    $(this).attr("src", "../images/left-gray.png");
                    NoNext = true;
                }
                else {
                    NoNext = false;
                    NoPrev = false;
                    $("#imgPrev").attr("src", "../images/right.png");
                }
            });

            $("#imgPrev").click(function() {
                if (!NoPrev) {
                    ActiveIndex -= 1;
                    SetTabs();
                    getRecord();
                }
                if (ActiveIndex <= 0) {
                    $(this).attr("src", "../images/right-gray.png");
                    NoPrev = true;
                }
                else {
                    NoPrev = false;
                    NoNext = false;
                    $("#imgNext").attr("src", "../images/left.png");
                }
            });


           
            
            //DB Integration Start                          
            //On Device Ready Event
            document.addEventListener("deviceready", onDR, false);
            function onDR() {
                platform = sessionStorage.getItem("platform");
                getSettings();
                //getRecord();
            }
            
            // Case and Edit setting initialization
            function getSettings() {
                //Setting for Case Field Enabled
                if (sessionStorage.getItem("CaseEnabled") == "0" || sessionStorage.getItem("CaseEnabled") == null)
                    CaseEnabled = false;
                else if (sessionStorage.getItem("CaseEnabled") == "1")
                    CaseEnabled = true;
                
                // Removing Case and Caseprice column if case is not enabled.
                if (!CaseEnabled) {
                    $("#tblHeaderContent tr th:eq(1)").remove();
                    $("#tblHeaderContent tr th:eq(2)").remove();
                    $("#tblContent tr td:eq(1)").remove();
                    $("#tblContent tr td:eq(2)").remove();
                }
                
                var Qry = "SELECT totalsalesamount,totalreturnamount,totaldamagedamount,totalbuybackfreeamount as cnt FROM salesorderheader WHERE istemp='true' AND routekey=" + sessionStorage.getItem("RouteKey") + " AND visitkey=" + sessionStorage.getItem("VisitKey") + " AND customercode = " + sessionStorage.getItem("customerid");
                console.log(Qry);
                if (platform == iPadPlatform) {
                    Cordova.exec(function(result) {
                        if(result.length > 0)
                        {
                            FinalizeSales = result[0][0];
                            FinalizeReturn = result[0][1];
                            FinalizeDamage = result[0][2];
                            FinalizeFree = result[0][3];                            
                        }
                        else
                        {
                            FinalizeSales = 0;
                            FinalizeReturn = 0;
                            FinalizeDamage = 0;
                            FinalizeFree = 0;
                        }
                        TabSettings();
                    },
                    function(error) {
                        navigator.notification.alert(error);
                    },
                    "PluginClass",
                    "GetdataMethod",
                    [Qry]);
                }
                else if (platform == AndroidPlatform) {
                    window.plugins.DataBaseHelper.select(Qry, function(result) {                    	
                        if(result.array != undefined)
                        {
                        	if(result.array.length > 0)
                        	{                            
                            FinalizeSales = result.array[0].totalsalesamount;
                            FinalizeReturn = result.array[0].totalreturnamount;
                            FinalizeDamage = result.array[0].totaldamagedamount;
                            FinalizeFree = result.array[0].cnt;
                            }                                                                                 
                        }
                        else
                        {
                            FinalizeSales = 0;
                            FinalizeReturn = 0;
                            FinalizeDamage = 0;
                            FinalizeFree = 0;
                        }
                        TabSettings();
                    },
					function() {
					    console.warn("Error calling plugin");
					});
                } 
            }
                          
            function TabSettings()
            {
                var Qry = "SELECT ifnull(enablereturnstrxn,0) enablereturnstrxn,ifnull(enabledamagedreturns,0) enabledamagedreturns, ifnull(enablepromotrxn,0) enablepromotrxn FROM customermaster WHERE customercode=" + sessionStorage.getItem("customerid") + " AND routecode=" + sessionStorage.getItem("RouteCode");
                console.log(Qry);
                if (platform == iPadPlatform) {
                    Cordova.exec(function(result) {
                        if(result.length > 0)
                        {                            
                            getAvailableTabs(result);
                        }
                    },
                    function(error) {
                        navigator.notification.alert(error);
                    },
                    "PluginClass",
                    "GetdataMethod",
                    [Qry]);
                }
                else if (platform == AndroidPlatform) {
                    window.plugins.DataBaseHelper.select(Qry, function(result) {
                    	if(result.array != undefined)
                    	{
                        	var array = $.map(result.array, function(item, index) {                        
                            	return [[item.enablereturnstrxn, item.enabledamagedreturns, item.enablepromotrxn]];
                        	});
                        	result = array;
                        	getAvailableTabs(result);
                        }
                    },
					function() {
					    console.warn("Error calling plugin");
					});
                }
            }
            
            function getAvailableTabs(result)
            {
                var strGoodReturn = "<div id='Tab1' class='Tab ordertab' db='GR' lang='en' style='display: block;'>G.Return</div>";
                var strBadReturn = "<div id='Tab2' class='Tab' db='BR' lang='en' style='display: block'>B.Return</div>";
                var strFree = "<div id='Tab3' class='Tab' db='F' lang='en' act='1' style='display: block'>Free</div>";
                if(result[0][0] == 2 || result[0][0] == 4)
                {
                    $("#TabPanel").append(strGoodReturn);
                }
                if(result[0][1] == 2 || result[0][1] == 4)
                {
                    $("#TabPanel").append(strBadReturn);
                }
                if(result[0][2] == 2 || result[0][2] == 4)
                {
                    $("#TabPanel").append(strFree);
                }
                
                
                var TabCount = $("#TabPanel div").length;
                if(TabCount < 4)
                {
                    $("#paging").hide()
                    /*$("#imgNext").hide();
                    $("#imgPrev").hide();*/
                }
                else
                    $("#paging").show();
                
                $("#TabPanel div:eq(" + (eval(TabCount) - 1) + ")").addClass("TabLast"); //Class for last Tab
                if(TabCount > 2)
                {                 
                    $("#TabPanel div:eq(1)").addClass("Tabmiddle");
                }
                if(TabCount > 3)
                {
                    $("#TabPanel div:eq(2)").addClass("TabLast");
                    $("#TabPanel div:eq(3)").addClass("TabFirst");
                }
                
                 //Setting Tab Styles
                $("#TabPanel div").click(function() {
                if(anytimetabclick)
                {
                ActiveIndex = $("#TabPanel div").index(this);
                Qty = $(this).attr("db");
                switch (Qty) {
                    case 'O':
                        Qty = 'salesqty'; break;
                    case 'GR':
                        Qty = 'returnqty'; break;
                    case 'BR':
                        Qty = 'damagedqty'; break;
                    case 'F':
                        Qty = 'manualfreeqty'; break; 
                    default:
                        Qty = 'salesqty';
                }
                $("#TabPanel div").removeClass("TabActive");
                $(this).removeClass("TabInactive").addClass("TabActive");

                $("#lblQty").css("display", "block");
                $("#txtQty").css("display", "block");
                $("#txtItemNo").addClass("textWidth");
                getRecord();
                $('#tblContent').css("display", "table");
                }
                });
                
                SetTabs();
            }
            
            function getRecord()
            {
                var PriceFields; 
                switch (Qty) {
                    case 'salesqty':
                        Qty = 'salesqty'; break;
                    case 'returnqty':
                        Qty = 'returnqty'; break;
                    case 'damagedqty':
                        Qty = 'damagedqty'; break;
                    case 'manualfreeqty':
                        Qty = 'manualfreeqty'; break; 
                    default:
                        Qty = 'salesqty';
                }
                
                localStorage.setItem("AddQty",Qty);
                /*if(Qty == 'salesqty')
                {
                    if(eval(FinalizeSales) > 0)
                        IsFinalize = true;
                    else
                        IsFinalize = false;
                }
                else if(Qty == 'returnqty')
                {
                    if(eval(FinalizeReturn) > 0)
                        IsFinalize = true;
                    else
                        IsFinalize = false;
                }
                else if(Qty == 'damagedqty')
                {
                    if(eval(FinalizeDamage) > 0)
                        IsFinalize = true;
                    else
                        IsFinalize = false;
                }
                else if(Qty == 'manualfreeqty')
                {
                    if(eval(FinalizeFree) > 0)
                        IsFinalize = true;
                    else
                        IsFinalize = false;
                }*/
                
                if(eval(FinalizeSales) > 0 || eval(FinalizeReturn) > 0 || eval(FinalizeDamage) > 0 || eval(FinalizeFree) > 0)
                {
                          IsFinalize = true;
                }
                if (CaseEnabled) {
                          if(Qty == "returnqty" || Qty == "damagedqty")                          
                                PriceFields = "(CASE  WHEN pd.returncaseprice NOT NULL THEN pd.returncaseprice ELSE im.returncaseprice END) caseprice,(CASE  WHEN pd.returnprice NOT NULL THEN pd.returnprice ELSE im.defaultreturnprice END) price";
                           else
                                PriceFields = "(case when pd.salescaseprice NOT NULL THEN pd.salescaseprice else im.caseprice end) as caseprice,(case when pd.salesprice is not null then pd.salesprice else defaultsalesprice end) as price";
                          
                          if(IsFinalize)
                          var Qry = "Select * from (SELECT CASE WHEN '" + sessionStorage.getItem("Language") + "' = 'en' THEN itemdescription ELSE arbitemdescription END as Desc,(SELECT case when " + Qty + "=0 THEN '' ELSE (" + Qty + "/im.unitspercase) END from salesorderdetail invd where istemp='true' and invd.itemcode = im.actualitemcode and routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + sessionStorage.getItem("VisitKey") + ") as cases,(SELECT case when " + Qty + "=0 THEN '' ELSE  (" + Qty + " % im.unitspercase) END from salesorderdetail invd where istemp='true' and invd.itemcode = im.actualitemcode and routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + sessionStorage.getItem("VisitKey") + ") as units," + PriceFields + ",NULL as total,CASE WHEN '" + sessionStorage.getItem("CheckCode") + "' = 'alternatecode' THEN im.alternatecode ELSE im.actualitemcode END as Code,im.actualitemcode,im.unitspercase,im.caseprice,im.warehousestock,CASE  WHEN pd.salescaseprice NOT NULL THEN pd.salescaseprice ELSE im.caseprice END caseprice,CASE  WHEN pd.returncaseprice NOT NULL THEN pd.returncaseprice ELSE im.returncaseprice END returncaseprice,CASE  WHEN pd.returnprice NOT NULL THEN pd.returnprice ELSE im.defaultreturnprice END returnsalesprice,1 as sortf ,printsequencecust FROM itemmaster AS im join itemmustdetail imd on imd.itemcode = im.actualitemcode and imd.itemmustcode =(select itemmustcode from itemmustheader imh join customermaster cm on cm.itemmustkey =imh.itemmustcode and customercode = " + sessionStorage.getItem("customerid") + ") JOIN salesorderdetail sod on sod.itemcode = im.actualitemcode AND sod.routekey = " + sessionStorage.getItem("RouteKey") + " AND sod.visitkey=" + sessionStorage.getItem("VisitKey") + " AND " + Qty + " > 0  left join pricingdetail1 pd on pd.itemcode = actualitemcode and customerpricingkey = (select ifnull(customerpricing1.customerpricingkey,0) from customerpricing1 join customermaster on customerpricing1.pricingplankey = customermaster.pricingkey and customercode = " + sessionStorage.getItem("customerid") + ") where im.itemtype = 1 and printsequencecust > 0 or displayitem=1 AND im.actualitemcode IN(SELECT CASE authorizeditemgrpkey WHEN 0 THEN im.actualitemcode ELSE pg.itemcode END FROM customermaster cm LEFT JOIN productgroupdetail pg ON pg.groupnumber = cm.authorizeditemgrpkey WHERE customercode = " + sessionStorage.getItem("customerid") + ") group by actualitemcode UNION SELECT CASE WHEN '" + sessionStorage.getItem("Language") + "' = 'en' THEN itemdescription ELSE arbitemdescription END as Desc,(SELECT case when " + Qty + "=0 THEN '' ELSE (" + Qty + "/im.unitspercase) END from salesorderdetail invd where istemp='true' and invd.itemcode = im.actualitemcode and routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + sessionStorage.getItem("VisitKey") + ") as cases,(SELECT case when " + Qty + "=0 THEN '' ELSE  (" + Qty + " % im.unitspercase) END from salesorderdetail invd where istemp='true' and invd.itemcode = im.actualitemcode and routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + sessionStorage.getItem("VisitKey") + ") as units," + PriceFields + ",NULL as total,CASE WHEN '" + sessionStorage.getItem("CheckCode") + "' = 'alternatecode' THEN im.alternatecode ELSE im.actualitemcode END as Code,im.actualitemcode,im.unitspercase,im.caseprice,im.warehousestock,CASE  WHEN pd.salescaseprice NOT NULL THEN pd.salescaseprice ELSE im.caseprice END caseprice,CASE  WHEN pd.returncaseprice NOT NULL THEN pd.returncaseprice ELSE im.returncaseprice END returncaseprice,CASE  WHEN pd.returnprice NOT NULL THEN pd.returnprice ELSE im.defaultreturnprice END returnsalesprice,2 as sortf ,printsequencecust FROM itemmaster AS im JOIN salesorderdetail sod on sod.itemcode = im.actualitemcode AND sod.routekey = " + sessionStorage.getItem("RouteKey") + " AND sod.visitkey=" + sessionStorage.getItem("VisitKey") + " AND " + Qty + " > 0  left join pricingdetail1 pd on pd.itemcode = actualitemcode and customerpricingkey = (select ifnull(customerpricing1.customerpricingkey,0) from customerpricing1 join customermaster on customerpricing1.pricingplankey = customermaster.pricingkey and customercode = " + sessionStorage.getItem("customerid") + ") where im.itemtype = 1 and printsequencecust > 0 or displayitem=1 AND im.actualitemcode IN(SELECT CASE authorizeditemgrpkey WHEN 0 THEN im.actualitemcode ELSE pg.itemcode END FROM customermaster cm LEFT JOIN productgroupdetail pg ON pg.groupnumber = cm.authorizeditemgrpkey WHERE customercode = " + sessionStorage.getItem("customerid") + ") group by actualitemcode) tb1 group by tb1.actualitemcode order by min(tb1.sortf),CASE printsequencecust WHEN 0 THEN 100000 ELSE printsequencecust END";
                          else{
                            
                        //  var Qry = "select * from (SELECT CASE WHEN '" + sessionStorage.getItem("Language") + "' = 'en' THEN itemdescription ELSE arbitemdescription END as Desc,(SELECT case when " + Qty + "=0 THEN '' ELSE (" + Qty + "/im.unitspercase) END from salesorderdetail invd where istemp='true' and invd.itemcode = im.actualitemcode and routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + sessionStorage.getItem("VisitKey") + ") as cases,(SELECT case when " + Qty + "=0 THEN '' ELSE  (" + Qty + " % im.unitspercase) END from salesorderdetail invd where istemp='true' and invd.itemcode = im.actualitemcode and routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + sessionStorage.getItem("VisitKey") + ") as units," + PriceFields + ",NULL as total,CASE WHEN '" + sessionStorage.getItem("CheckCode") + "' = 'alternatecode' THEN im.alternatecode ELSE im.actualitemcode END as Code,im.actualitemcode,im.unitspercase,im.caseprice,im.warehousestock,CASE  WHEN pd.salescaseprice NOT NULL THEN pd.salescaseprice ELSE im.caseprice END caseprice,CASE  WHEN pd.returncaseprice NOT NULL THEN pd.returncaseprice ELSE im.returncaseprice END returncaseprice,CASE  WHEN pd.returnprice NOT NULL THEN pd.returnprice ELSE im.defaultreturnprice END returnsalesprice,1 as sortf ,printsequencecust FROM itemmaster AS im join itemmustdetail imd on imd.itemcode = im.actualitemcode and imd.itemmustcode =(select itemmustcode from itemmustheader imh join customermaster cm on cm.itemmustkey =imh.itemmustcode and customercode = " + sessionStorage.getItem("customerid") + ") left JOIN salesorderdetail sod on sod.itemcode = im.actualitemcode AND sod.routekey=" + sessionStorage.getItem("RouteKey") + " AND sod.visitkey=" + sessionStorage.getItem("VisitKey") + " left join pricingdetail1 pd on pd.itemcode = actualitemcode and customerpricingkey = (select ifnull(customerpricing1.customerpricingkey,0) from customerpricing1 join customermaster on customerpricing1.pricingplankey = customermaster.pricingkey and customercode = " + sessionStorage.getItem("customerid") + ") where im.itemtype = 1 and printsequencecust > 0 or displayitem=1 AND im.actualitemcode IN(SELECT CASE authorizeditemgrpkey WHEN 0 THEN im.actualitemcode ELSE pg.itemcode END FROM customermaster cm LEFT JOIN productgroupdetail pg ON pg.groupnumber = cm.authorizeditemgrpkey WHERE customercode = " + sessionStorage.getItem("customerid") + ") group by actualitemcode UNION SELECT CASE WHEN '" + sessionStorage.getItem("Language") + "' = 'en' THEN itemdescription ELSE arbitemdescription END as Desc,(SELECT case when " + Qty + "=0 THEN '' ELSE (" + Qty + "/im.unitspercase) END from salesorderdetail invd where istemp='true' and invd.itemcode = im.actualitemcode and routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + sessionStorage.getItem("VisitKey") + ") as cases,(SELECT case when " + Qty + "=0 THEN '' ELSE  (" + Qty + " % im.unitspercase) END from salesorderdetail invd where istemp='true' and invd.itemcode = im.actualitemcode and routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + sessionStorage.getItem("VisitKey") + ") as units," + PriceFields + ",NULL as total,CASE WHEN '" + sessionStorage.getItem("CheckCode") + "' = 'alternatecode' THEN im.alternatecode ELSE im.actualitemcode END as Code,im.actualitemcode,im.unitspercase,im.caseprice,im.warehousestock,CASE  WHEN pd.salescaseprice NOT NULL THEN pd.salescaseprice ELSE im.caseprice END caseprice,CASE  WHEN pd.returncaseprice NOT NULL THEN pd.returncaseprice ELSE im.returncaseprice END returncaseprice,CASE  WHEN pd.returnprice NOT NULL THEN pd.returnprice ELSE im.defaultreturnprice END returnsalesprice,2 as sortf ,printsequencecust FROM itemmaster AS im left JOIN salesorderdetail sod on sod.itemcode = im.actualitemcode AND sod.routekey=" + sessionStorage.getItem("RouteKey") + " AND sod.visitkey=" + sessionStorage.getItem("VisitKey") + " left join pricingdetail1 pd on pd.itemcode = actualitemcode and customerpricingkey = (select ifnull(customerpricing1.customerpricingkey,0) from customerpricing1 join customermaster on customerpricing1.pricingplankey = customermaster.pricingkey and customercode = " + sessionStorage.getItem("customerid") + ") where im.itemtype = 1 and printsequencecust > 0 or displayitem=1 AND im.actualitemcode IN(SELECT CASE authorizeditemgrpkey WHEN 0 THEN im.actualitemcode ELSE pg.itemcode END FROM customermaster cm LEFT JOIN productgroupdetail pg ON pg.groupnumber = cm.authorizeditemgrpkey WHERE customercode = " + sessionStorage.getItem("customerid") + ") group by actualitemcode) tb1 group by tb1.actualitemcode order by min(tb1.sortf),CASE printsequencecust WHEN 0 THEN 100000 ELSE printsequencecust END";
                          //remove left join for prefill grid
                          var Qry = "select * from (SELECT CASE WHEN '" + sessionStorage.getItem("Language") + "' = 'en' THEN itemdescription ELSE arbitemdescription END as Desc,(SELECT case when " + Qty + "=0 THEN '' ELSE (" + Qty + "/im.unitspercase) END from salesorderdetail invd where istemp='true' and invd.itemcode = im.actualitemcode and routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + sessionStorage.getItem("VisitKey") + ") as cases,(SELECT case when " + Qty + "=0 THEN '' ELSE  (" + Qty + " % im.unitspercase) END from salesorderdetail invd where istemp='true' and invd.itemcode = im.actualitemcode and routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + sessionStorage.getItem("VisitKey") + ") as units," + PriceFields + ",NULL as total,CASE WHEN '" + sessionStorage.getItem("CheckCode") + "' = 'alternatecode' THEN im.alternatecode ELSE im.actualitemcode END as Code,im.actualitemcode,im.unitspercase,im.caseprice,im.warehousestock,CASE  WHEN pd.salescaseprice NOT NULL THEN pd.salescaseprice ELSE im.caseprice END caseprice,CASE  WHEN pd.returncaseprice NOT NULL THEN pd.returncaseprice ELSE im.returncaseprice END returncaseprice,CASE  WHEN pd.returnprice NOT NULL THEN pd.returnprice ELSE im.defaultreturnprice END returnsalesprice,1 as sortf ,printsequencecust FROM itemmaster AS im join itemmustdetail imd on imd.itemcode = im.actualitemcode and imd.itemmustcode =(select itemmustcode from itemmustheader imh join customermaster cm on cm.itemmustkey =imh.itemmustcode and customercode = " + sessionStorage.getItem("customerid") + ") JOIN salesorderdetail sod on sod.itemcode = im.actualitemcode AND sod.routekey=" + sessionStorage.getItem("RouteKey") + " AND sod.visitkey=" + sessionStorage.getItem("VisitKey") + " left join pricingdetail1 pd on pd.itemcode = actualitemcode and customerpricingkey = (select ifnull(customerpricing1.customerpricingkey,0) from customerpricing1 join customermaster on customerpricing1.pricingplankey = customermaster.pricingkey and customercode = " + sessionStorage.getItem("customerid") + ") where im.itemtype = 1 and printsequencecust > 0 or displayitem=1 AND im.actualitemcode IN(SELECT CASE authorizeditemgrpkey WHEN 0 THEN im.actualitemcode ELSE pg.itemcode END FROM customermaster cm LEFT JOIN productgroupdetail pg ON pg.groupnumber = cm.authorizeditemgrpkey WHERE customercode = " + sessionStorage.getItem("customerid") + ") group by actualitemcode UNION SELECT CASE WHEN '" + sessionStorage.getItem("Language") + "' = 'en' THEN itemdescription ELSE arbitemdescription END as Desc,(SELECT case when " + Qty + "=0 THEN '' ELSE (" + Qty + "/im.unitspercase) END from salesorderdetail invd where istemp='true' and invd.itemcode = im.actualitemcode and routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + sessionStorage.getItem("VisitKey") + ") as cases,(SELECT case when " + Qty + "=0 THEN '' ELSE  (" + Qty + " % im.unitspercase) END from salesorderdetail invd where istemp='true' and invd.itemcode = im.actualitemcode and routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + sessionStorage.getItem("VisitKey") + ") as units," + PriceFields + ",NULL as total,CASE WHEN '" + sessionStorage.getItem("CheckCode") + "' = 'alternatecode' THEN im.alternatecode ELSE im.actualitemcode END as Code,im.actualitemcode,im.unitspercase,im.caseprice,im.warehousestock,CASE  WHEN pd.salescaseprice NOT NULL THEN pd.salescaseprice ELSE im.caseprice END caseprice,CASE  WHEN pd.returncaseprice NOT NULL THEN pd.returncaseprice ELSE im.returncaseprice END returncaseprice,CASE  WHEN pd.returnprice NOT NULL THEN pd.returnprice ELSE im.defaultreturnprice END returnsalesprice,2 as sortf ,printsequencecust FROM itemmaster AS im JOIN salesorderdetail sod on sod.itemcode = im.actualitemcode AND sod.routekey=" + sessionStorage.getItem("RouteKey") + " AND sod.visitkey=" + sessionStorage.getItem("VisitKey") + " left join pricingdetail1 pd on pd.itemcode = actualitemcode and customerpricingkey = (select ifnull(customerpricing1.customerpricingkey,0) from customerpricing1 join customermaster on customerpricing1.pricingplankey = customermaster.pricingkey and customercode = " + sessionStorage.getItem("customerid") + ") where im.itemtype = 1 and printsequencecust > 0 or displayitem=1 AND im.actualitemcode IN(SELECT CASE authorizeditemgrpkey WHEN 0 THEN im.actualitemcode ELSE pg.itemcode END FROM customermaster cm LEFT JOIN productgroupdetail pg ON pg.groupnumber = cm.authorizeditemgrpkey WHERE customercode = " + sessionStorage.getItem("customerid") + ") group by actualitemcode) tb1 group by tb1.actualitemcode order by min(tb1.sortf),CASE printsequencecust WHEN 0 THEN 100000 ELSE printsequencecust END";
                          }
                          }
                else 
                {
                          if(Qty == "returnqty" || Qty == "damagedqty")                          
                                PriceFields = "(CASE  WHEN pd.returnprice NOT NULL THEN pd.returnprice ELSE im.defaultreturnprice END) price";
                           else
                                PriceFields = "(case when pd.salesprice is not null then pd.salesprice else defaultsalesprice end) price";
                          if(IsFinalize)
                          var Qry = "Select * from (SELECT CASE WHEN '" + sessionStorage.getItem("Language") + "' = 'en' THEN itemdescription ELSE arbitemdescription END as Desc,(SELECT CASE WHEN " + Qty + "=0 THEN 'NULL' ELSE " + Qty + " END  from salesorderdetail invd where istemp='true' and invd.itemcode = im.actualitemcode and routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + sessionStorage.getItem("VisitKey") + ") as units," + PriceFields + ",NULL as total,CASE WHEN '" + sessionStorage.getItem("CheckCode") + "' = 'alternatecode' THEN im.alternatecode ELSE im.actualitemcode END as Code,im.actualitemcode,im.unitspercase,im.caseprice,im.warehousestock,CASE  WHEN pd.salescaseprice NOT NULL THEN pd.salescaseprice ELSE im.caseprice END caseprice,CASE  WHEN pd.returncaseprice NOT NULL THEN pd.returncaseprice ELSE im.returncaseprice END returncaseprice,CASE  WHEN pd.returnprice NOT NULL THEN pd.returnprice ELSE im.defaultreturnprice END returnsalesprice,1 as sortf ,printsequencecust FROM itemmaster AS im join itemmustdetail imd on imd.itemcode = im.actualitemcode and imd.itemmustcode =(select itemmustcode from itemmustheader imh join customermaster cm on cm.itemmustkey =imh.itemmustcode and customercode = " + sessionStorage.getItem("customerid") + ") JOIN salesorderdetail sod on sod.itemcode = im.actualitemcode AND sod.routekey=" + sessionStorage.getItem("RouteKey") + " AND sod.visitkey=" + sessionStorage.getItem("VisitKey") + " AND " + Qty + " > 0 left join pricingdetail1 pd on pd.itemcode = actualitemcode and customerpricingkey = (select ifnull(customerpricing1.customerpricingkey,0) from customerpricing1 join customermaster on customerpricing1.pricingplankey = customermaster.pricingkey and customercode = " + sessionStorage.getItem("customerid") + ") where im.itemtype = 1 and printsequencecust > 0 or displayitem=1 AND im.actualitemcode IN(SELECT CASE authorizeditemgrpkey WHEN 0 THEN im.actualitemcode ELSE pg.itemcode END FROM customermaster cm LEFT JOIN productgroupdetail pg ON pg.groupnumber = cm.authorizeditemgrpkey WHERE customercode = " + sessionStorage.getItem("customerid") + ") group by actualitemcode UNION SELECT CASE WHEN '" + sessionStorage.getItem("Language") + "' = 'en' THEN itemdescription ELSE arbitemdescription END as Desc,(SELECT CASE WHEN " + Qty + "=0 THEN 'NULL' ELSE " + Qty + " END  from salesorderdetail invd where istemp='true' and invd.itemcode = im.actualitemcode and routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + sessionStorage.getItem("VisitKey") + ") as units," + PriceFields + ",NULL as total,CASE WHEN '" + sessionStorage.getItem("CheckCode") + "' = 'alternatecode' THEN im.alternatecode ELSE im.actualitemcode END as Code,im.actualitemcode,im.unitspercase,im.caseprice,im.warehousestock,CASE  WHEN pd.salescaseprice NOT NULL THEN pd.salescaseprice ELSE im.caseprice END caseprice,CASE  WHEN pd.returncaseprice NOT NULL THEN pd.returncaseprice ELSE im.returncaseprice END returncaseprice,CASE  WHEN pd.returnprice NOT NULL THEN pd.returnprice ELSE im.defaultreturnprice END returnsalesprice,2 as sortf ,printsequencecust FROM itemmaster AS im JOIN salesorderdetail sod on sod.itemcode = im.actualitemcode AND sod.routekey=" + sessionStorage.getItem("RouteKey") + " AND sod.visitkey=" + sessionStorage.getItem("VisitKey") + " AND " + Qty + " > 0 left join pricingdetail1 pd on pd.itemcode = actualitemcode and customerpricingkey = (select ifnull(customerpricing1.customerpricingkey,0) from customerpricing1 join customermaster on customerpricing1.pricingplankey = customermaster.pricingkey and customercode = " + sessionStorage.getItem("customerid") + ") where im.itemtype = 1 and printsequencecust > 0 or displayitem=1 AND im.actualitemcode IN(SELECT CASE authorizeditemgrpkey WHEN 0 THEN im.actualitemcode ELSE pg.itemcode END FROM customermaster cm LEFT JOIN productgroupdetail pg ON pg.groupnumber = cm.authorizeditemgrpkey WHERE customercode = " + sessionStorage.getItem("customerid") + ") group by actualitemcode) tb1 group by tb1.actualitemcode order by min(tb1.sortf),CASE printsequencecust WHEN 0 THEN 100000 ELSE printsequencecust END";
                          else{
                          //var Qry = "Select * from (SELECT CASE WHEN '" + sessionStorage.getItem("Language") + "' = 'en' THEN itemdescription ELSE arbitemdescription END as Desc,(SELECT CASE WHEN " + Qty + "=0 THEN 'NULL' ELSE " + Qty + " END  from salesorderdetail invd where istemp='true' and invd.itemcode = im.actualitemcode and routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + sessionStorage.getItem("VisitKey") + ") as units," + PriceFields + ",NULL as total,CASE WHEN '" + sessionStorage.getItem("CheckCode") + "' = 'alternatecode' THEN im.alternatecode ELSE im.actualitemcode END as Code,im.actualitemcode,im.unitspercase,im.caseprice,im.warehousestock,CASE  WHEN pd.salescaseprice NOT NULL THEN pd.salescaseprice ELSE im.caseprice END caseprice,CASE  WHEN pd.returncaseprice NOT NULL THEN pd.returncaseprice ELSE im.returncaseprice END returncaseprice,CASE  WHEN pd.returnprice NOT NULL THEN pd.returnprice ELSE im.defaultreturnprice END returnsalesprice,1 as sortf ,printsequencecust FROM itemmaster AS im join itemmustdetail imd on imd.itemcode = im.actualitemcode and imd.itemmustcode =(select itemmustcode from itemmustheader imh join customermaster cm on cm.itemmustkey =imh.itemmustcode and customercode = " + sessionStorage.getItem("customerid") + ") left JOIN salesorderdetail sod on sod.itemcode = im.actualitemcode AND sod.routekey=" + sessionStorage.getItem("RouteKey") + " AND sod.visitkey=" + sessionStorage.getItem("VisitKey") + " left join pricingdetail1 pd on pd.itemcode = actualitemcode and customerpricingkey = (select ifnull(customerpricing1.customerpricingkey,0) from customerpricing1 join customermaster on customerpricing1.pricingplankey = customermaster.pricingkey and customercode = " + sessionStorage.getItem("customerid") + ") where im.itemtype = 1 and printsequencecust > 0 or displayitem=1 AND im.actualitemcode IN(SELECT CASE authorizeditemgrpkey WHEN 0 THEN im.actualitemcode ELSE pg.itemcode END FROM customermaster cm LEFT JOIN productgroupdetail pg ON pg.groupnumber = cm.authorizeditemgrpkey WHERE customercode = " + sessionStorage.getItem("customerid") + ") group by actualitemcode UNION SELECT CASE WHEN '" + sessionStorage.getItem("Language") + "' = 'en' THEN itemdescription ELSE arbitemdescription END as Desc,(SELECT CASE WHEN " + Qty + "=0 THEN 'NULL' ELSE " + Qty + " END  from salesorderdetail invd where istemp='true' and invd.itemcode = im.actualitemcode and routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + sessionStorage.getItem("VisitKey") + ") as units," + PriceFields + ",NULL as total,CASE WHEN '" + sessionStorage.getItem("CheckCode") + "' = 'alternatecode' THEN im.alternatecode ELSE im.actualitemcode END as Code,im.actualitemcode,im.unitspercase,im.caseprice,im.warehousestock,CASE  WHEN pd.salescaseprice NOT NULL THEN pd.salescaseprice ELSE im.caseprice END caseprice,CASE  WHEN pd.returncaseprice NOT NULL THEN pd.returncaseprice ELSE im.returncaseprice END returncaseprice,CASE  WHEN pd.returnprice NOT NULL THEN pd.returnprice ELSE im.defaultreturnprice END returnsalesprice,2 as sortf ,printsequencecust FROM itemmaster AS im left JOIN salesorderdetail sod on sod.itemcode = im.actualitemcode AND sod.routekey=" + sessionStorage.getItem("RouteKey") + " AND sod.visitkey=" + sessionStorage.getItem("VisitKey") + " left join pricingdetail1 pd on pd.itemcode = actualitemcode and customerpricingkey = (select ifnull(customerpricing1.customerpricingkey,0) from customerpricing1 join customermaster on customerpricing1.pricingplankey = customermaster.pricingkey and customercode = " + sessionStorage.getItem("customerid") + ") where im.itemtype = 1 and printsequencecust > 0 or displayitem=1 AND im.actualitemcode IN(SELECT CASE authorizeditemgrpkey WHEN 0 THEN im.actualitemcode ELSE pg.itemcode END FROM customermaster cm LEFT JOIN productgroupdetail pg ON pg.groupnumber = cm.authorizeditemgrpkey WHERE customercode = " + sessionStorage.getItem("customerid") + ") group by actualitemcode) tb1 group by tb1.actualitemcode order by min(tb1.sortf),CASE printsequencecust WHEN 0 THEN 100000 ELSE printsequencecust END";
                          //remove left join for prefill grid
                           var Qry = "Select * from (SELECT CASE WHEN '" + sessionStorage.getItem("Language") + "' = 'en' THEN itemdescription ELSE arbitemdescription END as Desc,(SELECT CASE WHEN " + Qty + "=0 THEN 'NULL' ELSE " + Qty + " END  from salesorderdetail invd where istemp='true' and invd.itemcode = im.actualitemcode and routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + sessionStorage.getItem("VisitKey") + ") as units," + PriceFields + ",NULL as total,CASE WHEN '" + sessionStorage.getItem("CheckCode") + "' = 'alternatecode' THEN im.alternatecode ELSE im.actualitemcode END as Code,im.actualitemcode,im.unitspercase,im.caseprice,im.warehousestock,CASE  WHEN pd.salescaseprice NOT NULL THEN pd.salescaseprice ELSE im.caseprice END caseprice,CASE  WHEN pd.returncaseprice NOT NULL THEN pd.returncaseprice ELSE im.returncaseprice END returncaseprice,CASE  WHEN pd.returnprice NOT NULL THEN pd.returnprice ELSE im.defaultreturnprice END returnsalesprice,1 as sortf ,printsequencecust FROM itemmaster AS im join itemmustdetail imd on imd.itemcode = im.actualitemcode and imd.itemmustcode =(select itemmustcode from itemmustheader imh join customermaster cm on cm.itemmustkey =imh.itemmustcode and customercode = " + sessionStorage.getItem("customerid") + ") JOIN salesorderdetail sod on sod.itemcode = im.actualitemcode AND sod.routekey=" + sessionStorage.getItem("RouteKey") + " AND sod.visitkey=" + sessionStorage.getItem("VisitKey") + " left join pricingdetail1 pd on pd.itemcode = actualitemcode and customerpricingkey = (select ifnull(customerpricing1.customerpricingkey,0) from customerpricing1 join customermaster on customerpricing1.pricingplankey = customermaster.pricingkey and customercode = " + sessionStorage.getItem("customerid") + ") where im.itemtype = 1 and printsequencecust > 0 or displayitem=1 AND im.actualitemcode IN(SELECT CASE authorizeditemgrpkey WHEN 0 THEN im.actualitemcode ELSE pg.itemcode END FROM customermaster cm LEFT JOIN productgroupdetail pg ON pg.groupnumber = cm.authorizeditemgrpkey WHERE customercode = " + sessionStorage.getItem("customerid") + ") group by actualitemcode UNION SELECT CASE WHEN '" + sessionStorage.getItem("Language") + "' = 'en' THEN itemdescription ELSE arbitemdescription END as Desc,(SELECT CASE WHEN " + Qty + "=0 THEN 'NULL' ELSE " + Qty + " END  from salesorderdetail invd where istemp='true' and invd.itemcode = im.actualitemcode and routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + sessionStorage.getItem("VisitKey") + ") as units," + PriceFields + ",NULL as total,CASE WHEN '" + sessionStorage.getItem("CheckCode") + "' = 'alternatecode' THEN im.alternatecode ELSE im.actualitemcode END as Code,im.actualitemcode,im.unitspercase,im.caseprice,im.warehousestock,CASE  WHEN pd.salescaseprice NOT NULL THEN pd.salescaseprice ELSE im.caseprice END caseprice,CASE  WHEN pd.returncaseprice NOT NULL THEN pd.returncaseprice ELSE im.returncaseprice END returncaseprice,CASE  WHEN pd.returnprice NOT NULL THEN pd.returnprice ELSE im.defaultreturnprice END returnsalesprice,2 as sortf ,printsequencecust FROM itemmaster AS im JOIN salesorderdetail sod on sod.itemcode = im.actualitemcode AND sod.routekey=" + sessionStorage.getItem("RouteKey") + " AND sod.visitkey=" + sessionStorage.getItem("VisitKey") + " left join pricingdetail1 pd on pd.itemcode = actualitemcode and customerpricingkey = (select ifnull(customerpricing1.customerpricingkey,0) from customerpricing1 join customermaster on customerpricing1.pricingplankey = customermaster.pricingkey and customercode = " + sessionStorage.getItem("customerid") + ") where im.itemtype = 1 and printsequencecust > 0 or displayitem=1 AND im.actualitemcode IN(SELECT CASE authorizeditemgrpkey WHEN 0 THEN im.actualitemcode ELSE pg.itemcode END FROM customermaster cm LEFT JOIN productgroupdetail pg ON pg.groupnumber = cm.authorizeditemgrpkey WHERE customercode = " + sessionStorage.getItem("customerid") + ") group by actualitemcode) tb1 group by tb1.actualitemcode order by min(tb1.sortf),CASE printsequencecust WHEN 0 THEN 100000 ELSE printsequencecust END";
                          }
                          }

                console.log(Qry);
                if (platform == iPadPlatform) {
                    Cordova.exec(function(result) {
                        TableDataOffLine(result)
                    },
                    function(error) {
                        navigator.notification.alert(error);
                    },
                    "PluginClass",
                    "GetdataMethod",
                    [Qry]);
                }
                else if (platform == AndroidPlatform) {
                    window.plugins.DataBaseHelper.select(Qry, function(result) {
                    	if(result.array != undefined)
                        	TableDataOffLine(result);
                    },
					function() {
					    console.warn("Error calling plugin");
					});
                }
            } 
           
                
            // Salesinvoice grid data bind.
            function TableDataOffLine(RecSet) {
                ClearTable('tblContent');
                var CellCount = $("#tblHeaderContent tr:eq(0) th").length;
                var temp;
                data = RecSet;
                if (platform == AndroidPlatform) {
                    var array = $.map(data.array, function(item, index) {
                        if (CaseEnabled)
                            return [[item.Desc, item.cases, item.units, item.caseprice, item.price, item.total, item.Code, item.actualitemcode, item.unitspercase, item.caseprice,item.warehousestock,item.caseprice,item.returncaseprice,item.returnsalesprice]];
                        else
                            return [[item.Desc, item.units, item.price, item.total, item.Code, item.actualitemcode, item.unitspercase, item.caseprice, item.warehousestock,item.caseprice,item.returncaseprice,item.returnsalesprice]];
                    });
                    data = array;
                    RecSet = array;
                }
                for (i = 0; i < data.length; i++) {
                    var r = "<tr class='contentFont'>";
                    for (j = 0; j < CellCount; j++) {
                        if (CaseEnabled) {
                            if (j == 1 || j == 2) {
                                temp = "class = 'editable'";                                
                                if (data[i][j] != '' && data[i][j] != undefined)
                                    data[i][j] = parseInt(data[i][j]);
                                else 
                                {
                                    data[i][j] = '';
                                }
                            }
                            else
                                temp = '';
                        }
                        else {
                            if (j == 1) 
                            {
                                temp = "class = 'editable'";
                                if (data[i][j] != '' && data[i][j] != undefined)
                                    data[i][j] = parseInt(data[i][j]);
                                else
                                    data[i][j] = '';
                            }
                            else
                                temp = '';
                        }
                        temp += (j == 0) ? 'class = leftAlign' : '';
                        if (j == CellCount - 1) {
                            temp += " class = 'last' style='display:none;text-align:right;padding:0px 10px 0px 10px;'";
                            if (data[i][1] == '')
                            { 
                                data[i][j] = ''; //Overriding total column to set blank;
                            }
                            else
                                data[i][j] = data[i][1];
                            
                            if (CaseEnabled) {
                                if(Qty == "returnqty" || Qty == "damagedqty")
                                {
                                    // Total = (case * returncaseprice) + (Units * returnsalesprice)
                                    data[i][j] = eval(data[i][1] * data[i][12]) + eval(data[i][2] * data[i][13]);
                                }
                                else
                                {                                
                                    // Total = (case * caseprice) + (Units * salesprice)
                                    data[i][j] = eval(data[i][1] * data[i][3]) + eval(data[i][2] * data[i][4]);
                                }
                            }
                            else {
                                if(Qty == "returnqty" || Qty == "damagedqty")
                                {
                                    // Total = (Units * returnsalesprice)                  
                                    data[i][j] = eval(data[i][1] * data[i][11])
                                }
                                else
                                {
                                    // Total = (Units * salesprice)       
                                    data[i][j] = eval(data[i][1] * data[i][2])
                                }
                            }
                            if (isNaN(data[i][j]))
                                data[i][j] = 0;
                                
                            
                        }
                        if (CaseEnabled) {
                            if (j >= 3 && j <= 5) {
                                if (data[i][j] != '' && data[i][j] != undefined)
                                    data[i][j] = eval(data[i][j]).toFixed(decimalplace);
                            }
                        }
                        else {
                            if (j >= 2 && j <= 3)
                                if (data[i][j] != '' && data[i][j] != undefined)
                                data[i][j] = eval(data[i][j]).toFixed(decimalplace);
                        }
                        var c = "<td " + temp + ">" + data[i][j] + "</td>";
                        r += c;                        
                    }
                    r += "</tr>";
                    $('#tblContent tbody').append(r);
                }
                
                if(platform == "iPad")
                {
                	$("#tblHeaderContent th.last").show()
                	$("#tblContent td.last").show()
                }
                
                //Click event for each row in table to process row data.
                $("#tblContent tr").live('click', function() {
                    $(this).addClass('clicked');
                    $(this).siblings().removeClass('clicked');
                    var idx = $(this).index();
                    if (CaseEnabled) {
                        $('#txtItemNo').val(RecSet[idx - 1][6]);

                        var cases = $(this).children().eq(1).text();
                        var units = $(this).children().eq(2).text();
                        var total = $(this).children().eq(5).text();
                        var SalesPrice = RecSet[idx - 1][4];
                        var CasePrice = RecSet[idx - 1][3];
                        if (SalesPrice == '')
                            SalesPrice = 0;
                        if (CasePrice == '')
                            CasePrice = 0;                       
                        
                        $('#txtTotal1').val(GetCaseUnitTotal());
                        $('#txtTotal2').val(GetTotalAmount());
                        //$('#txtWareHouseStock').val(RecSet[idx - 1][10]);
                        if(RecSet[idx - 1][10] != '' && RecSet[idx - 1][10] != undefined)
                            $('#txtWareHouseStock').val((parseInt(RecSet[idx - 1][10]/RecSet[idx - 1][8])) + "/" + (parseInt(RecSet[idx - 1][10]%RecSet[idx - 1][8])));

                        /*AvailQty = null;
                        getAvailQty(RecSet[idx - 1][7]);*/

                    }
                    else {
                        $('#txtItemNo').val(RecSet[idx - 1][4]);
                        //$('#txtUPC').val(RecSet[idx - 1][6]);
                        $('#txtTotal1').val(GetCaseUnitTotal());
                        $('#txtTotal2').val(GetTotalAmount());
                        //$('#txtWareHouseStock').val(RecSet[idx - 1][9]);
                        if(RecSet[idx - 1][8] != '' && RecSet[idx - 1][8] != undefined)
                            $('#txtWareHouseStock').val((parseInt(RecSet[idx - 1][8]/RecSet[idx - 1][6])) + "/" + (parseInt(RecSet[idx - 1][8]%RecSet[idx - 1][6])));

                        /*AvailQty = null;
                        getAvailQty(RecSet[idx - 1][5]);*/
                    }
                });
                
                $("#tblContent tr:eq(1)").trigger('click');
                $("#tblContent tr:odd").addClass('oddRow');
                $("#tblContent tr:even").addClass('evenRow');

                // If Edit is enabled allow editing in grid
                $('#tblContent td.editable').click(function(e) {
                    anytimetabclick = false;
                                                   e.preventDefault(); 
                                                   e.stopPropagation();
					if(eval($(this).text()) <= 0)
                    	$(this).text("");                                                   
                    var input = $("<input type='number'/>").attr('value', $(this).text());
                    var w = $(this).innerWidth();
                    w = w - 50 + "px";
                    input.css('width', w).css('border', '0').css('height', 30).css('font-size', 16);
                    $(this).empty();
                    $(this).append(input);
                                                  
                                                   
                    input.bind("keyup",function() { return SetNumberMaxLength(this,4) });
                    input.focusout(function() { 
                                   var v = parseInt($(input).val(),10);
                        			$(input).val(v);
                                   if(ValidateGridCaseUnit(this)) {
                                   UpdateData(this) 
                                   } 
                                   });
                    $(this).find('input').live("keypress", function(event) {
                        if (event.keyCode == 13) {
                            input.focusout();
                        }
                    });
                         input.focus();                          
                        
                });                                
                HasDeliveryDate();
            } 
            
            function HasDeliveryDate()
            {
            	var Qry = "SELECT strftime('%d-%m-%Y',orderdeliverydate) orderdeliverydate FROM salesorderheader WHERE routekey = " + sessionStorage.getItem("RouteKey") + " AND visitkey = " + sessionStorage.getItem("VisitKey") + " AND customercode=" + sessionStorage.getItem("customerid");
            	console.log(Qry);
            	if(platform == iPadPlatform)
            	{
            		Cordova.exec(function(result) {
                        if(result.length > 0)
                        {
                            $("#txtdate").val(result[0][0]);                                                                       
                            $("#txtdate").datebox('refresh');
                        }
                        else
                        	getDefaultDeliveryDate();
                    },
                    function(error) {
                        navigator.notification.alert(error);
                    },
                    "PluginClass",
                    "GetdataMethod",
                    [Qry]);
            	}
            	else if(platform == AndroidPlatform)
            	{
            		window.plugins.DataBaseHelper.select(Qry, function(result) {
                        if(result.array != undefined)
                        {
                            $("#txtdate").val(result.array[0].orderdeliverydate);                                                                       
                            $("#txtdate").datebox('refresh');
                        }
                        else
                        	getDefaultDeliveryDate();
                    },
					function() {
					    console.warn("Error calling plugin");
					});
            	}
            }
            
            function getDefaultDeliveryDate()
            {  
                var Qry = "SELECT (CASE WHEN defaultdeliverydays is null THEN 0 ELSE defaultdeliverydays end) Days from Routemaster where salesmancode = " + sessionStorage.getItem("SalesmanCode") + " and routecode=" + sessionStorage.getItem("RouteCode");
                console.log(Qry);
                if(platform == iPadPlatform)
                {
                    Cordova.exec(function(result) {
                        if(result.length > 0)
                        {
                            var dt = result[0][0];
                            var QryDate = "SELECT strftime('%d-%m-%Y',date('now'," + "'" + dt + " days'))";
                            console.log(QryDate);
                            Cordova.exec(function(result1) {
                                if(result1.length > 0)
                                {                                    
                                    $("#txtdate").val(result1[0][0]);                                                                       
                                    $("#txtdate").datebox('refresh');
                                }
                            },
                            function(error) {
                                navigator.notification.alert(error);
                            },
                            "PluginClass",
                            "GetdataMethod",
                            [QryDate]);
                        }
                    },
                    function(error) {
                        navigator.notification.alert(error);
                    },
                    "PluginClass",
                    "GetdataMethod",
                    [Qry]);
                }
                else if(platform == AndroidPlatform)
                {
                    window.plugins.DataBaseHelper.select(Qry, function(result) {
                        if(result.array != undefined)
                        {
                            var dt = result.array[0].Days;
                            var QryDate = "SELECT strftime('%d-%m-%Y',date('now'," + "'" + dt + " days')) as deliverydate";
                            window.plugins.DataBaseHelper.select(QryDate, function(result1)
                            {
                                if(result1.array != undefined)
                                {
                                    $("#txtdate").val(result1.array[0].deliverydate);                                                                       
                                    $("#txtdate").datebox('refresh');
                                }
                            },
                            function() {
                                console.warn("Error calling plugin");
                            });
                        }
                    },
					function() {
					    console.warn("Error calling plugin");
					});
                }
            }
            
            // Update Quantity according to changes in grid.
            function UpdateData(obj) {
                var RowIndex = $(obj).parent().parent().index();
                var ObjIndex = $(obj).parent().index();
                $(obj).parent().text(parseInt(CheckIsNaN($(obj).val())));
                var Cases, Units, UnitsPerCase, ItemCode, RouteCode, CurrQty, Price;
                if (CaseEnabled) {
                    Cases = eval($("#tblContent tr:eq(" + RowIndex + ") td:eq(1)").text());
                    Units = eval($("#tblContent tr:eq(" + RowIndex + ") td:eq(2)").text());
                                        
                    ItemCode = data[RowIndex - 1][7];
                    UnitsPerCase = data[RowIndex - 1][8];
                    RouteKey = sessionStorage.getItem("RouteKey");
                    Cases = (Cases == undefined || Cases == '') ? 0 : parseInt(CheckIsNaN(Cases));
                    Units = (Units == undefined || Units == '') ? 0 : parseInt(CheckIsNaN(Units));
                    CurrQty = (parseInt(Cases) * UnitsPerCase) + parseInt(Units);
                    //navigator.notification.alert(CurrQty + " : " + AvailQty + " : " + UnitsPerCase);
                    
                    Price = eval(data[RowIndex - 1][4]).toFixed(decimalplace);
                           salescaseprice1 = eval(data[RowIndex - 1][11]).toFixed(decimalplace);
                           returncaseprice1 = eval(data[RowIndex - 1][12]).toFixed(decimalplace);
                           returnprice1 = eval(data[RowIndex - 1][13]).toFixed(decimalplace);
                    
                    $("#tblContent tr:eq(" + RowIndex + ") td:eq(1)").text(parseInt(CurrQty / UnitsPerCase));
                    $("#tblContent tr:eq(" + RowIndex + ") td:eq(2)").text(parseInt(CurrQty % UnitsPerCase));
                    var Total;        
                    if(Qty == "returnqty" || Qty == "damagedqty")
                    {
                        //Calculating Total value ([case * returncaseprice] + [units * returnsalesprice])
                        Total = eval(Cases * data[RowIndex - 1][12]) + eval(Units * data[RowIndex - 1][13]);
                    }
                    else
                    {
                        //Calculating Total value ([case * caseprice] + [units * salesprice])
                        Total = eval(Cases * data[RowIndex - 1][3]) + eval(Units * data[RowIndex - 1][4]);
                    }
                    $("#tblContent tr:eq(" + RowIndex + ") td:eq(5)").text(CheckIsNaN(Total.toFixed(decimalplace)));
                    $("#txtTotal1").val(GetCaseUnitTotal());
                    $("#txtTotal2").val(GetTotalAmount());
                    //Over
                          
                    HasEntry(ItemCode, RouteKey, sessionStorage.getItem("VisitKey"), CurrQty, Price,salescaseprice1,returncaseprice1,returnprice1);                
                }
                else {
                    Units = eval($("#tblContent tr:eq(" + RowIndex + ") td:eq(1)").text());
                                        
                    ItemCode = data[RowIndex - 1][5];
                    UnitsPerCase = data[RowIndex - 1][6];
                    RouteKey = sessionStorage.getItem("RouteKey");
                    Units = (Units == undefined || Units == '') ? 0 : parseInt(Units);
                    CurrQty = parseInt(Units);
                    
                    Price = data[RowIndex - 1][2];
                          salescaseprice1 = data[RowIndex - 1][9];
                          returncaseprice1 = data[RowIndex - 1][10];
                          returnprice1 = data[RowIndex - 1][11];
                    var Total;
                    if(Qty == "returnqty" || Qty == "damagedqty")
                    {
                        //Calculating Total value (Units * returnsalesprice)
                        Total = eval(Units * data[RowIndex - 1][11]);
                    }
                    else
                    {
                        //Calculating Total value (Units * Salesprice)
                        Total = eval(Units * data[RowIndex - 1][2]);
                    }
                    $("#tblContent tr:eq(" + RowIndex + ") td:eq(3)").text(CheckIsNaN(Total.toFixed(decimalplace)));
                    $("#txtTotal1").val(GetCaseUnitTotal());
                    $("#txtTotal2").val(GetTotalAmount());
                    //Over
                    HasEntry(ItemCode, RouteKey, sessionStorage.getItem("VisitKey"), CurrQty, Price,salescaseprice1,returncaseprice1,returnprice1);        
                }
            }
            
            // Check For Entry of quantity in database
            function HasEntry(ItemCode, RouteKey, VisitKey, CurrQty, Price,salescaseprice1,returncaseprice1,returnprice1) {
                var res = true;
                var Qry = "SELECT COUNT(*) as totalcount FROM salesorderdetail where itemcode=" + ItemCode + " and visitkey=" + VisitKey
                if (platform == iPadPlatform) {
                    Cordova.exec(function(result) {
                        CheckInsert(ItemCode, RouteKey, VisitKey, CurrQty, Price, result,salescaseprice1,returncaseprice1,returnprice1)
                    },
                    function(error) {
                        navigator.notification.alert(error);
                    },
                    "PluginClass",
                    "GetdataMethod",
                    [Qry]);
                }
                else if (platform == AndroidPlatform) {
                    window.plugins.DataBaseHelper.select(Qry, function(result) {
                        var res = $.map(result.array, function(item, index) {
                            return [[item.totalcount]];
                        });

                        CheckInsert(ItemCode, RouteKey, VisitKey, CurrQty, Price, res,salescaseprice1,returncaseprice1,returnprice1);
                    },
					function() {
					    console.warn("Error calling plugin");
					});
                }
            }
            
            // Insert/Update Quantity according to result.
            function CheckInsert(ItemCode, RouteKey, VisitKey, CurrQty, Price, result,salescaseprice1,returncaseprice1,returnprice1) {  
                anytimetabclick = true;
                if (result == 0) {
                   if(eval(CurrQty) > 0)
                          {
                          Qry = "INSERT INTO salesorderdetail(itemcode,routekey,transactionkey,visitkey," + Qty + ",istemp,salesprice,issync,salescaseprice,returncaseprice,returnprice,stdsalesprice,stdsalescaseprice,stdreturnprice,stdreturncaseprice) VALUES(" + ItemCode + "," + RouteKey + ",0," + sessionStorage.getItem("VisitKey") + "," + CurrQty + ",'true'," + Price + ",0,"+salescaseprice1+","+returncaseprice1+","+returnprice1+",(SELECT defaultsalesprice FROM itemmaster WHERE actualitemcode=" + ItemCode + "),(SELECT caseprice FROM itemmaster WHERE actualitemcode=" + ItemCode + "),(SELECT defaultreturnprice FROM itemmaster WHERE actualitemcode=" + ItemCode + "),(SELECT returncaseprice FROM itemmaster WHERE actualitemcode=" + ItemCode + "))";
                          console.log(Qry);
                    //navigator.notification.alert(Qry);
                    if (platform == iPadPlatform) {
                        Cordova.exec(function(result) {
                            //navigator.notification.alert(result);
                        },
                        function(error) {
                            navigator.notification.alert(error);
                        },
                        "PluginClass",
                        "InsertUpdateMethod",
                        [Qry]);
                    }
                    else if (platform == AndroidPlatform) {
                        window.plugins.DataBaseHelper.insert(Qry, function(result) {
                            //navigator.notification.alert(result);
                        },
					    function() {
					        console.warn("Error calling plugin");
					    });
                    }
                          }
                }
                else {
                    Qry = "UPDATE salesorderdetail SET " + Qty + " = " + CurrQty + ",issync=0 where itemcode=" + ItemCode + " and visitkey=" + VisitKey
                    //navigator.notification.alert(Qry);
                    if (platform == iPadPlatform) {
                        Cordova.exec(function(result) {
                            //navigator.notification.alert(result);
                        },
                        function(error) {
                            navigator.notification.alert(error);
                        },
                        "PluginClass",
                        "InsertUpdateMethod",
                        [Qry]);
                    }
                    else if (platform == AndroidPlatform) {
                        window.plugins.DataBaseHelper.insert(Qry, function(result) {
                            //navigator.notification.alert(result);
                        },
					    function() {
					        console.warn("Error calling plugin");
					    });
                    }
                }

            }
            
            
            // Checking Value is Number
            function CheckIsNaN(val)
            {
                if(isNaN(val))
                    return 0;
                else
                    return val;
            }
            
            // Calculating Total Cases and Total Units in grid.
            function GetCaseUnitTotal() {
                var TC = 0;
                var TU = 0;
                var C, U;
                for (i = 0; i < data.length; i++) {
                    if (CaseEnabled) {
                        C = eval($("#tblContent tr:eq(" + (i + 1) + ") td:eq(1)").text());
                        U = eval($("#tblContent tr:eq(" + (i + 1) + ") td:eq(2)").text());
                        if (C == undefined)
                            C = 0;
                        else
                            TC = TC + C;
                        if (U == undefined)
                            U = 0;
                        else
                            TU = TU + U;
                    }
                    else {
                        U = eval($("#tblContent tr:eq(" + (i + 1) + ") td:eq(1)").text());
                        if (U == undefined)
                            U = 0;
                        TU += eval(U);
                    }
                }                
                return (TC + " / " + TU);
            }

            // Calculating Total Amount in grid.
            function GetTotalAmount() {
                var T;
                var Total = 0;
                for (i = 0; i < data.length; i++) {
                    if (CaseEnabled) {
                        T = eval($("#tblContent tr:eq(" + (i + 1) + ") td:eq(5)").text());
                    }
                    else {
                        T = eval($("#tblContent tr:eq(" + (i + 1) + ") td:eq(3)").text());
                    }

                    if (T == undefined)
                        T = 0;
                    else
                        Total = Total + T;
                }                
                if(eval(Total) == 0)
                    return Total;
                else                
                    return eval(Total).toFixed(decimalplace);
            }
            

            $('.ui-input-datebox').css({ 'background': '#fff', 'width': '92%', 'line-height': '4.0' });
            $('.ui-btn-icon-notext').css({ 'margin-top': '19px !important' });
            $('.ui-input-datebox input').css({ 'width': '76% !important', 'color': '#999' });
            

            function ClearTable(TBL) {
                $("#" + TBL + " tr:gt(0)").remove();
            }


            var lan = sessionStorage.getItem("Language");
            window.lang.run(lan);

            if (sessionStorage.getItem("Language") != "en") {

                window.lang.change('Orderrequest' + lan, lan);
                window.lang.change('Footer' + lan, lan);
                if (lan == "AR") {
                    $(".centerboxInvReq").attr("dir", "rtl");
                    $('#Back_inner').removeClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                    $('#Back_inner').addClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                    $('#lang_inner').removeClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                    $('#lang_inner').addClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                }

            }
            else {
                window.lang.change('en', 'en');
                $(".centerboxInvReq").attr("dir", "ltr");
                $('#Back_inner').removeClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                $('#Back_inner').addClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                $('#lang_inner').removeClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                $('#lang_inner').addClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
            }


        });
        
        function SaveOrderHeader()
            {
                var routecode=sessionStorage.getItem("RouteCode");
                var routekey=sessionStorage.getItem("RouteKey");
                var visitkey=sessionStorage.getItem("VisitKey");
                var platform= sessionStorage.getItem("platform");
                var Qry = "select ids.salesqty,damagedqty,returnqty,manualfreeqty,ids.itemcode,i.unitspercase,CASE WHEN p.salesprice NOT NULL THEN p.salesprice ELSE i.defaultsalesprice END salesprice,CASE  WHEN p.salescaseprice NOT NULL THEN p.salescaseprice ELSE i.caseprice END caseprice,CASE  WHEN p.returncaseprice NOT NULL THEN p.returncaseprice ELSE i.returncaseprice END returncaseprice,CASE  WHEN p.returnprice NOT NULL THEN p.returnprice ELSE i.defaultreturnprice END returnsalesprice from salesorderdetail as ids join itemmaster as i on i.actualitemcode=ids.itemcode left join pricingdetail1 p on p.itemcode = actualitemcode and customerpricingkey = (select ifnull(customerpricing1.customerpricingkey,0) from customerpricing1 join customermaster on customerpricing1.pricingplankey = customermaster.pricingkey and customercode = " + sessionStorage.getItem("customerid") + ")  where routekey="+routekey+" and visitkey="+visitkey;
                console.log(Qry);
                if(platform == "iPad")
                {
                var abc = Cordova.exec(function(result) {
                                        //alert(result);
                                        CalculateAmount(result);
                                        },
                                        function(error) {
                                        alert(error);},
                                        "PluginClass", 
                                        "GetdataMethod", 
                                        [Qry]);
                }
                else if(platform == "Android")
                {
                    window.plugins.DataBaseHelper.select(Qry,function(result)
							{
								if(result.array != undefined)
								{
									result = $.map(result.array, function (item, index) {                
	                					return [[item.salesqty,item.damagedqty,item.returnqty,item.manualfreeqty,item.itemcode,item.unitspercase,item.salesprice,item.caseprice,item.returncaseprice,item.returnsalesprice]];
            						});
							 		CalculateAmount(result);
							 	}
							},
							function()
							{
						   	 console.warn("Error calling plugin");
							});
                }
            }
            
        function CalculateAmount(data)
            {
                var salesamount=0;
                var damageamount=0;
                var returnamount=0;           
                var manualfreeamount=0;
            
                var salesunit=0;
                var salescase=0;
                var damagedunit=0;
                var damagecase=0;
                var returnunit=0;
                var returncase=0;                
                var manualfreeunit=0;
                var manualfreecase=0;
            
                for (i = 0; i < data.length; i++)
                {
                var salesqty = data[i][0];
                var damagedqty = data[i][1];
                var retrunqty = data[i][2];                
                var manualfreeqty = data[i][3];                
                var itemcode = data[i][4];
                var unitspercase = data[i][5];
                var salesprice = eval(data[i][6]).toFixed(decimalplace);
                var caseprice = eval(data[i][7]).toFixed(decimalplace);
                var returncaseprice = eval(data[i][8]).toFixed(decimalplace);
                var returnprice = eval(data[i][9]).toFixed(decimalplace);                
                   
                if(salesqty != '')
                {
                salesunit = parseInt(salesqty%unitspercase);
                salescase =parseInt(salesqty/unitspercase);               
                salesamount = salesamount + ((salescase * caseprice) + ((salesunit) * salesprice));
                }
                    
                damagedunit = parseInt(damagedqty%unitspercase);
                damagecase = parseInt(damagedqty/unitspercase);
                damageamount += ((damagecase * returncaseprice) + ((damagedunit) * returnprice));
                
                returnunit = parseInt(retrunqty%unitspercase);
                returncase = parseInt(retrunqty/unitspercase);
                returnamount += ((returncase * returncaseprice) + ((returnunit) * returnprice));
                
                manualfreeunit = parseInt(manualfreeqty%unitspercase);
                manualfreecase = parseInt(manualfreeqty/unitspercase);
                manualfreeamount += ((manualfreecase * caseprice) + ((manualfreeunit) * salesprice));

                salesamount = CheckIsNaN(salesamount);
                damageamount = CheckIsNaN(damageamount);
                returnamount = CheckIsNaN(returnamount);
                manualfreeamount = CheckIsNaN(manualfreeamount);
                }
                
                var dt = $("#txtdate").val();
                dt = dt.split("-");
                dt[0] = (dt[0]<=9 ? "0"+dt[0] : dt[0]);
                var dtnew = dt[2] + "-" + dt[1] + "-" + dt[0];                
                
                var platform = sessionStorage.getItem("platform");
                sessionStorage.setItem("OrderNumber",InvoiceNumber);
                var Qry = "SELECT COUNT(*) as cnt FROM salesorderheader where routekey = " + sessionStorage.getItem("RouteKey") + " and visitkey = " + sessionStorage.getItem("VisitKey");
                console.log(Qry);                
                var totalorder = eval(salesamount)-eval(returnamount)-eval(damageamount);
                var QryInsert = "INSERT INTO salesorderheader(istemp,transactionkey,documentnumber,invoicenumber,routekey,visitkey,transactiondate,transactiontime,customercode,routecode,salesmancode,totalsalesamount,totalreturnamount,totaldamagedamount,totalbuybackfreeamount,issync,totalinvoiceamount,hhctransactionkey,orderdeliverydate,actualtransactiondate) VALUES('true',(SELECT ifnull(max(transactionkey),0) + 1 from salesorderheader),0,0," + sessionStorage.getItem("RouteKey") + "," + sessionStorage.getItem("VisitKey") + ",date(),time('now', 'localtime')," + sessionStorage.getItem("customerid") + "," + sessionStorage.getItem("RouteCode") + "," + sessionStorage.getItem("SalesmanCode") + "," + salesamount + "," + returnamount + "," + damageamount + "," + manualfreeamount + ",0,"+totalorder+"," + sessionStorage.getItem("VisitKey") + ",'" + dtnew + "',date())";
                var QryUpdate = "UPDATE salesorderheader set transactiontime=time('now', 'localtime'),totalsalesamount=" + salesamount + ",totalreturnamount=" + returnamount + ",totaldamagedamount=" + damageamount + ",totalbuybackfreeamount=" + manualfreeamount + ",issync=0,totalinvoiceamount="+totalorder+",orderdeliverydate='" + dtnew + "' where routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey = " + sessionStorage.getItem("VisitKey");
                if (platform == "iPad") {
                    console.log(QryInsert);
                    Cordova.exec(function(result) {
                        if (result.length > 0) {
                            if (result[0][0] <= 0) {
                                    Cordova.exec(function(result) {
                                        checkcreditlimit(salesamount);                                        
                                    },
                                    function(error) {
                                        alert(error);
                                    },
                                    "PluginClass",
                                    "InsertUpdateMethod",
                                    [QryInsert]);
                            }
                            else {
                                    Cordova.exec(function(result) {
                                        checkcreditlimit(salesamount);                                        
                                    },
                                    function(error) {
                                        alert(error);
                                    },
                                    "PluginClass",
                                    "InsertUpdateMethod",
                                    [QryUpdate]);
                            }
                        }
                    },
                    function(error) {
                        alert(error);
                    },
                    "PluginClass",
                    "GetdataMethod",
                    [Qry]);
                }
                else if (platform == "Android") {
                	window.plugins.DataBaseHelper.select(Qry, function(result) 
                	{
                		if(result.array != undefined)
                		{                		
                   		if (result.array[0].cnt <= 0) 
                    	{	
                            window.plugins.DataBaseHelper.insert(QryInsert, function(result) 
                            {
                                checkcreditlimit(salesamount);                               	
                            },
	                        function() 
	                        {
	                           	console.warn("Error calling plugin");
	                        });                        
                        }
                        else 
                        {
                            window.plugins.DataBaseHelper.insert(QryUpdate, function(result) 
                            {
                                checkcreditlimit(salesamount);                                
                            },
	                        function() 
	                        {
	                            console.warn("Error calling plugin");
	                        });
                        }  
                        }                  
                    },
                    function() {
	                            console.warn("Error calling plugin");
	                });
                }
            }
        function checkcustomerbalace(balance)
        {
            var custid=sessionStorage.getItem("customerid");
            var platform= sessionStorage.getItem("platform");
            if(balance=='')
            balance=0;
            
            if(platform=='iPad')
            {
                Cordova.exec(function(result) {
                              
                              if(eval(result[0][1]) > 1)
                              {
                              
                              if(eval(balance) >= eval(result[0][0]))
                              {
                              navigator.notification.alert("Order Amount Exceeded Credit Limit.");
                              SetNextPage();
                              }
                              else
                              {
                              SetNextPage();
                              }
                              }
                              else
                              {
                              SetNextPage();
                              }
                              },
                              function(error) {
                              alert(error);
                              },
                              "PluginClass",
                              "GetdataMethod",
                              ["select (CASE WHEN jp.creditlimit IS NOT NULL THEN jp.creditlimit ELSE cm.creditlimit END) AS creditlimit,invoicepaymentterms from customermaster cm left join journeyplancreditlimit jp ON jp.customercode = cm.customercode and jp.routecode = " + sessionStorage.getItem("RouteCode") + " where cm.customercode="+custid]);
            }
            else if(platform=='Android')
            {
                window.plugins.DataBaseHelper.select("select (CASE WHEN jp.creditlimit IS NOT NULL THEN jp.creditlimit ELSE cm.creditlimit END) AS creditlimit,invoicepaymentterms from customermaster cm left join journeyplancreditlimit jp ON jp.customercode = cm.customercode and jp.routecode = " + sessionStorage.getItem("RouteCode") + " where cm.customercode="+custid,function(result)
                                                     {
                                                     if(eval(result.array[0].invoicepaymentterms) > 1)
                                                     {
                                                     if(eval(balance) >= eval(result.array[0].creditlimit))
                                                     {
                                                     navigator.notification.alert("Order Amount Exceeded Credit Limit.");
                                                      SetNextPage();
                                                     }
                                                     else
                                                     {
                                                     SetNextPage();
                                                     }
                                                     }
                                                     else
                                                     {
                                                     SetNextPage();
                                                     }
                                                     },
                                                     function()
                                                     {
                                                     console.warn("Error calling plugin");
                                                     });
            }
        }
        function checkcreditlimit(salesamount)
        {
            
            var Qry = "select sum(invoicebalance) as balance from customerinvoice where routecode="+sessionStorage.getItem("RouteCode")+" and customercode="+sessionStorage.getItem("customerid");
            console.log(Qry);
            if(platform == "iPad")
            {
                Cordova.exec(function(result) {
                              var balance = result[0][0];
                              if(balance == '')
                              balance=0;
                              
                              total = eval(salesamount)+eval(balance);
                              checkcustomerbalace(total);
                              
                              },
                              function(error) {
                              alert(error);
                              },
                              "PluginClass",
                              "GetdataMethod",
                              [Qry]);
            }
            else if(platform == "Android")
            {
                window.plugins.DataBaseHelper.select(Qry, function(result) 
                                                     {
                                                     var balance = result.array[0].balance;
                                                     if(balance == '')
                                                     	balance=0;                                                     
                                                     total = eval(salesamount)+eval(balance);
                                                     checkcustomerbalace(total);
                                                    
                                                     },
                                                     function() 
                                                     {
                                                     console.warn("Error calling plugin");
                                                     });
            }
            
            
            
        }
            // Checking Value is Number
        function CheckIsNaN(val)
        {
            if(isNaN(val))
                return 0;
            else
                return val;
        }       
        
        
        function GetOrderInvoiceNumber()
        {          	
            if(eval($("#txtTotal2").val()) <=0 )
            {
                navigator.notification.alert("Enter Order Detail.");
                return false;
            }
            /*var Qry = "SELECT CASE WHEN MAX(invoicenumber) IS NULL OR MAX(invoicenumber) = 0 THEN '000000' ELSE SUBSTR(MAX(invoicenumber),-6) END as invoicenumber from salesorderheader";*/
            var Qry = "SELECT CASE WHEN MAX(hhcordseq) IS NULL OR MAX(hhcordseq) = 0 OR MAX(hhcordseq) = 'null' THEN 0 ELSE hhcordseq END as invoicenumber from routemaster WHERE routecode = " + sessionStorage.getItem("RouteCode");
            console.log(Qry);
            if(platform == "iPad")
        	{
            Cordova.exec(function(result) {
                if(result.length > 0)
                {
                   var InvoicePrefix  = sessionStorage.getItem("RouteCode").toString() + '1'; // 1 is the prefix for order
                   InvoiceNumber = InvoicePrefix.toString() + (eval(result[0][0]) + 1).toString().lpad("0",6); 
                   SaveOrderHeader();                 
                }
            },
            function(error) {
                alert(error);
            },
            "PluginClass",
            "GetdataMethod",
            [Qry]);
            }
           else if(platform == "Android")
            {
                window.plugins.DataBaseHelper.select(Qry, function(result) 
                                                     {
                                                     	if(result.array != undefined)
                                                     	{
	                                                     	result = $.map(result.array, function(item, index) {
                        										return [[item.invoicenumber]];
                    								 		});                    								 		
                    								 		if(result.length > 0)
                									 		{
                   												var InvoicePrefix  = sessionStorage.getItem("RouteCode").toString() + '1'; // 1 is the prefix for order
               													InvoiceNumber = InvoicePrefix.toString() + (eval(result[0][0]) + 1).toString().lpad("0",6); 
                   												SaveOrderHeader();                 
                									 		}
                									 	}
                                                     },
                                                     function() 
                                                     {
                                                     console.warn("Error calling plugin");
                                                     });
            }
        }       
        
        
        function SetNextPage()
        {
            
            var EnableComment,EnableSalesPromotion;
            EnableComment = localStorage.getItem("enableinvoicecomment");
            EnableSalesPromotion = localStorage.getItem("enableorderpromotion");
            
            if(EnableComment == 1)
            window.location = "ordercomment.html";
            else
            {
                
                if(EnableSalesPromotion == 1)
                {   
                    console.log("in");
                    getPromotionplan();
                    
                }
                else
                {
                    if(sessionStorage.getItem("SignEnabled") != 1)
                    window.location = "../customer/signature.html" ;
                    else
                    {                        
                        window.location = '../customer_opt/orderdetail.html'; 
                    }
                }
            }
        }
        
        function getPromotionplan()
        {
            if (platform == 'iPad') {
                Cordova.exec(function(result) {
                              
                              promotionKeyplan = result[0][0];
                              console.log("in=="+promotionKeyplan);
                              if(promotionKeyplan > 0)
                              window.location = "../customer_opt/order_promotion_list.html";
                              else
                              {
                              if(sessionStorage.getItem("SignEnabled") != 1)
                              window.location = "../customer/signature.html" ;
                              else
                              {                              
                              window.location = '../customer_opt/orderdetail.html'; 
                              }
                              }
                              },
                              function(error) {
                              navigator.notification.alert("Error updating record in salesman");
                              },
                              "PluginClass",
                              "GetdataMethod",
                              ["select count(*) as cnt from promokeydetail join customermaster on customermaster.promotionkey=promokeydetail.promotionkey where customercode="+sessionStorage.getItem("customerid")]);
            }
            else if (platform == 'Android') {
                
                window.plugins.DataBaseHelper.select("select count(*) as cnt from promokeydetail join customermaster on customermaster.promotionkey=promokeydetail.promotionkey where customercode="+sessionStorage.getItem("customerid"), function(result) {
                                                     var result = $.map(result.array, function(item, index) {
                                                                        return [[item.cnt]];
                                                                        });
                                                     
                                                     
                                                     promotionKeyplan = result[0][0];
                                                     if(promotionKeyplan > 0)
                                                     window.location = "../customer_opt/order_promotion_list.html";
                                                     else
                                                     {
                                                     if(sessionStorage.getItem("SignEnabled") != 1)
                                                     window.location = "../customer/signature.html" ;
                                                     else
                                                     {
                                                     
                                                     window.location = '../customer_opt/orderdetail.html'; 
                                                     }
                                                     }
                                                     
                                                     
                                                     },
                                                     function() {
                                                     console.warn("Error calling plugin");
                                                     });
            }
        }
        
        function PromotionCount()
        {
            
            var Qry = "SELECT COUNT(*) as cnt FROM promotiondetail WHERE istemp='true' and routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + sessionStorage.getItem("VisitKey");
            if(platform=='iPad')
            {
                Cordova.exec(function(result) {  
                              
                              if(result=="0")
                              boolPromotion = false;                            
                              else
                              boolPromotion = true;
                              SalesCount();
                              },
                              function(error) {
                              alert(error);},
                              "PluginClass", 
                              "GetdataMethod",                
                              [Qry]);
            }
            else if(platform=='Android')
            {
                window.plugins.DataBaseHelper.select(Qry,function(result)
                                                     {
                                                     result = $.map(result.array, function (item, index) {
                                                                    
                                                                    return [[item.cnt]];
                                                                    });
                                                     if(result=="0")
                                                     boolPromotion = false;                            
                                                     else
                                                     boolPromotion = true;
                                                     SalesCount();
                                                     
                                                     },
                                                     function()
                                                     {
                                                     console.warn("Error calling plugin");
                                                     });
            }  
        }
        
        function SalesCount()
        {
            var Qry = "SELECT COUNT(*) as cnt FROM salesorderdetail WHERE istemp='true' and routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + sessionStorage.getItem("VisitKey");
			if(platform=='iPad')
            {
                Cordova.exec(function(result) {                       
                              
                              if(result=="0")
                              boolSales = false;                            
                              else
                              boolSales = true;
                              SaveDataAlert();
                              // InvoiceRxCount();
                              },
                              function(error) {
                              alert(error);},
                              "PluginClass", 
                              "GetdataMethod",                
                              [Qry]);
            }
            else if(platform=='Android')
            {
                window.plugins.DataBaseHelper.select(Qry,function(result)
                                                     {
                                                     result = $.map(result.array, function (item, index) {
                                                                    
                                                                    return [[item.cnt]];
                                                                    });
                                                     if(result=="0")
                                                     boolSales = false;                            
                                                     else
                                                     boolSales = true;
                                                     SaveDataAlert();
                                                     
                                                     },
                                                     function()
                                                     {
                                                     console.warn("Error calling plugin");
                                                     });
            } 
        }
        function SaveDataAlert()
        {  
            sessionStorage.removeItem("addorderqty");
            if(boolPromotion==true || boolSales==true)
            {
                
                var res = navigator.notification.confirm("Discard All Changes And Exit?",onConfirm);
                
            }
            else
            {
                window.location='cust_opt.html';
            }
            
        }
        function onConfirm(button)
        {               
            if(button == 1)
            {
                DeleteUnsavedData();   
            }
        }
        function DeleteUnsavedData()
        {            
            var Tbls = ["salesorderdetail","promotiondetail","salesorderdetail","cashcheckdetail"];
            for(i=0;i<Tbls.length-1;i++)
            {
                if(i == 5 || i == 6 || i == 7)
                {
                    var Qry = "DELETE FROM " + Tbls[i] + " WHERE istemp='true' and transactiontypecode!=07 and routekey=" + sessionStorage.getItem("RouteKey");
                }
                else
                {            
                    var Qry = "DELETE FROM " + Tbls[i] + " WHERE istemp='true' and routekey=" + sessionStorage.getItem("RouteKey") + " and visitkey=" + sessionStorage.getItem("VisitKey");
                }
                //alert(Qry);
                if(platform=='iPad')
		    	{
                    Cordova.exec(function(result) {
                                  //alert(result);
                                  window.location='cust_opt.html';
                                  },
                                  function(error) {
                                  alert(error);},
                                  "PluginClass", 
                                  "GetdataMethod",                
                                  [Qry]);
                }
                else if(platform=='Android')
           		{
	           		window.plugins.DataBaseHelper.insert(Qry,function(result)
                                                         {
                                                         window.location='cust_opt.html';
                                                         
                                                         },
                                                         function()
                                                         {
                                                         console.warn("Error calling plugin");
                                                         });
           		}  
            }
        }
        
        function SetPage()
        {
            sessionStorage.addmodule = 'customer';
            sessionStorage.addorderqty = Qty;
            //window.location = "add_order_request.html?from=" + Qty;
            window.location = "add_order_request.html";

        }
    </script>

</body>
</html>
