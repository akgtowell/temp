<!--
 '  Created By   : Nidhi Dedania
 '  Created Date : 26/1/2011
 '  Description  : This page is used for detail of commission
-->

<!DOCTYPE html>
<html>
<head>
<title>HOME</title>
<meta name="viewport"
	content="width=device-width, initial-scale=1.0;maximum-scale=1.0;user-scalable=0; target-densitydpi=device-dpi">

<meta name="format-detection" content="telephone=no">
<link rel="stylesheet" href="../css/style.css" />
<link rel="stylesheet" href="../css/en.css" lang="en" />
<link rel="stylesheet" href="../css/jquery.mobile-1.0.min.css" />
<link rel="stylesheet"
	media="only screen and (min-width: 1200px) and (max-width: 1500px)"
	href="../css/style_1400.css" />
<link rel="stylesheet"
	media="only screen and (min-width: 1000px) and (max-width: 1200px)"
	href="../css/style_1200.css" />
<link rel="stylesheet"
	media="only screen and (min-width: 700px) and (max-width: 800px)"
	href="../css/style_800.css" />
<link rel="stylesheet"
	media="only screen and (min-width: 600px) and (max-width: 699px)"
	href="../css/style_700.css" />
<link rel="stylesheet"
	media="only screen and (min-width: 320px) and (max-width: 599px)"
	href="../css/style_600.css" />

<script type="text/javascript" src="../js/jquery.js"></script>

<script type="text/javascript" src="../js/jquery.mobile-1.0.js"></script>

<script type="text/javascript" src="../js/common.js"></script>
<script type="text/javascript" src="../js/batch.js"></script>
<script>
if (navigator.userAgent.toLowerCase().match(/android/)) {
document.write('<script charset="utf-8" src="../cordova-2.0.0.js"><\/script>');
document.write('<script charset="utf-8" src="../directoryListing.js"><\/script>');
} else if (navigator.userAgent.toLowerCase().match(/iphone/) || navigator.userAgent.toLowerCase().match(/ipad/)) {
document.write('<script charset="utf-8" src="../cordova-1.5.0.js"><\/script>');
}
    </script>

<script type="text/javascript" src="../js/jquery.json-2.3.min.js"></script>

<script src="../LangJS/jquery-lang.js" charset="utf-8"
	type="text/javascript"></script>

<script src="../LangJS/langpack/AR.js" charset="utf-8"
	type="text/javascript" lang="en"></script>
<link rel="stylesheet" type="text/css"
	href="../css/jquery.mobile.simpledialog.css" />

<script type="text/javascript" src="../js/jquery.mobile.simpledialog.js"></script>
</head>
<body>
	<div data-role="page" data-theme="d" data-title="HOME" id="myPage">
		<div>
			<img title="" alt="" src="../images/bg.png" id="background">
		</div>
		<div data-role="header" data-position="inline" id="bgclheader">
			<!--<a href="index.html"   id="Back_inner">test</a>-->
			<a href="customer_promotion_listexpress.html" id="Back_inner"
				class="enableText" rel="external" lang="en">Back</a> <div class="wrapper"><div class="card_content"><div><img title="" alt="" data-pushbar-target="left"  src="../images/icons8-menu-50.png" id="setting"></div></div></div> 
			<h1 lang="en">Promotions Review</h1>
			<a href="#" id="lang_inner">EN</a>
		</div>
		<div data-role="content" class="centerboxInvReq">
			<div class="com_div comm" style="display: none" id="divTotalInvoice">
				<table border="0" width="100%" cellpadding="6" cellspacing="0"
					id="tbl1" data-role="none">
					<thead>
						<tr>
							<td class="tblHeader" style="padding: 10px;" lang="en"
								id="divPromoKey">Promotions Review</td>
							<td colspan=2 class="tblHeader" style="padding: 10px;" lang="en"
								id="divPromoDesc">Promotions Review</td>
						</tr>
					</thead>
					<tbody class="tbl_body">
						<!-- <tr class="tr_commission td_com1" style="font-size:18px;">
                           <td width="36%" lang="en">Promo Plan</td>
                            <td style="text-align: right;" colspan=2>
                                <div id="divPromoKey" class="readonly_text" style="width:85%">
                                </div>
                            </td>
                        </tr>
                         <tr class="tr_commission td_com1" style="font-size:18px;">
                            <td lang="en" width="36%">
                                Promo Description
                            </td>                           
                            <td colspan=2>
                                <div id="divPromoDesc" class="readonly_text" style="width:85%">
                                </div>
                            </td>
                        </tr>-->
						<tr class="tr_commission td_com1" style="font-size: 18px;">
							<td width="36%" lang="en">Current Invoice Amount</td>
							<td style="text-align: right;" colspan=2>
								<div id="divCIAmount" class="readonly_text" style="width: 85%">
								</div>
							</td>
						</tr>
						<tr class="tr_commission td_com1" style="font-size: 18px;"
							id="app1">
							<td width="36%" lang="en">Qualified Amount</td>
							<td colspan=2 style="text-align: right;">
								<div id="divqualifiedAmount" class="readonly_text"
									style="width: 85%"></div>
							</td>
						</tr>

						<tr class="tr_commission td_com1" style="font-size: 18px;"
							id="app2">
							<td lang="en" width="36%">Applied Promotion</td>

							<td width="32%" style="text-align: right;">
								<div id="divPromo" class="readonly_text" style="width: 80%">
								</div>
							</td>
							<td
								style="padding-left: 0px; padding-right: 30px; text-align: right;">
								<div id="divPromotionAmount" class="readonly_text"
									style="width: 80%"></div>
							</td>
						</tr>
						<tr class="tr_commission td_com1" style="font-size: 18px;"
							id="app1">
							<td width="36%" lang="en">Return Qualified Amount</td>
							<td colspan=2 style="text-align: right;">
								<div id="divqualifiedAmount1" class="readonly_text"
									style="width: 85%"></div>
							</td>
						</tr>

						<tr class="tr_commission td_com1" style="font-size: 18px;"
							id="app2">
							<td lang="en" width="36%">Return Applied Promotion</td>

							<td width="32%" style="text-align: right;">
								<div id="divPromo1" class="readonly_text" style="width: 80%">
								</div>
							</td>
							<td
								style="padding-left: 0px; padding-right: 30px; text-align: right;">
								<div id="divPromotionAmount1" class="readonly_text"
									style="width: 80%"></div>
							</td>
						</tr>
						<tr class="tr_commission td_com1" style="font-size: 18px;"
							id="app3">
							<td width="36%" lang="en">Promotion Amount</td>
							<td style="text-align: right;" colspan=2>
								<div id="divPromotionAmount" class="readonly_text"
									style="width: 85%"></div>
							</td>
						</tr>
						<tr class="tr_commission td_com1" style="font-size: 18px;">
							<td lang="en" width="36%">New Invoice Amount</td>
							<td style="text-align: right;" colspan=2>
								<div id="divNIAmount" class="readonly_text" style="width: 85%">
								</div>
							</td>
						</tr>
						<tr>
							<td colspan="2"></td>
						</tr>
					</tbody>
				</table>
			</div>
			<div class="com_div comm" id="divLineItem">
				<div class="textBar">
					<table id="tblInput" cellpadding="2" cellspacing="2" border="0"
						width="100%">
						<tr>
							<td class="captionLabel" lang="en" style="width: 30%">Promo Plan</td>
							<td><input id="txtPromoKey" type="text"
								class="textWidth textFont" readonly="readonly" /></td>
						</tr>
						<tr>
							<td class="captionLabel" lang="en" style="width: 30%">Description</td>
							
							<td><input id="txtDescription" type="text"
								class="textWidth textFont" readonly="readonly" /></td>
						</tr>
					</table>
				</div>
				<div class="tblBox tbltd">
					<table id="tblLineHeader" cellpadding="0" cellspacing="0"
						width="100%" class="tblHeader">
						<tr>
							<th style="width: 20%;" lang="en" class="leftAlign">Item Code</th>
							<th style="width: 30%;" lang="en" class="leftAlign">Item Description</th>
							<th style="width: 20%;" lang="en">Old</th>
							<th style="width: 20%;" lang="en">New</th>
							<th style="width: 10%;" lang="en" class="last">Type</th>
						</tr>
					</table>
					<div id="contentWrapper" class="tblHeightWithTab">
						<table id="tblLineContent" cellpadding="0" cellspacing="0"
							border="0" width="100%">
							<tr>
								<td style="width: 20%;" class="leftAlign"></td>
								<td style="width: 30%;" class="leftAlign"></td>
								<td style="width: 20%;"></td>
								<td style="width: 20%;"></td>
								<td style="width: 10%;" class="last"></td>
							</tr>
						</table>
					</div>
				</div>
				<div class="textBar">
					<table id="tblInput" cellpadding="2" cellspacing="2" border="0"
						width="100%">
						<tr>
							<td class="captionLabel" lang="en" style="width: 50%">Current Invoice</td>
							<td class="captionLabel" lang="en" style="width: 50%">New Invoice</td>
						</tr>
						<tr>
							<td><input id="txtcurrentinvoice" type="text"
								class="textWidth textFont" style="text-align: right;"
								readonly="readonly" /></td>
							<td><input id="txtnewinvoice" type="text"
								class="textWidth textFont" style="text-align: right;"
								readonly="readonly" /></td>
						</tr>
					</table>
				</div>
			</div>
			<div class="com_div comm" style="display: none;" id="divFreeSample">
				<div class="textBar">
					<table id="tblInput" cellpadding="2" cellspacing="2" border="0"
						width="100%">
						<tr>
							<td class="captionLabel" lang="en" style="width: 30%">Promo Plan</td>
							<td><input id="txtPromoKey1" type="text"
								class="textWidth textFont" readonly="readonly" /></td>
							
						</tr>
						<tr>
							<td class="captionLabel" lang="en" style="width: 30%">Description</td>
							<td><input id="txtDescription1" type="text"
								class="textWidth textFont" readonly="readonly" /></td>
							
							
						</tr>
					</table>
				</div>
				<div class="tblBox tbltd">
					<table id="tblHeaderContent" cellpadding="0" cellspacing="0"
						width="100%" class="tblHeader">
						<tr>
							<th style="width: 20%;" lang="en" class="leftAlign">Item Code</th>
							<th style="width: 30%;" lang="en" class="leftAlign">Item Description</th>
							<th style="width: 15%;" lang="en" id="sqty">Sales Qty</th>
							<th style="width: 15%;" lang="en">UPC</th>
							<th style="width: 20%;" lang="en" class="last">Given Free</th>
						</tr>
					</table>
					<div id="contentWrapper"
						class="tblHeightWithTab tblHeightWithTabreview">
						<table id="tblContent" cellpadding="0" cellspacing="0" border="0"
							width="100%">
							<tr>
								<td style="width: 20%;" class="leftAlign"></td>
								<td style="width: 30%;" class="leftAlign"></td>
								<td style="width: 15%;"></td>
								<td style="width: 15%;"></td>
								<td style="width: 20%;" class="last"></td>
							</tr>
						</table>
					</div>
				</div>
				<div class="textBar">
					<table id="tblInput" cellpadding="2" cellspacing="2" border="0"
						width="100%">
						<tr>
							<td style="width: 50%;" lang="en">Allowed Free</td>
							<td style="width: 50%;">Allowed Free Return</td>
						</tr>
						<tr>
							<td>
								<!--<input id="txFreeQty" type="text" pattern="[0-9]*" size="11" class="textWidth textFont"  value="0" readonly="readonly"/>-->
								<input id="txFreeQty" type="number" size="11"
								class="textWidth textFont" value="0" readonly="readonly" />
							</td>
							<td>
								<!--<input id="txFreeQtyreturn" type="text" pattern="[0-9]*" size="11" class="textWidth textFont"  value="0" readonly="readonly"/>-->
								<input id="txFreeQtyreturn" type="number" size="11"
								class="textWidth textFont" value="0" readonly="readonly" />
							</td>
						</tr>
					</table>
				</div>
				<div class="textBar" id="addfreegrid" style="display: none;">
					<table id="tblInput1" cellpadding="2" cellspacing="2" border="0"
						width="100%">
						<tr>
							<td style="width: 50%;" lang="en">Item</td>
							<td style="width: 50%;">Qty</td>
							<td></td>
						</tr>
						<tr>
							<td><select id="txtitemadd" style="width: 100%"
								name="select-choice-1"></select></td>
							<td>
								<!--<input id="txFreeQtyadd" type="text" pattern="[0-9]*" size="11" class="textWidth textFont"  value="0"/>-->
								<input id="txFreeQtyadd" type="number" size="11"
								class="textWidth textFont" value="0" />
							</td>
							<td><input type="button" value="Add" name="add"
								onclick="savepromotion()" /></td>
						</tr>
					</table>
				</div>
			</div>
			<div class="leftbottomMenu">


				<!-- <a href="#" onclick="checkfreepromo()" rel="external" id="continue"
                    style="text-decoration: none" data-role="none">-->
				<a href="#" onclick="continueprom();" rel="external" id="continue"
					style="text-decoration: none" data-role="none">
					<div class="MenuPositionFourIcons up_book_div">
						<div class="MenuTextPos">
							<img src="../images/icn-select.png" alt="Add" />
						</div>
						<div class="MenuTextPos MenuText" lang="en">Continue</div>
					</div>
				</a>


				<div class="MenuPositionFourIcons up_book_div">
					<div class="MenuTextPos">
						<img id="imgNext" src="../images/left.png" alt="Option" />
					</div>
					<div class="MenuTextPos MenuText" lang="en">Next</div>
				</div>
				<div class="MenuPositionFourIcons up_book_div">
					<div class="MenuTextPos">
						<img id="imgPrev" src="../images/right.png" alt="Exit" />
					</div>
					<div class="MenuTextPos MenuText" lang="en">Previous</div>
				</div>
				<a href="customer_promotion_listexpress.html" onclick="" rel="external"
					id="A3" style="text-decoration: none" data-role="none">
					<div class="MenuPositionFourIcons up_book_div">
						<div class="MenuTextPos">
							<img src="../images/no.png" alt="Exit" />
						</div>
						<div class="MenuTextPos MenuText" lang="en">Cancel</div>
					</div>
				</a>
			</div>
			<table id="tblPassword" border="0" cellpadding="2" cellspacing="0"
				width="100%;" style="display: none;">
				<tr>
					<th class="tblHeader captionLabel leftAlign popupTitle" colspan="2"
						lang="en">Password Entry</th>
				</tr>
				<tr class="popupRow">
					<td colspan="2">&nbsp;</td>
				</tr>
				<tr class="popupRow">
					<td colspan="2" colspan="2" class="popupSubTitle" lang="en">
						Promotion Review</td>
				</tr>
				<tr class="popupRow">
					<td colspan="2" lang="en" class="popupInfo">Please Enter The
						Security Password</td>
				</tr>
				<tr class="popupRow">
					<td colspan="2"><input id="txtPassword"type="tel" pattern="[0-9]*" value="" maxlength="10" class="textWidth textFont passwordCenter"
						 /> <label id="lblMessage" lang="en"
						style="display: none">Enter Correct Password</label></td>
				</tr>
				<tr class="popupRow">
					<td style="width: 50%;"><input id="btnSubmit" type="button"
						value="Submit"
						onclick="VerifyPassword('btnSubmit','promotion_reviewexpress.html',tblPassword.innerHTML);"
						data-role="none" lang="en" /></td>
					<td style="width: 50%;"><input id="btnCancel" type="button"
						rel="close" value="Cancel" onclick="ClearPassword();"
						data-role="none" lang="en" /></td>
				</tr>
			</table>
		</div>
		<div id="f1" data-role="footer" class="ui-bar">
			<div class="footer">
				<div class="leftfooter">09 November 2011</div>
				<div class="rightfooter">Mirnah Technology Systems</div>
			</div>
		</div>
		<div id="f2" data-role="footer" style="bottom: 0; position: absolute;">
		 <aside data-pushbar-id="left" class="pushbar from_left">
		<div class="title"><span data-pushbar-close class="close push_right"></span>
			<span id="txtroute"></span>
		</div>

		<ul class="menu">
		<li style="margin-bottom: 0 !important;" > 
		<img title="" alt="" src="../images/startday-icon.png" id="day"  class="leftmenu" >
		 <a href="#"
						class="ui-btn-active" rel="external" id="day" data-icon="custom"  
						lang="en" onclick="footerredict('../startofday/startofday.html')">Start day</a></li>
					<li style="margin-bottom: 0 !important;">
					 <img title="" alt="" src="../images/Inventoryicon.png" id="inve"  class="leftmenu">
					 <a href="#" id="inve"
						rel="external" data-icon="custom" lang="en"
						onclick="footerredict('../inventory/inventory.html')">Inventory</a></li>
					<li style="margin-bottom: 0 !important;">
					 <img title="" alt="" src="../images/customer-icon.png" id="cust" class="leftmenu">
					 <a href="#"
						rel="external" id="cust" data-icon="custom" lang="en"
						onclick="footerredict('../customer/customer_operation.html')">Customer</a></li>
					<li style="margin-bottom: 0 !important;">
					<img title="" alt="" src="../images/Money-icon.png" id="sett" class="leftmenu">
					<a href="#"
						rel="external" id="sett" data-icon="custom" lang="en"
						onclick="footerredict('../settlement/managesettlement.html')">Settlement</a></li>
					<li style="margin-bottom: 0 !important;">
					<img title="" alt="" src="../images/expense-icon.png" id="expe" class="leftmenu">
					<a href="#"
						rel="external" id="expe" data-icon="custom" lang="en"
						onclick="footerredict('../settlement/expenseentry.html')">Expenses</a></li>
					<li style="margin-bottom: 0 !important;">
					<img title="" alt="" src="../images/information-icon.png" id="info" class="leftmenu" >
					<a href="#"
						rel="external" id="info" data-icon="custom" lang="en"  
						onclick="footerredict('../information/information.html')">Information</a></li>
					<li style="margin-bottom: 0 !important; ">
					 <img title="" alt="" src="../images/user-settings-icon.png" id="setup" class="leftmenu">
					 <a href="#" rel="external" id="setup" data-icon="custom" lang="en"
						onclick="footerredict('../utilities/utilities.html')">Utilities</a></li>
		</ul>

	</aside>
		
			<div data-role="navbar" data-iconpos="top" data-grid="f">
				<ul>
					<li style="margin-bottom: 0 !important;"><a href="#"
						rel="external" id="day" data-icon="custom" lang="en"
						onclick="footerredict('../startofday/startofday.html')">Start day</a></li>
					<li style="margin-bottom: 0 !important;"><a href="#" id="inve"
						rel="external" data-icon="custom" lang="en"
						onclick="footerredict('../inventory/inventory.html')">Inventory</a></li>
					<li style="margin-bottom: 0 !important;"><a href="#"
						class="ui-btn-active" rel="external" id="cust" data-icon="custom"
						lang="en">Customer</a></li>
					<li style="margin-bottom: 0 !important;"><a href="#"
						rel="external" id="sett" data-icon="custom" lang="en"
						onclick="footerredict('../settlement/managesettlement.html')">Settlement</a></li>
					<li style="margin-bottom: 0 !important;"><a href="#"
						rel="external" id="expe" data-icon="custom" lang="en"
						onclick="footerredict('../settlement/expenseentry.html')">Expenses</a></li>
					<li style="margin-bottom: 0 !important;"><a href="#"
						rel="external" id="info" data-icon="custom" lang="en"
						onclick="footerredict('../information/information.html')">Information</a></li>
					<li style="margin-bottom: 0 !important; width: 14.0%"><a
						href="#" rel="external" id="setup" data-icon="custom" lang="en"
						onclick="footerredict('../utilities/utilities.html')">Utilities</a></li>
				</ul>
			</div>
		</div>


		<script type="text/javascript" language="javascript">
            var data = null,dataAmount = null,dataItem = null,dataLineItem = null,dataFreeSample = null;  
            var NoNext = false;
            var planNumber = 0, promotionTypeCode = -1, rangeBasis = 0, assignmentgroup = 0,promovalue = 0,rangelow=0,repeatingrange=0;
            var datapro1 = new Array(2);
            var datapro2 = new Array(2);
            var platform='';  
            var index = 0;
            var lineItem0 = 0;
            var lineItem1 = 0;
            var lineItem2 = 0;
            var lineItem5 = 0;   
            var Qty = 0;
            var EnableSalesPromotion=0;
            var returnpromovalue=0;
            var isOnQuantity=0;
            var key;
            var transactiontypecode=17;
            var freepromoflag=0;
            var totrpromo=0;
            var isLock='0';
            //  Flag to restrict prommotion invoice
            var lockFlag='1';
            var AvailableQtyArray=[];
            var NoPrev = true,ActiveIndex = 0;
			var freepromotionGR=false;
            window.lang = new jquery_lang_js();
            $("#tblLineContent").click(function() { });
            $("#tblContent").click(function() { });
            
            resizeOrientationWindow();
            $(document).ready(function() {
            resizeWindow();
            EnableSalesPromotion = localStorage.getItem("enablesalespromotion");
            $(".leftfooter").html(getCurrentDate());
            sessionStorage.setItem("invoiceamount", '0');
            document.addEventListener("deviceready", getPromotionList, false); 

            // sujee added side bar ----------------- START ------------------------ 

         	          	          var pushbar = new Pushbar({
         	      		blur:true,
         	      		overlay:true,
         	      	});
         	          $("#txtroute").text("ROUTE #: " + sessionStorage.getItem("RouteCode")); 
         	          window.setInterval(function(){
         	       		var randomColor = '#'+ ('000000' + Math.floor(Math.random()*16777215).toString(16)).slice(-6);
         	       		$('#txtroute').css({
         	         			'color' : randomColor,
         	       		});
         	     			}, 2000);
         	          //----------------------------- END -------------------------  
            $("#txFreeQty").ForceNumericOnly();
            var lan = sessionStorage.getItem("Language");
            window.lang.run(lan);
                          
	        $("#tblLineContent tr").live('click', function() {
                   $(this).toggleClass('clicked');
                   $(this).siblings().removeClass('clicked');                                                       
	        });
                          
            $("#tblContent tr").live('click', function() {
                   $(this).toggleClass('clicked');
                   $(this).siblings().removeClass('clicked');
                   index = $(this).index();
             });
             $("#imgNext").click(function() 
             {   
                             if(promotionTypeCode==7)
                             {
                            	 
                            	 	if(isOnQuantity==0){
                            	 		var Qry="select ifnull(sum(promofreeqty),0) as tot,ifnull(sum(Availability),0) as availflag from promotionfreetemp where promotionplannumber=" + $('#txtPromoKey1').val() + " and routekey=" + sessionStorage.getItem('RouteKey') + " and visitkey=" + sessionStorage.getItem('VisitKey') + "";
                            	 	}else{
                            	 		var Qry="select ifnull(sum(promofreeqty*salesprice),0) as tot,ifnull(sum(Availability),0) as availflag from promotionfreetemp pm INNER JOIN itemmaster im on pm.itemcode=im.actualitemcode where promotionplannumber=" + $('#txtPromoKey1').val() + " and routekey=" + sessionStorage.getItem('RouteKey') + " and visitkey=" + sessionStorage.getItem('VisitKey') + "";
                            	 	}
                                      
                                       window.plugins.DataBaseHelper.select(Qry, function(result) {
                                           if(result.array != undefined)
                                               {
                                                   var result = $.map(result.array, function (item, index) 
                                                   {               
                                                       return [[item.tot,item.availflag]];                                
                                                   });
                                         var dataf=result;
                                         // Added by bindal on 25 Aug 2014
                                         
                                         if(isOnQuantity==1?(eval(dataf[0][0])> eval($('#txFreeQty').val())):(eval(dataf[0][0])!= eval($('#txFreeQty').val())))
              	                         {
                                        	
                                        	 if(lockFlag=='1')
                                             {
                                        		 
                                        		 if(eval(dataf[0][1])==0 && isLock=='1')
                                        	     {
                                        			 getLangText("Cant Continue");
                                            		 return false; 
                                        			 
                                        	     }else
                                        	     {
                                        	    	 
                                        	    	 getLangText("Given Qty Not Match With Allowed Free Qty");
         		                                     return false;
                                        	    	 
                                        	     }	 
                                        		
                                        		 
                                             }else if(eval(dataf[0][1])==1 && lockFlag=='0')
                                        	 {
                                            	// alert("in else");
                                            	 if (!NoNext) {
		                                    		 ActiveIndex += 1;   
		                                           $("#divPromoKey").html(data[ActiveIndex][0]);
		                                           $("#divPromoDesc").html(data[ActiveIndex][1]);
	
	                                            planNumber = data[ActiveIndex][0];
	                                            assignmentgroup = data[ActiveIndex][5]; 
	                                            getPomotionTypeCode(0);
	                                           }
	                                          
	                                           if (ActiveIndex >= (data.length - 1)) {
	                                             $("#imgNext").attr("src", "../images/left-gray.png");
	                                             NoNext = true;
	                                             
	                                             if(data.length == 2)
	                                             {
	                                                 NoPrev = false;
	                                                 $("#imgPrev").attr("src", "../images/right.png");
	                                             }
	                                              
	                                           }
	                                           else {
	                                             NoNext = false;
	                                             NoPrev = false;
	                                             $("#imgPrev").attr("src", "../images/right.png");
	                                           }
                                            	 
                                            	 
                                            	 
                                        	 }else
                                        	 {
                                        		 getLangText("Given Qty Not Match With Allowed Free Qty");
     		                                     return false;
                                        	 }
                                        	 
		                                   
	                                     }	
                                         else
                                         {
                                        	 
                                        	 // alert("in outer else");
                                         
			                                    	 if (!NoNext) {
			                                    		 ActiveIndex += 1;   
			                                           $("#divPromoKey").html(data[ActiveIndex][0]);
			                                           $("#divPromoDesc").html(data[ActiveIndex][1]);
		
		                                            planNumber = data[ActiveIndex][0];
		                                            assignmentgroup = data[ActiveIndex][5]; 
		                                            getPomotionTypeCode(0);
		                                           }
		                                          
		                                           if (ActiveIndex >= (data.length - 1)) {
		                                             $("#imgNext").attr("src", "../images/left-gray.png");
		                                             NoNext = true;
		                                             
		                                             if(data.length == 2)
		                                             {
		                                                 NoPrev = false;
		                                                 $("#imgPrev").attr("src", "../images/right.png");
		                                             }
		                                              
		                                           }
		                                           else {
		                                             NoNext = false;
		                                             NoPrev = false;
		                                             $("#imgPrev").attr("src", "../images/right.png");
		                                           }
                                         }
                                                                   
                                  }
                                        
                              },
                              function() {
                                  console.warn("Error calling plugin");
                              });
                                  }else
                                      {
                                      if (!NoNext) {
                                          ActiveIndex += 1;   
                                        $("#divPromoKey").html(data[ActiveIndex][0]);
                                        $("#divPromoDesc").html(data[ActiveIndex][1]);

                                         planNumber = data[ActiveIndex][0];
                                         assignmentgroup = data[ActiveIndex][5]; 
                                        
                                         getPomotionTypeCode(0);
                                        }
                                       
                                        if (ActiveIndex >= (data.length - 1)) {
                                            
                                          $("#imgNext").attr("src", "../images/left-gray.png");
                                          NoNext = true;
                                          
                                          if(data.length == 2)
                                          {
                                              
                                              NoPrev = false;
                                              $("#imgPrev").attr("src", "../images/right.png");
                                          }
                                           
                                        }
                                        else {
                                          NoNext = false;
                                          NoPrev = false;
                                          $("#imgPrev").attr("src", "../images/right.png");
                                        }
                                      }
                            
                              
                                              });
                          
                          $("#imgPrev").click(function() {
                             
                              if(promotionTypeCode==7)
                              {
                            	if(isOnQuantity==0){
                                  var Qry="select ifnull(sum(promofreeqty),0) as tot,ifnull(sum(Availability),0) as availflag from promotionfreetemp where promotionplannumber=" + $('#txtPromoKey1').val() + " and routekey=" + sessionStorage.getItem('RouteKey') + " and visitkey=" + sessionStorage.getItem('VisitKey') + "";
                            	}else{
                            	  var Qry="select ifnull(sum(promofreeqty*salesprice),0) as tot,ifnull(sum(Availability),0) as availflag from promotionfreetemp  pm INNER JOIN itemmaster im on pm.itemcode=im.actualitemcode where promotionplannumber=" + $('#txtPromoKey1').val() + " and routekey=" + sessionStorage.getItem('RouteKey') + " and visitkey=" + sessionStorage.getItem('VisitKey') + "";	
                            		
                            	}
                                   window.plugins.DataBaseHelper.select(Qry, function(result) {
                                       if(result.array != undefined)
                                           {
                                               var result = $.map(result.array, function (item, index) 
                                                       {               
                                                   return [[item.tot,item.availflag]];                                
                                                       });
                                               var dataf=result;
                                     // Added by bindal on 25 Aug 2014
                                               
                                      if(isOnQuantity==1?(eval(dataf[0][0])> eval($('#txFreeQty').val())):(eval(dataf[0][0])!= eval($('#txFreeQty').val())))
                    	              {
	                                	 
	                                	 if(lockFlag=='1')
                                         {
	                                		 if(eval(dataf[0][1])==0 && isLock=='1')
                                    	     {
	                                			 getLangText("Cant Continue");
                                        		 return false; 
                                    			 
                                    	     }else
                                    	     {
                                    	    	 getLangText("Given Qty Not Match With Allowed Free Qty");
     		                                     return false;
                                    	    	 
                                    	     }	
                                    		 
                                         }else if(eval(dataf[0][1])==1 && lockFlag=='0')
                                    	 {
                                        	
                                        	 if(eval(dataf[0][1])==1 && lockFlag=='1')
                                             {
                                        		 getLangText("Cant Continue");
                                        		  return false;
                                        		 
                                             }
                                         
    	                                	 if (!NoPrev) {
    		                                         if(data[ActiveIndex][4] == 7)
    		                                         {
    		                                        	 var flagtype = 2;
    		                                         }
    		                                         else{
    		                                        	 var flagtype = 1;
    		                                         }
                                               ActiveIndex -= 1;   
                                             $("#divPromoKey").html(data[ActiveIndex][0]);
                                             $("#divPromoDesc").html(data[ActiveIndex][1]);

                                              planNumber = data[ActiveIndex][0];
                                              assignmentgroup = data[ActiveIndex][5];  
                                             
                                              getPomotionTypeCode(flagtype);
                                             }
                                             if (ActiveIndex <= 0) {
                                                 
                                               $("#imgPrev").attr("src", "../images/right-gray.png");
                                               NoPrev = true;
                                             
                                               if(data.length == 2)
                                               {
                                                   
                                                   NoNext = false;
                                                   $("#imgNext").attr("src", "../images/left.png");
                                               }
                                             }
                                             else {
                                                
                                               NoPrev = false;
                                               NoNext = false;
                                               $("#imgNext").attr("src", "../images/left.png");
                                             }
                                        	 
                                        	 
                                    	 }else
                                    	 {
                                    		 getLangText("Given Qty Not Match With Allowed Free Qty");
      		                                 return false;
                                    	 }
	                                	 
	                                	 
	                                	 
	                                	 
	                                	 
	                                	 
		                              
	                                 }	
	                                 else
                                     {
	                                	 
	                                	
                                     
	                                	 if (!NoPrev) {
		                                         if(data[ActiveIndex][4] == 7)
		                                         {
		                                        	 var flagtype = 2;
		                                         }
		                                         else{
		                                        	 var flagtype = 1;
		                                         }
                                           ActiveIndex -= 1;   
                                         $("#divPromoKey").html(data[ActiveIndex][0]);
                                         $("#divPromoDesc").html(data[ActiveIndex][1]);

                                          planNumber = data[ActiveIndex][0];
                                          assignmentgroup = data[ActiveIndex][5];  
                                         
                                          getPomotionTypeCode(flagtype);
                                         }
                                         if (ActiveIndex <= 0) {
                                             
                                           $("#imgPrev").attr("src", "../images/right-gray.png");
                                           NoPrev = true;
                                         
                                           if(data.length == 2)
                                           {
                                               
                                               NoNext = false;
                                               $("#imgNext").attr("src", "../images/left.png");
                                           }
                                         }
                                         else {
                                            
                                           NoPrev = false;
                                           NoNext = false;
                                           $("#imgNext").attr("src", "../images/left.png");
                                         }
                                     }
                                                               
                              }
                                    
                          },
                          function() {
                              console.warn("Error calling plugin");
                          });
                              }else {
                                  if (!NoPrev) {
                                     
                                      if(data[ActiveIndex][4] == 7)
                                      {
                                      var flagtype = 2;
                                      }
                                      else{
                                      var flagtype = 1;
                                      }
                                        ActiveIndex -= 1;   
                                      $("#divPromoKey").html(data[ActiveIndex][0]);
                                      $("#divPromoDesc").html(data[ActiveIndex][1]);

                                       planNumber = data[ActiveIndex][0];
                                       assignmentgroup = data[ActiveIndex][5];  
                                      
                                       getPomotionTypeCode(flagtype);
                                      }
                                    
                                      if (ActiveIndex <= 0) {
                                        
                                        $("#imgPrev").attr("src", "../images/right-gray.png");
                                        NoPrev = true;
                                      
                                        if(data.length == 2)
                                        {
                                            NoNext = false;
                                            $("#imgNext").attr("src", "../images/left.png");
                                        }
                                      }
                                      else {
                                        NoPrev = false;
                                        NoNext = false;
                                        $("#imgNext").attr("src", "../images/left.png");
                                      }
                              }
                              // ------------------------
                                              
                                              });       
                          
		// -----------------------------End----------
                if (sessionStorage.getItem("Language")  != "en") {
               
                window.lang.change('Promoreview'+lan,lan);
                window.lang.change('Footer'+lan,lan);
		if(lan=="AR")
                {
                    $('#Back_inner').removeClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
		    $('#Back_inner').addClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
		    $('#lang_inner').removeClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
		    $('#lang_inner').addClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
		}
		
		}
		else
		{
		    window.lang.change('en','en');
		    
		    $('#Back_inner').removeClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
		    $('#Back_inner').addClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
		    $('#lang_inner').removeClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
		    $('#lang_inner').addClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
		}
        });
            
            // Function for bind item list
            function getPromotionList()
            {      
            	// Added by bindal on 25 Aug 2014
            	
            	getLockSettings();
            	
            	
                platform= sessionStorage.getItem("platform");               
               
                var qry ="SELECT distinct promokeydetail.plannumber,Case When '" + sessionStorage.getItem('Language') + "' = 'en' Then promoplanheader.plandescription Else promoplanheader.arbplandescription End As plandesc,0,promokeydetail.plannumber,promokeydetail.promotiontypecode,promokeydetail.assignmentgroup,0 as isOnQuantity FROM promokeydetail inner join customermaster on promokeydetail.promotionkey = customermaster.promotionkey inner join promoplanheader on promokeydetail.plannumber = promoplanheader.plannumber inner join promotiondetail on promokeydetail.plannumber = promotiondetail.promotionplannumber and promotiondetail.routekey = " + sessionStorage.getItem('RouteKey') + " and promotiondetail.visitkey = " + sessionStorage.getItem('VisitKey') + " where customermaster.customercode = " + sessionStorage.getItem('customerid') + " order by promokeydetail.promotiontypecode,promokeydetail.plannumber";
                
                console.log(qry);
                if(platform=='iPad')
           		{
                Cordova.exec(function(result) {
                                if(result.length > 0 )
                                {
                                    data = result;                              
                                                                                                                       
                                    $("#divPromoKey").html(data[0][0]);
                                    $("#divPromoDesc").html(data[0][1]);                              
                                   
                                    $("#imgPrev").attr("src", "../images/right-gray.png");
                                    
                                    if(data.length == 1)
                                    {
                                        $("#imgNext").attr("src", "../images/left-gray.png");
                                         NoNext = true;
                                    }

                                    planNumber = data[0][0];
                                    assignmentgroup = data[0][5];                                     
                                    getPomotionTypeCode(0);
                                    
                                }
                                else
                                {
                                    // navigator.notification.alert("No record
									// found for selected promotion");
                              
                                    NoNext = true;
                                    $("#imgPrev").attr("src", "../images/right-gray.png");
                                    $("#imgNext").attr("src", "../images/left-gray.png");
                                }
                              },
                              function(error) {
                                navigator.notification.alert("Error in binding promotion detail : " + error);
                              },
                              "PluginClass", 
                              "GetdataMethod",
                             [qry]);         
               
             }
            else if(platform=='Android')
            {
                window.plugins.DataBaseHelper.select(qry, function(result)
				{
						if(result.array!=undefined)
                        {                        
                        	
                        	
                        	var result = $.map(result.array, function (item, index) {               
                			return [[item.plannumber, item.plandesc,item.routekey,item.plannumber,item.promotiontypecode,item.assignmentgroup]];
            				});    
                                                     
                            data = result;
                                 
                            $("#divPromoKey").html(data[0][0]);
                            $("#divPromoDesc").html(data[0][1]);                              
                                   
                            $("#imgPrev").attr("src", "../images/right-gray.png");
                                    
                            if(data.length == 1)
                            {
                            	$("#imgNext").attr("src", "../images/left-gray.png");
                                NoNext = true;
                             }

                                planNumber = data[0][0];
                                assignmentgroup = data[0][5]; 
                                getPomotionTypeCode(0);			 		
				 		} 
				 		else
                        {
                               // navigator.notification.alert("No record found
								// for selected promotion");
                              
                               NoNext = true;
                               $("#imgPrev").attr("src", "../images/right-gray.png");
                               $("#imgNext").attr("src", "../images/left-gray.png");
                        }            
                                        
				},
				function()
				{
			   	 console.warn("Error calling plugin");
				});
            } 
            }
            
            function getPomotionTypeCode(flag) {
            	 isLock='0';
                selectbatchdata();
                sessionStorage.setItem("plannumber", planNumber);
                console.log("select promotiondetail.promotiontypecode,promokeydetail.rangebasis,promotiondetail.promotionquantity,promotiondetail.promotionamount,promotiondetail.rangelow,promotiondetail.repeatingrange From promotiondetail inner join promokeydetail on promotiondetail.promotionplannumber = promokeydetail.plannumber and promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") where promotionplannumber = " + planNumber + " and routekey = " + sessionStorage.getItem('RouteKey') + " and visitkey = " + sessionStorage.getItem('VisitKey') + "");
            	if(platform=='iPad')
           		{
                Cordova.exec(function(result) {
                              if(result.length > 0 )
                              {
                                    if(result[0][0] == 0)
                                       promotionTypeCode = 0;
                                    else 
                                        promotionTypeCode = eval(result[0][0]);

                                    rangeBasis = eval(result[0][1]);
                              rangelow = eval(result[0][4]);
                              repeatingrange = eval(result[0][5]);
                                    if (promotionTypeCode == 7) 
                                    {
                              freepromoflag=1;         
                              // $('#imgAdd').css({ "display": "block" });
                              var promovalues=0;
                              var returnpromovalues=0;
                              if(result[0][1]==3 || result[0][1]==4)
                              {
                                for(i=0;i<result.length;i++)
                                {
                                    if(eval(result[i][6])==1)      
                                        promovalues +=eval(result[i][2]);
                                    else
                                        returnpromovalues +=eval(result[i][2]);
                                   
                                }
                              }
                              else if(result[0][5]==1)
                              {
                                for(i=0;i<result.length;i++)
                                {
                                    if(eval(result[i][6])==1)      
                                        promovalues =eval(result[i][2]);
                                    else
                                        returnpromovalues =eval(result[i][2]);
                              console.log(promovalues);
                                }
                              }
                              else
                              {
                              for(i=0;i<result.length;i++)
                              {
                              if(eval(result[i][6])==1)  
                              promovalues = result[i][2];
                              else
                              returnpromovalues =eval(result[i][2]);
                              }
                              }
                                        sessionStorage.setItem("promovalue", promovalues);
                              sessionStorage.setItem("returnpromovalue", returnpromovalues);
                              $('#txtPromoKey1').val($("#divPromoKey").html());
                              $('#txtDescription1').val($("#divPromoDesc").html()); 
                                        $('#divLineItem').css({ "display": "none" });
                                        $('#divTotalInvoice').css({ "display": "none" });                              
                                        $('#divFreeSample').css({ "display": "block" });
                              if(eval(result[0][7])==-1)
                              {
                              $('#addfreegrid').css({ "display": "block" });
                              getItemList();
                              }
                                        getFreeSampleList(flag);                                        
                                    }                                   
                                    else if(promotionTypeCode == 1 || promotionTypeCode == 2 || promotionTypeCode == 0 )
                                    {                                        
                                         sessionStorage.setItem("promovalue", result[0][3]);
                              
                                         $('#txtPromoKey').val($("#divPromoKey").html());
                                         $('#txtDescription').val($("#divPromoDesc").html());                              
                              
                                         $('#divTotalInvoice').css({ "display": "none" });                              
                                         $('#divFreeSample').css({ "display": "none" });   
                                         $('#divLineItem').css({ "display": "block" });
                              
                                         getLineItemDetail(flag);
                                    }
                                    else if(promotionTypeCode == 5 || promotionTypeCode == 6)
                                    {
                                         sessionStorage.setItem("promovalue", result[0][3]);
                              
                                         $('#divFreeSample').css({ "display": "none" });   
                                         $('#divLineItem').css({ "display": "none" });
                                         $('#divTotalInvoice').css({ "display": "block" });
                              
                                         getAmount(flag);     
                                    }                  
                                                                
                              }
                              else 
                              {
                                    promotionTypeCode = -1; 
                                    rangeBasis = 0;
                              }
                              
                              },
                              function(error) {
                                navigator.notification.alert("Error in binding promotion type code : " + error);
                              },
                              "PluginClass", 
                              "GetdataMethod",
                              ["select promotiondetail.promotiontypecode,promokeydetail.rangebasis,promotiondetail.promotionquantity,promotiondetail.promotionamount,promotiondetail.rangelow,promotiondetail.repeatingrange,promotiondetail.itemtransactiontype,promotiondetail.itemcode From promotiondetail inner join promokeydetail on promotiondetail.promotionplannumber = promokeydetail.plannumber and promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") where promotionplannumber = " + planNumber + " and routekey = " + sessionStorage.getItem('RouteKey') + " and visitkey = " + sessionStorage.getItem('VisitKey') + ""]); 
            	}
            	else if(platform=='Android')
            	{
            	    window.plugins.DataBaseHelper.select("select promotiondetail.promotiontypecode,promokeydetail.rangebasis,promotiondetail.promotionquantity,promotiondetail.promotionamount,promotiondetail.rangelow,promotiondetail.repeatingrange,promotiondetail.itemtransactiontype,promotiondetail.itemcode,0 as isOnQuantity From promotiondetail inner join promokeydetail on promotiondetail.promotionplannumber = promokeydetail.plannumber and promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") where promotionplannumber = " + planNumber + " and routekey = " + sessionStorage.getItem('RouteKey') + " and visitkey = " + sessionStorage.getItem('VisitKey') + "", function(result)
					{
						var array = $.map(result.array, function (item, index) {               
                		return [[item.promotiontypecode, item.rangebasis,item.promotionquantity,item.promotionamount,item.rangelow,item.repeatingrange,item.itemtransactiontype,item.itemcode,item.isOnQuantity]];
            			});
            			
            			result = array;
	            		if(result.length > 0 )
                        {
                                    if(result[0][0] == 0){
                                    	 promotionTypeCode = 0;
                                    }
                                    else{
                                    	 promotionTypeCode = eval(result[0][0]);
                                    }
                                       

                                    rangeBasis = eval(result[0][1]);
                                    rangelow = eval(result[0][4]);
                                    repeatingrange = eval(result[0][5]);
                                    if (promotionTypeCode == 7) 
                                    {
                                    	isOnQuantity=eval(result[0][8]);
                                    	freepromoflag=1;         
                                    	// $('#imgAdd').css({ "display": "block" });
                                    	var promovalues=0;
                                    	var returnpromovalues=0;
                                    	if(result[0][1]==3 || result[0][1]==4)
                                    	{
                                    		for(i=0;i<result.length;i++)
                                    		{
                                    			if(eval(result[i][6])==1)      
                                    				promovalues +=eval(result[i][2]);
                                    			else
                                    				returnpromovalues +=eval(result[i][2]);
                                   
                                    		}
                                    	}
                                    	else if(result[0][5]==1)
                                    	{
                                    		for(i=0;i<result.length;i++)
                                    		{
                                    			if(eval(result[i][6])==1)      
                                    				promovalues =eval(result[i][2]);
                                    			else
                                    				returnpromovalues =eval(result[i][2]);
                                    			console.log(promovalues);
                                    		}
                                    	}
                                    	else
                                    	{
                                    		if(eval(result[0][6])==1)  
                                    			promovalues = result[0][2];
                                    		else
                                    			returnpromovalues =eval(result[0][2]);
                                    	}
                                        sessionStorage.setItem("promovalue", promovalues);
                                        sessionStorage.setItem("returnpromovalue", returnpromovalues);
                                        $('#txtPromoKey1').val($("#divPromoKey").html());
                                        $('#txtDescription1').val($("#divPromoDesc").html()); 
                                        $('#divLineItem').css({ "display": "none" });
                                        $('#divTotalInvoice').css({ "display": "none" });                              
                                        $('#divFreeSample').css({ "display": "block" });
		                               if(eval(result[0][7])==-1)
		                               {
		                            	   $('#addfreegrid').css({ "display": "block" });
		                            	   getItemList();
		                               }
                                        getFreeSampleList(flag);                                        
                                    }                                   
                                    else if(promotionTypeCode == 1 || promotionTypeCode == 2 || promotionTypeCode == 0 )
                                    {                                        
                                         sessionStorage.setItem("promovalue", result[0][3]);
                              
                                         $('#txtPromoKey').val($("#divPromoKey").html());
                                         $('#txtDescription').val($("#divPromoDesc").html());                              
                              
                                         $('#divTotalInvoice').css({ "display": "none" });                              
                                         $('#divFreeSample').css({ "display": "none" });   
                                         $('#divLineItem').css({ "display": "block" });
                              
                                         getLineItemDetail(flag);
                                    }
                                    else if(promotionTypeCode == 5 || promotionTypeCode == 6)
                                    {
                                         sessionStorage.setItem("promovalue", result[0][3]);
                              
                                         $('#divFreeSample').css({ "display": "none" });   
                                         $('#divLineItem').css({ "display": "none" });
                                         $('#divTotalInvoice').css({ "display": "block" });
                              
                                         getAmount(flag);     
                                    }                  
                                                                
                              }
                              else 
                              {
                                    promotionTypeCode = -1; 
                                    rangeBasis = 0;
                              }
                    },
                    function()
					{
			   	 		console.warn("Error calling plugin");
					});
            	}
            }
            
            // Function for getting promotion amount for passed plan number
            function getAmount(flag)
            {
                var Qry = '';               
                if(EnableSalesPromotion == 1)
                {
                    var totalfield = "invoiceheader.totalsalesamount";
                    var totalfield1 = "invoiceheader.totalsalesamount";
                }
                else if(EnableSalesPromotion == 2)
                {
                    var totalfield = "(invoiceheader.totalreturnamount)";
                    var totalfield1 = "(invoiceheader.totalreturnamount)";
                }
                else if(EnableSalesPromotion == 3)
                {
                	// orq line sujee commented 17/03/2020
                 //  var totalfield = "(invoiceheader.totalsalesamount - invoiceheader.totalreturnamount-ifnull(invoiceheader.totaldamagedamount,0))";
                  //  var totalfield1 = "CASE WHEN itemtransactiontype = 1 THEN invoiceheader.totalsalesamount ELSE ifnull(invoiceheader.totalreturnamount,0)+ifnull(invoiceheader.totaldamagedamount,0) END";
                    
                    var totalfield = "(invoiceheader.totalsalesamount - invoiceheader.totalreturnamount-ifnull(invoiceheader.totaldamagedamount,0)-ifnull(invoiceheader.totalexpiryamount,0))";
                    var totalfield1 = "CASE WHEN itemtransactiontype = 1 THEN invoiceheader.totalsalesamount ELSE ifnull(invoiceheader.totalreturnamount,0)+ifnull(invoiceheader.totaldamagedamount,0) +ifnull(invoiceheader.totalexpiryamount,0) END";
                }

                
                if(promotionTypeCode != 7)
                {
                    if(promotionTypeCode == 5)
                    {
                       
                         Qry = "select ("+totalfield+") as CurrentInvoiceAmount  , ("+totalfield1+" - promotiondetail.promotionamount) as NewInvoiceAmount,promotiondetail.promotionamount,promotiondetail.salesamount,itemtransactiontype from promotiondetail join invoiceheader on invoiceheader.visitkey = promotiondetail.visitkey and invoiceheader.routekey=promotiondetail.routekey  where promotiondetail.promotionplannumber = "+ planNumber +" and promotiondetail.routekey = "+ sessionStorage.getItem('RouteKey') +" and promotiondetail.visitkey = "+ sessionStorage.getItem('VisitKey') +"";
                    }
                    else if(promotionTypeCode == 6)
                    {
                        
                        if(repeatingrange ==1)
                        {
                            getAmountrepeate(flag,totalfield,totalfield1);
                        }
                        else 
                        {
                        Qry = "select ("+totalfield+") as CurrentInvoiceAmount  , (("+totalfield1+") - ("+totalfield1+") * (promotiondetail.promotionamount/100.0)) as NewInvoiceAmount,((promotiondetail.promotionamount)/100.0) as promotionamount,promotiondetail.oldpromotionamount as salesamount,itemtransactiontype from promotiondetail join invoiceheader on invoiceheader.visitkey = promotiondetail.visitkey and invoiceheader.routekey=promotiondetail.routekey  where promotiondetail.promotionplannumber = "+ planNumber +" and promotiondetail.routekey = "+ sessionStorage.getItem('RouteKey') +" and promotiondetail.visitkey = "+ sessionStorage.getItem('VisitKey') +"";
                        }
                    }
                   
                    console.log(Qry);
                }
                
                if(platform=='iPad')
           		{
                Cordova.exec(function(result) {
                              if(result.length > 0 )
                              {
                                  dataAmount = result;                         
                              bindinvoice(dataAmount,flag);
                              }
                              },
                              function(error) {
                                    navigator.notification.alert("Error in binding promotion amount : " + error);
                              },
                              "PluginClass", 
                              "GetdataMethod", 
                              [Qry]);        
            	}
            	else if(platform=='Android')
            	{
            		window.plugins.DataBaseHelper.select(Qry,function(result)
					{
            			if(result.array!=undefined)
                    	{
                    		dataAmount = result;
                    		var array = $.map(dataAmount.array, function (item, index) {               
                			return [[item.CurrentInvoiceAmount, item.NewInvoiceAmount,item.promotionamount,item.salesamount,item.itemtransactiontype]];
            				});

            				dataAmount = array;
							bindinvoice(dataAmount,flag);
                        }                         
                    },
                    function()
					{
			   	 		console.warn("Error calling plugin");
					});
            	}
            }
            
            
            
            function bindinvoice(dataAmount,flag)
            {
                var finalpromo =0;
                var salespromoamount=0;
                var returnpromoamount=0;
                var salesactual=0;
                var returnactual=0;
                var salesqualify=0;
                var returnqualify=0;
                console.log("aaa");
                if (promotionTypeCode == 5) 
                {
                    
                    
                    if(flag==0)
                    {
                        if(sessionStorage.getItem("invoiceamount")==0)
                        {
                            dataAmount[0][0] = eval(dataAmount[0][0]);
                        }
                        else
                        {
                            dataAmount[0][0] = sessionStorage.getItem("invoiceamount");
                        }
                        // check sales promotion and return promotion
                        if(eval(dataAmount[0][4]) == 1) 
                        {
                            dataAmount[0][1] = eval(dataAmount[0][0]) - eval(dataAmount[0][2]);
                            var salespromoamount = eval(dataAmount[0][2]);
                        }
                        else
                        {
                            dataAmount[0][1] = eval(dataAmount[0][0]) + eval(dataAmount[0][2]);
                            var returnpromoamount = eval(dataAmount[0][2]);
                        }
                        // check more than 1 row
                        if((dataAmount.length) > 1)
                        {
                            if(eval(dataAmount[1][4]) == 1) 
                            {
                            dataAmount[1][1] = eval(dataAmount[0][0]) - eval(dataAmount[1][2]);
                                var salespromoamount = eval(dataAmount[1][2]);    
                            }
                            else
                            {
                            dataAmount[1][1] = eval(dataAmount[0][0]) + eval(dataAmount[1][2]);
                            var returnpromoamount = eval(dataAmount[1][2]);
                            }

                        }
                        else
                        {
                            var finalpromo =eval(dataAmount[0][1]);
                        }
                    }
                    else if(flag==1)
                    {
                        if(eval(dataAmount[0][4]) == 1) 
                        {
                        dataAmount[0][0] =eval(sessionStorage.getItem("currentinvoice")) + eval(dataAmount[0][2]);
                        }
                        else
                        {
                        dataAmount[0][0] =eval(sessionStorage.getItem("currentinvoice")) - eval(dataAmount[0][2]);
                        }
                        
                        // minus sales and return both promoamount if 2 rows are
						// there
                        if((dataAmount.length) > 1)
                        {
                           if(eval(dataAmount[1][4]) == 1) 
                            dataAmount[0][0] =eval(sessionStorage.getItem("currentinvoice")) + eval(dataAmount[0][2]) - eval(dataAmount[1][2]) ;
                            else
                            dataAmount[0][0] =eval(sessionStorage.getItem("currentinvoice")) - eval(dataAmount[0][2]) +eval(dataAmount[1][2]);
                        }
                        dataAmount[0][1] = eval(sessionStorage.getItem("currentinvoice"));
                    }
                    else if(flag==2)
                    {
                        dataAmount[0][0] =eval(sessionStorage.getItem("currentinvoice"));
                        dataAmount[0][1] = eval(sessionStorage.getItem("invoiceamount"));
                    }
                    var promoactual = eval(dataAmount[0][2]);
                    sessionStorage.setItem("invoiceamount", dataAmount[0][1]);
                    sessionStorage.setItem("currentinvoice", dataAmount[0][0]);
                    if(eval(dataAmount[0][4]) == 1) 
                    {
                         var salespromoamount = eval(dataAmount[0][2]);
                    }
                    else
                    {
                        var returnpromoamount = eval(dataAmount[0][2]);
                    }
                    // check more than 1 row
                    if((dataAmount.length) > 1)
                    {
                        if(eval(dataAmount[1][4]) == 1) 
                        {                            
                            var salespromoamount = eval(dataAmount[1][2]);    
                        }
                        else
                        {                            
                            var returnpromoamount = eval(dataAmount[1][2]);
                        }
                        
                    }
                }
            
                if (promotionTypeCode == 6) {                    
                    
                    
                    
                    if(flag==0)
                    {
                        if(sessionStorage.getItem("invoiceamount")==0)
                        {
                            dataAmount[0][0] = eval(dataAmount[0][0]);
                        }
                        else
                        {
                            dataAmount[0][0] = sessionStorage.getItem("invoiceamount");
                        }
                        // dataAmount[0][1] = eval(dataAmount[0][0]) -
						// eval(dataAmount[0][2]);
                        if(eval(dataAmount[0][4]) == 1) 
                        dataAmount[0][1] = eval(dataAmount[0][0]) - (eval(dataAmount[0][3]) * eval(dataAmount[0][2]));
                        else
                         dataAmount[0][1] = eval(dataAmount[0][0]) + (eval(dataAmount[0][3]) * eval(dataAmount[0][2]));
                        
                        if((dataAmount.length) > 1)
                        {
                            if(eval(dataAmount[1][4]) == 1) 
                            {
                            dataAmount[1][1] = eval(dataAmount[1][0]) - (eval(dataAmount[1][3]) * eval(dataAmount[1][2]));
                            var finalpromo=eval(dataAmount[1][1]) - eval(dataAmount[0][1]);
                            }
                            else
                            {
                            dataAmount[1][1] = eval(dataAmount[1][0]) + (eval(dataAmount[1][3]) * eval(dataAmount[1][2]));
                                var finalpromo=eval(dataAmount[0][1]) - eval(dataAmount[1][1]);
                            }
                        }
                        else
                        {
                            var finalpromo =eval(dataAmount[0][1]) ;
                        }
                       
                        console.log(eval(dataAmount[0][1]));
                    }
                    else if(flag==1)
                    {
                        if(eval(dataAmount[0][4]) == 1)
                        dataAmount[0][0] =eval(sessionStorage.getItem("currentinvoice")) +(eval(dataAmount[0][3]) * eval(dataAmount[0][2]));
                        else
                         dataAmount[0][0] =eval(sessionStorage.getItem("currentinvoice")) -(eval(dataAmount[0][3]) * eval(dataAmount[0][2]));
                        
                        if((dataAmount.length) > 1)
                        {
                            if(eval(dataAmount[1][4]) == 1)
                            dataAmount[0][0] =eval(sessionStorage.getItem("currentinvoice")) +(eval(dataAmount[0][3]) * eval(dataAmount[0][2])) - (eval(dataAmount[1][3]) * eval(dataAmount[1][2]));
                            else
                            dataAmount[0][0] =eval(sessionStorage.getItem("currentinvoice")) -(eval(dataAmount[0][3]) * eval(dataAmount[0][2])) + (eval(dataAmount[1][3]) * eval(dataAmount[1][2]));
                        }
                        
                        dataAmount[0][1] = eval(sessionStorage.getItem("currentinvoice"));
                    }
                    else if(flag==2)
                    {
                        dataAmount[0][0] =eval(sessionStorage.getItem("currentinvoice"));
                        dataAmount[0][1] = eval(sessionStorage.getItem("invoiceamount"));
                    }
                    if(eval(dataAmount[0][4]) == 1)
                    {
                        var salesactual = eval(dataAmount[0][2]) *100;
                        var salesqualify = eval(dataAmount[0][3]);
                    }
                    else
                    {
                        var returnactual = eval(dataAmount[0][2]) *100;
                        var returnqualify = eval(dataAmount[0][3]);
                    }
                    if((dataAmount.length) > 1)
                    {
                        if(eval(dataAmount[1][4]) == 1)
                        {
                            var salesactual = eval(dataAmount[1][2]) *100;
                            var salesqualify = eval(dataAmount[1][3]);
                        }
                        else
                        {
                            var returnactual = eval(dataAmount[1][2]) *100;
                            var returnqualify = eval(dataAmount[1][3]);
                        }
                    }
                    sessionStorage.setItem("invoiceamount", dataAmount[0][1]);
                    sessionStorage.setItem("currentinvoice", dataAmount[0][0]);
                    if(eval(dataAmount[0][4]) == 1)
                    {
                        var salespromoamount =  (eval(dataAmount[0][3]) * eval(dataAmount[0][2]));                    
                    }
                    else
                    {
                        var returnpromoamount =  (eval(dataAmount[0][3]) * eval(dataAmount[0][2]));
                    }
                    if((dataAmount.length) > 1)
                    {
                        if(eval(dataAmount[1][4]) == 1)
                        {
                            var salespromoamount =(eval(dataAmount[1][3]) * eval(dataAmount[1][2]));                    
                        }
                        else
                        {
                            var returnpromoamount =  (eval(dataAmount[1][3]) * eval(dataAmount[1][2]));
                        }
                    }
                }
                
                
                if(promotionTypeCode == 6)
                {
                    $("#app1").show();
                    $("#app2").show();
                    $("#app3").hide();
                    console.log(salesactual);
                    $("#divPromo").html(eval(salesactual).toFixed(sessionStorage.getItem('decimalplace'))+"%");
                    
                    $("#divPromo1").html(eval(returnactual).toFixed(sessionStorage.getItem('decimalplace'))+"%");
                    $("#divqualifiedAmount").html(eval(salesqualify).toFixed(sessionStorage.getItem('decimalplace')));
                    
                    $("#divqualifiedAmount1").html(eval(returnqualify).toFixed(sessionStorage.getItem('decimalplace')));
                }
                else
                {
                    $("#app1").hide();
                    $("#app2").hide();
                    $("#app3").show();
                    
                }
                $("#divCIAmount").html(eval(dataAmount[0][0]).toFixed(sessionStorage.getItem('decimalplace')));
                
                if(finalpromo == 0)
                {
                    finalpromo = eval(dataAmount[0][1]);
                    sessionStorage.setItem("invoiceamount", dataAmount[0][1]);
                }
               
                
                 finalpromo = dataAmount[0][0] - salespromoamount + returnpromoamount;
                sessionStorage.setItem("invoiceamount", finalpromo);
                $("#divPromotionAmount").html(eval(salespromoamount).toFixed(sessionStorage.getItem('decimalplace')));
                $("#divPromotionAmount1").html(eval(returnpromoamount).toFixed(sessionStorage.getItem('decimalplace')));
                $("#divNIAmount").html(eval(finalpromo).toFixed(sessionStorage.getItem('decimalplace')));
            
            }
            function getAmountrepeate(flag,totalfield,totalfield1)
            {
                
               var selectQry ="select promotiondetail.oldpromotionamount,promotiondetail.promotionamount,itemtransactiontype from promotiondetail where promotiondetail.promotionplannumber = "+ planNumber +" and promotiondetail.routekey = "+ sessionStorage.getItem('RouteKey') +" and promotiondetail.visitkey = "+ sessionStorage.getItem('VisitKey') +"";
                if(platform=='iPad')
           		{
                    Cordova.exec(function(result) {
                                  if(result.length > 0 )
                                  {
                                  
                                  
                                  var oldamount = result[0][0];
                                  var promoamount = result[0][1];
                                  var transtype = result[0][2];
                                                                   
                                  var finalamount = 0;
                                  var totalamount = eval(oldamount);
                                  while( totalamount >= eval(rangelow))
                                  {
                                  finalamount = finalamount + eval(rangelow) * (promoamount/100);
                                  totalamount = totalamount - eval(rangelow);
                                  }
                                    Qry = "select ("+totalfield+") as CurrentInvoiceAmount  , CASE WHEN itemtransactiontype =1 THEN (("+totalfield1+") - "+finalamount+") ELSE (("+totalfield1+") + "+finalamount+") END as NewInvoiceAmount,("+finalamount+") as amount,promotiondetail.oldpromotionamount,itemtransactiontype from promotiondetail join invoiceheader on invoiceheader.visitkey = promotiondetail.visitkey and invoiceheader.routekey=promotiondetail.routekey  where promotiondetail.promotionplannumber = "+ planNumber +" and promotiondetail.routekey = "+ sessionStorage.getItem('RouteKey') +" and promotiondetail.visitkey = "+ sessionStorage.getItem('VisitKey') +"";
                                    Cordova.exec(function(result) {
                                                if(result.length > 0 )
                                                {
                                                dataAmount = result;                         
                                                bindinvoice(dataAmount,flag);
                                                }
                                                },
                                                function(error) {
                                                navigator.notification.alert("Error in binding promotion amount : " + error);
                                                },
                                                "PluginClass", 
                                                "GetdataMethod", 
                                                [Qry]);
                                  }
                                  },
                                  function(error) {
                                  navigator.notification.alert("Error in binding promotion amount : " + error);
                                  },
                                  "PluginClass", 
                                  "GetdataMethod", 
                                  [selectQry]); 
                            
            	}
            	else if(platform=='Android')
            	{
            		window.plugins.DataBaseHelper.select(selectQry,function(result)
                                                         {
                                                         if(result.array!=undefined)
                                                         {
                                                         var oldamount = result.array[0].oldpromotionamount;
                                                         var promoamount = result.array[0].promotionamount;
                                                         
                                                         var finalamount = 0;
                                                         var totalamount = eval(oldamount);
                                                         while( totalamount >= eval(rangelow))
                                                         {
                                                         finalamount = finalamount + eval(rangelow) * (promoamount/100);
                                                         totalamount = totalamount - eval(rangelow);
                                                         }
                                                         Qry = "select ("+totalfield+") as CurrentInvoiceAmount  , (("+totalfield+") - "+finalamount+") as NewInvoiceAmount,("+finalamount+") as amount,promotiondetail.oldpromotionamount from promotiondetail join invoiceheader on invoiceheader.visitkey = promotiondetail.visitkey and invoiceheader.routekey=promotiondetail.routekey  where promotiondetail.promotionplannumber = "+ planNumber +" and promotiondetail.routekey = "+ sessionStorage.getItem('RouteKey') +" and promotiondetail.visitkey = "+ sessionStorage.getItem('VisitKey') +"";
                                                         window.plugins.DataBaseHelper.select(Qry,function(result)
                                                                                              {
                                                                                              if(result.array!=undefined)
                                                                                              {
                                                                                              dataAmount = result;
                                                                                              var array = $.map(dataAmount.array, function (item, index) {               
                                                                                                                return [[item.CurrentInvoiceAmount, item.NewInvoiceAmount,item.amount,item.oldpromotionamount]];
                                                                                                                });
                                                                                              
                                                                                              dataAmount = array;
                                                                                              bindinvoice(dataAmount,flag);
                                                                                              }
                                                                                              },
                                                                                              function()
                                                                                              {
                                                                                              console.warn("Error calling plugin");
                                                                                              });
                                                         }
                                                         },
                                                         function()
                                                         {
                                                         console.warn("Error calling plugin");
                                                         });
                   
            	}
            }
          function getLineItemDetail(flag)
            {
                var lintItemQry = '';
                
                if(EnableSalesPromotion == 1)
                {
                    var totalfield = "CAST(totalsalesamount AS VARCHAR) as amount";
                }
                else if(EnableSalesPromotion == 2)
                {
                    var totalfield = "CAST(totalreturnamount AS VARCHAR) as amount";
                }
                else if(EnableSalesPromotion == 3)
                {
                	// org line sujee commented 
                    //var totalfield = "CAST((totalsalesamount - totalreturnamount-totaldamagedamount) AS VARCHAR) as amount";
                	var totalfield = "CAST((totalsalesamount - totalreturnamount-totaldamagedamount-totalexpiryamount) AS VARCHAR) as amount";
                }
                
                if(promotionTypeCode == 0)
                {
                    
                    
                    lintItemQry = "select CASE WHEN '"+ sessionStorage.getItem('CheckCode') +"' = 'alternatecode' THEN itemmaster.alternatecode ELSE itemmaster.actualitemcode END AS Code,CASE WHEN '"+ sessionStorage.getItem('Language') +"' = 'en' THEN itemmaster.itemdescription ELSE itemmaster.arbitemdescription END As Description,CASE WHEN itemtransactiontype=2 THEN -promotiondetail.oldpromotionamount ELSE promotiondetail.oldpromotionamount END as oldamount,CASE WHEN itemtransactiontype =1 THEN (promotiondetail.oldpromotionamount - ifnull(promotiondetail.promotionamount,0)) ELSE -(promotiondetail.oldpromotionamount - ifnull(promotiondetail.promotionamount,0)) END as newamount,"+totalfield+",itemtransactiontype From promotiondetail inner join promokeydetail on promotiondetail.promotionplannumber = promokeydetail.plannumber and promotionkey = (select promotionkey from customermaster  where customercode = " + sessionStorage.getItem('customerid') + ") inner join invoicedetail on promotiondetail.itemcode = invoicedetail.itemcode and invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey = " + sessionStorage.getItem('VisitKey') + " inner join invoiceheader on invoiceheader.routekey=invoicedetail.routekey and invoiceheader.visitkey=invoicedetail.visitkey inner join itemmaster on promotiondetail.itemcode = itemmaster.actualitemcode where promotiondetail.promotionplannumber = " + planNumber + " and promotiondetail.routekey = " + sessionStorage.getItem('RouteKey') + " and promotiondetail.visitkey = " + sessionStorage.getItem('VisitKey') + ""; 
                    console.log(lintItemQry);
                }
                else if(promotionTypeCode == 1)
                {
                    
                    
                    lintItemQry = "select CASE WHEN '"+ sessionStorage.getItem('CheckCode') +"' = 'alternatecode' THEN itemmaster.alternatecode ELSE itemmaster.actualitemcode END AS Code,CASE WHEN '"+ sessionStorage.getItem('Language') +"' = 'en' THEN itemmaster.itemdescription ELSE itemmaster.arbitemdescription END As Description,CASE WHEN itemtransactiontype=2 THEN -(promotiondetail.oldpromotionamount) ELSE promotiondetail.oldpromotionamount END as oldamount,CASE WHEN itemtransactiontype =1 THEN (promotiondetail.oldpromotionamount - ifnull(promotiondetail.promotionamount,0)) ELSE -(promotiondetail.oldpromotionamount - ifnull(promotiondetail.promotionamount,0)) END as newamount,"+totalfield+",itemtransactiontype From promotiondetail inner join promokeydetail on promotiondetail.promotionplannumber = promokeydetail.plannumber and promotionkey = (select promotionkey from customermaster  where customercode = " + sessionStorage.getItem('customerid') + ") inner join invoicedetail on promotiondetail.itemcode = invoicedetail.itemcode and invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey = " + sessionStorage.getItem('VisitKey') + " inner join invoiceheader on invoiceheader.routekey=invoicedetail.routekey and invoiceheader.visitkey=invoicedetail.visitkey  inner join itemmaster on promotiondetail.itemcode = itemmaster.actualitemcode where promotiondetail.promotionplannumber = " + planNumber + " and promotiondetail.routekey = " + sessionStorage.getItem('RouteKey') + " and promotiondetail.visitkey = " + sessionStorage.getItem('VisitKey') + "";                
                }
                else 
                {
                    
                                    
                    if(repeatingrange ==1)
                    {
                        selectlineitemrepeat(flag,totalfield);
                        
                    }
                    else
                    {
                        
                    lintItemQry = "select CASE WHEN '"+ sessionStorage.getItem('CheckCode') +"' = 'alternatecode' THEN itemmaster.alternatecode ELSE itemmaster.actualitemcode END AS Code,CASE WHEN '"+ sessionStorage.getItem('Language') +"' = 'en' THEN itemmaster.itemdescription ELSE itemmaster.arbitemdescription END As Description,CASE WHEN itemtransactiontype=2 THEN -(promotiondetail.oldpromotionamount) ELSE (promotiondetail.oldpromotionamount) END as oldamount,CASE WHEN itemtransactiontype =1 THEN ((promotiondetail.oldpromotionamount - (promotiondetail.oldpromotionamount * ifnull(promotiondetail.promotionamount/100.0,0)))) ELSE -((promotiondetail.oldpromotionamount - (promotiondetail.oldpromotionamount * ifnull(promotiondetail.promotionamount/100.0,0)))) END as newamount,"+totalfield+",itemtransactiontype From promotiondetail inner join promokeydetail on promotiondetail.promotionplannumber = promokeydetail.plannumber and promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") inner join invoicedetail on promotiondetail.itemcode = invoicedetail.itemcode and invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey = " + sessionStorage.getItem('VisitKey') + " inner join invoiceheader on invoiceheader.routekey=invoicedetail.routekey and invoiceheader.visitkey=invoicedetail.visitkey inner join itemmaster on promotiondetail.itemcode = itemmaster.actualitemcode where promotiondetail.promotionplannumber = " + planNumber + " and promotiondetail.routekey = " + sessionStorage.getItem('RouteKey') + " and promotiondetail.visitkey = " + sessionStorage.getItem('VisitKey') + "";
                    }
                }
               
                if(platform=='iPad')
           		{
                    Cordova.exec(function(result) {
                                  if(result.length > 0 )
                                  {
                                        ClearTable();
                                        BindLineItem(result,flag);     
                                        
                                  }
                                  },
                                  function(error) {
                                    navigator.notification.alert("Error in binding line item detail : " + error);
                                  },
                                  "PluginClass", 
                                  "GetdataMethod",
                                  [lintItemQry]); 
            	}
                else if(platform=='Android')
                {
                        window.plugins.DataBaseHelper.select(lintItemQry,function(result)
                                                            {
                                                                if(result.array != undefined)
                                                                {
                                                                    ClearTable();
                                                                    BindLineItem(result,flag);     
                                                                }
                                                            },
                                                            function()
                                                            {
                                                             console.warn("Error calling plugin");
                                                            });
                }
            }
           function selectlineitemrepeat(flag,totalfield)
            {
                
                var selectqry = "select oldpromotionamount,promotionamount,itemcode,itemtransactiontype from promotiondetail where promotiondetail.promotionplannumber = " + planNumber + " and promotiondetail.routekey = " + sessionStorage.getItem('RouteKey') + " and promotiondetail.visitkey = " + sessionStorage.getItem('VisitKey') + "";
                
                console.log(selectqry);
                
               
                if(platform=='iPad')
           		{
                    
                    Cordova.exec(function(result) {
                                  if(result.length > 0 )
                                  {
                                  var where ='CASE ';
                                  for(i=0;i<result.length;i++)
                                  {
                                  
                                  var oldamount = result[i][0];
                                  var promoamount = result[i][1];
                                  var itemcodes = result[i][2];
                                  var tratype = result[i][3];
                                  
                                  var finalamount = 0;
                                  if(tratype = 1)
                                  var totalamount = eval(oldamount);
                                  else
                                  var totalamount = eval(oldamount);
                                  while( totalamount >= eval(rangelow))
                                  {
                                 
                                  finalamount = finalamount + eval(rangelow) * (promoamount/100);
                                  console.log(totalamount);
                                  
                                  totalamount = totalamount - eval(rangelow);
                                  }
                                  
                                  where =where + "when promotiondetail.itemcode="+itemcodes+" and itemtransactiontype ="+eval(result[i][3])+" THEN "+finalamount+" ";
                                    
                                  } 
                                  where = where +"END";
                                  console.log(where);
                                  lintItemQry = "select CASE WHEN '"+ sessionStorage.getItem('CheckCode') +"' = 'alternatecode' THEN itemmaster.alternatecode ELSE itemmaster.actualitemcode END AS Code,CASE WHEN '"+ sessionStorage.getItem('Language') +"' = 'en' THEN itemmaster.itemdescription ELSE itemmaster.arbitemdescription END As Description,CASE WHEN itemtransactiontype=2 THEN -(promotiondetail.oldpromotionamount) ELSE (promotiondetail.oldpromotionamount) END as oldamount,CASE WHEN itemtransactiontype =1 THEN ((promotiondetail.oldpromotionamount - "+where+")) ELSE -((promotiondetail.oldpromotionamount - "+where+")) END as newamount,"+totalfield+",itemtransactiontype From promotiondetail inner join promokeydetail on promotiondetail.promotionplannumber = promokeydetail.plannumber and promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") inner join invoicedetail on promotiondetail.itemcode = invoicedetail.itemcode and invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey = " + sessionStorage.getItem('VisitKey') + " inner join invoiceheader on invoiceheader.routekey=invoicedetail.routekey and invoiceheader.visitkey=invoicedetail.visitkey inner join itemmaster on promotiondetail.itemcode = itemmaster.actualitemcode where promotiondetail.promotionplannumber = " + planNumber + " and promotiondetail.routekey = " + sessionStorage.getItem('RouteKey') + " and promotiondetail.visitkey = " + sessionStorage.getItem('VisitKey') + "";
                                  console.log(lintItemQry);
                                  
                                  Cordova.exec(function(result1) {
                                                if(result1.length > 0 )
                                                {
                                                
                                                ClearTable();
                                                BindLineItem(result1,flag);     
                                                
                                                }
                                                },
                                                function(error) {
                                                navigator.notification.alert("Error in binding line item detail : " + error);
                                                },
                                                "PluginClass", 
                                                "GetdataMethod",
                                                [lintItemQry]); 
                                  
                                  
                                  }
                                  },
                                  function(error) {
                                  navigator.notification.alert("Error in binding line item detail : " + error);
                                  },
                                  "PluginClass", 
                                  "GetdataMethod",
                                  [selectqry]); 
                    
            	}
                else if(platform=='Android')
                {
                    window.plugins.DataBaseHelper.select(selectqry,function(result)
                                                         {
                                                         if(result.array != undefined)
                                                         {
                                                            var where ='CASE ';
                                                         for(i=0;i<result.array.length;i++)
                                                         {
                                                         var oldamount = result.array[i].oldpromotionamount;
                                                         var promoamount = result.array[i].promotionamount;
                                                         var itemcodes = result.array[i].itemcode;
                                                         var tratype = result.array[i].itemtransactiontype;
                                                         
                                                         var finalamount = 0;
                                                        if(tratype = 1)
                                                            var totalamount = eval(oldamount);
                                                            else
                                                            var totalamount = eval(oldamount);
                                                         while( totalamount >= eval(rangelow))
                                  {
                                 
                                  finalamount = finalamount + eval(rangelow) * (promoamount/100);
                                  console.log(totalamount);
                                  
                                  totalamount = totalamount - eval(rangelow);
                                  }
                                  
                                  where =where + "when promotiondetail.itemcode="+itemcodes+" and itemtransactiontype ="+eval(result.array[i].itemtransactiontype)+" THEN "+finalamount+" ";
                                                         } 
                                  where = where +"END";
                                                       lintItemQry = "select CASE WHEN '"+ sessionStorage.getItem('CheckCode') +"' = 'alternatecode' THEN itemmaster.alternatecode ELSE itemmaster.actualitemcode END AS Code,CASE WHEN '"+ sessionStorage.getItem('Language') +"' = 'en' THEN itemmaster.itemdescription ELSE itemmaster.arbitemdescription END As Description,CASE WHEN itemtransactiontype=2 THEN -(promotiondetail.oldpromotionamount) ELSE (promotiondetail.oldpromotionamount) END as oldamount,CASE WHEN itemtransactiontype =1 THEN ((promotiondetail.oldpromotionamount - "+where+")) ELSE -((promotiondetail.oldpromotionamount - "+where+")) END as newamount,"+totalfield+",itemtransactiontype From promotiondetail inner join promokeydetail on promotiondetail.promotionplannumber = promokeydetail.plannumber and promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") inner join invoicedetail on promotiondetail.itemcode = invoicedetail.itemcode and invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey = " + sessionStorage.getItem('VisitKey') + " inner join invoiceheader on invoiceheader.routekey=invoicedetail.routekey and invoiceheader.visitkey=invoicedetail.visitkey inner join itemmaster on promotiondetail.itemcode = itemmaster.actualitemcode where promotiondetail.promotionplannumber = " + planNumber + " and promotiondetail.routekey = " + sessionStorage.getItem('RouteKey') + " and promotiondetail.visitkey = " + sessionStorage.getItem('VisitKey') + "";
                                                         console.log(lintItemQry);

                                                         window.plugins.DataBaseHelper.select(lintItemQry,function(result1)
                                                                                              {
                                                                                              if(result.array != undefined)
                                                                                              {
                                                                                              ClearTable();
                                                                                              BindLineItem(result1,flag);     
                                                                                              }
                                                                                              },
                                                                                              function()
                                                                                              {
                                                                                              console.warn("Error calling plugin");
                                                                                              });    
                                                         }
                                                         
                                                         },
                                                         function()
                                                         {
                                                         console.warn("Error calling plugin");
                                                         });
                    
                }
            }
             
            // Bind data dynamically
            function BindLineItem(result,flag)
            {
                var CellCount = $("#tblLineHeader tr:eq(0) th").length;
                // sessionStorage.setItem("invoiceamount",0);
                dataLineItem = result;
                
                if(platform=='Android')
                {
                    var result = $.map(result.array, function (item, index) {               
                                      return [[item.Code, item.Description,item.oldamount,item.newamount,item.amount,item.itemtransactiontype]];
                                });   
                    
                    dataLineItem = result;
                }
                
               // lineItem1 = 0;
               // lineItem2 = 0;
                if(promotionTypeCode == 0)
                {
                    lineItem0 = 0;
                    lineold0 = 0;
                    for(k=0;k<dataLineItem.length;k++)
                    {
                        // lineItem1 += eval(dataLineItem[i][3]);
                        lineItem0 += eval(dataLineItem[k][3]);
                        lineold0 += eval(dataLineItem[k][2]);// changes i
																// from k by
																// pratik
                    }
                     if(flag==0)
                    {
                        if(sessionStorage.getItem("invoiceamount") == 0)
                        {
                            var currentinvoice = eval(dataLineItem[0][4]);
                        }
                        else
                        {
                            var currentinvoice = sessionStorage.getItem("invoiceamount");
                        }
                        var newinvoice=currentinvoice - eval(lineold0 - lineItem0);
                    }
                    else if(flag==1)
                    {
                       
                        var currentinvoice = eval(sessionStorage.getItem("currentinvoice"))+ eval(lineold0 - lineItem0);
                        var newinvoice=eval(sessionStorage.getItem("currentinvoice"));
                    }
                    else if(flag==2)
                    {
                        var currentinvoice = eval(sessionStorage.getItem("currentinvoice"));
                        var newinvoice=eval(sessionStorage.getItem("invoiceamount"));
                    }
                   
                    
                    
                    $('#txtcurrentinvoice').val(eval(currentinvoice).toFixed(sessionStorage.getItem('decimalplace')));
                    $('#txtnewinvoice').val(eval(newinvoice).toFixed(sessionStorage.getItem('decimalplace')));
                    sessionStorage.setItem("invoiceamount", eval(newinvoice).toFixed(sessionStorage.getItem('decimalplace')));
                    sessionStorage.setItem("currentinvoice", eval(currentinvoice).toFixed(sessionStorage.getItem('decimalplace')));
                }
                else if(promotionTypeCode == 1)
                {
                    lineItem1 = 0;
                    lineold = 0;
                    for(k=0;k<dataLineItem.length;k++)
                    {
                        // lineItem1 += eval(dataLineItem[i][3]);
                        lineItem1 += eval(dataLineItem[k][3]);
                        lineold += eval(dataLineItem[k][2]);// changes i from k
															// by pratik
                    }
                    if(flag==0)
                    {
                        if(sessionStorage.getItem("invoiceamount") == 0)
                        {
                            var currentinvoice = eval(dataLineItem[0][4]);
                        }
                        else
                        {
                            var currentinvoice = sessionStorage.getItem("invoiceamount");
                        }
                        var newinvoice=currentinvoice - eval(lineold - lineItem1);
                    }
                    else if(flag==1)
                    {
                        
                        var currentinvoice = eval(sessionStorage.getItem("currentinvoice"))+ eval(lineold - lineItem1);
                        var newinvoice=eval(sessionStorage.getItem("currentinvoice"));
                    }
                    else if(flag==2)
                    {
                        var currentinvoice = eval(sessionStorage.getItem("currentinvoice"));
                        var newinvoice=eval(sessionStorage.getItem("invoiceamount"));
                    }

                    
                    $('#txtcurrentinvoice').val(eval(currentinvoice).toFixed(sessionStorage.getItem('decimalplace')));
                    $('#txtnewinvoice').val(eval(newinvoice).toFixed(sessionStorage.getItem('decimalplace')));
                    sessionStorage.setItem("invoiceamount", eval(newinvoice).toFixed(sessionStorage.getItem('decimalplace')));
                    sessionStorage.setItem("currentinvoice", eval(currentinvoice).toFixed(sessionStorage.getItem('decimalplace')));
                }
                else 
                {
                    lineItem2 = 0;
                    lineold2 = 0;
                    for(k=0;k<dataLineItem.length;k++)
                    {
                        // lineItem2 += eval(dataLineItem[i][3]);
                        lineItem2 += eval(dataLineItem[k][3]);
                        lineold2 += eval(dataLineItem[k][2]);// changes i
																// from k by
																// pratik
                    }
                   console.log("flag="+flag+"----"+dataLineItem[0][4]);
                    if(flag==0)
                    {
                        if(sessionStorage.getItem("invoiceamount") == 0)
                        {
                        var currentinvoice = eval(dataLineItem[0][4]);
                        }
                        else
                        {
                        var currentinvoice = sessionStorage.getItem("invoiceamount");
                        }
                        var newinvoice=currentinvoice - eval(lineold2 - lineItem2);
                    }
                    else if(flag==1)
                    {
                        
                        var currentinvoice = eval(sessionStorage.getItem("currentinvoice"))+ eval(lineold2 - lineItem2);
                        var newinvoice=eval(sessionStorage.getItem("currentinvoice"));
                    }
                    else if(flag==2)
                    {
                        var currentinvoice = eval(sessionStorage.getItem("currentinvoice"));
                        var newinvoice=eval(sessionStorage.getItem("invoiceamount"));
                    }
                    
                    $('#txtcurrentinvoice').val(eval(currentinvoice).toFixed(sessionStorage.getItem('decimalplace')));
                    $('#txtnewinvoice').val(eval(newinvoice).toFixed(sessionStorage.getItem('decimalplace')));
                    sessionStorage.setItem("invoiceamount", eval(newinvoice).toFixed(sessionStorage.getItem('decimalplace')));
                    sessionStorage.setItem("currentinvoice", eval(currentinvoice).toFixed(sessionStorage.getItem('decimalplace')));
                }
                
                for (i = 0; i < dataLineItem.length; i++) 
                {
                    var r = "<tr class='contentFont'>";
                    for (j = 0; j < CellCount; j++) 
                    {
                        var temp = (j == 0 || j == 1) ? 'class = leftAlign' : '';
                        
                        if (j == CellCount - 1)
                            temp += "class = 'last'";
                        if(j>1 && j<4)
                        dataLineItem[i][j] =eval(dataLineItem[i][j]).toFixed(sessionStorage.getItem('decimalplace'));
                        if(j==4)
                        {
                            if(eval(dataLineItem[i][5]) == 1)
                            var stype = 'S';
                            else
                            var stype = 'R';
                        dataLineItem[i][j] = stype;
                        }
                        var c = "<td " + temp + ">" + dataLineItem[i][j] + "</td>";   
                        r += c;
                    }
                    r += "</tr>";
                      
                    $('#tblLineContent tbody').append(r);
                }
                
                $("#tblLineContent tr:odd").addClass('oddRow');
                $("#tblLineContent tr:even").addClass('evenRow');        
                
                $("#tblLineContent tr:eq(1)").trigger('click');
            }   
            
            function ClearTable() {
                $("#tblLineContent  tr:gt(0)").remove();
            }
            
            
            // Function for bind free sample list
            function getFreeSampleList(flag)
            {      
              
                promovalue = sessionStorage.getItem("promovalue");
                returnpromovalue = sessionStorage.getItem("returnpromovalue");
                
                if(EnableSalesPromotion ==2)
                {
                    var selectqry ="select CASE WHEN '"+ sessionStorage.getItem('CheckCode') +"' = 'alternatecode' THEN itemmaster.alternatecode ELSE itemmaster.actualitemcode END AS Code,CASE WHEN '"+ sessionStorage.getItem('Language') +"' = 'en' THEN itemmaster.itemdescription ELSE itemmaster.arbitemdescription END As Description,ifnull(invoicedetail.returnqty,0)+ifnull(invoicedetail.damagedqty,0) as returnqty,itemmaster.unitspercase,ifnull(returnfreeqty,0) as returnfreeqty,ifnull(invoicedetail.salesprice,0) as salesprice,itemmaster.actualitemcode,ifnull(invoicedetail.salescaseprice,0) as salescaseprice,promokeydetail.rangebasis,promotiondetail.promotionquantity from promokeydetail inner join promotiondetail on promotiondetail.promotionplannumber=promokeydetail.plannumber and promotiondetail.promotionplannumber = "+ sessionStorage.getItem('plannumber') +" and promotiondetail.visitkey="+ sessionStorage.getItem('VisitKey') +" and promotiondetail.routekey = "+ sessionStorage.getItem('RouteKey') +" left join invoicedetail on promotiondetail.itemcode = invoicedetail.itemcode and invoicedetail.routekey = "+ sessionStorage.getItem('RouteKey') +" and invoicedetail.visitkey  = "+ sessionStorage.getItem('VisitKey') +" and itemtransactiontype=2 inner join itemmaster on promotiondetail.itemcode = itemmaster.actualitemcode where promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = "+ sessionStorage.getItem('customerid') +") and promokeydetail.plannumber = "+ sessionStorage.getItem('plannumber') +" and itemtransactiontype=2";
                    $('#sqty').text("Return Qty");
                }
                else
                {
                    if(promotionTypeCode == 7)
                        {
                          var selectqry="SELECT CASE WHEN '"+ sessionStorage.getItem('CheckCode') +"' = 'alternatecode' THEN itemmaster.alternatecode ELSE itemmaster.actualitemcode END AS Code,CASE WHEN '"+ sessionStorage.getItem('Language') +"' = 'en' THEN itemmaster.itemdescription ELSE itemmaster.arbitemdescription END As Description,ifnull(invoicedetail.salesqty,0) as salesqty,itemmaster.unitspercase,ifnull((SELECT promotionfreetemp.promofreeqty FROM promotionfreetemp WHERE promotionfreetemp.promotionplannumber = promotiondetail.promotionplannumber and promotionfreetemp.itemcode = promotiondetail.itemcode),0) as freesampleqty,ifnull(invoicedetail.salesprice,0) as salesprice,itemmaster.actualitemcode,  ifnull(invoicedetail.salescaseprice,0) as salescaseprice,promokeydetail.rangebasis,promotiondetail.promotionquantity,ifnull(freesampleqty,0) as freesampleqtyold FROM promokeydetail inner join promotiondetail on promotiondetail.promotionplannumber=promokeydetail.plannumber and    promotiondetail.promotionplannumber = "+ sessionStorage.getItem('plannumber') +" and promotiondetail.visitkey="+sessionStorage.getItem('VisitKey') +" and promotiondetail.routekey = "+ sessionStorage.getItem('RouteKey') +" left join invoicedetail on promotiondetail.itemcode = invoicedetail.itemcode and invoicedetail.routekey = "+ sessionStorage.getItem('RouteKey') +" and invoicedetail.visitkey  = "+ sessionStorage.getItem('VisitKey') +" and itemtransactiontype=1  inner join itemmaster on promotiondetail.itemcode = itemmaster.actualitemcode WHERE promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = "+ sessionStorage.getItem('customerid') +") and   promokeydetail.plannumber = "+sessionStorage.getItem('plannumber') +" and   itemtransactiontype=1";
                        
                        }else
                            {
                            var selectqry ="select CASE WHEN '"+ sessionStorage.getItem('CheckCode') +"' = 'alternatecode' THEN itemmaster.alternatecode ELSE itemmaster.actualitemcode END AS Code,CASE WHEN '"+ sessionStorage.getItem('Language') +"' = 'en' THEN itemmaster.itemdescription ELSE itemmaster.arbitemdescription END As Description,ifnull(invoicedetail.salesqty,0) as salesqty,itemmaster.unitspercase,ifnull(freesampleqty,0) as freesampleqty,ifnull(invoicedetail.salesprice,0) as salesprice,itemmaster.actualitemcode,ifnull(invoicedetail.salescaseprice,0) as salescaseprice,promokeydetail.rangebasis,promotiondetail.promotionquantity from promokeydetail inner join promotiondetail on promotiondetail.promotionplannumber=promokeydetail.plannumber and promotiondetail.promotionplannumber = "+ sessionStorage.getItem('plannumber') +" and promotiondetail.visitkey="+ sessionStorage.getItem('VisitKey') +" and promotiondetail.routekey = "+ sessionStorage.getItem('RouteKey') +" left join invoicedetail on promotiondetail.itemcode = invoicedetail.itemcode and invoicedetail.routekey = "+ sessionStorage.getItem('RouteKey') +" and invoicedetail.visitkey  = "+ sessionStorage.getItem('VisitKey') +" and itemtransactiontype=1 inner join itemmaster on promotiondetail.itemcode = itemmaster.actualitemcode where promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = "+ sessionStorage.getItem('customerid') +") and promokeydetail.plannumber = "+ sessionStorage.getItem('plannumber') +" and itemtransactiontype=1";
                            
                            }
                   
                }
                               
                $('#txFreeQty').val(parseInt(promovalue));
                 $('#txFreeQtyreturn').val(parseInt(returnpromovalue));
                console.log(selectqry);
                if(platform=='iPad')
                {
                Cordova.exec(function(result) {                      
                              
                              ClearTableContent();
                              BindData(result);
                              if(flag=='true')
                              UpdateInvoiceDetail(result.length);
                              
                              },
                              function(error) {
                                alert("Error in binding free sample detail : " + error);
                              },
                              "PluginClass", 
                              "GetdataMethod",                           
                              [selectqry]);
                }
                else if(platform=='Android')
                {
                    window.plugins.DataBaseHelper.select(selectqry,function(result)
                                                         {
                       
                                                            if(result.array != undefined)
                                                            {
                                                                ClearTableContent();
																freepromotionGR=false;
																getAvailabiliy(result); 
	                                                         	if(flag=='true')
	                                                         		UpdateInvoiceDetail(result.array.length);
	                                                            }
                                                         },
                                                         function()
                                                         {
                                                            console.warn("Error calling plugin");
                                                         });
                }
				
				if(EnableSalesPromotion == 3)
                {
                
                	ClearTableContent();
                    var selectqry1 ="select CASE WHEN '"+ sessionStorage.getItem('CheckCode') +"' = 'alternatecode' THEN itemmaster.alternatecode ELSE itemmaster.actualitemcode END AS Code,CASE WHEN '"+ sessionStorage.getItem('Language') +"' = 'en' THEN itemmaster.itemdescription ELSE itemmaster.arbitemdescription END As Description,ifnull(invoicedetail.returnqty,0)+ifnull(invoicedetail.damagedqty,0) as returnqty,itemmaster.unitspercase,ifnull(returnfreeqty,0) as returnfreeqty,ifnull(invoicedetail.salesprice,0) as salesprice,itemmaster.actualitemcode,ifnull(invoicedetail.salescaseprice,0) as salescaseprice,promokeydetail.rangebasis,promotiondetail.promotionquantity from promokeydetail inner join promotiondetail on promotiondetail.promotionplannumber=promokeydetail.plannumber and promotiondetail.promotionplannumber = "+ sessionStorage.getItem('plannumber') +" and promotiondetail.visitkey="+ sessionStorage.getItem('VisitKey') +" and promotiondetail.routekey = "+ sessionStorage.getItem('RouteKey') +" left join invoicedetail on promotiondetail.itemcode = invoicedetail.itemcode and invoicedetail.routekey = "+ sessionStorage.getItem('RouteKey') +" and invoicedetail.visitkey  = "+ sessionStorage.getItem('VisitKey') +" and itemtransactiontype=2 inner join itemmaster on promotiondetail.itemcode = itemmaster.actualitemcode where promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = "+ sessionStorage.getItem('customerid') +") and promokeydetail.plannumber = "+ sessionStorage.getItem('plannumber') +" and itemtransactiontype=2";
                    if(platform=='iPad')
                    {
                    			Cordova.exec(function(result) {                      
                                  
                                  ClearTableContent();
                                  
                                  
                                  },
                                  function(error) {
                                    alert("Error in binding free sample detail : " + error);
                                  },
                                  "PluginClass", 
                                  "GetdataMethod",                           
                                  [selectqry1]);
                    }
                    else if(platform=='Android')
                    {
                        window.plugins.DataBaseHelper.select(selectqry1,function(result)
                                                             {
                           
                                                                if(result.array != undefined && result.array.length>0)
                                                                {
                                                                	freepromotionGR=true;
                                                                	checkGoodrtnQty();
                                                                	
                                                                }  
                                                             },
                                                             function()
                                                             {
                                                                console.warn("Error calling plugin");
                                                             });
                    }
                }
            }
                
			 function checkGoodrtnQty(){
            	ClearTableContent();
            	var qry="Select sum(returnfreeqty) as sum,sum(returnqty) as returnqty from invoicedetail where visitkey = "+ sessionStorage.getItem('VisitKey') +" and routekey ="+ sessionStorage.getItem('RouteKey') +"";
            	var platform= sessionStorage.getItem("platform");
            	
            	if(platform=='iPad')
           		{
            				Cordova.exec(function(result) 
            				{                           
                                    if(result.length > 0)
                                    {
                                       
                                    }
                                    else 
                                    {
                                                                            
                                        
                                    }
                              },
                              function(error) {
                                navigator.notification.alert("Error in binding promotion list : " + error);
                              },
                              "PluginClass", 
                              "GetdataMethod", 
                              [qry]);         
                }
            	else if(platform=='Android')
            	{          
            		window.plugins.DataBaseHelper.select(qry,function(result)
					{
				 		if(result.array!=undefined)
						{     
							if(eval(result.array[0].sum)==0 && eval(result.array[0].returnqty)>0){
								alert("Please make sure the free items are taken back");
								
							}       
				 			
                        }
                                     
					},
					function()
					{
			   	 		console.warn("Error calling plugin");
					});
            	}  
            	
            	
            }
			var wrapFunction = function(fn, context, params) {
				    return function() {
				        fn.apply(context, params);
				    };
			}
            
			function getAvailabiliy(result){
				var result = $.map(result.array, function (item, index) {               
                     return [[item.Code, item.Description,item.salesqty,item.unitspercase,item.freesampleqty,item.salesprice,item.actualitemcode,item.salescaseprice,item.rangebasis,item.promotionquantity]];
                     });   
  
				dataFreeSample = result;
				AvailableQtyArray=new Array(); 
				if(promotionTypeCode == '7')
                {
					var arrFreeSample=dataFreeSample.slice(0);;
					getAvailQty(arrFreeSample);
				
                }else{
                	
                	BindData(result)
                }
				
				
				
				
			}
			
            function BindData(result)
            {
                var CellCount = $("#tblHeaderContent tr:eq(0) th").length;
               
                
               
                
//                 // Addded by bindal on 25-8-2014
//                 if(promotionTypeCode == '7' && flag==0)
//                 {
//                 	AvailableQtyArray=new Array(); 
//                 	var funqueue = [];
//                     for(j=0;j<dataFreeSample.length;j++)
//                     {
                    	
                    	
                    	
//                     	var fun=wrapFunction(availfn, this,[""+ dataFreeSample[j][6]+""]);
//                     	funqueue.push(fun);
//                     	if(j==dataFreeSample.length-1){
//                     		while (funqueue.length > 0) {
//                                 (funqueue.shift())();   
//                             }
                    		
//                     	}
                    	
//                     }
                	
                    
                    
                	
//                 }
                
                
                for (i = 0; i < dataFreeSample.length; i++) 
                {
                   
                    var r = "<tr class='contentFont'>";
                    for (j = 0; j < CellCount; j++) 
                    {
                        var temp = (j == 0 || j == 1) ? 'class = leftAlign' : '';
                        if (j == CellCount - 1)
                            temp += "class = 'last'";
                        if(j > 1)
                            dataFreeSample[i][j] = parseInt(dataFreeSample[i][j]);
                        
                    if(dataFreeSample[i][8]==3 || dataFreeSample[i][8]==4)
                    {
                        if(j==4)
                        {
                           // alert('Flag4: '+ dataFreeSample[i][9]);
                           // alert("bind");
                            var c = "<td " + temp + ">" + parseInt(dataFreeSample[i][9]) + "</td>";
                        }
                        else
                        {
                           // alert('Flag5: '+ dataFreeSample[i][j] + 'i =' +i
							// + 'j =' + j);
                           // alert("bind");
                            var c = "<td " + temp + ">" + dataFreeSample[i][j] + "</td>";
                        }
                    }
                    else{
                       
                        
                       // alert('Flag6: '+ dataFreeSample[i][j] + 'i =' +i + 'j
						// =' + j);
                      // alert("bind");
                            var c = "<td " + temp + ">" + dataFreeSample[i][j] + "</td>";
                        }
                        r += c;
                    }
                    r += "</tr>";
                    $('#tblContent tbody').append(r);  
                      
                    
                }
               
                if(dataFreeSample[0][8]==3 || dataFreeSample[0][8]==4)
                { 
                    UpdateInvoiceDetail(0);
                } 
                $("#tblContent tr:odd").addClass('oddRow');
                $("#tblContent tr:even").addClass('evenRow');        
                
                $("#tblContent tr:eq(1)").trigger('click');
                var Qty=0;
                if(EnableSalesPromotion !=2)
                {
                    if(dataFreeSample[0][8]<3)
                    {
                    	
                    	$('#tblContent td.last').click(function()
                        {
                                   var rowindex=$(this).parent().index();
                                   var aval= $(this).text();
                                   
                                   var input = $('<input/>').attr('value',$(this).text());
                                   var w = $(this).innerWidth();
                                   w=w-20;
                                   
                                   input.attr('type','number');
                                   if(window.innerWidth>1000){ 
                                	   input.css('width', w).css('border', '0').css('height', 60).css('font-size',35);
                                   }else{
                                	   input.css('width', w).css('border', '0').css('height', 30).css('font-size', 16);
                                   }
                                   
                                   
                                   $(this).empty();
                                   $(this).append(input);
                                   
                                   input.focusout(function()
                                   { 
                                                 
                                	   			  
                                                 
                                                  Qty = eval($(this).val());
                                                  
                                                  if((Qty)  > promovalue)
                                                  {
	                                                  Qty = eval(Qty) - eval($(this).val());
	                                                  $(this).parent().text(0);   
	                                                  getLangText("Given Qty Cant Exceeded Allowed Qty");
                                                  
                                                    
                                                  }else if(eval(Qty)<0){
                                                	  Qty=0;
                                                	  $(this).parent().text(Qty);   
                                                	  if(eval(Qty)<0)
	                                                  getLangText("Nagative Qty Not Allowed");
                                                   
                                                  }
                                                  else{
                                                	// alert("Available"+AvailableQtyArray[rowindex-1]);
                                                	// alert("Entered"+eval($(this).val()));
                                                	 
                                                	 if(promotionTypeCode == '7')
                                                     {
                                                		    
		                                                	 if(eval($(this).val())>AvailableQtyArray[rowindex-1])
		                                                	 {
		                                                		  $(this).parent().text(0);
		                                                		  alert("Quantity Not Available\nAvailable Quantity "+AvailableQtyArray[rowindex-1]);
		                                                		  isLock='1';
		                                                		  if(lockFlag=='0')
		                                                		  {
		                                                			  UpdateInvoiceDetail(rowindex,'1');
		                                                			  
		                                                		  }
		                                                		  
		                                                	 }else
		                                                	 {
		                                                		 $(this).parent().text(parseInt(eval($(this).val())));
		                                                		 UpdateInvoiceDetail(rowindex,'0');
		                                                	 }
                                                	  
                                                     }else
                                                     {
                                                    	 $(this).parent().text(parseInt(eval($(this).val())));
                                                		 UpdateInvoiceDetail(rowindex,'0');
                                                    	 
                                                     }
                                                 
                                                    
                                                  }
                                                  
                                                  });
                                        input.focus();
                                   }); 
                }
                }
            }   
            
                       
            
            function UpdateInvoiceDetail(index1,availflag)
            { 
                // CheckfreeAvailQty();
               // alert(Qty);
               // alert(promovalue);
            	
                var Qty = 0; 
                
                var eachqty =[];
                $('#tblContent tr').each(function()
                {
                         if($(this).index() > 0)
                         {
                             var index= $(this).index();
                             eachqty[index] = eval($(this).find('td:last').text());
                             if(isOnQuantity==1){
                            	 Qty += eval($(this).find('td:last').text())*eval(dataFreeSample[index-1][5]);
                             }else{
                            	 Qty += eval($(this).find('td:last').text());
                             }
                            
                         
                         }
                });
                
                
                if(Qty != 0 || availflag=='1' )
                {
                    
                    if((Qty)  > promovalue)
                    {
                    	getLangText("Given Qty Cant Exceeded Allowed Qty");
                        $('#tblContent tr').each(function(){
                                                
                                                 if($(this).index() == index1)
                                                 {
                                                 
	                                                 Qty = eval(Qty)-eval($(this).find('td:last').text());
	                                                
	                                                 $(this).find('td:last').text(0);
                                                 }
                                                 });
                        return false;
                    }
                    else
                    {
                        // Update Invoice Detail
                        var amount =0;
                       
                        for(i=0;i<dataFreeSample.length;i++)
                        {
                            batchqty='promoqty';
                            transactiontypecode=17;
                            deletebatchexpiry(dataFreeSample[i][6],sessionStorage.getItem('RouteKey'),sessionStorage.getItem('VisitKey'), eachqty[i+1],transactiontypecode,batchqty);
                            console.log("Update invoicedetail set freesampleqty = "+ eachqty[i+1] +",mdat = datetime() where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ dataFreeSample[i][6] +"");
                            var freeqty = eachqty[i+1];
                           // alert(freeqty);
                            var freecase = eval(eachqty[i+1]) / eval(dataFreeSample[i][3]);
                            var freeunits = eval(eachqty[i+1]) % eval(dataFreeSample[i][3]);
                             amount = amount + eval(freecase *eval(dataFreeSample[i][7]))+eval(freeunits*eval(dataFreeSample[i][5]));
                            var updateqty ="update invoiceheader set totalfreesampleamount="+amount+" where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +"";
                            console.log(updateqty);
                            // alert(updateqty);
                             if(i==dataFreeSample.length-1) 
                             {
                            if(platform=='iPad')
                            {
                                Cordova.exec(function(result) 
                                          { 
                                            
                                          },
                                          function(error) {
                                            alert("Error updating record in a invoice detail");
                                          },
                                          "PluginClass", 
                                          "InsertUpdateMethod", 
                                          [updateqty]); 
                            }
                            else if(platform=='Android')
                            {
                                window.plugins.DataBaseHelper.insert(updateqty,function(result)
                                                                     {
                                                                        
                                                                     },
                                                                     function()
                                                                     {
                                                                     console.warn("Error calling plugin");
                                                                     });
                            }                                                           
                             }
                            // updateinvoicedetail1(dataFreeSample[i][6],eachqty[i+1],dataFreeSample[0][8]);
                            updatepromotionfreetemp1(dataFreeSample[i][6],eachqty[i+1],dataFreeSample[0][8],amount,availflag,dataFreeSample[i][5]);
                        }
                        // window.location =
						// '../customer/promotion_review.html';
                    }
                }
                 else
                {
//                 	if(availflag=='0') 
//                 	{
//                 		getLangText("Please enter quantity");
//                 	}
                   
                    return false;
                }   
                
                
                
            }
            
            function ClearTableContent() {
                $("#tblContent  tr:gt(0)").remove();
            }
            // ------------
            // ------------Start--
            function CheckfreeAvailQty()
            {
               
                var Qry = "SELECT id.itemcode,(IFNULL(id.salesqty,0)+IFNULL(id.freesampleqty,0)+IFNULL(id.manualfreeqty,0)) InvoicedQty, (IFNULL(inv.loadqty,0)+IFNULL(inv.loadadjustqty,0)+IFNULL(inv.beginstockqty,0)+IFNULL(inv.loadaddqty,0)-IFNULL(inv.loadcutqty,0)-IFNULL(inv.saleqty,0)+IFNULL(inv.returnqty,0)+IFNULL(inv.returnfreeqty,0)-IFNULL(inv.freesampleqty,0)) AS AvailableQty FROM invoicedetail id INNER JOIN inventorysummarydetail inv ON id.itemcode = inv.itemcode AND id.visitkey = " + sessionStorage.getItem("VisitKey") + " AND id.istemp = 'true' WHERE InvoicedQty > AvailableQty";
                
                console.log(Qry);
                if(platform == "iPad") {
                    Cordova.exec(function(result) {
                        // navigator.notification.alert(result);
                        if (CaseEnabled)
                            $("#AvailQty").val(parseInt(result[0][0]) + "/" + parseInt(result[0][1]));
                        else
                            $("#AvailQty").val(parseInt(result[0][4]));

                        AvailQty = result[0][4];
                        if(AvailQty > 0)
                        getSuggestedQty(ItemNo,i,flag,AvailQty);
                    },
                    function(error) {
                        navigator.notification.alert(error);
                    },
                    "PluginClass",
                    "GetdataMethod",
                    [Qry]);
                }
                else if (platform == "Android") 
                {
                    
                    var line = [];
                    window.plugins.DataBaseHelper.select(Qry, function(result) {  
                        if(result.array != undefined){
                           
                        var result = $.map(result.array, function(item, index) {
                            return [[item.itemcode,item.InvoicedQty,item.AvailableQty]];
                        });
                       
                        for (i = 0; i < result.length; i++) {
                            for (j = 0; j < result[i].length; j++) {
                                 	 if(j==0)
                                     {
                                  
                                     line.push(result[i][j]);
                                     }
                                 
                                 
                             }
                        }
                       navigator.notification.alert("Over Sale Not Allowed   \n Item(s) :"+line.join(','));
                       return false;
                        }
                        else
                        {
                            // checkfreepromo();
                            upinvoicedetail();
                        }    
                        
                    },
                    function() {
                        console.warn("Error calling plugin");
                    });
                }
            }
            // ------------End---
            // -----------
            function checkfreepromo()
            {
                localStorage.sign='promo';
                
                if(freepromoflag==1)
                {
                   // var selectqry="select sum(freesampleqty) as
					// qty,promotionquantity as qty2 from promotiondetail join
					// invoicedetail on
					// invoicedetail.itemcode=promotiondetail.itemcode and
					// invoicedetail.routekey="+sessionStorage.getItem('RouteKey')+"
					// and invoicedetail.visitkey="+
					// sessionStorage.getItem('VisitKey') +" where
					// promotiondetail.routekey="+sessionStorage.getItem('RouteKey')+"
					// and promotiondetail.visitkey="+
					// sessionStorage.getItem('VisitKey') +" and
					// promotiontypecode=7 group by
					// invoicedetail.routekey,invoicedetail.visitkey having
					// qty<>qty2";
                    var selectqry="Select count(*) as cnt FROM promotionfreetemp";
                    console.log(selectqry);
                    if(platform=='iPad')
                    {
                        Cordova.exec(function(result) {                      
                                    if(result!='')
                                      {
                                     // PopupPasswordEntry("continue",'promotion_review.html',tblPassword.innerHTML,'promotion_review.html');
                                      }
                                    // else
                                      {                                      	
                                            if(sessionStorage.getItem("SignEnabled") != 1)
                                                window.location = "signatureexpress.html" ;
                                            else
                                            {
                                            	checkCustomerPromo();
                                            }
                                      }
                                      
                                      },
                                      function(error) {
                                      alert("Error in binding free sample detail : " + error);
                                      },
                                      "PluginClass", 
                                      "GetdataMethod",                           
                                      [selectqry]);
                    }
                    else if(platform=='Android')
                    {
                        window.plugins.DataBaseHelper.select(selectqry,function(result)
                                                             {
                                                            if(result.array.length<=0)
                                                             // if(result.array
																// != undefined)
                                                             {
                                                            	getLangText("Without Promotion Qty Not Allowed Continue");
                                                                return false;
                                                            // PopupPasswordEntry("continue",'promotion_review.html',tblPassword.innerHTML,'promotion_review.html');
                                                             }
                                                             else
                                                             {
                                                            	 var SignEnabled=window.localStorage.getItem("SignEnabled");
                                                              	 if(SignEnabled != 1)
                                                         		 {
                                                         			window.location = "signatureexpress.html" ;
                                                         		 }
                                                                 else
                                                                 {
                                                                 	checkCustomerPromo();
                                                                 	 
                                                                 }
                                                             }
                                                             },
                                                             function()
                                                             {
                                                             console.warn("Error calling plugin");
                                                             });
                    }
                }
                else{
                			
                	 	var SignEnabled=window.localStorage.getItem("SignEnabled");
                     	if(SignEnabled != 1)
                		{
                			window.location = "signatureexpress.html" ;
                		}
                        else
                        {
                        	checkCustomerPromo();
                        	 
                        }
                }
            }
            
            function checkCustomerPromo(){
            
            	var custid=sessionStorage.getItem("customerid");
                var platform= sessionStorage.getItem("platform");
                var routecode=sessionStorage.getItem("RouteCode");
                var CompanyCode=sessionStorage.getItem("CompanyCode");
                
                
                if(platform=='iPad')
                {
                     Cordova.exec(function(result) {
                                  
                                 
	                  },
	                  function(error) {
	                  alert(error);
	                  },   
	                  "PluginClass",
	                  "GetdataMethod",
	                  ["select invoicepaymentterms from customermaster where customercode="+custid]);
                }
                else if(platform=='Android')
                {
                    window.plugins.DataBaseHelper.select("select invoicepaymentterms,manualfree,tcspecialdiscount from customermaster where customercode="+custid,function(result)
                    {
							
	                    	 var result = $.map(result.array, function (item, index) {
	                             return [[item.invoicepaymentterms,item.manualfree,item.tcspecialdiscount]];
	                         });	
                    	
                    		window.localStorage.setItem("manualfree",result[0][2]);
                    		sessionStorage.setItem("invoicepaymentterms",result[0][0]);
                    		var isreturn=window.localStorage.getItem("isreturn");
                    		if(eval(result[0][2])>0 && eval(isreturn)==1){
                    	 		window.location = '../customer_opt/Customer_manualfreeexpress.html';
                    	 	}
                    		else
                    		{
                    		
			                            if (eval(result[0][0]) != 2)
			                            {
			                            	 window.location = '../customer_opt/cashcollection_mopexpress.html';
			                            }	
			                            else
			                            {
			                                var allowgctocash = sessionStorage.getItem("allowgctocash");
			                                if(allowgctocash == 1)
			                                {
			                                    var msg = "Do You Want To Make Payment ?";
			                                    navigator.notification.confirm(msg,function(action){
			                                    if(action == true)
			                                        window.location = '../customer_opt/cashcollection_mopexpress.html';
			                                    else
			                                        window.location = '../review/printoptionexpress.html';
			                                    });
			                                }
			                                else
			                                    window.location = '../review/printoptionexpress.html';
			                            }
                    		}
                            
                     },
                     function()
                     {
                     console.warn("Error calling plugin");
                     });
                }
            
            }
            
            function getItemList()
            {
                var selectqry ="SELECT itemmaster.actualitemcode,CASE WHEN '" + sessionStorage.getItem('Language') + "' = 'en' THEN itemmaster.itemdescription ELSE itemmaster.arbitemdescription END As Description,itemmaster.actualitemcode from itemmaster join inventorysummarydetail on inventorysummarydetail.itemcode=itemmaster.actualitemcode where inventorysummarydetail.routekey="+sessionStorage.getItem('RouteKey');
                if (platform == 'iPad') {
                    Cordova.exec(function(result) {
                                  
                                  for(i=0;i<result.length;i++){    
                                  
                                  $("<option />" ,{value:result[i][0],text:result[i][0]+" "+result[i][1]}).appendTo($("#txtitemadd"));   
                                  
                                  }
                                  $('#txtitemadd').selectmenu("refresh");
                                  },
                                  function(error) {
                                  alert("Error in binding Item : " + error);
                                  },
                                  "PluginClass",
                                  "GetdataMethod",
                                  [selectqry]);
                    
                }
                else if (platform == 'Android') {
                    window.plugins.DataBaseHelper.select(selectqry, function(result) {
                                                         var array = $.map(result.array, function (item, index) {               
                                                                           return [[item.actualitemcode, item.Description]];            					
                                                                           });
                                                         
                                                         result = array;
                                                         for(i=0;i<result.length;i++){    
                                                         
                                                         $("<option />" ,{value:result[i][0],text:result[i][0]+" "+result[i][1]}).appendTo($("#txtitemadd"));   
                                                         
                                                         }
                                                         $('#txtitemadd').selectmenu("refresh");
                                                         },
                                                         function() {
                                                         console.warn("Error calling plugin");
                                                         });
                }
            }
            function savepromotion()
            {
                var itemcode =$("#txtitemadd").val();
                var qty =$("#txFreeQtyadd").val();
               
                if((qty)  > parseInt(promovalue))
                {
                  
                	getLangText("Given Qty Cant Exceeded Allowed Qty");
                    return false;
                    
                }
                var selectqry ="select promotionquantity,rangelow,repeatingrange,itemtransactiontype from promotiondetail where promotionplannumber="+ sessionStorage.getItem('plannumber')+" and routekey="+sessionStorage.getItem('RouteKey')+" and visitkey="+sessionStorage.getItem('VisitKey');
               
                if (platform == 'iPad') {
                    Cordova.exec(function(result) {
                                  promotionquantity = result[0][0];
                                  rangelow = result[0][1];
                                  repeatingrange = result[0][2];
                                  itemtransactiontype = result[0][3];
                                   insertQry = "Insert Into promotiondetail(routekey,visitkey,transactionkey,itemcode,promotiontypecode,promotionquantity,promotionplannumber,assignmentkey,weighted,istemp,salesamount,issync,rangelow,repeatingrange,itemtransactiontype) values("+ sessionStorage.getItem('RouteKey') +","+ sessionStorage.getItem('VisitKey') +",0,"+ itemcode +",7,"+ promotionquantity  +","+ sessionStorage.getItem('plannumber') +","+ sessionStorage.getItem('plannumber') +",0,'true',0,0,"+ rangelow +","+ repeatingrange +","+itemtransactiontype+")";
                                  console.log(insertQry);
                                 
                                  
                                  Cordova.exec(function(result) 
                                                {    
                                                 
                                                updateinvoicefree(itemcode,qty);
                                                },
                                                function(error) {
                                                navigator.notification.alert("Error inserting record in promotion detail");
                                                },
                                                "PluginClass", 
                                                "InsertUpdateMethod", 
                                                [insertQry]);
                                  },
                                  function(error) {
                                  alert("Error in binding Item : " + error);
                                  },
                                  "PluginClass",
                                  "GetdataMethod",
                                  [selectqry]);
                    
                }
                else if (platform == 'Android') {
                    window.plugins.DataBaseHelper.select(selectqry, function(result) {
                                                         var array = $.map(result.array, function (item, index) {               
                                                                           return [[item.promotionquantity, item.rangelow,item.repeatingrange,item.itemtransactiontype]];            					
                                                                           });
                                                         
                                                         result = array;
                                                         promotionquantity = result[0][0];
                                                         rangelow = result[0][1];
                                                         repeatingrange = result[0][2];
                                                         itemtransactiontype = result[0][3];
                                                         
                                                          insertQry = "Insert Into promotiondetail(routekey,visitkey,transactionkey,itemcode,promotiontypecode,promotionquantity,promotionplannumber,assignmentkey,weighted,istemp,salesamount,issync,rangelow,repeatingrange,itemtransactiontype) values("+ sessionStorage.getItem('RouteKey') +","+ sessionStorage.getItem('VisitKey') +",0,"+ itemcode +",7,"+ promotionquantity  +","+ sessionStorage.getItem('plannumber') +","+ sessionStorage.getItem('plannumber') +",0,'true',0,0,"+ rangelow +","+ repeatingrange +","+itemtransactiontype+")";
                                                          console.log("promoinsert_review_2847"+ insertQry);
                                                          window.plugins.DataBaseHelper.insert(insertQry,function(result)
                                                                                              {
                                                                                              
                                                                                              updateinvoicefree(itemcode,qty);
                                                                                             
                                                                                              },
                                                                                              function()
                                                                                              {
                                                                                              console.warn("Error calling plugin");
                                                                                              });
                                                           
                                                         
                                                         },
                                                         function() {
                                                         console.warn("Error calling plugin");
                                                         });
                }
                
                
            }
            function updateinvoicefree(itemcode,qty)
            {
                var selectqry ="select count(*) as cnt from invoicedetail where itemcode="+itemcode+" and routekey="+sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +"";
                
                
                if (platform == 'iPad') {
                    Cordova.exec(function(result) {
                                  if(result[0][0] > 0)
                                  {
                                  var inserqry="Update invoicedetail set freesampleqty = "+ qty +",promoqty=" + qty + ",mdat = datetime() where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemcode +"";
                                  }
                                  else
                                  {
                                 var inserqry = "INSERT INTO invoicedetail(itemcode,routekey,transactionkey,visitkey,freesampleqty,istemp,mdat,salesprice,issync,salescaseprice,stdsalesprice,stdsalescaseprice,stdreturnprice,stdreturncaseprice,stdgoodreturnprice,stdgoodreturncaseprice,returnprice,returncaseprice,goodreturnprice,goodreturncaseprice,promoqty) select " + itemcode + "," + sessionStorage.getItem('RouteKey') + ",0," + sessionStorage.getItem("VisitKey") + "," + qty + ",'true',datetime(),defaultsalesprice,0,caseprice,defaultsalesprice,caseprice,defaultreturnprice,returncaseprice,defaultgoodreturnprice,defaultgoodreturncaseprice,defaultreturnprice,returncaseprice,defaultgoodreturnprice,defaultgoodreturncaseprice," + qty + " from itemmaster where actualitemcode="+itemcode;
                                  }
                                  
                                 Cordova.exec(function(result) 
                                                {    
                                                
                                                getFreeSampleList('true');
                                               
                                                },
                                                function(error) {
                                                navigator.notification.alert("Error inserting record in promotion detail");
                                                },
                                                "PluginClass", 
                                                "InsertUpdateMethod", 
                                                [inserqry]);
                                  },
                                  function(error) {
                                	  alert("Error in binding Item : " + error);
                                  },
                                  "PluginClass",
                                  "GetdataMethod",
                                  [selectqry]);
                    
                }
                else if (platform == 'Android') {
                    window.plugins.DataBaseHelper.select(selectqry, function(result) {
                                                         var result = $.map(result.array, function (item, index) {               
                                                                           return [[item.cnt]];            					
                                                                           });
                                                         
                                                         if(result[0][0] > 0)
                                                         {
                                                         var inserqry="Update invoicedetail set freesampleqty = "+ qty +",promoqty=" + qty + ",mdat = datetime() where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemcode +"";
                                                         }
                                                         else
                                                         {
                                                         var inserqry = "INSERT INTO invoicedetail(itemcode,routekey,transactionkey,visitkey,freesampleqty,istemp,mdat,salesprice,issync,salescaseprice,stdsalesprice,stdsalescaseprice,stdreturnprice,stdreturncaseprice,stdgoodreturnprice,stdgoodreturncaseprice,returnprice,returncaseprice,goodreturnprice,goodreturncaseprice,promoqty) select " + itemcode + "," + sessionStorage.getItem('RouteKey') + ",0," + sessionStorage.getItem("VisitKey") + "," + qty + ",'true',datetime(),defaultsalesprice,0,caseprice,defaultsalesprice,caseprice,defaultreturnprice,returncaseprice,defaultgoodreturnprice,defaultgoodreturncaseprice,defaultreturnprice,returncaseprice,defaultgoodreturnprice,defaultgoodreturncaseprice," + qty + "  from itemmaster where actualitemcode="+itemcode;
                                                         }
                                                         
                                                         
                                                         
                                                         window.plugins.DataBaseHelper.insert(inserqry,function(result)
                                                                                              {
                                                                                              
                                                                                              getFreeSampleList('true');
                                                                                              
                                                                                              },
                                                                                              function()
                                                                                              {
                                                                                              console.warn("Error calling plugin");
                                                                                              });
                                                         
                                                         
                                                         },
                                                         function() {
                                                         console.warn("Error calling plugin");
                                                         });
                }

            }
            function updateinvoicedetail1(itemcode,qty,flag)
            {
                var selectqry ="select count(*) as cnt from invoicedetail where itemcode="+itemcode+" and routekey="+sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +"";
                
                if (platform == 'iPad') {
                    Cordova.exec(function(result) {
                                  if(result[0][0] > 0)
                                  {
                                  // var inserqry="Update invoicedetail set
									// freesampleqty = "+ qty +",promoqty=" +
									// qty + ",mdat = datetime(),issync=0 where
									// routekey = "+
									// sessionStorage.getItem('RouteKey') +" and
									// visitkey = "+
									// sessionStorage.getItem('VisitKey') +" and
									// itemcode = "+ itemcode +"";
                                      var inserqry="Update invoicedetail set freesampleqty = 0,promoqty=0,mdat = datetime() where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemcode +"";
                                  }
                                  else
                                  {
                                  // var inserqry = "INSERT INTO
									// invoicedetail(itemcode,routekey,transactionkey,visitkey,freesampleqty,istemp,mdat,salesprice,issync,salescaseprice,stdsalesprice,stdsalescaseprice,stdreturnprice,stdreturncaseprice,stdgoodreturnprice,stdgoodreturncaseprice,returnprice,returncaseprice,goodreturnprice,goodreturncaseprice,promoqty)
									// select " + itemcode + "," +
									// sessionStorage.getItem('RouteKey') +
									// ",0," +
									// sessionStorage.getItem("VisitKey") + ","
									// + qty +
									// ",'true',datetime(),defaultsalesprice,0,caseprice,defaultsalesprice,caseprice,defaultreturnprice,returncaseprice,defaultgoodreturnprice,defaultgoodreturncaseprice,defaultreturnprice,returncaseprice,defaultgoodreturnprice,defaultgoodreturncaseprice,"
									// + qty + " from itemmaster where
									// actualitemcode="+itemcode;
                                  var inserqry = "INSERT INTO invoicedetail(itemcode,routekey,transactionkey,visitkey,freesampleqty,istemp,mdat,salesprice,issync,salescaseprice,stdsalesprice,stdsalescaseprice,stdreturnprice,stdreturncaseprice,stdgoodreturnprice,stdgoodreturncaseprice,returnprice,returncaseprice,goodreturnprice,goodreturncaseprice,promoqty) select " + itemcode + "," + sessionStorage.getItem('RouteKey') + ",0," + sessionStorage.getItem("VisitKey") + ",0,'true',datetime(),defaultsalesprice,0,caseprice,defaultsalesprice,caseprice,defaultreturnprice,returncaseprice,defaultgoodreturnprice,defaultgoodreturncaseprice,defaultreturnprice,returncaseprice,defaultgoodreturnprice,defaultgoodreturncaseprice," + qty + " from itemmaster where actualitemcode="+itemcode;
                                  }
                                
                                  Cordova.exec(function(result) 
                                                {    
                                                
                                                if(flag<3)
                                                {
                                                getFreeSampleList(0);
                                                }
                                                
                                                },
                                                function(error) {
                                                navigator.notification.alert("Error inserting record in promotion detail");
                                                },
                                                "PluginClass", 
                                                "InsertUpdateMethod", 
                                                [inserqry]);
                                  },
                                  function(error) {
                                  alert("Error in binding Item : " + error);
                                  },
                                  "PluginClass",
                                  "GetdataMethod",
                                  [selectqry]);
                    
                }
                else if (platform == 'Android') {
                    window.plugins.DataBaseHelper.select(selectqry, function(result) {
                                                         var result = $.map(result.array, function (item, index) {               
                                                                            return [[item.cnt]];            					
                                                                            });
                                                         
                                                         if(result[0][0] > 0)
                                                         {
                                                         var inserqry="Update invoicedetail set freesampleqty = 0,promoqty=0,mdat = datetime() where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemcode +"";
                                                         // alert(inserqry);
                                                          window.plugins.DataBaseHelper.insert(inserqry,function(result)
                                                                                              {
                                                                                              if(flag<3)
                                                                                              {
                                                                                              	//getFreeSampleList(1);
                                                                                              }
                                                                                              },
                                                                                              function()
                                                                                              {
                                                                                              console.warn("Error calling plugin");
                                                                                              });
                                                         }
                                                         else
                                                         {
                                                         var inserqry = "INSERT INTO invoicedetail(itemcode,routekey,transactionkey,visitkey,freesampleqty,istemp,mdat,salesprice,issync,salescaseprice,stdsalesprice,stdsalescaseprice,stdreturnprice,stdreturncaseprice,stdgoodreturnprice,stdgoodreturncaseprice,returnprice,returncaseprice,goodreturnprice,goodreturncaseprice,promoqty) select " + itemcode + "," + sessionStorage.getItem('RouteKey') + ",0," + sessionStorage.getItem("VisitKey") + ",0,'true',datetime(),defaultsalesprice,0,caseprice,defaultsalesprice,caseprice,defaultreturnprice,returncaseprice,defaultgoodreturnprice,defaultgoodreturncaseprice,defaultreturnprice,returncaseprice,defaultgoodreturnprice,defaultgoodreturncaseprice," + qty + " from itemmaster where actualitemcode="+itemcode;
                                                         if(qty > 0){
                                                          window.plugins.DataBaseHelper.insert(inserqry,function(result)
                                                                                              {
                                                                                              if(flag<3)
                                                                                              {
                                                                                              	//getFreeSampleList(1);
                                                                                              }
                                                                                              },
                                                                                              function()
                                                                                              {
                                                                                              console.warn("Error calling plugin");
                                                                                              });
								                                                         }
								                                                         else
								                                                         {
                                                                                              if(flag<3)
                                                                                              {
                                                                                              	//getFreeSampleList(1);
                                                                                              }
                                                         }
                                                          
                                                         }
                                                         
                                                         
                                                         
                                                        
                                                         
                                                         
                                                         },
                                                         function() {
                                                         console.warn("Error calling plugin");
                                                         });
                }
                
            }
            // ------------For Free Promotion
            function updatepromotionfreetemp1(itemcode,qty,flag,amount,availFlag,itemprice)
            {
                
                
                var selectqry ="select count(*) as cnt,Availability from promotionfreetemp where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemcode +" and promotionplannumber = "+ sessionStorage.getItem('plannumber') +"";
                
                
                if (platform == 'iPad') {
                    Cordova.exec(function(result) {
                                  if(result[0][0] > 0)
                                  {
                                  var inserqry="Update promotionfreetemp set promofreeqty = "+ qty +",itempcsprice="+amount+" where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemcode +" and promotionplannumber = "+ sessionStorage.getItem('plannumber') +" and Availablility="+availFlag;
                                  }
                                  else
                                  {
                                  var inserqry = "INSERT INTO promotionfreetemp(routekey,visitkey,transactionkey,promotionplannumber,itemcode,promofreeqty,itempcsprice,Availability) VALUES(" + sessionStorage.getItem('RouteKey') + ",0," + sessionStorage.getItem('plannumber') + "," + itemcode + "," + qty + ","+ amount +","+availFlag+")";
                                  }
                                 // alert(inserqry);
                                  Cordova.exec(function(result) 
                                                { 
                                                  updateinvoicedetail1(itemcode,qty,flag);
                                                },
                                                function(error) {
                                                navigator.notification.alert("Error inserting record in promotion detail");
                                                },
                                                "PluginClass", 
                                                "InsertUpdateMethod", 
                                                [inserqry]);
                                  },
                                  function(error) {
                                  alert("Error in binding Item : " + error);
                                  },
                                  "PluginClass",
                                  "GetdataMethod",
                                  [selectqry]);
                    
                }
                else if (platform == 'Android') {
                    window.plugins.DataBaseHelper.select(selectqry, function(result) {
                                                         var result = $.map(result.array, function (item, index) {               
                                                                            return [[item.cnt,item.Availability]];                                
                                                                            });
                                                         
                                                         if(result[0][0] > 0)
                                                         {
                                                        	 
	                                                        if(result[0][1]==1)
	                                                        {
	                                                        	availFlag=result[0][1];
	                                                        	
	                                                        }
                                                         var inserqry="Update promotionfreetemp set promofreeqty = "+ qty +",itempcsprice="+amount+",Availability="+availFlag+" where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemcode +" and promotionplannumber = "+ sessionStorage.getItem('plannumber') +"";
                                                         
                                                       
                                                          window.plugins.DataBaseHelper.insert(inserqry,function(result)
                                                                                              {
                                                        	  
                                                        	  										
                                                                                      				updateinvoicedetail1(itemcode,qty,flag);
                                                                                              },
                                                                                              function()
                                                                                              {
                                                                                              console.warn("Error calling plugin");
                                                                                              });
                                                        
                                                         }
                                                         else
                                                         {
                                                         var inserqry = "INSERT INTO promotionfreetemp(routekey,visitkey,transactionkey,promotionplannumber,itemcode,promofreeqty,itempcsprice,Availability,salesprice) VALUES(" + sessionStorage.getItem('RouteKey') + "," + sessionStorage.getItem('VisitKey') + ",0," + sessionStorage.getItem('plannumber') + "," + itemcode + "," + qty + ","+amount+","+availFlag+","+itemprice+")";
                                                         // alert(inserqry);
                                                         if(qty > 0 || availFlag=='1'){
                                                          window.plugins.DataBaseHelper.insert(inserqry,function(result)
                                                                                              {
                                                        	  									
                                                                                        			updateinvoicedetail1(itemcode,qty,flag);
                                                                                              },
                                                                                              function()
                                                                                              {
                                                                                              console.warn("Error calling plugin");
                                                                                              });
                                                         }
                                                        
                                                          
                                                         }
                                                       
                                                         },
                                                         function() {
                                                         console.warn("Error calling plugin");
                                                         });
                }
                
            }
            
            function upinvoicedetail()
            {
                var selectqry ="SELECT itemcode, SUM(promofreeqty) as promofreeqty, SUM(itempcsprice) as promofreeamount FROM promotionfreetemp where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" GROUP BY itemcode";
             	
                if (platform == 'iPad') {
                    Cordova.exec(function(result) {
                                  if(result[0][0] > 0)
                                  {
                                  // var inserqry="Update invoicedetail set
									// freesampleqty = "+ qty +",promoqty=" +
									// qty + ",mdat = datetime(),issync=0 where
									// routekey = "+
									// sessionStorage.getItem('RouteKey') +" and
									// visitkey = "+
									// sessionStorage.getItem('VisitKey') +" and
									// itemcode = "+ itemcode +"";
                                      var inserqry="Update invoicedetail set freesampleqty = 0,promoqty=0,mdat = datetime() where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemcode +"";    
                                  }
                                  else
                                  {
                                  // var inserqry = "INSERT INTO
									// invoicedetail(itemcode,routekey,transactionkey,visitkey,freesampleqty,istemp,mdat,salesprice,issync,salescaseprice,stdsalesprice,stdsalescaseprice,stdreturnprice,stdreturncaseprice,stdgoodreturnprice,stdgoodreturncaseprice,returnprice,returncaseprice,goodreturnprice,goodreturncaseprice,promoqty)
									// select " + itemcode + "," +
									// sessionStorage.getItem('RouteKey') +
									// ",0," +
									// sessionStorage.getItem("VisitKey") + ","
									// + qty +
									// ",'true',datetime(),defaultsalesprice,0,caseprice,defaultsalesprice,caseprice,defaultreturnprice,returncaseprice,defaultgoodreturnprice,defaultgoodreturncaseprice,defaultreturnprice,returncaseprice,defaultgoodreturnprice,defaultgoodreturncaseprice,"
									// + qty + " from itemmaster where
									// actualitemcode="+itemcode;
                                  var inserqry = "INSERT INTO invoicedetail(itemcode,routekey,transactionkey,visitkey,freesampleqty,istemp,mdat,salesprice,issync,salescaseprice,stdsalesprice,stdsalescaseprice,stdreturnprice,stdreturncaseprice,stdgoodreturnprice,stdgoodreturncaseprice,returnprice,returncaseprice,goodreturnprice,goodreturncaseprice,promoqty) select " + itemcode + "," + sessionStorage.getItem('RouteKey') + ",0," + sessionStorage.getItem("VisitKey") + ",0,'true',datetime(),defaultsalesprice,0,caseprice,defaultsalesprice,caseprice,defaultreturnprice,returncaseprice,defaultgoodreturnprice,defaultgoodreturncaseprice,defaultreturnprice,returncaseprice,defaultgoodreturnprice,defaultgoodreturncaseprice," + qty + " from itemmaster where actualitemcode="+itemcode;
                                  }
                                 // alert(inserqry);
                                  Cordova.exec(function(result) 
                                                {    
                                                
                                               
                                                
                                                },
                                                function(error) {
                                                navigator.notification.alert("Error inserting record in promotion detail");
                                                },
                                                "PluginClass", 
                                                "InsertUpdateMethod", 
                                                [inserqry]);
                                  },
                                  function(error) {
                                  alert("Error in binding Item : " + error);
                                  },
                                  "PluginClass",
                                  "GetdataMethod",
                                  [selectqry]);
                    
                }
                else if (platform == 'Android') {
                    var invamt=0;
                    window.plugins.DataBaseHelper.select(selectqry, function(result) {
                        if(result.array != undefined)
                        {
                                                         var result = $.map(result.array, function (item, index) {               
                                                                            return [[item.itemcode,item.promofreeqty,item.promofreeamount]];                                
                                                                            });
                                                         
                                                         for (i = 0; i < result.length; i++) 
                                                         {
                                                         var inserqry="Update invoicedetail set freesampleqty = "+result[i][1]+",promoqty=promoqty+"+result[i][1]+",mdat = datetime() where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ result[i][0] +"";
                                                          window.plugins.DataBaseHelper.insert(inserqry,function(result)
                                                                                              {
                                                                                              invamt=eval(eval(invamt)+eval(result[i][2]));
                                                                                              },
                                                                                              function()
                                                                                              {
                                                                                              console.warn("Error calling plugin");
                                                                                              });
                                                             }
                                                         	updateinvoiceheader(invamt);
                                                            }
					                        else{
					                            checkfreepromo();
					                            }
                     
                                                         },
                                                         function() {
                                                         console.warn("Error calling plugin");
                                                         });
                }
                
            }
            // -----------
            // ------------Invoiceheader
            function updateinvoiceheader(amt)
            {                    
                var Qry ="update invoiceheader set totalfreesampleamount="+amt+" where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +"";
                    console.log(Qry);
                    if(platform == 'iPad')
                    {
                        Cordova.exec(function(result) {
                            Deltemptable();
                        },
                        function(error) {
                            navigator.notification.alert(error);
                        },
                        "PluginClass",
                        "InsertUpdateMethod",
                        [Qry]);
                    }
                    else if(platform == 'Android')
                    {
                        window.plugins.DataBaseHelper.insert(Qry, function(result) {
                            // checkfreepromo();
                        	updatePromotionDetails();
                           
                        },
                        function() {
                            console.warn("Error calling plugin");
                        });
                    }                
            }
            function Deltemptable()
            {            
            	
            	// alert("in Temp");
                var Qry ="Delete from promotionfreetemp where routekey = "+ sessionStorage.getItem('RouteKey') +"";
                    console.log(Qry);
                    if(platform == 'iPad')
                    {
                        Cordova.exec(function(result) {
                            checkfreepromo(); 
                        },
                        function(error) {
                            navigator.notification.alert(error);
                        },
                        "PluginClass",
                        "InsertUpdateMethod",
                        [Qry]);
                    }
                    else if(platform == 'Android')
                    {
                        window.plugins.DataBaseHelper.insert(Qry, function(result) {
                        	updateLineLevelTax();  
                            
                        },
                        function() {
                            console.warn("Error calling plugin");
                        });
                    }                
            }
            function updatePromotionDetails()
            {
            	var promotionQry="SELECT itemcode, SUM(promofreeqty) as promofreeqty, SUM(itempcsprice) as promofreeamount,promotionplannumber FROM promotionfreetemp where routekey = "+sessionStorage.getItem('RouteKey')+" and visitkey = "+sessionStorage.getItem('VisitKey')+" GROUP BY itemcode";    
            	// alert(promotionQry);
            	
            	 if (platform == 'iPad') {
            		 
            		 // need to develop for ios
            		 
            	 }
            	 else if(platform=='Android')
            	 {
            		
                         window.plugins.DataBaseHelper.select(promotionQry, function(result) {
                             
                        	 if(result.array != undefined)
                             {
                                  var result = $.map(result.array, function (item, index) {               
                                                     return [[item.itemcode,item.promofreeqty,item.promofreeamount,item.promotionplannumber]];                                
                                                     });
                                 // alert(JSON.stringify(result));
                                  for (i = 0; i < result.length; i++) 
                                  {
    		                               var upateqry="Update promotiondetail set promotionquantity = "+result[i][1]+" where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ result[i][0] +" and promotionplannumber="+result[i][3]+"";
    		                               // alert(upateqry);
    		                               window.plugins.DataBaseHelper.insert(upateqry,function(result)
                                           {
                                           	
                                           },
                                           function()
                                           {
                                        	   console.warn("Error calling plugin");
                                           });
                                  }
                                  setInterval(function () {
                                	  
                                	  Deltemptable();
                                	  
                                  }, 500);
                                 	
                            }else
                            {
                            	 Deltemptable();	
                            }
                            
                             
                         },
                         function() {
                             console.warn("Error calling plugin");
                         });
                        
            		 
            		 
            		 
            	 }
            	
            	 
            	 
            }
            
            
            
            // ---Checking Qty------Start
            function Gettotfreecount()
            {                    
                // var Qry ="SELECT count(distinct promokeydetail.plannumber)
				// FROM promokeydetail inner join customermaster on
				// promokeydetail.promotionkey = customermaster.promotionkey
				// inner join promoplanheader on promokeydetail.plannumber =
				// promoplanheader.plannumber inner join promotiondetail on
				// promokeydetail.plannumber =
				// promotiondetail.promotionplannumber and
				// promotiondetail.routekey = " +
				// sessionStorage.getItem('RouteKey') + " and
				// promotiondetail.visitkey = " +
				// sessionStorage.getItem('VisitKey') + " and
				// promokeydetail.promotiontypecode = 7 where
				// customermaster.customercode = " +
				// sessionStorage.getItem('customerid') + " order by
				// promokeydetail.promotiontypecode,promokeydetail.plannumber";
                var Qry="SELECT distinct (SELECT count(distinct promokeydetail.plannumber) FROM promokeydetail inner join customermaster on promokeydetail.promotionkey = customermaster.promotionkey inner join promoplanheader on promokeydetail.plannumber = promoplanheader.plannumber inner join promotiondetail on promokeydetail.plannumber = promotiondetail.promotionplannumber and promotiondetail.routekey = " + sessionStorage.getItem('RouteKey') + " and promotiondetail.visitkey = " + sessionStorage.getItem('VisitKey') + " and promokeydetail.promotiontypecode = 7 where customermaster.customercode = " + sessionStorage.getItem('customerid') + " order by promokeydetail.promotiontypecode,promokeydetail.plannumber) as plan, (SELECT count(distinct promotionplannumber) from promotionfreetemp where routekey = " + sessionStorage.getItem('RouteKey') + " and visitkey = " + sessionStorage.getItem('VisitKey') + ") as tempplan";
                // var Qry="SELECT count(distinct promotionplannumber) from
				// promotionfreetemp";
                
                    console.log(Qry);
                    if(platform == 'iPad')
                    {
                        Cordova.exec(function(result) {
                            checkfreepromo(); 
                        },
                        function(error) {
                            navigator.notification.alert(error);
                        },
                        "PluginClass",
                        "InsertUpdateMethod",
                        [Qry]);
                    }
                    else if(platform == 'Android')
                    {
                        window.plugins.DataBaseHelper.select(Qry, function(result) {
                            
                            if(result.array != undefined)
                            {
                               var result = $.map(result.array, function (item, index) 
                                     {               
                                        return [[item.plan,item.tempplan]];                                
                                       });
                                      if(result[0][0]!=result[0][1])
                                             {
                                    	  		  getLangText("Promotion Not Given"); 
		                                          return false;
                                             }else
                                             {
                                                 CheckfreeAvailQty();
                                             }
                                                             
                            }
                           
                            
                        },
                        function() {
                            console.warn("Error calling plugin");
                        });
                    }                
            }
            // ---Checking Qty --------end
            // ---------Cheking Allowed Free Qty
            function Enterfreecount(plan,fqty)
            {                    
            
                // var Qry ="SELECT count(distinct promokeydetail.plannumber)
				// FROM promokeydetail inner join customermaster on
				// promokeydetail.promotionkey = customermaster.promotionkey
				// inner join promoplanheader on promokeydetail.plannumber =
				// promoplanheader.plannumber inner join promotiondetail on
				// promokeydetail.plannumber =
				// promotiondetail.promotionplannumber and
				// promotiondetail.routekey = " +
				// sessionStorage.getItem('RouteKey') + " and
				// promotiondetail.visitkey = " +
				// sessionStorage.getItem('VisitKey') + " and
				// promokeydetail.promotiontypecode = 7 where
				// customermaster.customercode = " +
				// sessionStorage.getItem('customerid') + " order by
				// promokeydetail.promotiontypecode,promokeydetail.plannumber";
            	
            	if(isOnQuantity==0){
            		var Qry="select ifnull(sum(promofreeqty),0) as tot,ifnull(sum(Availability),0) as availflag from promotionfreetemp where promotionplannumber=" + plan + " and routekey=" + sessionStorage.getItem('RouteKey') + " and visitkey=" + sessionStorage.getItem('VisitKey') + "";
            	}else{
            		var Qry="select ifnull(sum(promofreeqty*salesprice),0) as tot,ifnull(sum(Availability),0) as availflag from promotionfreetemp pm INNER JOIN itemmaster im on pm.itemcode=im.actualitemcode where promotionplannumber=" + plan + " and routekey=" + sessionStorage.getItem('RouteKey') + " and visitkey=" + sessionStorage.getItem('VisitKey') + "";
            		
            	}
                // var Qry12="SELECT distinct (SELECT count(distinct
				// promokeydetail.plannumber) FROM promokeydetail inner join
				// customermaster on promokeydetail.promotionkey =
				// customermaster.promotionkey inner join promoplanheader on
				// promokeydetail.plannumber = promoplanheader.plannumber inner
				// join promotiondetail on promokeydetail.plannumber =
				// promotiondetail.promotionplannumber and
				// promotiondetail.routekey = " +
				// sessionStorage.getItem('RouteKey') + " and
				// promotiondetail.visitkey = " +
				// sessionStorage.getItem('VisitKey') + " and
				// promokeydetail.promotiontypecode = 7 where
				// customermaster.customercode = " +
				// sessionStorage.getItem('customerid') + " order by
				// promokeydetail.promotiontypecode,promokeydetail.plannumber)
				// as plan, (SELECT count(distinct promotionplannumber) from
				// promotionfreetemp where routekey = " +
				// sessionStorage.getItem('RouteKey') + " and visitkey = " +
				// sessionStorage.getItem('VisitKey') + ") as tempplan";
               
                    console.log(Qry);
                    if(platform == 'iPad')
                    {
                        Cordova.exec(function(result) {
                            Gettotfreecount(); 
                        },
                        function(error) {
                            navigator.notification.alert(error);
                        },
                        "PluginClass",
                        "InsertUpdateMethod",
                        [Qry]);
                    }
                    else if(platform == 'Android')
                    {
                        window.plugins.DataBaseHelper.select(Qry, function(result) {
                            if(result.array != undefined)
                            {
                               var result = $.map(result.array, function (item, index) 
                                     {               
                                        return [[item.tot,item.availflag]];                                
                                       });
                               var dataf=result;
                               // Added by bindal on 25 Aug 2014
                               if(isOnQuantity==1?(eval(dataf[0][0])> eval(fqty)):(eval(dataf[0][0])!= eval(fqty)))
  	                           {	
                            	   
                            	   if(lockFlag=='1')
                                   {
                            		  if(eval(dataf[0][1])==0 && isLock=='1')
                              	     {
                            			 getLangText("Cant Continue");
                                  		 return false; 
                              			 
                              	     }else
                              	     {
                              	    	     getLangText("Given Qty Not Match With Allowed Free Qty");
		                                     return false;
                              	    	 
                              	     }	 
                              		 
                                   }
                            	   else if(eval(dataf[0][1])==1 && lockFlag=='0')
                              	 	{
                                	   Gettotfreecount();
                                	   
                              	 	}else
                              	 		{
                              	 		getLangText("Given Qty Not Match With Allowed Free Qty");
                              	 		
                              	 		}
                                	   
	                            	   
                            	   
	                               
                               }else
                                   {
                            	   
                            	   
                                   Gettotfreecount();
                                   }
                                                             
                            }
                                  
                        },
                        function() {
                            console.warn("Error calling plugin");
                        });
                    }                
            }
            // ---------End
            function continueprom()
            {
              
                if(promotionTypeCode=='7')
                    {
						if(freepromotionGR){
                			//checkCustomerPromo();
							updateLineLevelTax();
                		}else{
                    		Enterfreecount($('#txtPromoKey1').val(),$('#txFreeQty').val());
						}
                    }/*sujee added */ 
                else if(promotionTypeCode=='6')
                    	{
                    	updateLineLevelTax(promotionTypeCode);
                    	}
                
                else
                     {
                        CheckfreeAvailQty();
                      }
            }
            
             // Function for getting Available Qty
        function getAvailQty(arrFree)
        {
           
        	if(arrFree.length>0){ 
	            var arrItem=arrFree.shift();
	            var ItemNo=arrItem[6];
	            	
	            
	            var SalesQuery="select (select (ifnull(salesqty,0)-ifnull(returnqty,0)+ifnull(manualfreeqty,0)) from invoicedetail  where routekey="+sessionStorage.getItem('RouteKey')+" and visitkey="+sessionStorage.getItem('VisitKey')+" and itemcode="+ItemNo+") currqty,ifnull((select promofreeqty from promotionfreetemp prf inner join invoicedetail id   on id.itemcode=prf.itemcode   where id.routekey="+sessionStorage.getItem('RouteKey')+" and id.visitkey="+sessionStorage.getItem('VisitKey')+" and prf.visitkey="+sessionStorage.getItem('VisitKey')+" and id.itemcode="+ItemNo+" and prf.promotionplannumber!="+$('#txtPromoKey1').val()+") ,0) as qty";
	        	var SalesQty=0;
	        	var Prmqty=0;
	        	if (platform == 'iPad') {
	                Cordova.exec(function(result) {
	                   
	
	                	SalesQty = result[0][0];
	                    if(SalesQty > 0)
	                    {
	                    	
	                    }
	                },
	                function(error) {
	                    navigator.notification.alert(error);
	                },
	                "PluginClass",
	                "GetdataMethod",
	                [SalesQuery]);
	            }
	            else if (platform == 'Android') 
	            {
	                window.plugins.DataBaseHelper.select(SalesQuery, function(result) {                      	      	
	                   
	                	var result = $.map(result.array, function (item, index) 
	                            {               
	                                return [[item.currqty,item.qty]];                                
	                            });
	                    SalesQty = parseInt(result[0][0]);
	                    Prmqty=parseInt(result[0][1]);
	                    var Qry = "Select ((ifnull(inventorysummarydetail.loadqty,0)+ifnull(inventorysummarydetail.loadadjustqty,0)+ifnull(inventorysummarydetail.beginstockqty,0) + ifnull(inventorysummarydetail.loadaddqty,0) - ifnull(inventorysummarydetail.loadcutqty,0) -   ifnull(inventorysummarydetail.saleqty,0) + ifnull(inventorysummarydetail.returnqty,0) +ifnull(inventorysummarydetail.returnfreeqty,0) - ifnull(inventorysummarydetail.freesampleqty,0))/itemmaster.unitspercase) As LoadQty,(((ifnull(inventorysummarydetail.loadqty,0)+ifnull(inventorysummarydetail.loadadjustqty,0)+ifnull(inventorysummarydetail.beginstockqty,0) + ifnull(inventorysummarydetail.loadaddqty,0) - ifnull(inventorysummarydetail.loadcutqty,0) -  ifnull(inventorysummarydetail.saleqty,0) + ifnull(inventorysummarydetail.returnqty,0) + ifnull(inventorysummarydetail.returnfreeqty,0) - ifnull(inventorysummarydetail.freesampleqty,0))%itemmaster.unitspercase)) As LoadUnit,itemmaster.unitspercase,itemmaster.defaultsalesprice,(ifnull(inventorysummarydetail.loadqty,0) +ifnull(inventorysummarydetail.loadadjustqty,0)+ ifnull(inventorysummarydetail.loadaddqty,0) +ifnull(inventorysummarydetail.beginstockqty,0)- ifnull(inventorysummarydetail.loadcutqty,0) - ifnull(inventorysummarydetail.saleqty,0) + ifnull(inventorysummarydetail.returnqty,0) + ifnull(inventorysummarydetail.returnfreeqty,0) - ifnull(inventorysummarydetail.freesampleqty,0)) As AvailableQty from inventorysummarydetail inner join itemmaster on inventorysummarydetail.itemcode = itemmaster.actualitemcode  and inventorysummarydetail.routekey = " + sessionStorage.getItem('RouteKey') + " where itemmaster.actualitemcode = " + ItemNo
	                    console.log(Qry);
	                    if (platform == 'iPad') {
	                        Cordova.exec(function(result) {
	                           
	
	                           	var AvailQty = result[0][4];
	                            if(AvailQty > 0)
	                            {
	                            	
	                            }
	                        },
	                        function(error) {
	                            navigator.notification.alert(error);
	                        },
	                        "PluginClass",
	                        "GetdataMethod",
	                        [Qry]);
	                    }
	                    else if (platform == 'Android') 
	                    {
	                        window.plugins.DataBaseHelper.select(Qry, function(result) {                      	      	
	                           
	                            
	                           var AvailQty = result.array[0].AvailableQty;
	                           AvailQty = parseInt(eval(AvailQty)- eval(SalesQty)-eval(Prmqty));
	                          
	                           AvailableQtyArray.push(AvailQty);
	                           getAvailQty(arrFree);
	                        },
	        				function() {
	        				    console.warn("Error calling plugin");
	        				});
	                    }
	              	  
	                },
					function() {
					    console.warn("Error calling plugin");
					});
	            }
        	
        	}else{
        		
        		BindData(dataFreeSample);
        	}
            
        }
             
      
             
         function getLockSettings()
         {
        	var settingQuery="select tlockstatus from routemaster where routecode="+ sessionStorage.getItem("RouteCode")+"";
         	
         	if (platform == 'iPad') {
                 Cordova.exec(function(result) {
                  
                 },
                 function(error) {
                     navigator.notification.alert(error);
                 },
                 "PluginClass",
                 "GetdataMethod",
                 [settingQuery]);
             }
             else if (platform == 'Android') 
             {
                 window.plugins.DataBaseHelper.select(settingQuery, function(result) {                      	      	
                    
                 	var result = $.map(result.array, function (item, index) 
                    {               
                       return [[item.tlockstatus]];                                
                    });
                 	lockFlag = eval(result[0][0]);
                 	
                 	if(lockFlag=='')
                 		lockFlag='0';
                   
                 },
 				function() {
 				    console.warn("Error calling plugin");
 				});
             }
        	 
        	 
        	 
        	 
        	 
         }
         
         /*
     	*@method updateLineLevelTax
     	*Function to update the item level tax for each item
     	*/
     	function updateLineLevelTax(promotionTypeCode){ alert("updateLineLevelTax promotion review screen");
     		
     		var Qry="UPDATE invoicedetail  SET "
             	+"salesitemexcisetax=(CASE WHEN "+sessionStorage.getItem("applytax")+" = 0  THEN 0 ELSE (SELECT CASE WHEN COALESCE(im.defaultsalesprice,0)>0 and tm.taxbase = 2 THEN (COALESCE(sd.salesqty,0))*tm.taxpercentage/100 "
     				+"WHEN im.unitspercase>1 and tm.taxbase = 1 THEN ( ( cast(( (COALESCE(sd.salesqty,0))/ im.unitspercase) as int)*sd.salescaseprice) + (((COALESCE(sd.salesqty,0))% im.unitspercase)*sd.salesprice))*(tm.taxpercentage/100) "
     				+" WHEN im.unitspercase<=1 and tm.taxbase = 1 THEN (((COALESCE(sd.salesqty,0)))*sd.salesprice)*tm.taxpercentage/100 END"
     				+" as salesexcisetax FROM invoicedetail sd INNER JOIN itemmaster im ON "
     				+"sd.itemcode=im.actualitemcode AND sd.visitkey="+sessionStorage.getItem('VisitKey')
     				+" inner join taxmaster tm on tm.taxcode=im.itemtaxkey1 WHERE sd.itemcode=invoicedetail.itemcode) END),"				
     						
     			+" returnitemexcisetax=(CASE WHEN "+sessionStorage.getItem("applytax")+" = 0  THEN 0 ELSE (SELECT CASE WHEN COALESCE(im.defaultsalesprice,0)>0 and tm.taxbase = 2 THEN (COALESCE(sd.returnqty,0))*tm.taxpercentage/100 "
     				+"WHEN im.unitspercase>1 and tm.taxbase = 1 THEN ( ( cast(( (COALESCE(sd.returnqty,0))/ im.unitspercase) as int)*sd.goodreturncaseprice) + (((COALESCE(sd.returnqty,0))% im.unitspercase)*sd.goodreturnprice))*(tm.taxpercentage/100) "
     				+" WHEN im.unitspercase<=1 and tm.taxbase = 1 THEN (((COALESCE(sd.returnqty,0)))*sd.goodreturnprice)*tm.taxpercentage/100 END"
     				+" as returnexcisetax FROM invoicedetail sd INNER JOIN itemmaster im ON "
     				+"sd.itemcode=im.actualitemcode AND sd.visitkey="+sessionStorage.getItem('VisitKey')
     				+" inner join taxmaster tm on tm.taxcode=im.itemtaxkey1 WHERE sd.itemcode=invoicedetail.itemcode) END),"
     						
     			+"damageditemexcisetax=(CASE WHEN "+sessionStorage.getItem("applytax")+" = 0  THEN 0 ELSE (SELECT CASE WHEN COALESCE(im.defaultsalesprice,0)>0 and tm.taxbase = 2 THEN (COALESCE(sd.damagedqty,0))*tm.taxpercentage/100 "
     				+"WHEN im.unitspercase>1 and tm.taxbase = 1 THEN ( ( cast(( (COALESCE(sd.damagedqty,0))/ im.unitspercase) as int)*sd.returncaseprice) + (((COALESCE(sd.damagedqty,0))% im.unitspercase)*sd.returnprice))*(tm.taxpercentage/100)"
     				+" WHEN im.unitspercase<=1 and tm.taxbase = 1 THEN (((COALESCE(sd.damagedqty,0)))*sd.returnprice)*tm.taxpercentage/100 END"
     				+" as damagedexcisetax FROM invoicedetail sd INNER JOIN itemmaster im ON "
     				+"sd.itemcode=im.actualitemcode AND sd.visitkey="+sessionStorage.getItem('VisitKey')
     				+" inner join taxmaster tm on tm.taxcode=im.itemtaxkey1 WHERE sd.itemcode=invoicedetail.itemcode) END),"
     				
     			+"promoitemexcisetax=(CASE WHEN 0 = 0  THEN 0 ELSE (SELECT CASE WHEN COALESCE(im.defaultsalesprice,0)>0 and tm.taxbase = 2 THEN (COALESCE(sd.freesampleqty,0))*tm.taxpercentage/100 "
     				+"WHEN im.unitspercase>1 and tm.taxbase = 1 THEN ( ( cast(( (COALESCE(sd.freesampleqty,0))/ im.unitspercase) as int)*sd.salescaseprice) + (((COALESCE(sd.freesampleqty,0))% im.unitspercase)*sd.salesprice))*(tm.taxpercentage/100)"
     				+" WHEN im.unitspercase<=1 and tm.taxbase = 1 THEN (((COALESCE(sd.freesampleqty,0)))*sd.salesprice)*tm.taxpercentage/100 END "
     				+"as promofreeexcisetax FROM invoicedetail sd INNER JOIN itemmaster im ON "
     				+"sd.itemcode=im.actualitemcode AND sd.visitkey="+sessionStorage.getItem('VisitKey')
     				+" inner join taxmaster tm on tm.taxcode=im.itemtaxkey1 WHERE sd.itemcode=invoicedetail.itemcode) END),"
     				
     			+"fgitemexcisetax=(CASE WHEN 0 = 0 THEN 0 ELSE (SELECT CASE WHEN COALESCE(im.defaultsalesprice,0)>0 and tm.taxbase = 2 THEN(COALESCE(sd.manualfreeqty,0))*tm.taxpercentage/100 "
     				+"WHEN im.unitspercase>1 and tm.taxbase = 1 THEN ( ( cast(( (COALESCE(sd.manualfreeqty,0))/ im.unitspercase) as int)*sd.salescaseprice) + (((COALESCE(sd.manualfreeqty,0))% im.unitspercase)*sd.salesprice))*(tm.taxpercentage/100) "
     				+" WHEN im.unitspercase<=1 and tm.taxbase = 1 THEN (((COALESCE(sd.manualfreeqty,0)))*sd.salesprice)*tm.taxpercentage/100 END "
     				+" as focexcisetax FROM invoicedetail sd INNER JOIN itemmaster im ON "
     				+"sd.itemcode=im.actualitemcode AND sd.visitkey="+sessionStorage.getItem('VisitKey')
     				+" inner join taxmaster tm on tm.taxcode=im.itemtaxkey1 WHERE sd.itemcode=invoicedetail.itemcode) END),"
     			
     			 +"buybackexcisetax=(CASE WHEN 0 = 0  THEN 0 ELSE (SELECT CASE WHEN COALESCE(im.defaultsalesprice,0)>0 and tm.taxbase = 2 THEN(COALESCE(sd.returnfreeqty,0))*tm.taxpercentage/100 "
     					+"WHEN im.unitspercase>1 and tm.taxbase = 1 THEN ( ( cast(( (COALESCE(sd.returnfreeqty,0))/ im.unitspercase) as int)*sd.goodreturncaseprice) + (((COALESCE(sd.returnfreeqty,0))% im.unitspercase)*sd.goodreturnprice))*(tm.taxpercentage/100) "
     					+" WHEN im.unitspercase<=1 and tm.taxbase = 1 THEN (((COALESCE(sd.returnfreeqty,0)))*sd.goodreturnprice)*tm.taxpercentage/100 END "
     					+" as buybackexcisetax FROM invoicedetail sd INNER JOIN itemmaster im ON "
     					+"sd.itemcode=im.actualitemcode AND sd.visitkey="+sessionStorage.getItem('VisitKey')
     					+" inner join taxmaster tm on tm.taxcode=im.itemtaxkey1 WHERE sd.itemcode=invoicedetail.itemcode) END),"
     			
     				/*
     			+"salesitemgsttax=(CASE WHEN "+sessionStorage.getItem("applytax")+" = 0  THEN 0 ELSE (SELECT CASE WHEN COALESCE(im.defaultsalesprice,0)>0 and tm.taxbase = 2 THEN (COALESCE(sd.salesqty,0))*tm.taxpercentage/100 "
     				+"WHEN im.unitspercase>1 and tm.taxbase = 1 THEN (((cast(((COALESCE(sd.salesqty,0))/ im.unitspercase)as int)*sd.salescaseprice +(((COALESCE(sd.salesqty,0)))% im.unitspercase)*sd.salesprice))-coalesce(sd.promovalue,0))*tm.taxpercentage/100  "
     				+" WHEN im.unitspercase<=1 and tm.taxbase = 1 THEN (((((COALESCE(sd.salesqty,0)))*sd.salesprice))-coalesce(sd.promovalue,0))*tm.taxpercentage/100 END"
     				+" as salesitemgsttax FROM invoicedetail sd INNER JOIN itemmaster im ON "
     				+"sd.itemcode=im.actualitemcode AND sd.visitkey="+sessionStorage.getItem('VisitKey')
     				+" inner join taxmaster tm on tm.taxcode=im.itemtaxkey2 WHERE sd.itemcode=invoicedetail.itemcode) END),"	
     				
     				
     				

     						
     			+" returnitemgsttax=(CASE WHEN "+sessionStorage.getItem("applytax")+" = 0  THEN 0 ELSE (SELECT CASE WHEN COALESCE(im.defaultsalesprice,0)>0 and tm.taxbase = 2 THEN (COALESCE(sd.returnqty,0))*tm.taxpercentage/100 "
     				+"WHEN im.unitspercase>1 and tm.taxbase = 1 THEN  (CASE WHEN COALESCE(sd.returnqty,0)=0 THEN (cast(((COALESCE(sd.returnqty,0))/ im.unitspercase)as int)*sd.goodreturncaseprice +((COALESCE(sd.returnqty,0))% im.unitspercase)*sd.goodreturnprice) ELSE ((cast(((COALESCE(sd.returnqty,0))/ im.unitspercase)as int)*sd.goodreturncaseprice +((COALESCE(sd.returnqty,0))% im.unitspercase)*sd.goodreturnprice)-coalesce(sd.returnpromovalue,0))END)*tm.taxpercentage/100   "
     				+" WHEN im.unitspercase<=1 and tm.taxbase = 1 THEN (CASE WHEN COALESCE(sd.returnqty,0)=0 THEN ((COALESCE(sd.returnqty,0))*sd.goodreturnprice) ELSE (((COALESCE(sd.returnqty,0))*sd.goodreturnprice)-coalesce(sd.promovalue,0))END)*tm.taxpercentage/100 END"
     				+" as returnitemgsttax FROM invoicedetail sd INNER JOIN itemmaster im ON "
     				+"sd.itemcode=im.actualitemcode AND sd.visitkey="+sessionStorage.getItem('VisitKey')
     				+" inner join taxmaster tm on tm.taxcode=im.itemtaxkey2 WHERE sd.itemcode=invoicedetail.itemcode) END),"
     						
     			+"damageditemgsttax=(CASE WHEN "+sessionStorage.getItem("applytax")+" = 0  THEN 0 ELSE (SELECT CASE WHEN COALESCE(im.defaultsalesprice,0)>0 and tm.taxbase = 2 THEN (COALESCE(sd.damagedqty,0))*tm.taxpercentage/100 "
     				+"WHEN im.unitspercase>1 and tm.taxbase = 1 THEN (CASE WHEN z=0 THEN (cast(((COALESCE(sd.damagedqty,0))/ im.unitspercase)as int)*sd.returncaseprice +((COALESCE(sd.damagedqty,0))% im.unitspercase)*sd.returnprice) ELSE ((cast(((COALESCE(sd.damagedqty,0))/ im.unitspercase)as int)*sd.returncaseprice +((COALESCE(sd.damagedqty,0))% im.unitspercase)*sd.returnprice)-coalesce(sd.returnpromovalue,0))END)*tm.taxpercentage/100   "
     				+" WHEN im.unitspercase<=1 and tm.taxbase = 1 THEN (CASE WHEN COALESCE(sd.damagedqty,0)=0 THEN ((COALESCE(sd.damagedqty,0))*sd.returnprice) ELSE (((COALESCE(sd.damagedqty,0))*sd.returnprice)-coalesce(sd.promovalue,0))END)*tm.taxpercentage/100 END"
     				+" as damageditemgsttax FROM invoicedetail sd INNER JOIN itemmaster im ON "
     				+"sd.itemcode=im.actualitemcode AND sd.visitkey="+sessionStorage.getItem('VisitKey')
     				+" inner join taxmaster tm on tm.taxcode=im.itemtaxkey2 WHERE sd.itemcode=invoicedetail.itemcode) END),"
     				
     				// sujee added 12/07/2021 for exp tax 
				+"expiryitemgsttax=(CASE WHEN "+sessionStorage.getItem("applytax")+" = 0  THEN 0 ELSE (SELECT CASE WHEN COALESCE(im.defaultsalesprice,0)>0 and tm.taxbase = 2 THEN (COALESCE(sd.expiryqty,0))*tm.taxpercentage/100 "
					+"WHEN im.unitspercase>1 and tm.taxbase = 1 THEN (CASE WHEN COALESCE(sd.expiryqty,0)=0 THEN (cast(((COALESCE(sd.expiryqty,0))/ im.unitspercase)as int)*sd.returncaseprice +((COALESCE(sd.expiryqty,0))% im.unitspercase)*sd.returnprice) ELSE ((cast(((COALESCE(sd.expiryqty,0))/ im.unitspercase)as int)*sd.returncaseprice +((COALESCE(sd.expiryqty,0))% im.unitspercase)*sd.returnprice)-coalesce(sd.returnpromovalue,0))END)*tm.taxpercentage/100   "
					+" WHEN im.unitspercase<=1 and tm.taxbase = 1 THEN (CASE WHEN COALESCE(sd.expiryqty,0)=0 THEN ((COALESCE(sd.expiryqty,0))*sd.returnprice) ELSE (((COALESCE(sd.expiryqty,0))*sd.returnprice)-coalesce(sd.returnpromovalue,0))END)*tm.taxpercentage/100 END"
					+" as expiryitemgsttax FROM invoicedetail sd INNER JOIN itemmaster im ON "
					+"sd.itemcode=im.actualitemcode AND sd.visitkey="+sessionStorage.getItem('VisitKey')
					+" inner join taxmaster tm on tm.taxcode=im.itemtaxkey2 WHERE sd.itemcode=invoicedetail.itemcode) END),"
					
					*/
					
					+" salesitemgsttax=(CASE WHEN "+sessionStorage.getItem("applytax")+" = 0  THEN 0 ELSE (SELECT CASE WHEN COALESCE(im.defaultsalesprice,0)>0 and tm.taxbase = 2 THEN (COALESCE(sd.salesqty,0))*tm.taxpercentage/100 "
					+"WHEN im.unitspercase>1 and tm.taxbase = 1 THEN (((cast(((COALESCE(sd.salesqty,0))/ im.unitspercase)as int)*sd.salescaseprice +(((COALESCE(sd.salesqty,0)))% im.unitspercase)*sd.salesprice))-coalesce(sd.promovalue,0))*tm.taxpercentage/100  "
					+" WHEN im.unitspercase<=1 and tm.taxbase = 1 THEN (((((COALESCE(sd.salesqty,0)))*sd.salesprice))-coalesce(sd.promovalue,0))*tm.taxpercentage/100 END"
					+" as salesitemgsttax FROM invoicedetail sd INNER JOIN itemmaster im ON "
					+"sd.itemcode=im.actualitemcode AND sd.visitkey="+sessionStorage.getItem('VisitKey')
					+" inner join taxmaster tm on tm.taxcode=im.itemtaxkey2 WHERE sd.itemcode=invoicedetail.itemcode) END)," 
					
					+" returnitemgsttax=(CASE WHEN "+sessionStorage.getItem("applytax")+" = 0  THEN 0 ELSE (SELECT CASE WHEN COALESCE(im.defaultsalesprice,0)>0 and tm.taxbase = 2 THEN (COALESCE(sd.returnqty,0))*tm.taxpercentage/100 "
					+"WHEN im.unitspercase>1 and tm.taxbase = 1 THEN  (CASE WHEN COALESCE(sd.returnqty,0)=0 THEN (cast(((COALESCE(sd.returnqty,0))/ im.unitspercase)as int)*sd.goodreturncaseprice +((COALESCE(sd.returnqty,0))% im.unitspercase)*sd.goodreturnprice) ELSE ((cast(((COALESCE(sd.returnqty,0))/ im.unitspercase)as int)*sd.goodreturncaseprice +((COALESCE(sd.returnqty,0))% im.unitspercase)*sd.goodreturnprice)-coalesce(sd.returnpromovalue,0))END)*tm.taxpercentage/100   "
					+" WHEN im.unitspercase<=1 and tm.taxbase = 1 THEN (CASE WHEN COALESCE(sd.returnqty,0)=0 THEN ((COALESCE(sd.returnqty,0))*sd.goodreturnprice) ELSE (((COALESCE(sd.returnqty,0))*sd.goodreturnprice)-coalesce(sd.returnpromovalue,0))END)*tm.taxpercentage/100 END"
					+" as returnitemgsttax FROM invoicedetail sd INNER JOIN itemmaster im ON "
					+"sd.itemcode=im.actualitemcode AND sd.visitkey="+sessionStorage.getItem('VisitKey')
					+" inner join taxmaster tm on tm.taxcode=im.itemtaxkey2 WHERE sd.itemcode=invoicedetail.itemcode) END),"
					
					+"damageditemgsttax=(CASE WHEN "+sessionStorage.getItem("applytax")+" = 0  THEN 0 ELSE (SELECT CASE WHEN COALESCE(im.defaultsalesprice,0)>0 and tm.taxbase = 2 THEN (COALESCE(sd.damagedqty,0))*tm.taxpercentage/100 "
					+"WHEN im.unitspercase>1 and tm.taxbase = 1 THEN (CASE WHEN  sd.damagedqty=0 THEN (cast(((sd.damagedqty)/ im.unitspercase)as int)*sd.returncaseprice +((  sd.damagedqty)% im.unitspercase)*sd.returnprice) ELSE ((cast(((sd.damagedqty)/ im.unitspercase)as int)*sd.returncaseprice +(( sd.damagedqty)% im.unitspercase)*sd.returnprice)-coalesce(sd.damagepromoamount,0))END)*tm.taxpercentage/100   "
					+" WHEN im.unitspercase<=1 and tm.taxbase = 1 THEN (CASE WHEN COALESCE(sd.damagedqty,0)=0 THEN ((COALESCE(sd.damagedqty,0))*sd.returnprice) ELSE (((COALESCE(sd.damagedqty,0))*sd.returnprice)-coalesce(sd.damagepromoamount,0))END)*tm.taxpercentage/100 END"
					+" as damageditemgsttax FROM invoicedetail sd INNER JOIN itemmaster im ON "
					+" sd.itemcode=im.actualitemcode AND sd.visitkey="+sessionStorage.getItem('VisitKey')
					+" inner join taxmaster tm on tm.taxcode=im.itemtaxkey2 WHERE sd.itemcode=invoicedetail.itemcode) END),"
					
					+"expiryitemgsttax=(CASE WHEN "+sessionStorage.getItem("applytax")+" = 0  THEN 0 ELSE (SELECT CASE WHEN COALESCE(im.defaultsalesprice,0)>0 and tm.taxbase = 2 THEN (COALESCE(sd.expiryqty,0))*tm.taxpercentage/100 "
					+"WHEN im.unitspercase>1 and tm.taxbase = 1 THEN (CASE WHEN COALESCE(sd.expiryqty,0)=0 THEN (cast(((COALESCE(sd.expiryqty,0))/ im.unitspercase)as int)*sd.returncaseprice +((COALESCE(sd.expiryqty,0))% im.unitspercase)*sd.returnprice) ELSE ((cast(((COALESCE(sd.expiryqty,0))/ im.unitspercase)as int)*sd.returncaseprice +((COALESCE(sd.expiryqty,0))% im.unitspercase)*sd.returnprice)-coalesce(sd.damagepromoamount,0))END)*tm.taxpercentage/100   "
					+" WHEN im.unitspercase<=1 and tm.taxbase = 1 THEN (CASE WHEN COALESCE(sd.expiryqty,0)=0 THEN ((COALESCE(sd.expiryqty,0))*sd.returnprice) ELSE (((COALESCE(sd.expiryqty,0))*sd.returnprice)-coalesce(sd.damagepromoamount,0))END)*tm.taxpercentage/100 END"
					+" as expiryitemgsttax FROM invoicedetail sd INNER JOIN itemmaster im ON "
					+"sd.itemcode=im.actualitemcode AND sd.visitkey="+sessionStorage.getItem('VisitKey')
					+" inner join taxmaster tm on tm.taxcode=im.itemtaxkey2 WHERE sd.itemcode=invoicedetail.itemcode) END),"
					
     				
     			+"promoitemgsttax=(CASE WHEN 0 = 0   THEN 0 ELSE (SELECT CASE WHEN COALESCE(im.defaultsalesprice,0)>0 and tm.taxbase = 2 THEN (COALESCE(sd.freesampleqty,0))*tm.taxpercentage/100 "
     				+"WHEN im.unitspercase>1 and tm.taxbase = 1 THEN (((cast(((COALESCE(sd.freesampleqty,0))/ im.unitspercase)as int)*sd.salescaseprice +(((COALESCE(sd.freesampleqty,0)))% im.unitspercase)*sd.salesprice))-coalesce(sd.promovalue,0))*tm.taxpercentage/100  "
     				+" WHEN im.unitspercase<=1 and tm.taxbase = 1 THEN (((((COALESCE(sd.freesampleqty,0)))*sd.salesprice))-coalesce(sd.promovalue,0))*tm.taxpercentage/100 END"
     				+" as promoitemgsttax FROM invoicedetail sd INNER JOIN itemmaster im ON "
     				+"sd.itemcode=im.actualitemcode AND sd.visitkey="+sessionStorage.getItem('VisitKey')
     				+" inner join taxmaster tm on tm.taxcode=im.itemtaxkey2 WHERE sd.itemcode=invoicedetail.itemcode) END),"				
     				
     			+"fgitemgsttax=(CASE WHEN 0 = 0  THEN 0 ELSE (SELECT CASE WHEN COALESCE(im.defaultsalesprice,0)>0 and tm.taxbase = 2 THEN (COALESCE(sd.manualfreeqty,0))*tm.taxpercentage/100 "
     				+"WHEN im.unitspercase>1 and tm.taxbase = 1 THEN (((cast(((COALESCE(sd.manualfreeqty,0))/ im.unitspercase)as int)*sd.salescaseprice +(((COALESCE(sd.manualfreeqty,0)))% im.unitspercase)*sd.salesprice))-coalesce(sd.promovalue,0))*tm.taxpercentage/100  "
     				+" WHEN im.unitspercase<=1 and tm.taxbase = 1 THEN (((((COALESCE(sd.manualfreeqty,0)))*sd.salesprice))-coalesce(sd.promovalue,0))*tm.taxpercentage/100 END"
     				+" as fgitemgsttax FROM invoicedetail sd INNER JOIN itemmaster im ON "
     				+"sd.itemcode=im.actualitemcode AND sd.visitkey="+sessionStorage.getItem('VisitKey')
     				+" inner join taxmaster tm on tm.taxcode=im.itemtaxkey2 WHERE sd.itemcode=invoicedetail.itemcode) END),"				
     				
     			+"buybackgsttax=(CASE WHEN 0 = 0    THEN 0 ELSE (SELECT CASE WHEN COALESCE(im.defaultsalesprice,0)>0 and tm.taxbase = 2 THEN (COALESCE(sd.returnfreeqty,0))*tm.taxpercentage/100 "
     				+"WHEN im.unitspercase>1 and tm.taxbase = 1 THEN (((cast(((COALESCE(sd.returnfreeqty,0))/ im.unitspercase)as int)*sd.salescaseprice +(((COALESCE(sd.returnfreeqty,0)))% im.unitspercase)*sd.salesprice))-coalesce(sd.promovalue,0))*tm.taxpercentage/100  "
     				+" WHEN im.unitspercase<=1 and tm.taxbase = 1 THEN (((((COALESCE(sd.returnfreeqty,0)))*sd.salesprice))-coalesce(sd.promovalue,0))*tm.taxpercentage/100 END"
     				+" as buybackgsttax FROM invoicedetail sd INNER JOIN itemmaster im ON "
     				+"sd.itemcode=im.actualitemcode AND sd.visitkey="+sessionStorage.getItem('VisitKey')
     				+" inner join taxmaster tm on tm.taxcode=im.itemtaxkey2 WHERE sd.itemcode=invoicedetail.itemcode) END)"		
     				
     				+" where visitkey = "+sessionStorage.getItem('VisitKey')+" and routekey = " + sessionStorage.getItem('RouteKey') + "";
     				
     		console.log("Qry%%%%%"+Qry);	
     				
     		if (platform == 'Android') 
             {
                 window.plugins.DataBaseHelper.select(Qry, function(result) {                      	      	
                    
                 	//updateTotalItemLevelTax();
                	 updateRoundingInvoiceDetails();
                   
                 },
     			function() {
     			    console.warn("Error calling plugin");
     			});
             }
     	}
     	function updateRoundingInvoiceDetails(){
    		
   		 var decimalplace = sessionStorage.getItem("decimalplace");
   		 if(decimalplace==null || decimalplace==undefined){
   			 decimalplace=2;
   		 }
   		 $.mobile.hidePageLoadingMsg();  
   		 $.mobile.showPageLoadingMsg(); 
   		try{
   			//org qry sujee commented 12/07/2021
   			//var Qry="select itemcode,ifnull(salesitemgsttax,0) salesitemgsttax,ifnull(salesitemexcisetax,0) salesitemexcisetax,ifnull(returnitemexcisetax,0) returnitemexcisetax,ifnull(returnitemgsttax,0) returnitemgsttax,ifnull(damageditemexcisetax,0) damageditemexcisetax,ifnull(damageditemgsttax,0) damageditemgsttax,ifnull(fgitemexcisetax,0) fgitemexcisetax,ifnull(fgitemgsttax,0) fgitemgsttax,ifnull(promoitemexcisetax,0) promoitemexcisetax,ifnull(promoitemgsttax,0) promoitemgsttax from invoicedetail where visitkey="+sessionStorage.getItem("VisitKey");
   			
   			var Qry="select itemcode,ifnull(salesitemgsttax,0) salesitemgsttax,ifnull(salesitemexcisetax,0) salesitemexcisetax,ifnull(returnitemexcisetax,0) returnitemexcisetax,ifnull(returnitemgsttax,0) returnitemgsttax,ifnull(damageditemexcisetax,0) damageditemexcisetax,ifnull(damageditemgsttax,0) damageditemgsttax,ifnull(fgitemexcisetax,0) fgitemexcisetax,ifnull(fgitemgsttax,0) fgitemgsttax,ifnull(promoitemexcisetax,0) promoitemexcisetax,ifnull(promoitemgsttax,0) promoitemgsttax,ifnull(expiryitemgsttax,0) expiryitemgsttax from invoicedetail where visitkey="+sessionStorage.getItem("VisitKey");
   			window.plugins.DataBaseHelper.select(Qry, function(result) {
   		         
   		         if(!$.isEmptyObject(result))
   		         {
   		        	 $.each(result.array, function(index, item) {
   		        		 
   		        		 var salesitemexcisetax=eval(item.salesitemexcisetax).toFixed(decimalplace);
   		        		 var salesitemgsttax=eval(item.salesitemgsttax).toFixed(decimalplace);
   		        		 var returnitemexcisetax=eval(item.returnitemexcisetax).toFixed(decimalplace);
   		        		 var returnitemgsttax=eval(item.returnitemgsttax).toFixed(decimalplace);
   		        		 var damageditemexcisetax=eval(item.damageditemexcisetax).toFixed(decimalplace);
   		        		 var damageditemgsttax=eval(item.damageditemgsttax).toFixed(decimalplace);
   		        		
   		        		 var fgitemexcisetax=eval(item.fgitemexcisetax).toFixed(decimalplace);
   		        		 var fgitemgsttax=eval(item.fgitemgsttax).toFixed(decimalplace);
   		        		 var promoitemexcisetax=eval(item.promoitemexcisetax).toFixed(decimalplace);
   		        		 var promoitemgsttax=eval(item.promoitemgsttax).toFixed(decimalplace); 
   		        		 var expiryitemgsttax=eval(item.expiryitemgsttax).toFixed(decimalplace);
   		        		 var itemcode=item.itemcode;
   		        		 var QryUpdate="UPDATE invoicedetail set salesitemexcisetax='"+salesitemexcisetax+"',salesitemgsttax='"+salesitemgsttax+"',returnitemexcisetax='"+returnitemexcisetax+"',returnitemgsttax='"+returnitemgsttax+"',damageditemexcisetax='"+damageditemexcisetax+"',damageditemgsttax='"+damageditemgsttax+"',fgitemexcisetax='"+fgitemexcisetax+"',fgitemgsttax='"+fgitemgsttax+"',promoitemexcisetax='"+promoitemexcisetax+"',promoitemgsttax='"+promoitemgsttax+"',expiryitemgsttax='"+expiryitemgsttax+"' where visitkey="+sessionStorage.getItem("VisitKey")+" and itemcode="+itemcode; 
   		        			 		
   		    			window.plugins.DataBaseHelper.insert(QryUpdate, function(result1) {
   		    				
   		    				if(index==(result.array.length-1)){
   		    					$.mobile.hidePageLoadingMsg();  
   		    					updateTotalItemLevelTax(promotionTypeCode);
   		    				}
   		    				
   		    		    },
   		    		    function() {
   		    		    console.warn("Error calling plugin");
   		    		    });
   		        		 
   		        		 
   		        		 	
   		        	 });
   		         }
   		     	},
   				function() {
   				    console.warn("Error calling plugin");
   				});
   			
   			
   			
   		}catch(e){
   			$.mobile.hidePageLoadingMsg();  
   			updateTotalItemLevelTax(promotionTypeCode);
   		} 
   		
   		
   		
   	}
     	/*
     	*@method updateTotalItemLevelTax
     	*Function to update invoiceheader table itemlinetaxamount field with total line tax amount
     	*/
     	function updateTotalItemLevelTax(promotionTypeCode){
     		 var decimalplace = sessionStorage.getItem("decimalplace");
     		 if(decimalplace==null || decimalplace==undefined){
     			 decimalplace=2;
     		 }

     		 // sujee commented org 11/07/2021 
    /* 	 	var Qry="UPDATE invoiceheader set itemlinetaxamount =ROUND(((Select COALESCE(SUM(ROUND(salesitemexcisetax,"+decimalplace+")),0) +COALESCE(SUM(ROUND(salesitemgsttax,"+decimalplace+")),0)-COALESCE(SUM(ROUND(returnitemexcisetax,"+decimalplace+")),0) -COALESCE(SUM(ROUND(returnitemgsttax,"+decimalplace+")),0) -COALESCE(SUM(ROUND(damageditemexcisetax,"+decimalplace+")),0)-COALESCE(SUM(ROUND(damageditemgsttax,"+decimalplace+")),0) + COALESCE(SUM(ROUND(fgitemexcisetax,"+decimalplace+")),0) +COALESCE(SUM(ROUND(fgitemgsttax,"+decimalplace+")),0) +COALESCE(SUM(ROUND(promoitemexcisetax,"+decimalplace+")),0) +COALESCE(SUM(ROUND(promoitemgsttax,"+decimalplace+")),0) -COALESCE(SUM(ROUND(buybackexcisetax,"+decimalplace+")),0) -COALESCE(SUM(ROUND(buybackgsttax,"+decimalplace+")),0)  from invoicedetail "
     		+"where invoicedetail.routekey="+sessionStorage.getItem('RouteKey')
     		+" and invoicedetail.visitkey="+sessionStorage.getItem('VisitKey')+")),"+decimalplace+")"
     		+"where routekey="+sessionStorage.getItem('RouteKey')+" and visitkey="+sessionStorage.getItem('VisitKey');
     	*/
     	
     	var Qry="UPDATE invoiceheader set itemlinetaxamount =ROUND(((Select COALESCE(SUM(ROUND(salesitemexcisetax,"+decimalplace+")),0) +COALESCE(SUM(ROUND(salesitemgsttax,"+decimalplace+")),0)-COALESCE(SUM(ROUND(returnitemexcisetax,"+decimalplace+")),0) -COALESCE(SUM(ROUND(returnitemgsttax,"+decimalplace+")),0) -COALESCE(SUM(ROUND(damageditemexcisetax,"+decimalplace+")),0)-COALESCE(SUM(ROUND(damageditemgsttax,"+decimalplace+")),0)-COALESCE(SUM(ROUND(expiryitemgsttax,"+decimalplace+")),0) + COALESCE(SUM(ROUND(fgitemexcisetax,"+decimalplace+")),0) +COALESCE(SUM(ROUND(fgitemgsttax,"+decimalplace+")),0) +COALESCE(SUM(ROUND(promoitemexcisetax,"+decimalplace+")),0) +COALESCE(SUM(ROUND(promoitemgsttax,"+decimalplace+")),0) -COALESCE(SUM(ROUND(buybackexcisetax,"+decimalplace+")),0) -COALESCE(SUM(ROUND(buybackgsttax,"+decimalplace+")),0)  from invoicedetail "
 		+"where invoicedetail.routekey="+sessionStorage.getItem('RouteKey')
 		+" and invoicedetail.visitkey="+sessionStorage.getItem('VisitKey')+")),"+decimalplace+")"
 		+"where routekey="+sessionStorage.getItem('RouteKey')+" and visitkey="+sessionStorage.getItem('VisitKey');

     		if (platform == 'Android') 
             {
                 window.plugins.DataBaseHelper.select(Qry, function(result) {            
                	updateTotalInvoiceLevelTax(promotionTypeCode);
                   
                 },
     			function() {
     			    console.warn("Error calling plugin");
     			});
             }
     	}
     	/*
     	*@method updateTotalInvoiceLevelTax
     	*Function to check and update invoice level tax
     	*/
     	function updateTotalInvoiceLevelTax(promotionTypeCode){
     		
     		var Qry="UPDATE invoiceheader set totaltaxesamount= (select taxAmount from "
     		+"(select cm.custtaxkey1,tm.taxtype,tm.taxpercentage,case when tm.taxtype=1 then "
     		+" ( (COALESCE(ih.totalsalesamount,0)-COALESCE(ih.totalpromoamount,0)+COALESCE(ih.itemlinetaxamount,0) +COALESCE(ih.diffround,0))*tm.taxpercentage/100)  else 0 END taxAmount " 
     		+"from customermaster cm inner join taxmaster  tm on cm.custtaxkey1=tm.taxcode "
     		+"inner join invoiceheader ih on routekey="+sessionStorage.getItem('RouteKey')
     		+" and visitkey="+sessionStorage.getItem('VisitKey')+" where  cm.customercode="+sessionStorage.getItem('customerid')
     		+") where routekey="+sessionStorage.getItem('RouteKey')+" and visitkey="+sessionStorage.getItem('VisitKey')+")";
     		
     		if (platform == 'Android') 
             {
                 window.plugins.DataBaseHelper.select(Qry, function(result) {           
                 	//checkfreepromo(); // org line sujee commented 
                 	if(promotionTypeCode=='6')
                 		{
                 		 CheckfreeAvailQty();
                 		}else {
                 			checkfreepromo();
                 		}
                 },
     			function() {
     			    console.warn("Error calling plugin");
     			});
             }
     	}
           
        </script>

	</div>
</body>
</html>
