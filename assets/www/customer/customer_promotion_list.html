<!--
 '  Created By   : Nidhi Dedania
 '  Created Date : 2/2/2011
 '  Description  : This page is used for promotion list
-->
<!DOCTYPE html>
<html>
<head>
    <title>HOME</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0;maximum-scale=1.0;user-scalable=0; target-densitydpi=device-dpi">
	
    <meta name="format-detection" content="telephone=no">
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="../css/en.css" lang="en" />
    <link rel="stylesheet" href="../css/jquery.mobile-1.0.min.css" />
    <link type="text/css"  href="../css/jquery.mobile.datebox.min.css" rel="stylesheet" />
    <link rel="stylesheet" media="only screen and (min-width: 1200px) and (max-width: 1500px)"
        href="../css/style_1400.css" />
    <link rel="stylesheet" media="only screen and (min-width: 1000px) and (max-width: 1200px)"
        href="../css/style_1200.css" />
    <link rel="stylesheet" media="only screen and (min-width: 700px) and (max-width: 800px)"
        href="../css/style_800.css" />
    <link rel="stylesheet" media="only screen and (min-width: 601px) and (max-width: 699px)"
        href="../css/style_700.css" />
    <link rel="stylesheet" media="only screen and (min-width: 320px) and (max-width: 600px)"
        href="../css/style_600.css" />

    <script type="text/javascript" src="../js/jquery.js"></script>

    <script type="text/javascript" src="../js/jquery.mobile-1.0.js"></script>

    <script type="text/javascript" src="../js/common.js"></script>

    <script>
if (navigator.userAgent.toLowerCase().match(/android/)) {
document.write('<script charset="utf-8" src="../cordova-2.0.0.js"><\/script>');
document.write('<script charset="utf-8" src="../directoryListing.js"><\/script>');
} else if (navigator.userAgent.toLowerCase().match(/iphone/) || navigator.userAgent.toLowerCase().match(/ipad/)) {
document.write('<script charset="utf-8" src="../cordova-1.5.0.js"><\/script>');
}
    </script>

    <script type="text/javascript" src="../js/jquery.json-2.3.min.js"></script>

    <script type="text/javascript" src="../js/jquery.mobile.datebox.min.js"></script>

    <script src="../LangJS/jquery-lang.js" charset="utf-8" type="text/javascript"></script>

    <script src="../LangJS/langpack/AR.js" charset="utf-8" type="text/javascript" lang="en"></script>
        <link rel="stylesheet" type="text/css" href="../css/jquery.mobile.simpledialog.css" />
        
        <script type="text/javascript" src="../js/jquery.mobile.simpledialog.js"></script>
    
</head>
<body>
    <div data-role="page" data-theme="d" data-title="HOME" id="myPage">
        <div>
            <img title="" alt="" src="../images/bg.png" id="background">
        </div>
        <div data-role="header" data-position="inline" id="bgclheader">
            <!--<a href="index.html"   id="Back_inner">test</a>-->
            <a id="Back_inner" href="#" rel="external" lang="en" onclick="localStorage.promooveride=0">Back</a><div class="wrapper"><div class="card_content"><div><img title="" alt="" data-pushbar-target="left"  src="../images/icons8-menu-50.png" id="setting"></div></div></div> 
            <h1 lang="en">
                Customer Promotion</h1>
            <a href="#" id="lang_inner">EN</a>
        </div>
        <div data-role="content" class="centerboxInvReq">
            <div class="com_div comm">
                <div style="width:40%;display:none;" id="promodiv"><input id="btnSubmit1" type="button" value="Override" onclick="PopupPasswordEntry(this.id,'customer_promotion_list.html',tblPassword.innerHTML,'customer_promotion_list.html');" lang="en"/></div>
                <div class="tblBox tbltd" id="contentWrapper">
                    <div class="promotblHeader tblHeader">
                        <table id="tblHeaderContent" width="100%" cellpadding="10" cellspacing="0">
                            <tr style="font-size:22px;">
                                <th width="10%">
                                </th>
                                <th width="20%" class="leftAlign" lang="en"> Key</th>
                                <th width="60%" lang="en" class="leftAlign last">
                                    Promo Description
                                </th>
                                <th width="15%" style="display:none;">
                                </th>
                            </tr>
                        </table>
                    </div>
                    <div class=" promoheaderadj  route_table_height item promotionheight">
                        <table border="2" width="100%" cellpadding="0" cellspacing="0" id="tbl1" data-role="none">
                            <tbody>
                                <tr style="height:0px;font-size:22px;">
                                    <td width="10%" style="height:0px;">
                                    </td>
                                    <td width="20%" style="height:0px;">
                                    </td>
                                    <td width="60%" style="height:0px;">
                                    </td>
                                    <td width="15%"  style="display:none;">
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="leftbottomMenu">
                <a id="linkDetail" href="#" class="enableText" rel="external" onclick="checkRecordCount(this.id)">
                    <div class="MenuPositiondone">
                        <div class="MenuTextPos">
                            <img  class="bottomicon" src="../images/detail.png" alt="Option" /></div>
                        <div id="lnktextDetail" class="MenuTextPos MenuText" lang="en">
                            Details</div>
                    </div>
                </a><a id="linkContinue" href="#" class="enableText" rel="external" >
                    <div class="MenuPositionright">
                        <div class="MenuTextPos">
                            <img  class="bottomicon" src="../images/icn-select.png" alt="Add" /></div>
                        <div id="lnktextContinue" class="MenuTextPos MenuText" lang="en">
                            Continue</div>
                    </div>
                </a><a href="#" class="enableText" rel="external" id="exit" onclick="localStorage.promooveride=0">
                    <div class="MenuPosition ">
                        <div class="MenuTextPos">
                            <img  class="bottomicon" src="../images/no.png" alt="Exit" /></div>
                        <div class="MenuTextPos MenuText" lang="en">
                            Cancel</div>
                    </div>
                </a>
            </div>
            <table id="tblPassword" border="0" cellpadding="2" cellspacing="0" width="100%;"
                style="display: none;">
                <tr>
                    <th class="tblHeader captionLabel leftAlign popupTitle" colspan="2" lang="en">
                        Password Entry
                    </th>
                </tr>
                <tr class="popupRow">
                    <td colspan="2">
                        &nbsp;
                    </td>
                </tr>
                <tr class="popupRow">
                    <td  colspan="2" colspan="2" class="popupSubTitle" lang="en">                                       
                        Promotion
                    </td>                
                </tr>
                <tr class="popupRow">
                    <td colspan="2" lang="en" class="popupInfo">
                        Please Enter The Security Password
                    </td>
                </tr>
                <tr class="popupRow">
                    <td colspan="2">
                        <input id="txtPassword" type="password" pattern="\d*" value="" maxlength="10" class="textWidth textFont passwordCenter"  />
                        <label id="lblMessage" lang="en" style="display:none">Enter Correct Password</label> 
                    </td>
                </tr>
                <tr class="popupRow">
                    <td style="width: 50%;">
                        <input id="btnSubmit" type="button" value="Submit" onclick="VerifyPassword('btnSubmit','customer_promotion_list.html',tblPassword.innerHTML);" data-role="none"
                        lang="en" />
                    </td>
                    <td style="width: 50%;">
                        <input id="btnCancel" type="button" rel="close" value="Cancel" onclick="ClearPassword();"
                        data-role="none" lang="en" />
                    </td>
                </tr>
            </table>
        </div>
        <div id="f1" data-role="footer" class="ui-bar">
            <div class="footer">
                <div class="leftfooter">
                    09 November 2011</div>
                <div class="rightfooter">
                    Mirnah Technology Systems</div>
            </div>
        </div>
        <div class='ui-loader-background'></div>
        <div id="f2" data-role="footer" style="bottom: 0; position: absolute;">
         <aside data-pushbar-id="left" class="pushbar from_left">
		<div class="title"><span data-pushbar-close class="close push_right"></span>
			<span id="txtroute"></span>
		</div>

		<ul class="menu">
		<li style="margin-bottom: 0 !important;" > 
		<img title="" alt="" src="../images/startday-icon.png" id="day"  class="leftmenu" >
		 <a href="#"
						class="ui-btn-active" rel="external" id="day" data-icon="custom"  
						lang="en" onclick="footerredict('../startofday/startofday.html')">Start day</a></li>
					<li style="margin-bottom: 0 !important;">
					 <img title="" alt="" src="../images/Inventoryicon.png" id="inve"  class="leftmenu">
					 <a href="#" id="inve"
						rel="external" data-icon="custom" lang="en"
						onclick="footerredict('../inventory/inventory.html')">Inventory</a></li>
					<li style="margin-bottom: 0 !important;">
					 <img title="" alt="" src="../images/customer-icon.png" id="cust" class="leftmenu">
					 <a href="#"
						rel="external" id="cust" data-icon="custom" lang="en"
						onclick="footerredict('../customer/customer_operation.html')">Customer</a></li>
					<li style="margin-bottom: 0 !important;">
					<img title="" alt="" src="../images/Money-icon.png" id="sett" class="leftmenu">
					<a href="#"
						rel="external" id="sett" data-icon="custom" lang="en"
						onclick="footerredict('../settlement/managesettlement.html')">Settlement</a></li>
					<li style="margin-bottom: 0 !important;">
					<img title="" alt="" src="../images/expense-icon.png" id="expe" class="leftmenu">
					<a href="#"
						rel="external" id="expe" data-icon="custom" lang="en"
						onclick="footerredict('../settlement/expenseentry.html')">Expenses</a></li>
					<li style="margin-bottom: 0 !important;">
					<img title="" alt="" src="../images/information-icon.png" id="info" class="leftmenu" >
					<a href="#"
						rel="external" id="info" data-icon="custom" lang="en"  
						onclick="footerredict('../information/information.html')">Information</a></li>
					<li style="margin-bottom: 0 !important; ">
					 <img title="" alt="" src="../images/user-settings-icon.png" id="setup" class="leftmenu">
					 <a href="#" rel="external" id="setup" data-icon="custom" lang="en"
						onclick="footerredict('../utilities/utilities.html')">Utilities</a></li>
		</ul>

	</aside>
            <div data-role="navbar" data-iconpos="top" data-grid="f">
                <ul>
                    <li style="margin-bottom:0 !important;"><a href="#" rel="external" id="day" data-icon="custom" lang="en" onclick="footerredict('../startofday/startofday.html')">Start day</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" id="inve" rel="external" data-icon="custom" lang="en" onclick="footerredict('../inventory/inventory.html')">Inventory</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" class="ui-btn-active" rel="external" id="cust" data-icon="custom" lang="en">Customer</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" rel="external" id="sett" data-icon="custom" lang="en" onclick="footerredict('../settlement/managesettlement.html')">Settlement</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" rel="external" id="expe" data-icon="custom" lang="en" onclick="footerredict('../settlement/expenseentry.html')">Expenses</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" rel="external" id="info" data-icon="custom" lang="en" onclick="footerredict('../information/information.html')">Information</a></li>
			        <li style="margin-bottom:0 !important; width:14.0%"><a href="#" rel="external" id="setup" data-icon="custom" lang="en" onclick="footerredict('../utilities/utilities.html')">Utilities</a></li>
                </ul>
            </div>
        </div>


        <script type="text/javascript" language="javascript">
            var data = null,dataItem = null;
            var index = 0;
            var countRecord = 0;
            var promotionAmount = 0;
            var repeatingrange=0;
             var platform='';
            var itemIndex = 0,rangeBasis = 0,promotionTypeCode = 0,rangeLow = 0,rangeHigh = 0,dataAmount = null;
            var totalpromo = 0,totalfree = 0,promotiontype = 0,totalInvoiceAmount = 0;
            var flag = false;
            var arrayPlan = new Array();
            var tempPlan = 0;
            var count1 = 0;
            var flagpromo = false,flagpromo2 = false;
            var enforcepromotion=0;
            var EnableSalesPromotion = 1;
            var promooveride=0;
            window.lang = new jquery_lang_js();
            var decimalplace = sessionStorage.getItem("decimalplace");
            var dataInvoice = null,invoiceIndex = 0,totalinvoice=0;
	
            $("#tbl1").click(function() { });
            $('label').css({ 'background': '#D1ECFD','border':'none' });
            $('.ui-btn-inner').css({ 'border-top':'none' });
            $("#tbl1 td").css({ 'height':'25px' });
            resizeOrientationWindow();
            $(document).ready(function() 
            {
	            	resizeWindow();                            
	            	document.addEventListener("deviceready", getPromotionList, false);
	            	 // sujee added side bar ----------------- START ------------------------ 

        	          var pushbar = new Pushbar({
    		blur:true,
    		overlay:true,
    	});
        $("#txtroute").text("ROUTE #: " + sessionStorage.getItem("RouteCode")); 
        window.setInterval(function(){
     		var randomColor = '#'+ ('000000' + Math.floor(Math.random()*16777215).toString(16)).slice(-6);
     		$('#txtroute').css({
       			'color' : randomColor,
     		});
   			}, 2000);
        //----------------------------- END -------------------------  
	            	EnableSalesPromotion = localStorage.getItem("enablesalespromotion");
	                
	            	if (localStorage.custpro == 'order') {
	            		var page = '../customer_opt/salesinvoice_option.html'
	            	}
	            	else 
	            	{
	            		var page = '../customer_opt/salesinvoice_option.html';
	            	}
	            	$("#Back_inner").attr("href", page);
	            	$("#exit").attr("href", page);
	
	            	$("#tbl1 tr").live('click', function() 
	            	{
	                           
			            	if(enforcepromotion==0 || localStorage.promooveride==1)
			                {
			            
				      
			            		index = $(this).index();
			                    promoenforce = eval(data[index - 1][9]); 
			                           
			                    if(promoenforce == 0)
			                    {
			                           $(this).toggleClass('clicked');
			                           if ($("#check_" + (index)).css('display') == 'block') {
			                        	   $("#check_" + (index)).css({ "display": "none" });
			                        	   if(countRecord != 0)
			                        	   {           
			                        		   DeletePromotionDetail(index);
			                        	   }
			                        	   tempPlan = eval(data[index - 1][0]);           
			                        	   for(i=0;i < arrayPlan.length;i++)
			                        	   {
				                                if(arrayPlan[i] == tempPlan)
				                                {
				                                    arrayPlan.splice(i,1);    
				                                    
				                                }
			                        	   }
				           
			                           }
			                           else if($.inArray(data[index - 1][0],arrayPlan) >= 0)
			                           {
			                        	   		tempPlan = eval(data[index - 1][0]);           
			                                    for(i=0;i < arrayPlan.length;i++)
			                                    {
			                                        if(arrayPlan[i] == tempPlan)
			                                        {
			                                            arrayPlan.splice(i,1);    
			                                           
			                                        }
			                                    }
			                           }
			                           else 
			                           {	
			                        	   	 promotionTypeCode = eval(data[index - 1][3]);           
							                 rangeBasis = eval(data[index - 1][5]);     
							                 arrayPlan.push(eval(data[index - 1][0]));  
			                          
							                 if(rangeBasis==3){
							                	 getItemAmountFixed(index,promotionTypeCode,rangeBasis);
							                 }
							                 else{
							                	 getItemAmount(index,promotionTypeCode,rangeBasis);
							                 }
			                          
				           
			                           }
			                    }
			                }
	            	});
        
			        $(".leftfooter").html(getCurrentDate());
				    $('.ui-body-d').css({ 'background': '#fff' });
				    $('.ui-input-datebox').css({ 'width': '92%', 'line-height': '4.0' });
				    $('.ui-btn-icon-notext').css({ 'margin-top': '19px !important' });
				    $('.ui-input-datebox input').css({ 'width': '76% !important', 'color': '#999' });

				    var lan = sessionStorage.getItem("Language");
				    window.lang.run(lan);
			
				    if (sessionStorage.getItem("Language") != "en") 
				    {
			
				        window.lang.change('Promolist' + lan, lan);
				        window.lang.change('Footer' + lan, lan);
				        if (lan == "AR") {
				            $("#contentWrapper").attr("dir", "rtl");
				            $('#Back_inner').removeClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
				            $('#Back_inner').addClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
				            $('#lang_inner').removeClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
				            $('#lang_inner').addClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
				        }
			
				    }
				    else 
				    {
				        window.lang.change('en', 'en');
				        $("#contentWrapper").attr("dir", "ltr");
				        $('#Back_inner').removeClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
				        $('#Back_inner').addClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
				        $('#lang_inner').removeClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
				        $('#lang_inner').addClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
				    }
            });
            
            // Function for bind promotion list
            function getPromotionList()
            {
            	$("#linkContinue").attr("onclick","");
                $.mobile.showPageLoadingMsg();
            	platform= sessionStorage.getItem("platform");
            	getPassword();
                //var Qry="select promokeydetail.plannumber,Case When '"+ sessionStorage.getItem('Language') +"' = 'en' Then promoplanheader.plandescription Else promoplanheader.arbplandescription End As plandesc,promokeydetail.plannumber,promokeydetail.promotiontypecode,promokeydetail.assignmentnumber,ifnull(promokeydetail.rangebasis,0) as rangebasis,customermaster.enforcepromotion,promokeydetail.assignmentgroup,promokeydetail.qualificationgroup,promoplandetail.enforcepromotion as promoenforce,promoplandetail.memo1 as memo1 from promokeyheader inner join customermaster on promokeyheader.promotionkey =  customermaster.promotionkey inner join promokeydetail on promokeydetail.promotionkey = promokeyheader.promotionkey inner join promoplanheader  on promoplanheader.plannumber = promokeydetail.plannumber join promoplandetail on promoplandetail.plannumber = promokeydetail.plannumber where customermaster.customercode = "+ sessionStorage.getItem("customerid") +"";
                // org qry sujee commented 05/06/2018
            	//var Qry="select promokeydetail.plannumber, Case When '"+ sessionStorage.getItem('Language') +"' = 'en' Then promoplanheader.plandescription Else promoplanheader.arbplandescription End As plandesc, promokeydetail.plannumber, promokeydetail.promotiontypecode, promokeydetail.assignmentnumber, ifnull(promokeydetail.rangebasis,0) as rangebasis, customermaster.enforcepromotion, promokeydetail.assignmentgroup, promokeydetail.qualificationgroup, promoplandetail.enforcepromotion as promoenforce, promoplandetail.memo1 as memo1 from promokeyheader inner join customermaster on promokeyheader.promotionkey =  customermaster.promotionkey inner join promokeydetail on promokeydetail.promotionkey = promokeyheader.promotionkey inner join promoplanheader  on promoplanheader.plannumber = promokeydetail.plannumber inner join promoplandetail on promoplandetail.plannumber = promokeydetail.plannumber where customermaster.customercode = "+ sessionStorage.getItem("customerid") +" AND promokeydetail.qualificationgroup IN (SELECT DISTINCT pgd.groupnumber FROM productgroupdetail pgd INNER JOIN invoicedetail id on id.itemcode = pgd.itemcode and id.visitkey = "+ sessionStorage.getItem("VisitKey") +") order by plandesc ASC";
            	
            	var Qry="select promokeydetail.plannumber, Case When '"+ sessionStorage.getItem('Language') +"' = 'en' Then promoplanheader.plandescription Else promoplanheader.arbplandescription End As plandesc, promokeydetail.plannumber, promokeydetail.promotiontypecode, promokeydetail.assignmentnumber, ifnull(promokeydetail.rangebasis,0) as rangebasis, customermaster.enforcepromotion, promokeydetail.assignmentgroup, promokeydetail.qualificationgroup, promoplandetail.enforcepromotion as promoenforce, promoplandetail.memo1 as memo1 from promokeyheader inner join customermaster on promokeyheader.promotionkey =  customermaster.promotionkey inner join promokeydetail on promokeydetail.promotionkey = promokeyheader.promotionkey inner join promoplanheader  on promoplanheader.plannumber = promokeydetail.plannumber inner join promoplandetail on promoplandetail.plannumber = promokeydetail.plannumber where customermaster.customercode = "+ sessionStorage.getItem("customerid") +"  order by plandesc ASC";
            	if(platform=='iPad')
           		{
            				Cordova.exec(function(result) 
            				{                           
                                    if(result.length > 0)
                                    {
                                        BindData(result);   
                             
		                              if(result[0][6]!=1 || localStorage.promooveride==1)
		                              {
		                                  selectPromotionList();             
		                              }
		                              else if(result[0][6]==1)
		                              {
		                            	  $("#promodiv").css({'display':'block'});
		                              }
                                    }
                                    else 
                                    {
                                        if (countRecord == 0) {
                                            $("#linkDetail").attr("href", "#");                                            
                                            $("#lnktextDetail").addClass('MenuGray');
                                            $("#linkDetail").attr("onclick", "#");

                                            $("#linkContinue").attr("href", "#");
                                            $("#linkContinue img").attr("src", "../images/icn-select-gray.png");
                                            $("#lnktextContinue").addClass('MenuGray');
                                            $("#linkContinue").attr("onclick", "#");
                                        }                                     
                                        
                                    }
                              },
                              function(error) {
                                navigator.notification.alert("Error in binding promotion list : " + error);
                              },
                              "PluginClass", 
                              "GetdataMethod", 
                              ["select promokeydetail.plannumber,Case When '"+ sessionStorage.getItem('Language') +"' = 'en' Then promoplanheader.plandescription Else promoplanheader.arbplandescription End As plandesc,promokeydetail.plannumber,promokeydetail.promotiontypecode,promokeydetail.assignmentnumber,ifnull(promokeydetail.rangebasis,0),customermaster.enforcepromotion,promokeydetail.assignmentgroup,promokeydetail.qualificationgroup,promoplandetail.enforcepromotion as promoenforce from promokeyheader inner join customermaster on promokeyheader.promotionkey =  customermaster.promotionkey inner join promokeydetail on promokeydetail.promotionkey = promokeyheader.promotionkey inner join promoplanheader  on promoplanheader.plannumber = promokeydetail.plannumber join promoplandetail on promoplandetail.plannumber = promokeydetail.plannumber where customermaster.customercode = "+ sessionStorage.getItem("customerid") +""]);         
                }
            	else if(platform=='Android')
            	{     
            		
            		
            		window.plugins.DataBaseHelper.select(Qry,function(result)
					{
				 		if(result.array!=undefined)
						{     
							BindData(result); 
                            if(result.array[0].enforcepromotion!=1 || localStorage.promooveride==1)
                            {
                                selectPromotionList();             
                            }
                            else if(result.array[0].enforcepromotion==1)
                            {
                                $("#promodiv").css({'display':'block'});
                            }                             
                        }
                        else
                        {
//                            if (countRecord == 0) {
//                                $("#linkDetail").attr("href", "#");                               
//                                $("#lnktextDetail").addClass('MenuGray');
//                                $("#linkDetail").attr("onclick", "#");
//
//                                $("#linkContinue").attr("href", "#");
//                                $("#linkContinue img").attr("src", "../images/icn-select-gray.png");
//                                $("#lnktextContinue").addClass('MenuGray');
//                                $("#linkContinue").attr("onclick", "#");
//                            }
                            $.mobile.hidePageLoadingMsg();
                            $("#linkContinue").attr("onclick","checkRecordCount('linkContinue');");
                        }               
					},
					function()
					{
			   	 		console.warn("Error calling plugin");
					});
            	}                
            }
            
            // Bind data dynamically
            function BindData(result) 
            {

                var CellCount = $("#tblHeaderContent tr:eq(0) th").length;
                data = result;
                if (platform == 'Android') {                    
                    var array = $.map(data.array, function(item, index) {

                        return [[item.plannumber, item.plandesc, item.plannumber, item.promotiontypecode, item.assignmentnumber, item.rangebasis,item.enforcepromotion,item.assignmentgroup,item.qualificationgroup,item.promoenforce,item.memo1]];
                    });

                    data = array;
                }
                for (i = 0; i < data.length; i++) 
                {
                    var r = "<tr class='contentFont'>";
                    for (j = 1; j <= CellCount; j++) {  
                        var c = '';
                        var temp = (j == 2 || j == 3) ? 'class = leftAlign' : '';
                        if(j == 1)
                        {
                            c = "<td>" + "<img src='../images/check_1.png' height='25' style='display:none;' id = check_"+ (i + 1)  +" />" + "</td>";                           
                        }
                        else
                        {
                        	
                            if (j == CellCount-1)
                                temp += " class = 'leftAlign last '";
                            if(j==4){
                            	 temp += "style=display:none;";
                            	
                            }
                            if(j==4)
                            	c = "<td " + temp + ">0</td>"; 
                            else
                            	c = "<td " + temp + ">" + data[i][j - 2] + "</td>"; 
                           
                        }
                        r += c;
                    }
                    r += "</tr>";
                  
                    $('#tbl1 tbody').append(r);                    
                   
                }
                
                $("#tbl1 tr:odd").addClass('oddRow');
                $("#tbl1 tr:even").addClass('evenRow'); 
               
                enforcepromotion=data[0][6];
                console.log("promoenforce"+data[0][9]);
                $('#tbl1 tr').each(function()
                {
                       if($(this).index() > 0)
                       {
			                       index= $(this).index();
			                       promoenforce = data[index - 1][9];
			                       if(promoenforce==1 && enforcepromotion!=1)
			                       {
				                       deleteallpromotion();
				                       $(this).toggleClass('clicked',true);
				                       index= $(this).index();
				                       console.log("index"+index);
				                       promotionTypeCode = eval(data[index - 1][3]);
				                        console.log("promotionTypeCode"+promotionTypeCode);
				                       rangeBasis = eval(data[index - 1][5]);     
				                       arrayPlan.push(eval(data[index - 1][0]));
				                       console.log("rangeBasis"+rangeBasis);
				                       if(rangeBasis==3)
				                    	   getItemAmountFixed(index,promotionTypeCode,rangeBasis);
				                       else
				                    	   getItemAmount(index,promotionTypeCode,rangeBasis);
				                    }
                       
                       
                      
                       }
               });
               if(enforcepromotion==1)
                {
                    
                    if(localStorage.promooveride!=1)
                    {
	                    $('#tbl1 tr').each(function()
	                    {
                            if($(this).index() > 0)
                            {
                               deleteallpromotion();
                               $(this).toggleClass('clicked',true);
                               index= $(this).index();
                               promotionTypeCode = eval(data[index - 1][3]);           
                               rangeBasis = eval(data[index - 1][5]);     
                               arrayPlan.push(eval(data[index - 1][0]));  
                               promoenforce = data[index - 1][9];
                       
                               if(rangeBasis==3)
                            	   getItemAmountFixed(index,promotionTypeCode,rangeBasis);
                               else
                            	   getItemAmount(index,promotionTypeCode,rangeBasis);
                           
                            }
	                                       
	                    });
                    }
                }
               $("#linkContinue").attr("onclick","deleteRecord(this.id)"); 
               $.mobile.hidePageLoadingMsg();  
             
      }
      function deleteRecord(id)
      {
      		$.mobile.showPageLoadingMsg();  
            var deleteinvoice ="update invoicedetail set promoamount = 0,promovalue=0,returnpromovalue=0,returnpromoamount=0,promoqty=0,freesampleqty = 0 where visitkey = "+ sessionStorage.getItem('VisitKey') +" and routekey ="+ sessionStorage.getItem('RouteKey') +"";
          	    
            if(platform=='iPad')
            {                     
                Cordova.exec(function(result) {
                                deleteheaders(id);             
                              },
                              function(error) {
                                navigator.notification.alert("Error in update record : " + error);
                              },
                              "PluginClass",
                              "InsertUpdateMethod",
                              [deleteinvoice]);
            }
            else if(platform=='Android')
            {
                    window.plugins.DataBaseHelper.insert(deleteinvoice,function(result)
                    {
                             deleteheaders(id);                                 
                    },
                    function()
                    {
                         console.warn("Error calling plugin");
                    });
            }
        }
        function deleteheaders(id)
        {
                var deleteheader ="update invoiceheader set totalpromoamount = 0,issync=0 where visitkey = "+ sessionStorage.getItem('VisitKey') +" and routekey ="+ sessionStorage.getItem('RouteKey') +"";
            
            
            if(platform=='iPad')
            {  
                           
                Cordova.exec(function(result) {
                                UpdateRecord(id);           
                              },
                              function(error) {
                                navigator.notification.alert("Error in update record : " + error);
                              },
                              "PluginClass",
                              "InsertUpdateMethod",
                              [deleteheader]);
            }
            else if(platform=='Android')
            {
                window.plugins.DataBaseHelper.insert(deleteheader,function(result)
                                                     {
                                                        UpdateRecord(id); 
                                                     },
                                                     function()
                                                     {
                                                     console.warn("Error calling plugin");
                                                     });
            }
                
        }
       function UpdateRecord(id)
       {                       
            var ID = id; 
          
            if(countRecord != 0)
            {   
            
                if(EnableSalesPromotion == 1)
                {    
                    var ttype=1;
                    var selectQry = "select promotiondetail.itemcode,promotiondetail.promotiontypecode,ifnull(promotiondetail.promotionquantity,0) as promotionquantity,ifnull(promotiondetail.promotionamount,0) as promotionamount,((CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.salescaseprice)) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * invoicedetail.salesprice)) As CurrentInvoiceAmount,promotiondetail.promotionplannumber,0 as promotionkey,promotiondetail.assignmentkey,promotiondetail.rowid,ifnull(oldpromotionamount,0) as oldpromotionamount,promotiondetail.rangelow,promotiondetail.repeatingrange,promotiondetail.itemtransactiontype from promotiondetail left join invoicedetail on promotiondetail.itemcode = invoicedetail.itemcode and invoicedetail.routekey = "+ sessionStorage.getItem('RouteKey') +" and invoicedetail.visitkey = "+ sessionStorage.getItem('VisitKey') +" left join itemmaster on itemmaster.actualitemcode = promotiondetail.itemcode where promotiondetail.routekey ="+ sessionStorage.getItem('RouteKey') +" and promotiondetail.visitkey = "+ sessionStorage.getItem('VisitKey') +" order by promotiondetail.promotiontypecode,promotiondetail.promotionplannumber";
                }
                else if(EnableSalesPromotion == 2)
                {    
                    var ttype=2;
                    var selectQry = "select promotiondetail.itemcode,promotiondetail.promotiontypecode,ifnull(promotiondetail.promotionquantity,0) as promotionquantity,ifnull(promotiondetail.promotionamount,0) as promotionamount,(CAST((returnqty / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturncaseprice)) + (CAST((returnqty % itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturnprice)) As CurrentInvoiceAmount,promotiondetail.promotionplannumber,0 as promotionkey,promotiondetail.assignmentkey,promotiondetail.rowid,ifnull(oldpromotionamount,0) as oldpromotionamount,promotiondetail.rangelow,promotiondetail.repeatingrange,promotiondetail.itemtransactiontype from promotiondetail left join invoicedetail on promotiondetail.itemcode = invoicedetail.itemcode and invoicedetail.routekey = "+ sessionStorage.getItem('RouteKey') +" and invoicedetail.visitkey = "+ sessionStorage.getItem('VisitKey') +" left join itemmaster on itemmaster.actualitemcode = promotiondetail.itemcode where promotiondetail.routekey ="+ sessionStorage.getItem('RouteKey') +" and promotiondetail.visitkey = "+ sessionStorage.getItem('VisitKey') +" order by promotiondetail.promotiontypecode,promotiondetail.promotionplannumber";
                }
                else if(EnableSalesPromotion == 3)
                {    
                    var ttype=1;
                    // var selectQry = "select
					// promotiondetail.itemcode,promotiondetail.promotiontypecode,promotiondetail.promotionquantity,promotiondetail.promotionamount,((CAST((salesqty
					// / itemmaster.unitspercase) AS INTEGER) * (CASE WHEN
					// p.salescaseprice NOT NULL THEN p.salescaseprice ELSE
					// itemmaster.caseprice END)) + (CAST((salesqty %
					// itemmaster.unitspercase) AS INTEGER) *
					// invoicedetail.salesprice)) - (CAST((damagedqty /
					// itemmaster.unitspercase) AS INTEGER) * (CASE WHEN
					// p.returncaseprice NOT NULL THEN p.returncaseprice ELSE
					// itemmaster.returncaseprice END)) + (CAST((damagedqty %
					// itemmaster.unitspercase) AS INTEGER) *
					// invoicedetail.returnprice) - (CAST((returnqty /
					// itemmaster.unitspercase) AS INTEGER) * (CASE WHEN
					// p.returncaseprice NOT NULL THEN p.returncaseprice ELSE
					// itemmaster.defaultgoodreturncaseprice END)) +
					// (CAST((returnqty % itemmaster.unitspercase) AS INTEGER) *
					// (CASE WHEN p.returnprice NOT NULL THEN p.returnprice ELSE
					// itemmaster.defaultgoodreturnprice END)) As
					// CurrentInvoiceAmount,promotiondetail.promotionplannumber,0
					// as
					// promotionkey,promotiondetail.assignmentkey,promotiondetail.rowid,oldpromotionamount,promotiondetail.rangelow,promotiondetail.repeatingrange
					// from promotiondetail left join invoicedetail on
					// promotiondetail.itemcode = invoicedetail.itemcode and
					// invoicedetail.routekey = "+
					// sessionStorage.getItem('RouteKey') +" and
					// invoicedetail.visitkey = "+
					// sessionStorage.getItem('VisitKey') +" left join
					// itemmaster on itemmaster.actualitemcode =
					// promotiondetail.itemcode left join pricingdetail1 p on
					// p.itemcode = promotiondetail.itemcode and
					// p.customerpricingkey =(select
					// ifnull(customerpricing1.customerpricingkey,0) from
					// customerpricing1 join customermaster on
					// customerpricing1.pricingplankey =
					// customermaster.pricingkey and customercode = " +
					// sessionStorage.getItem("customerid") + ") where
					// promotiondetail.routekey ="+
					// sessionStorage.getItem('RouteKey') +" and
					// promotiondetail.visitkey = "+
					// sessionStorage.getItem('VisitKey') +" order by
					// promotiondetail.promotiontypecode,promotiondetail.promotionplannumber";
                    var selectQry = "select promotiondetail.itemcode,promotiondetail.promotiontypecode,ifnull(promotiondetail.promotionquantity,0) as promotionquantity,ifnull(promotiondetail.promotionamount,0) as promotionamount,CASE WHEN itemtransactiontype =1 THEN ((CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.salescaseprice)) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * invoicedetail.salesprice)) ELSE (CAST((ifnull(returnqty,0)+ifnull(damagedqty,0) / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturncaseprice)) + (CAST((ifnull(returnqty,0)+ifnull(damagedqty,0) % itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturnprice)) END As CurrentInvoiceAmount,promotiondetail.promotionplannumber,0 as promotionkey,promotiondetail.assignmentkey,promotiondetail.rowid,ifnull(oldpromotionamount,0) as oldpromotionamount,promotiondetail.rangelow,promotiondetail.repeatingrange,promotiondetail.itemtransactiontype from promotiondetail left join invoicedetail on promotiondetail.itemcode = invoicedetail.itemcode and invoicedetail.routekey = "+ sessionStorage.getItem('RouteKey') +" and invoicedetail.visitkey = "+ sessionStorage.getItem('VisitKey') +" left join itemmaster on itemmaster.actualitemcode = promotiondetail.itemcode where promotiondetail.routekey ="+ sessionStorage.getItem('RouteKey') +" and promotiondetail.visitkey = "+ sessionStorage.getItem('VisitKey') +" order by promotiondetail.promotiontypecode,promotiondetail.promotionplannumber";
                    
                    
                }
                console.log(selectQry);
                if(platform=='iPad')
                {     
                    Cordova.exec(function(result) {
                          if (result.length > 0) {
                                  dataInvoice = result;                                  
                                  totalinvoice = dataInvoice.length;
                                  UpdateInvoiceDetail(0,ttype);
                                  
                                  for(invoiceIndex = 0;invoiceIndex < dataInvoice.length;invoiceIndex++)
                                  {                                
                                    // UpdateInvoiceDetail();
                                    // UpdatePromotionDetail();
                                  }
                                                 
                          }                         
                          },
                          function(error) {
                          navigator.notification.alert("Error in update record : " + error);
                          },
                          "PluginClass",
                          "GetdataMethod",
                          [selectQry]);
                }
                else if(platform=='Android')
                {
                    window.plugins.DataBaseHelper.select(selectQry,function(result)
                                                         {
                                                            if(result.array!=undefined)
                                                            {         
                                                         
                                                                var result = $.map(result.array, function(item, index) {
                                                                           
                                                                           return [[item.itemcode, item.promotiontypecode, item.promotionquantity, item.promotionamount, item.CurrentInvoiceAmount,item.promotionplannumber,item.promotionkey,item.assignmentkey,item.rowid,item.oldpromotionamount,item.rangelow,item.repeatingrange,item.itemtransactiontype]];
                                                                        });
                                                            }
                                                         
                                                            if (result.length > 0) 
                                                            {
                                                                dataInvoice = result;
                                                         
                                                                totalinvoice = dataInvoice.length;
                                                                UpdateInvoiceDetail(0,ttype);
                                                         
                                                                for(invoiceIndex = 0;invoiceIndex < dataInvoice.length;invoiceIndex++)
                                                                {                                
                                                                    // UpdateInvoiceDetail();
                                                                    // UpdatePromotionDetail();
                                                                }
                                                                // checkRecordCount('linkContinue');
                                                            }             
                                                                
                                                         },
                                                         function()
                                                         {
                                                         console.warn("Error calling plugin");
                                                         });
                }
                
                
            }
            else 
            {
               	
               checkRecordCount(ID);               
            }
            
        }
            
         
         // Function for check at least one record select or not
         function checkRecordCount(id)
            {
    
            	$.mobile.hidePageLoadingMsg();  
                var base = window.location.toString().substring(0, window.location.toString().lastIndexOf("/")) + "/"; 
                // sujee added if tax enabled updateItemLevelTax line level tax 
              //  alert('promotionTypeCode' +promotionTypeCode);
                var  Taxflag=sessionStorage.getItem("enabletax");
                if(countRecord != 0)
                {     
                    if(id == "linkContinue")
                    {
                    	// org line sujee commented 10/09/2018
                     /*   sessionStorage.setItem('arrayplan','');
                        window.location = base + "promotion_review.html" ;*/
                        //-----END ------------
                        // sujee added ----- START ----
                    	if(Taxflag == 1 )
                    		{
                    		 sessionStorage.setItem('arrayplan','');
                    			updateItemLevelTax(base + "promotion_review.html");
                    		} else {
                            sessionStorage.setItem('arrayplan','');
                            window.location = base + "promotion_review.html" ;
                    		}
                        //--------------- END ------------
                    }
                    if(id == "linkDetail")
                    {   
                        localStorage.prodetail = 'cust';
                       
                        sessionStorage.setItem('arrayplan',arrayPlan);
                       
                       window.location = base + "promotion_detail.html" ;
                    }
                   
                }
                else
                {
                    if(id == "linkDetail")
                    { 
                        // navigator.notification.alert("At least one record
						// required for promotion");
                        // return false
                        localStorage.prodetail = 'cust';
                        
                        sessionStorage.setItem('arrayplan',arrayPlan);
                        
                        window.location = base + "promotion_detail.html" ;
                    }
                    else 
                    {
                        localStorage.sign='promo_list';
                        sessionStorage.setItem('arrayplan','');
                        var SignEnabled=window.localStorage.getItem("SignEnabled");
                       
                        if(SignEnabled != 1){
                        	updateItemLevelTax(base + "signature.html");
                        }
                        else
                        {
                        	
                        	var manualfree=window.localStorage.getItem("manualfree");
                        	var isreturn=window.localStorage.getItem("isreturn");
                        	if((eval(manualfree)>0 && eval(isreturn)==1)){
                        		updateItemLevelTax('../customer_opt/Customer_manualfree.html');
                        	}else{
                        		if (eval(sessionStorage.getItem("invoicepaymentterms")) != 2){
                                	updateItemLevelTax('../customer_opt/cashcollection_mop.html');
                                }
                                else
                                {
                                    var allowgctocash = sessionStorage.getItem("allowgctocash");
                                    if(allowgctocash == 1)
                                    {
                                        var msg = "Do You Want To Make Payment ?";
                                        navigator.notification.confirm(msg,function(action){
                                            if(action == true)
                                                	updateItemLevelTax('../customer_opt/cashcollection_mop.html');
                                            else
                                            	updateItemLevelTax('../review/printoption.html');
                                        });
                                    }
                                    else{
                                    	updateItemLevelTax('../review/printoption.html');
                                    }
                                       
                                }
                        		
                        	}
                            
                        }
                    }
                }
            }
            
            function deleteallpromotion()
            {
                if(platform=='iPad')
           		{
                    Cordova.exec(function(result) {
                                 return true;
                                  // navigator.notification.alert("Delete
									// record successfully");
                                  },
                                  function(error) {
                                  navigator.notification.alert("Error deleting record from promotion detail");
                                  },
                                  "PluginClass", 
                                  "InsertUpdateMethod", 
                                  ["Delete from promotiondetail where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+  sessionStorage.getItem('VisitKey') +""]);                 
                    
            	}
            	else if(platform=='Android')
            	{          
            		window.plugins.DataBaseHelper.insert("Delete from promotiondetail where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+  sessionStorage.getItem('VisitKey') +"",function(result) {
                                                         return true;
                                                         // navigator.notification.alert("Delete
															// record
															// successfully");
                                                         },
                                                         function()
                                                         {
                                                         console.warn("Error calling plugin");
                                                         });
				}
            }
			
			 function deleteallpromotionfreetmp()
             {
				
				 
            	$.mobile.hidePageLoadingMsg();  
                if(platform=='iPad')
           		{
                    Cordova.exec(function(result) {
                                 return true;
                                 
                                  },
                                  function(error) {
                                  navigator.notification.alert("Error deleting record from promotion detail");
                                  },
                                  "PluginClass", 
                                  "InsertUpdateMethod", 
                                  ["Delete from promotionfreetemp "]);                 
                    
            	}
            	else if(platform=='Android')
            	{          
            		
            		window.plugins.DataBaseHelper.insert("Delete from promotionfreetemp",function(result) {
                                                         return true;
                                                         
                                                         },
                                                         function()
                                                         {
                                                         console.warn("Error calling plugin");
                                                         });
				}
            }
			//
            // Function for delete promtion detail for passed plan number
            function DeletePromotionDetail(index)
            {
            	if(platform=='iPad')
           		{
                Cordova.exec(function(result) {
                                 countRecord -= 1;                                
                                 $("#tbl1 tr:eq("+ (index) +") td:eq(3)").html(0);  
                              $("#tbl1 tr:eq("+ (index) +") td:eq(0) img").css({"display":"none"});
                                 UpdatePromoDetailOrder();
                                // navigator.notification.alert("Delete record
								// successfully");
                              },
                              function(error) {
                                navigator.notification.alert("Error deleting record from promotion detail");
                              },
                              "PluginClass", 
                              "InsertUpdateMethod", 
                              ["Delete from promotiondetail where promotionplannumber ="+ data[index - 1][2] +" and routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+  sessionStorage.getItem('VisitKey') +""]);                 
                    
            	}
            	else if(platform=='Android')
            	{          
            		window.plugins.DataBaseHelper.insert("Delete from promotiondetail where promotionplannumber ="+ data[index - 1][2] +" and routekey = "+ sessionStorage.getItem('RouteKey') + " and visitkey = "+  sessionStorage.getItem('VisitKey') +"",function(result) {
            		countRecord -= 1;
                    $("#tbl1 tr:eq("+ (index) +") td:eq(3)").html(0);
                    $("#tbl1 tr:eq("+ (index) +") td:eq(0) img").css({"display":"none"});
                    UpdatePromoDetailOrder();
						// navigator.notification.alert("Delete record
						// successfully");
					},
					function()
					{
			   	 		console.warn("Error calling plugin");
					});
				}
            }
            
            function getPromotionAssignmentAdvancedFixed(index,promotionTypeCode,rangeBasis,returntype,dataAmount) 
            {
                var assignQry = '';
                flag = false;
                pAmount=1;
                for(j=0;j<dataAmount.length;j++)
                {
                    salesqty = eval(dataAmount[j][0]);
                    salesamount = eval(dataAmount[j][1]);
                    itemcode = eval(dataAmount[j][2]);
                    itemqty = eval(dataAmount[j][3]);
                    repeatingrange = eval(dataAmount[j][4]);
                    
                        if(eval(salesqty)%eval(itemqty) == 0)
                        {
                            pRange = parseInt(eval(salesqty)/eval(itemqty));
                            flag = true;   
                           if(j==0)
                            {
                            pAmount=pRange;
                            }
                           else
                           {
                                if(eval(pRange) < eval(pAmount))
                                {
                                    pAmount=pRange;
                                }
                            }
                           
                        }
                    
                    
                }     
                
             getItemDetailFixed(index,flag,promotionTypeCode,rangeBasis,repeatingrange,0,returntype,pAmount);
                
                
            	
            
            }
          // Function for getting prmotion amount for passed assignementnumber
            function getPromotionAssignmentAdvanced(index,promotionTypeCode,rangeBasis,returntype) {

                var assignQry = '';
                flag = false;
               

                dataAmount[0][0] = eval(dataAmount[0][0]);
                dataAmount[0][1] = eval(dataAmount[0][1]);
                
                if (rangeBasis == 2) {
                   // assignQry = "select CASE WHEN repeatingrange = 0 THEN
					// promotionamount ELSE CAST((" + dataAmount[0][1] +
					// "/rangelow) as int) END as
					// promoamount,rangelow,rangehigh,repeatingrange from
					// promotionassignmentadvanced where assignmentnumber = " +
					// data[index - 1][4] + " and CASE WHEN repeatingrange = 0
					// THEN " + dataAmount[0][1] + " between rangelow and
					// rangehigh ELSE " + dataAmount[0][1] + " >= rangelow END";
                    assignQry = "select promotionamount,rangelow,rangehigh,repeatingrange,"+dataAmount[0][1]+" as amount from promotionassignmentadvanced where assignmentnumber = " + data[index - 1][4] + " and CASE WHEN repeatingrange = 0 THEN " + dataAmount[0][1] + " between rangelow and rangehigh ELSE " + dataAmount[0][1] + " >= rangelow END";
                }
                else {
                    // assignQry = "select CASE WHEN repeatingrange = 0 THEN
					// promotionamount ELSE CAST((" + dataAmount[0][0] +
					// "/rangelow) as int) END as
					// promoamount,rangelow,rangehigh,repeatingrange from
					// promotionassignmentadvanced where assignmentnumber = " +
					// data[index - 1][4] + " and CASE WHEN repeatingrange = 0
					// THEN " + dataAmount[0][0] + " between rangelow and
					// rangehigh ELSE " + dataAmount[0][0] + " >= rangelow END";
                    assignQry = "select promotionamount,rangelow,rangehigh,repeatingrange,"+dataAmount[0][0]+" as amount from promotionassignmentadvanced where assignmentnumber = " + data[index - 1][4] + " and  CASE WHEN repeatingrange = 0 THEN " + dataAmount[0][0] + " between rangelow and rangehigh ELSE " + dataAmount[0][0] + " >= rangelow END";
                }
                
                console.log(assignQry);
            	if(platform=='iPad')
           		{
           		    Cordova.exec(function(result) {
           		        if (result.length > 0) {
                                  
           		            promotionAmount = result[0][0];
           		            rangeLow = result[0][1];
           		            rangeHigh = result[0][2];
                            repeatingrange = result[0][3];
                                  amount = result[0][4];
                                  
                            flag = true;  
                                  if(promotionTypeCode==7)
                                  {
                                    if(repeatingrange==1)
                                    {
                                 
                                        var pr = parseInt(amount/parseInt(rangeLow));
                                        promotionAmount = eval(pr)*eval(promotionAmount);
                                 
                                    }
                                  }
                                  console.log("pr="+pr+"promoamo="+promotionAmount);
                                  if (rangeBasis == 4)
                                  {
                                  getItemDetailFixed(index,flag,promotionTypeCode,rangeBasis,repeatingrange,rangeLow,returntype,pr);
                                  }
                                  else {
                                  
           		            getItemDetail(index,flag,promotionTypeCode,rangeBasis,repeatingrange,rangeLow,returntype,promotionAmount);
                                  }    
           		        }
           		        else {
           		            promotionAmount = 0;
           		            rangeLow = 0;
           		            rangeHigh = 0;
                                  repeatingrange=0;
                            flag = false;  
           		        }
           		    },
                              function(error) {
                                  navigator.notification.alert("Error in getting promotion amount : " + error);
                              },
                              "PluginClass",
                              "GetdataMethod",
                              [assignQry]);
            	}
            	else if(platform=='Android')
            	{
            	    window.plugins.DataBaseHelper.select(assignQry, function(result)
					{
						var array = $.map(result.array, function (item, index) {               
                		return [[item.promotionamount, item.rangelow, item.rangehigh,item.repeatingrange,item.amount]];
           				});
           				
           				result = array;
					  if (result.length > 0) {
                                  
           		            promotionAmount = result[0][0];
           		            rangeLow = result[0][1];
           		            rangeHigh = result[0][2];
                            repeatingrange = result[0][3];
                            amount = result[0][4];
                                  
                            flag = true;  
                                  if(promotionTypeCode==7)
                                  {
                                    if(repeatingrange==1)
                                    {
                                 
                                        var pr = parseInt(amount/parseInt(rangeLow));
                                        promotionAmount = eval(pr)*eval(promotionAmount);
                                 
                                    }
                                  }
                                  console.log("pr="+pr+"promoamo="+promotionAmount);
                                  if (rangeBasis == 4)
                                  {
                                  getItemDetailFixed(index,flag,promotionTypeCode,rangeBasis,repeatingrange,rangeLow,returntype,pr);
                                  }
                                  else {
                                  
           		            getItemDetail(index,flag,promotionTypeCode,rangeBasis,repeatingrange,rangeLow,returntype,promotionAmount);
                                  }    
           		        }
           		        else {
           		            promotionAmount = 0;
           		            rangeLow = 0;
           		            rangeHigh = 0;
                                  repeatingrange=0;
                            flag = false;  
           		        }
					},
					function()
					{
			   	 		console.warn("Error calling plugin");
					});
				}
            }
            var preindex='';
            function getItemDetailFixed(index,flag,promotionTypeCode,rangeBasis,repeatingrange,rangeLow,returntype,promotionAmount)
            {
                if(repeatingrange==0)
                        var pqty = "productgroupdetail.itemqty";
                else
                        var pqty = "("+promotionAmount+" *productgroupdetail.itemqty)";           
                if(EnableSalesPromotion == 1)
                {
                    
                    var itemqry="select productgroupdetail.itemcode,"+pqty+" As NewInvoiceAmount, (itemqty * itemmaster.defaultsalesprice) As SalesAmount,ifnull(itemqty,0) As SalesQty,(itemqty * productgroupdetail.promopcprice) As promoamount,promocaseprice,promopcprice from promokeydetail inner join productgroupdetail on  promokeydetail.assignmentgroup = productgroupdetail.groupnumber inner join inventorysummarydetail on productgroupdetail.itemcode = inventorysummarydetail.itemcode and inventorysummarydetail.routekey = " + sessionStorage.getItem('RouteKey') + " inner join itemmaster on itemmaster.actualitemcode = productgroupdetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";
                }
                else if(EnableSalesPromotion == 2)
                {   
                    var itemqry="select productgroupdetail.itemcode,"+pqty+" As NewInvoiceAmount, (itemqty * (itemmaster.defaultgoodreturnprice)) As SalesAmount,ifnull(itemqty,0) As SalesQty,(itemqty  * productgroupdetail.promopcprice) As promoamount,promocaseprice,promopcprice from promokeydetail inner join productgroupdetail on  promokeydetail.assignmentgroup = productgroupdetail.groupnumber inner join inventorysummarydetail on productgroupdetail.itemcode = inventorysummarydetail.itemcode and inventorysummarydetail.routekey = " + sessionStorage.getItem('RouteKey') + " inner join itemmaster on itemmaster.actualitemcode = productgroupdetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";
                }
                else if(EnableSalesPromotion == 3)
                { 
                    var trantype = 1;
                    var itemqry="select productgroupdetail.itemcode,"+pqty+" As NewInvoiceAmount, (itemqty * itemmaster.defaultsalesprice) As SalesAmount,ifnull(itemqty,0) As SalesQty,(itemqty * productgroupdetail.promopcprice) As promoamount,promocaseprice,promopcprice from promokeydetail inner join productgroupdetail on  promokeydetail.assignmentgroup = productgroupdetail.groupnumber inner join inventorysummarydetail on productgroupdetail.itemcode = inventorysummarydetail.itemcode and inventorysummarydetail.routekey = " + sessionStorage.getItem('RouteKey') + " inner join itemmaster on itemmaster.actualitemcode = productgroupdetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";
                    var itemqry2="select productgroupdetail.itemcode,"+pqty+" As NewInvoiceAmount, (itemqty * (itemmaster.defaultgoodreturnprice)) As SalesAmount,ifnull(itemqty,0) As SalesQty,(itemqty * productgroupdetail.promopcprice) As promoamount,promocaseprice,promopcprice from promokeydetail inner join productgroupdetail on  promokeydetail.assignmentgroup = productgroupdetail.groupnumber inner join inventorysummarydetail on productgroupdetail.itemcode = inventorysummarydetail.itemcode and inventorysummarydetail.routekey = " + sessionStorage.getItem('RouteKey') + " inner join itemmaster on itemmaster.actualitemcode = productgroupdetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";
                }
                console.log("itemqry == "+itemqry);
                console.log("itemqry == "+itemqry2);
                if(returntype ==1)
                {
                    if(platform=='iPad')
                    {
                        Cordova.exec(function(result) {    
                                      
                                      
                                      if(result.length > 0)
                                      {     
                                      
                                      itemIndex = 0;
                                      dataItem = result;
                                      
                                      
                                      if(flag == true)
                                      {
                                      for(itemIndex = 1;itemIndex <= dataItem.length ;itemIndex++)
                                      {                               
                                      if(eval(dataItem[itemIndex-1][3]) > 0)
                                      InsertPromotionDetail(itemIndex,dataItem,index,promotionTypeCode,rangeBasis,repeatingrange,rangeLow,trantype);
                                      // UpdateInvoiceDetail();
                                      }
                                      // navigator.notification.alert("Insert
										// record successfully");
                                      countRecord += 1;
                                      }
                                      else 
                                      {
                                      // navigator.notification.alert("Promotion
										// not avialable for this assignment
										// number");
                                      }
                                      }
                                      else
                                      {                                        
                                      // navigator.notification.alert("Item
										// detail not found for assignment
										// number");
                                      }
                                      },
                                      function(error) {
                                      navigator.notification.alert("Error in binding item list: " + error);
                                      },
                                      "PluginClass", 
                                      "GetdataMethod",                               
                                      [itemqry]);
                    }
                    else if(platform=='Android')
                    {
                        window.plugins.DataBaseHelper.select(itemqry, function(result)
                                                             {              
                                                             var array = $.map(result.array, function (item, index) {               
                                                                               return [[item.itemcode, item.NewInvoiceAmount, item.SalesAmount,item.SalesQty,item.promoamount,item.promocaseprice,item.promopcprice]];
                                                                               });
                                                             
                                                             result = array;   
                                                             if(result.length > 0)
                                                             {     
                                                             // var flag =
																// false;
                                                             itemIndex = 0;
                                                             dataItem = result;
                                                             
                                                             
                                                             if(flag == true)
                                                             {
                                                             for(itemIndex = 1;itemIndex <= dataItem.length ;itemIndex++)
                                                             {                               
                                                             InsertPromotionDetail(itemIndex,dataItem,index,promotionTypeCode,rangeBasis,repeatingrange,rangeLow,trantype);
                                                             // UpdateInvoiceDetail();
                                                             }
                                                             // navigator.notification.alert("Insert
																// record
																// successfully");
                                                             countRecord += 1;
                                                             }
                                                             else 
                                                             {
                                                             // navigator.notification.alert("Promotion
																// not avialable
																// for this
																// assignment
																// number");
                                                             }
                                                             }
                                                             else
                                                             {                                        
                                                             // navigator.notification.alert("Item
																// detail not
																// found for
																// assignment
																// number");
                                                             } 
                                                             },
                                                             function()
                                                             {
                                                             console.warn("Error calling plugin");
                                                             });
                    }
                }
                if(EnableSalesPromotion == 3)
                {
                    if(returntype ==2)
                    {
                        if(platform=='iPad')
                        {
                            Cordova.exec(function(result) {    
                                          
                                          
                                          if(result.length > 0)
                                          {     
                                          
                                          itemIndex = 0;
                                          dataItem = result;
                                          
                                          
                                          if(flag == true)
                                          {
                                          for(itemIndex = 1;itemIndex <= dataItem.length ;itemIndex++)
                                          {                               
                                          if(eval(dataItem[itemIndex-1][3]) > 0)
                                          InsertPromotionDetail(itemIndex,dataItem,index,promotionTypeCode,rangeBasis,repeatingrange,rangeLow,2);
                                          // UpdateInvoiceDetail();
                                          }
                                          // navigator.notification.alert("Insert
											// record successfully");
                                          countRecord += 1;
                                          }
                                          else 
                                          {
                                          // navigator.notification.alert("Promotion
											// not avialable for this assignment
											// number");
                                          }
                                          }
                                          else
                                          {                                        
                                          // navigator.notification.alert("Item
											// detail not found for assignment
											// number");
                                          }
                                          },
                                          function(error) {
                                          navigator.notification.alert("Error in binding item list: " + error);
                                          },
                                          "PluginClass", 
                                          "GetdataMethod",                               
                                          [itemqry2]);
                        }
                        else if(platform=='Android')
                        {
                            window.plugins.DataBaseHelper.select(itemqry2, function(result)
                                                                 {              
                                                                 var array = $.map(result.array, function (item, index) {               
                                                                                   return [[item.itemcode, item.NewInvoiceAmount, item.SalesAmount,item.SalesQty,item.promoamount]];
                                                                                   });
                                                                 
                                                                 result = array;   
                                                                 if(result.length > 0)
                                                                 {     
                                                                 // var flag
																	// = false;
                                                                 itemIndex = 0;
                                                                 dataItem = result;
                                                                 
                                                                 
                                                                 if(flag == true)
                                                                 {
                                                                 for(itemIndex = 1;itemIndex <= dataItem.length ;itemIndex++)
                                                                 {                               
                                                                 InsertPromotionDetail(itemIndex,dataItem,index,promotionTypeCode,rangeBasis,repeatingrange,rangeLow,2);
                                                                 // UpdateInvoiceDetail();
                                                                 }
                                                                 // navigator.notification.alert("Insert
																	// record
																	// successfully");
                                                                 countRecord += 1;
                                                                 }
                                                                 else 
                                                                 {
                                                                 // navigator.notification.alert("Promotion
																	// not
																	// avialable
																	// for this
																	// assignment
																	// number");
                                                                 }
                                                                 }
                                                                 else
                                                                 {                                        
                                                                 // navigator.notification.alert("Item
																	// detail
																	// not found
																	// for
																	// assignment
																	// number");
                                                                 } 
                                                                 },
                                                                 function()
                                                                 {
                                                                 console.warn("Error calling plugin");
                                                                 });
                        }
                    }
                }
            }
            // Function for getting item detail for passed item number
            function getItemDetail(index,flag,promotionTypeCode,rangeBasis,repeatingrange,rangeLow,returntype)
            {                                          
                console.log("index= "+index+"---- type = "+returntype);
                
                if(EnableSalesPromotion == 1)
                {
                    var trantype = 1;
                    if(data[index - 1][7]==1)
                    {
                    if(promotionTypeCode==0)
                    {
                        var itemqry="select invoicedetail.itemcode," + promotionAmount + " As NewInvoiceAmount, ((CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.salescaseprice)) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * invoicedetail.salesprice)) As SalesAmount,ifnull(invoicedetail.salesqty,0) As SalesQty,(CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.salescaseprice)) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * invoicedetail.salesprice) As promoamount from promokeydetail inner join invoicedetail on invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " inner join itemmaster on itemmaster.actualitemcode = invoicedetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";
                    }
                    else if(promotionTypeCode == 5 || promotionTypeCode == 6)
                    {
                        var itemqry="select group_concat(invoicedetail.itemcode) as itemcode," + promotionAmount + " As NewInvoiceAmount, sum((CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.salescaseprice)) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * invoicedetail.salesprice)) As SalesAmount,sum(ifnull(invoicedetail.salesqty,0)) As SalesQty,(CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.salescaseprice)) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * invoicedetail.salesprice) As promoamount from promokeydetail inner join invoicedetail on invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " inner join itemmaster on itemmaster.actualitemcode = invoicedetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + " group by promokeydetail.plannumber";
                    }
                    else if(promotionTypeCode == 7)
                    {
                        var itemqry="select -1," + promotionAmount + " As NewInvoiceAmount, 0,0,0 from promokeydetail  where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";
                    }
                    else
                    {
                        var itemqry="select invoicedetail.itemcode," + promotionAmount + " As NewInvoiceAmount, ((CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.salescaseprice)) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * invoicedetail.salesprice)) As SalesAmount,ifnull(invoicedetail.salesqty,0) As SalesQty,(CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.salescaseprice)) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * invoicedetail.salesprice) As promoamount from promokeydetail inner join invoicedetail on invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " inner join itemmaster on itemmaster.actualitemcode = invoicedetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";
                    }
                }
                else
                {
                if(promotionTypeCode==0)
                {
                var itemqry="select productgroupdetail.itemcode," + promotionAmount + " As NewInvoiceAmount, ((CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.salescaseprice)) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * invoicedetail.salesprice)) As SalesAmount,ifnull(invoicedetail.salesqty,0) As SalesQty,(CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * productgroupdetail.promocaseprice) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * productgroupdetail.promopcprice) As promoamount from promokeydetail inner join promotionassignmentadvanced on promotionassignmentadvanced.assignmentnumber=promokeydetail.assignmentnumber inner join productgroupdetail on  promotionassignmentadvanced.promotionamount = productgroupdetail.groupnumber inner join invoicedetail on productgroupdetail.itemcode = invoicedetail.itemcode and invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " inner join itemmaster on itemmaster.actualitemcode = productgroupdetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";
                }
                else if(promotionTypeCode == 5 || promotionTypeCode == 6)
                {
                    var itemqry="select group_concat(productgroupdetail.itemcode) as itemcode," + promotionAmount + " As NewInvoiceAmount, sum(((CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.salescaseprice)) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * invoicedetail.salesprice))) As SalesAmount,sum(ifnull(invoicedetail.salesqty,0)) As SalesQty,(CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * productgroupdetail.promocaseprice) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * productgroupdetail.promopcprice) As promoamount from promokeydetail inner join productgroupdetail on  promokeydetail.assignmentgroup = productgroupdetail.groupnumber inner join invoicedetail on productgroupdetail.itemcode = invoicedetail.itemcode and invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " inner join itemmaster on itemmaster.actualitemcode = productgroupdetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + " group by promokeydetail.plannumber";
                }
                else if(promotionTypeCode == 7)
                {
                      // var itemqry="select productgroupdetail.itemcode," +
						// promotionAmount + " As NewInvoiceAmount, (" +
						// promotionAmount + " * defaultsalesprice) As
						// SalesAmount,ifnull(" + promotionAmount + ",0) As
						// SalesQty,(" + promotionAmount + " *
						// productgroupdetail.promopcprice) As promoamount from
						// promokeydetail inner join productgroupdetail on
						// promokeydetail.assignmentgroup =
						// productgroupdetail.groupnumber inner join
						// inventorysummarydetail on productgroupdetail.itemcode
						// = inventorysummarydetail.itemcode and
						// inventorysummarydetail.routekey = " +
						// sessionStorage.getItem('RouteKey') + " inner join
						// itemmaster on itemmaster.actualitemcode =
						// productgroupdetail.itemcode where
						// promokeydetail.assignmentnumber = " + data[index -
						// 1][4] + " and promokeydetail.promotionkey = (select
						// promotionkey from customermaster where customercode =
						// " + sessionStorage.getItem('customerid') + ") and
						// promokeydetail.plannumber = " + data[index - 1][0] +
						// "";
                    var itemqry="select productgroupdetail.itemcode," + promotionAmount + " As NewInvoiceAmount, (" + promotionAmount + " * defaultsalesprice) As SalesAmount,ifnull(" + promotionAmount + ",0) As SalesQty,(IFNULL(inventorysummarydetail.loadqty,0)+IFNULL(inventorysummarydetail.loadadjustqty,0)+IFNULL(inventorysummarydetail.beginstockqty,0)+IFNULL(inventorysummarydetail.loadaddqty,0)-IFNULL(inventorysummarydetail.loadcutqty,0)-IFNULL(inventorysummarydetail.saleqty,0)+IFNULL(inventorysummarydetail.returnqty,0)+IFNULL(inventorysummarydetail.returnfreeqty,0)-IFNULL(inventorysummarydetail.freesampleqty,0)) AS AvailableQty,(" + promotionAmount + " * productgroupdetail.promopcprice) As promoamount from promokeydetail inner join productgroupdetail on  promokeydetail.assignmentgroup = productgroupdetail.groupnumber inner join inventorysummarydetail on productgroupdetail.itemcode = inventorysummarydetail.itemcode and inventorysummarydetail.routekey = " + sessionStorage.getItem('RouteKey') + " inner join itemmaster on itemmaster.actualitemcode = productgroupdetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and AvailableQty >0 and  promokeydetail.promotionkey = (select promotionkey from customermaster where  customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";
                   // alert(itemqry);
                }
                else
                {
                    var itemqry="select productgroupdetail.itemcode," + promotionAmount + " As NewInvoiceAmount, ((CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.salescaseprice)) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * invoicedetail.salesprice)) As SalesAmount,ifnull(invoicedetail.salesqty,0) As SalesQty,(CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * productgroupdetail.promocaseprice) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * productgroupdetail.promopcprice) As promoamount from promokeydetail inner join productgroupdetail on  promokeydetail.assignmentgroup = productgroupdetail.groupnumber inner join invoicedetail on productgroupdetail.itemcode = invoicedetail.itemcode and invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " inner join itemmaster on itemmaster.actualitemcode = productgroupdetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";
                }
                }
                }
                else if(EnableSalesPromotion == 2)
                {
                     var trantype = 2;
                    if(data[index - 1][7]==1)
                    {
                        if(promotionTypeCode==0)
                        {
                            var itemqry="select invoicedetail.itemcode," + promotionAmount + " As NewInvoiceAmount, ((CAST((ifnull(returnqty,0)+ifnull(damagedqty,0) / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturncaseprice)) + (CAST((ifnull(returnqty,0)+ifnull(damagedqty,0) % itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturnprice))) As SalesAmount,ifnull(invoicedetail.returnqty,0)+ifnull(invoicedetail.damagedqty,0) As SalesQty,(CAST((ifnull(returnqty,0)+ifnull(damagedqty,0) / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturncaseprice)) + (CAST((returnqty % itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturnprice)) As promoamount from promokeydetail inner join invoicedetail on invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " inner join itemmaster on itemmaster.actualitemcode = invoicedetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";
                        }
                        else if(promotionTypeCode == 5 || promotionTypeCode == 6)
                        {
                            var itemqry="select group_concat(invoicedetail.itemcode) as itemcode," + promotionAmount + " As NewInvoiceAmount, sum(((CAST(((ifnull(returnqty,0)+ifnull(damagedqty,0)) / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturncaseprice)) + (CAST(((ifnull(returnqty,0)+ifnull(damagedqty,0)) % itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturnprice)))) As SalesAmount,sum(ifnull(invoicedetail.returnqty,0))+sum(ifnull(invoicedetail.damagedqty,0)) As SalesQty,(CAST(((ifnull(returnqty,0)+ifnull(damagedqty,0)) / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturncaseprice)) + (CAST(((ifnull(returnqty,0)+ifnull(damagedqty,0)) % itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturnprice)) As promoamount from promokeydetail inner join invoicedetail on invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " inner join itemmaster on itemmaster.actualitemcode = invoicedetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + " group by promokeydetail.plannumber";
                        }
                        else if(promotionTypeCode == 7)
                        {
                                   var itemqry="select -1," + promotionAmount + " As NewInvoiceAmount, 0,0,0 from promokeydetail  where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";
                        }
                        else
                        {
                            var itemqry="select invoicedetail.itemcode," + promotionAmount + " As NewInvoiceAmount, ((CAST((ifnull(returnqty,0)+ifnull(damagedqty,0) / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturncaseprice)) + (CAST((ifnull(returnqty,0)+ifnull(damagedqty,0) % itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturnprice))) As SalesAmount,ifnull(invoicedetail.returnqty,0)+ifnull(invoicedetail.damagedqty,0) As SalesQty,(CAST((returnqty / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturncaseprice)) + (CAST((returnqty % itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturnprice)) As promoamount from promokeydetail inner join invoicedetail on invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " inner join itemmaster on itemmaster.actualitemcode = invoicedetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";
                        }
                    }
                    else
                    {
                        if(promotionTypeCode==0)
                        {
                            var itemqry="select productgroupdetail.itemcode," + promotionAmount + " As NewInvoiceAmount, ((CAST((ifnull(returnqty,0)+ifnull(damagedqty,0) / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturncaseprice)) + (CAST((ifnull(returnqty,0)+ifnull(damagedqty,0) % itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturnprice))) As SalesAmount,ifnull(invoicedetail.returnqty,0)+ifnull(invoicedetail.damagedqty,0) As SalesQty,(CAST((ifnull(returnqty,0)+ifnull(damagedqty,0) / itemmaster.unitspercase) AS INTEGER) * productgroupdetail.promocaseprice) + (CAST((ifnull(returnqty,0)+ifnull(damagedqty,0) % itemmaster.unitspercase) AS INTEGER) * productgroupdetail.promopcprice) As promoamount from promokeydetail inner join promotionassignmentadvanced on promotionassignmentadvanced.assignmentnumber=promokeydetail.assignmentnumber inner join productgroupdetail on  promotionassignmentadvanced.promotionamount = productgroupdetail.groupnumber inner join invoicedetail on productgroupdetail.itemcode = invoicedetail.itemcode and invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " inner join itemmaster on itemmaster.actualitemcode = productgroupdetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";
                        }
                        else if(promotionTypeCode == 5 || promotionTypeCode == 6)
                        {
                            var itemqry="select group_concat(productgroupdetail.itemcode) as itemcode," + promotionAmount + " As NewInvoiceAmount, sum(((CAST(((ifnull(returnqty,0)+ifnull(damagedqty,0)) / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturncaseprice)) + (CAST(((ifnull(returnqty,0)+ifnull(damagedqty,0)) % itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturnprice)))) As SalesAmount,sum(ifnull(invoicedetail.returnqty,0))+sum(ifnull(invoicedetail.damagedqty,0)) As SalesQty,(CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.salescaseprice)) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * invoicedetail.salesprice) As promoamount from promokeydetail inner join productgroupdetail on  promokeydetail.assignmentgroup = productgroupdetail.groupnumber inner join invoicedetail on productgroupdetail.itemcode = invoicedetail.itemcode and invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " inner join itemmaster on itemmaster.actualitemcode = productgroupdetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + " group by promokeydetail.plannumber";
                        }
                        else if(promotionTypeCode == 7)
                        {
                            var itemqry="select productgroupdetail.itemcode," + promotionAmount + " As NewInvoiceAmount, (" + promotionAmount + " * defaultgoodreturnprice) As SalesAmount,ifnull(" + promotionAmount + ",0) As SalesQty,(" + promotionAmount + " * productgroupdetail.promopcprice) As promoamount from promokeydetail inner join productgroupdetail on  promokeydetail.assignmentgroup = productgroupdetail.groupnumber inner join inventorysummarydetail on productgroupdetail.itemcode = inventorysummarydetail.itemcode and inventorysummarydetail.routekey = " + sessionStorage.getItem('RouteKey') + " inner join itemmaster on itemmaster.actualitemcode = productgroupdetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";  
                        }
                        else
                        {
                            var itemqry="select productgroupdetail.itemcode," + promotionAmount + " As NewInvoiceAmount, ((CAST((ifnull(returnqty,0)+ifnull(damagedqty,0) / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturncaseprice)) + (CAST((ifnull(returnqty,0)+ifnull(damagedqty,0) % itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturnprice))) As SalesAmount,ifnull(invoicedetail.returnqty,0)+ifnull(invoicedetail.damagedqty,0) As SalesQty,(CAST((ifnull(returnqty,0)+ifnull(damagedqty,0) / itemmaster.unitspercase) AS INTEGER) * productgroupdetail.promocaseprice) + (CAST((ifnull(returnqty,0)+ifnull(damagedqty,0) % itemmaster.unitspercase) AS INTEGER) * productgroupdetail.promopcprice) As promoamount from promokeydetail inner join productgroupdetail on  promokeydetail.assignmentgroup = productgroupdetail.groupnumber inner join invoicedetail on productgroupdetail.itemcode = invoicedetail.itemcode and invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " inner join itemmaster on itemmaster.actualitemcode = productgroupdetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";
                        }
                    }
                }
                else if(EnableSalesPromotion == 3)
                {
                    var trantype = 1;
                    /*
					 * if(data[index - 1][7]==1) { if(promotionTypeCode==0) {
					 * var itemqry="select invoicedetail.itemcode," +
					 * promotionAmount + " As NewInvoiceAmount, (CAST((salesqty /
					 * itemmaster.unitspercase) AS INTEGER) * (CASE WHEN
					 * p.salescaseprice NOT NULL THEN p.salescaseprice ELSE
					 * itemmaster.caseprice END)) + (CAST((salesqty %
					 * itemmaster.unitspercase) AS INTEGER) *
					 * invoicedetail.salesprice) - (CAST((returnqty /
					 * itemmaster.unitspercase) AS INTEGER) * (CASE WHEN
					 * p.returncaseprice NOT NULL THEN p.returncaseprice ELSE
					 * itemmaster.defaultgoodreturncaseprice END)) +
					 * (CAST((returnqty % itemmaster.unitspercase) AS INTEGER) *
					 * (CASE WHEN p.returnprice NOT NULL THEN p.returnprice ELSE
					 * itemmaster.defaultgoodreturnprice END))-(CAST((damagedqty /
					 * itemmaster.unitspercase) AS INTEGER) * (CASE WHEN
					 * p.returncaseprice NOT NULL THEN p.returncaseprice ELSE
					 * itemmaster.returncaseprice END)) + (CAST((damagedqty %
					 * itemmaster.unitspercase) AS INTEGER) *
					 * invoicedetail.returnprice) As
					 * SalesAmount,ifnull(invoicedetail.salesqty,0) -
					 * ifnull(invoicedetail.returnqty,0)-ifnull(invoicedetail.damagedqty,0)
					 * As SalesQty,(CAST((salesqty / itemmaster.unitspercase) AS
					 * INTEGER) * (CASE WHEN p.salescaseprice NOT NULL THEN
					 * p.salescaseprice ELSE itemmaster.caseprice END)) +
					 * (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) *
					 * invoicedetail.salesprice) - (CAST((returnqty /
					 * itemmaster.unitspercase) AS INTEGER) * (CASE WHEN
					 * p.returncaseprice NOT NULL THEN p.returncaseprice ELSE
					 * itemmaster.defaultgoodreturncaseprice END)) +
					 * (CAST((returnqty % itemmaster.unitspercase) AS INTEGER) *
					 * (CASE WHEN p.returnprice NOT NULL THEN p.returnprice ELSE
					 * itemmaster.defaultgoodreturnprice END))-(CAST((damagedqty /
					 * itemmaster.unitspercase) AS INTEGER) * (CASE WHEN
					 * p.returncaseprice NOT NULL THEN p.returncaseprice ELSE
					 * itemmaster.returncaseprice END)) + (CAST((damagedqty %
					 * itemmaster.unitspercase) AS INTEGER) *
					 * invoicedetail.returnprice) As promoamount from
					 * promokeydetail inner join invoicedetail on
					 * invoicedetail.routekey = " +
					 * sessionStorage.getItem('RouteKey') + " and
					 * invoicedetail.visitkey = " +
					 * sessionStorage.getItem('VisitKey') + " inner join
					 * itemmaster on itemmaster.actualitemcode =
					 * invoicedetail.itemcode left join pricingdetail1 p on
					 * p.itemcode = invoicedetail.itemcode and
					 * p.customerpricingkey =(select
					 * ifnull(customerpricing1.customerpricingkey,0) from
					 * customerpricing1 join customermaster on
					 * customerpricing1.pricingplankey =
					 * customermaster.pricingkey and customercode = " +
					 * sessionStorage.getItem("customerid") + ") where
					 * promokeydetail.assignmentnumber = " + data[index - 1][4] + "
					 * and promokeydetail.promotionkey = (select promotionkey
					 * from customermaster where customercode = " +
					 * sessionStorage.getItem('customerid') + ") and
					 * promokeydetail.plannumber = " + data[index - 1][0] + ""; }
					 * else if(promotionTypeCode == 5 || promotionTypeCode == 6) {
					 * var itemqry="select group_concat(invoicedetail.itemcode)
					 * as itemcode," + promotionAmount + " As NewInvoiceAmount,
					 * sum((CAST((salesqty / itemmaster.unitspercase) AS
					 * INTEGER) * (CASE WHEN p.salescaseprice NOT NULL THEN
					 * p.salescaseprice ELSE itemmaster.caseprice END)) +
					 * (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) *
					 * invoicedetail.salesprice) - (CAST((returnqty /
					 * itemmaster.unitspercase) AS INTEGER) * (CASE WHEN
					 * p.returncaseprice NOT NULL THEN p.returncaseprice ELSE
					 * itemmaster.defaultgoodreturncaseprice END)) +
					 * (CAST((returnqty % itemmaster.unitspercase) AS INTEGER) *
					 * (CASE WHEN p.returnprice NOT NULL THEN p.returnprice ELSE
					 * itemmaster.defaultgoodreturnprice END))-(CAST((damagedqty /
					 * itemmaster.unitspercase) AS INTEGER) * (CASE WHEN
					 * p.returncaseprice NOT NULL THEN p.returncaseprice ELSE
					 * itemmaster.returncaseprice END)) + (CAST((damagedqty %
					 * itemmaster.unitspercase) AS INTEGER) *
					 * invoicedetail.returnprice)) As
					 * SalesAmount,sum(ifnull(invoicedetail.salesqty,0) -
					 * ifnull(invoicedetail.returnqty,0)-ifnull(invoicedetail.damagedqty,0))
					 * As SalesQty,sum((CAST((salesqty /
					 * itemmaster.unitspercase) AS INTEGER) * (CASE WHEN
					 * p.salescaseprice NOT NULL THEN p.salescaseprice ELSE
					 * itemmaster.caseprice END)) + (CAST((salesqty %
					 * itemmaster.unitspercase) AS INTEGER) *
					 * invoicedetail.salesprice) - (CAST((returnqty /
					 * itemmaster.unitspercase) AS INTEGER) * (CASE WHEN
					 * p.returncaseprice NOT NULL THEN p.returncaseprice ELSE
					 * itemmaster.defaultgoodreturncaseprice END)) +
					 * (CAST((returnqty % itemmaster.unitspercase) AS INTEGER) *
					 * (CASE WHEN p.returnprice NOT NULL THEN p.returnprice ELSE
					 * itemmaster.defaultgoodreturnprice END))-(CAST((damagedqty /
					 * itemmaster.unitspercase) AS INTEGER) * (CASE WHEN
					 * p.returncaseprice NOT NULL THEN p.returncaseprice ELSE
					 * itemmaster.returncaseprice END)) + (CAST((damagedqty %
					 * itemmaster.unitspercase) AS INTEGER) *
					 * invoicedetail.returnprice)) As promoamount from
					 * promokeydetail inner join invoicedetail on
					 * invoicedetail.routekey = " +
					 * sessionStorage.getItem('RouteKey') + " and
					 * invoicedetail.visitkey = " +
					 * sessionStorage.getItem('VisitKey') + " inner join
					 * itemmaster on itemmaster.actualitemcode =
					 * invoicedetail.itemcode left join pricingdetail1 p on
					 * p.itemcode = invoicedetail.itemcode and
					 * p.customerpricingkey =(select
					 * ifnull(customerpricing1.customerpricingkey,0) from
					 * customerpricing1 join customermaster on
					 * customerpricing1.pricingplankey =
					 * customermaster.pricingkey and customercode = " +
					 * sessionStorage.getItem("customerid") + ") where
					 * promokeydetail.assignmentnumber = " + data[index - 1][4] + "
					 * and promokeydetail.promotionkey = (select promotionkey
					 * from customermaster where customercode = " +
					 * sessionStorage.getItem('customerid') + ") and
					 * promokeydetail.plannumber = " + data[index - 1][0] + "
					 * group by promokeydetail.plannumber"; } else { var
					 * itemqry="select invoicedetail.itemcode," +
					 * promotionAmount + " As NewInvoiceAmount, (CAST((salesqty /
					 * itemmaster.unitspercase) AS INTEGER) * (CASE WHEN
					 * p.salescaseprice NOT NULL THEN p.salescaseprice ELSE
					 * itemmaster.caseprice END)) + (CAST((salesqty %
					 * itemmaster.unitspercase) AS INTEGER) *
					 * invoicedetail.salesprice) - (CAST((returnqty /
					 * itemmaster.unitspercase) AS INTEGER) * (CASE WHEN
					 * p.returncaseprice NOT NULL THEN p.returncaseprice ELSE
					 * itemmaster.defaultgoodreturncaseprice END)) +
					 * (CAST((returnqty % itemmaster.unitspercase) AS INTEGER) *
					 * (CASE WHEN p.returnprice NOT NULL THEN p.returnprice ELSE
					 * itemmaster.defaultgoodreturnprice END))-(CAST((damagedqty /
					 * itemmaster.unitspercase) AS INTEGER) * (CASE WHEN
					 * p.returncaseprice NOT NULL THEN p.returncaseprice ELSE
					 * itemmaster.returncaseprice END)) + (CAST((damagedqty %
					 * itemmaster.unitspercase) AS INTEGER) *
					 * invoicedetail.returnprice) As
					 * SalesAmount,ifnull(invoicedetail.salesqty,0) -
					 * ifnull(invoicedetail.returnqty,0)-ifnull(invoicedetail.damagedqty,0)
					 * As SalesQty,(CAST((salesqty / itemmaster.unitspercase) AS
					 * INTEGER) * (CASE WHEN p.salescaseprice NOT NULL THEN
					 * p.salescaseprice ELSE itemmaster.caseprice END)) +
					 * (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) *
					 * invoicedetail.salesprice) - (CAST((returnqty /
					 * itemmaster.unitspercase) AS INTEGER) * (CASE WHEN
					 * p.returncaseprice NOT NULL THEN p.returncaseprice ELSE
					 * itemmaster.defaultgoodreturncaseprice END)) +
					 * (CAST((returnqty % itemmaster.unitspercase) AS INTEGER) *
					 * (CASE WHEN p.returnprice NOT NULL THEN p.returnprice ELSE
					 * itemmaster.defaultgoodreturnprice END))-(CAST((damagedqty /
					 * itemmaster.unitspercase) AS INTEGER) * (CASE WHEN
					 * p.returncaseprice NOT NULL THEN p.returncaseprice ELSE
					 * itemmaster.returncaseprice END)) + (CAST((damagedqty %
					 * itemmaster.unitspercase) AS INTEGER) *
					 * invoicedetail.returnprice) As promoamount from
					 * promokeydetail inner join invoicedetail on
					 * invoicedetail.routekey = " +
					 * sessionStorage.getItem('RouteKey') + " and
					 * invoicedetail.visitkey = " +
					 * sessionStorage.getItem('VisitKey') + " inner join
					 * itemmaster on itemmaster.actualitemcode =
					 * invoicedetail.itemcode left join pricingdetail1 p on
					 * p.itemcode = invoicedetail.itemcode and
					 * p.customerpricingkey =(select
					 * ifnull(customerpricing1.customerpricingkey,0) from
					 * customerpricing1 join customermaster on
					 * customerpricing1.pricingplankey =
					 * customermaster.pricingkey and customercode = " +
					 * sessionStorage.getItem("customerid") + ") where
					 * promokeydetail.assignmentnumber = " + data[index - 1][4] + "
					 * and promokeydetail.promotionkey = (select promotionkey
					 * from customermaster where customercode = " +
					 * sessionStorage.getItem('customerid') + ") and
					 * promokeydetail.plannumber = " + data[index - 1][0] + ""; } }
					 * else { if(promotionTypeCode==0) { var itemqry="select
					 * productgroupdetail.itemcode," + promotionAmount + " As
					 * NewInvoiceAmount, (CAST((salesqty /
					 * itemmaster.unitspercase) AS INTEGER) * (CASE WHEN
					 * p.salescaseprice NOT NULL THEN p.salescaseprice ELSE
					 * itemmaster.caseprice END)) + (CAST((salesqty %
					 * itemmaster.unitspercase) AS INTEGER) *
					 * invoicedetail.salesprice) - (CAST((returnqty /
					 * itemmaster.unitspercase) AS INTEGER) * (CASE WHEN
					 * p.returncaseprice NOT NULL THEN p.returncaseprice ELSE
					 * itemmaster.defaultgoodreturncaseprice END)) +
					 * (CAST((returnqty % itemmaster.unitspercase) AS INTEGER) *
					 * (CASE WHEN p.returnprice NOT NULL THEN p.returnprice ELSE
					 * itemmaster.defaultgoodreturnprice END))-(CAST((damagedqty /
					 * itemmaster.unitspercase) AS INTEGER) * (CASE WHEN
					 * p.returncaseprice NOT NULL THEN p.returncaseprice ELSE
					 * itemmaster.returncaseprice END)) + (CAST((damagedqty %
					 * itemmaster.unitspercase) AS INTEGER) *
					 * invoicedetail.returnprice) As
					 * SalesAmount,ifnull(invoicedetail.salesqty,0) -
					 * ifnull(invoicedetail.returnqty,0)-ifnull(invoicedetail.damagedqty,0)
					 * As SalesQty,(CAST((salesqty / itemmaster.unitspercase) AS
					 * INTEGER) * productgroupdetail.promocaseprice) +
					 * (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) *
					 * productgroupdetail.promopcprice) - (CAST((returnqty /
					 * itemmaster.unitspercase) AS INTEGER) *
					 * productgroupdetail.promocaseprice) + (CAST((returnqty %
					 * itemmaster.unitspercase) AS INTEGER) *
					 * productgroupdetail.promopcprice) - (CAST((damagedqty /
					 * itemmaster.unitspercase) AS INTEGER) *
					 * productgroupdetail.promocaseprice) + (CAST((damagedqty %
					 * itemmaster.unitspercase) AS INTEGER) *
					 * productgroupdetail.promopcprice) As promoamount from
					 * promokeydetail inner join promotionassignmentadvanced on
					 * promotionassignmentadvanced.assignmentnumber=promokeydetail.assignmentnumber
					 * inner join productgroupdetail on
					 * promotionassignmentadvanced.promotionamount =
					 * productgroupdetail.groupnumber inner join invoicedetail
					 * on productgroupdetail.itemcode = invoicedetail.itemcode
					 * and invoicedetail.routekey = " +
					 * sessionStorage.getItem('RouteKey') + " and
					 * invoicedetail.visitkey = " +
					 * sessionStorage.getItem('VisitKey') + " inner join
					 * itemmaster on itemmaster.actualitemcode =
					 * productgroupdetail.itemcode left join pricingdetail1 p on
					 * p.itemcode = productgroupdetail.itemcode and
					 * p.customerpricingkey =(select
					 * ifnull(customerpricing1.customerpricingkey,0) from
					 * customerpricing1 join customermaster on
					 * customerpricing1.pricingplankey =
					 * customermaster.pricingkey and customercode = " +
					 * sessionStorage.getItem("customerid") + ") where
					 * promokeydetail.assignmentnumber = " + data[index - 1][4] + "
					 * and promokeydetail.promotionkey = (select promotionkey
					 * from customermaster where customercode = " +
					 * sessionStorage.getItem('customerid') + ") and
					 * promokeydetail.plannumber = " + data[index - 1][0] + ""; }
					 * else if(promotionTypeCode == 5 || promotionTypeCode == 6) {
					 * var itemqry="select
					 * group_concat(productgroupdetail.itemcode) as itemcode," +
					 * promotionAmount + " As NewInvoiceAmount,
					 * sum((CAST((salesqty / itemmaster.unitspercase) AS
					 * INTEGER) * (CASE WHEN p.salescaseprice NOT NULL THEN
					 * p.salescaseprice ELSE itemmaster.caseprice END)) +
					 * (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) *
					 * invoicedetail.salesprice) - (CAST((returnqty /
					 * itemmaster.unitspercase) AS INTEGER) * (CASE WHEN
					 * p.returncaseprice NOT NULL THEN p.returncaseprice ELSE
					 * itemmaster.defaultgoodreturncaseprice END)) +
					 * (CAST((returnqty % itemmaster.unitspercase) AS INTEGER) *
					 * (CASE WHEN p.returnprice NOT NULL THEN p.returnprice ELSE
					 * itemmaster.defaultgoodreturnprice END))-(CAST((damagedqty /
					 * itemmaster.unitspercase) AS INTEGER) * (CASE WHEN
					 * p.returncaseprice NOT NULL THEN p.returncaseprice ELSE
					 * itemmaster.returncaseprice END)) + (CAST((damagedqty %
					 * itemmaster.unitspercase) AS INTEGER) *
					 * invoicedetail.returnprice)) As
					 * SalesAmount,sum(ifnull(invoicedetail.salesqty,0) -
					 * ifnull(invoicedetail.returnqty,0)-ifnull(invoicedetail.damagedqty,0))
					 * As SalesQty,(CAST((salesqty / itemmaster.unitspercase) AS
					 * INTEGER) * productgroupdetail.promocaseprice) +
					 * (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) *
					 * productgroupdetail.promopcprice) - (CAST((returnqty /
					 * itemmaster.unitspercase) AS INTEGER) *
					 * productgroupdetail.promocaseprice) + (CAST((returnqty %
					 * itemmaster.unitspercase) AS INTEGER) *
					 * productgroupdetail.promopcprice) - (CAST((damagedqty /
					 * itemmaster.unitspercase) AS INTEGER) *
					 * productgroupdetail.promocaseprice) + (CAST((damagedqty %
					 * itemmaster.unitspercase) AS INTEGER) *
					 * productgroupdetail.promopcprice) As promoamount from
					 * promokeydetail inner join productgroupdetail on
					 * promokeydetail.assignmentgroup =
					 * productgroupdetail.groupnumber inner join invoicedetail
					 * on productgroupdetail.itemcode = invoicedetail.itemcode
					 * and invoicedetail.routekey = " +
					 * sessionStorage.getItem('RouteKey') + " and
					 * invoicedetail.visitkey = " +
					 * sessionStorage.getItem('VisitKey') + " inner join
					 * itemmaster on itemmaster.actualitemcode =
					 * productgroupdetail.itemcode left join pricingdetail1 p on
					 * p.itemcode = productgroupdetail.itemcode and
					 * p.customerpricingkey =(select
					 * ifnull(customerpricing1.customerpricingkey,0) from
					 * customerpricing1 join customermaster on
					 * customerpricing1.pricingplankey =
					 * customermaster.pricingkey and customercode = " +
					 * sessionStorage.getItem("customerid") + ") where
					 * promokeydetail.assignmentnumber = " + data[index - 1][4] + "
					 * and promokeydetail.promotionkey = (select promotionkey
					 * from customermaster where customercode = " +
					 * sessionStorage.getItem('customerid') + ") and
					 * promokeydetail.plannumber = " + data[index - 1][0] + "
					 * group by promokeydetail.plannumber"; } else { var
					 * itemqry="select productgroupdetail.itemcode," +
					 * promotionAmount + " As NewInvoiceAmount, (CAST((salesqty /
					 * itemmaster.unitspercase) AS INTEGER) * (CASE WHEN
					 * p.salescaseprice NOT NULL THEN p.salescaseprice ELSE
					 * itemmaster.caseprice END)) + (CAST((salesqty %
					 * itemmaster.unitspercase) AS INTEGER) *
					 * invoicedetail.salesprice) - (CAST((returnqty /
					 * itemmaster.unitspercase) AS INTEGER) * (CASE WHEN
					 * p.returncaseprice NOT NULL THEN p.returncaseprice ELSE
					 * itemmaster.defaultgoodreturncaseprice END)) +
					 * (CAST((returnqty % itemmaster.unitspercase) AS INTEGER) *
					 * (CASE WHEN p.returnprice NOT NULL THEN p.returnprice ELSE
					 * itemmaster.defaultgoodreturnprice END))-(CAST((damagedqty /
					 * itemmaster.unitspercase) AS INTEGER) * (CASE WHEN
					 * p.returncaseprice NOT NULL THEN p.returncaseprice ELSE
					 * itemmaster.returncaseprice END)) + (CAST((damagedqty %
					 * itemmaster.unitspercase) AS INTEGER) *
					 * invoicedetail.returnprice) As
					 * SalesAmount,ifnull(invoicedetail.salesqty,0) -
					 * ifnull(invoicedetail.returnqty,0)-ifnull(invoicedetail.damagedqty,0)
					 * As SalesQty,(CAST((salesqty / itemmaster.unitspercase) AS
					 * INTEGER) * productgroupdetail.promocaseprice) +
					 * (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) *
					 * productgroupdetail.promopcprice) - (CAST((returnqty /
					 * itemmaster.unitspercase) AS INTEGER) *
					 * productgroupdetail.promocaseprice) + (CAST((returnqty %
					 * itemmaster.unitspercase) AS INTEGER) *
					 * productgroupdetail.promopcprice) - (CAST((damagedqty /
					 * itemmaster.unitspercase) AS INTEGER) *
					 * productgroupdetail.promocaseprice) + (CAST((damagedqty %
					 * itemmaster.unitspercase) AS INTEGER) *
					 * productgroupdetail.promopcprice) As promoamount from
					 * promokeydetail inner join productgroupdetail on
					 * promokeydetail.assignmentgroup =
					 * productgroupdetail.groupnumber inner join invoicedetail
					 * on productgroupdetail.itemcode = invoicedetail.itemcode
					 * and invoicedetail.routekey = " +
					 * sessionStorage.getItem('RouteKey') + " and
					 * invoicedetail.visitkey = " +
					 * sessionStorage.getItem('VisitKey') + " inner join
					 * itemmaster on itemmaster.actualitemcode =
					 * productgroupdetail.itemcode left join pricingdetail1 p on
					 * p.itemcode = productgroupdetail.itemcode and
					 * p.customerpricingkey =(select
					 * ifnull(customerpricing1.customerpricingkey,0) from
					 * customerpricing1 join customermaster on
					 * customerpricing1.pricingplankey =
					 * customermaster.pricingkey and customercode = " +
					 * sessionStorage.getItem("customerid") + ") where
					 * promokeydetail.assignmentnumber = " + data[index - 1][4] + "
					 * and promokeydetail.promotionkey = (select promotionkey
					 * from customermaster where customercode = " +
					 * sessionStorage.getItem('customerid') + ") and
					 * promokeydetail.plannumber = " + data[index - 1][0] + ""; } }
					 */
                    if(data[index - 1][7]==1)
                    {
                        if(promotionTypeCode==0)
                        {
                            var itemqry="select invoicedetail.itemcode," + promotionAmount + " As NewInvoiceAmount, ((CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.salescaseprice)) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * invoicedetail.salesprice)) As SalesAmount,ifnull(invoicedetail.salesqty,0) As SalesQty,(CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.salescaseprice)) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * invoicedetail.salesprice) As promoamount from promokeydetail inner join invoicedetail on invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " inner join itemmaster on itemmaster.actualitemcode = invoicedetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";
                            var itemqry2="select invoicedetail.itemcode," + promotionAmount + " As NewInvoiceAmount, ((CAST((ifnull(returnqty,0)+ifnull(damagedqty,0) / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturncaseprice)) + (CAST((ifnull(returnqty,0)+ifnull(damagedqty,0) % itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturnprice))) As SalesAmount,ifnull(invoicedetail.returnqty,0) As SalesQty,(CAST((ifnull(returnqty,0)+ifnull(damagedqty,0) / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturncaseprice)) + (CAST((ifnull(returnqty,0)+ifnull(damagedqty,0) % itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturnprice)) As promoamount from promokeydetail inner join invoicedetail on invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " inner join itemmaster on itemmaster.actualitemcode = invoicedetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";
                        }
                        else if(promotionTypeCode == 5 || promotionTypeCode == 6)
                        {
                            var itemqry="select group_concat(invoicedetail.itemcode) as itemcode," + promotionAmount + " As NewInvoiceAmount, sum(((CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.salescaseprice)) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * invoicedetail.salesprice))) As SalesAmount,sum(ifnull(invoicedetail.salesqty,0)) As SalesQty,(CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.salescaseprice)) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * invoicedetail.salesprice) As promoamount from promokeydetail inner join invoicedetail on invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " inner join itemmaster on itemmaster.actualitemcode = invoicedetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + " group by promokeydetail.plannumber";
                            var itemqry2="select group_concat(invoicedetail.itemcode) as itemcode," + promotionAmount + " As NewInvoiceAmount, sum(((CAST(((ifnull(returnqty,0)+ifnull(damagedqty,0)) / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturncaseprice)) + (CAST(((ifnull(returnqty,0)+ifnull(damagedqty,0)) % itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturnprice)))) As SalesAmount,sum(ifnull(invoicedetail.returnqty,0))+sum(ifnull(invoicedetail.damagedqty,0)) As SalesQty,(CAST(((ifnull(returnqty,0)+ifnull(damagedqty,0)) / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturncaseprice)) + (CAST(((ifnull(returnqty,0)+ifnull(damagedqty,0)) % itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturnprice)) As promoamount from promokeydetail inner join invoicedetail on invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " inner join itemmaster on itemmaster.actualitemcode = invoicedetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + " group by promokeydetail.plannumber";
                        }
                        else if(promotionTypeCode == 7)
                        {
                                   var itemqry="select -1," + promotionAmount + " As NewInvoiceAmount, 0,0,0 from promokeydetail  where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";
                                    var itemqry2="select -1," + promotionAmount + " As NewInvoiceAmount, 0,0,0 from promokeydetail  where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";
                        }           
                        else
                        {
                            var itemqry="select invoicedetail.itemcode," + promotionAmount + " As NewInvoiceAmount, ((CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.salescaseprice)) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * invoicedetail.salesprice)) As SalesAmount,ifnull(invoicedetail.salesqty,0) As SalesQty,(CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.salescaseprice)) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * invoicedetail.salesprice) As promoamount from promokeydetail inner join invoicedetail on invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " inner join itemmaster on itemmaster.actualitemcode = invoicedetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";
                            var itemqry2="select invoicedetail.itemcode," + promotionAmount + " As NewInvoiceAmount, ((CAST((ifnull(returnqty,0)+ifnull(damagedqty,0) / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturncaseprice)) + (CAST((ifnull(returnqty,0)+ifnull(damagedqty,0) % itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturnprice))) As SalesAmount,ifnull(invoicedetail.returnqty,0)+ifnull(invoicedetail.damagedqty,0) As SalesQty,(CAST((ifnull(returnqty,0)+ifnull(damagedqty,0) / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturncaseprice)) + (CAST((ifnull(returnqty,0)+ifnull(damagedqty,0) % itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturnprice)) As promoamount from promokeydetail inner join invoicedetail on invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " inner join itemmaster on itemmaster.actualitemcode = invoicedetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";
                        }
                    }
                    else
                    {
                        if(promotionTypeCode==0)
                        {
                            var itemqry="select productgroupdetail.itemcode," + promotionAmount + " As NewInvoiceAmount, ((CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.salescaseprice)) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * invoicedetail.salesprice)) As SalesAmount,ifnull(invoicedetail.salesqty,0) As SalesQty,(CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * productgroupdetail.promocaseprice) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * productgroupdetail.promopcprice) As promoamount,promocaseprice,promopcprice from promokeydetail inner join promotionassignmentadvanced on promotionassignmentadvanced.assignmentnumber=promokeydetail.assignmentnumber inner join productgroupdetail on  promotionassignmentadvanced.promotionamount = productgroupdetail.groupnumber inner join invoicedetail on productgroupdetail.itemcode = invoicedetail.itemcode and invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " inner join itemmaster on itemmaster.actualitemcode = productgroupdetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";
                            var itemqry2="select productgroupdetail.itemcode," + promotionAmount + " As NewInvoiceAmount, ((CAST((ifnull(returnqty,0)+ifnull(damagedqty,0) / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturncaseprice)) + (CAST((ifnull(returnqty,0)+ifnull(damagedqty,0) % itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturnprice))) As SalesAmount,ifnull(invoicedetail.returnqty,0)+ifnull(invoicedetail.damagedqty,0) As SalesQty,(CAST((ifnull(returnqty,0)+ifnull(damagedqty,0) / itemmaster.unitspercase) AS INTEGER) * productgroupdetail.promocaseprice) + (CAST((ifnull(returnqty,0)+ifnull(damagedqty,0) % itemmaster.unitspercase) AS INTEGER) * productgroupdetail.promopcprice) As promoamount,promocaseprice,promopcprice from promokeydetail inner join promotionassignmentadvanced on promotionassignmentadvanced.assignmentnumber=promokeydetail.assignmentnumber inner join productgroupdetail on  promotionassignmentadvanced.promotionamount = productgroupdetail.groupnumber inner join invoicedetail on productgroupdetail.itemcode = invoicedetail.itemcode and invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " inner join itemmaster on itemmaster.actualitemcode = productgroupdetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";
                        }
                        else if(promotionTypeCode == 5 || promotionTypeCode == 6)
                        {
                            var itemqry="select group_concat(productgroupdetail.itemcode) as itemcode," + promotionAmount + " As NewInvoiceAmount, sum(((CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.salescaseprice)) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * invoicedetail.salesprice))) As SalesAmount,sum(ifnull(invoicedetail.salesqty,0)) As SalesQty,(CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * productgroupdetail.promocaseprice) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * productgroupdetail.promopcprice) As promoamount,promocaseprice,promopcprice from promokeydetail inner join productgroupdetail on  promokeydetail.assignmentgroup = productgroupdetail.groupnumber inner join invoicedetail on productgroupdetail.itemcode = invoicedetail.itemcode and invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " inner join itemmaster on itemmaster.actualitemcode = productgroupdetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + " group by promokeydetail.plannumber";
                             var itemqry2="select group_concat(productgroupdetail.itemcode) as itemcode," + promotionAmount + " As NewInvoiceAmount, sum(((CAST(((ifnull(returnqty,0)+ifnull(damagedqty,0)) / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturncaseprice)) + (CAST(((ifnull(returnqty,0)+ifnull(damagedqty,0)) % itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturnprice)))) As SalesAmount,sum(ifnull(invoicedetail.returnqty,0))+sum(ifnull(invoicedetail.damagedqty,0)) As SalesQty,(CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.salescaseprice)) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * invoicedetail.salesprice) As promoamount,promocaseprice,promopcprice from promokeydetail inner join productgroupdetail on  promokeydetail.assignmentgroup = productgroupdetail.groupnumber inner join invoicedetail on productgroupdetail.itemcode = invoicedetail.itemcode and invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " inner join itemmaster on itemmaster.actualitemcode = productgroupdetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + " group by promokeydetail.plannumber";
                        }
                        else if(promotionTypeCode == 7)
                        {
                            var itemqry="select productgroupdetail.itemcode," + promotionAmount + " As NewInvoiceAmount, (" + promotionAmount + " * defaultsalesprice) As SalesAmount,ifnull(" + promotionAmount + ",0) As SalesQty,(" + promotionAmount + " * productgroupdetail.promopcprice) As promoamount from promokeydetail inner join productgroupdetail on  promokeydetail.assignmentgroup = productgroupdetail.groupnumber inner join inventorysummarydetail on productgroupdetail.itemcode = inventorysummarydetail.itemcode and inventorysummarydetail.routekey = " + sessionStorage.getItem('RouteKey') + " inner join itemmaster on itemmaster.actualitemcode = productgroupdetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";  
                            var itemqry2="select productgroupdetail.itemcode," + promotionAmount + " As NewInvoiceAmount, (" + promotionAmount + " * defaultgoodreturnprice) As SalesAmount,ifnull(" + promotionAmount + ",0) As SalesQty,(" + promotionAmount + " * productgroupdetail.promopcprice) As promoamount from promokeydetail inner join productgroupdetail on  promokeydetail.assignmentgroup = productgroupdetail.groupnumber inner join inventorysummarydetail on productgroupdetail.itemcode = inventorysummarydetail.itemcode and inventorysummarydetail.routekey = " + sessionStorage.getItem('RouteKey') + " inner join itemmaster on itemmaster.actualitemcode = productgroupdetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";  
                        }
                        else
                        {
                            //var itemqry="select productgroupdetail.itemcode," + promotionAmount + " As NewInvoiceAmount, ((CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.salescaseprice)) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * invoicedetail.salesprice)) As SalesAmount,ifnull(invoicedetail.salesqty,0) As SalesQty,(CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * productgroupdetail.promocaseprice) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * productgroupdetail.promopcprice) As promoamount,promocaseprice,promopcprice from promokeydetail inner join productgroupdetail on  promokeydetail.assignmentgroup = productgroupdetail.groupnumber inner join invoicedetail on productgroupdetail.itemcode = invoicedetail.itemcode and invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " inner join itemmaster on itemmaster.actualitemcode = productgroupdetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";
                            //var itemqry2="select productgroupdetail.itemcode," + promotionAmount + " As NewInvoiceAmount, ((CAST((ifnull(returnqty,0)+ifnull(damagedqty,0) / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturncaseprice)) + (CAST((ifnull(returnqty,0)+ifnull(damagedqty,0) % itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturnprice))) As SalesAmount,ifnull(invoicedetail.returnqty,0)+ifnull(invoicedetail.damagedqty,0) As SalesQty,(CAST((ifnull(returnqty,0)+ifnull(damagedqty,0) / itemmaster.unitspercase) AS INTEGER) * productgroupdetail.promocaseprice) + (CAST((returnqty % itemmaster.unitspercase) AS INTEGER) * productgroupdetail.promopcprice) As promoamount,promocaseprice,promopcprice from promokeydetail inner join productgroupdetail on  promokeydetail.assignmentgroup = productgroupdetail.groupnumber inner join invoicedetail on productgroupdetail.itemcode = invoicedetail.itemcode and invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " inner join itemmaster on itemmaster.actualitemcode = productgroupdetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";
                        	
                        	var itemqry="select productgroupdetail.itemcode," + promotionAmount + " As NewInvoiceAmount, ((CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.salescaseprice)) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * invoicedetail.salesprice)) As SalesAmount,ifnull(invoicedetail.salesqty,0) As SalesQty,(CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * productgroupdetail.promocaseprice) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * productgroupdetail.promopcprice) As promoamount,promocaseprice,promopcprice from promokeydetail inner join promoplandetail on promokeydetail.plannumber = promokeydetail.plannumber inner join productgroupdetail on  promoplandetail.assignmentgroup = productgroupdetail.groupnumber inner join invoicedetail on productgroupdetail.itemcode = invoicedetail.itemcode and invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " inner join itemmaster on itemmaster.actualitemcode = productgroupdetail.itemcode where promoplandetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";
                        	var itemqry2="select productgroupdetail.itemcode," + promotionAmount + " As NewInvoiceAmount, ((CAST((ifnull(returnqty,0)+ifnull(damagedqty,0) / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturncaseprice)) + (CAST((ifnull(returnqty,0)+ifnull(damagedqty,0) % itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturnprice))) As SalesAmount,ifnull(invoicedetail.returnqty,0)+ifnull(invoicedetail.damagedqty,0) As SalesQty,(CAST((ifnull(returnqty,0)+ifnull(damagedqty,0) / itemmaster.unitspercase) AS INTEGER) * productgroupdetail.promocaseprice) + (CAST((ifnull(returnqty,0)+ifnull(damagedqty,0) % itemmaster.unitspercase) AS INTEGER) * productgroupdetail.promopcprice) As promoamount,promocaseprice,promopcprice from promokeydetail inner join promoplandetail on promokeydetail.plannumber = promokeydetail.plannumber inner join productgroupdetail on  promoplandetail.assignmentgroup = productgroupdetail.groupnumber inner join invoicedetail on productgroupdetail.itemcode = invoicedetail.itemcode and invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " inner join itemmaster on itemmaster.actualitemcode = productgroupdetail.itemcode where promoplandetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";
                        }
                    }
                }
                console.log("itemqry == "+itemqry);
                console.log("itemqry == "+itemqry2);
                if(returntype ==1)
                {
                if(platform=='iPad')
           		{
                Cordova.exec(function(result) {    
                              
                              
                              if(result.length > 0)
                              {     
                                   
                                    itemIndex = 0;
                                    dataItem = result;
                                                               
                              
                                    if(flag == true)
                                    {
                                        for(itemIndex = 1;itemIndex <= dataItem.length ;itemIndex++)
                                        {                               
                              if(eval(dataItem[itemIndex-1][0]) ==-1)
                              {
                              InsertPromotionDetail(itemIndex,dataItem,index,promotionTypeCode,rangeBasis,repeatingrange,rangeLow,trantype);
                              }
                              else
                              {
                              if(eval(dataItem[itemIndex-1][3]) > 0)
                                            InsertPromotionDetail(itemIndex,dataItem,index,promotionTypeCode,rangeBasis,repeatingrange,rangeLow,trantype);
                              }
                                            // UpdateInvoiceDetail();
                                        }
                                        // navigator.notification.alert("Insert
										// record successfully");
                                        countRecord += 1;
                                    }
                                    else 
                                    {
                                        // navigator.notification.alert("Promotion
										// not avialable for this assignment
										// number");
                                    }
                              }
                              else
                              {                                        
                                // navigator.notification.alert("Item detail not
								// found for assignment number");
                              }
                              },
                              function(error) {
                                navigator.notification.alert("Error in binding item list: " + error);
                              },
                              "PluginClass", 
                              "GetdataMethod",                               
                              [itemqry]);
                }
            	else if(platform=='Android')
            	{
            	    window.plugins.DataBaseHelper.select(itemqry, function(result)
					{              
                        var array = $.map(result.array, function (item, index) {               
                			return [[item.itemcode, item.NewInvoiceAmount, item.SalesAmount,item.SalesQty,item.promoamount,item.promocaseprice,item.promopcprice]];
           				});
           				
           				result = array;   
           				if(result.length > 0)
                              {     
                                    // var flag = false;
                                    itemIndex = 0;
                                    dataItem = result;
                                  
                              
                                    if(flag == true)
                                    {
                                        for(itemIndex = 1;itemIndex <= dataItem.length ;itemIndex++)
                                        {                               
                                                         if(eval(dataItem[itemIndex-1][0]) ==-1)
                                                         {
                                                         InsertPromotionDetail(itemIndex,dataItem,index,promotionTypeCode,rangeBasis,repeatingrange,rangeLow,trantype);
                                                         }
                                                         else
                                                         {
                                            if(eval(dataItem[itemIndex-1][3]) > 0)
                                            InsertPromotionDetail(itemIndex,dataItem,index,promotionTypeCode,rangeBasis,repeatingrange,rangeLow,trantype);
                                                         }
                                            // UpdateInvoiceDetail();
                                        }
                                        // navigator.notification.alert("Insert
										// record successfully");
                                        countRecord += 1;
                                    }
                                    else 
                                    {
                                       // navigator.notification.alert("Promotion
										// not avialable for this assignment
										// number");
                                    }
                              }
                              else
                              {                                        
                                // navigator.notification.alert("Item detail not
								// found for assignment number");
                              } 
					},
					function()
					{
			   	 		console.warn("Error calling plugin");
					});
				}
                }
                if(EnableSalesPromotion == 3)
                {
                    if(returntype ==2)
                    {
                    if(platform=='iPad')
                    {
                        Cordova.exec(function(result) {    
                                      
                                      
                                      if(result.length > 0)
                                      {     
                                      
                                      itemIndex = 0;
                                      dataItem = result;
                                      
                                      
                                      if(flag == true)
                                      {
                                      for(itemIndex = 1;itemIndex <= dataItem.length ;itemIndex++)
                                      {                               
                                      if(eval(dataItem[itemIndex-1][0]) ==-1)
                                      {
                                      InsertPromotionDetail(itemIndex,dataItem,index,promotionTypeCode,rangeBasis,repeatingrange,rangeLow,trantype);
                                      }
                                      else
                                      {
                                      if(eval(dataItem[itemIndex-1][3]) > 0)
                                      InsertPromotionDetail(itemIndex,dataItem,index,promotionTypeCode,rangeBasis,repeatingrange,rangeLow,2);
                                      }
                                      // UpdateInvoiceDetail();
                                      }
                                      // navigator.notification.alert("Insert
										// record successfully");
                                      countRecord += 1;
                                      }
                                      else 
                                      {
                                      // navigator.notification.alert("Promotion
										// not avialable for this assignment
										// number");
                                      }
                                      }
                                      else
                                      {                                        
                                      // navigator.notification.alert("Item
										// detail not found for assignment
										// number");
                                      }
                                      },
                                      function(error) {
                                      navigator.notification.alert("Error in binding item list: " + error);
                                      },
                                      "PluginClass", 
                                      "GetdataMethod",                               
                                      [itemqry2]);
                    }
                    else if(platform=='Android')
                    {
                        window.plugins.DataBaseHelper.select(itemqry2, function(result)
                                                             {              
                                                             var array = $.map(result.array, function (item, index) {               
                                                                               return [[item.itemcode, item.NewInvoiceAmount, item.SalesAmount,item.SalesQty,item.promoamount]];
                                                                               });
                                                             
                                                             result = array;   
                                                             if(result.length > 0)
                                                             {     
                                                             // var flag =
																// false;
                                                             itemIndex = 0;
                                                             dataItem = result;
                                                             
                                                             
                                                             if(flag == true)
                                                             {
                                                             for(itemIndex = 1;itemIndex <= dataItem.length ;itemIndex++)
                                                             {                               
                                                             if(eval(dataItem[itemIndex-1][0]) ==-1)
                                                             {
                                                             InsertPromotionDetail(itemIndex,dataItem,index,promotionTypeCode,rangeBasis,repeatingrange,rangeLow,trantype);
                                                             }
                                                             else
                                                             {
                                                             if(eval(dataItem[itemIndex-1][3]) > 0)
                                                             InsertPromotionDetail(itemIndex,dataItem,index,promotionTypeCode,rangeBasis,repeatingrange,rangeLow,2);
                                                             }
                                                             // UpdateInvoiceDetail();
                                                             }
                                                             // navigator.notification.alert("Insert
																// record
																// successfully");
                                                             countRecord += 1;
                                                             }
                                                             else 
                                                             {
                                                             // navigator.notification.alert("Promotion
																// not avialable
																// for this
																// assignment
																// number");
                                                             }
                                                             }
                                                             else
                                                             {                                        
                                                             // navigator.notification.alert("Item
																// detail not
																// found for
																// assignment
																// number");
                                                             } 
                                                             },
                                                             function()
                                                             {
                                                             console.warn("Error calling plugin");
                                                             });
                    }
                    }
                }
            } 
            function getItemAmountFixed(index,promotionTypeCode,rangeBasis)
            {
                if(EnableSalesPromotion == 1)
                {
                    var assignqry ="select count(*) as cnt from promokeydetail inner join productgroupdetail on  promokeydetail.qualificationgroup = productgroupdetail.groupnumber where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + " and productgroupdetail.itemqty !=0 and productgroupdetail.itemcode not in(select invoicedetail.itemcode from invoicedetail where invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " and salesqty>=productgroupdetail.itemqty)";
                }
                else if(EnableSalesPromotion == 2)
                {
                    var assignqry ="select count(*) as cnt from promokeydetail inner join productgroupdetail on  promokeydetail.qualificationgroup = productgroupdetail.groupnumber where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + " and productgroupdetail.itemqty !=0 and productgroupdetail.itemcode not in(select invoicedetail.itemcode from invoicedetail where invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " and returnqty>=productgroupdetail.itemqty)";
                }
                else if(EnableSalesPromotion == 3)
                {
                    var assignqry ="select count(*) as cnt from promokeydetail inner join productgroupdetail on  promokeydetail.qualificationgroup = productgroupdetail.groupnumber where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + " and productgroupdetail.itemqty !=0 and productgroupdetail.itemcode not in(select invoicedetail.itemcode from invoicedetail where invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " and salesqty>=productgroupdetail.itemqty)";
                    var assignqry2 ="select count(*) as cnt from promokeydetail inner join productgroupdetail on  promokeydetail.qualificationgroup = productgroupdetail.groupnumber where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + " and productgroupdetail.itemqty !=0 and productgroupdetail.itemcode not in(select invoicedetail.itemcode from invoicedetail where invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " and ifnull(returnqty,0)+ifnull(damagedqty,0)>=productgroupdetail.itemqty)";
                }
                console.log(assignqry);
                if(platform=='iPad')
                {
                    Cordova.exec(function(result) {                             
                                  if(result[0][0] == 0)
                                  {                     
                                  
                                  getItemAmountFixed1(index,promotionTypeCode,rangeBasis,0)
                                  }
                                  else 
                                  {
                                  // navigator.notification.alert("Item amount
									// not found");
                                  }
                                  },
                                  function(error) {
                                  navigator.notification.alert("Error in getting item amount : " + error);
                                  },
                                  "PluginClass", 
                                  "GetdataMethod",
                                  [assignqry]);
                    
            	}
            	else if(platform=='Android')
            	{
            	    window.plugins.DataBaseHelper.select(assignqry, function(result)
                                                         {          
                                                         var array = $.map(result.array, function (item, index) {               
                                                                           return [[item.cnt]];
                                                                           });
                                                         
                                                         result = array;
                                                         
                                                         if(result[0][0] == 0)
                                                         {                    
                                                         
                                                         getItemAmountFixed1(index,promotionTypeCode,rangeBasis,0)
                                                         }
                                                         else 
                                                         {
                                                         // navigator.notification.alert("Item
															// amount not
															// found");
                                                         }                       
                                                         },
                                                         function()
                                                         {
                                                         console.warn("Error calling plugin");
                                                         });
				}
                if(EnableSalesPromotion == 3)
                {
                    if(platform=='iPad')
                    {
                        Cordova.exec(function(result) {                             
                                      if(result[0][0] == 0)
                                      { 
                                      getItemAmountFixed1(index,promotionTypeCode,rangeBasis,1)
                                      }
                                      else 
                                      {
                                      // navigator.notification.alert("Item
										// amount not found");
                                      }
                                      },
                                      function(error) {
                                      navigator.notification.alert("Error in getting item amount : " + error);
                                      },
                                      "PluginClass", 
                                      "GetdataMethod",
                                      [assignqry2]);
                        
                    }
                    else if(platform=='Android')
                    {
                        window.plugins.DataBaseHelper.select(assignqry2, function(result)
                                                             {          
                                                             var array = $.map(result.array, function (item, index) {               
                                                                               return [[item.cnt]];
                                                                               });
                                                             
                                                             result = array;
                                                             
                                                             if(result[0][0] == 0)
                                                             { 
                                                             // getItemDetail();
                                                             getItemAmountFixed1(index,promotionTypeCode,rangeBasis,1)
                                                             }
                                                             else 
                                                             {
                                                             // navigator.notification.alert("Item
																// amount not
																// found");
                                                             }                       
                                                             },
                                                             function()
                                                             {
                                                             console.warn("Error calling plugin");
                                                             });
                    }
                }
            }
       // for fixed assignment and qualification type
          function getItemAmountFixed1(index,promotionTypeCode,rangeBasis,type)
            {
                if(EnableSalesPromotion == 1)
                {
                     var assignqry ="select ifnull((invoicedetail.salesqty),0) As TotalQty,(((CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.salescaseprice)) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * invoicedetail.salesprice))) As TotalAmount,productgroupdetail.itemcode,itemqty,onetimeuse from promokeydetail inner join promoplandetail on promoplandetail.plannumber=promokeydetail.plannumber inner join productgroupdetail on  promokeydetail.qualificationgroup = productgroupdetail.groupnumber inner join invoicedetail on productgroupdetail.itemcode = invoicedetail.itemcode and invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " inner join itemmaster on itemmaster.actualitemcode = productgroupdetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";
                }
                else if(EnableSalesPromotion == 2)
                {
                    var assignqry ="select ifnull((invoicedetail.returnqty),0) As TotalQty,(((CAST((returnqty / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturncaseprice)) + (CAST((returnqty % itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturnprice)))) As TotalAmount,productgroupdetail.itemcode,itemqty,onetimeuse from promokeydetail inner join promoplandetail on promoplandetail.plannumber=promokeydetail.plannumber inner join productgroupdetail on  promokeydetail.qualificationgroup = productgroupdetail.groupnumber inner join invoicedetail on productgroupdetail.itemcode = invoicedetail.itemcode and invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " inner join itemmaster on itemmaster.actualitemcode = productgroupdetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";
                }
                else if(EnableSalesPromotion == 3)
                {
                    var assignqry ="select ifnull((invoicedetail.salesqty),0) As TotalQty,(((CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.salescaseprice)) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * invoicedetail.salesprice))) As TotalAmount,productgroupdetail.itemcode,itemqty,onetimeuse from promokeydetail inner join promoplandetail on promoplandetail.plannumber=promokeydetail.plannumber inner join productgroupdetail on  promokeydetail.qualificationgroup = productgroupdetail.groupnumber inner join invoicedetail on productgroupdetail.itemcode = invoicedetail.itemcode and invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " inner join itemmaster on itemmaster.actualitemcode = productgroupdetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";
                    var assignqry2 ="select ifnull((invoicedetail.returnqty)+(invoicedetail.damagedqty),0) As TotalQty,(((CAST(((returnqty+damagedqty) / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturncaseprice)) + (CAST(((returnqty+damagedqty) % itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturnprice)))) As TotalAmount,productgroupdetail.itemcode,itemqty,onetimeuse from promokeydetail inner join promoplandetail on promoplandetail.plannumber=promokeydetail.plannumber inner join productgroupdetail on  promokeydetail.qualificationgroup = productgroupdetail.groupnumber inner join invoicedetail on productgroupdetail.itemcode = invoicedetail.itemcode and invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " inner join itemmaster on itemmaster.actualitemcode = productgroupdetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";
                }
                console.log(assignqry);
                if(type == 0)
                {
                if(platform=='iPad')
                {
                    Cordova.exec(function(result) {                             
                                  if(result.length > 0)
                                  {                     
                                  dataAmount = result;
                                  flag=true;
                                  // getItemDetail();
                                 // getItemDetailFixed(index,flag,promotionTypeCode,rangeBasis,dataAmount[0][4],0,1,0);
                                  getPromotionAssignmentAdvancedFixed(index,promotionTypeCode,rangeBasis,1,dataAmount);
                                  }
                                  else 
                                  {
                                  // navigator.notification.alert("Item amount
									// not found");
                                  }
                                  },
                                  function(error) {
                                  navigator.notification.alert("Error in getting item amount : " + error);
                                  },
                                  "PluginClass", 
                                  "GetdataMethod",
                                  [assignqry]);
                    
            	}
            	else if(platform=='Android')
            	{
            	    window.plugins.DataBaseHelper.select(assignqry, function(result)
                                                         {          
                                                         var array = $.map(result.array, function (item, index) {               
                                                                           return [[item.TotalQty, item.TotalAmount,item.itemcode,item.itemqty,item.onetimeuse]];
                                                                           });
                                                         
                                                         result = array;
                                                         
                                                         if(result.length > 0)
                                                         {                     
                                                         dataAmount = result;
                                                         flag=true;
                                                         // getItemDetail();
                                                        // getItemDetailFixed(index,flag,promotionTypeCode,rangeBasis,dataAmount[0][4],0,1,0);
                                                         getPromotionAssignmentAdvancedFixed(index,promotionTypeCode,rangeBasis,1,dataAmount);
                                                         }
                                                         else 
                                                         {
                                                         // navigator.notification.alert("Item
															// amount not
															// found");
                                                         }                       
                                                         },
                                                         function()
                                                         {
                                                         console.warn("Error calling plugin");
                                                         });
				}
                }
                if(type == 1)
                {
                if(EnableSalesPromotion == 3)
                {
                    if(platform=='iPad')
                    {
                        Cordova.exec(function(result) {                             
                                      if(result.length > 0)
                                      {                     
                                      dataAmount = result;
                                      
                                      flag=true;
                                      // getItemDetail();
                                      // getItemDetailFixed(index,flag,promotionTypeCode,rangeBasis,dataAmount[0][4],0,1,0);
                                      getPromotionAssignmentAdvancedFixed(index,promotionTypeCode,rangeBasis,2,dataAmount);
                                      }
                                      else 
                                      {
                                      // navigator.notification.alert("Item
										// amount not found");
                                      }
                                      },
                                      function(error) {
                                      navigator.notification.alert("Error in getting item amount : " + error);
                                      },
                                      "PluginClass", 
                                      "GetdataMethod",
                                      [assignqry2]);
                        
                    }
                    else if(platform=='Android')
                    {
                        window.plugins.DataBaseHelper.select(assignqry2, function(result)
                                                             {          
                                                             var array = $.map(result.array, function (item, index) {               
                                                                               return [[item.TotalQty, item.TotalAmount,item.itemcode,item.itemqty,item.onetimeuse]];
                                                                               });
                                                             
                                                             result = array;
                                                             
                                                             if(result.length > 0)
                                                             {                     
                                                             dataAmount = result;
                                                             flag=true;
                                                             // getItemDetail();
                                                            // getItemDetailFixed(index,flag,promotionTypeCode,rangeBasis,dataAmount[0][4],0,1,0);
                                                             getPromotionAssignmentAdvancedFixed(index,promotionTypeCode,rangeBasis,2,dataAmount);
                                                             }
                                                             else 
                                                             {
                                                             // navigator.notification.alert("Item
																// amount not
																// found");
                                                             }                       
                                                             },
                                                             function()
                                                             {
                                                             console.warn("Error calling plugin");
                                                             });
                    }
                }
                }
            }
         function getItemAmount(index,promotionTypeCode,rangeBasis)
         {
             
         	 console.log("EnableSalesPromotion="+EnableSalesPromotion);
                 
                 if(EnableSalesPromotion == 1)
                 {
                    
                    if(data[index - 1][8] == 1)
                    {
                        
                
                            var assignqry ="select ifnull(sum(invoicedetail.salesqty),0) As TotalQty,sum(((CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.salescaseprice)) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * invoicedetail.salesprice))) As TotalAmount from promokeydetail inner join invoicedetail on invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " inner join itemmaster on itemmaster.actualitemcode = invoicedetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";
                   
                    }
                    else{
                    
                
                        var assignqry ="select ifnull(sum(invoicedetail.salesqty),0) As TotalQty,sum(((CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.salescaseprice)) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * invoicedetail.salesprice))) As TotalAmount from promokeydetail inner join productgroupdetail on  promokeydetail.qualificationgroup = productgroupdetail.groupnumber inner join invoicedetail on productgroupdetail.itemcode = invoicedetail.itemcode and invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " inner join itemmaster on itemmaster.actualitemcode = productgroupdetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";
                   
                    }
                }
                 else if(EnableSalesPromotion == 2)
                 {
                if(data[index - 1][8] == 1)
                {
                
                
                var assignqry ="select ifnull(sum(invoicedetail.returnqty),0) As TotalQty,sum(((CAST((returnqty / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturncaseprice)) + (CAST((returnqty % itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturnprice)))) As TotalAmount from promokeydetail inner join invoicedetail on invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " inner join itemmaster on itemmaster.actualitemcode = invoicedetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";
                
                }
                else{
                
                
                var assignqry ="select ifnull(sum(invoicedetail.returnqty),0) As TotalQty,sum(((CAST((returnqty / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturncaseprice)) + (CAST((returnqty % itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturnprice)))) As TotalAmount from promokeydetail inner join productgroupdetail on  promokeydetail.qualificationgroup = productgroupdetail.groupnumber inner join invoicedetail on productgroupdetail.itemcode = invoicedetail.itemcode and invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " inner join itemmaster on itemmaster.actualitemcode = productgroupdetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";
                
                }
                 }
                 else if(EnableSalesPromotion == 3)
                 {
                    
                     /*
						 * if(data[index - 1][8] == 1) {
						 * 
						 * 
						 * var assignqry ="select
						 * ifnull(sum(invoicedetail.salesqty),0)
						 * -ifnull(sum(invoicedetail.returnqty),0)-ifnull(sum(invoicedetail.damagedqty),0)
						 * As TotalQty,sum((CAST((salesqty /
						 * itemmaster.unitspercase) AS INTEGER) * (CASE WHEN
						 * p.salescaseprice NOT NULL THEN p.salescaseprice ELSE
						 * itemmaster.caseprice END)) + (CAST((salesqty %
						 * itemmaster.unitspercase) AS INTEGER) *
						 * invoicedetail.salesprice))-sum((CAST((returnqty /
						 * itemmaster.unitspercase) AS INTEGER) * (CASE WHEN
						 * p.returncaseprice NOT NULL THEN p.returncaseprice
						 * ELSE itemmaster.defaultgoodreturncaseprice END)) +
						 * (CAST((returnqty % itemmaster.unitspercase) AS
						 * INTEGER) * (CASE WHEN p.returnprice NOT NULL THEN
						 * p.returnprice ELSE itemmaster.defaultgoodreturnprice
						 * END)))-sum((CAST((damagedqty /
						 * itemmaster.unitspercase) AS INTEGER) * (CASE WHEN
						 * p.returncaseprice NOT NULL THEN p.returncaseprice
						 * ELSE itemmaster.returncaseprice END)) +
						 * (CAST((damagedqty % itemmaster.unitspercase) AS
						 * INTEGER) * invoicedetail.returnprice)) As TotalAmount
						 * from promokeydetail inner join invoicedetail on
						 * invoicedetail.routekey = " +
						 * sessionStorage.getItem('RouteKey') + " and
						 * invoicedetail.visitkey = " +
						 * sessionStorage.getItem('VisitKey') + " inner join
						 * itemmaster on itemmaster.actualitemcode =
						 * invoicedetail.itemcode left join pricingdetail1 p on
						 * p.itemcode = invoicedetail.itemcode and
						 * p.customerpricingkey =(select
						 * ifnull(customerpricing1.customerpricingkey,0) from
						 * customerpricing1 join customermaster on
						 * customerpricing1.pricingplankey =
						 * customermaster.pricingkey and customercode = " +
						 * sessionStorage.getItem("customerid") + ") where
						 * promokeydetail.assignmentnumber = " + data[index -
						 * 1][4] + " and promokeydetail.promotionkey = (select
						 * promotionkey from customermaster where customercode = " +
						 * sessionStorage.getItem('customerid') + ") and
						 * promokeydetail.plannumber = " + data[index - 1][0] +
						 * ""; } else{
						 * 
						 * 
						 * var assignqry ="select
						 * ifnull(sum(invoicedetail.salesqty),0)
						 * -ifnull(sum(invoicedetail.returnqty),0)-ifnull(sum(invoicedetail.damagedqty),0)
						 * As TotalQty,sum((CAST((salesqty /
						 * itemmaster.unitspercase) AS INTEGER) * (CASE WHEN
						 * p.salescaseprice NOT NULL THEN p.salescaseprice ELSE
						 * itemmaster.caseprice END)) + (CAST((salesqty %
						 * itemmaster.unitspercase) AS INTEGER) *
						 * invoicedetail.salesprice))-sum((CAST((returnqty /
						 * itemmaster.unitspercase) AS INTEGER) * (CASE WHEN
						 * p.returncaseprice NOT NULL THEN p.returncaseprice
						 * ELSE itemmaster.defaultgoodreturncaseprice END)) +
						 * (CAST((returnqty % itemmaster.unitspercase) AS
						 * INTEGER) * (CASE WHEN p.returnprice NOT NULL THEN
						 * p.returnprice ELSE itemmaster.defaultgoodreturnprice
						 * END)))-sum((CAST((damagedqty /
						 * itemmaster.unitspercase) AS INTEGER) * (CASE WHEN
						 * p.returncaseprice NOT NULL THEN p.returncaseprice
						 * ELSE itemmaster.returncaseprice END)) +
						 * (CAST((damagedqty % itemmaster.unitspercase) AS
						 * INTEGER) * invoicedetail.returnprice)) As TotalAmount
						 * from promokeydetail inner join productgroupdetail on
						 * promokeydetail.qualificationgroup =
						 * productgroupdetail.groupnumber inner join
						 * invoicedetail on productgroupdetail.itemcode =
						 * invoicedetail.itemcode and invoicedetail.routekey = " +
						 * sessionStorage.getItem('RouteKey') + " and
						 * invoicedetail.visitkey = " +
						 * sessionStorage.getItem('VisitKey') + " inner join
						 * itemmaster on itemmaster.actualitemcode =
						 * productgroupdetail.itemcode left join pricingdetail1
						 * p on p.itemcode = productgroupdetail.itemcode and
						 * p.customerpricingkey =(select
						 * ifnull(customerpricing1.customerpricingkey,0) from
						 * customerpricing1 join customermaster on
						 * customerpricing1.pricingplankey =
						 * customermaster.pricingkey and customercode = " +
						 * sessionStorage.getItem("customerid") + ") where
						 * promokeydetail.assignmentnumber = " + data[index -
						 * 1][4] + " and promokeydetail.promotionkey = (select
						 * promotionkey from customermaster where customercode = " +
						 * sessionStorage.getItem('customerid') + ") and
						 * promokeydetail.plannumber = " + data[index - 1][0] +
						 * ""; }
						 */
                     
                     if(data[index - 1][8] == 1)
                     {
                         
                         
                         var assignqry ="select ifnull(sum(invoicedetail.salesqty),0) As TotalQty,sum(((CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.salescaseprice)) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * invoicedetail.salesprice))) As TotalAmount from promokeydetail inner join invoicedetail on invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " inner join itemmaster on itemmaster.actualitemcode = invoicedetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";
                         var assignqry2 ="select ifnull(sum(invoicedetail.returnqty),0)+ifnull(sum(invoicedetail.damagedqty),0) As TotalQty,sum((CAST(((ifnull(returnqty,0)+ifnull(damagedqty,0)) / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturncaseprice)) + (CAST(((ifnull(returnqty,0)+ifnull(damagedqty,0)) % itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturnprice))) As TotalAmount from promokeydetail inner join invoicedetail on invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " inner join itemmaster on itemmaster.actualitemcode = invoicedetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";
                         
                     }
                     else{
                         
                         
                         var assignqry ="select ifnull(sum(invoicedetail.salesqty),0) As TotalQty,sum(((CAST((salesqty / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.salescaseprice)) + (CAST((salesqty % itemmaster.unitspercase) AS INTEGER) * invoicedetail.salesprice))) As TotalAmount from promokeydetail inner join productgroupdetail on  promokeydetail.qualificationgroup = productgroupdetail.groupnumber inner join invoicedetail on productgroupdetail.itemcode = invoicedetail.itemcode and invoicedetail.routekey = " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " inner join itemmaster on itemmaster.actualitemcode = productgroupdetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";
                         var assignqry2 ="select ifnull(sum(invoicedetail.returnqty),0)+ifnull(sum(invoicedetail.damagedqty),0) As TotalQty,sum((CAST(((ifnull(returnqty,0)+ifnull(damagedqty,0)) / itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturncaseprice)) + (CAST(((ifnull(returnqty,0)+ifnull(damagedqty,0)) % itemmaster.unitspercase) AS INTEGER) * (invoicedetail.goodreturnprice))) As TotalAmount from promokeydetail inner join productgroupdetail on  promokeydetail.qualificationgroup = productgroupdetail.groupnumber inner join invoicedetail on productgroupdetail.itemcode = invoicedetail.itemcode and invoicedetail.routekey= " + sessionStorage.getItem('RouteKey') + " and invoicedetail.visitkey  = " + sessionStorage.getItem('VisitKey') + " inner join itemmaster on itemmaster.actualitemcode = productgroupdetail.itemcode where promokeydetail.assignmentnumber = " + data[index - 1][4] + "  and promokeydetail.promotionkey = (select promotionkey from customermaster where customercode = " + sessionStorage.getItem('customerid') + ") and promokeydetail.plannumber = " + data[index - 1][0] + "";
                         
                     }
                 }
                 console.log(assignqry);
                 console.log(assignqry2);
                 if(platform=='iPad')
           	 {
             Cordova.exec(function(result) {                             
                           if(result.length > 0)
                           {                     
                                dataAmount = result;
                           
                                // getItemDetail();
                                getPromotionAssignmentAdvanced(index,promotionTypeCode,rangeBasis,1);
                           }
                           else 
                           {
                                // navigator.notification.alert("Item amount not
								// found");
                           }
                           },
                           function(error) {
                                navigator.notification.alert("Error in getting item amount : " + error);
                           },
                           "PluginClass", 
                           "GetdataMethod",
                           [assignqry]);
            
            	}
            	else if(platform=='Android')
            	{
            	    window.plugins.DataBaseHelper.select(assignqry, function(result)
					{          
					       var array = $.map(result.array, function (item, index) {               
                			return [[item.TotalQty, item.TotalAmount]];
           				  });
           				  
           				  result = array;
           				   		    
                          if(result.length > 0)
                           {                     
                                dataAmount = result;
                                // getItemDetail();
                                getPromotionAssignmentAdvanced(index,promotionTypeCode,rangeBasis,1);
                           }
                           else 
                           {
                                // navigator.notification.alert("Item amount not
								// found");
                           }                       
					},
					function()
					{
			   	 		console.warn("Error calling plugin");
					});
				}
             if(EnableSalesPromotion == 3)
             {
                 if(platform=='iPad')
                 {
                     Cordova.exec(function(result) {                             
                                   if(result.length > 0)
                                   {                     
                                   dataAmount = result;
                                   
                                   // getItemDetail();
                                   getPromotionAssignmentAdvanced(index,promotionTypeCode,rangeBasis,2);
                                   }
                                   else 
                                   {
                                   // navigator.notification.alert("Item amount
									// not found");
                                   }
                                   },
                                   function(error) {
                                   navigator.notification.alert("Error in getting item amount : " + error);
                                   },
                                   "PluginClass", 
                                   "GetdataMethod",
                                   [assignqry2]);
                     
                 }
                 else if(platform=='Android')
                 {
                     window.plugins.DataBaseHelper.select(assignqry2, function(result)
                                                          {          
                                                          var array = $.map(result.array, function (item, index) {               
                                                                            return [[item.TotalQty, item.TotalAmount]];
                                                                            });
                                                          
                                                          result = array;
                                                          
                                                          if(result.length > 0)
                                                          {                     
                                                          dataAmount = result;
                                                          // getItemDetail();
                                                         
                                                          getPromotionAssignmentAdvanced(index,promotionTypeCode,rangeBasis,2);
                                                          }
                                                          else 
                                                          {
                                                          // navigator.notification.alert("Item
															// amount not
															// found");
                                                          }                       
                                                          },
                                                          function()
                                                          {
                                                          console.warn("Error calling plugin");
                                                          });
                 }
             }
         }   
         // Function for insert promotion detail
         function InsertPromotionDetail(itemIndex,dataItem,index,promotionTypeCode,rangeBasis,repeatingrange,rangeLow,transtype)
            {   
                var insertQry = '';
                $.mobile.hidePageLoadingMsg();
                console.log("itemindex = "+itemIndex);
                if(rangeBasis==2)
                {
                    if(repeatingrange == 1)
                    var rpromoamount = parseInt(eval(dataItem[itemIndex - 1][2])/rangeLow);
                    else
                    var rpromoamount =eval(dataItem[itemIndex - 1][1]);
                    
                }                
                else
                {
                    if(repeatingrange == 1)
                    var rpromoamount = parseInt(dataItem[itemIndex - 1][3]/rangeLow);
                    else
                    var rpromoamount =eval(dataItem[itemIndex - 1][1]);
                }
               
                if(promotionTypeCode == 7)
                {
                    rpromoamount=eval(dataItem[itemIndex - 1][1]);
                }
                /*
				 * if(promotionTypeCode == 7) { if(rangeBasis==2) {
				 * if(repeatingrange == 1) var rpromoamount =
				 * parseInt(dataAmount[0][1]/rangeLow); else var rpromoamount
				 * =eval(dataItem[itemIndex - 1][1]); } else { if(repeatingrange ==
				 * 1) var rpromoamount = parseInt(dataAmount[0][0]/rangeLow);
				 * else var rpromoamount =eval(dataItem[itemIndex - 1][1]); } }
				 */
                if(promotionTypeCode == 1)
                {
                    insertQry = "Insert Into promotiondetail(routekey,visitkey,transactionkey,itemcode,promotiontypecode,promotionamount,oldpromotionamount,promotionplannumber,assignmentkey,weighted,istemp,salesamount,issync,rangelow,repeatingrange,itemtransactiontype,memo1) values("+ sessionStorage.getItem('RouteKey') +","+ sessionStorage.getItem('VisitKey') +",0,"+ dataItem[itemIndex - 1][0] +","+ data[index - 1][3] +","+ eval(rpromoamount).toFixed(decimalplace)  +","+ eval(dataItem[itemIndex - 1][2]).toFixed(decimalplace) +","+ data[index - 1][2] +","+ data[index - 1][4] +",0,'true',"+ eval(dataItem[itemIndex - 1][2]).toFixed(decimalplace) +",0,"+ rangeLow +","+ repeatingrange +","+transtype+",'"+data[index - 1][10]+"')";
                }
                else if(promotionTypeCode == 2)
                {
                    insertQry = "Insert Into promotiondetail(routekey,visitkey,transactionkey,itemcode,promotiontypecode,promotionamount,oldpromotionamount,promotionplannumber,assignmentkey,weighted,istemp,salesamount,issync,rangelow,repeatingrange,itemtransactiontype,memo1) values("+ sessionStorage.getItem('RouteKey') +","+ sessionStorage.getItem('VisitKey') +",0,"+ dataItem[itemIndex - 1][0] +","+ data[index - 1][3] +","+ eval(dataItem[itemIndex - 1][1]).toFixed(decimalplace)  +","+ eval(dataItem[itemIndex - 1][2]).toFixed(decimalplace) +","+ data[index - 1][2] +","+ data[index - 1][4] +",0,'true',"+ eval(dataItem[itemIndex - 1][2]).toFixed(decimalplace) +",0,"+ rangeLow +","+ repeatingrange +","+transtype+",'"+data[index - 1][10]+"')";
                }
                else if(promotionTypeCode == 0)
                {
                    
                    if(dataItem[itemIndex - 1][4]=='' || dataItem[itemIndex - 1][4]==0)
                    dataItem[itemIndex - 1][4]=dataItem[itemIndex - 1][2];
                    
                    var promoamounts = dataItem[itemIndex - 1][2] - dataItem[itemIndex - 1][4];
                    
                    insertQry = "Insert Into promotiondetail(routekey,visitkey,transactionkey,itemcode,promotiontypecode,promotionamount,oldpromotionamount,promotionplannumber,assignmentkey,weighted,istemp,salesamount,issync,rangelow,repeatingrange,itemtransactiontype,promotioncaseprice,promotioneachprice,memo1) values("+ sessionStorage.getItem('RouteKey') +","+ sessionStorage.getItem('VisitKey') +",0,"+ dataItem[itemIndex - 1][0] +","+ data[index - 1][3] +","+eval(promoamounts).toFixed(decimalplace)+","+ dataItem[itemIndex - 1][2] +","+ data[index - 1][2] +","+ data[index - 1][4] +",0,'true',"+ dataItem[itemIndex - 1][2] +",0,"+ rangeLow +","+ repeatingrange +","+transtype+",'"+dataItem[itemIndex - 1][5]+"','"+dataItem[itemIndex - 1][6]+"','"+data[index - 1][10]+"')";
                }
                else if(promotionTypeCode == 5)
                {
                    if(itemIndex == 1)
                    {
                    insertQry = "Insert Into promotiondetail(routekey,visitkey,transactionkey,itemcode,promotiontypecode,promotionamount,oldpromotionamount,promotionplannumber,assignmentkey,weighted,istemp,salesamount,issync,rangelow,repeatingrange,itemtransactiontype,memo1) values("+ sessionStorage.getItem('RouteKey') +","+ sessionStorage.getItem('VisitKey') +",0,'"+dataItem[itemIndex - 1][0]+"',"+ data[index - 1][3] +","+ eval(rpromoamount).toFixed(decimalplace)  +","+ dataItem[itemIndex - 1][2] +","+ data[index - 1][2] +","+ data[index - 1][4] +",0,'true',"+ dataItem[itemIndex - 1][2] +",0,"+ rangeLow +","+ repeatingrange +","+transtype+",'"+data[index - 1][10]+"')";
                    }
                }
                else if(promotionTypeCode == 6)
                {
                    if(itemIndex == 1)
                    {
                        insertQry = "Insert Into promotiondetail(routekey,visitkey,transactionkey,itemcode,promotiontypecode,promotionamount,oldpromotionamount,promotionplannumber,assignmentkey,weighted,istemp,salesamount,issync,rangelow,repeatingrange,itemtransactiontype,memo1) values("+ sessionStorage.getItem('RouteKey') +","+ sessionStorage.getItem('VisitKey') +",0,'"+dataItem[itemIndex - 1][0]+"',"+ data[index - 1][3] +","+ dataItem[itemIndex - 1][1]  +","+ dataItem[itemIndex - 1][2] +","+ data[index - 1][2] +","+ data[index - 1][4] +",0,'true',"+ dataItem[itemIndex - 1][2] +",0,"+ rangeLow +","+ repeatingrange +","+transtype+",'"+data[index - 1][10]+"')";
                    }
                }
                else if(promotionTypeCode == 7)
                {
                    console.log(rpromoamount+"----");
                            
                    insertQry = "Insert Into promotiondetail(routekey,visitkey,transactionkey,itemcode,promotiontypecode,promotionquantity,promotionplannumber,assignmentkey,weighted,istemp,salesamount,issync,rangelow,repeatingrange,itemtransactiontype,memo1) values("+ sessionStorage.getItem('RouteKey') +","+ sessionStorage.getItem('VisitKey') +",0,"+ dataItem[itemIndex - 1][0] +","+ data[index - 1][3] +","+ eval(rpromoamount).toFixed(decimalplace)  +","+ data[index - 1][2] +","+ data[index - 1][4] +",0,'true',"+ dataItem[itemIndex - 1][2] +",0,"+ rangeLow +","+ repeatingrange +","+transtype+",'"+data[index - 1][10]+"')";
                    console.log("promoinsert_list_2702"+ insertQry);
                }
                
                console.log(insertQry);
                               
                if(platform=='iPad')
           	 	{
                Cordova.exec(function(result) 
                              {                                   
                                    $("#tbl1 tr:eq("+ (index) +") td:eq(3)").html(1);
                              $("#tbl1 tr:eq("+ (index) +") td:eq(0) img").css({"display":"block"});
                                // navigator.notification.alert("Insert record
								// successfully");
                              },
                              function(error) {
                                navigator.notification.alert("Error inserting record in promotion detail");
                              },
                              "PluginClass", 
                              "InsertUpdateMethod", 
                              [insertQry]);
            	}
            	else if(platform=='Android')
            	{          
            		window.plugins.DataBaseHelper.insert(insertQry,function(result)
					{
                        $("#tbl1 tr:eq("+ (index) +") td:eq(3)").html(1);    
                        $("#tbl1 tr:eq("+ (index) +") td:eq(0) img").css({"display":"block"});
						// navigator.notification.alert("Insert record
						// successfully");
					},
					function()
					{
			   	 		console.warn("Error calling plugin");
					});
				}  
            }        
            
            // Function for bind selected record for promtion when next time
			// user coming on this screen.
            function selectPromotionList()
            {
                
                var plan = new Array();
            	if(platform=='iPad')
           	 	{
            			Cordova.exec(function(result) 
            		    {                              
                              if(result.length > 0)
                              { 
                             
                                for(i=0;i < result.length ;i++)
                                {    
                                    for(j=0;j < data.length;j++)
                                    {    
                                      
                                        if(data[j][0] == result[i][0])
                                        {  
                                            $("#tbl1 tr:eq("+ (j + 1) +")").toggleClass('clicked',false);
                                            $("#tbl1 tr:eq("+ (j + 1) +")").toggleClass('clicked');
                                          // $("#tbl1 tr:eq("+ (j + 1) +")
											// td:eq(0)
											// img").css({"display":"block"});
                                            // $("#tbl1 tr:eq("+ (j + 1) +")
											// td:eq(3)").html(1);
                              
                                            countRecord += 1;
                                            arrayPlan.push(data[j][0]); 
                              DeletePromotionDetail(j+1);
                              promotionTypeCode = eval(data[j][3]);           
                              rangeBasis = eval(data[j][5]);     
                             
                              if(rangeBasis==3)
                              getItemAmountFixed(j+1,promotionTypeCode,rangeBasis);
                              else
                              getItemAmount(j+1,promotionTypeCode,rangeBasis);
                                            // sessionStorage.setItem('arrayplan',arrayPlan);
                                        }
                                        
                                    }
                                }
                              
                              if(sessionStorage.getItem('arrayplan') == '' || sessionStorage.getItem('arrayplan') == null || sessionStorage.getItem('arrayplan') =='null')
                              {
                             
                              } 
                              else
                              {
                               arrayPlan = sessionStorage.getItem('arrayplan').split(',');
                              
                              }
                              
                                    for(i=0;i < data.length;i++)
                                    {
                                
                                        for(k=0;k < arrayPlan.length;k++)
                                        {
                             
                                            if(eval(data[i][0]) == eval(arrayPlan[k]))
                                            {                       
                                                $("#tbl1 tr:eq("+ (i + 1) +")").toggleClass('clicked',false);              
                                                $("#tbl1 tr:eq("+ (i + 1) +")").toggleClass('clicked');
                                                // $("#tbl1 tr:eq("+ (i + 1) +")
												// td:eq(0)
												// img").css({"display":"block"});
                                            }
                              
                                        }
                                    }
                              
                                   /*
									 * for(i=0;i < data.length;i++) { for(j=0;j <
									 * plan.length;j++) { alert(data[i][0]);
									 * alert(plan[j]);
									 * 
									 * if(eval(data[i][0]) == eval(plan[j])) {
									 * $("#tbl1 tr:eq("+ (i + 1) +") td:eq(0)
									 * img").css({"display":"block"}); } } }
									 */
                              }
                              else 
                              {
                              if(sessionStorage.getItem('arrayplan') == '' || sessionStorage.getItem('arrayplan') == null || sessionStorage.getItem('arrayplan') =='null')
                              {
                              
                              } 
                              else
                              {
                              arrayPlan = sessionStorage.getItem('arrayplan').split(',');
                              }
                              
                                    for(i=0;i < data.length;i++)
                                    {
                              
                                        for(k=0;k < arrayPlan.length;k++)
                                        {
                              
                                            if(eval(data[i][0]) == eval(arrayPlan[k]))
                                            {                       
                                            	$("#tbl1 tr:eq("+ (i + 1) +")").toggleClass('clicked',false);                  
                                            	$("#tbl1 tr:eq("+ (i + 1) +")").toggleClass('clicked');
                                                // $("#tbl1 tr:eq("+ (i + 1) +")
                                            	// td:eq(0)
										        // img").css({"display":"block"});
                                            }
                              
                                        }
                                    }
                              }
                              },
                              function(error) {
                                navigator.notification.alert("Error in select promotion list: " + error);
                              },
                              "PluginClass", 
                              "GetdataMethod", 
                              ["select distinct promokeydetail.plannumber from promokeydetail inner join customermaster on promokeydetail.promotionkey = customermaster.promotionkey inner join promotiondetail on promokeydetail.plannumber = promotiondetail.promotionplannumber  where customermaster.customercode = "+ sessionStorage.getItem('customerid') +" and promotiondetail.routekey = "+ sessionStorage.getItem('RouteKey') +" and promotiondetail.visitkey = "+ sessionStorage.getItem('VisitKey') +""]);            
            	}
            	else if(platform=='Android')
            	{          
            		window.plugins.DataBaseHelper.select("select distinct promokeydetail.plannumber from promokeydetail inner join customermaster on promokeydetail.promotionkey = customermaster.promotionkey inner join promotiondetail on promokeydetail.plannumber = promotiondetail.promotionplannumber  where customermaster.customercode = "+ sessionStorage.getItem('customerid') +" and promotiondetail.routekey = "+ sessionStorage.getItem('RouteKey') +" and promotiondetail.visitkey = "+ sessionStorage.getItem('VisitKey') +"",function(result)
					{
						var array = $.map(result.array, function (item, index) {               
                		return [[item.plannumber]];
            			});
            			
            			result = array;
            			
						if(result.length > 0)
                              { 
                             
                                for(i=0;i < result.length ;i++)
                                {    
                                    for(j=0;j < data.length;j++)
                                    {    
                                      
                                        if(data[j][0] == result[i][0])
                                        {  
                                            $("#tbl1 tr:eq("+ (j + 1) +")").toggleClass('clicked',false);
                                            $("#tbl1 tr:eq("+ (j + 1) +")").toggleClass('clicked');
                                          // $("#tbl1 tr:eq("+ (j + 1) +")
											// td:eq(0)
											// img").css({"display":"block"});
                                            // $("#tbl1 tr:eq("+ (j + 1) +")
											// td:eq(3)").html(1);
                              
                                            countRecord += 1;
                                            arrayPlan.push(data[j][0]); 
                                            DeletePromotionDetail(j+1);
                                            promotionTypeCode = eval(data[j][3]);           
                                            rangeBasis = eval(data[j][5]);     
                             
                              
                                                         if(rangeBasis==3)
                                                         getItemAmountFixed(j+1,promotionTypeCode,rangeBasis);
                                                         else
                                                         getItemAmount(j+1,promotionTypeCode,rangeBasis);
                                            // sessionStorage.setItem('arrayplan',arrayPlan);
                                        }
                                        
                                    }
                                }
                              
                              if(sessionStorage.getItem('arrayplan') == '' || sessionStorage.getItem('arrayplan') == null || sessionStorage.getItem('arrayplan') =='null')
                              {
                             
                              } 
                              else
                              {
                               arrayPlan = sessionStorage.getItem('arrayplan').split(',');
                              
                              }
                              
                                    for(i=0;i < data.length;i++)
                                    {
                                
                                        for(k=0;k < arrayPlan.length;k++)
                                        {
                             
                                            if(eval(data[i][0]) == eval(arrayPlan[k]))
                                            {                       
                                                $("#tbl1 tr:eq("+ (i + 1) +")").toggleClass('clicked',false);              
                                                $("#tbl1 tr:eq("+ (i + 1) +")").toggleClass('clicked');
                                                // $("#tbl1 tr:eq("+ (i + 1) +")
												// td:eq(0)
												// img").css({"display":"block"});
                                            }
                              
                                        }
                                    }
                              
                                   /*
									 * for(i=0;i < data.length;i++) { for(j=0;j <
									 * plan.length;j++) { alert(data[i][0]);
									 * alert(plan[j]);
									 * 
									 * if(eval(data[i][0]) == eval(plan[j])) {
									 * $("#tbl1 tr:eq("+ (i + 1) +") td:eq(0)
									 * img").css({"display":"block"}); } } }
									 */
                              }
                              else 
                              {
                              if(sessionStorage.getItem('arrayplan') == '' || sessionStorage.getItem('arrayplan') == null || sessionStorage.getItem('arrayplan') =='null')
                              {
                              
                              } 
                              else
                              {
                              arrayPlan = sessionStorage.getItem('arrayplan').split(',');
                              }
                              
                                    for(i=0;i < data.length;i++)
                                    {
                              
                                        for(k=0;k < arrayPlan.length;k++)
                                        {
                              
                                            if(eval(data[i][0]) == eval(arrayPlan[k]))
                                            {                       
                              $("#tbl1 tr:eq("+ (i + 1) +")").toggleClass('clicked',false);                  
                              $("#tbl1 tr:eq("+ (i + 1) +")").toggleClass('clicked');
                                            // $("#tbl1 tr:eq("+ (i + 1) +")
											// td:eq(0)
											// img").css({"display":"block"});
                                            }
                              
                                        }
                                    }
                              }                          
                                                         
					},
					function()
					{
			   	 		console.warn("Error calling plugin");
					});
				}  
            }
            var previnvindex = '';
       function UpdateInvoiceDetail(invoiceIndex,type)
            {
                var UpdateQry = ''; 
                      
                promotiontype = eval(dataInvoice[invoiceIndex][1]);     
                console.log(invoiceIndex);
                UpdatePromotionDetail(invoiceIndex,type);
                
                    if(eval(dataInvoice[invoiceIndex][1]) == 1)
                    {
                        dataInvoice[invoiceIndex][3] = eval(dataInvoice[invoiceIndex][3]);
                        
                        totalpromo += eval(dataInvoice[invoiceIndex][3]); 
                       // type 1 sales promotion type 2 return promotion
                        if(eval(dataInvoice[invoiceIndex][12]) == 1)
                        {
                        UpdateQry = "Update invoicedetail set promoamount = promoamount + "+ eval(dataInvoice[invoiceIndex][3]).toFixed(decimalplace) +",promovalue = promovalue + "+ eval(dataInvoice[invoiceIndex][3]).toFixed(decimalplace) +",issync=0 where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ dataInvoice[invoiceIndex][0] +"";
                        }
                        else
                        {
                            UpdateQry = "Update invoicedetail set returnpromoamount = ifnull(returnpromoamount,0) + "+ eval(dataInvoice[invoiceIndex][3]).toFixed(decimalplace) +",returnpromovalue = returnpromovalue + "+ eval(dataInvoice[invoiceIndex][3]).toFixed(decimalplace) +",issync=0 where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ dataInvoice[invoiceIndex][0] +"";
                        }
                        
                                                   
                    }
                    else if(eval(dataInvoice[invoiceIndex][1]) == 0)
                    {
                    dataInvoice[invoiceIndex][3] = eval(dataInvoice[invoiceIndex][3]);
                    
                    totalpromo += eval(dataInvoice[invoiceIndex][3]); 
                        if(eval(dataInvoice[invoiceIndex][12]) == 1)
                        {
                    
                            UpdateQry = "Update invoicedetail set promoamount = promoamount + "+ eval(dataInvoice[invoiceIndex][3]).toFixed(decimalplace) +",promovalue = promovalue + "+ eval(dataInvoice[invoiceIndex][3]).toFixed(decimalplace) +",issync=0 where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ dataInvoice[invoiceIndex][0] +"";
                        }
                        else
                        {
                            UpdateQry = "Update invoicedetail set returnpromoamount = ifnull(returnpromoamount,0) + "+ eval(dataInvoice[invoiceIndex][3]).toFixed(decimalplace) +",returnpromovalue = returnpromovalue + "+ eval(dataInvoice[invoiceIndex][3]).toFixed(decimalplace) +",issync=0 where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ dataInvoice[invoiceIndex][0] +"";
                        }
                    
                    
                    }
                    else if(eval(dataInvoice[invoiceIndex][1]) == 2)
                    {
                        dataInvoice[invoiceIndex][3] = eval(dataInvoice[invoiceIndex][3]).toFixed(decimalplace);
                        dataInvoice[invoiceIndex][4] = eval(dataInvoice[invoiceIndex][4]).toFixed(decimalplace);
                        
                                              
                        totalpromo += ((eval(dataInvoice[invoiceIndex][4]).toFixed(decimalplace)) * ((eval(dataInvoice[invoiceIndex][3]).toFixed(decimalplace))/100));
                                             
                        if(dataInvoice[invoiceIndex][11] == 1)
                        {
                            
                            updaterepeaterange(dataInvoice,invoiceIndex,type);
                        }
                        else
                        {
                            if(eval(dataInvoice[invoiceIndex][12]) == 1)
                            { 
                            UpdateQry = "Update invoicedetail set promoamount = ROUND(promoamount + (("+ eval(dataInvoice[invoiceIndex][4]).toFixed(decimalplace)+" - promoamount) * (("+ eval(dataInvoice[invoiceIndex][3]).toFixed(decimalplace) +")/100.0)),"+decimalplace+"),  promovalue = promovalue + (("+ eval(dataInvoice[invoiceIndex][4]).toFixed(decimalplace)+" - promoamount) * (("+ eval(dataInvoice[invoiceIndex][3]).toFixed(decimalplace) +")/100.0)),issync=0 where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ dataInvoice[invoiceIndex][0] +"";
                            }
                            else
                            {
                                UpdateQry = "Update invoicedetail set returnpromoamount = ROUND(ifnull(returnpromoamount,0) + (("+ eval(dataInvoice[invoiceIndex][4]).toFixed(decimalplace)+" - returnpromoamount) * (("+ eval(dataInvoice[invoiceIndex][3]).toFixed(decimalplace) +")/100.0)),"+decimalplace+"),  returnpromovalue = returnpromovalue + (("+ dataInvoice[invoiceIndex][4]+" + returnpromovalue) * (("+ eval(dataInvoice[invoiceIndex][3]).toFixed(decimalplace) +")/100.0)),issync=0 where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ dataInvoice[invoiceIndex][0] +"";
                            }
                        }
                        
                       
                                               
                    }
                
                    else if(eval(dataInvoice[invoiceIndex][1]) == 5)
                    {
                        dataInvoice[invoiceIndex][3] = eval(dataInvoice[invoiceIndex][3]).toFixed(decimalplace);
                        
                        if(eval(dataInvoice[invoiceIndex][12]) == 1)
                        { 
                        UpdateQry = "Update invoiceheader set totalpromoamount = ifnull(totalpromoamount,0) + "+ eval(dataInvoice[invoiceIndex][3]).toFixed(decimalplace) +",issync=0 where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +"";
                        }
                        else
                        {
                            UpdateQry = "Update invoiceheader set totalpromoamount = ifnull(totalpromoamount,0) - "+ eval(dataInvoice[invoiceIndex][3]).toFixed(decimalplace) +",issync=0 where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +"";
                        }
                                               
                    }
                    else if(eval(dataInvoice[invoiceIndex][1]) == 6)
                    {
                        dataInvoice[invoiceIndex][3] = eval(dataInvoice[invoiceIndex][3]).toFixed(decimalplace);
                        if(dataInvoice[invoiceIndex][11] == 1)
                        {
                            
                            updateinvoicerepeaterange(dataInvoice,invoiceIndex,type);
                        }
                        else
                        {
                            if(eval(dataInvoice[invoiceIndex][12]) == 1)
                            {
                            UpdateQry = "Update invoiceheader set totalpromoamount = ifnull(totalpromoamount,0) + ((("+eval(dataInvoice[invoiceIndex][9]).toFixed(decimalplace)+") - (select sum(promoamount) from invoicedetail where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode IN ("+ dataInvoice[invoiceIndex][0] +"))) * ("+ eval(dataInvoice[invoiceIndex][3]).toFixed(decimalplace) +")/100),issync=0 where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +"";
                            }
                            else
                            {
                                UpdateQry = "Update invoiceheader set totalpromoamount = ifnull(totalpromoamount,0) - ((("+eval(dataInvoice[invoiceIndex][9]).toFixed(decimalplace)+") - (select sum(returnpromoamount) from invoicedetail where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode IN ("+ dataInvoice[invoiceIndex][0] +"))) * ("+ eval(dataInvoice[invoiceIndex][3]).toFixed(decimalplace) +")/100),issync=0 where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +"";
                            }
                            
                        }
                    }
                    else if(eval(dataInvoice[invoiceIndex][1]) == 7)
                    {
                        dataInvoice[invoiceIndex][2] = eval(dataInvoice[invoiceIndex][2]);
                        
                        
                        if(eval(dataInvoice[invoiceIndex][12]) == 1)
                        {
                            totalfree += eval(dataInvoice[invoiceIndex][2]);
                        UpdateQry = "Update invoicedetail set promoqty = promoqty + "+ dataInvoice[invoiceIndex][2] +",issync=0 where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ dataInvoice[invoiceIndex][0] +"";   
                        }
                        else
                        {
                            totalfree =totalfree - eval(dataInvoice[invoiceIndex][2]);
                            UpdateQry = "Update invoicedetail set promoqty = promoqty - "+ dataInvoice[invoiceIndex][2] +",issync=0 where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ dataInvoice[invoiceIndex][0] +"";  
                        }
                    }
                console.log(UpdateQry);
                                               
                if(platform=='iPad')
           	 	{            
                Cordova.exec(function(result) 
                              {
                                // navigator.notification.alert("Update invoice
								// detail successfully");
                              // alert(promotiontype);
                                if(promotiontype == 1 || promotiontype == 2 || promotiontype == 0)
                                {                                   
                                   
                                    UpdateInvoiceHeader(type);                                                   

                                }
                             
                                if(invoiceIndex+1 < totalinvoice)
                                {                                    
                                    UpdateInvoiceDetail(invoiceIndex+1,type);                                    
                                }
                                else
                                {                                   
                                    checkRecordCount('linkContinue'); 
                                }
                              },
                              function(error) {
                                navigator.notification.alert("Error in updating record in invoice detail");
                              },
                              "PluginClass", 
                              "InsertUpdateMethod", 
                              [UpdateQry]);
            	}
            	else if(platform=='Android')
            	{          
            		window.plugins.DataBaseHelper.insert(UpdateQry,function(result)
					{
						// navigator.notification.alert("Update invoice detail
						// successfully");
                                                       
                                                         if(promotiontype == 1 || promotiontype == 2 || promotiontype == 7)
                                                         {                                   
                                                         
                                                            UpdateInvoiceHeader(type);
                                                            
                                                         }
                                                         
                                                         if(invoiceIndex+1 < totalinvoice)
                                                         {
                                                         UpdateInvoiceDetail(invoiceIndex+1,type);
                                                         }
                                                         else
                                                         {
                                                         checkRecordCount('linkContinue'); 
                                                         }                                                       
					},
					function()
					{
			   	 		console.warn("Error calling plugin");
					});
				}           
            }
            
            function UpdateInvoiceHeader(type)   
            {              
                
                var uqry = '';
              
                
                if(promotiontype == 1 || promotiontype == 2 ||  promotiontype == 0)
                {
                       uqry = "update invoiceheader set totalpromoamount = (select sum(ROUND(ifnull(promoamount,0),"+decimalplace+")-ROUND(ifnull(returnpromoamount,0),"+decimalplace+")) from invoicedetail where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +"),issync=0 where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +"";                      
                    console.log(uqry);
                }
                else if(promotiontype == 7)
                {
                     uqry = "update invoiceheader set totalmanualfree = "+ totalfree +",issync=0 where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +"";
                }
                
              
                if(platform=='iPad')
           	 	{            
                    Cordova.exec(function(result) 
                                  {
                        deleteallpromotionfreetmp();
                                  // navigator.notification.alert("Update
									// invoice detail successfully");
                                 // return true;
                                  },
                                  function(error) {
                                    navigator.notification.alert("Error in updating record in invoice detail");
                                  },
                                  "PluginClass", 
                                  "InsertUpdateMethod", 
                                  [uqry]);
            	}
                else if(platform=='Android')
            	{          
            		window.plugins.DataBaseHelper.insert(uqry,function(result)
                                                         {
            		    deleteallpromotionfreetmp();
                                                         // navigator.notification.alert("Update
															// invoice detail
															// successfully");
                                                     // return true;
                                                         },
                                                         function()
                                                         {
                                                         console.warn("Error calling plugin");
                                                         });
				}          
            }
            function updateinvoicerepeaterange(datainvoice,index,type)
            {
                var selectqry = "select sum(promoamount),sum(retrunpromoamount) from invoicedetail where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode IN ("+ dataInvoice[index][0] +")";
                if(platform=='iPad')
                {
                    Cordova.exec(function(result) {
                                  var promoamount = eval(result[0][0]).toFixed(decimalplace);
                                  var returnpromoamount = eval(result[0][1]).toFixed(decimalplace);
                                  var finalamount = 0;
                                  if(type == 1) 
                                  var totalamount = eval(dataInvoice[index][9]).toFixed(decimalplace) - eval(promoamount);
                                  else
                                  var totalamount = eval(dataInvoice[index][9]).toFixed(decimalplace) - eval(returnpromoamount);
                                  while( totalamount >= eval(dataInvoice[index][10]))
                                  {
                                  finalamount = finalamount + eval(dataInvoice[index][10]) * (eval(dataInvoice[index][3]).toFixed(decimalplace)/100);
                                  totalamount = totalamount - eval(dataInvoice[index][10]);
                                  }
                                  if(type == 1) 
                                  {
                                    UpdateQry = "Update invoiceheader set totalpromoamount = ifnull(totalpromoamount,0) +"+finalamount+" ,issync=0 where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +"";
                                  
                                  }
                                  else
                                  {
                                    UpdateQry = "Update invoiceheader set totalpromoamount = ifnull(totalpromoamount,0) -"+finalamount+" ,issync=0 where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +"";
                                  }
                                  
                                  
                                  Cordova.exec(function(result) 
                                                {
                                                // navigator.notification.alert("Update
												// invoice detail
												// successfully");
                                                return true;
                                                },
                                                function(error) {
                                                navigator.notification.alert("Error in updating record in invoice detail");
                                                },
                                                "PluginClass", 
                                                "InsertUpdateMethod", 
                                                [UpdateQry]);
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  },
                                  function(error) {
                                  alert(error);},
                                  "PluginClass", 
                                  "GetdataMethod", 
                                  [selectqry]);
                }
                else if(platform=='Android')
                {
                    window.plugins.DataBaseHelper.select(selectqry,function(result)
                                                         {
                                                         var promoamount = eval(result.array[0][0]).toFixed(decimalplace);
                                                         var finalamount = 0;
                                                         var totalamount = eval(dataInvoice[index][4]).toFixed(decimalplace) - eval(promoamount);
                                                         while( totalamount >= eval(dataInvoice[index][10]))
                                                         {
                                                         finalamount = finalamount + eval(dataInvoice[index][10]) * (eval(dataInvoice[index][3]).toFixed(decimalplace)/100);
                                                         totalamount = totalamount - eval(dataInvoice[index][10]);
                                                         }
                                                         if(type == 1) 
                                                         {
                                                         UpdateQry = "Update invoiceheader set totalpromoamount = ifnull(totalpromoamount,0) +"+finalamount+" ,issync=0 where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +"";
                                                         }
                                                         else
                                                         {
                                                         UpdateQry = "Update invoiceheader set totalpromoamount = ifnull(totalpromoamount,0) -"+finalamount+" ,issync=0 where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +"";
                                                         }
                                                         window.plugins.DataBaseHelper.insert(UpdateQry,function(result)
                                                                                              {
                                                                                              // navigator.notification.alert("Update
																								// invoice
																								// detail
																								// successfully");
                                                                                              return true;
                                                                                              },
                                                                                              function()
                                                                                              {
                                                                                              console.warn("Error calling plugin");
                                                                                              });
                                                         },
                                                         function()
                                                         {
                                                         console.warn("Error calling plugin");
                                                         });
                }

            }
            function updaterepeaterange(datainvoice,index,type)
            {
                var selectqry = "select promoamount,returnpromoamount from invoicedetail where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ dataInvoice[index][0] +"";
                if(platform=='iPad')
                {
                    Cordova.exec(function(result) {
                                  var promoamount = eval(result[0][0]).toFixed(decimalplace);
                                  var retrunpromoamount = eval(result[0][1]).toFixed(decimalplace);
                                  console.log("promoamount="+promoamount);
                                  var finalamount = 0;
                                 if(eval(dataInvoice[index][12]) ==1)
                                  var totalamount = eval(dataInvoice[index][4]).toFixed(decimalplace) - eval(promoamount);
                                  else
                                  var totalamount = eval(dataInvoice[index][4]).toFixed(decimalplace) - eval(retrunpromoamount);
                                  while( totalamount >= eval(dataInvoice[index][10]))
                                  {
                                  finalamount = finalamount + eval(dataInvoice[index][10]) * (eval(dataInvoice[index][3]).toFixed(decimalplace)/100);
                                  totalamount = totalamount - eval(dataInvoice[index][10]);
                                  console.log("totalamount="+totalamount);
                                  }
                                  if(eval(dataInvoice[index][12]) ==1)
                                  {
                                  UpdateQry = "Update invoicedetail set promoamount = promoamount + "+finalamount+",  promovalue = promovalue + "+finalamount+",issync=0 where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ dataInvoice[index][0] +"";
                                  }
                                  else
                                  {
                                  UpdateQry = "Update invoicedetail set returnpromoamount = returnpromoamount + "+finalamount+",  returnpromoamount = returnpromoamount + "+finalamount+",issync=0 where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ dataInvoice[index][0] +"";
                                  }
                                  console.log(UpdateQry);
                                                
                                  Cordova.exec(function(result) 
                                                {
                                                // navigator.notification.alert("Update
												// invoice detail
												// successfully");
                                                return true;
                                                },
                                                function(error) {
                                                navigator.notification.alert("Error in updating record in invoice detail");
                                                },
                                                "PluginClass", 
                                                "InsertUpdateMethod", 
                                                [UpdateQry]);
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  },
                                                  function(error) {
                                                  alert(error);},
                                                  "PluginClass", 
                                                  "GetdataMethod", 
                                                  [selectqry]);
                }
                else if(platform=='Android')
                {
                    window.plugins.DataBaseHelper.select(selectqry,function(result)
                                                         {
                    	// org line sujee commented 03/10/2019
                                                       //  var promoamount = eval(result.array[0][0]).toFixed(decimalplace);
                                                         var promoamount = eval(result.array[0][0]);
                                                         alert('promoamount' +promoamount);
                                                         var finalamount = 0;
                                                      
                                                         var totalamount = eval(dataInvoice[index][4]).toFixed(decimalplace) - eval(promoamount);
                                                        alert('totalamount' +totalamount);
                                                         while( totalamount >= eval(dataInvoice[index][10]))
                                                         { alert("while");
                                                         finalamount = finalamount + eval(dataInvoice[index][10]) * (eval(dataInvoice[index][3]).toFixed(decimalplace)/100);
                                                         totalamount = totalamount - eval(dataInvoice[index][10]);
                                                         }
                                                         if(eval(dataInvoice[index][12]) ==1)
                                                         {
                                                         UpdateQry = "Update invoicedetail set promoamount = promoamount + "+finalamount+",  promovalue = promovalue + "+finalamount+",issync=0 where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ dataInvoice[index][0] +"";
                                                         }
                                                         else
                                                         {
                                                         UpdateQry = "Update invoicedetail set promoamount = promoamount - "+finalamount+",  promovalue = promovalue + "+finalamount+",issync=0 where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ dataInvoice[index][0] +"";
                                                         }
                                                         window.plugins.DataBaseHelper.insert(UpdateQry,function(result)
                                                                                              {
                                                                                              // navigator.notification.alert("Update
																								// invoice
																								// detail
																								// successfully");
                                                                                              return true;
                                                                                              },
                                                                                              function()
                                                                                              {
                                                                                              console.warn("Error calling plugin");
                                                                                              });
                                                         },
                                                         function()
                                                         {
                                                         console.warn("Error calling plugin");
                                                         });
                }
            }
           function UpdatePromotionDetail(index,type)
            {
                var updatePromo = '';
                var rowid = 0,itemID = 0,ptype = 0,tempPlan = 0,amount = 0;
               
                
                ptype = eval(dataInvoice[index][1]);
                rowid =  eval(dataInvoice[index][8]);
                itemID = dataInvoice[index][0];
                itemtrantype = eval(dataInvoice[index][12]);
                console.log(flagpromo+" = "+flagpromo2);
                console.log("promotiondetail update" + ptype);
                amount = (eval(dataInvoice[index][9]).toFixed(decimalplace) - eval(dataInvoice[index][3]).toFixed(decimalplace));
                count1 += 1;
                                
                if(ptype == 0)
                {
                    
                    flagpromo = true;
                    
                                        
                    updatePromo = "update promotiondetail set oldpromotionamount = case when (select CASE WHEN  itemtransactiontype =1 THEN (oldpromotionamount - promotionamount) ELSE (oldpromotionamount - promotionamount) END from promotiondetail where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemID +" and itemtransactiontype="+itemtrantype+" and promotiontypecode = 0 and orderid < "+ count1 +" and orderid <> 0 order by orderid desc limit 1) Is NULL Then oldpromotionamount Else (select CASE WHEN  itemtransactiontype =1 THEN (oldpromotionamount - promotionamount) ELSE (oldpromotionamount - promotionamount) END from promotiondetail where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemID +" and itemtransactiontype="+itemtrantype+" and promotiontypecode = 0 and orderid < "+ count1 +" and orderid <> 0 order by orderid desc limit 1) End,issync=0 where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemID +" and itemtransactiontype="+itemtrantype+" and rowid = "+ rowid +"";
                    
                    console.log(updatePromo);
                }
                else if(ptype == 1)
                {
                    
                    flagpromo = true;
                    
                  
                    
                    updatePromo = "update promotiondetail set oldpromotionamount = case when (select CASE WHEN  itemtransactiontype =1 THEN (oldpromotionamount - promotionamount) ELSE (oldpromotionamount - promotionamount) END from promotiondetail where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemID +" and itemtransactiontype="+itemtrantype+" and (promotiontypecode = 1 or promotiontypecode=0) and orderid < "+ count1 +" and orderid <> 0 order by orderid desc limit 1) Is NULL Then oldpromotionamount Else (select CASE WHEN  itemtransactiontype =1 THEN (oldpromotionamount - promotionamount) ELSE (oldpromotionamount - promotionamount) END from promotiondetail where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemID +" and itemtransactiontype="+itemtrantype+" and (promotiontypecode = 1 or promotiontypecode=0) and orderid < "+ count1 +" and orderid <> 0 order by orderid desc limit 1) End,issync=0 where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemID +" and itemtransactiontype="+itemtrantype+" and rowid = "+ rowid +"";
                    console.log(updatePromo);
                    
                    
                }
                else if(ptype == 2)
                {
                   
                    
                   /*
					 * updatePromo = "update promotiondetail set
					 * oldpromotionamount = "+ amount +" where routekey = "+
					 * sessionStorage.getItem('RouteKey') +" and visitkey = "+
					 * sessionStorage.getItem('VisitKey') +" and itemcode = "+
					 * itemID +" and rowid <> (select min(rowid) from
					 * promotiondetail where routekey = "+
					 * sessionStorage.getItem('RouteKey') +" and visitkey = "+
					 * sessionStorage.getItem('VisitKey') +" and itemcode = "+
					 * itemID +" and (promotiontypecode = 1 or promotiontypecode =
					 * 2))";
					 */ 
                    if(flagpromo == true && flagpromo2 == false || flagpromo2 == false &&  flagpromo == false)
                    { 
                        flagpromo2 = true;
                    /*
					 * updatePromo = "update promotiondetail set
					 * oldpromotionamount = case when (select case when
					 * promotiontypecode = 2 Then (oldpromotionamount -
					 * (oldpromotionamount * ("+ eval(dataInvoice[index][3])
					 * +")/100.0)) Else (oldpromotionamount - "+
					 * eval(dataInvoice[index][3]) +") End from promotiondetail
					 * where routekey = "+ sessionStorage.getItem('RouteKey') +"
					 * and visitkey = "+ sessionStorage.getItem('VisitKey') +"
					 * and itemcode = "+ itemID +" and (promotiontypecode = 1)
					 * and orderid < "+ count1 +" and orderid <> 0 order by
					 * orderid desc limit 1) Is NULL Then oldpromotionamount
					 * Else (select case when promotiontypecode = 2 Then
					 * (oldpromotionamount - (oldpromotionamount * ("+
					 * eval(dataInvoice[index][3]) +")/100.0)) Else
					 * (oldpromotionamount - "+ eval(dataInvoice[index][3]) +")
					 * End from promotiondetail where routekey = "+
					 * sessionStorage.getItem('RouteKey') +" and visitkey = "+
					 * sessionStorage.getItem('VisitKey') +" and itemcode = "+
					 * itemID +" and (promotiontypecode = 1) and orderid < "+
					 * count1 +" and orderid <> 0 order by orderid desc limit 1)
					 * End where routekey = "+
					 * sessionStorage.getItem('RouteKey') +" and visitkey = "+
					 * sessionStorage.getItem('VisitKey') +" and itemcode = "+
					 * itemID +" and rowid = "+ rowid +"";
					 */   
                        /*
						 * if(dataInvoice[index][11] == 1) {
						 * updatepromotionrepeat(dataInvoice,index,count1,1); }
						 * else {
						 */
                        updatePromo = "update promotiondetail set oldpromotionamount = case when (select CASE WHEN itemtransactiontype =1 THEN case when promotiontypecode = 2 Then (oldpromotionamount - (oldpromotionamount * (promotionamount)/100.0)) Else (oldpromotionamount - promotionamount) End ELSE case when promotiontypecode = 2 Then (oldpromotionamount - (oldpromotionamount * (promotionamount)/100.0)) Else (oldpromotionamount -promotionamount) End END from promotiondetail where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemID +" and itemtransactiontype="+itemtrantype+" and (promotiontypecode = 1 or promotiontypecode = 0) and orderid < "+ count1 +" and orderid <> 0 order by orderid desc limit 1) Is NULL Then oldpromotionamount Else (select CASE WHEN itemtransactiontype =1 THEN case when promotiontypecode = 2 Then (oldpromotionamount - (oldpromotionamount * (promotionamount)/100.0)) Else (oldpromotionamount - promotionamount) End ELSE case when promotiontypecode = 2 Then (oldpromotionamount - (oldpromotionamount * (promotionamount)/100.0)) Else (oldpromotionamount - promotionamount) End END from promotiondetail where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemID +" and itemtransactiontype="+itemtrantype+" and (promotiontypecode = 1 or promotiontypecode = 0) and orderid < "+ count1 +" and orderid <> 0 order by orderid desc limit 1)  End ,issync=0 where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemID +" and itemtransactiontype="+itemtrantype+" and rowid = "+ rowid +"";
                           
                            updatepromotionrepeat(dataInvoice,index,count1,1,updatePromo);
                        // }
                    }
                    else if(flagpromo2 == true)
                    {
                       flagpromo2 = true;
                       /*
						 * updatePromo = "update promotiondetail set
						 * oldpromotionamount = case when (select case when
						 * promotiontypecode = 2 Then (oldpromotionamount -
						 * (oldpromotionamount * ("+ eval(dataInvoice[index][3])
						 * +")/100.0)) Else (oldpromotionamount - "+
						 * eval(dataInvoice[index][3]) +") End from
						 * promotiondetail where routekey = "+
						 * sessionStorage.getItem('RouteKey') +" and visitkey = "+
						 * sessionStorage.getItem('VisitKey') +" and itemcode = "+
						 * itemID +" and (promotiontypecode = 2) and orderid < "+
						 * count1 +" and orderid <> 0 order by orderid desc
						 * limit 1) Is NULL Then oldpromotionamount Else (select
						 * case when promotiontypecode = 2 Then
						 * (oldpromotionamount - (oldpromotionamount * ("+
						 * eval(dataInvoice[index][3]) +")/100.0)) Else
						 * (oldpromotionamount - "+ eval(dataInvoice[index][3])
						 * +") End from promotiondetail where routekey = "+
						 * sessionStorage.getItem('RouteKey') +" and visitkey = "+
						 * sessionStorage.getItem('VisitKey') +" and itemcode = "+
						 * itemID +" and (promotiontypecode = 2) and orderid < "+
						 * count1 +" and orderid <> 0 order by orderid desc
						 * limit 1) End where routekey = "+
						 * sessionStorage.getItem('RouteKey') +" and visitkey = "+
						 * sessionStorage.getItem('VisitKey') +" and itemcode = "+
						 * itemID +" and rowid = "+ rowid +"";
						 */
                       /*
						 * if(dataInvoice[index][11] == 1) {
						 * updatepromotionrepeat(dataInvoice,index,count1,2); }
						 * else {
						 */
                        updatePromo = "update promotiondetail set oldpromotionamount = case when (select CASE WHEN itemtransactiontype =1 THEN case when promotiontypecode = 2 Then (oldpromotionamount - (oldpromotionamount * (promotionamount)/100.0)) Else (oldpromotionamount - promotionamount) End ELSE case when promotiontypecode = 2 Then (oldpromotionamount - (oldpromotionamount * (promotionamount)/100.0)) Else (oldpromotionamount - promotionamount) End END from promotiondetail where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemID +" and itemtransactiontype="+itemtrantype+" and (promotiontypecode = 1 or promotiontypecode = 2 or promotiontypecode = 0) and orderid < "+ count1 +" and orderid <> 0 order by orderid desc limit 1) Is NULL Then oldpromotionamount Else (select CASE WHEN itemtransactiontype =1 THEN case when promotiontypecode = 2 Then (oldpromotionamount - (oldpromotionamount * (promotionamount)/100.0)) Else (oldpromotionamount - promotionamount) End ELSE case when promotiontypecode = 2 Then (oldpromotionamount - (oldpromotionamount * (promotionamount)/100.0)) Else (oldpromotionamount - promotionamount) End END from promotiondetail where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemID +" and itemtransactiontype="+itemtrantype+" and (promotiontypecode = 1 or promotiontypecode = 2 or promotiontypecode = 0) and orderid < "+ count1 +" and orderid <> 0 order by orderid desc limit 1)  End,issync=0  where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemID +" and itemtransactiontype="+itemtrantype+" and rowid = "+ rowid +""; 
                            
                            updatepromotionrepeat(dataInvoice,index,count1,2,updatePromo);
                        // }
                    }
                    
                }
                    
                    else if(ptype == 6)
                    {
                        if(eval(itemtrantype) == 1)
                        {
                        updatePromo = "update promotiondetail set oldpromotionamount =oldpromotionamount - (select sum(promoamount) from invoicedetail where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode IN ("+ itemID +")),issync=0 where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = '"+ itemID +"' and itemtransactiontype="+itemtrantype+" and rowid = "+ rowid +""; 
                        }
                        else
                        {
                            updatePromo = "update promotiondetail set oldpromotionamount =oldpromotionamount - (select sum(returnpromoamount) from invoicedetail where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode IN ("+ itemID +")),issync=0 where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = '"+ itemID +"' and itemtransactiontype="+itemtrantype+" and rowid = "+ rowid +""; 
                        }
                        console.log(updatePromo);
                    }
                    
                
                
                               
                if(platform=='iPad')
           	 	{            
                    Cordova.exec(function(result) 
                                  {
                                  // navigator.notification.alert("Update
									// invoice detail successfully");
                                  // alert(promotiontype);
                                    UpdateOrder(rowid,count1,ptype);                  
                                  },
                                  function(error) {
                                  navigator.notification.alert("Error in updating record in invoice detail");
                                  },
                                  "PluginClass", 
                                  "InsertUpdateMethod", 
                                  [updatePromo]);
            	}
            	else if(platform=='Android')
            	{          
            		window.plugins.DataBaseHelper.insert(updatePromo,function(result)
                                                         {
                                                         // navigator.notification.alert("Update
															// invoice detail
															// successfully");
                                                            UpdateOrder(rowid,count1,ptype); 
                                                                                      
                                                         },
                                                         function()
                                                         {
                                                         console.warn("Error calling plugin");
                                                         });
				}           

            }
            function updatepromotionrepeat(dataInvoice,index,count1,flag,qry)
            {
                ptype = eval(dataInvoice[index][1]);
                rowid =  eval(dataInvoice[index][8]);
                itemID = dataInvoice[index][0];
                itemtrantype = dataInvoice[index][12];
                
                amount = (eval(dataInvoice[index][9]) - eval(dataInvoice[index][3]));
               if(flag ==1)
                {
                    var selectproqry ="select oldpromotionamount,promotionamount,repeatingrange,rangelow,itemtransactiontype from promotiondetail where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemID +" and itemtransactiontype="+itemtrantype+" and (promotiontypecode = 1 or promotiontypecode = 0) and orderid < "+ count1 +" and orderid <> 0 order by orderid desc limit 1";
                }
                else
                {
                    var selectproqry ="select oldpromotionamount,promotionamount,repeatingrange,rangelow,itemtransactiontype from promotiondetail where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemID +" and itemtransactiontype="+itemtrantype+" and (promotiontypecode = 1 or promotiontypecode = 2 or promotiontypecode = 0) and orderid < "+ count1 +" and orderid <> 0 order by orderid desc limit 1";
                }
                console.log(selectproqry);
                if(platform=='iPad')
                {
                    Cordova.exec(function(result) {
                                  if(eval(result[0][2]) == 1)
                                  {
                                  var oldamount = eval(result[0][0]).toFixed(decimalplace);
                                  var promoamount = eval(result[0][1]).toFixed(decimalplace);
                                  var finalamount = 0;
                                  if(eval(result[0][4]) == 1)
                                  var totalamount = eval(oldamount)-eval(promoamount);
                                  else
                                  var totalamount = eval(oldamount)-eval(promoamount);
                                  console.log("totalamount"+totalamount);
                                  while( totalamount >= eval(result[0][3]))
                                  {
                                  finalamount = finalamount + eval(result[0][3]).toFixed(decimalplace) * (promoamount/100);
                                  totalamount = totalamount - eval(result[0][3]).toFixed(decimalplace);
                                  }
                                  console.log("finalamount"+finalamount);
                                 if(flag ==1)
                                  {
                                  updatePromo = "update promotiondetail set oldpromotionamount = case when (select CASE WHEN itemtransactiontype =1 THEN case when promotiontypecode = 2 Then (oldpromotionamount - "+finalamount+") Else (oldpromotionamount - promotionamount) End ELSE case when promotiontypecode = 2 Then (oldpromotionamount + "+finalamount+") Else (oldpromotionamount + promotionamount) End END from promotiondetail where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemID +" and itemtransactiontype="+itemtrantype+" and (promotiontypecode = 1 or promotiontypecode = 0) and orderid < "+ count1 +" and orderid <> 0 order by orderid desc limit 1) Is NULL Then oldpromotionamount Else (select CASE WHEN itemtransactiontype =1 THEN case when promotiontypecode = 2 Then (oldpromotionamount - "+finalamount+") Else (oldpromotionamount - promotionamount) End ELSE case when promotiontypecode = 2 Then (oldpromotionamount + "+finalamount+") Else (oldpromotionamount + promotionamount) End END from promotiondetail where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemID +" and itemtransactiontype="+itemtrantype+" and (promotiontypecode = 1 or promotiontypecode = 0) and orderid < "+ count1 +" and orderid <> 0 order by orderid desc limit 1)  End ,issync=0 where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemID +" and itemtransactiontype="+itemtrantype+" and rowid = "+ rowid +"";
                                  
                                  }
                                  else
                                  {
                                    updatePromo = "update promotiondetail set oldpromotionamount = case when (select CASE WHEN itemtransactiontype =1 THEN case when promotiontypecode = 2 Then (oldpromotionamount - "+finalamount+") Else (oldpromotionamount - promotionamount) End ELSE case when promotiontypecode = 2 Then (oldpromotionamount + "+finalamount+") Else (oldpromotionamount + promotionamount) End END from promotiondetail where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemID +" and itemtransactiontype="+itemtrantype+" and (promotiontypecode = 1 or promotiontypecode = 2 or promotiontypecode = 0) and orderid < "+ count1 +" and orderid <> 0 order by orderid desc limit 1) Is NULL Then oldpromotionamount Else (select CASE WHEN itemtransactiontype =1 THEN case when promotiontypecode = 2 Then (oldpromotionamount - "+finalamount+") Else (oldpromotionamount - promotionamount) End ELSE case when promotiontypecode = 2 Then (oldpromotionamount + "+finalamount+") Else (oldpromotionamount + promotionamount) End END from promotiondetail where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemID +" and itemtransactiontype="+itemtrantype+" and (promotiontypecode = 1 or promotiontypecode = 2 or promotiontypecode = 0) and orderid < "+ count1 +" and orderid <> 0 order by orderid desc limit 1)  End,issync=0  where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemID +" and itemtransactiontype="+itemtrantype+" and rowid = "+ rowid +"";
                                  }
                                  }
                                  else{
                                  updatePromo = qry;
                                  }
                                  console.log(updatePromo);
                                  
                                  Cordova.exec(function(result) 
                                                {
                                                // navigator.notification.alert("Update
												// invoice detail
												// successfully");
                                                return true;
                                                },
                                                function(error) {
                                                navigator.notification.alert("Error in updating record in invoice detail");
                                                },
                                                "PluginClass", 
                                                "InsertUpdateMethod", 
                                                [updatePromo]);
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  },
                                  function(error) {
                                  alert(error);},
                                  "PluginClass", 
                                  "GetdataMethod", 
                                  [selectproqry]);
                }
                else if(platform=='Android')
                {
                    window.plugins.DataBaseHelper.select(selectproqry,function(result)
                                                         {
                                                         if(eval(result.array[0].repeatingrange) == 1)
                                  {
                                  var oldamount = eval(result.array[0].oldpromotionamount).toFixed(decimalplace);
                                  var promoamount = eval(result.array[0].promotionamount).toFixed(decimalplace);
                                  var finalamount = 0;
                                  if(eval(result.array[0].itemtransactiontype) == 1)
                                  var totalamount = eval(oldamount)-eval(promoamount);
                                  else
                                  var totalamount = eval(oldamount)-eval(promoamount);
                                  console.log("totalamount"+totalamount);
                                  while( totalamount >= eval(result.array[0].rangelow))
                                  {
                                  finalamount = finalamount + eval(result.array[0].rangelow) * (promoamount/100);
                                  totalamount = totalamount - eval(result.array[0].rangelow);
                                  }
                                  console.log("finalamount"+finalamount);
                                 if(flag ==1)
                                  {
                                  updatePromo = "update promotiondetail set oldpromotionamount = case when (select CASE WHEN itemtransactiontype =1 THEN case when promotiontypecode = 2 Then (oldpromotionamount - "+finalamount+") Else (oldpromotionamount - promotionamount) End ELSE case when promotiontypecode = 2 Then (oldpromotionamount + "+finalamount+") Else (oldpromotionamount + promotionamount) End END from promotiondetail where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemID +" and itemtransactiontype="+itemtrantype+" and (promotiontypecode = 1 or promotiontypecode = 0) and orderid < "+ count1 +" and orderid <> 0 order by orderid desc limit 1) Is NULL Then oldpromotionamount Else (select CASE WHEN itemtransactiontype =1 THEN case when promotiontypecode = 2 Then (oldpromotionamount - "+finalamount+") Else (oldpromotionamount - promotionamount) End ELSE case when promotiontypecode = 2 Then (oldpromotionamount + "+finalamount+") Else (oldpromotionamount + promotionamount) End END from promotiondetail where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemID +" and itemtransactiontype="+itemtrantype+" and (promotiontypecode = 1 or promotiontypecode = 0) and orderid < "+ count1 +" and orderid <> 0 order by orderid desc limit 1)  End ,issync=0 where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemID +" and itemtransactiontype="+itemtrantype+" and rowid = "+ rowid +"";
                                  
                                  }
                                  else
                                  {
                                    updatePromo = "update promotiondetail set oldpromotionamount = case when (select CASE WHEN itemtransactiontype =1 THEN case when promotiontypecode = 2 Then (oldpromotionamount - "+finalamount+") Else (oldpromotionamount - promotionamount) End ELSE case when promotiontypecode = 2 Then (oldpromotionamount + "+finalamount+") Else (oldpromotionamount + promotionamount) End END from promotiondetail where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemID +" and itemtransactiontype="+itemtrantype+" and (promotiontypecode = 1 or promotiontypecode = 2 or promotiontypecode = 0) and orderid < "+ count1 +" and orderid <> 0 order by orderid desc limit 1) Is NULL Then oldpromotionamount Else (select CASE WHEN itemtransactiontype =1 THEN case when promotiontypecode = 2 Then (oldpromotionamount - "+finalamount+") Else (oldpromotionamount - promotionamount) End ELSE case when promotiontypecode = 2 Then (oldpromotionamount + "+finalamount+") Else (oldpromotionamount + promotionamount) End END from promotiondetail where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemID +" and itemtransactiontype="+itemtrantype+" and (promotiontypecode = 1 or promotiontypecode = 2 or promotiontypecode = 0) and orderid < "+ count1 +" and orderid <> 0 order by orderid desc limit 1)  End,issync=0  where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and itemcode = "+ itemID +" and itemtransactiontype="+itemtrantype+" and rowid = "+ rowid +"";
                                  }
                                  }
                                  else{
                                  updatePromo = qry;
                                  }
                                  console.log(updatePromo);
                                                         window.plugins.DataBaseHelper.insert(updatePromo,function(result)
                                                                                              {
                                                                                              // navigator.notification.alert("Update
																								// invoice
																								// detail
																								// successfully");
                                                                                              return true;
                                                                                              },
                                                                                              function()
                                                                                              {
                                                                                              console.warn("Error calling plugin");
                                                                                              });
                                                         },
                                                         function()
                                                         {
                                                         console.warn("Error calling plugin");
                                                         });
                }
                
              
                
            }
            function UpdateOrder(rowid,count,ptype)
            {
                var updateorder = '';
                
                if(ptype == 1 || ptype == 2 || ptype==0) 
                {
                updateorder = "update promotiondetail set orderid = "+ count +" where rowid = "+ rowid +"";                
                
                if(platform=='iPad')
           	 	{            
                    Cordova.exec(function(result) 
                                  {
                                  // navigator.notification.alert("Update
									// invoice detail successfully");
                                  // alert(promotiontype);
                                  },
                                  function(error) {
                                  navigator.notification.alert("Error in updating record in invoice detail");
                                  },
                                  "PluginClass", 
                                  "InsertUpdateMethod", 
                                  [updateorder]);
            	}
            	else if(platform=='Android')
            	{          
            		window.plugins.DataBaseHelper.insert(updateorder,function(result)
                                                         {
                                                         // navigator.notification.alert("Update
															// invoice detail
															// successfully");
                                                         
                                                         },
                                                         function()
                                                         {
                                                         console.warn("Error calling plugin");
                                                         });
				}   
                }
            }
            
            function UpdatePromoDetailOrder()
            {
                var updatedetailorder = '';
                
                if(eval(data[index - 1][3]) == 1 || eval(data[index - 1][3]) == 2 || eval(data[index - 1][3]) == 0)
                {
                updatedetailorder = "update promotiondetail set oldpromotionamount = salesamount,orderid = 0 where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +"";
                
                if(platform=='iPad')
           	 	{            
                    Cordova.exec(function(result) 
                                  {
                                  // navigator.notification.alert("Update
									// invoice detail successfully");
                                  // alert(promotiontype);
                                  },
                                  function(error) {
                                  navigator.notification.alert("Error in updating record in invoice detail");
                                  },
                                  "PluginClass", 
                                  "InsertUpdateMethod", 
                                  [updatedetailorder]);
            	}
            	else if(platform=='Android')
            	{          
            		window.plugins.DataBaseHelper.insert(updatedetailorder,function(result)
                                                         {
                                                         // navigator.notification.alert("Update
															// invoice detail
															// successfully");
                                                         
                                                         },
                                                         function()
                                                         {
                                                         console.warn("Error calling plugin");
                                                         });
				}           
                }        
            }
            function enforcepromotionoverride()
            {
                localStorage.promooveride=1;               
                
                $('#btnSubmit1').simpledialog('close');
            }
            function getPassword()
            {   
                
                if(platform=='iPad')
                {
                    Cordova.exec(function(result) {   
                                  
                                  
                                  
                                  if (result.length > 0) {
                                  var i = result[0][0]; 
                                  if(result[0][0] == 0)
                                  $("#promodiv").css({'display':'none'});
                                 
                                  localStorage.PromotionPassword = ((result[0][0] == 0) ? 0 : result[0][i]);
                                  localStorage.LoadPassword2 = result[0][5];
                                  
                                  }
                                  else {
                                  localStorage.PromotionPassword = "";
                                  localStorage.adminpass = "";
                                  }
                                  
                                  },
                                  function(error) {
                                  alert("Error in getting Password : " + error);
                                  },
                                  "PluginClass", 
                                  "GetdataMethod", 
                                  ["select passwordarray03,password1,password2,password3,password4,password5 From routemaster where routecode = "+ sessionStorage.getItem('RouteCode') +""]);   
                    
                }
                else if(platform=='Android')
                {
                    window.plugins.DataBaseHelper.select("select passwordarray03,password1,password2,password3,password4,password5 From routemaster where routecode = "+ sessionStorage.getItem('RouteCode') +"",function(result)
                                                         {
                                                         
                                                         result = $.map(result.array, function (item, index) {
                                                                        
                                                                        return [[item.passwordarray03, item.password1,item.password2,item.password3,item.password4,item.password5]];
                                                                        });
                                                         if (result.length > 0) {
                                                         var i = result[0][0]; 
                                                         if(result[0][0] == 0)
                                                         $("#promodiv").css({'display':'none'});
                                                         
                                                         localStorage.PromotionPassword = ((result[0][0] == 0) ? 0 : result[0][i]);
                                                         localStorage.LoadPassword2 = result[0][5];
                                                         
                                                         }
                                                         else {
                                                         localStorage.PromotionPassword = "";
                                                         localStorage.adminpass = "";
                                                         }
                                                         
                                                         },
                                                         function()
                                                         {
                                                         console.warn("Error calling plugin");
                                                         });
                } 
                
            }
        </script>

    </div>
</body>
</html>
