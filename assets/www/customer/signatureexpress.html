<!--
 '  Created By   : Pratik Raval
 '  Created Date : 17/02/2012
 '  Description  : This page is used for Signature.
-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Signature</title>
  <meta name="viewport"
	content="width=device-width, initial-scale=1.0;maximum-scale=1.0;user-scalable=0; target-densitydpi=device-dpi"/>

    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="../css/en.css" lang="en" />
    <link rel="stylesheet" href="../css/jquery.mobile-1.0.min.css" />
    <link rel="stylesheet" media="only screen and (min-width: 320px) and (max-width: 600px)"
        href="../css/style_600.css"/>
    <!--Black P-->
    <link rel="stylesheet" media="only screen and (min-width: 600px) and (max-width: 700px)"
        href="../css/style_700.css"/>
    <!--Iphone 4 P-->
    <link rel="stylesheet" media="only screen and (min-width: 700px) and (max-width: 800px)"
        href="../css/style_800.css"/>
    <!--Ipad P-->
    <!--Black L-->
    <link rel="stylesheet" media="only screen and (min-width: 1000px) and (max-width: 1200px)"
        href="../css/style_1200.css"/>
    
    <link rel="stylesheet" media="only screen and (min-width: 1200px) and (max-width: 1500px)" href="../css/style_1400.css"/>
    
    <link rel="stylesheet" href="../css/boostrap/css/bStyle.css"/>
        <link rel="stylesheet" href="../css/boostrap/css/bootstrap.min.css"/>
        <link rel="stylesheet" href="../css/boostrap/css/bootstrap-grid.css"/>
        <link rel="stylesheet" href="../css/boostrap/css/bootstrap-grid.min.css"/>
        <link rel="stylesheet" href="../css/boostrap/css/bootstrap.css"/>
    

    <script type="text/javascript" src="../js/jquery.js"></script>

    <script type="text/javascript" src="../js/jquery.mobile-1.0.js"></script>

    <script type="text/javascript" src="../js/common.js"></script>
        <script>
if (navigator.userAgent.toLowerCase().match(/android/)) {
document.write('<script charset="utf-8" src="../cordova-2.0.0.js"><\/script>');
document.write('<script charset="utf-8" src="../directoryListing.js"><\/script>');
} else if (navigator.userAgent.toLowerCase().match(/iphone/) || navigator.userAgent.toLowerCase().match(/ipad/)) {
document.write('<script charset="utf-8" src="../cordova-1.5.0.js"><\/script>');
}
</script>
        <script type="text/javascript" src="../js/jquery.json-2.3.min.js"></script> 

  

    <!-- Signature CSS and Java Script File  -->
    <link rel="stylesheet" href="../css/jquery.signaturepad.css"/>

    <script src="../js/jquery.signaturepad.min.js" type="text/javascript"></script>
      <script src="../LangJS/jquery-lang.js" charset="utf-8" type="text/javascript"></script>

    <script src="../LangJS/langpack/AR.js" charset="utf-8" type="text/javascript" lang="en"></script>

    <!--End Signature CSS and Java Script File  -->
</head>
<body>
    <div data-role="page" data-theme="d" data-title="Order Request" id="myPage">
        <div>
            <img title="" alt="" src="../images/bg.png" id="background">
        </div>
        <div data-role="header" data-position="inline" id="bgclheader">
            <a href="#" id="Back_inner" rel="external" lang="en" >Back</a>
            <div class="wrapper"><div class="card_content"><div><img title="" alt="" data-pushbar-target="left"  src="../images/icons8-menu-50.png" id="setting"></div></div></div> 
            <h1 lang="en">
                Signature</h1>
            <a href="#" id="lang_inner">EN</a>
        </div>
        <div data-role="content" class="centerboxInvReq">
        	<div class="com_div comm captionLabel">
                <div>
                    <!--<canvas style="border: 1px solid black; background-color: white" id="thecanvas"></canvas>-->
                    <div class="sigPad" style="text-align:center">
                        <canvas class="pad" width="1000" height="700" id="thecanvas"></canvas>
                        <input type="hidden" name="output" class="output" id="hidsignature"/>
                    </div>
                    <!-- <div style="height: 30px;">
                    </div> -->
                    <div>
                        <table cellpadding="5" cellspacing="2" border="0" width="100%">
                            <tr>
                                <td class="captionLabel" lang="en">
                                    Customer#
                                </td>
                                <td class="captionLabel" lang="en">
                                    Customer Name
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <input id="txtCustomerNumber" type="text" class="textFont" style="width: 80%" disabled="disabled"/>
                                </td>
                                <td>
                                    <input id="txtCustomerName" type="text" class="textFont" disabled="disabled" style="width: 80%" />
                                </td>
                            </tr>
                            <tr>
                                <td class="captionLabel" lang="en" id="lblOrdNumber">
                                    Order Number
                                </td>
                                <td class="captionLabel" id="lblAmount" lang="en">
                                    Amount Due
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <input id="txtInvoiceNumber" type="text" size="20" class="textFont" style="width: 80%" disabled="disabled"/>
                                </td>
                                <td>
                                    <input id="txtAmountDue" type="text" size="11" class="textFont" disabled="disabled"
                                        style="width: 80%;text-align:right" />
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            <div class="leftbottomMenu com_info_right">
                <div class="row">
                    
                    <div class="col-3" style="margin:10px !important">
                        <div class="card bg-success text-center">
                            <a href="javascript:Clear();" class="clearButton" style="text-decoration: none" rel="external">
                                <img class="bottomicon" src="../images/clear.png" alt="sync" /><h4 class="text-white">CLEAR</h4>
                            </a>
                        </div>
                        
                    </div>
                    <div class="col-3" style="margin:10px !important">
                        <div class="card bg-danger text-center">
                            <a id="lnkAccept" href="#" rel="external" style="text-decoration: none" data-role="none" >
                            <img class="bottomicon" src="../images/accept.png" id="imgexit" alt="Exit" /><h4 class="text-white">ACCEPT</h4>
                            </a>
                        </div>
                        
                    </div>
                    <div class="col-3" style="margin:10px !important">
                        <div class="card bg-danger text-center">
                            <a id="lnkExit" href="#" rel="external" id="A2" style="text-decoration: none" data-role="none">
                            <img class="bottomicon" src="../images/icn-exit.png" id="imgexit" alt="Exit" /><h4 class="text-white">CANCEL</h4>
                            </a>
                        </div>                        
                    </div>
                </div>
            </div>
        </div>
        <div id="f1" data-role="footer" class="ui-bar">
            <div class="footer">
                <div class="leftfooter">
                    09 November 2011</div>
                <div class="rightfooter">
                    Mirnah Technology Systems</div>
            </div>
        </div>
        <div id="f2" data-role="footer" style="bottom: 0; position: absolute;">
        
		 <aside data-pushbar-id="left" class="pushbar from_left">
		<div class="title"><span data-pushbar-close class="close push_right"></span>
			<span id="txtroute"></span>
		</div>

		<ul class="menu">
		<li style="margin-bottom: 0 !important;" > 
		<img title="" alt="" src="../images/startday-icon.png" id="day"  class="leftmenu" >
		 <a href="#"
						class="ui-btn-active" rel="external" id="day" data-icon="custom"  
						lang="en" onclick="footerredict('../startofday/startofday.html')">Start day</a></li>
					<li style="margin-bottom: 0 !important;">
					 <img title="" alt="" src="../images/Inventoryicon.png" id="inve"  class="leftmenu">
					 <a href="#" id="inve"
						rel="external" data-icon="custom" lang="en"
						onclick="footerredict('../inventory/inventory.html')">Inventory</a></li>
					<li style="margin-bottom: 0 !important;">
					 <img title="" alt="" src="../images/customer-icon.png" id="cust" class="leftmenu">
					 <a href="#"
						rel="external" id="cust" data-icon="custom" lang="en"
						onclick="footerredict('../customer/customer_operation.html')">Customer</a></li>
					<li style="margin-bottom: 0 !important;">
					<img title="" alt="" src="../images/Money-icon.png" id="sett" class="leftmenu">
					<a href="#"
						rel="external" id="sett" data-icon="custom" lang="en"
						onclick="footerredict('../settlement/managesettlement.html')">Settlement</a></li>
					<li style="margin-bottom: 0 !important;">
					<img title="" alt="" src="../images/expense-icon.png" id="expe" class="leftmenu">
					<a href="#"
						rel="external" id="expe" data-icon="custom" lang="en"
						onclick="footerredict('../settlement/expenseentry.html')">Expenses</a></li>
					<li style="margin-bottom: 0 !important;">
					<img title="" alt="" src="../images/information-icon.png" id="info" class="leftmenu" >
					<a href="#"
						rel="external" id="info" data-icon="custom" lang="en"  
						onclick="footerredict('../information/information.html')">Information</a></li>
					<li style="margin-bottom: 0 !important; ">
					 <img title="" alt="" src="../images/user-settings-icon.png" id="setup" class="leftmenu">
					 <a href="#" rel="external" id="setup" data-icon="custom" lang="en"
						onclick="footerredict('../utilities/utilities.html')">Utilities</a></li>
		</ul>

	</aside>
        
             <div data-role="navbar" data-iconpos="top" data-grid="f">
                <ul>
                    <li style="margin-bottom:0 !important;"><a href="#" rel="external" id="day" data-icon="custom" lang="en" onclick="footerredict('../startofday/startofday.html')">Start day</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" id="inve" rel="external" data-icon="custom" lang="en" onclick="footerredict('../inventory/inventory.html')">Inventory</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" class="ui-btn-active" rel="external" id="cust" data-icon="custom" lang="en">Customer</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" rel="external" id="sett" data-icon="custom" lang="en" onclick="footerredict('../settlement/managesettlement.html')">Settlement</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" rel="external" id="expe" data-icon="custom" lang="en" onclick="footerredict('../settlement/expenseentry.html')">Expenses</a></li>
			        <li style="margin-bottom:0 !important;"><a href="#" rel="external" id="info" data-icon="custom" lang="en" onclick="footerredict('../information/information.html')">Information</a></li>
			        <li style="margin-bottom:0 !important; width:14.0%"><a href="#" rel="external" id="setup" data-icon="custom" lang="en" onclick="footerredict('../utilities/utilities.html')">Utilities</a></li>
                </ul>
            </div>
        </div>


        <script type="text/javascript">
        	var platform='';
            platform= sessionStorage.getItem("platform");
            //platform == "iPad";
            window.lang = new jquery_lang_js();
            var presignature = "";
 			resizeOrientationWindow();
	  		$(document).ready(function() {
	 		resizeWindow();
	 		
	 		if(window.devicePixelRatio <=1.5) { 
     			
     			var canvas = document.getElementById("thecanvas");
         		canvas.width = 500;
         		canvas.height = 300; 
         		Clear();
           	 } 
                $(".leftfooter").html(getCurrentDate());
                $('.sigPad').signaturePad({ drawOnly: true });
                 localStorage.setItem("roundredirect",'signature');
					document.addEventListener("deviceready", GetCashSetting, false);
					// sujee added side bar ----------------- START ------------------------ 

        	          var pushbar = new Pushbar({
    		blur:true,
    		overlay:true,
    	});
        $("#txtroute").text("ROUTE #: " + sessionStorage.getItem("RouteCode")); 
        window.setInterval(function(){
     		var randomColor = '#'+ ('000000' + Math.floor(Math.random()*16777215).toString(16)).slice(-6);
     		$('#txtroute').css({
       			'color' : randomColor,
     		});
   			}, 2000);
        //----------------------------- END -------------------------  
                                              /*else if(localStorage.sign == 'promo')
                              {
                              var back = '../customer/promotion_review.html';
                              var exitlink = '../customer/promotion_review.html';
                              }
                              else if(localStorage.sign == 'promo_list')
                              {
                              
                              var back = '../customer/customer_promotion_list.html';    
                              var exitlink = '../customer/customer_promotion_list.html';
                              }
                              else if(localStorage.sign == 'order_promo_list')
                              {
                              
                              var back = '../customer_opt/order_promotion_list.html';    
                              var exitlink = '../customer_opt/order_promotion_list.html';
                              }*/


                
                //$("#lnkExit").attr("href", exitlink);
              	
                var lan = sessionStorage.getItem("Language");
                window.lang.run(lan);

                if (sessionStorage.getItem("Language") != "en") {

                    window.lang.change('Signature' + lan, lan);
                    window.lang.change('Footer' + lan, lan);
                    if (lan == "AR") {
                        $(".centerboxInvReq").attr("dir", "rtl");
                        $('#Back_inner').removeClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                        $('#Back_inner').addClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                        $('#lang_inner').removeClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                        $('#lang_inner').addClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                    }

                }
                else {
                    window.lang.change('en', 'en');
                    $(".centerboxInvReq").attr("dir", "ltr");
                    $('#Back_inner').removeClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                    $('#Back_inner').addClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                    $('#lang_inner').removeClass('ui-btn-left ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                    $('#lang_inner').addClass('ui-btn-right ui-btn ui-btn-corner-all ui-shadow ui-btn-up-a');
                }
            });            

            function GetCashSetting() {
            	//alert(localStorage.signature);
             	//$.mobile.showPageLoadingMsg();        	
                platform = sessionStorage.getItem("platform");
                var acceptlink,exitlink;
                $("#lnkAccept").attr("onclick","");
                if (localStorage.signature == 'sales') {                    
                    if (eval(sessionStorage.getItem("invoicepaymentterms")) != 2)
                        acceptlink = '../customer_opt/cashcollection_mopexpress.html';
                                                      
                    exitlink = '../customer_opt/salesinvoice_optionexpress.html';
                    getRoundingline();
                }   
                else if (localStorage.signature == 'orderrequest') {
                    acceptlink = '../customer_opt/orderdetail.html';  
                    var back = '../customer_opt/orderRequest.html';
                    var exitlink = '../customer_opt/orderRequest.html';
                    getSignature();
                }
                else{
                	if (eval(sessionStorage.getItem("invoicepaymentterms")) != 2)
                        acceptlink = '../customer_opt/cashcollection_mopexpress.html';
                                                      
                    exitlink = '../customer_opt/salesinvoice_optionexpress.html';
                    getRoundingline();
                }
                $("#lnkAccept").attr("href", "#");
                $("#lnkExit").attr("href", exitlink);
                $("#Back_inner").attr("href", exitlink);
                $("#txtCustomerNumber").val(sessionStorage.getItem("customercode"));
                $("#txtCustomerName").val(sessionStorage.getItem("customername"));  
                
                
                //getRoundinginvoice();
                //getSignature();
            }
           
          	
            function getSignature()
            {
            	//alert("getSignature");
            	$.mobile.hidePageLoadingMsg(); 
            	$("#lnkAccept").attr("onclick","CheckSignatueCount()");
                var Qry = "SELECT signaturedata FROM sigcapturedata WHERE routekey=" + sessionStorage.getItem("RouteKey") + " AND visitkey=" + sessionStorage.getItem("VisitKey");
                if(platform == "iPad")
                {                    
                    Cordova.exec(function(result) {
                       if(result.length > 0)
                       {
                            if(result[0][0] != "")
                            {
                                $(".sigPad").signaturePad().regenerate(result[0][0]);
                                presignature = result[0][0];
                            }
                       }
                       getAmountDue();
                    },
                    function(error) {
                        alert("Error in binding Bank Name : " + error);
                    },
                    "PluginClass",
                    "GetdataMethod",
                    [Qry]);
                }
                else if(platform == "Android")
                {
                    window.plugins.DataBaseHelper.select(Qry, function(result) {
                    	if(result.array != undefined)
                    	{                    	
                    		result = $.map(result.array, function (item, index) {                
                       		 	return [[item.signaturedata]];
                    		});                    	
                    		if(result.length > 0)
                       		{
	                            if(result[0][0] != "")
                            	{
	                                //$(".sigPad").signaturePad().regenerate(result[0][0]);
                                	//presignature = result[0][0];
                            	}
                       		}
                       	}
                       	getSaleAmount();
                       
                    },
                    function() {
                        console.warn("Error calling plugin");
                    });
                }
            }
            function getSaleAmount(){
            
            	//alert("getSaleAmount");
            		var Qry = "select sum(diffround) as diffrence from invoicedetail where visitkey="+ sessionStorage.getItem("VisitKey")+" and routekey="+sessionStorage.getItem("RouteKey");
					
					console.log(Qry);
					if (platform == "iPad") {
						Cordova.exec(function(result) {
							
					
						}, function(error) {
							alert("Error in binding Bank Name : " + error);
						}, "PluginClass", "GetdataMethod", [ Qry ]);
					} else if (platform == "Android") {
						window.plugins.DataBaseHelper.select(Qry, function(result) {
							if (result.array != undefined) {
								result = $.map(result.array, function(item, index) {
									return [ [ item.diffrence] ];
								});
								if (result.length > 0) {
									
									if(eval(result[0][0])!=0){
									
										 $('#lblAmount').text("Amount due(After Rounding)");
									
									}
								}
								getAmountDue();
							}
					
						}, function() {
							console.warn("Error calling plugin");
						});
					}
            	
            }
            function getAmountDue()
            {                
            	//alert("getAmountDue");
            	var decimalplace = sessionStorage.getItem("decimalplace");
                var routekey=sessionStorage.getItem("RouteKey");
                var visitkey=sessionStorage.getItem("VisitKey");
                var customerid=sessionStorage.getItem("customerid");                
                var Qry;
                if(localStorage.getItem("signature") == "sales")
                {
                    
                   
                    $('#lblOrdNumber').html(getLangTextdata("Invoice Number"));
                    
                    // sujee commented org qry 08/08/2018
             //      Qry = "select CAST(CASE WHEN (ifnull(totalsalesamount,0)-ifnull(totalreturnamount,0)-ifnull(totaldamagedamount,0)) >0 THEN (CASE WHEN ifnull(totalmanualfree,0)>0 THEN ROUND((ifnull(totalsalesamount,0)-ifnull(totalreturnamount,0)-ifnull(totalpromoamount,0)-ifnull(totaldamagedamount,0)-ifnull(totaldiscountamount,0)+ifnull(itemlinetaxamount,0)+ifnull(totaltaxesamount,0)),"+decimalplace+")ELSE  ROUND((ifnull(totalsalesamount,0)-ifnull(totalreturnamount,0)-ifnull(totalpromoamount,0)-ifnull(totaldamagedamount,0)-ifnull(totaldiscountamount,0)+ifnull(itemlinetaxamount,0)+ifnull(totaltaxesamount,0)),"+decimalplace+") END) ELSE (CASE WHEN ifnull(totalmanualfree,0)>0 THEN ROUND((ifnull(totalsalesamount,0)-ifnull(totalreturnamount,0)-ifnull(totalpromoamount,0)-ifnull(totaldamagedamount,0)-ifnull(totaldiscountamount,0)+ifnull(itemlinetaxamount,0)+ifnull(totaltaxesamount,0)),"+decimalplace+")ELSE  ROUND((ifnull(totalsalesamount,0)-ifnull(totalreturnamount,0)-ifnull(totalpromoamount,0)-ifnull(totaldamagedamount,0)-ifnull(totaldiscountamount,0)+ifnull(itemlinetaxamount,0)+ifnull(totaltaxesamount,0)),"+decimalplace+") END) END AS VARCHAR) as amount from invoiceheader where routekey="+routekey+" and visitkey="+visitkey+" and customercode="+customerid+" and istemp='true' group by routekey,visitkey";
                    
                    Qry= "select CAST(CASE WHEN (ifnull(totalsalesamount,0)-ifnull(totalreturnamount,0)-ifnull(totaldamagedamount,0) - ifnull(totalexpiryamount,0)) >0 THEN (CASE WHEN ifnull(totalmanualfree,0)>0 THEN ROUND((ifnull(totalsalesamount,0)-ifnull(totalreturnamount,0)-ifnull(totalpromoamount,0)-ifnull(totaldamagedamount,0)-ifnull(totaldiscountamount,0) - ifnull(totalexpiryamount,0) +ifnull(itemlinetaxamount,0)+ifnull(totaltaxesamount,0)),"+decimalplace+")ELSE  ROUND((ifnull(totalsalesamount,0)-ifnull(totalreturnamount,0)-ifnull(totalpromoamount,0)-ifnull(totaldamagedamount,0)-ifnull(totaldiscountamount,0)- ifnull(totalexpiryamount,0) +ifnull(itemlinetaxamount,0)+ifnull(totaltaxesamount,0)),"+decimalplace+") END) ELSE (CASE WHEN ifnull(totalmanualfree,0)>0 THEN ROUND((ifnull(totalsalesamount,0)-ifnull(totalreturnamount,0)-ifnull(totalpromoamount,0)-ifnull(totaldamagedamount,0)-ifnull(totaldiscountamount,0)- ifnull(totalexpiryamount,0) +ifnull(itemlinetaxamount,0)+ifnull(totaltaxesamount,0)),"+decimalplace+")ELSE  ROUND((ifnull(totalsalesamount,0)-ifnull(totalreturnamount,0)-ifnull(totalpromoamount,0)-ifnull(totaldamagedamount,0)-ifnull(totaldiscountamount,0) - ifnull(totalexpiryamount,0) +ifnull(itemlinetaxamount,0)+ifnull(totaltaxesamount,0)),"+decimalplace+") END) END AS VARCHAR) as amount from invoiceheader where routekey="+routekey+" and visitkey="+visitkey+" and customercode="+customerid+" and istemp='true' group by routekey,visitkey";
                   /* Qry="select totalsalesamount,totalreturnamount,totaldamagedamount,totalmanualfree,itemlinetaxamount,totaltaxesamount,totalpromoamount,totaldiscountamount, "
                    +" (select GROUP_CONCAT(cast(ppad.promotionamount as INT) )  from promokeyheader pkh inner join promokeydetail pkd on pkh.promotionkey=pkd.promotionkey "
                    +"    inner join promoplandetail ppd on ppd.plannumber=pkd.plannumber "
                    +"    inner join promotionassignmentadvanced ppad on ppad.assignmentnumber=ppd.assignmentnumber  "    
                    +"    inner join customermaster cm on cm.promotionkey=pkh.promotionkey where cm.customercode="+customerid+")as rebate from invoiceheader where routekey="+routekey+" and visitkey="+visitkey+" and customercode="+customerid+" and istemp='true'  " ;*/
                 // Qry = "select CAST(ifnull(totalinvoiceamount,0) AS VARCHAR) as amount from invoiceheader where routekey="+routekey+" and visitkey="+visitkey+" and customercode="+customerid+" and istemp='true' group by routekey,visitkey";
                }
                else if(localStorage.getItem("signature") == "orderrequest")
                {
                    $('#lblOrdNumber').html(getLangTextdata("Order Number"));
                    Qry = "select CAST(ROUND((ifnull(totalsalesamount,0)-ifnull(totalreturnamount,0)-ifnull(totalpromoamount,0)-ifnull(totaldamagedamount,0)+ifnull(totallineitemtax,0)),"+decimalplace+") AS VARCHAR) as amount"
                    +" from salesorderheader where routekey="+routekey+" and visitkey="+visitkey+" and customercode="+customerid
                    +" and case when "+sessionStorage.getItem("onHoldOrderInvoice")+" >1 then 0=0 else  istemp='true' end "
                    +"group by routekey,visitkey";
                    
                }
                console.log(Qry);
               // alert(Qry);
                if(platform=='iPad')
		    	{
                    var abc = Cordova.exec(function(result) {
                                            $('#txtAmountDue').val(parseFloat(result[0][0]).toFixed(decimalplace));
                                            if(localStorage.getItem("signature") == "sales")
                                                $('#txtInvoiceNumber').val(sessionStorage.getItem("InvoiceNumber"));
                                            else if(localStorage.getItem("signature") == "orderrequest")
                                                $('#txtInvoiceNumber').val(sessionStorage.getItem("OrderNumber"));                                                   
                                            sessionStorage.setItem("amountdue",result[0][0]);                                        
                                            },
                                            function(error) {
                                            navigator.notification.alert(error);},
                                            "PluginClass", 
                                            "GetdataMethod", 
                                            [Qry]);
            	}
                else if(platform=='Android')
           		{
           		    window.plugins.DataBaseHelper.select(Qry, function(result)
                                                         {
                                                            // org line sujee comented 08/08/2018
                                                        result = $.map(result.array, function (item, index) {
                                                                        return [[item.amount]];
                                                                        });
                                                                        
                                                      /*  result = $.map(result.array, function (item, index) {
                                                             return [[item.totalsalesamount,item.totalreturnamount,item.totaldamagedamount,item.totalmanualfree,item.itemlinetaxamount,item.totaltaxesamount,item.totalpromoamount,item.totaldiscountamount,item.rebate]];
                                                             });
                                                        var netsale = parseFloat(result[0][0]).toFixed(decimalplace);
                                                        var retsale = parseFloat(result[0][1]).toFixed(decimalplace);
                                                        var damsale= parseFloat(result[0][2]).toFixed(decimalplace);
                                                        var lineitemtax= parseFloat(result[0][4]).toFixed(decimalplace);
                                                        var tottax = parseFloat(result[0][5]).toFixed(decimalplace);
                                                        var promoval = parseFloat(result[0][6]).toFixed(decimalplace);
                                                        var disval = parseFloat(result[0][7]).toFixed(decimalplace);
                                                        var rebate= result[0][8];
                                                        alert('netsale' +netsale);
                                                        alert('retsale' +retsale);
                                                        alert('damsale' +damsale);
                                                        alert('lineitemtax' +lineitemtax);
                                                        alert('tottax' +tottax);
                                                        alert('promoval' +promoval);
                                                        alert('disval' +disval);
                                                        alert('rebate' +rebate);
                                                        
                                                        var totamt= eval(netsale - retsale- damsale - promoval).toFixed(decimalplace);
                                                        alert('totamt' +totamt);
                                                        var taxper = rebate;
                                                        alert('taxper' +taxper);
                                        				var tottaxamt= eval((totamt * taxper)/100).toFixed(decimalplace);
                                        				 alert('tottaxamt' +tottaxamt);
                                 
                                        				 var finalamt= parseFloat(totamt) + parseFloat(lineitemtax);
                                        				 alert('finalamt' +finalamt);
                                        				 
                                        			*/
                                                        
                                                         $('#txtAmountDue').val(parseFloat(result[0][0]).toFixed(decimalplace));
                                            			 if(localStorage.getItem("signature") == "sales")
                                                			$('#txtInvoiceNumber').val(sessionStorage.getItem("InvoiceNumber"));
                                            			 else if(localStorage.getItem("signature") == "orderrequest")
                                                			$('#txtInvoiceNumber').val(sessionStorage.getItem("OrderNumber"));                                                   
                                            			 sessionStorage.setItem("amountdue",result[0][0]);
                                                         },
                                                         function()
                                                         {
                                                         console.warn("Error calling plugin");
                                                         });
           		} 
            }
            
            function CheckSignatueCount()
            {
            	//alert("CheckSignatueCount");
            	platform= sessionStorage.getItem("platform");  
               // alert($('#lnkAccept').attr('href'));
                console.log("select count(customercode) from sigcapturedata where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and customercode = "+ sessionStorage.getItem('customerid') +"");
                if(platform=='iPad')
           		{
                Cordova.exec(function(result) {                                
                                    if(result.length > 0)
                                    {
                              
                                        if(result[0][0] == 0)
                                        {
                                            InsertImage();
                                        }
                                        else
                                        {
                                            UpdateImage();
                                        }
                                    }                                   
                              },
                              function(error) {
                                navigator.notification.alert("Error in check signature count : " + error);
                              },
                              "PluginClass", 
                              "GetdataMethod", 
                              ["select count(customercode) from sigcapturedata where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and customercode = "+ sessionStorage.getItem('customerid') +""]);      
            	}
             else if(platform=='Android')
            		{
             		
		             window.plugins.DataBaseHelper.select("select count(customercode) As custcode from sigcapturedata where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and customercode = "+ sessionStorage.getItem('customerid') +"",function(result)
						{
						
										
						    			if(result.array!=undefined)
                                        {                                           
                                            if(result.array[0].custcode == 0)
                                        	{
                                            	InsertImage();
                                        	}
                                        	else
                                        	{
                                            	UpdateImage();
                                        	}
                                        }                                        
						},
						function()
						{
					   	 console.warn("Error calling plugin");
						});
             		}   
            }
            
            function InsertImage()
            {
               // alert("InsertImage");
            	localStorage.collectionMOP ='signature';
                console.log("aa");
                var obj = {};
                obj.Img = document.getElementById('thecanvas').toDataURL();
                
               
                var signature = $("#hidsignature").val();
                signature = presignature + signature;
               
                var fabricCanvas = document.getElementById('thecanvas');  //real ID here
                var scaledCanvas = document.createElement('canvas');    //off-screen canvas

                scaledCanvas.width = 400;  //size of new canvas, make sure they are proportional
                scaledCanvas.height = 300; //compared to original canvas

                // scale original image to new canvas
                var ctx = scaledCanvas.getContext('2d');
                ctx.drawImage(fabricCanvas, 0, 0, scaledCanvas.width, scaledCanvas.height);

                //extract image
                var data = scaledCanvas.toDataURL("image/jpeg"); //no need to specify PNG as that's the def.
           
               //alert("Insert Into sigcapturedata(routekey,visitkey,transactionkey,customercode,documentnumber,transactiondate,transactiontime,balancedueamount,signaturedata,istemp) values("+ sessionStorage.getItem('RouteKey') +","+ sessionStorage.getItem('VisitKey') +",0,"+ sessionStorage.getItem('customerid') +",0,strftime('%Y-%m-%d',datetime()),strftime('%H:%M',datetime()),0,'"+ signature +"','true')");
                 if(platform=='iPad')
           		{
                Cordova.exec(function(result) 
                                        {
                                            //navigator.notification.alert("Insert record successfully");
                                            CheckGCToCash();
                                        },
                                        function(error) {
                                            navigator.notification.alert("Error insert record in sigcapturedata");
                                        },
                                        "PluginClass", 
                                        "InsertUpdateMethod", 
                 
                                        ["Insert Into sigcapturedata(routekey,visitkey,transactionkey,customercode,documentnumber,transactiondate,transactiontime,balancedueamount,signaturedata,istemp,issync) values("+ sessionStorage.getItem('RouteKey') +","+ sessionStorage.getItem('VisitKey') +",0,"+ sessionStorage.getItem('customerid') +",0,strftime('%Y-%m-%d',datetime()),time('now', 'localtime'),0,'"+ signature +"','true',0)"]);
                 }                       
            	 else if(platform=='Android')
            		{
             
		             window.plugins.DataBaseHelper.insert("Insert Into sigcapturedata(routekey,visitkey,transactionkey,customercode,documentnumber,transactiondate,transactiontime,balancedueamount,signaturedata,istemp,issync) values("+ sessionStorage.getItem('RouteKey') +","+ sessionStorage.getItem('VisitKey') +",0,"+ sessionStorage.getItem('customerid') +",0,strftime('%Y-%m-%d',datetime()),time('now', 'localtime'),0,'"+ data +"','true',0)",function(result)
						{
						    //navigator.notification.alert("Insert record successfully");
                            CheckGCToCash();
						},
						function()
						{
					   	 console.warn("Error calling plugin");
						});
             		}   
            }
            
           
            function UpdateImage()
            {
            	//alert("UpdateImage");
            	localStorage.collectionMOP ='signature';
                
                var obj = {};
                obj.Img = document.getElementById('thecanvas').toDataURL();
                var signature = $("#hidsignature").val();
                var fabricCanvas = document.getElementById('thecanvas');  //real ID here
                var scaledCanvas = document.createElement('canvas');    //off-screen canvas

                scaledCanvas.width = 400;  //size of new canvas, make sure they are proportional
                scaledCanvas.height = 300; //compared to original canvas

                // scale original image to new canvas
                var ctx = scaledCanvas.getContext('2d');
                ctx.drawImage(fabricCanvas, 0, 0, scaledCanvas.width, scaledCanvas.height);

                //extract image
                var data = scaledCanvas.toDataURL("image/jpeg"); //no need to specify PNG as that's the def.
           
                console.log("Update sigcapturedata set documentnumber = 0,transactiondate =  strftime('%Y-%m-%d',datetime()),transactiontime = time('now', 'localtime'),balancedueamount = 0,issync=0,signaturedata = '"+ data +"' where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and customercode = "+ sessionStorage.getItem('customerid') +"");
                 if(platform=='iPad')
           		{
                Cordova.exec(function(result) 
                              {
                                //navigator.notification.alert("Update record successfully");
                                CheckGCToCash();
                              },
                              function(error) {
                                navigator.notification.alert("Error update record in sigcapturedata");
                              },
                              "PluginClass", 
                              "InsertUpdateMethod", 
                              ["Update sigcapturedata set documentnumber = 0,transactiondate =  strftime('%Y-%m-%d',datetime()),transactiontime = time('now', 'localtime'),balancedueamount = 0,issync=0,signaturedata = '"+ signature +"' where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and customercode = "+ sessionStorage.getItem('customerid') +""]);
            	}                       
            	 else if(platform=='Android')
            		{
             
		             	window.plugins.DataBaseHelper.insert("Update sigcapturedata set documentnumber = 0,transactiondate =  strftime('%Y-%m-%d',datetime()),transactiontime = time('now', 'localtime'),balancedueamount = 0,issync=0,signaturedata = '"+ signature +"' where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and customercode = "+ sessionStorage.getItem('customerid') +"",function(result)
						{
						   //navigator.notification.alert("Update record successfully");
                           CheckGCToCash();
						},
						function()
						{
					   	 console.warn("Error calling plugin");
						});
             		}   
            }

            function Clear() {
                $('.sigPad').signaturePad({ drawOnly: true });
            }
        function updateinvoice()
        {
        	//alert("updateinvoice");
        	console.log("select sum(promoamount) from invoicedetail where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" group by routekey,visitkey");
            Cordova.exec(function(result) {                                
                          if(result.length > 0)
                          {
                          updateheader(result[0][0]);
                          }
                          },
                          function(error) {
                          navigator.notification.alert("Error in check signature count : " + error);
                          },
                          "PluginClass", 
                          "GetdataMethod", 
                          ["select sum(promoamount) from invoicedetail where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" group by routekey,visitkey"]);    
        }
            function updateheader(data)
            {
            	//alert("updateheader");
            	console.log("Update invoiceheader set totalpromoamount = "+data+" where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and customercode = "+ sessionStorage.getItem('customerid') +"");
                Cordova.exec(function(result) 
                              {
                             
                              },
                              function(error) {
                              navigator.notification.alert("Error update record in sigcapturedata");
                              },
                              "PluginClass", 
                              "InsertUpdateMethod", 
                              ["Update invoiceheader set totalpromoamount = "+data+",issync=0 where routekey = "+ sessionStorage.getItem('RouteKey') +" and visitkey = "+ sessionStorage.getItem('VisitKey') +" and customercode = "+ sessionStorage.getItem('customerid') +""]);
                
            }
            
            function CheckGCToCash()
            {
            	
            	//alert("CheckGCToCash");
            		var manualfree=window.localStorage.getItem("manualfree");
            		var isreturn=window.localStorage.getItem("isreturn");
            		if(eval(manualfree)> 0 && eval(isreturn)==1){
	            			window.location = '../customer_opt/Customer_manualfreeexpress.html';
	            	}
	            	else
	            	{
            	
		                if(localStorage.signature == "sales")
		                {
		                    var lnkaccept = ""                    
		                    var allowgctocash = sessionStorage.getItem("allowgctocash");
		                    if(sessionStorage.getItem("invoicepaymentterms") == 2)
		                    {
		                        if(allowgctocash == 1)
		                        {
		                            var msg = "Do You Want To Make Payment ?";
		                            navigator.notification.confirm(msg,function(action){
		                                if(action == true)
		                                    window.location = '../customer_opt/cashcollection_mopexpress.html';
		                                else
		                                    window.location = '../review/printoptionexpress.html';
		                            })
		                        }
		                        else
		                            window.location = '../review/printoptionexpress.html';
		                    }
		                    else
		                        window.location = '../customer_opt/cashcollection_mopexpress.html';
		                }else{
		                	// window.location = '../customer_opt/orderdetailexpress.html';
                            var lnkaccept = ""                    
		                    var allowgctocash = sessionStorage.getItem("allowgctocash");
		                    if(sessionStorage.getItem("invoicepaymentterms") == 2)
		                    {
		                        if(allowgctocash == 1)
		                        {
		                            var msg = "Do You Want To Make Payment ?";
		                            navigator.notification.confirm(msg,function(action){
		                                if(action == true)
		                                    window.location = '../customer_opt/cashcollection_mopexpress.html';
		                                else
		                                    window.location = '../review/printoptionexpress.html';
		                            })
		                        }
		                        else
		                            window.location = '../review/printoptionexpress.html';
		                    }
		                    else
		                        window.location = '../customer_opt/cashcollection_mopexpress.html';
		                 }
	            	}
            }
            
        </script>
</body>
</html>
